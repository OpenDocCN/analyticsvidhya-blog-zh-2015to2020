<html>
<head>
<title>Part 4 !! Pandas DataFrame to PostgreSQL using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第四部！！使用Python将数据帧转换为PostgreSQL</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/part-4-pandas-dataframe-to-postgresql-using-python-8ffdb0323c09?source=collection_archive---------0-----------------------#2020-12-11">https://medium.com/analytics-vidhya/part-4-pandas-dataframe-to-postgresql-using-python-8ffdb0323c09?source=collection_archive---------0-----------------------#2020-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2fa5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Python将批量CSV数据导入PostgreSQL的方法比较</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f70b8e50f6364ebdccb1d347c802c97b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VSYm810uuwbajQKwzv2esA.png"/></div></div></figure><h1 id="6458" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">1.概观</h1><p id="716d" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">本教程的主要目标是找到将批量CSV数据导入PostgreSQL的最佳方法。</p><h1 id="afd5" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">2.先决条件</h1><p id="6b60" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><strong class="ih hj"> Python 3.8.3 : </strong> <a class="ae ks" href="https://www.anaconda.com/products/individual" rel="noopener ugc nofollow" target="_blank">蟒蛇下载链接</a></p><p id="c3b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">PostgreSQL 13:</strong>T6<strong class="ih hj">T8】下载链接</strong></p><p id="1ae8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Psycopg2 : </strong>安装<strong class="ih hj"> Psycopg2 </strong>使用命令:<strong class="ih hj"> pip安装psycopg2 </strong></p><h1 id="80dc" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">3.准备或识别您的数据</h1><p id="2072" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">首先，准备或确定要导入PostgreSQL数据库的CSV文件。例如，我们从GitHub加载虹膜数据。</p><h2 id="13da" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">3.1导入库</h2><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="9ee7" class="kt jq hi li b fi lm ln l lo lp">import os<br/>import sys<br/><strong class="li hj"><em class="lq"># import the connect library for psycopg2</em></strong><br/>import psycopg2<br/><strong class="li hj"><em class="lq"># import the error handling libraries for psycopg2</em></strong><br/>from psycopg2 import OperationalError, errorcodes, errors<br/>import psycopg2.extras as extras<br/>import pandas as pd<br/>from io import StringIO<br/>import numpy as np<br/>from sqlalchemy import create_engine<br/>import seaborn as sns<br/>import matplotlib.pyplot as plt</span></pre><p id="9ea3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3.2提取数据</strong></p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="6551" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Loading data from github</em></strong><br/>irisData = pd.read_csv('<a class="ae ks" href="https://raw.githubusercontent.com/Muhd-Shahid/Learn-Python-Data-Access/main/iris.csv',index_col=False" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/Muhd-Shahid/Learn-Python-Data-Access/main/iris.csv',index_col=False</a>)<br/>irisData.head()</span></pre><h1 id="cfae" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">3.3在PostgreSQL数据库中创建一个表</h1><p id="7c9c" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">为了从Python连接到PostgreSQL数据库，我们使用psycopg:</p><p id="e52c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq">定义功能建立连接</em> </strong></p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="2518" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define a connect function for PostgreSQL database server</em></strong><br/>def connect(conn_params_dic):<br/>    conn = None<br/>    try:<br/>        print('Connecting to the PostgreSQL...........')<br/>        conn = psycopg2.connect(**conn_params_dic)<br/>        print("Connection successfully..................")<br/>        <br/>    except OperationalError as err:<br/>       <strong class="li hj"><em class="lq"> # passing exception to function</em></strong><br/>        show_psycopg2_exception(err)        <br/>        # set the connection to 'None' in case of error<br/>        conn = None<br/>    return conn</span></pre><p id="1c4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq">定义函数捕捉异常</em> </strong></p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="b6e7" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define a function that handles and parses psycopg2 exceptions</em></strong><br/>def show_psycopg2_exception(err):<br/>    <strong class="li hj"><em class="lq"># get details about the exception</em></strong><br/>    err_type, err_obj, traceback = sys.exc_info()    <br/>    <strong class="li hj"><em class="lq"># get the line number when exception occured</em></strong><br/>    line_n = traceback.tb_lineno    <br/>   <strong class="li hj"><em class="lq"> # print the connect() error</em></strong><br/>    print ("\npsycopg2 ERROR:", err, "on line number:", line_n)<br/>    print ("psycopg2 traceback:", traceback, "-- type:", err_type) <br/>    <strong class="li hj"><em class="lq"># psycopg2 extensions.Diagnostics object attribute</em></strong><br/>    print ("\nextensions.Diagnostics:", err.diag)    <br/>  <strong class="li hj"><em class="lq">  # print the pgcode and pgerror exceptions</em></strong><br/>    print ("pgerror:", err.pgerror)<br/>    print ("pgcode:", err.pgcode, "\n")</span></pre><p id="0e32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lq">定义函数创建表</em> </strong></p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="68fe" class="kt jq hi li b fi lm ln l lo lp">def create_table(cursor):<br/>    try:<br/>        <strong class="li hj"><em class="lq"># Dropping table iris if exists</em></strong><br/>        cursor.execute("DROP TABLE IF EXISTS iris;")<br/>        sql = '''CREATE TABLE iris(<br/>        sepal_length DECIMAL(2,1) NOT NULL, <br/>        sepal_width DECIMAL(2,1) NOT NULL, <br/>        petal_length DECIMAL(2,1) NOT NULL, <br/>        petal_width DECIMAL(2,1),<br/>        species CHAR(11)NOT NULL<br/>        )'''<br/>        <strong class="li hj"><em class="lq"># Creating a table</em></strong><br/>        cursor.execute(sql);<br/>        print("iris table is created successfully...............")  <br/>    except OperationalError as err:<br/>        <strong class="li hj"><em class="lq"># pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        <strong class="li hj"><em class="lq"># set the connection to 'None' in case of error</em></strong><br/>        conn = None</span></pre><h1 id="4b4a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">4.执行时间</h1><p id="bdea" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">为了测量每个方法的执行时间，我们使用了timeit。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="2d6d" class="kt jq hi li b fi lm ln l lo lp"># Example<br/>def run_method(n):<br/>    for i in range(n):<br/>        3 ** n</span><span id="fe25" class="kt jq hi li b fi lr ln l lo lp">from timeit import default_timer as timer<br/>start_time = timer()<br/>run_method(10000)<br/>end_time = timer()<br/>elapsed = end_time-start_time<br/>print('function took {:.3f} ms'.format((elapsed)*1000.0))</span></pre><h1 id="1982" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">5.方法</h1><h2 id="7e8f" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.1.使用一个接一个的插入</h2><p id="49ba" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">为了建立基线，我们从最简单的方法开始，一个接一个地插入记录:</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="09d7" class="kt jq hi li b fi lm ln l lo lp">def single_inserts(conn, df, table):<br/>    for i in df.index:<br/>        cols  = ','.join(list(df.columns))<br/>        vals  = [df.at[i,col] for col in list(df.columns)]<br/>        query = "INSERT INTO %s(%s) VALUES(%s,%s,%s,%s,'%s')" % (table, cols, vals[0], vals[1], vals[2],vals[3],vals[4])<br/>        cursor.execute(query)<br/>    print("single_inserts() done")</span></pre><h2 id="b3c1" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.2.使用execute_many()</h2><p id="2a80" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">psycopg文档:使用<a class="ae ks" href="https://www.psycopg.org/docs/cursor.html#cursor.executemany" rel="noopener ugc nofollow" target="_blank">执行许多</a></p><blockquote class="ls lt lu"><p id="ef3b" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><em class="hi">对序列vars_list中找到的所有参数元组或映射执行数据库操作(查询或命令)。</em></p></blockquote><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="9b8b" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define function using cursor.executemany() to insert the dataframe</em></strong><br/>def execute_many(conn, datafrm, table):<br/>    <br/>   <strong class="li hj"><em class="lq"> # Creating a list of tupples from the dataframe values</em></strong><br/>    tpls = [tuple(x) for x in datafrm.to_numpy()]<br/>    <br/>    <strong class="li hj"><em class="lq"># dataframe columns with Comma-separated</em></strong><br/>    cols = ','.join(list(datafrm.columns))<br/>    <br/>   <strong class="li hj"><em class="lq"> # SQL query to execute</em></strong><br/>    sql = "INSERT INTO %s(%s) VALUES(%%s,%%s,%%s,%%s,%%s)" % (table, cols)<br/>    cursor = conn.cursor()<br/>    try:<br/>        cursor.executemany(sql, tpls)<br/>        print("Data inserted using execute_many() successfully...")<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>       <strong class="li hj"><em class="lq"> # pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="338a" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.3.使用execute_batch()</h2><p id="6a5b" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">psycopg文档:<a class="ae ks" href="https://www.psycopg.org/docs/extras.html#fast-execution-helpers" rel="noopener ugc nofollow" target="_blank">“快速执行助手”部分:</a></p><blockquote class="ls lt lu"><p id="ef33" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><em class="hi">execute many()的当前实现(用一种非常宽容的说法)性能不是特别好。这些函数可用于加速针对一组参数的语句的重复执行。通过减少服务器往返次数，性能可以比使用executemany()好几个数量级。</em></p></blockquote><p id="4423" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">psycopg文档:<a class="ae ks" href="https://www.psycopg.org/docs/extras.html#psycopg2.extras.execute_batch" rel="noopener ugc nofollow" target="_blank">“execute many”部分:</a></p><blockquote class="ls lt lu"><p id="d0bb" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><em class="hi">以更少的服务器往返次数执行语句组。</em></p></blockquote><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="2ebf" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define function using psycopg2.extras.execute_batch() to insert the dataframe</em></strong><br/>def execute_batch(conn, datafrm, table, page_size=150):<br/>    <br/>  <strong class="li hj"><em class="lq">  # Creating a list of tupples from the dataframe values</em></strong><br/>    tpls = [tuple(x) for x in datafrm.to_numpy()]<br/>    <br/>    <strong class="li hj"><em class="lq"># dataframe columns with Comma-separated</em></strong><br/>    cols = ','.join(list(datafrm.columns))<br/>    <br/>    <strong class="li hj"><em class="lq"># SQL query to execute</em></strong><br/>    sql = "INSERT INTO %s(%s) VALUES(%%s,%%s,%%s,%%s,%%s)" % (table, cols)<br/>    cursor = conn.cursor()<br/>    try:<br/>        extras.execute_batch(cursor, sql, tpls, page_size)<br/>        print("Data inserted using execute_batch() successfully...")<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>        <strong class="li hj"><em class="lq"># pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="7d7e" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.4.使用execute_values()</h2><p id="21ab" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">psycopg文档:<a class="ae ks" href="https://www.psycopg.org/docs/extras.html#psycopg2.extras.execute_values" rel="noopener ugc nofollow" target="_blank"> "execute_values" </a>部分:</p><blockquote class="ls lt lu"><p id="3e18" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><em class="hi">使用带有一系列参数的值执行语句。</em></p></blockquote><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="80a8" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define function using psycopg2.extras.execute_values() to insert the dataframe.</em></strong><br/>def execute_values(conn, datafrm, table):<br/>    <br/>  <strong class="li hj"><em class="lq">  # Creating a list of tupples from the dataframe values</em></strong><br/>    tpls = [tuple(x) for x in datafrm.to_numpy()]<br/>    <br/>    <strong class="li hj"><em class="lq"># dataframe columns with Comma-separated</em></strong><br/>    cols = ','.join(list(datafrm.columns))<br/>    <br/>    <strong class="li hj"><em class="lq"># SQL query to execute</em></strong><br/>    sql = "INSERT INTO %s(%s) VALUES %%s" % (table, cols)<br/>    cursor = conn.cursor()<br/>    try:<br/>        extras.execute_values(cursor, sql, tpls)<br/>        print("Data inserted using execute_values() successfully..")<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>        # pass exception to function<br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="1a71" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.5.使用execute_mogrify()</h2><blockquote class="ls lt lu"><p id="b837" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><em class="hi">参数绑定后返回查询字符串。返回的字符串正是发送给运行execute()方法或类似方法的数据库的字符串。</em></p></blockquote><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="708a" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define function using execute.mogrify() to insert the dataframe.</em></strong><br/>def execute_mogrify(conn, datafrm, table):<br/>   <br/>    <strong class="li hj"><em class="lq"># Creating a list of tupples from the dataframe values</em></strong><br/>    tpls = [tuple(x) for x in datafrm.to_numpy()]<br/>    <br/>    <strong class="li hj"><em class="lq"># dataframe columns with Comma-separated</em></strong><br/>    cols = ','.join(list(datafrm.columns))<br/>    <br/>    <strong class="li hj"><em class="lq"># SQL quert to execute</em></strong><br/>    cursor = conn.cursor()<br/>    values = [cursor.mogrify("(%s,%s,%s,%s,%s)", tup).decode('utf8') for tup in tpls]<br/>    sql  = "INSERT INTO %s(%s) VALUES " % (table, cols) + ",".join(values)<br/>    try:<br/>        cursor.execute(sql, tpls)<br/>        print("Data inserted using execute_mogrify() successfully.")<br/>        cursor.close()<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>        <strong class="li hj"><em class="lq"># pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="7b3c" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.6.使用Using copy_from()</h2><p id="c4bf" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">psycopg文档:<a class="ae ks" href="https://www.psycopg.org/docs/cursor.html#cursor.copy_from" rel="noopener ugc nofollow" target="_blank"> "copy_from()" </a>部分:</p><blockquote class="ls lt lu"><p id="a3a0" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><em class="hi">为了使用copy from Python，psycopg提供了一个名为copy_from的特殊函数。复制命令需要CSV文件。让我们看看是否可以将我们的数据转换成CSV，并使用copy_from: </em>将其加载到数据库中</p></blockquote><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="3670" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define function using copy_from_dataFile to insert the dataframe.</em></strong><br/>def copy_from_dataFile(conn, df, table):<br/>    <br/><strong class="li hj"><em class="lq">#  Here we are going save the dataframe on disk as a csv file, load # the csv file and use copy_from() to copy it to the table</em></strong><br/>    tmp_df = '../Learn Python Data Access/iris_temp.csv'<br/>    df.to_csv(tmp_df, header=False,index = False)<br/>    f = open(tmp_df, 'r')<br/>    cursor = conn.cursor()<br/>    try:<br/>        cursor.copy_from(f, table, sep=",")<br/>        print("Data inserted using copy_from_datafile() successfully....")<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>        os.remove(tmp_df)<br/>        <strong class="li hj"><em class="lq"># pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="adb2" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.7.对StringIO使用copy_from()</h2><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="4ca4" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Define function using copy_from() with StringIO to insert the dataframe</em></strong><br/>def copy_from_dataFile_StringIO(conn, datafrm, table):<br/>    <br/>  <strong class="li hj"><em class="lq"># save dataframe to an in memory buffer</em></strong><br/>    buffer = StringIO()<br/>    datafrm.to_csv(buffer, header=False, index = False)<br/>    buffer.seek(0)<br/>    <br/>    cursor = conn.cursor()<br/>    try:<br/>        cursor.copy_from(buffer, table, sep=",")<br/>        print("Data inserted using copy_from_datafile_StringIO() successfully....")<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>        <strong class="li hj"><em class="lq"># pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="848d" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">5.8.使用to_sql()</h2><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="ab68" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Using alchemy method</em></strong><br/>connect_alchemy = "postgresql+psycopg2://%s:%s@%s/%s" % (<br/>    conn_params_dic['user'],<br/>    conn_params_dic['password'],<br/>    conn_params_dic['host'],<br/>    conn_params_dic['database']<br/>)</span><span id="19ac" class="kt jq hi li b fi lr ln l lo lp">def using_alchemy(df):<br/>    try:<br/>        engine = create_engine(connect_alchemy)<br/>        df.to_sql('irisAlchemy', con=engine, index=False, if_exists='append',chunksize = 1000)<br/>        print("Data inserted using to_sql()(sqlalchemy) done successfully...")<br/>    except OperationalError as err:<br/>       <strong class="li hj"><em class="lq"> # passing exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h1 id="6469" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">6.结果</h1><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="0064" class="kt jq hi li b fi lm ln l lo lp">conn = connect(conn_params_dic)<br/><strong class="li hj"><em class="lq"># We set autocommit=True so every command we execute will produce </em></strong>results immediately.<br/>conn.autocommit = True<br/>cursor = conn.cursor()<br/>create_table(cursor)</span></pre><h2 id="3860" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">定义一个函数来比较每种方法的性能</h2><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="c189" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq">#-----------------------------------------<br/># COMPARE THE PERFORMANCE OF EACH METHOD<br/>#-----------------------------------------</em></strong><br/>def compare_methods_to_insert_bulk_data(df):<br/>    #execute_query(conn, "delete from iris where true;")<br/>    # Delete records from iris table<br/>    cursor.execute("delete from iris where true;")<br/>    print("Data has been deleted from iris table..........")<br/>    print("")<br/>    <br/>    methods = [single_inserts, execute_many, execute_batch, execute_values, execute_mogrify, <br/>               copy_from_dataFile, copy_from_dataFile_StringIO]<br/>    df_performance = pd.DataFrame(index=range(len(methods)), columns=['Total_Records','Method_Name','Time ()'])</span><span id="44e9" class="kt jq hi li b fi lr ln l lo lp">k = 0<br/>    for method in methods:<br/>        start_time = timer()<br/>        method(conn, df, 'iris')<br/>        end_time = timer()<br/>        <br/>        df_performance.at[k,'Total_Records'] = len(df.index)<br/>        df_performance.at[k,'Method_Name'] = method.__name__<br/>        df_performance.at[k,'Time ()'] = end_time-start_time<br/>        <br/>        # Delete records for the previous method and prepare test for the next method<br/>        # Delete records from iris table<br/>        cursor.execute("delete from iris where true;")<br/>        print("Data has been deleted from iris table........")<br/>        print("")<br/>        k = k + 1</span><span id="040f" class="kt jq hi li b fi lr ln l lo lp"><strong class="li hj"><em class="lq"># Adding sqlalchemy's to_sql() method</em></strong><br/>    start_time = timer()<br/>    using_alchemy(df)<br/>    end_time = timer()<br/>    df_performance.at[k,'Total_Records'] = len(df.index)<br/>    df_performance.at[k,'Method_Name'] = "to_sql() | sqlalchemy"<br/>    df_performance.at[k,'Time ()'] = end_time-start_time<br/>    <br/>    return df_performance</span></pre><h2 id="e086" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">针对1000、5000、10000、50000、100000条记录，比较每种方法的性能。</h2><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="2330" class="kt jq hi li b fi lm ln l lo lp">df = irisData<br/><strong class="li hj"><em class="lq"># Repeating our dataframe 667 times to get a large test dataframe</em></strong><br/>bulk_df = pd.concat([df]*667, ignore_index=True)<br/>print(len(bulk_df.index))</span><span id="d14b" class="kt jq hi li b fi lr ln l lo lp">df_performance_list = []<br/>for records in [1000,5000,10000,50000,100000]:<br/>    print("records = %s" % records)<br/>    df_cutoff = bulk_df[0:records]<br/>    df_performance = compare_methods_to_insert_bulk_data(df_cutoff)<br/>    df_performance_list.append(df_performance)</span><span id="8eec" class="kt jq hi li b fi lr ln l lo lp">method_performances = pd.concat(df_performance_list, axis=0).reset_index()<br/>method_performances.head()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ly"><img src="../Images/661d44a4ea2d4a5c220b8d3d0df55caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2mBQw23XiNenggYFR7xJKw.png"/></div></div></figure><h2 id="b559" class="kt jq hi bd jr ku kv kw jv kx ky kz jz iq la lb kd iu lc ld kh iy le lf kl lg bi translated">可视化每种方法的性能</h2><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="412b" class="kt jq hi li b fi lm ln l lo lp">fig, ax = plt.subplots(figsize=(15,10))<br/>for method in method_performances['Method_Name'].unique():<br/>    subset = method_performances[method_performances['Method_Name'] == method]    <br/>    ax.plot(subset['Total_Records'], subset['Time ()'], 'o-.', label=method, linewidth=2, markersize=10)</span><span id="cfe8" class="kt jq hi li b fi lr ln l lo lp">plt.xticks([1000, 5000,10000, 50000,100000])<br/>plt.xlabel('Number of records in dataframe',fontsize=12)<br/>plt.ylabel('Execution Time (second)',fontsize=12)<br/>plt.title("COMPARING THE DIFFERENT INSERT METHODS", fontsize=15)<br/>plt.legend()<br/>plt.savefig("./Learn Python Data Access/all_methods.png", dpi=600)<br/>plt.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lz"><img src="../Images/4770e248f060716823279e3afce248ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7OSiJCWRPFvErN9_jwSr0A.png"/></div></div></figure><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="6cbd" class="kt jq hi li b fi lm ln l lo lp"><strong class="li hj"><em class="lq"># Closing the cursor &amp; connection</em></strong><br/>cursor.close()<br/>conn.close()</span></pre><h1 id="7663" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">7.结论</h1><p id="3e26" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">现在，主要问题是我们应该用什么？答案是视情况而定。每种方法都有自己的优缺点，适合不同的情况。从上图可以明显看出，最快的方法是使用copy_from，但是，execute_values()和execute_mogrify()也是导入数据的好方法。</p><p id="d02b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文的所有代码都可以作为GitHub    <em class="lq">上的<a class="ae ks" href="https://github.com/Muhd-Shahid/Learn-Python-Data-Access/tree/main/PostgreSQL" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> <em class="lq"> Jupyter笔记本获得。</em></strong></a></em></p><blockquote class="ls lt lu"><p id="741f" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">下一篇</em> </strong> <a class="ae ks" rel="noopener" href="/analytics-vidhya/part-5-1-pandas-dataframe-to-postgresql-using-python-e2588e65c235"> <strong class="ih hj"> <em class="hi">第5.1部分</em> </strong> </a> <strong class="ih hj"> <em class="hi"> : </em>如何从PostgreSQL读取数据到熊猫DataFrame？</strong></p><p id="b766" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">之前的学习:</em> </strong></p><p id="bf06" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/pandas-dataframe-to-postgresql-using-python-part-1-93f928f6fac7" rel="noopener"> <strong class="ih hj"> <em class="hi">第一部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">:简介、连接&amp;数据库创建</em> </strong></p><p id="fd59" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/pandas-dataframe-to-postgresql-using-python-part-2-3ddb41f473bd" rel="noopener"> <strong class="ih hj"> <em class="hi">第二部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">使用Python </em> </strong>在PostgreSQL数据库中创建表</p><p id="2467" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/part-3-1-pandas-dataframe-to-postgresql-using-python-8a3e3da87ff1" rel="noopener"> <strong class="ih hj"> <em class="hi">第3.1部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">:使用executemany()将批量数据插入PostgreSQL数据库</em> </strong></p><p id="ef4d" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" rel="noopener" href="/analytics-vidhya/part-3-2-pandas-dataframe-to-postgresql-using-python-8dc0b0741226"> <strong class="ih hj"> <em class="hi">第3.2部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">:使用execute_batch()将批量数据插入PostgreSQL数据库</em> </strong></p><p id="c26d" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/part-3-3-pandas-dataframe-to-postgresql-using-python-57e68fe39385" rel="noopener"> <strong class="ih hj"> <em class="hi">第3.3部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">:使用Python </em> </strong>使用execute_values()方法将批量数据插入PostgreSQL数据库</p><p id="6f73" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/part-3-4-pandas-dataframe-to-postgresql-using-python-d94e644a332" rel="noopener"> <strong class="ih hj"> <em class="hi">第3.4部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">:使用mogrify()将批量数据插入PostgreSQL数据库</em> </strong></p><p id="164e" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/part-3-5-pandas-dataframe-to-postgresql-using-python-d3bc41fcf39" rel="noopener"> <strong class="ih hj"> <em class="hi">第3.5部分</em> </strong> </a> <strong class="ih hj"> <em class="hi">:使用copy_from()将批量数据插入PostgreSQL数据库</em> </strong></p><p id="6df6" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" href="https://shahid-dhn.medium.com/part-3-6-pandas-dataframe-to-postgresql-using-python-ec80cb33ca4a" rel="noopener"> <strong class="ih hj"> <em class="hi">第3.6部分</em></strong></a><em class="hi">:</em><strong class="ih hj"><em class="hi">使用copy_from()和StringIO将批量数据插入PostgreSQL数据库</em> </strong></p><p id="5eda" class="if ig lq ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated"><a class="ae ks" rel="noopener" href="/analytics-vidhya/part-3-7-pandas-dataframe-to-postgresql-using-python-6590fda63f41"> <strong class="ih hj"> <em class="hi">第3.7部分</em></strong></a><em class="hi">:</em><strong class="ih hj"><em class="hi"/>使用to_sql()(alchemy)将批量数据插入PostgreSQL数据库</strong></p></blockquote><p id="3d48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">保持乐观！！注意安全！！继续学习:))</p><p id="fc68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">感谢您的阅读！！</strong></p></div></div>    
</body>
</html>