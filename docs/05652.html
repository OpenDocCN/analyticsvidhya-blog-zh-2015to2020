<html>
<head>
<title>Process large files line by line with AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda逐行处理大文件</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/demystifying-aws-lambda-deal-with-large-files-stored-on-s3-using-python-and-boto3-6078d0e2b9df?source=collection_archive---------2-----------------------#2020-04-28">https://medium.com/analytics-vidhya/demystifying-aws-lambda-deal-with-large-files-stored-on-s3-using-python-and-boto3-6078d0e2b9df?source=collection_archive---------2-----------------------#2020-04-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3500" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用boto3和python使用无服务器FAAS功能逐行处理文件，并充分利用它</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/47ed48df9969520efcbeeb551121552f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IwHKeuI629cJ6a14"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">照片由<a class="ae jn" href="https://unsplash.com/@alfredsd?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿尔弗雷德</a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="2bc2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi kk translated"><span class="l kl km kn bm ko kp kq kr ks di">想到用于执行工作负载的大型物理服务器，你的脑海中就会浮现出上面的画面。现在考虑购买这些巨大的服务器来处理您的数据，这并不是一个好的选择，对吗？</span></p><p id="b36d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为什么不利用云中的服务器，在云服务器上运行我们的工作负载呢？好主意，但另一个问题是，现在我们必须管理我们的工作负载，并且还要注意在适当的时候关闭服务器，以避免额外的成本。没有人愿意为不必要的东西付钱。为什么我们不能有一些我们不需要管理的东西呢？为什么我们不能为我们使用的东西付费？为什么我们不能为使用服务器的时间付费？</p><p id="3d8f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">好吧，这就是无服务器模式。你不想购买巨大的服务器。您不希望因服务器未被利用而被收费。对于特定的工作负载，您只需要特定的内存。走向无服务器是你所有疑问的答案。</p><p id="799e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">无服务器并不意味着你的程序在没有服务器的情况下也能运行，而是当你需要服务器的时候，它会以最低的最优价格提供给你，而且你只需为你的程序被执行的时间付费。所以，从技术上来说，服务器并没有过时，它们只是被抽象化了，所以我们更关注我们的程序，而不是服务器管理。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><p id="f094" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">AWS Lambda是无服务器的<strong class="jq hj"> FAAS </strong>(功能即服务)，它使您能够在不提供物理服务器或利用云服务器的情况下运行您的程序。</p><p id="dec0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Lambda函数虽然非常强大，但自身却没有什么限制:</p><ol class=""><li id="8185" class="la lb hi jq b jr js ju jv jx lc kb ld kf le kj lf lg lh li bi translated">Lambda函数运行时间不能超过15分钟。</li><li id="7108" class="la lb hi jq b jr lj ju lk jx ll kb lm kf ln kj lf lg lh li bi translated">Lambda函数不能使用大于3GB的内存</li></ol><p id="d17c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了从s3读取文件，我们将使用boto3:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lo lp l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">λ要点</figcaption></figure><p id="67be" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，当我们使用get_object读取文件而不是返回完整的数据时，它会返回该对象的<strong class="jq hj"> StreamingBody </strong>。</p><pre class="iy iz ja jb fd lq lr ls lt aw lu bi"><span id="20b7" class="lv lw hi lr b fi lx ly l lz ma">{<br/>    'Body': <strong class="lr hj">StreamingBody()</strong>,<br/>    'DeleteMarker': <strong class="lr hj">True|False</strong>,<br/>    'AcceptRanges': 'string',<br/>    'Expiration': 'string',<br/>    'Restore': 'string',<br/>    'LastModified': datetime(2015, 1, 1),<br/>    'ContentLength': 123,<br/>    'ETag': 'string',<br/>    'MissingMeta': 123,<br/>    'VersionId': 'string',<br/>    'CacheControl': 'string',<br/>    'ContentDisposition': 'string',<br/>    'ContentEncoding': 'string',<br/>    'ContentLanguage': 'string',<br/>    'ContentRange': 'string',<br/>    'ContentType': 'string',<br/>    'Expires': datetime(2015, 1, 1),<br/>    'WebsiteRedirectLocation': 'string',<br/>    'ServerSideEncryption': 'AES256'<strong class="lr hj">|</strong>'aws:kms',<br/>    'Metadata': {<br/>        'string': 'string'<br/>    },<br/>    'SSECustomerAlgorithm': 'string',<br/>    'SSECustomerKeyMD5': 'string',<br/>    'SSEKMSKeyId': 'string',<br/>    'StorageClass': 'STANDARD'<strong class="lr hj">|</strong>'REDUCED_REDUNDANCY'<strong class="lr hj">|</strong>'STANDARD_IA'<strong class="lr hj">|</strong>'ONEZONE_IA'<strong class="lr hj">|</strong>'INTELLIGENT_TIERING'<strong class="lr hj">|</strong>'GLACIER'<strong class="lr hj">|</strong>'DEEP_ARCHIVE',<br/>    'RequestCharged': 'requester',<br/>    'ReplicationStatus': 'COMPLETE'<strong class="lr hj">|</strong>'PENDING'<strong class="lr hj">|</strong>'FAILED'<strong class="lr hj">|</strong>'REPLICA',<br/>    'PartsCount': 123,<br/>    'TagCount': 123,<br/>    'ObjectLockMode': 'GOVERNANCE'<strong class="lr hj">|</strong>'COMPLIANCE',<br/>    'ObjectLockRetainUntilDate': datetime(2015, 1, 1),<br/>    'ObjectLockLegalHoldStatus': 'ON'<strong class="lr hj">|</strong>'OFF'<br/>}</span></pre><p id="5528" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里可以找到<a class="ae jn" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.get_object" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5487" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这个流主体为我们提供了各种选项，比如分块读取数据或逐行读取数据。关于<a class="ae jn" href="https://botocore.amazonaws.com/v1/documentation/api/latest/reference/response.html" rel="noopener ugc nofollow" target="_blank"> StreamingBody </a>的所有可用选项，请参考此<a class="ae jn" href="https://botocore.amazonaws.com/v1/documentation/api/latest/reference/response.html" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="6ccc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当我们运行下面的命令时，我们默认读取完整的数据，这是我们需要不惜一切代价避免的。</p><pre class="iy iz ja jb fd lq lr ls lt aw lu bi"><span id="d647" class="lv lw hi lr b fi lx ly l lz ma">reponse['Body'].read()</span></pre><p id="bc46" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">根据文档，我建议避免使用:</p><p id="42c8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> read( <em class="mb"> amt=None </em> ): </strong>从流中最多读取amt字节。如果省略amt参数，则读取所有数据。</p><p id="060d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">而是更喜欢</p><p id="c40c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">ITER _ lines(<em class="mb">chunk _ size = 1024</em>):</strong>返回一个迭代器，从原始流中产生行。这是通过从原始流中一次读取字节块(大小为chunk_size ),然后从中产生行来实现的。</p><p id="e83d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">ITER _ chunks(<em class="mb">chunk_size = 1024</em>):</strong>返回一个迭代器，从原始流中产生chunk _ size字节的块。</p><p id="5a5f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，由于在我们运行get_object时没有返回完整的对象，这为lambda打开了一个新的可能性世界。现在，我们可以在step函数的帮助下链接多个lambda函数，也可以通过设置s3 bucket事件将值从一个lambda传递到另一个lambda。</p><p id="4509" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这使得数据工程师能够以最低的成本完成许多任务。希望你喜欢这篇文章。</p><p id="8317" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">敬请关注更多内容。</p><p id="c04c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">参考资料:<br/>【1】<a class="ae jn" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.get_object" rel="noopener ugc nofollow" target="_blank">boto 3文档</a></p><p id="8677" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[2] <a class="ae jn" href="https://botocore.amazonaws.com/v1/documentation/api/latest/reference/response.html" rel="noopener ugc nofollow" target="_blank">响应参考文件</a></p></div></div>    
</body>
</html>