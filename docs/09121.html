<html>
<head>
<title>Capture your favourite quotes from physical books — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从实体书中捕捉你最喜欢的语录——第二部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/capture-your-favourite-quotes-from-physical-books-part-2-1b531f1010f4?source=collection_archive---------33-----------------------#2020-08-25">https://medium.com/analytics-vidhya/capture-your-favourite-quotes-from-physical-books-part-2-1b531f1010f4?source=collection_archive---------33-----------------------#2020-08-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fb55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一篇由两部分组成的系列博文:</p><ul class=""><li id="c433" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae jm" rel="noopener" href="/@bhagiasanjay/capture-your-favourite-quotes-from-physical-books-80ca4833dbf3">第 1 部分:设置逻辑应用程序从图像中检索文本</a></li><li id="1959" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><a class="ae jm" rel="noopener" href="/@bhagiasanjay/capture-your-favourite-quotes-from-physical-books-part-2-1b531f1010f4">第 2 部分:将检测到的文本推送到 blob 存储中的文本文件(this) </a></li></ul><p id="b583" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我之前的博客文章中，我们创建了 logic 应用程序，我们可以将图片上传到 OneDrive 中的文件夹，计算机视觉 API 可以从该图像中检测文本。如果你还没有通读那篇<a class="ae jm" href="https://www.sanjaybhagia.com/2020/08/25/capture-quotes-from-books" rel="noopener ugc nofollow" target="_blank">文章</a>，请在继续这篇文章之前通读一下。让我们在这篇博文中更进一步。</p><h1 id="8e96" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">将检测到的文本保存到文本文件</h1><p id="4884" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">当前，没有针对 blob 存储的“追加”操作的操作。如果你问我，我会觉得这有点令人失望！所以我们需要写一点代码来实现这一点。我知道我说过，我希望这很简单，但这就是生活，你必须在你没有预料到的地方写一些代码。我打算用 C#来学习 Azure 函数，你可以使用任何你觉得舒服的语言。</p><h1 id="e90c" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建 Azure 功能应用</h1><p id="1234" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">您可以选择任何您喜欢的 IDE，我将使用 Visual Studio(如果您喜欢，VSCode 也很棒)</p><p id="3230" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不会详细讨论如何创建和发布函数，因为已经有人写过了。你可以按照这个<a class="ae jm" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-develop-vs" rel="noopener ugc nofollow" target="_blank">链接</a>来创建 Azure 函数，并将它们发布到 Azure。如果您更喜欢 VS 代码，请检查<a class="ae jm" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-vs-code?pivots=programming-language-csharp" rel="noopener ugc nofollow" target="_blank">这个</a>出来。</p><ul class=""><li id="8600" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">创建了函数项目后，删除“Function1.cs”文件并添加一个新函数(右键单击项目-&gt;添加-&gt;新建 azure 函数-&gt;选择“Azure 函数”并将其命名为 AddQuotetoFile)</li><li id="690a" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">选择“HTTP 触发器”并按“确定”</li></ul><p id="584a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">继续看实际的代码。下面是一些细节:<br/>该函数需要以下有效载荷(请求)</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="90d5" class="le jt hi la b fi lf lg l lh li">{ "blobName": "testfile.txt", "containerName": "ocr-images", "text": "Here is the quote from the book" }</span></pre><ul class=""><li id="54f7" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj"> blobName </strong>:我们需要添加文本的 blob 的名称(如果它还不存在，将在第一次创建它)</li><li id="7447" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><strong class="ih hj"> containerName </strong>:文件应该存在的 blob 存储容器</li><li id="9aa5" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated"><strong class="ih hj">文本</strong>:我们想要写入文件的实际文本</li></ul><p id="b2f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个函数中，当它被触发时，我们希望:</p><ol class=""><li id="543f" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc lj jj jk jl bi translated">解析 HTTP 请求体</li><li id="5ace" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc lj jj jk jl bi translated">确保我们有所有需要的信息</li><li id="efac" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc lj jj jk jl bi translated">获取对 blob 容器的引用(如果不存在，则创建)</li><li id="8eae" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc lj jj jk jl bi translated">获取对 blob 的引用(如果不存在，则创建)</li><li id="90da" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc lj jj jk jl bi translated">将文本追加到文件的末尾</li></ol><p id="4c43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我的主函数的样子。请查看我的<a class="ae jm" href="https://github.com/sanjaybhagia/capture-quotes-books" rel="noopener ugc nofollow" target="_blank"> GitHub 库</a>了解整个解决方案。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="fe0c" class="le jt hi la b fi lf lg l lh li">public static class AddQuotetoFile<br/>    {<br/>        [FunctionName("AddQuotetoFile")]<br/>        public static async Task&lt;IActionResult&gt; Run(<br/>            [HttpTrigger(AuthorizationLevel.Function,"post", Route = null)] HttpRequest req,<br/>            ILogger log)<br/>        {<br/>            log.LogInformation("C# HTTP trigger function processed a request.");<br/><br/>            // Expects JSON body:<br/>            // {<br/>            //      "blobName": "[Blob name here]",<br/>            //      "containerName": "[Container name here]",<br/>            //      "text": "\"Column A\","Column B\",\\n,\"A1\",\"B1\",\\n,\"A2\",\"B2\""<br/>            // }<br/><br/>            var connectionString = System.Environment.GetEnvironmentVariable("StorageConnectionString");<br/><br/>            // StorageConnectionString configured as app setting.<br/><br/>            string requestBody = await new StreamReader(req.Body).ReadToEndAsync();<br/>            dynamic data = JsonConvert.DeserializeObject(requestBody);<br/><br/>            var blobName = data?.blobName;<br/>            var containerName = data?.containerName;<br/>            var text = data?.text;<br/><br/>            if (blobName == null)<br/>            {<br/>                return new BadRequestObjectResult("blobName is required.");<br/>            }<br/><br/>            if (containerName == null)<br/>            {<br/>                return new BadRequestObjectResult("containerName is required.");<br/>            }<br/><br/>            if (text == null)<br/>            {<br/>                return new BadRequestObjectResult("text is required.");<br/>            }<br/><br/>            var storageAccount = CloudStorageAccount.Parse(connectionString);<br/>            var blobClient = storageAccount.CreateCloudBlobClient();<br/>            CloudBlobContainer container = blobClient.GetContainerReference(containerName.ToString());<br/><br/>            await container.CreateIfNotExistsAsync();<br/><br/>            <br/>            var appendBlob = container.GetAppendBlobReference(blobName.ToString());<br/><br/>            if ((await appendBlob.ExistsAsync()) == false)<br/>            {<br/>                await appendBlob.CreateOrReplaceAsync();<br/>            }<br/><br/>            StringBuilder lineToAdd = new StringBuilder();<br/>            lineToAdd.AppendLine(text.ToString());<br/>            await appendBlob.AppendTextAsync(lineToAdd.ToString());<br/><br/>            return new OkResult();<br/>        }<br/>    }</span></pre><ul class=""><li id="d56c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">前往入口</li><li id="f1bb" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">为存储帐户创建资源</li></ul><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lk"><img src="../Images/6a6bbcd3a5086ef8104c066122d6dbda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6zUUvteoHu_4ZfPo.png"/></div></div></figure><ul class=""><li id="7ebf" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">按“查看+创建”来创建帐户</li><li id="335a" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">一旦创建了资源，就去找它</li><li id="b415" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">选择设置下的“访问键”</li><li id="6bf8" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">复制 Key1 连接字符串</li><li id="58ae" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">返回 Visual Studio，打开“local.settings.json”文件，并在 Values 下设置属性“StorageConnectionString”</li></ul><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="a18f" class="le jt hi la b fi lf lg l lh li">{ "IsEncrypted": false, "Values": { "AzureWebJobsStorage": "UseDevelopmentStorage=true", "FUNCTIONS_WORKER_RUNTIME": "dotnet", "StorageConnectionString": "&lt;your connection string goes here&gt;" } }</span></pre><p id="77a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，如果您想在本地测试该函数，请按 F5 调试解决方案，您可以通过 Postman(或任何其他工具)发出 HTTP 请求，以确保该函数按预期运行。将一个文件放入您创建的存储帐户的容器中，构造 HTTP 请求并点击您的本地函数端点(您可以使用 simulator 来选择文件，而不是使用 Azure 中的存储帐户，如果您设置了它)。</p><p id="2958" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你建立了正确运行的函数，就该发布函数了。我们都知道<em class="ls"> " </em> <strong class="ih hj"> <em class="ls">朋友不会让朋友右键点击并发布</em> </strong> <em class="ls"> " </em> —但这对于本演示来说是可以的，所以不要觉得不好，继续吧—是的，右键点击解决方案并点击发布。按照我之前提到的链接(<a class="ae jm" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-develop-vs" rel="noopener ugc nofollow" target="_blank">此处</a>和<a class="ae jm" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-vs-code?pivots=programming-language-csharp" rel="noopener ugc nofollow" target="_blank">此处</a>)获取关于如何在本地运行以及从 Visual Studio 和 Visual Studio 代码发布的说明。</p><ul class=""><li id="dc1d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">一旦发布成功，我们将添加应用程序设置。</li><li id="e5a1" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">导航到 Azure 门户，打开我们刚刚发布的功能应用资源</li><li id="63f5" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">转到设置下的“配置”</li></ul><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lt"><img src="../Images/91449182177defc1f380f412affbaed1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Z5OxxaopDTJc0OqB.png"/></div></div></figure><ul class=""><li id="b40a" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">添加新的应用程序设置</li><li id="4d50" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">名称:StorageConnectionString</li><li id="d695" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">值:"您之前放在 local.settings.json 文件中的存储帐户的连接字符串"</li></ul><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lu"><img src="../Images/d76d23fa8484d8eec27d46478f28f969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fsqN5xbd1NY460Ks.png"/></div></div></figure><ul class=""><li id="dd25" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">请确保单击“保存”来保存设置，否则将会丢失设置。</li></ul><p id="55e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好了设置。您可以像前面一样通过 Postman 在 point 测试这一点。唯一的变化是从 Azure 而不是 localhost 获取函数的 URL。仍然在您的功能入口-&gt;选择'功能'-&gt;选择您的功能(' AddQuotetoFile) -&gt;点击'获取功能 URL '并复制 Url。</p><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lv"><img src="../Images/505d128c44eb4629cab032d818171e7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*oiuCYwrzMUb9fl8e.png"/></div></div></figure><p id="91f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们差不多完成了，现在是测试的时候了。在 OneDrive 文件夹“ocr-images”中上传另一张图像，并再次查看运行历史记录。以下是我成功的跑步记录:</p><figure class="kv kw kx ky fd ll er es paragraph-image"><div class="er es lw"><img src="../Images/8990e9ad9ceeba40b8856d435ca119fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/0*Cj1soK_AoeF2ve_S.png"/></div></figure><figure class="kv kw kx ky fd ll er es paragraph-image"><div class="er es lx"><img src="../Images/5d3b5b96ed074624b16053af48922f6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/0*N5kz3FTFSf3SifeR.png"/></div></figure><p id="887c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们打开存储帐户，看看文本是否成功写入。</p><ul class=""><li id="0273" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">选择存储帐户-&gt;容器-&gt;配额容器</li><li id="811e" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">单击文件“quotes.txt”(注意 blob 类型是“追加 Blob”)</li><li id="ffc8" class="jd je hi ih b ii jn im jo iq jp iu jq iy jr jc ji jj jk jl bi translated">从弹出窗口中点击“下载”,在任何编辑器中打开它，检查内容</li></ul><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ly"><img src="../Images/0d46538eb8f92a3dd9a9743033547ce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uBygFGIasJoxW8Rw.png"/></div></div></figure><p id="d646" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在 OneDrive 上传了另一个文件。再次下载 quotes.txt 文件，看看内容。您将看到附加了另一行。</p><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lz"><img src="../Images/c796b39feb2759e5400011c39a63668d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I7eD3cBW42IJVe20.png"/></div></div></figure><p id="b2f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们最终为此解决方案创建的所有资源</p><figure class="kv kw kx ky fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ma"><img src="../Images/b0b879c321628fe0097149e82705f66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W2bwUbAv70qqosdJ.png"/></div></div></figure><p id="f7b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们终于完成了！现在，当您拍摄任何报价的照片并将其上传到 OneDrive 时，Logic 应用程序将被触发，并将报价附加到 blob 存储中的文本文件中。</p><p id="8c00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">如果您遵循并提供了资源，并且您不打算使用该解决方案，您可以在此处删除资源组。</em></p><p id="dad1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一篇比我预想的要长得多的博文，所以谢谢你的关注。<br/>让我知道你是否觉得这有用，如果你有任何进一步改进的建议。</p><p id="4078" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">干杯</p><p id="a1b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请启用 JavaScript 查看 Disqus 支持的<a class="ae jm" href="http://disqus.com/?ref_noscript" rel="noopener ugc nofollow" target="_blank">评论。</a> <a class="ae jm" href="https://disqus.com" rel="noopener ugc nofollow" target="_blank">评论由</a>提供</p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="58aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ls">原载于 2020 年 8 月 25 日 https://www.sanjaybhagia.com</em><a class="ae jm" href="https://www.sanjaybhagia.com/2020/08/25/capture-quotes-from-books-2" rel="noopener ugc nofollow" target="_blank"><em class="ls"/></a><em class="ls">。</em></p></div></div>    
</body>
</html>