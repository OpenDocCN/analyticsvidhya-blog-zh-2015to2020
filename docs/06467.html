<html>
<head>
<title>How to generate a Chinese text-to-speech via iFLYTEK API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过科大讯飞API生成中文文本到语音转换</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-generate-a-chinese-text-to-speech-via-iflytek-api-db469b31f4a2?source=collection_archive---------22-----------------------#2020-05-23">https://medium.com/analytics-vidhya/how-to-generate-a-chinese-text-to-speech-via-iflytek-api-db469b31f4a2?source=collection_archive---------22-----------------------#2020-05-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e210" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">将语音添加到您的网站和应用程序中，使您的内容面向更多受众。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/235a5514e10b8b684e04b4396c847225.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xnA0J7rqH9WQQuLG"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">埃里克·普劳泽特在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0ea9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">简介</strong></p><p id="7c8e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">去年，我进行了一个项目，要求将中国古代诗歌从文本转换为音频。所以我在网上做了一些调查，发现能提供中文文字转语音服务的公司并不多。最后，我发现在github上使用科大讯飞源代码可以提供语音识别功能，并对其进行了改进，以满足项目的要求。</p><p id="5bea" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">github上的原始源代码链接:</p><div class="kk kl ez fb km kn"><a href="https://github.com/ssky87/iflytek_sdk_python" rel="noopener  ugc nofollow" target="_blank"><div class="ko ab dw"><div class="kp ab kq cl cj kr"><h2 class="bd hj fi z dy ks ea eb kt ed ef hh bi translated">ssky 87/科大讯飞_sdk_python</h2><div class="ku l"><h3 class="bd b fi z dy ks ea eb kt ed ef dx">Python使用科大讯飞语音识别、语音合成. Contribute to ssky87/iflytek_sdk_python development by creating an account on GitHub.</h3></div><div class="kv l"><p class="bd b fp z dy ks ea eb kt ed ef dx translated">github.com</p></div></div><div class="kw l"><div class="kx l ky kz la kw lb jh kn"/></div></div></a></div><p id="d452" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">什么是文本到语音转换？</p><p id="8838" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">文语转换的缩写是(TTS)，即“从文本到语音”，是人机对话的一部分，让机器说话。文本到语音(TTS)是一种自然语言建模过程，需要将文本单元转换为语音单元以进行音频呈现。这是语音和文字的对立面。在这种技术中，一种技术吸收口语单词并试图将它们准确地记录为文本。</p><p id="a4c6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们知道了什么是文语转换，我来解释一下项目的前期准备和需求。</p><p id="c8bc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">准备</strong>:</p><p id="16a6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这个项目我会用ubuntu 16.04，因为我发现ubuntu 18.04以上的版本不行。第二是需要使用Python 2.7版本。安装后，我们首先下载原始的github包。</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="b8e8" class="lh li hi ld b fi lj lk l ll lm">sysadmin@tts:~$ git clone <a class="ae jn" href="https://github.com/ssky87/iflytek_sdk_python.git" rel="noopener ugc nofollow" target="_blank">https://github.com/ssky87/iflytek_sdk_python.git</a><br/>Cloning into 'iflytek_sdk_python'...<br/>remote: Enumerating objects: 16, done.<br/>remote: Total 16 (delta 0), reused 0 (delta 0), pack-reused 16<br/>Unpacking objects: 100% (16/16), done.<br/>Checking connectivity... done.</span></pre><p id="18de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后，我们需要测试软件包是否运行正确。</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="4b40" class="lh li hi ld b fi lj lk l ll lm">sysadmin@tts:~$ cd iflytek_sdk_python/<br/>sysadmin@tts:~/iflytek_sdk_python$ python tts.py<br/>INFO:root:正在合成 [科大讯飞还是不错的]...<br/>DEBUG:root:.<br/>DEBUG:root:.<br/>DEBUG:root:.<br/>DEBUG:root:.<br/>DEBUG:root:.<br/>INFO:root:合成完成！<br/>sysadmin@tts:~/iflytek_sdk_python$ ls<br/>README.md  <strong class="ld hj">msc</strong>  stt.py  tts.py  <strong class="ld hj">x64</strong>  <strong class="ld hj">x86</strong>  xx.wav</span></pre><p id="79ff" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们会看到一个xx.wav，试着下载听一下，这是我们刚刚生成的语音文件。但是对这个项目有一些要求，例如:</p><ol class=""><li id="4231" class="ln lo hi jq b jr js ju jv jx lp kb lq kf lr kj ls lt lu lv bi translated">需要从文本文件中输入</li><li id="ed1f" class="ln lo hi jq b jr lw ju lx jx ly kb lz kf ma kj ls lt lu lv bi translated">每段都需要加上停顿时间</li><li id="b479" class="ln lo hi jq b jr lw ju lx jx ly kb lz kf ma kj ls lt lu lv bi translated">由于输出的wav文件太大，需要转换成mp3</li></ol><p id="13c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在确认需求之后，我们需要安装ffmpeg包来将wav转换成mp3。</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="62ec" class="lh li hi ld b fi lj lk l ll lm">sysadmin@tts:~$ sudo add-apt-repository ppa:mc3man/trusty-media<br/>sysadmin@tts:~$ sudo apt-get update<br/>sysadmin@tts:~$ sudo apt-get install ffmpeg</span></pre><p id="8ff1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">修改源代码</strong></p><p id="3fd6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">导入所需的库</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="454b" class="lh li hi ld b fi lj lk l ll lm">#!/usr/bin/env python<br/># -*- coding: utf-8 -*-<br/>import os<br/>import sys<br/>reload(sys)<br/>sys.setdefaultencoding('utf-8')<br/><br/>import time<br/>from ctypes import *<br/>from io import BytesIO<br/>import wave<br/>import platform<br/>import logging<br/>from pydub import AudioSegment<br/>import shutil</span></pre><p id="a044" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">将源代码封装在类中</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="ea79" class="lh li hi ld b fi lj lk l ll lm">class convertTTS(object):<br/>    logging.basicConfig(level=logging.DEBUG)<br/>    BASEPATH=os.path.split(os.path.realpath(__file__))[0]<br/>    plat = platform.architecture()</span><span id="98de" class="lh li hi ld b fi mb lk l ll lm">    if plat[0] == '32bit':<br/>        cur = cdll.LoadLibrary(BASEPATH + '/x86/libmsc.so')<br/>    else:<br/>        cur = cdll.LoadLibrary(BASEPATH + '/x64/libmsc.so')</span><span id="986d" class="lh li hi ld b fi mb lk l ll lm">    def login(self,str_txt='appid = 539feff8, work_dir = .'):<br/>        MSPLogin = self.cur.MSPLogin<br/>        ret = 0<br/>        ret = MSPLogin(None,None,str_txt) <br/>  <br/>        if ret != 0:<br/>            logging.error("MSPLogin failed, error code: " + str(ret))<br/>        else:<br/>            logging.info("MSPLogin")<br/><br/>        return ret</span><span id="cc6f" class="lh li hi ld b fi mb lk l ll lm">    def logout(self):<br/>        MSPLogout = self.cur.MSPLogout<br/>        MSPLogout()<br/>        logging.info("MSPLogout")</span><span id="a486" class="lh li hi ld b fi mb lk l ll lm">    def saveWave(self, raw_data, _tmpFile = 'test.wav'):<br/>        f = wave.open(_tmpFile,'w')<br/>        f.setparams((1, 2, 16000, 262720, 'NONE', 'not compressed'))<br/>        f.writeframesraw(raw_data)<br/>        f.close()</span><span id="7711" class="lh li hi ld b fi mb lk l ll lm">        return _tmpFile</span><span id="de60" class="lh li hi ld b fi mb lk l ll lm">    def text_to_speech(self,src_text,voicename,speed,volumn,pitch,mp3,file_name=None):</span><span id="85bb" class="lh li hi ld b fi mb lk l ll lm">        logging.info (str(voicename) + " " + str(speed) + " " + str(volumn) + " " + str(pitch))<br/>        encoding = 'utf8'<br/>        sample_rate = 16000<br/>        rdn = 2<br/><br/>        QTTSSessionBegin = self.cur.QTTSSessionBegin<br/>        QTTSTextPut = self.cur.QTTSTextPut<br/>        QTTSAudioGet = self.cur.QTTSAudioGet<br/>        QTTSAudioGet.restype = c_void_p<br/>        QTTSSessionEnd = self.cur.QTTSSessionEnd<br/><br/>        ret_c = c_int(0)</span><span id="464e" class="lh li hi ld b fi mb lk l ll lm">session_begin_params="voice_name=" + str(voicename) + ",text_encoding=" + str(encoding) + ",sample_rate=" + str(sample_rate) +",speed=" + str(speed) + ",volume=" + str(volumn) + ",pitch=" + str(pitch) + ",rdn=" + str(rdn)<br/><br/>        sessionID = QTTSSessionBegin(session_begin_params, byref(ret_c))<br/><br/>	if ret_c.value != 0 :<br/>            logging.error("QTTSSessionBegin failed, error code: " + ret_c.value)<br/>            return</span><span id="3785" class="lh li hi ld b fi mb lk l ll lm">        ret = QTTSTextPut(sessionID, src_text, len(src_text),None)</span><span id="64a3" class="lh li hi ld b fi mb lk l ll lm">        if ret != 0:<br/>            logging.error("QTTSTextPut failed, error code: " + str(ret))<br/>            QTTSSessionEnd(sessionID, "TextPutError")<br/>            return</span><span id="a3b4" class="lh li hi ld b fi mb lk l ll lm">        logging.info("Synthesizing : " + (src_text))</span><span id="54f1" class="lh li hi ld b fi mb lk l ll lm">        audio_len = c_uint(0)<br/>	synth_status = c_int(0)<br/>        f = BytesIO()</span><span id="3618" class="lh li hi ld b fi mb lk l ll lm">        while True:<br/>            p = QTTSAudioGet(sessionID, byref(audio_len), byref(synth_status), byref(ret_c))</span><span id="8bab" class="lh li hi ld b fi mb lk l ll lm">        if ret_c.value != 0:<br/>	    logging.error("QTTSAudioGet failed, error code: " + str(ret_c))<br/>	    QTTSSessionEnd(sessionID, "AudioGetError")<br/>	    break</span><span id="b72b" class="lh li hi ld b fi mb lk l ll lm">        if p != None:<br/>	    buf = (c_char * audio_len.value).from_address(p)<br/>	    f.write(buf)</span><span id="0e4a" class="lh li hi ld b fi mb lk l ll lm">        if synth_status.value == 2 :<br/>	    self.saveWave(f.getvalue(),file_name)<br/>	    break</span><span id="e499" class="lh li hi ld b fi mb lk l ll lm">        time.sleep(1)</span><span id="ed67" class="lh li hi ld b fi mb lk l ll lm">        logging.info('Convert Completed！【' + file_name  + '】\n')</span><span id="cf4e" class="lh li hi ld b fi mb lk l ll lm">        ret = QTTSSessionEnd(sessionID, "Normal")</span><span id="8e70" class="lh li hi ld b fi mb lk l ll lm">        if ret != 0:<br/>            logging.error("QTTSTextPut failed, error code: " + str(ret))</span></pre><p id="b302" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因为我们是按段落转换，所以会生成多个文件，所以我们需要将这些文件合并在一起。</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="7dbb" class="lh li hi ld b fi lj lk l ll lm">def joinwav(fn, num_of_file):<br/>    infiles =[]<br/>    outfile = fn + ".wav"<br/><br/>    for num in range(1,num_of_file):<br/>	filename = fn + "-" + str(num) + ".wav"<br/>	logging.info(filename)<br/>	infiles.append (AudioSegment.from_wav(filename))<br/>	infiles.append (AudioSegment.from_wav("silentFix.wav"))<br/>	<br/>    combined = infiles[0]<br/>	<br/>    for wavcombined in infiles[1:]:<br/>	combined = combined.append(wavcombined)<br/><br/>    combined.export(outfile, format="wav")<br/>    logging.info(' Merge Complete！【' + outfile  + '】')</span></pre><p id="1cdf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">此外，我们还需要将输出的wav文件转换成mp3文件</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="9cfe" class="lh li hi ld b fi lj lk l ll lm">def wav2mp3(filename):<br/>    fn = os.path.splitext(filename)[0]<br/><br/>    AudioSegment.from_wav(filename).export(fn + ".mp3", format="mp3"<br/>    logging.info(' MP3 Output Complete！【' + fn + ".mp3"  + '】')</span></pre><p id="2588" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">清除文本文件中的特殊符号</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="d35c" class="lh li hi ld b fi lj lk l ll lm">def clear(text):<br/>    text = text.replace('《', '')<br/>    text = text.replace('》','')<br/><br/>    return text</span></pre><p id="1a28" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">程序逻辑:你可以在函数中更改语音名称、速度、音量、音调、mp3、joinfile。</p><p id="23b1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">voicename:通过该参数设置不同的说话人，实现不同的语言、方言、性别等。默认发言者是小燕</p><p id="aa2f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">速度:通过该参数设置合成返回的音频的语速，取值范围:[0，100]，默认:50</p><p id="df48" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">volumn:通过该参数设置合成返回的音频的音量，取值范围:[0，100]，默认:50</p><p id="97cc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">音高:通过该参数设置合成后的回传音频的音调，取值范围:[0，100]，默认为:50</p><p id="956f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">mp3:通过此参数设置是否输出mp3文件</p><p id="66b7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">joinfile:通过该参数设置是否将多个wav文件链接成一个文件</p><pre class="iy iz ja jb fd lc ld le lf aw lg bi"><span id="9ec1" class="lh li hi ld b fi lj lk l ll lm">def main(filename, voicename, speed, volumn, pitch, mp3, joinfile):<br/>    lineno = 0<br/><br/>    fh = open(filename)<br/>    fn = os.path.splitext(filename)[0]<br/><br/>    tts = convertTTS()<br/>    tts.login()<br/><br/>    while True:	<br/>        content = fh.readline()<br/><br/>	if (content &lt;&gt; ''):<br/>	    if not content.strip(): continue<br/>		content = clear(content)<br/><br/>		lineno = lineno + 1<br/>			<br/>		targetfilename = fn + "-" + str(lineno) + ".wav"<br/>						    tts.text_to_speech(content,voicename,speed,volumn,pitch,mp3,targetfilename)<br/><br/><br/>	if not content:<br/>	    break</span><span id="be45" class="lh li hi ld b fi mb lk l ll lm">    fh.close()<br/>	<br/>    tts.logout()<br/>	<br/>    if (1 == joinfile):<br/>	joinwav(fn, lineno+1)<br/><br/>	if (1 == mp3):<br/>            wav2mp3(fn + ".wav")</span><span id="3217" class="lh li hi ld b fi mb lk l ll lm">if __name__ == "__main__":<br/>    nfn = sys.argv[1]</span><span id="8271" class="lh li hi ld b fi mb lk l ll lm">    main(nfn, 'xiaoyan', 50, 50, 50, 1, 1)</span></pre><p id="70eb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在你可以在控制台运行程序了！！！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mc"><img src="../Images/75b6467dc1b50706c9fb73dd3e0de014.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EK51s4fLJuKURdA5iZtuow.png"/></div></div></figure></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="1aa4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢阅读！如果你喜欢这篇文章，请通过鼓掌来感谢你的支持(👏🏼)按钮，或者通过共享这篇文章让其他人可以找到它。</p><p id="eb70" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您也可以在我的<a class="ae jn" href="https://github.com/kindersham/100DaysDS/tree/master/iFLYTEK_TTS" rel="noopener ugc nofollow" target="_blank"> github </a>资源库中下载源代码。感谢您的阅读时间。</p></div></div>    
</body>
</html>