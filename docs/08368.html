<html>
<head>
<title>Keep your secrets safe with Azure Key Vault in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python中的Azure Key Vault保护您的秘密</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/keep-your-secrets-safe-with-azure-key-vault-in-python-9848be3230db?source=collection_archive---------4-----------------------#2020-07-27">https://medium.com/analytics-vidhya/keep-your-secrets-safe-with-azure-key-vault-in-python-9848be3230db?source=collection_archive---------4-----------------------#2020-07-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e4c522494f878878d2ac958202f35d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0Q0dQ-EP8MU4jY9Y8StWw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用Azure Key Vault保护您的秘密。</figcaption></figure><p id="c3c3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi js translated">当你开发应用程序时，你经常会遇到这样的情况，你必须将你的工作与其他应用程序和资源连接起来。因为您只想快速检查连接方法是否有效，所以您在代码中将用户名和密码作为不变的字符串写下来，运行代码。瞧！起作用了！现在是喝那杯当之无愧的咖啡的时候了…</p><p id="37a9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">…在啜饮您的vic tourisy棕色液体时，您提交您的更改并将代码推送到您与各种同事共享的应用程序存储库。就是这样，凭证可以被多人访问，并且那些人可以(不希望地)访问他们的计算机。</p><p id="edfb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，让我们确保这不会发生在你身上！</p></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="e693" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我假设你有一个有效的Azure订阅，安装了Python 2.7或3.5+和Azure CLI。</p><h1 id="a213" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">创建和配置Azure资源</h1><p id="308d" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">让我们从创建Azure资源组和密钥库开始:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="898a" class="lw kl hi ls b fi lx ly l lz ma">$ az login</span><span id="2b23" class="lw kl hi ls b fi mb ly l lz ma">$ az group create --name &lt;keyVaultGroup&gt; -l westeurope</span><span id="5c3a" class="lw kl hi ls b fi mb ly l lz ma">$ az keyvault create --name &lt;myUniqueKeyVaultName&gt; -g &lt;keyVaultGroup&gt;</span></pre><p id="b50d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">检索并记住密钥库<code class="du mc md me ls b">properties.vaultUri</code>:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="3381" class="lw kl hi ls b fi lx ly l lz ma">$ az keyvault show -n &lt;myUniqueKeyVaultName&gt; --query "properties.vaultUri" -o json</span></pre><p id="53ee" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">密钥库URL应该是这样的:<code class="du mc md me ls b">https://myuniquekeyvaultname.vault.azure.net/</code></p><p id="8e76" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在创建一个服务主体来管理访问策略:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="5e18" class="lw kl hi ls b fi lx ly l lz ma">$ az ad sp create-for-rbac --name &lt;http://my-key-vault-principal-name&gt; --sdk-auth</span></pre><p id="ebab" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意输出，特别是<code class="du mc md me ls b">clientId</code>、<code class="du mc md me ls b">clientSecret</code>和<code class="du mc md me ls b">tenantId</code>，它应该是这样的:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="667d" class="lw kl hi ls b fi lx ly l lz ma">{<br/>  "clientId": "d55c654c-22df-4641-91a9-3e8b567d6253",<br/>  "clientSecret": "1pXue~dOK6TTCf1NVTBcMaFrQwnIWjS_tO",<br/>  "subscriptionId": "d410egf1-7e00-45x3-beab-081531f878ed",<br/>  "tenantId": "45c8b1a0-8c74-43f9-9fd5-110f80d9a6f9",<br/>  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",<br/>  "resourceManagerEndpointUrl": "https://management.azure.com/",<br/>  "activeDirectoryGraphResourceId": "https://graph.windows.net/",<br/>  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",<br/>  "galleryEndpointUrl": "https://gallery.azure.com/",<br/>  "managementEndpointUrl": "https://management.core.windows.net/"<br/>}</span></pre><p id="e4df" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">创建允许服务主体访问密钥库的访问策略。<strong class="iw hj">注意</strong>上一步输出的<code class="du mc md me ls b">--spn</code> ID是<code class="du mc md me ls b">clientId</code>:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="b156" class="lw kl hi ls b fi lx ly l lz ma">$ az keyvault set-policy -n &lt;myUniqueKeyVaultName&gt; --spn &lt;the-previous-clientId&gt; --secret-permissions delete get list set --key-permissions create decrypt delete encrypt get list unwrapKey wrapKey</span></pre><h1 id="c751" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">设置环境变量</h1><p id="7ed5" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">我们稍后将在Python中使用的Azure Identity客户端库将查找环境服务主体变量，以向密钥库认证自身。</p><h2 id="ea81" class="lw kl hi bd km mf mg mh kq mi mj mk ku jf ml mm ky jj mn mo lc jn mp mq lg mr bi translated">Linux操作系统</h2><p id="c045" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">打开终端，编辑<code class="du mc md me ls b">$HOME</code>目录下的<code class="du mc md me ls b">.profile</code>文件:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="ae3f" class="lw kl hi ls b fi lx ly l lz ma">$ cd ~ &amp;&amp; nano .profile</span></pre><p id="161e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，将服务主体的细节添加到文件的末尾，并保存它:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="7d30" class="lw kl hi ls b fi lx ly l lz ma">AZURE_CLIENT_ID="&lt;the-previous-clientId&gt;"<br/>AZURE_CLIENT_SECRET="&lt;the-previous-clientSecret&gt;"<br/>AZURE_TENANT_ID="&lt;the-previous-tenantId&gt;"<br/>VAULT_URL="&lt;the-previous-properties.vaultUri&gt;"</span></pre><h2 id="dd7b" class="lw kl hi bd km mf mg mh kq mi mj mk ku jf ml mm ky jj mn mo lc jn mp mq lg mr bi translated">Windows操作系统</h2><p id="44a7" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">以管理员权限打开CMD，并将服务主体的细节设置为环境变量:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="5fdc" class="lw kl hi ls b fi lx ly l lz ma">$ SETX AZURE_CLIENT_ID "&lt;the-previous-clientId&gt;"<br/>$ SETX AZURE_CLIENT_SECRET "&lt;the-previous-clientSecret&gt;"<br/>$ SETX AZURE_TENANT_ID "&lt;the-previous-tenantId&gt;"<br/>$ SETX VAULT_URL "&lt;the-previous-properties.vaultUri&gt;"</span></pre><h1 id="e5ec" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">Python实现</h1><h2 id="a500" class="lw kl hi bd km mf mg mh kq mi mj mk ku jf ml mm ky jj mn mo lc jn mp mq lg mr bi translated">安装需求</h2><p id="4c96" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">安装必要的软件包:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="03f6" class="lw kl hi ls b fi lx ly l lz ma">pip install azure.keyvault<br/>pip install azure.identity</span></pre><h2 id="c23d" class="lw kl hi bd km mf mg mh kq mi mj mk ku jf ml mm ky jj mn mo lc jn mp mq lg mr bi translated">设置秘密</h2><p id="a584" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">以下示例将密码添加到密钥库中:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="c7cc" class="lw kl hi ls b fi lx ly l lz ma">import os</span><span id="aa78" class="lw kl hi ls b fi mb ly l lz ma">from azure.identity import EnvironmentCredential<br/>from azure.keyvault.secrets import SecretClient</span><span id="9b9d" class="lw kl hi ls b fi mb ly l lz ma">VAULT_URL = os.environ["VAULT_URL"]</span><span id="8edd" class="lw kl hi ls b fi mb ly l lz ma">credential = EnvironmentCredential()<br/>client = SecretClient(vault_url=VAULT_URL, credential=credential)</span><span id="ab6f" class="lw kl hi ls b fi mb ly l lz ma">client.set_secret(<br/>    "&lt;my-password-reference&gt;",<br/>    "&lt;the-actual-password&gt;",<br/>)</span></pre><h2 id="110a" class="lw kl hi bd km mf mg mh kq mi mj mk ku jf ml mm ky jj mn mo lc jn mp mq lg mr bi translated">获取秘密</h2><p id="f47d" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">以下示例使用“设置密码”步骤中的客户端从密钥库中获取密码:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="ecbe" class="lw kl hi ls b fi lx ly l lz ma">password = client.get_secret("&lt;my-password-reference&gt;").value</span></pre><h2 id="a1dd" class="lw kl hi bd km mf mg mh kq mi mj mk ku jf ml mm ky jj mn mo lc jn mp mq lg mr bi translated">删除秘密</h2><p id="5c24" class="pw-post-body-paragraph iu iv hi iw b ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn lm jp jq jr hb bi translated">以下示例从密钥库中删除一个密码，使用“设置密码”步骤中的客户端:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="f5e8" class="lw kl hi ls b fi lx ly l lz ma">client.begin_delete_secret("&lt;my-password-reference&gt;")</span></pre></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="91c0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就是这样，现在您可以将任何代码推送到任何(公共)存储库，而没有暴露凭据的风险，您的秘密是安全的！</p></div></div>    
</body>
</html>