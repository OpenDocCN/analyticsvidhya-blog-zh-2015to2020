<html>
<head>
<title>How to Send a CSV File from S3 into Redshift with an AWS Lambda Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何发送一个 CSV 文件从 S3 到红移与 AWS Lambda 函数</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-send-a-csv-file-from-s3-into-redshift-with-an-aws-lambda-function-953bf347dddb?source=collection_archive---------1-----------------------#2020-12-10">https://medium.com/analytics-vidhya/how-to-send-a-csv-file-from-s3-into-redshift-with-an-aws-lambda-function-953bf347dddb?source=collection_archive---------1-----------------------#2020-12-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="9833" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="ce04" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如今，自动化是必须的，云工作也不例外，作为数据工程师，我们需要掌握将数据移动到任何需要的地方的技能，如果你想知道如何像数据专家一样在日常生活中面对 AWS 工具，这篇文章就是为你准备的。</p><h1 id="fa78" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">逐步地</h1><p id="8ede" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">收集数据后，下一步是设计一个 ETL，以便在您想要将数据移动到 Amazon Redshift 等分析平台之前提取、转换和加载数据，但在这种情况下，只有我们将使用 for AWS free tier 将数据从 S3 移动到 Redshift 集群。</p><p id="0a36" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">为了做到这一点，我尝试按如下方式处理研究案例:</p><ol class=""><li id="46cb" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka kl km kn ko bi translated">创建一个 S3 桶。</li><li id="6d7c" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">创建一个红移星团。</li><li id="3000" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">从 DBeaver 或者随便什么连接到 Redshift。</li><li id="cef8" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">在数据库中创建一个表。</li><li id="966e" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">用 Python 创建一个需要依赖关系的虚拟环境。</li><li id="456c" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">创建你的 Lambda 函数。</li><li id="8fb9" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">有人上传数据给 S3。</li><li id="8a4e" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">查询您的数据。</li></ol><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/964539db0b0d047a7203422340c2ba97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*qlT-z52nrz9_UatytQ9ZtA.png"/></div></div></figure><p id="bc9c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们开始吧！！</p><p id="49c2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">稍后，您已经完成了第 1 步和第 2 步，让我们借助 SQL 客户端<a class="ae lg" href="https://dbeaver.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj"><em class="lh">【DBeaver】</em></strong></a><strong class="jf hj"><em class="lh"/></strong>或任何您想要的东西来连接到我们的数据库，为此我们需要记住来自红移集群配置的以下数据:</p><pre class="kv kw kx ky fd li lj lk ll aw lm bi"><span id="5b5a" class="ln ig hi lj b fi lo lp l lq lr">HOST = "xyz.redshift.amazonaws.com"<br/>PORT = "5439"<br/>DATABASE = "mydatabase"<br/>USERNAME = "myadmin"<br/>PASSWORD = "XYZ"<br/>TABLE = "mytable"</span></pre></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lz"><img src="../Images/1b7d01f9f5c21b534c074f42d69d738f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QLIPfkbct2Fxi02o3oWsXw.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">连接到数据库</figcaption></figure><p id="077b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">现在，当我们连接到数据库时，让我们创建一个新表</p><pre class="kv kw kx ky fd li lj lk ll aw lm bi"><span id="b7af" class="ln ig hi lj b fi lo lp l lq lr">CREATE TABLE mytable (<br/>id      INT4 distkey sortkey,<br/>col 1     VARCHAR (30) NOT NULL,<br/>col 2         VARCHAR(100) NOT NULL,<br/>col 3 VARCHAR(100) NOT NULL,<br/>col 4        INTEGER NOT NULL,<br/>col 5  INTEGER NOT NULL,<br/>col 6           INTEGER NOT NULL);</span></pre><p id="a5e5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">对于本教程，我们的 Lambda 函数将需要一些 Python 库，如<a class="ae lg" href="https://pypi.org/project/SQLAlchemy/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj"><em class="lh">Sqalchemy</em></strong></a><strong class="jf hj"><em class="lh">，</em></strong><a class="ae lg" href="https://pypi.org/project/psycopg2/" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj"><em class="lh">psycopg 2</em></strong></a><strong class="jf hj"><em class="lh">，</em> </strong>，所以您需要在压缩之前用 Python 和 Lambda 脚本创建一个虚拟环境。您将上传到 AWS 的 zip 文件。</p><p id="676c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">此时，将 Lambda 函数配置到 AWS 中所需要的只是一个 Python 脚本，并在每次有人将新对象上传到 S3 存储桶时触发您的 Lambda，您需要配置以下资源:</p><ol class=""><li id="54e5" class="kg kh hi jf b jg kb jk kc jo ki js kj jw kk ka kl km kn ko bi translated">上传您的 lambda _ function . zip(<strong class="jf hj"><em class="lh">Python 脚本和依赖关系</em> </strong>)并使用下面的代码示例将数据发送到 redshift <code class="du me mf mg lj b">lambda_function.py</code>。</li><li id="4e51" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">将一个 IAM 角色附加到 Lambda 函数，该函数授予对<code class="du me mf mg lj b">AWSLambdaVPCAccesExcecutionRole</code>的访问权限</li><li id="163f" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">对于这种情况，您需要在 Lambda 函数或任何其他函数中添加 VPC 默认值。</li><li id="d523" class="kg kh hi jf b jg kp jk kq jo kr js ks jw kt ka kl km kn ko bi translated">添加环境变量“<em class="lh"> CON </em>和“<em class="lh"> Table </em></li></ol><pre class="kv kw kx ky fd li lj lk ll aw lm bi"><span id="f3bb" class="ln ig hi lj b fi lo lp l lq lr">CON = "postgresql://USERNAME:PASSWORD<a class="ae lg" href="mailto:Datexland686@datexland-129-s3.c7e9zmkabpjl.us-east-1.redshift.amazonaws.com" rel="noopener ugc nofollow" target="_blank">@clustername.</a>xyz.redshift.amazonaws.com:5439/DATABASE"<br/>Table = "<em class="lh">mytable</em>"</span></pre><p id="0a35" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">5.创建一个<a class="ae lg" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/NotificationHowTo.html" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj"><em class="lh">【S3】事件通知</em> </strong> </a>，每当有人上传一个对象到你的 S3 桶时，它就调用 Lambda 函数。</p><p id="3e7f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">6.您可以配置超时时间≥ 5 分钟。</p><pre class="kv kw kx ky fd li lj lk ll aw lm bi"><span id="b313" class="ln ig hi lj b fi lo lp l lq lr">import sqlalchemy <br/>import psycopg2<br/>from sqlalchemy import create_engine <br/>from sqlalchemy.orm import scoped_session, sessionmaker<br/>from datetime import datetime,timedelta<br/>import os</span><span id="72f9" class="ln ig hi lj b fi mh lp l lq lr"><br/>def handler(event, context):</span><span id="711a" class="ln ig hi lj b fi mh lp l lq lr">   for record in event['Records']:<br/>        <br/>      S3_BUCKET = record['s3']['bucket']['name']<br/>      S3_OBJECT = record['s3']['object']['key']<br/>    <br/>    <br/>    # Arguments<br/>    DBC= os.environ["CON"]<br/>    RS_TABLE = os.environ["Table"]<br/>    RS_PORT = "5439"<br/>    DELIMITER = "','"<br/>    REGION = "'us-east-1' "</span><span id="3e39" class="ln ig hi lj b fi mh lp l lq lr">    # Connection<br/>    engine = create_engine(DBC)<br/>    db = scoped_session(sessionmaker(bind=engine))</span><span id="c243" class="ln ig hi lj b fi mh lp l lq lr">    # Send files from S3 into redshift<br/>    copy_query = "COPY "+RS_TABLE+" from 's3://"+   S3_BUCKET+'/'+S3_OBJECT+"' iam_role 'arn:aws:iam::11111111111:role/youroleredshift' delimiter "+DELIMITER+" IGNOREHEADER 1 REGION " + REGION</span><span id="383d" class="ln ig hi lj b fi mh lp l lq lr">    # Execute querie<br/>    db.execute(copy_query)<br/>    db.commit()<br/>    db.close()</span></pre><p id="d837" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在您准备将 CSV 文件上传到您的 S3 存储桶之前，请记住您已经首先创建了一个表，因此在您实现了 lambda 函数并正确配置它之后，您可以将数据上传到 S3，并转到 DBeaver 来查询您的表中的数据。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mi"><img src="../Images/98293868a1a9b1793283cc2f48108f24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y_dxlXfkKoxT8WTNEZFE1A.jpeg"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">执行 Lambda 函数后上传的数据</figcaption></figure><h1 id="46ad" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">摘要</h1><p id="0797" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">AWS Lambda 是一种自动化流程的简单方法，但我们需要了解哪个时刻不能使用它，例如，AWS Lambda 有 6MB 的有效负载限制，因此以这种方式迁移非常大的表是不实际的。</p><p id="663b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">另一方面，使用这项服务的主要优势是，这是一个无服务器的整体解决方案！！，所以不需要管理任何 EC2 实例。</p></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="14e2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">谢谢你读到这里。如果你觉得这篇文章有用，喜欢并分享这篇文章。有人也会觉得它很有用，为什么不邀请我喝杯咖啡呢？</p><figure class="kv kw kx ky fd kz er es paragraph-image"><a href="https://www.paypal.com/donate/?hosted_button_id=GBVXVLXMETRHE"><div class="er es mj"><img src="../Images/7b4a8b0ba9a8213d41096ed8ed319752.png" data-original-src="https://miro.medium.com/v2/resize:fit:336/format:webp/1*Bgbvd0vgdvwObB736NF8eg.png"/></div></a><figcaption class="ma mb et er es mc md bd b be z dx translated"><strong class="bd ih">用 PayPal 捐款</strong>👆</figcaption></figure><p id="1836" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">跟我来👉<a class="ae lg" href="https://www.linkedin.com/in/alexanderbolano/" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">领英</strong> </a></p><p id="af5e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">跟我来👉<a class="ae lg" href="https://twitter.com/Alex_bonella" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj">推特</strong> </a></p><p id="70b3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">联系人:alexbonella2806@gmail.com</p></div></div>    
</body>
</html>