<html>
<head>
<title>Send your ML model to the “Cloud Nine” using the Serverless Application Model (SAM)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用无服务器应用程序模型(SAM)将您的ML模型发送到“九霄云外”</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/send-your-ml-model-to-the-cloud-nine-using-the-serverless-application-model-sam-d0feaa988cbc?source=collection_archive---------19-----------------------#2019-11-27">https://medium.com/analytics-vidhya/send-your-ml-model-to-the-cloud-nine-using-the-serverless-application-model-sam-d0feaa988cbc?source=collection_archive---------19-----------------------#2019-11-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e88f31bd70bab17d76fcdbbd0e8c3743.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8z3nHV09ejt9teOyAz-BHg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">财产:spacenews.com</figcaption></figure><p id="2dbd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你开发了你整个职业生涯中最令人兴奋的ML模型，你期待着在现实世界中测试它，以评估它的性能，并含蓄地评估你的性能。由于您的公司缺少开发人员，您的经理认为，由于您是一名数据科学家，您也能够部署您的模型并制作一个REST API供最终客户端调用。在这种情况下，由您选择:</p><ul class=""><li id="c16b" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">“再见经理！”</li><li id="d872" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">使用AWS的无服务器应用程序模型(SAM)。</li></ul><p id="f8a3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这篇文章给出了第二种方法的简单解释，因为第一种方法需要太多的单词。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es kg"><img src="../Images/9dbee39852455e7125e3796ec9c353e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*QAigLGD_ErGWP8nGhW3Qtw.png"/></div></figure><p id="aad5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">先决条件:</strong>了解AWS Lambda、API Gateway、S3和CLI。</p><p id="7336" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">什么是山姆:</strong></p><p id="63bd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">SAM是一个很棒的工具，它允许您在本地构建一个完整的无服务器架构，该架构主要基于一些资源生成的事件，如API REST调用和在S3上创建的对象，并通过Lambda函数处理这些事件。SAM不仅允许您在自己的机器上测试所有的东西，而且只需一个简短的命令，您就可以将所有东西部署到云中，以创建一个正常运行的无服务器应用程序。SAM让这个过程变得快速而简单。更多信息请点击<a class="ae kl" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="df0b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第一步:</strong></p><p id="d5b5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在您的计算机上下载并安装SAM cli。根据你的OS我留下<a class="ae kl" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank">参考</a></p><p id="f6f9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第二步:</strong></p><p id="954c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">设置好SAM后，在cli中输入<em class="km"> sam init。</em>CLI引导您创建项目<em class="km">。下图不言自明。</em></p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/49bd82c0a60fd113e5c6a520e356adaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*JZib1xz6Ris18k7cT7SJwQ.png"/></div></figure><p id="44d1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在目录结构下面:</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es ko"><img src="../Images/9a421c0f50648defba751ca90d21e735.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*9dELafs4FZMdE1QEWozAyQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">目录结构</figcaption></figure><ul class=""><li id="c796" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">events文件夹包含带有模拟事件的JSON文件，用于在本地测试您的Lambda。你应该去创造你期望得到的东西。</li><li id="05a7" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">hello_word文件夹(可以随意更改)包含Lambda的python文件代码。requirement.txt应该包含您想要包含在最终包中的库的名称。</li><li id="c333" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">template.yaml是构建您想要的无服务器架构的配置文件。</li><li id="9198" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">测试是针对单元测试的。</li></ul><p id="791d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第三步:</strong></p><p id="7b72" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">假设我用sklearn做模型，用joblib腌制。然后，我把我的模型上传到S3桶。</p><p id="33c3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您想要浏览您的代码文件夹，并用代码编辑app.py文件，以加载您的酸洗模型/管道和预测方法。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es kp"><img src="../Images/8401353e88a8e3b558163880fdec2ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*sa-Z-iys8JachNl1-1FDvw.png"/></div></figure><p id="5fcd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">确保在<em class="km"> lambda_handler() </em>函数之外调用<em class="km"> load_model() </em>函数，以便利用<a class="ae kl" href="https://blog.octo.com/cold-start-warm-start-with-aws-lambda/" rel="noopener ugc nofollow" target="_blank">热启动</a>。我避免了输入观察的预处理，这只是一些代码逻辑的问题，但想法是将这些观察输入到您的模型中，这将为您提供预测，您可以根据自己的喜好将其返回。Lambda响应必须与下图类似。注意将函数的任何输出放在函数<em class="km">内部的<em class="km">主体</em>字段中。</em></p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kq"><img src="../Images/2ef1c0374965cdc4117723120213b2d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Xl_FZMN0_jze02JaT5YH7A.png"/></div></div></figure><p id="d73c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第四步:</strong></p><p id="dfd8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在你需要配置<em class="km"> template.yaml </em>文件如下:</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kr"><img src="../Images/146a70ead4319952af6209a0642902e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rZINN9l0XnRMfnc5EnTy_Q.png"/></div></div></figure><p id="01cc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如你可能看到的，这个想法是声明你想要使用的资源，在我们的例子中是一个函数和一个Api。每个资源都有其配置参数，您可以在它们的<a class="ae kl" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-resources-and-properties.html" rel="noopener ugc nofollow" target="_blank">特定文档</a>中找到。</p><p id="4a96" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Outputs部分的目的是在创建资源的过程中显示一些数据和变量，在我们的例子中是要调用的Api地址和Lambda函数的Arn。这些信息可以在Aws CloudFormation中看到。</p><p id="23d1" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">第五步:</p><p id="94b5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">将您用于此功能的所有库添加到您的<em class="km"> requirements.txt </em>文件中，记住最终的包不得大于250 MB。</p><p id="f371" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">运行<em class="km"> sam build，</em>它将输出:</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/dd568b55c7d46dff930367980455886e.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*DX1fXsJxK42q9KJOnuerAw.png"/></div></figure><p id="eec8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如您看到的，它创建了包含所有库的包，builder还扫描了您的需求文件，并将这些dep添加到包中。</p><p id="ba54" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第六步:</strong></p><p id="010c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">用<code class="du kt ku kv kw b">sam local invoke -e events/event.json</code>测试你的lambda</p><p id="8ce4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">还记得事件文件夹吗？这是一个模拟事件，将作为输入提供给你的处理函数，它应该是你期望的调用形式。它所做的是按需创建一个Docker容器，用你的代码模拟一个Lambda函数，然后测试你的事件，看它如何响应。下面你可以找到一个例子。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kx"><img src="../Images/5aaaedaebb33db37ac1fee117d744d2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pDXYIB7LXfCR4tnZyTDwgw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><em class="ky">Sam local invoke-e events/event . JSON</em></figcaption></figure><p id="f712" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意，这个方法只测试你的Lambda代码，如果你想测试架构API Gateway + Lambda你需要调用:<em class="km"> sam local start-api，</em>这也会创建一个Docker容器，你需要向它提交一个REST调用，这个调用会被传递给Lambda。</p><figure class="kh ki kj kk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/b53719f17914f950e19a3d6789993f89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bmYBA6vvIQSWEjhnNPl_1A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">sam本地启动-api</figcaption></figure><p id="8a24" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第七步:</strong></p><p id="0784" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">既然你对自己的结果感到满意，那就去做吧:</p><p id="1813" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><code class="du kt ku kv kw b">sam package — s3-bucket yourbucket — output-template-file packaged.yaml</code></p><p id="194c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这将把您的构建文件夹加载到您指定的S3桶中，并将创建<em class="km"> packaged.yaml </em>文件，它是您的<em class="km"> template.yaml. </em>的CloudFormation模板的转换，您不需要担心它。</p><p id="5c79" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">第八步:</strong></p><pre class="kh ki kj kk fd la kw lb lc aw ld bi"><span id="2214" class="le lf hi kw b fi lg lh l li lj">sam deploy — template-file packaged.yaml — region eu-west-1 — capabilities CAPABILITY_IAM — stack-name my-stack</span></pre><p id="c579" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这将最终启动你所有的工作到AWS。它会自动实例化你所有的资源并将它们绑定在一起。您可以检查CloudFormation服务，查看堆栈现在是否已创建。</p><p id="4e80" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您现在能够调用您的API并获得您的模型预测了！</p></div></div>    
</body>
</html>