<html>
<head>
<title>Machine Learning and big data : A SPARKling approach</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">机器学习和大数据:一个闪亮的方法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/machine-learning-and-big-data-a-sparkling-approach-d57a42919e0c?source=collection_archive---------43-----------------------#2020-05-03">https://medium.com/analytics-vidhya/machine-learning-and-big-data-a-sparkling-approach-d57a42919e0c?source=collection_archive---------43-----------------------#2020-05-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4f54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">利用Spark使用机器学习分析大数据</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/5edbb5a027e6f1d93bd7b6abc6b56394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*faNZ9T2l-Xp7t8Lh6uk9PA.jpeg"/></div></div></figure><p id="894d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着廉价存储容量的发展，各行业正在产生越来越多与其活动相关的数据。一家公司可以通过建立流程来分析其产生的大量数据，从而获得竞争优势。然而，有效地使用这种数据需要大量的计算能力。</p><p id="6c87" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spark为愿意主动监控其业务并做出明智决策的公司提供了解决方案。Spark的并行处理能力使其成为快速处理大规模数据的理想选择。Spark还包括一个机器学习库，这使它成为数据科学家处理大数据有用工具。</p><p id="0a55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将使用来自音乐流媒体网站(<strong class="ih hj"> Sparkify </strong>)的日志数据集来预测用户是否会流失。对于这个分析，我们将使用Spark和IBM Watson云解决方案平台。让我们看看Spark在数据集上的表现。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="84d8" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">数据探索</strong></h1><p id="87e6" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">让我们从打开Spark会话开始分析，导入数据集并查看数据集中可用的数据:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="c4bc" class="le jx hi la b fi lf lg l lh li"><strong class="la hj">from</strong> <strong class="la hj">pyspark.sql</strong> <strong class="la hj">import</strong> SparkSession<br/>spark = SparkSession.builder.getOrCreate()<br/>df = spark.read.json(cos.url('medium-sparkify-event-data.json', 'sparkify-donotdelete-pr-n3mm1l5ansd2bd'))<br/>df.printSchema()</span><span id="c2bc" class="le jx hi la b fi lj lg l lh li">root<br/> |-- artist: string (nullable = true)<br/> |-- auth: string (nullable = true)<br/> |-- firstName: string (nullable = true)<br/> |-- gender: string (nullable = true)<br/> |-- itemInSession: long (nullable = true)<br/> |-- lastName: string (nullable = true)<br/> |-- length: double (nullable = true)<br/> |-- level: string (nullable = true)<br/> |-- location: string (nullable = true)<br/> |-- method: string (nullable = true)<br/> |-- page: string (nullable = true)<br/> |-- registration: long (nullable = true)<br/> |-- sessionId: long (nullable = true)<br/> |-- song: string (nullable = true)<br/> |-- status: long (nullable = true)<br/> |-- ts: long (nullable = true)<br/> |-- userAgent: string (nullable = true)<br/> |-- userId: string (nullable = true)</span></pre><p id="1777" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据集包含<strong class="ih hj"> 543 705 </strong>行，快速检查<strong class="ih hj"> <em class="lk"> na </em> </strong>值显示它不包含自然空值。尽管如此，仍有用户标识为空的行。删除这些行后，数据集中还剩下<strong class="ih hj"> 528 005 </strong>行。</p><p id="4bea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户在网站上的互动取决于他们访问的页面，所以让我们看看不同类型的页面:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="926b" class="le jx hi la b fi lf lg l lh li">df.select(df.page).dropDuplicates().sort(["page"]).show()</span><span id="9311" class="le jx hi la b fi lj lg l lh li">+-------------------+<br/>|                page|<br/>+--------------------+<br/>|               About|<br/>|          Add Friend|<br/>|     Add to Playlist|<br/>|              Cancel|<br/>|Cancellation Conf...|<br/>|           Downgrade|<br/>|               Error|<br/>|                Help|<br/>|                Home|<br/>|              Logout|<br/>|            NextSong|<br/>|         Roll Advert|<br/>|       Save Settings|<br/>|            Settings|<br/>|    Submit Downgrade|<br/>|      Submit Upgrade|<br/>|         Thumbs Down|<br/>|           Thumbs Up|<br/>|             Upgrade|<br/>+--------------------+</span></pre><p id="5de6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看可用页面，我们可以将客户流失定义为用户访问“取消确认”页面的行为。使用这些信息，让我们创建客户流失列:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="5eb7" class="le jx hi la b fi lf lg l lh li">churned_user=[x.userId for x in df.filter(df.page=='Cancellation Confirmation').select('userId').dropDuplicates().collect()]</span><span id="f20d" class="le jx hi la b fi lj lg l lh li">df=df.withColumn('churn',df.userId.isin(churned_user).cast('Integer'<br/>))</span></pre><p id="d5f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lk">什么是流失分布？</em>T15】</strong></p><p id="93c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在下面看到，流失再分配分布是不平衡的:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/e099f21ff198b244df2062138b5c9107.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PmR5lVXczBY2G2DZNrnqwA.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lm"><img src="../Images/8a1d0d0bb0dcec6c88086709553865e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VvqYf0CVntxl_lLuKLuJsA.png"/></div></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="68db" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">数据争论和特性工程</strong></h1><p id="4db6" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在开始构建我们的机器学习模型之前，我们将进行一些数据争论和特征工程:</p><p id="351e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lk">人口统计信息</em> </strong></p><ul class=""><li id="4796" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">性别:M或F我们编码为0或1；</li><li id="a51d" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">级别:免费或付费我们编码为0或1；</li><li id="4e97" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">isCA:如果用户位于加利福尼亚，则为1，否则为0；</li></ul><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="dc1e" class="le jx hi la b fi lf lg l lh li">df_user=df_user.withColumn("isCA",get_localisation(df_user.location_level1).cast(IntegerType()))<br/>    df_user=df_user.replace(["M", "F"], ["0", "1"], "gender")<br/>    df_user=df_user.replace(["free", "paid"], ["0", "1"], "level")<br/>    df_user=df_user.withColumn("gender",df_user.level.cast(IntegerType()))<br/>    df_user=df_user.withColumn("level",df_user.level.cast(IntegerType()))</span></pre><p id="052a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="lk">用户与网站的交互</em> </strong></p><ul class=""><li id="2981" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">每次播放的平均歌曲数和播放的歌曲总数；</li><li id="8abc" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">会话之间的平均时间；</li><li id="d305" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">每次会话的平均起伏；</li><li id="b648" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">第一次和最后一次会话之间的时间(小时)；</li></ul><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="2e8b" class="le jx hi la b fi lf lg l lh li"><em class="lk">#feature 2 - user's interactions</em><br/>    <em class="lk"># Average song played in one session and number of songs played</em><br/>    df_user_inter=df.filter((df.page=='NextSong')) \<br/>            .groupBy('userID','sessionId') \<br/>            .agg(count('sessionId').alias('nb_song')) \<br/>            .groupBy('userID') \<br/>            .agg(round(mean('nb_song'),0).alias('average_nb_song'),sum('nb_song').alias('nb_song'))<br/>    <em class="lk"># average time  between sessions</em><br/>    df_time_session=df.select('userID','sessionId','duree').dropDuplicates() \<br/>            .groupBy('userID','duree') \<br/>            .agg(count('sessionId').alias('number_of_session'))<br/><br/>    df_time_session=df_time_session.withColumn('avg_time_session',df_time_session.duree/df_time_session.number_of_session)<br/>    <em class="lk"># Tumps up/down and upvote/downvote</em><br/>    df_user_inter_tUP=df.filter((df.page=='Thumbs Up')) \<br/>            .groupBy('userID','sessionId') \<br/>            .agg(count('sessionId').alias('step')) \<br/>            .groupBy('userID') \<br/>            .agg(round(mean('step'),0).alias('av_tumpup'))<br/>    df_user_inter_tDOWN=df.filter((df.page=='Thumbs Down')) \<br/>            .groupBy('userID','sessionId') \<br/>            .agg(count('sessionId').alias('step')) \<br/>            .groupBy('userID') \<br/>            .agg(round(mean('step'),0).alias('av_tumpdown'))</span></pre><p id="3302" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终数据集包含以下数据:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="0843" class="le jx hi la b fi lf lg l lh li">root<br/> |-- label: integer (nullable = true)<br/> |-- gender: integer (nullable = true)<br/> |-- level: integer (nullable = true)<br/> |-- isCA: integer (nullable = true)<br/> |-- average_nb_song: double (nullable = true)<br/> |-- av_tumpup: double (nullable = false)<br/> |-- av_tumpdown: double (nullable = false)<br/> |-- duree: double (nullable = true)<br/> |-- avg_time_session: double (nullable = true)<br/> |-- nb_song: long (nullable = true)</span></pre><p id="4829" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看这些功能是如何相互关联的:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="123b" class="le jx hi la b fi lf lg l lh li">df_pds = df_model.toPandas()[df_model.columns[1:]]<br/>axs = pd.plotting.scatter_matrix(df_pds, figsize=(10, 10));<br/>n = len(df_pds.columns)<br/><strong class="la hj">for</strong> i <strong class="la hj">in</strong> range(n):<br/>    v = axs[i, 0]<br/>    v.yaxis.label.set_rotation(0)<br/>    v.yaxis.label.set_ha('right')<br/>    v.set_yticks(())<br/>    h = axs[n-1, i]<br/>    h.xaxis.label.set_rotation(90)<br/>    h.set_xticks(())</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mb"><img src="../Images/84be8d8b8b79b08aafc2b45922a5f78d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*l8VgG5_cMQnCr__Yc8xaxg.png"/></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="2e55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们用<strong class="ih hj">标准缩放器</strong>缩放特征，并用<strong class="ih hj">矢量组装器</strong>将所有特征合并到一列中。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="5759" class="le jx hi la b fi lf lg l lh li">assembler=VectorAssembler(inputCols=df_model.columns[1:],outputCol='features_int')<br/>    scaler = StandardScaler(inputCol="features_int", outputCol="features", withStd=<strong class="la hj">True</strong>)</span></pre><h1 id="4bdb" class="jw jx hi bd jy jz mc kb kc kd md kf kg kh me kj kk kl mf kn ko kp mg kr ks kt bi translated"><strong class="ak">训练和调整我们的模型</strong></h1><p id="0224" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">我们将在数据集上测试五个模型:</p><ul class=""><li id="3b90" class="ln lo hi ih b ii ij im in iq lp iu lq iy lr jc ls lt lu lv bi translated">逻辑回归；</li><li id="5baf" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">决策树分类器；</li><li id="4773" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">随机森林分类器；</li><li id="dd82" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">梯度推进树；和</li><li id="957a" class="ln lo hi ih b ii lw im lx iq ly iu lz iy ma jc ls lt lu lv bi translated">朴素贝叶斯。</li></ul><p id="7fdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将数据集分为训练集、测试集和验证集:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="bef2" class="le jx hi la b fi lf lg l lh li">train, test_valid=df_model.randomSplit([0.7, 0.3], seed=42)<br/>    test, valid=test_valid.randomSplit([0.5, 0.5], seed=42)</span></pre><p id="9d64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个模型都将使用管道和CrossValidator来调整参数:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="4494" class="le jx hi la b fi lf lg l lh li"><em class="lk">#Five model to test</em><br/>    models={<br/>        'Logistic Regression':LogisticRegression(maxIter=10),<br/>        'Decission Tree Classifier':DecisionTreeClassifier(),<br/>        'Random Forest Classifier':RandomForestClassifier(),<br/>        'Gradient Boosted Tree':GBTClassifier(maxIter=10),<br/>        'Naive Bayes':NaiveBayes()<br/>    }<br/>    <br/>    <em class="lk">#paramGrid for tuning</em><br/>    paramGrid={<br/>        'Logistic Regression':ParamGridBuilder() \<br/>            .addGrid( models['Logistic Regression'].regParam, [0,0.01,0.001,0.0001]) \<br/>            .addGrid(models['Logistic Regression'].family, ['binomial','multinomial']) \<br/>            .build(),<br/>        'Decission Tree Classifier':ParamGridBuilder()<br/>             .addGrid(models['Decission Tree Classifier'].maxDepth, [2,  10, 30])<br/>             .addGrid(models['Decission Tree Classifier'].maxBins, [10, 40, 100])<br/>             .build(),<br/>        'Random Forest Classifier': ParamGridBuilder() \<br/>            .addGrid(models['Random Forest Classifier'].numTrees, [10, 30, 50]) \<br/>            .addGrid(models['Random Forest Classifier'].maxDepth, [2, 10, 30]) \<br/>            .build(),<br/>        'Gradient Boosted Tree':ParamGridBuilder() \<br/>            .addGrid(models['Gradient Boosted Tree'].maxBins, [10, 40, 100]) \<br/>            .addGrid(models['Gradient Boosted Tree'].maxDepth, [2, 10, 30]) \<br/>            .build(),<br/>        'Naive Bayes':ParamGridBuilder() \<br/>            .addGrid(models['Naive Bayes'].smoothing, [0.0,0.6,1.0])\<br/>            .build()<br/>    }<br/>    <br/>    trainned_model={}<br/>    <strong class="la hj">for</strong> mdl <strong class="la hj">in</strong> models:<br/>        print('Trainning model ' + mdl)<br/>        print('...')<br/>        pipeline = Pipeline(stages = [assembler,scaler, models[mdl]])<br/>        crossval= CrossValidator(estimator=pipeline,<br/>                          estimatorParamMaps=paramGrid[mdl],<br/>                          evaluator=MulticlassClassificationEvaluator(metricName='f1'),<br/>                          numFolds=3)<br/>        model_test = crossval.fit(train)</span></pre><p id="f70a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">五个模型的精确度和F值如下所示:</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="1892" class="le jx hi la b fi lf lg l lh li">Trainning model Logistic Regression<br/>...<br/>Logistic Regression metrics:<br/>Train - Accuracy: 84.18% and F-1 Score: 82.71%<br/>Test  - Accuracy: 78.12% and F-1 Score: 80.44%<br/>Valid - Accuracy: 84.00% and F-1 Score: 82.81%</span><span id="f375" class="le jx hi la b fi lj lg l lh li">Trainning model Decission Tree Classifier<br/>...<br/>Decission Tree Classifier metrics:<br/>Train - Accuracy: 87.66% and F-1 Score: 87.25%<br/>Test  - Accuracy: 84.38% and F-1 Score: 81.25%<br/>Valid - Accuracy: 84.00% and F-1 Score: 84.00%</span><span id="eb4f" class="le jx hi la b fi lj lg l lh li">Trainning model Random Forest Classifier<br/>...<br/><strong class="la hj">Random Forest Classifier metrics:<br/>Train - Accuracy: 98.10% and F-1 Score: 98.09%<br/>Test  - Accuracy: 87.50% and F-1 Score: 84.26%<br/>Valid - Accuracy: 87.00% and F-1 Score: 86.53%</strong></span><span id="cdef" class="le jx hi la b fi lj lg l lh li">Trainning model Gradient Boosted Tree<br/>...<br/>Gradient Boosted Tree metrics:<br/>Train - Accuracy: 90.19% and F-1 Score: 89.64%<br/>Test  - Accuracy: 81.25% and F-1 Score: 81.25%<br/>Valid - Accuracy: 87.00% and F-1 Score: 87.38%</span><span id="06e0" class="le jx hi la b fi lj lg l lh li">Trainning model Naive Bayes<br/>...<br/>Naive Bayes metrics:<br/>Train - Accuracy: 79.75% and F-1 Score: 73.28%<br/>Test  - Accuracy: 65.62% and F-1 Score: 56.88%<br/>Valid - Accuracy: 85.00% and F-1 Score: 80.27%</span></pre><p id="3622" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">随机森林分类器</strong>在训练、测试和验证集上表现更好，因此我们将保持它为最佳模型。</p><p id="17d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spark使我们能够在大型数据集上相对快速地计算我们的五个机器学习模型。对于数据科学家来说，掌握这项技术基本知识是非常重要的，因为越来越多的公司愿意将它集成到他们的流程中。</p><p id="6396" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您阅读我的文章，如有任何意见或问题，请随时联系我。</p><p id="c452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在我的<a class="ae mh" href="https://github.com/Savadogo/Sparkify-project" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到详细代码。</p></div></div>    
</body>
</html>