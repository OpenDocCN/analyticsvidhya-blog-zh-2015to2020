<html>
<head>
<title>A Good Day to Delete Hard</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">努力删除的好日子</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/a-good-day-to-delete-hard-22b8be83b622?source=collection_archive---------14-----------------------#2020-01-05">https://medium.com/analytics-vidhya/a-good-day-to-delete-hard-22b8be83b622?source=collection_archive---------14-----------------------#2020-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="57d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除方法是一个重要的数据仓库概念，你最好在面试前掌握它。这不是记住两个主要方法的定义的问题(下面我从网上复制给你)，而是理解选择其中一个的后果。</p><h1 id="789a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">删除的类型有哪些？</h1><p id="4a0c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">删除方法描述了当记录被设置为删除时，数据库(或特定的表)如何变化。</p><p id="ff46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">硬删除</strong> —从表中删除整个记录。删除后，用户将无法看到该记录曾经存在过。<br/> <strong class="ih hj">软删除</strong> —记录不会从表中删除，但表中的一个字段指示它已被删除。该字段可以是布尔值，如<code class="du kg kh ki kj b">is_deleted</code>或时间戳，如<code class="du kg kh ki kj b">deleted_timestamp</code>。如果这个字段名在所有表中都是一致的，那么通常是最好的，这样用户就可以容易地、动态地找到未删除的数据集。(<a class="ae kk" href="https://www.stitchdata.com/docs/replication/deleted-record-handling" rel="noopener ugc nofollow" target="_blank">来源</a>)</p><h1 id="146f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">什么时候应该使用硬删除？</h1><p id="d515" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在分析数据仓库中，软删除不是一个好主意。利益相关者希望看到一个只有相关记录的表格；对于分析数据仓库用户来说，<code class="du kg kh ki kj b">cats_dim</code>意味着“当前活跃的猫的列表”参见下表作为反例:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es kl"><img src="../Images/802e38cb392f7b2f2c538a76564bf37e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*9d1jN8n1UAKt659NxSRpVQ.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">猫_dim</figcaption></figure><p id="6f3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个分析师(他可能没有读过所有的字段名，因为提供的字段名可能不止三个)可能会很快尝试用<code class="du kg kh ki kj b">select count(*) from cats_dim</code>找到当前猫的数量</p><p id="1bfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这会给她三只猫，而不是两只的真实答案(当然我们不能收养寿司，尽管他很可爱)。我们的内心已经很充实了)。</p><p id="130d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这不是世界上最糟糕的错误，但是想象一下，不是<code class="du kg kh ki kj b">count(*)</code>，而是<code class="du kg kh ki kj b">sum(revenue)</code>。现在想象一下，这个指标被报告给一个主管。你明白我的意思了吧。</p><p id="8bd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照惯例，在数据仓库中，我们会进行硬删除。但这并不意味着我们在任何地方都这样做。</p><h1 id="f46f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">什么时候应该使用软删除？</h1><p id="a0b7" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我们知道，当用户只需要当前数据时，硬删除是有帮助的，但是还有其他类型的用户。例如，从源数据库编写ETL的团队——我们！</p><p id="a8ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为ETL的一部分，我们从源数据库中检索数据集，无论是完全提取还是增量提取。在完整提取中，每当我们需要更多数据时，我们都会提取整个数据集(数据集通常是一个表，但也可以是API端点的一个报告)。这是计算开销最大的获取数据的方式，但最容易编码。</p><p id="3a7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在增量提取的情况下，我们只查询尚未从源中看到的数据。我们可以使用一个元数据字段来编写这个查询，该字段表示源数据库中该记录最后一次被修改的时间(我喜欢将这个字段称为last_modified_timestamp，但您通常会看到它被称为systimestamp或sysmodtimestamp)。在我们的提取查询中，我们有效地说“昨天我得到了截至2019-01-01的数据，请给我从那以后更新的数据。”这允许我们提取和加载更少的行，节省计算和可能的存储。</p><p id="9523" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，如果源数据库执行硬删除会发生什么呢？假设我们从源中一个名为cat _ hospitalization _ fact的表中提取数据。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kx"><img src="../Images/96742966680502c103728e0d8234d640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oCyQpPwwYGfHv0w5N2Ur8g.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">cat _住院治疗_事实</figcaption></figure><p id="2320" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们在2019年12月19日从该表中增量提取，我们会收到所有这三行。现在，假设我们在2019年12月20日重新查看该表，结果如下:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lc"><img src="../Images/9f5caa1f5e657d0087f3a08d00b519bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GU3-lcRqM2-fPA1qvicpQ.png"/></div></div></figure><p id="26c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们提取时，我们将得到一个关于金枪鱼的新行。我们数据库中的表将如下所示:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ld"><img src="../Images/635eaaf658c3c672f4aa9f1514bbfc1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NPi9kEpvKpe0JTQACcRefg.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">cat _住院治疗_事实</figcaption></figure><p id="69d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当与来源相比，这是错误的，因为它仍然有寿司的住院治疗。不管什么原因，寿司住院被删了。为了知道这一点，我们必须将提取日期设置回2019-12-18，但是，由于我们无法知道哪些记录将在何时被删除，我们实际上必须将提取日期设置回时间的开始，以考虑硬删除。这只是一个满载。</p><p id="fb83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当源数据库有硬删除时，我们必须进行完整的提取，以确保我们不会误报数据。这非常昂贵，尤其是随着数据的增长。如果源数据库使用了软删除，它将如下所示:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es le"><img src="../Images/25ecedbbf95b080edbeacd713432c117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*otm4q7wM7Sqe773rlhilVA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">cat _住院治疗_事实</figcaption></figure><p id="3270" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们第二次提取数据时(2019年12月20日)，我们会收到:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lf"><img src="../Images/6261c75e33be80cd20b925fe451c5221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xRDt8z6TlVDiadRmuaCHw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">cat _住院治疗_事实</figcaption></figure><p id="aa8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将向我们表明，Sushi的记录已被删除，而不必提取整个数据集。我们可以保持我们的增量负载，但不夸大数据。</p><p id="3181" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从源数据库所有者的角度来看，软删除的另一个优点是更容易恢复。</p><p id="f5d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，一旦我们有了这个软删除，我们该怎么办呢？很简单，我们可以在merge语句中使用(这个例子是<a class="ae kk" href="https://docs.snowflake.net/manuals/sql-reference/sql/merge.html" rel="noopener ugc nofollow" target="_blank">雪花特定的</a>)。</p><p id="dea2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的merge语句应该是这样的:</p><pre class="km kn ko kp fd lg kj lh li aw lj bi"><span id="1fd5" class="lk je hi kj b fi ll lm l ln lo">MERGE INTO cat_hospitalization_fact as t<br/>USING source_data as s<br/>ON t.cat_id = s.cat id<br/>AND t.hospitalization_date = s.hospitalization_date<br/>WHEN MATCHED THEN UPDATE SET<br/>t.cat_name  = s.cat_name,<br/>t.hospitalization_reason = s.hospitalization_reason,<br/>WHEN NOT MATCHED THEN INSERT<br/>(cat_id, cat_name, hospitalization_reason, hospitalization_date)<br/>VALUES <br/>(s.cat_id, s.cat_name, s.hospitalization_reason, s.hospitalization_date)<br/>WHEN MATCHED AND s.is_delete = ‘Y’ THEN DELETE</span></pre><p id="4740" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意最后一行——我们可以使用软删除从源数据库中删除表中的记录。对于硬删除，我们无法做到这一点；缺少行不能在合并中创建删除，只有字段指示它的删除。在硬删除的情况下，我们必须执行单独的<a class="ae kk" href="https://docs.snowflake.net/manuals/sql-reference/sql/delete.html" rel="noopener ugc nofollow" target="_blank"> DELETE语句</a>。</p><h1 id="4f57" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="aeff" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">软删除和硬删除之间没有明确的赢家；各有各的用法和优点。话虽如此，我不能强调这一点不够，不要让你的猫吃线。还有，我能借点钱吗？猫手术很贵。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lp"><img src="../Images/6e1c61cbedf324d09780f3ee15e5fc6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UzLyTrDDktg3mJuQ"/></div></div></figure><p id="4253" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的小锥头猫在手术后从他的肠子里取出线</p></div><div class="ab cl lq lr gp ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hb hc hd he hf"><p id="9981" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lx">原载于</em><a class="ae kk" href="http://www.alisa-in.tech/sql/2019/10/12/deletes.html" rel="noopener ugc nofollow" target="_blank"><em class="lx">http://www . alisa-in . tech</em></a><em class="lx">。</em></p></div></div>    
</body>
</html>