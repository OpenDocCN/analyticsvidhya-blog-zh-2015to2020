<html>
<head>
<title>Anti-patterns which all Cassandra users must know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">所有Cassandra用户都必须知道的反模式</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/anti-patterns-which-all-cassandra-users-must-know-1e54c60ff1fa?source=collection_archive---------1-----------------------#2020-06-20">https://medium.com/analytics-vidhya/anti-patterns-which-all-cassandra-users-must-know-1e54c60ff1fa?source=collection_archive---------1-----------------------#2020-06-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cba0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再多的性能调优也无法减轻已知的反模式。当你在谷歌上搜索“Cassandra中的反模式”时，你会找到很多信息。Datastax做了大量的工作，列出了其中的许多，但这还不是全部。我的目标是在一个地方记下所有列出的反模式。这对每个Cassandra用户来说都是非常重要的。</p><p id="389c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.写前读:写前读模式两个主要缺点是a .性能影响b .如果多个客户端应用程序并行访问相同的记录，您将无法实现原子比较和设置。为了解决后一个问题，用户最终在Cassandra中使用LWT(轻量级交易)。但是这恶化了延迟方面的性能。<br/>改变数据模型的最佳方式是避免这种模式。<a class="ae jd" href="https://easyprograming.com/posts/2017/08/cassandra-deep-dive-read-before-write-evil/" rel="noopener ugc nofollow" target="_blank">这个</a>是一个非常好的帖子，其中有一些数据模型变化的好例子。</p><p id="5c8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.集合意味着存储/反规范化相对少量的数据。使用(单个)集合来存储大量数据是一种反模式。尽管地图和列表的最大大小是2 GB，但用户应该尽量保持比MBs小得多的值。</p><p id="2f57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.宽分区是Cassandra中多个问题的根本原因。一个经验法则是不要超过100 MB，然而一个好的数据模型设计应该使它更小。小贴士:桶化在这里可以有所帮助。例如，存储物联网应用的传感器事件，而不是将主键保持为(sensor_id，insert_time ),这将导致每个传感器的宽分区，可能将其更改为((sensor_id，date) insert_time)更有意义。事件虽然<a class="ae jd" href="https://issues.apache.org/jira/browse/CASSANDRA-11206" rel="noopener ugc nofollow" target="_blank">CASSANDRA-11206</a>(3.5+版本)在一定程度上移动了宽分区的屏障，但仍然建议不要有太宽的分区。</p><p id="d175" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.将大的有效负载存储为数据类型为text或blob的列是不明智的。建议的实际大小小于1 MB，但尽量保持在Kbs。小贴士:把大文件放在像S3这样的存储桶里，把元数据/引用链接保存在Cassandra表中，或者如果Cassandra是你唯一的选择，把一个大的blob分成几个小块，放在不同的行里。</p><p id="48fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.没有分区键的Select all或select count将导致全表扫描，不应在大型数据集上运行。</p><p id="e62d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.物化视图是一个实验性的特性，应该在生产中避免。</p><p id="06fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.非常小心地使用Cassandra二级索引。SI在高或低的肉欲场上不是一个明智的决定。</p><p id="0856" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.队列类型数据结构(一旦使用就删除) :队列反模式提醒人们，任何依赖于数据删除的设计都可能是性能很差的设计。Cassandra提供了<em class="je"> tombstone_warn_threshold </em>配置参数来警告您是否已经这样设计了您的数据模型。</p><p id="b3e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">9.“允许过滤”基本上是指需要扫描一堆数据来返回其中的一部分，相当于sql数据库中的全表扫描。我读到的最有趣的定义之一是“允许过滤”实际上意味着“允许我销毁我的应用程序和集群”这意味着数据模型不支持查询，并且不能伸缩。话虽如此，如果你真的知道你在做什么，你仍然可以使用它，例如通过指定分区键来允许查询过滤。</p><p id="3a37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">10.多分区批处理:如果我们使用批处理查询，并且它的大小很大，这将导致协调器级别的延迟。来自RDBMS的人应该记住这一点，多分区批处理不会提供更好的性能。多分区批处理是Cassandra中的一种反模式，所以要避免。Cassandra中的Batch (Logged)应该用于在多个非规范化表中保持写原子性。以下是与批处理相关的一些配置参数。</p><blockquote class="jf jg jh"><p id="2e91" class="if ig je ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">batch _ size _ WARN _ threshold _ in _ kb<br/>(默认值:每批5KB)使Cassandra在任何批大小超过此千字节值时记录一条警告消息。<br/>注意:<br/>增加这个阈值会导致节点不稳定。<br/>batch _ size _ fail _ threshold _ in _ kb<br/>(默认值:每批50KB)Cassandra会使任何大小超过此设置的批处理失败。默认值是批处理大小警告阈值以kb为单位的值的10倍</p></blockquote><p id="106c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">11.在生产中不使用推荐的<a class="ae jd" href="https://docs.datastax.com/en/dse/6.7/dse-admin/datastax_enterprise/config/configRecommendedSettings.html" rel="noopener ugc nofollow" target="_blank">设置</a>运行肯定是“否”。</p><p id="6d15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">12.最大堆大小太小:根据我的经验，Cassandra在小于8GB的堆上生产看起来太小了。所以8 GB是绝对的最小值，除非你很少阅读。如果您有8GB MAX_HEAP_SIZE，请继续使用CMS。对于G1，从16 GB或至少12 GB开始。</p><p id="3b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">13.最大堆大小太大:即使使用G1，也不建议超过32GB。它将产生递减的结果。MAX_HEAP_SIZE的最佳值将取决于多种因素，如访问模式、数据模型、每个节点的数据等，因此尝试调整它，看看哪个值最适合您。</p><p id="d417" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">13.不建议使用IN子句的Multi-get，因为它会给单个节点带来压力，因为通常必须查询许多节点，而并发的多个单独选择更可取。</p><p id="4836" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">14.列表与集合:列表上的一些操作确实在本地存储上执行写前读。此外，一些列表操作本质上不是等幂的，这使得它们在超时的情况下重试是有问题的。因此，建议尽可能选择集合而不是列表。</p><p id="23d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">15.使用SAN或NAS成为IO和网络路由方面的瓶颈，因此避免使用SAN或NAS，而是使用本地磁盘SSD或旋转磁盘。</p><p id="8a02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">17.如果由于io模式冲突而使用旋转磁盘，则保持commitlog和ssd在同一个磁盘中。如果是SSD或者EC2就可以了。</p><p id="18b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">16.在C*前面放一个负载均衡器是完全没有必要的，只会增加另一个故障点。而是使用具有不同类型负载平衡策略的驱动程序。</p><p id="f1eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">18.如果您在AWS上运行C*，EBS卷是有问题的。它是不可预测的，并且在许多情况下吞吐量是有限的。请使用临时设备，而不是将其分条。</p><p id="27ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">19.行缓存:行缓存有一个更加有限的用例。行缓存将整个分区拉入内存。如果该分区的任何部分被修改，则该行的整个缓存都将失效。对于大分区，这意味着缓存可能会频繁地缓存和失效大块内存。因为您确实需要大部分静态分区，所以对于大多数用例，建议您不要使用行缓存。</p><p id="6cd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">21.绑定空值:将空值绑定到准备好的语句参数会生成tombstones (java驱动示例:<em class="je">boundstatements . add(prep stmt . bind(1，null)) ) </em>，但是在Cassandra 2.2+中保留未设置的绑定参数结合DataStax Java驱动3.0.0+不会创建tombstone。因此，如果值为空，则不要添加绑定值。</p><p id="433b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">22.同一列上的密集更新:这将在读取期间导致性能影响，因为需要多个表扫描。为了避免这种情况，如果您的I/O能够跟上，请使用分级压缩。否则，请更改您的数据模型，参见下面的示例:</p><blockquote class="jf jg jh"><p id="e9d4" class="if ig je ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">设计不好:<br/>创建表sensor_data ( id long，value double，PRIMARY KEY(id))；<br/>更新传感器_数据集值=？其中id =？—这是对相同id的频繁操作<br/>从sensor_data中选择值，其中id =？—这里您将获得读取延迟(最坏的情况:超时)</p><p id="2977" class="if ig je ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">更好的设计:<br/>创建表sensor_data ( id长，日期时间戳，值双精度，主键(id，date))带聚类顺序(日期desc)；<br/>插入sensor_data (id，date，value)值(？, ?, ?);<br/>从sensor_data中选择值，其中id =？极限1；—您将获得最新的传感器值</p></blockquote><p id="79e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">23.并发模式和拓扑变化:这种设计的一个例子是每天创建/删除表(单独的表用于每日数据)。当您尝试更改拓扑(例如添加/删除节点)时，问题出现了，并且在您的拓扑更改正在进行时，您的应用程序尝试将DDL作为日常事务的一部分来执行。并发的模式更改和拓扑更改是一种反模式。</p><p id="7305" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">24.混合版本群集中的DDL或DCL操作:请在升级过程中避免它们..应该在步骤前或步骤后完成。</p><p id="07db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">25.在更新期间，任何涉及流的活动，如修复、扩大或缩小，都会给你带来麻烦，所以要避免。混合版本集群只支持跨版本读写。</p><p id="aeba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">26.不要试图在不同版本的Cassandra中保留同一个集群的两个数据中心。这仅适用于您正在升级集群的情况。</p><p id="bf44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">27.并发引导多个节点:并发引导可能会导致节点之间的令牌范围移动不一致。要安全引导每个节点，请尝试顺序引导。添加单独的dc节点时，可以通过设置<em class="je"> auto_bootstrap=false </em>并遵循新dc中两次连续启动之间的2分钟暂停规则来添加。</p><p id="ff5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">28.在所有节点上运行完全修复(不带任何参数的nodetool repair)以避免副本的冗余修复:尝试使用子范围修复(最好使用reaper之类的工具)或在每个节点上顺序运行nodetool repair -pr。请记住，Cassandra 4.0在修复和固定增量修复方面有了很大的改进，值得一试。</p><p id="2e4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">29.表太多:集群中的表太多可能会导致高内存使用率和压缩问题导致性能大幅下降。尽量保持计数少于200。</p><p id="5bcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">30.使用字节序分区器:不推荐使用字节序分区器(BOP)。请改用虚拟节点(vnodes)。</p><p id="f4a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">31.CPU频率缩放:正如Datastax提到的，最近的Linux系统包括一个称为CPU频率缩放或CPU速度缩放的特性。它允许动态调整服务器的时钟速度，以便当需求或负载较低时，服务器可以以较低的时钟速度运行。这降低了服务器的功耗和热量输出(这会显著影响冷却成本)。不幸的是，这种行为对运行DataStax产品的服务器有不利影响，因为吞吐量可能会被限制在较低的速率。</p><p id="8954" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">32.不熟悉linux:操作员必须了解一些基本的故障排除Linux命令来指出问题。例如:top、dstat、iostat、mpstat、iftop、sar、lsof、netstat、htop、vmstat等。需要一个单独的博客来涵盖所有这些。</p><p id="8ff2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">33.测试不足:确保在规模和生产负荷下进行测试。这是确保您的系统在应用程序上线时正常运行的最佳方式。要正确测试，请参见生产前测试集群的数据表<a class="ae jd" href="https://docs.datastax.com/en/dse-planning/doc/planning/planningTesting.html" rel="noopener ugc nofollow" target="_blank">提示</a>。</p><p id="b6f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">34.多次准备同一个查询通常是一种反模式，可能会影响性能。Cassandra也为same生成警告消息“重新准备已经准备好的查询”。</p><p id="3a4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">35.用RF=1运行Cassandra。你为什么要这么做？你没有使用Cassandra来避免单点故障吗？</p><p id="0a64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">36.在生产中使用简单策略。简单的复制策略可用作测试集群。网络拓扑系统策略应优先于简单策略，以便于以后向集群添加新的物理或虚拟数据中心</p><p id="f2bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">37.如果使用GossipingPropertyFileSnitch 和Cassandra-topology.properties仍然存在于服务器中，可能会导致一些不必要的行为，例如:在节点工具状态输出中显示不同的节点已关闭，或者当重新启动一个节点而其他节点已关闭时，节点工具状态以错误的dc名称显示所有已关闭的节点。当文件存在时，<em class="je">GossipingPropertyFileSnitch</em>总是加载Cassandra-topology.properties。从任何新集群或从<em class="je"> PropertyFileSnitch </em>迁移的任何集群上的每个节点中删除该文件。</p><p id="f0c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">38.不要在相同记录上混合普通写入和LWT写入，以避免并发执行期间的不一致性。此外，并行对同一记录进行正常读取(一致性仲裁)的LWT写入可能会显示过时数据，因此为了避免这种不一致性，请使用具有一致性的串行/本地串行读取。<br/> <br/>参考文献:<br/> 1。<a class="ae jd" href="https://docs.datastax.com/en/dse-planning/doc/planning/planningAntiPatterns.html" rel="noopener ugc nofollow" target="_blank">https://docs . datas tax . com/en/DSE-planning/doc/planning/planning anti patterns . html</a><br/>2 .<a class="ae jd" href="https://strange-loop-2012-notes.readthedocs.io/en/latest/tuesday/Cassandra.html" rel="noopener ugc nofollow" target="_blank">https://strange-loop-2012-notes . readthe docs . io/en/latest/Tuesday/Cassandra . html</a><br/>3 .<a class="ae jd" href="https://www.slideshare.net/doanduyhai/Cassandra-nice-use-cases-and-worst-anti-patterns" rel="noopener ugc nofollow" target="_blank">https://www . slide share . net/doanduyhai/Cassandra-nice-use-cases-and-worst-anti-patterns</a></p></div></div>    
</body>
</html>