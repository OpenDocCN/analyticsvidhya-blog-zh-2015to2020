<html>
<head>
<title>Python multithreading: Introduce concurrency into your programs.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 多线程:在你的程序中引入并发性。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/python-multithreading-introduce-concurrency-into-your-programs-bf9e837667ad?source=collection_archive---------20-----------------------#2020-11-19">https://medium.com/analytics-vidhya/python-multithreading-introduce-concurrency-into-your-programs-bf9e837667ad?source=collection_archive---------20-----------------------#2020-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="cba7" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">多线程操作</h2><div class=""/><div class=""><h2 id="2ce0" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">轻松地将任何一段 python 代码转换成异步线程程序。</h2></div><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/09ff58fa78c3de5af2c4bfb23d0c64bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bDTsSEQ9zP5_XEqw"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx translated">JOSHUA COLEMAN 在<a class="ae jw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="jx"><p id="e6ea" class="jy jz hi bd ka kb kc kd ke kf kg kh dx translated">当任务是相同的，只是它们操作的数据不同，并且可以以任何顺序执行时，问题就被说成是令人尴尬的<em class="ki">并行</em></p></blockquote><p id="0083" class="pw-post-body-paragraph kj kk hi kl b km kn is ko kp kq iv kr ks kt ku kv kw kx ky kz la lb lc ld kh hb bi le translated">oncurrency 在需要执行 n 次特定动作的算法中效果最好。如果这个操作在我们的计算机范围之外(等待 api 的响应),多线程是最理想的选择，可以最大限度地减少未使用的计算资源。</p><p id="314d" class="pw-post-body-paragraph kj kk hi kl b km ln is ko kp lo iv kr ks lp ku kv kw lq ky kz la lr lc ld kh hb bi translated">Python 经常被指出难以用于多线程任务。然而,<a class="ae jw" href="https://docs.python.org/3/library/concurrent.futures.html" rel="noopener ugc nofollow" target="_blank"> concurrent.futures </a>包的 ThreadPoolExecutor 模块部分(Python 标准库的一部分)为我们提供了一种简单的方法，无需对我们的原始代码进行重大修改。</p><h1 id="fbf7" class="ls lt hi bd lu lv lw lx ly lz ma mb mc ix md iy me ja mf jb mg jd mh je mi mj bi translated"><strong class="ak">用例:多个 api 调用</strong></h1><p id="34fe" class="pw-post-body-paragraph kj kk hi kl b km mk is ko kp ml iv kr ks mm ku kv kw mn ky kz la mo lc ld kh hb bi translated">让我们从一段简单的代码开始，这段代码将向 swapi.dev api 发出 n 个请求。SWAPI 是一个星球大战 API，它包含一个可以通过 REST API 使用的数据集。</p><p id="985a" class="pw-post-body-paragraph kj kk hi kl b km ln is ko kp lo iv kr ks lp ku kv kw lq ky kz la lr lc ld kh hb bi translated">第一个端点将给出数据集中不同人的数量:</p><pre class="jh ji jj jk fd mp mq mr ms aw mt bi"><span id="f529" class="mu lt hi mq b fi mv mw l mx my"><strong class="mq hs">import</strong> <strong class="mq hs">requests</strong></span><span id="53c0" class="mu lt hi mq b fi mz mw l mx my">url = 'https://swapi.dev/api/people/'<br/>r = requests.get(url)<br/>print(r.json()['count'])<br/># &gt;&gt; 82</span></pre><p id="301e" class="pw-post-body-paragraph kj kk hi kl b km ln is ko kp lo iv kr ks lp ku kv kw lq ky kz la lr lc ld kh hb bi translated">使用个人标识符(标识符从 1 到 83)，我们可以获得一个人的信息:</p><pre class="jh ji jj jk fd mp mq mr ms aw mt bi"><span id="77e1" class="mu lt hi mq b fi mv mw l mx my"><strong class="mq hs">import</strong> <strong class="mq hs">requests</strong></span><span id="26f3" class="mu lt hi mq b fi mz mw l mx my">url = 'https://swapi.dev/api/people/1'<br/>r = requests.get(url)<br/>print(r.json())</span><span id="531d" class="mu lt hi mq b fi mz mw l mx my">&gt;&gt;<br/>{<br/>    'name': 'Luke Skywalker',<br/>    'height': '172',<br/>    'mass': '77',<br/>    'hair_color': 'blond',<br/>    'skin_color': 'fair',<br/>    'eye_color': 'blue',<br/>    'birth_year': '19BBY',<br/>    ...<br/>}</span></pre><p id="f685" class="pw-post-body-paragraph kj kk hi kl b km ln is ko kp lo iv kr ks lp ku kv kw lq ky kz la lr lc ld kh hb bi translated">现在让我们创建一个人员 id 列表，以便能够遍历它们，向 swapi api 发出请求，并将每个 id 作为输入参数。</p><h2 id="5833" class="mu lt hi bd lu na nb nc ly nd ne nf mc ks ng nh me kw ni nj mg la nk nl mi ho bi translated">单线程</h2><pre class="jh ji jj jk fd mp mq mr ms aw mt bi"><span id="4b58" class="mu lt hi mq b fi mv mw l mx my"><strong class="mq hs">import</strong> <strong class="mq hs">requests<br/>from</strong> <strong class="mq hs">datetime</strong> <strong class="mq hs">import</strong> <strong class="mq hs">datetime</strong></span><span id="b3c7" class="mu lt hi mq b fi mz mw l mx my">input_ids = list(range(1, 84)) * 5<br/># Increase the items of the list to simulate higher load<br/>response_list = ['-'] * <strong class="mq hs">len</strong>(input_ids)</span><span id="ef4e" class="mu lt hi mq b fi mz mw l mx my"><strong class="mq hs">def</strong> <strong class="mq hs">request_person</strong>(person_id, idx):<br/>    url = f'<a class="ae jw" href="https://swapi.dev/api/people/{person_id}'" rel="noopener ugc nofollow" target="_blank">https://swapi.dev/api/people/{person_id}'</a><br/>    <strong class="mq hs">try</strong>:<br/>        r = requests.get(url)<br/>        response_list[idx] = r.json()['name']<br/>    <strong class="mq hs">except</strong> <strong class="mq hs"><em class="nm">Exception</em></strong> <strong class="mq hs">as</strong> e:<br/>        return</span><span id="a0ef" class="mu lt hi mq b fi mz mw l mx my">start = datetime.now()<br/><strong class="mq hs">for</strong> idx, _id <strong class="mq hs">in</strong> enumerate(input_ids):<br/>    <strong class="mq hs">request_person</strong>(_id, idx)</span><span id="fd39" class="mu lt hi mq b fi mz mw l mx my">print(datetime.now() - start)</span><span id="0897" class="mu lt hi mq b fi mz mw l mx my"><strong class="mq hs"><em class="nm">&gt;&gt; 0:01:04.925463</em></strong></span></pre><p id="9bbe" class="pw-post-body-paragraph kj kk hi kl b km ln is ko kp lo iv kr ks lp ku kv kw lq ky kz la lr lc ld kh hb bi translated">现在让我们用 ThreadPoolExecutor 将它转换成一个多线程任务:</p><h2 id="8d5e" class="mu lt hi bd lu na nb nc ly nd ne nf mc ks ng nh me kw ni nj mg la nk nl mi ho bi translated">多线程</h2><pre class="jh ji jj jk fd mp mq mr ms aw mt bi"><span id="094b" class="mu lt hi mq b fi mv mw l mx my"><strong class="mq hs">import requests<br/>from concurrent.futures import ThreadPoolExecutor<br/>from datetime import datetime</strong></span><span id="d60b" class="mu lt hi mq b fi mz mw l mx my">input_ids = list(range(1, 84)) * 5<br/>response_list = ['-'] * len(input_ids)</span><span id="6c90" class="mu lt hi mq b fi mz mw l mx my"><strong class="mq hs">def</strong> <strong class="mq hs">request_person</strong>(person_id, idx):<br/>    url = f'<a class="ae jw" href="https://swapi.dev/api/people/{person_id}'" rel="noopener ugc nofollow" target="_blank">https://swapi.dev/api/people/{person_id}'</a><br/>    <strong class="mq hs">try</strong>:<br/>        r = requests.get(url)<br/>        response_list[idx] = r.json()['name']<br/>    <strong class="mq hs">except</strong> <strong class="mq hs"><em class="nm">Exception</em></strong> <strong class="mq hs">as</strong> e:<br/>        return</span><span id="d837" class="mu lt hi mq b fi mz mw l mx my">start = datetime.now()<br/><strong class="mq hs">with</strong> ThreadPoolExecutor(max_workers=20) as executor:    <br/>    [executor.submit(<strong class="mq hs">request_person</strong>, person_id=_id, idx=idx) for idx, _id <strong class="mq hs">in</strong> enumerate(input_ids)]</span><span id="81dd" class="mu lt hi mq b fi mz mw l mx my"><strong class="mq hs">print</strong>(f'Time taken: {datetime.now() - start}')</span><span id="271b" class="mu lt hi mq b fi mz mw l mx my"><strong class="mq hs"><em class="nm">&gt;&gt; 0:00:10.516984</em></strong></span></pre><p id="6c71" class="pw-post-body-paragraph kj kk hi kl b km ln is ko kp lo iv kr ks lp ku kv kw lq ky kz la lr lc ld kh hb bi translated">所以基本上，只增加几行额外的代码，我们就可以减少 7%的程序执行时间。</p><h1 id="e1ad" class="ls lt hi bd lu lv lw lx ly lz ma mb mc ix md iy me ja mf jb mg jd mh je mi mj bi translated">结论</h1><p id="c58d" class="pw-post-body-paragraph kj kk hi kl b km mk is ko kp ml iv kr ks mm ku kv kw mn ky kz la mo lc ld kh hb bi translated">有许多方法可以将并发性引入我们的 Python 程序，选择最佳方法将取决于您的具体用例。希望本文中的例子有助于您了解这个主题，并帮助您在以后的案例中进行复制。</p><blockquote class="nn no np"><p id="d17b" class="kj kk nm kl b km ln is ko kp lo iv kr nq lp ku kv nr lq ky kz ns lr lc ld kh hb bi translated">感谢阅读这篇文章！有问题就在下面留言评论吧！</p></blockquote></div></div>    
</body>
</html>