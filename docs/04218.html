<html>
<head>
<title>Descriptive Image Tag Suggestion In a Streamlit App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Streamlit应用程序中的描述性图像标签建议</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/descriptive-image-tag-suggestion-in-a-streamlit-app-a17f09b49c4e?source=collection_archive---------6-----------------------#2020-03-10">https://medium.com/analytics-vidhya/descriptive-image-tag-suggestion-in-a-streamlit-app-a17f09b49c4e?source=collection_archive---------6-----------------------#2020-03-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="985c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用Tensorflow和Streamlit构建一个基于Web的图像标签建议应用程序</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/c53afc9a053956e737922a165b6edd27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZZQ9l8G56yx62qtSG1mRQ.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@ideasboom?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">蒙</a>在<a class="ae jt" href="https://unsplash.com/s/photos/nature?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="99d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将建立一个系统，可以使用视觉模型对图像进行自动标签建议。这意味着有一个图像作为输入，它将预测描述这个图像的标签的排序列表。这对于应用于图像集合的图像搜索或推荐是有用的。这个项目将基于一个叫做开放图像V6:<a class="ae jt" href="https://storage.googleapis.com/openimages/web/download.html" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/openimages/web/download.html</a>的惊人图像数据集。它有7，337，077个带有边界框、类别信息和图像级标签的图像。</p><p id="e478" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7，337，077百万幅图像中的每幅图像都有一个或多个与其相关联的标签，这些标签来自总共19，958个标签的集合</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ju"><img src="../Images/7792b086f55951eb7f387dd8e246a112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qZBnDsvSbioBdpEYqpy5TQ.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图片来自Unsplash</figcaption></figure><p id="f092" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，该图像可能有树木、雪、天空等标签……这些类型的标签可用作弱监督，以构建一个视觉模型，尝试预测最能描述图像的标签。</p><h1 id="c31f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">模型</h1><p id="4908" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">这里使用的模型与我在之前的一篇文章中描述的模型非常相似(<a class="ae jt" href="https://towardsdatascience.com/building-a-deep-image-search-engine-using-tf-keras-6760beedbad" rel="noopener" target="_blank">https://towards data science . com/building-a-deep-image-search-engine-using-TF-keras-6760 beed bad</a>)。</p><p id="78e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所使用的模型具有一个将每个图像编码成(50，1)向量的MobileNetV2子模型，以及将正标签和负标签编码成两个独立的(50，1)向量的嵌入子模型。</p><p id="c8e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用三重损失，其目的是将图像表示和阳性标记的嵌入拉得更近。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ky"><img src="../Images/4c5c2308353c4db5a1d5748c765b0a25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*5gnodeMtIGm0TaP5Y1Itug.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">由Unsplash修改的小狗图像</figcaption></figure><p id="4884" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图像子模型产生锚<strong class="ih hj"> E_a </strong>的表示，嵌入子模型输出正标签<strong class="ih hj"> E_p </strong>的嵌入和负标签<strong class="ih hj"> E_n </strong>的嵌入。</p><p id="a9f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们通过优化以下三重损失进行训练:</p><p id="d993" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> L = max( d(E_a，E_p)-d(E_a，E_n)+alpha，0) </strong></p><p id="a7e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中d是欧几里德距离，α是在该实验中等于0.4的超参数。</p><p id="b19c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本上，这种损失允许做的是使<strong class="ih hj"> d(E_a，E_p) </strong>变小，使<strong class="ih hj"> d(E_a，E_n) </strong>变大，使得每个图像表示接近其标签的嵌入，而远离随机标签的嵌入。</p><p id="2799" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当进行预测时，我们计算一次图像的表示，并计算它到每个标签嵌入的距离。然后，我们将距离转换为“分数”，并从最高到最低对分数进行排序。我们返回前k个得分最高的标签。</p><h1 id="a42a" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">构建用户界面</h1><p id="0b1f" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">我们将使用Streamlit python库来构建一个web应用程序，该应用程序允许我们上传一个jpg图像，然后接收前20个最可能的标签。</p><p id="1a3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Streamlit使得直接从浏览器构建用python构建的类似“演示”的应用程序变得容易。</p><p id="3069" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个软件包的使用非常简单。我们想做的是:</p><ul class=""><li id="dd6d" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">上传图像文件。</li><li id="d38a" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">预测图像的前20个最可能的标签。</li><li id="4a4d" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">在一个漂亮的图中显示结果。</li></ul><p id="f9ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们加载预测器类:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="bf5a" class="ls jw hi lo b fi lt lu l lv lw">image_predictor = predictor.ImagePredictor.init_from_config_url(predictor_config_path)                       label_predictor = predictor.LabelPredictor.init_from_config_url(predictor_config_path)</span></pre><ol class=""><li id="66de" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc lx lf lg lh bi translated">上传图像文件:</li></ol><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="f1c1" class="ls jw hi lo b fi lt lu l lv lw">import streamlit as st<br/>import matplotlib.pyplot as plt # To plot the image<br/>import altair as alt # To plot the label ranking</span><span id="1679" class="ls jw hi lo b fi ly lu l lv lw">file = st.file_uploader("Upload file", type=["jpg"])</span></pre><p id="5848" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.预测前20个标签:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="d9b8" class="ls jw hi lo b fi lt lu l lv lw">if file:<br/>    # Compute image representation<br/>    pred, arr = image_predictor.predict_from_file(file)<br/>    plt.imshow(arr)<br/>    plt.axis("off")<br/>    # Plot the image to the web page<br/>    st.pyplot()<br/>    # predict the labels<br/>    data = label_predictor.predict_dataframe_from_array(pred)</span></pre><p id="9796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.显示结果:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="de97" class="ls jw hi lo b fi lt lu l lv lw">bars = (<br/>        alt.Chart(data)<br/>        .mark_bar()<br/>        .encode(x="scores:Q", y=alt.X("label:O", sort=data["label"].tolist()),)<br/>    )</span><span id="4ca5" class="ls jw hi lo b fi ly lu l lv lw">text = bars.mark_text(<br/>        align="left",<br/>        baseline="middle",<br/>        dx=3,<br/>    ).encode(text="label")</span><span id="d23a" class="ls jw hi lo b fi ly lu l lv lw">(bars + text).properties(height=900)</span><span id="58bc" class="ls jw hi lo b fi ly lu l lv lw">st.write(bars)</span></pre><p id="b7d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">搞定了。</p><p id="5a8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果是:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lz"><img src="../Images/7ef8005331384c87fc80b259b45e5204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/1*h5PhlvuwuEtRO8if3KxUmw.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Unsplash中的树木图像</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ma"><img src="../Images/9ed56257ea0a0480f9bbe76b47c0e671.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*-JrVxd9Jvg5PGD-QpuUqTg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">预测图</figcaption></figure><p id="38d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有些建议非常准确，比如树、植物或陆生植物，但其他建议一般，我猜处理19，000个可能的标签对于一个小小的MobileNet来说太多了😅。</p><h2 id="7f8e" class="ls jw hi bd jx mb mc md kb me mf mg kf iq mh mi kj iu mj mk kn iy ml mm kr mn bi translated">码头工人</h2><p id="09df" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">您可以使用docker轻松地在本地运行这个应用程序。只需克隆帖子末尾引用的repo，并构建此docker映像:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="03b8" class="ls jw hi lo b fi lt lu l lv lw">FROM python:3.6-slim<br/>COPY image_tag_suggestion/main.py image_tag_suggestion/preprocessing_utilities.py /deploy/<br/>COPY image_tag_suggestion/predictor.py image_tag_suggestion/utils.py /deploy/<br/>COPY image_tag_suggestion/config.yaml /deploy/<br/>COPY image_tag_suggestion/image_representation.h5 /deploy/<br/># Download from <a class="ae jt" href="https://github.com/CVxTz/TagSuggestionImages/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/CVxTz/TagSuggestionImages/releases</a><br/>COPY image_tag_suggestion/labels.json /deploy/<br/># Download from <a class="ae jt" href="https://github.com/CVxTz/TagSuggestionImages/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/CVxTz/TagSuggestionImages/releases</a><br/>COPY requirements.txt /deploy/<br/>WORKDIR /deploy/<br/>RUN pip install -r requirements.txt<br/>EXPOSE 8501</span><span id="7789" class="ls jw hi lo b fi ly lu l lv lw">ENTRYPOINT streamlit run main.py</span></pre><p id="0022" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后构建并运行:</p><pre class="je jf jg jh fd ln lo lp lq aw lr bi"><span id="8ecd" class="ls jw hi lo b fi lt lu l lv lw">sudo docker build -t img_tag_suggestion .<br/>docker run -p 8501:8501 img_tag_suggestion</span></pre><h2 id="96d8" class="ls jw hi bd jx mb mc md kb me mf mg kf iq mh mi kj iu mj mk kn iy ml mm kr mn bi translated">部署在Heroku</h2><p id="5786" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">Heroku允许您直接从GitHub repo部署python应用程序。<br/>你只需要指定三个文件:</p><ul class=""><li id="3517" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">setup.sh: Helper文件，用于下载模型并为streamlit设置一些参数。</li><li id="db08" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">runtime.txt:指定想要使用的python版本。</li><li id="bf34" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">Procfile:指定应用程序的类型和运行它的命令。</li></ul><p id="d1ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有这些文件都可以在本页末尾链接的Github Repo中找到。</p><p id="b311" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后你只需要在Heroku上创建一个免费账户，并按照以下步骤操作:</p><ul class=""><li id="564a" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">创建应用程序:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mo"><img src="../Images/8c8ac31691545bb61411cd123d2a7cce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JC2eU0KmXyOF_iMdmUmR8A.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">创建应用程序</figcaption></figure><ul class=""><li id="b48e" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">选择应用程序名称:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/b117a1d5a04b2c46b8381139275f3857.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BtvMAeomo0UWaDVVj7Q9tQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">名字</figcaption></figure><ul class=""><li id="b473" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">指定Github repo:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mq"><img src="../Images/3a32d118aad5aedabee47d094041a15c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-jk2IMiAF_jbZMEO63tn0w.png"/></div></div></figure><ul class=""><li id="5ca2" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">选择一个分支并部署:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mr"><img src="../Images/e92bcbc5c93acd452fce0ec664308418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Op_X7sxnN1wO3skL7JfUiw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">部署</figcaption></figure><ul class=""><li id="a929" class="kz la hi ih b ii ij im in iq lb iu lc iy ld jc le lf lg lh bi translated">Tadaaaa！</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ms"><img src="../Images/79b9dc28ddd19f5bba36acafe005984f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KnT-YP5Bh38iu8B9MdJcDg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">我的猫</figcaption></figure><p id="f38d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">至少它把小猫、猫玩具和食肉动物排进了前20名😛。</p><h1 id="dcdd" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="13bc" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">在这个项目中，我们构建了一个具有web UI的应用程序，并且可以预测最适合图像的顶级描述性标签。机器学习部分仍然需要一些改进，但这里的主要焦点是展示使用Streamlit为我们的模型构建一个干净的基于web的用户界面并将其部署在Heroku上是多么容易。</p><p id="f62e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><p id="9a61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">[1]<a class="ae jt" href="https://gilberttanner.com/blog/deploying-your-streamlit-dashboard-with-heroku" rel="noopener ugc nofollow" target="_blank">https://Gilbert tanner . com/blog/deploying-your-streamlit-dashboard-with-heroku</a></p><p id="d216" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">复制结果的代码可从这里获得:<a class="ae jt" href="https://github.com/CVxTz/TagSuggestionImages" rel="noopener ugc nofollow" target="_blank">https://github.com/CVxTz/TagSuggestionImages</a></p></div></div>    
</body>
</html>