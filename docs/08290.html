<html>
<head>
<title>SCD Type1 Implementation in Pyspark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pyspark中的SCD Type1实现</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/scd-type1-implementation-in-pyspark-f3ded001fec8?source=collection_archive---------1-----------------------#2020-07-24">https://medium.com/analytics-vidhya/scd-type1-implementation-in-pyspark-f3ded001fec8?source=collection_archive---------1-----------------------#2020-07-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e037" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文的目标是理解使用大数据计算框架Apache Spark实现SCD Type1。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/86122375222a25858946770b4b0caed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-j5Zeqa9XmwqFk99CwmmQ.png"/></div></div></figure><p id="dd4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要对SCD类型1或渐变维度有更多的了解，请参考我以前的博客，链接如下。博客包含对维度建模和数据仓库的详细见解，涵盖的用例类似，但这里的解决方案是使用Apache Spark实现的。</p><blockquote class="jp jq jr"><p id="1896" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated"><a class="ae jw" rel="noopener" href="/analytics-vidhya/scd-type1-implementation-in-python-e4f6ec13a797">https://medium . com/analytics-vid hya/SCD-type 1-implementation-in-python-e4f 6 EC 13 a 797</a></p></blockquote><ol class=""><li id="8e47" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated"><strong class="ih hj">创建Spark会话并导入数据集:</strong></li></ol><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="1b7d" class="kl km hi kh b fi kn ko l kp kq">import pyspark<br/>from pyspark.sql import SparkSession<br/>print(‘Modules Imported’)</span><span id="308f" class="kl km hi kh b fi kr ko l kp kq">spark=SparkSession.builder.appName(‘spark_scd_type1’).getOrCreate()</span><span id="a9c8" class="kl km hi kh b fi kr ko l kp kq">#Import source dataset<br/>emp_src = spark.read.format(“jdbc”) \<br/> .option(“url”, “jdbc:oracle:thin:scott/scott@//localhost:1522/oracle”) \<br/> .option(“dbtable”, “emp_spark”).option(“user”, “scott”) \<br/> .option(“password”, “scott”).option(“driver”, “oracle.jdbc.driver.OracleDriver”).load()<br/>emp_src.show(10)</span><span id="bfda" class="kl km hi kh b fi kr ko l kp kq">#import Target dataset, as of now target has zero rows<br/>emp_tgt = spark.read.format(“jdbc”) \<br/> .option(“url”, “jdbc:oracle:thin:scott/scott@//localhost:1522/oracle”) \<br/> .option(“dbtable”, “emp_spark_scd1”).option(“user”, “scott”) \<br/> .option(“password”, “scott”).option(“driver”, “oracle.jdbc.driver.OracleDriver”).load()<br/></span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ks"><img src="../Images/74e0c494a544953c6495c8230559ea38.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*pK6z6GdfAO1DURiuJWvfIA.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">源数据集</figcaption></figure><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="9ef1" class="kl km hi kh b fi kn ko l kp kq">#rename source and target DFs columns <br/>emp_src=emp_src.withColumnRenamed(‘EMPNO’,’EMPNO_SRC’) \<br/> .withColumnRenamed(‘SAL’,’SAL_SRC’) \<br/> .withColumnRenamed(‘ENAME’,’ENAME_SRC’) \<br/> .withColumnRenamed(‘DEPTNO’,’DEPTNO_SRC’) \<br/> .withColumnRenamed(‘COMM’,’COMM_SRC’)<br/></span><span id="c8cb" class="kl km hi kh b fi kr ko l kp kq">emp_tgt=emp_tgt.withColumnRenamed(‘EMPNO’,’EMPNO_TGT’) \<br/> .withColumnRenamed(‘SAL’,’SAL_TGT’)</span></pre><p id="c469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。在源和目标DFs上执行左外连接:</strong></p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="1e52" class="kl km hi kh b fi kn ko l kp kq">emp_scd=emp_src.join(emp_tgt,emp_src.EMPNO_SRC==emp_tgt.EMPNO_TGT,how=’left’)<br/>emp_scd.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kx"><img src="../Images/4a6d7bbea319cf860de4eefd9aebe683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*oLrQKVKSGOnMqKQkSiSQtw.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">连接的数据框</figcaption></figure><p id="84f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。标记插入/更新的记录:</strong></p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="6d27" class="kl km hi kh b fi kn ko l kp kq">from pyspark.sql.functions import lit<br/>from pyspark.sql import functions as f</span><span id="418c" class="kl km hi kh b fi kr ko l kp kq">scd_df=emp_scd.withColumn(‘INS_FLAG’,<br/> f.when( (emp_scd.EMPNO_SRC!=emp_scd.EMPNO_TGT) | emp_scd.EMPNO_TGT.isNull(),’Y’). \<br/> otherwise(‘NA’))<br/>scd_df.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/7f9ad06ba324e5e38df8ff2164a1e1f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NImPl6cvqUgywy_XaRIOmw.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">标记为插入的记录</figcaption></figure><p id="8177" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。将记录插入目标:</strong></p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="25eb" class="kl km hi kh b fi kn ko l kp kq">#renaming columns as per table column names<br/>emp_ins=scd_df.select(scd_df[‘EMPNO_SRC’].alias(‘EMPNO’),scd_df[‘ENAME_SRC’].alias(‘ENAME’),scd_df[‘DEPTNO_SRC’].alias(‘DEPTNO’),scd_df[‘SAL_SRC’].alias(‘SAL’), scd_df[‘COMM_SRC’].alias(‘COMM’))</span><span id="24f1" class="kl km hi kh b fi kr ko l kp kq">emp_ins.write.format(“jdbc”).mode(‘append’) \<br/> .option(“url”, “jdbc:oracle:thin:scott/scott@//localhost:1522/oracle”) \<br/> .option(“dbtable”, “emp_spark_scd1”).option(“user”, “scott”) \<br/> .option(“password”, “scott”).option(“driver”, “oracle.jdbc.driver.OracleDriver”).save()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kz"><img src="../Images/d3f68b5a73c17576fd9ae1f00e0acce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*ouzGwKtZkeD6KCf3qTr_LA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">目标数据集</figcaption></figure><blockquote class="jp jq jr"><p id="58af" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated">记录被加载到目标表中，由于oracle命令行中的对齐问题，无法放置整个数据集屏幕截图。</p></blockquote><p id="6643" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5。插入并更新源中的一些记录:</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es la"><img src="../Images/578d34948c4c9a5a2de6724bfe4b480b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*u_u-WoaIppd1Udj0O5IZiw.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">数据集更改</figcaption></figure><p id="c0f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导入源和目标数据集:</p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="188b" class="kl km hi kh b fi kn ko l kp kq">#source data<br/>emp_src1 = spark.read.format(“jdbc”) \<br/> .option(“url”, “jdbc:oracle:thin:scott/scott@//localhost:1522/oracle”) \<br/> .option(“dbtable”, “emp_spark”).option(“user”, “scott”) \<br/> .option(“password”, “scott”).option(“driver”, “oracle.jdbc.driver.OracleDriver”).load()<br/>emp_src1.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lb"><img src="../Images/6afd9bbc7ef68c4705e7c8d369f5099f.png" data-original-src="https://miro.medium.com/v2/resize:fit:606/format:webp/1*B2w5TaHSj25kpyzM03BiLA.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">源数据</figcaption></figure><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="bfb0" class="kl km hi kh b fi kn ko l kp kq">#target dataset<br/>emp_tgt1 = spark.read.format(“jdbc”) \<br/> .option(“url”, “jdbc:oracle:thin:scott/scott@//localhost:1522/oracle”) \<br/> .option(“dbtable”, “emp_spark_scd1”).option(“user”, “scott”) \<br/> .option(“password”, “scott”).option(“driver”, “oracle.jdbc.driver.OracleDriver”).load()<br/>emp_tgt1.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lc"><img src="../Images/8b6da70824a515a0338bbc8dcaec3395.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*VbvvPOyXAtMSW4A2RGLULw.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">目标数据</figcaption></figure><p id="3833" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 6。组合数据集和插入/更新标记</strong></p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="40cb" class="kl km hi kh b fi kn ko l kp kq">from pyspark.sql.functions import round, col<br/>emp_tgt1=emp_tgt1.select(round(‘EMPNO’,0).alias(‘EMPNO_TGT’),emp_tgt1[‘ENAME’].alias(‘ENAME_TGT’), round(‘DEPTNO’,0).alias(‘DEPTNO_TGT’)<br/> ,round(‘SAL’,2).alias(‘SAL_TGT’),round(‘COMM’,2).alias(‘COMM_TGT’))</span><span id="7c3b" class="kl km hi kh b fi kr ko l kp kq">#perform left join on <br/>emp_scd1=emp_src1.join(emp_tgt1,emp_src1.EMPNO==emp_tgt1.EMPNO_TGT,how=’left’)<br/>emp_scd1.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ld"><img src="../Images/df10316f8eb36123d68f9f01c8849592.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*F_t7K-Uj7I7e5TR8dEMEcA.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">关联数据集</figcaption></figure><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="ca96" class="kl km hi kh b fi kn ko l kp kq">#Insert Flag<br/>scd1_df=emp_scd1.withColumn(‘INS_FLAG’,<br/> f.when( (emp_scd1.EMPNO!=emp_scd1.EMPNO_TGT) | emp_scd1.EMPNO_TGT.isNull(),’Y’). \<br/> otherwise(‘NA’))</span><span id="1dad" class="kl km hi kh b fi kr ko l kp kq">#Update Flag<br/>scd2_df=scd1_df.withColumn('UPD_FLAG',<br/>                          f.when( (scd1_df.EMPNO==scd1_df.EMPNO_TGT) &amp; (scd1_df.SAL!=scd1_df.SAL_TGT),'Y'). \<br/>                          otherwise('NA'))<br/>scd2_df.show()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es le"><img src="../Images/5b6a936c57e94e1ad7a57ed8c16a48cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rm8JG4qX-LoHDGfAwNuKdA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">标记的记录</figcaption></figure><p id="fe35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 7。插入else更新操作</strong></p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="6897" class="kl km hi kh b fi kn ko l kp kq">#insert records df<br/>scd_ins=scd2_df.select(‘EMPNO’,’ENAME’,’DEPTNO’,’SAL’,’COMM’).filter(scd2_df.INS_FLAG==’Y’)<br/>scd_ins.show(5)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lf"><img src="../Images/506ab49b9b683db95ce9696da641bb3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*zW_lNRiyUPMhKI3KBwx8sQ.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">插入标记</figcaption></figure><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="3990" class="kl km hi kh b fi kn ko l kp kq">#update records df<br/>scd_upd=scd2_df.select(‘EMPNO’,’ENAME’,’DEPTNO’,’SAL’,’COMM’).filter(scd2_df.UPD_FLAG==’Y’)<br/>scd_upd.show(5)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/89f3d2c2b0366ba962543f655def9ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/format:webp/1*72-k7o7fCIBiNMpW1b_r2Q.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">更新标记</figcaption></figure><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="069a" class="kl km hi kh b fi kn ko l kp kq">#records to be overridden<br/>scd_over=scd2_df.select(‘EMPNO’,’ENAME’,’DEPTNO’,’SAL’,’COMM’).filter((scd2_df.UPD_FLAG!=’Y’) &amp; (scd2_df.INS_FLAG!=’Y’))<br/></span></pre><blockquote class="jp jq jr"><p id="9144" class="if ig js ih b ii ij ik il im in io ip jt ir is it ju iv iw ix jv iz ja jb jc hb bi translated">免责声明:到目前为止，Spark不支持DML中的更新操作，所以记录将在目标中被覆盖。</p></blockquote><p id="7d45" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 8。对数据帧进行并集，并将记录插入表:</strong></p><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="2fc9" class="kl km hi kh b fi kn ko l kp kq">df_final = scd_ins.unionAll(scd_upd).unionAll(scd_over)<br/>df_final.show()<br/>df_final.count()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ks"><img src="../Images/08a2bce8941d47d00c4bda2449bef4e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*b8GUHZq-HKKVviSOu4SYpQ.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">最终数据集</figcaption></figure><pre class="je jf jg jh fd kg kh ki kj aw kk bi"><span id="9f91" class="kl km hi kh b fi kn ko l kp kq">df_final.write.format(“jdbc”).mode(‘overwrite’) \<br/> .option(“url”, “jdbc:oracle:thin:<a class="ae jw" href="http://twitter.com/localhost" rel="noopener ugc nofollow" target="_blank">@localhost</a>:1522/oracle”) \<br/> .option(“dbtable”, “emp_spark_scd1”).option(“user”, “scott”) \<br/> .option(“password”, “scott”).option(“driver”, “oracle.jdbc.driver.OracleDriver”).save()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lh"><img src="../Images/bcd0d8295083cba62135138e0afdca06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8qCcs_c2DjQQYmA38mk-qA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">新记录</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es li"><img src="../Images/fd27f900b2ee9b9eb3fe0a0ccf2059f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*ndRFj1FmQ8ACUltUjmS1pw.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">更新的记录</figcaption></figure><p id="5298" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">万岁！！！这是Pyspark中的SCD Type1实现，为了更好地理解流程和过程，分为两个部分。</p><h1 id="af30" class="lj km hi bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak">总结:</strong></h1><p id="8ade" class="pw-post-body-paragraph if ig hi ih b ii mg ik il im mh io ip iq mi is it iu mj iw ix iy mk ja jb jc hb bi translated">初始数据加载(满载)</p><p id="adeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果存在实施，则插入Else更新</p><p id="c3ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用sql_alchemy库插入和更新记录</p><p id="cf1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢所有人阅读我的博客，如果你喜欢我的内容和解释，请在媒体上关注我并分享你的反馈，这将永远帮助我们所有人提高我们的知识。</p><p id="b387" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢</p><p id="6392" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Vivek Chaudhary</p></div></div>    
</body>
</html>