<html>
<head>
<title>Mask Detector w/ FastAI and Streamlit Sharing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带FastAI和Streamlit共享的掩膜检测器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mask-detector-w-fastai-and-streamlit-sharing-62448b4cb7b6?source=collection_archive---------10-----------------------#2020-12-11">https://medium.com/analytics-vidhya/mask-detector-w-fastai-and-streamlit-sharing-62448b4cb7b6?source=collection_archive---------10-----------------------#2020-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/27ea24bb544afa9337a5f69000b6ecc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tMLsoEmfkIblMl9s"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae iu" href="https://unsplash.com/@enginakyurt?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> engin akyurt </a>拍摄的照片</figcaption></figure><h2 id="bb8e" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">介绍</h2><p id="93cc" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">我想用这篇文章来强调部署一个精确的深度学习web应用程序是多么容易。最近开始FastAI课程后，我学会了图像处理的基础知识，并设法用其中一个模型构建了一个应用程序。FastAI推荐使用Binder，但我发现这与Streamlit相比非常慢。</p><p id="2a74" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">我在一个可以使用GPU的Colab笔记本上训练模型；然后将其导出到Streamlit。所有代码都可以在<a class="ae iu" href="https://github.com/jacklinc/covid_mask_classifier" rel="noopener ugc nofollow" target="_blank">这个资源库</a>中找到，包括示例笔记本。Streamlit仪表盘在这里是<a class="ae iu" href="https://share.streamlit.io/jacklinc/covid_mask_classifier/main/src/src_bear-class.py" rel="noopener ugc nofollow" target="_blank">这里是</a>。</p><h2 id="89bb" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">Bing API</h2><p id="1ace" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">自动化数据收集过程是FastAI课程的一部分。Bing图片搜索API需要在Azure认知服务上开发一个应用程序(这不是一个小壮举),你已经准备好了。在Bing上搜索图片的功能如下。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="aa76" class="iv iw hi ky b fi lc ld l le lf">def search_images_bing(key, term, max_images: int = 150, **kwargs):<br/>  params = {‘q’:term, ‘count’:max_images} <br/>  headers = {“Ocp-Apim-Subscription-Key”:key} <br/>  search_url = “https://api.bing.microsoft.com/v7.0/images/search”<br/>  response = requests.get(search_url, headers=headers, params=params)<br/>  response.raise_for_status() <br/>  search_results = response.json() <br/>  return L(search_results[‘value’])</span></pre><p id="ec0b" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">数据组织阶段将不同的影像分类放入单独的文件夹中，用作数据标签，下面的函数将搜索词、Python路径和数据标签作为输入。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="f98d" class="iv iw hi ky b fi lc ld l le lf">def make_category(cat, path, label):                         <br/>  if not path.exists():                           <br/>    path.mkdir()                         <br/>  dest = (path/label)<br/>  dest.mkdir(exist_ok=True)<br/>  results = search_images_bing(key, cat)<br/>  download_images(dest, urls=results.attrgot('contentUrl'))</span></pre><p id="ba43" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">在Jupyter中使用“%ls”魔术命令显示文件夹结构。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h2 id="9878" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">模特培训</h2><p id="9dbf" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">FastAI使用<a class="ae iu" href="https://docs.fast.ai/tutorial.datablock" rel="noopener ugc nofollow" target="_blank">数据块</a> API，它管理数据，这样我就可以花更多的时间在建模上，而不是花更少的时间组织数据。推荐的文件夹结构如下。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="b4bb" class="iv iw hi ky b fi lc ld l le lf">mask_detector<br/>├── train<br/>│   ├── mask<br/>│   │   ├── img_1.jpeg<br/>│   │   └── img_2.jpeg<br/>│   └── no_mask<br/>│       ├── img_3.jpeg<br/>│       └── img_4.jpeg<br/>└── valid<br/>    ├── mask<br/>    │   ├── img_5.jpeg<br/>    │   └── img_6.jpeg<br/>    └── no_mask<br/>        ├── img_7.jpeg<br/>        └── img_8.jpeg</span></pre><p id="6c5f" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">下面列出了使用的参数:</p><ul class=""><li id="0c0b" class="ln lo hi jv b jw ko ka kp jg lp jk lq jo lr kn ls lt lu lv bi translated"><strong class="jv hj">块</strong>:指定因变量和自变量。ImageBlock是每个文件夹中的图像数据，CategoryBlock是文件夹名称。</li><li id="01fe" class="ln lo hi jv b jw lw ka lx jg ly jk lz jo ma kn ls lt lu lv bi translated"><strong class="jv hj"> get_items </strong>:取一个函数，返回图像数据的位置。</li><li id="0ffa" class="ln lo hi jv b jw lw ka lx jg ly jk lz jo ma kn ls lt lu lv bi translated"><strong class="jv hj">拆分器</strong>:将数据拆分为有效数据和训练数据</li><li id="5059" class="ln lo hi jv b jw lw ka lx jg ly jk lz jo ma kn ls lt lu lv bi translated"><strong class="jv hj"> get_y </strong>:用于标记数据的函数</li><li id="9a66" class="ln lo hi jv b jw lw ka lx jg ly jk lz jo ma kn ls lt lu lv bi translated"><strong class="jv hj"> item_tfms </strong>:将每张图像转换成合适的尺寸</li></ul><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="58be" class="iv iw hi ky b fi lc ld l le lf">masks = DataBlock(<br/>  blocks=(ImageBlock, CategoryBlock), <br/>  get_items=get_image_files(path), <br/>  splitter=RandomSplitter(valid_pct=0.2, seed=42),<br/>  get_y=parent_label,<br/>  item_tfms=Resize(128))</span></pre></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h2 id="663e" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">简化托管</h2><p id="96aa" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">Streamlit消除了共享数据科学项目所需的web开发技能。没有必要乱用HTML或JS框架；只是Python，看看他们的<a class="ae iu" href="https://share.streamlit.io/streamlit/demo-self-driving" rel="noopener ugc nofollow" target="_blank">演示</a>。你可以在本地或者像Heroku这样的PaaS上运行Streamlit，但是最简单快捷的方法是使用他们的测试版共享服务。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/493397e286c5391da1e1a104e5a04876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OaajKe15-GM3r0VfCPk24w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">简化it共享应用部署</figcaption></figure><p id="fb47" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">注册测试版后，包含您的GitHub repo、branch和Streamlit文件，您就可以开始部署了。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><h2 id="f4c1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">胡须歪斜</h2><p id="a232" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn hb bi translated">部署我的应用程序后，我很兴奋地看到它的性能有多好；我上传的每张照片都正常。当然，我把它发给了我的<a class="ae iu" href="https://github.com/FinnMcLaughlin" rel="noopener ugc nofollow" target="_blank">朋友</a>，他碰巧有胡子——模特不喜欢这个。我试了更多的胡子，意识到有一个问题。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/734904919b0c1cbc9c34ae3a0b8c50c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9tVZmr4c0w-hKWxJ"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@frank_marino87?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">弗兰克·马里诺</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7f94" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">我已经拥有的两个类别是mask和no_mask，所以我决定在数据中添加另一个标签:胡须。代码如下。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="82f3" class="iv iw hi ky b fi lc ld l le lf">make_category('peoples faces with covid mask', path, 'mask')</span><span id="2a94" class="iv iw hi ky b fi md ld l le lf">make_category('clean shaven face', path, 'no_mask')</span><span id="ce70" class="iv iw hi ky b fi md ld l le lf">make_category('bearded face', path, 'beard')</span></pre><p id="b3a7" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">在解决了胡子问题后，我意识到同样的问题可能会在不同的种族出现，因为大多数图片搜索结果都是白人男性。我开始时没有考虑到这一点，也没有考虑到我应该在未来的计算机视觉项目中加入一些东西。我推荐FastAI关于数据伦理的课程，对我刚才提到的内容进行扩展。</p><p id="fa8d" class="pw-post-body-paragraph jt ju hi jv b jw ko jy jz ka kp kc kd jg kq kf kg jk kr ki kj jo ks kl km kn hb bi translated">请随时纠正我可能犯的任何错误。</p><h2 id="37b4" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">资源</h2><ul class=""><li id="dcb8" class="ln lo hi jv b jw jx ka kb jg me jk mf jo mg kn ls lt lu lv bi translated"><a class="ae iu" href="https://docs.fast.ai/" rel="noopener ugc nofollow" target="_blank">https://docs.fast.ai/</a></li><li id="9428" class="ln lo hi jv b jw lw ka lx jg ly jk lz jo ma kn ls lt lu lv bi translated">https://coursefast.ai/(第二课)</li><li id="5e03" class="ln lo hi jv b jw lw ka lx jg ly jk lz jo ma kn ls lt lu lv bi translated"><a class="ae iu" href="https://blog.streamlit.io/introducing-streamlit-sharing/" rel="noopener ugc nofollow" target="_blank">https://blog.streamlit.io/introducing-streamlit-sharing/</a></li></ul></div></div>    
</body>
</html>