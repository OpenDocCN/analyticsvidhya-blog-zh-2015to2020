<html>
<head>
<title>Spark SQL Hive Job Conversion</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spark SQL 配置单元作业转换</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-sql-hive-job-conversion-9ec6f9269d94?source=collection_archive---------18-----------------------#2020-12-01">https://medium.com/analytics-vidhya/spark-sql-hive-job-conversion-9ec6f9269d94?source=collection_archive---------18-----------------------#2020-12-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="d2e4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">用例</h1><ul class=""><li id="de97" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">使用事实和维度模型并进行多重连接。</li><li id="8488" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">所有的事实和维度文件都存储为 parquet</li><li id="72df" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建临时表并连接</li></ul><h1 id="5bce" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">先决条件</h1><ul class=""><li id="dc14" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">Azure 帐户</li><li id="234b" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">使用 Spark 3.0 创建 Azure 数据块</li><li id="55bf" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">创建一个 Blob 存储来存储文件。</li><li id="65f7" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">Azure keyvault</li><li id="e827" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">为复制拼花文件</li><li id="ef21" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">事实</li><li id="f415" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">dimState</li><li id="b600" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">迪姆县</li><li id="4cbc" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">迪姆雷斯</li><li id="f9e6" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">迪姆塞克斯</li><li id="4968" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">所有这些都是根据美国人口数据(公开数据)得出的</li><li id="d02a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">这只是模拟连接，所以如果需要，请使用您自己的数据集。</li><li id="6986" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">我正在使用 scala 的 databricks 笔记本</li><li id="beeb" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">我创建了一个名为 uspopulationinput 的容器</li><li id="127a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">每个事实和数据都存储在相应的文件夹中。</li><li id="a2c8" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">文档来创建本文所需的数据集。<a class="ae ka" href="https://github.com/balakreshnan/Accenture/blob/master/cap/populationdataset.md" rel="noopener ugc nofollow" target="_blank">https://github . com/balakreshnan/Accenture/blob/master/cap/population dataset . MD</a></li></ul><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/d587f26ad781c2b0defca271859ce048.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D3evf-uNkA8a4DRn.jpg"/></div></div></figure><h1 id="4759" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">获取拼花文件、创建视图和构建连接的步骤</h1><ul class=""><li id="880d" class="jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">首先配置 blob 存储信息，如帐户名和密钥</li><li id="a16a" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">我正在使用 keyvault 获取存储密钥</li></ul><pre class="kc kd ke kf fd kn ko kp kq aw kr bi"><span id="6243" class="ks ig hi ko b fi kt ku l kv kw">val accbbstorekey = dbutils.secrets.get(scope = "allsecrects", key = "accbbstore")</span><span id="52e2" class="ks ig hi ko b fi kx ku l kv kw">spark.conf.set( "fs.azure.account.key.accbbstore.blob.core.windows.net", accbbstorekey)</span><span id="5551" class="ks ig hi ko b fi kx ku l kv kw">val factdata = spark.read.parquet("wasbs://containername@storagename.blob.core.windows.net/fact/*.parquet") <br/>display(factdata)</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es ky"><img src="../Images/001ba04698c3184c1eb177711a3ca7b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zhMNylirxVby-RhO.jpg"/></div></div></figure><pre class="kc kd ke kf fd kn ko kp kq aw kr bi"><span id="cc07" class="ks ig hi ko b fi kt ku l kv kw">%sql <br/>DROP VIEW factdata</span></pre><ul class=""><li id="3394" class="jd je hi jf b jg kz ji la jk lb jm lc jo ld jq jr js jt ju bi translated">现在让我们为文件创建临时视图</li><li id="94dc" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">首先是事实数据—视图</li></ul><pre class="kc kd ke kf fd kn ko kp kq aw kr bi"><span id="2aa9" class="ks ig hi ko b fi kt ku l kv kw">%sql <br/>CREATE TEMPORARY VIEW factdata USING org.apache.spark.sql.parquet OPTIONS ( path "wasbs://containername@storagename.blob.core.windows.net/fact/*.parquet" )</span><span id="bdd6" class="ks ig hi ko b fi kx ku l kv kw">%sql <br/>SELECT * FROM factdata;</span><span id="9b97" class="ks ig hi ko b fi kx ku l kv kw">%sql <br/>CREATE TEMPORARY VIEW dimstate USING org.apache.spark.sql.parquet OPTIONS ( path "wasbs://containername@storagename.blob.core.windows.net/dimstate/*.parquet" )</span><span id="e078" class="ks ig hi ko b fi kx ku l kv kw">%sql <br/>CREATE TEMPORARY VIEW dimcounty USING org.apache.spark.sql.parquet OPTIONS ( path "wasbs://containername@storagename.blob.core.windows.net/dimcountryname/*.parquet" )</span><span id="c295" class="ks ig hi ko b fi kx ku l kv kw">%sql <br/>CREATE TEMPORARY VIEW dimrace USING org.apache.spark.sql.parquet OPTIONS ( path "wasbs://containername@storagename.blob.core.windows.net/dimRace/*.parquet" )</span><span id="4e2e" class="ks ig hi ko b fi kx ku l kv kw">%sql <br/>CREATE TEMPORARY VIEW dimsex USING org.apache.spark.sql.parquet OPTIONS ( path "wasbs://containername@storagename.blob.core.windows.net/dimsex/*.parquet" )</span></pre><ul class=""><li id="dd6d" class="jd je hi jf b jg kz ji la jk lb jm lc jo ld jq jr js jt ju bi translated">现在让我们使用 HiveQL like 查询来加入，看看是否可以加入</li><li id="48e3" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">这个练习是尝试查看 HiveQL(类似的)是否可以移植到 Spark 3.0 的一部分</li></ul><pre class="kc kd ke kf fd kn ko kp kq aw kr bi"><span id="1742" class="ks ig hi ko b fi kt ku l kv kw">%sql <br/>Select factdata.*, dimstate.StateName as dimStateName, dimcounty.CountyName as dimCountyName, dimrace.Race as dimRace, dimsex.Sex as dimSex from factdata inner join dimstate on factdata.StateName = dimstate.StateName join dimcounty on factdata.countyName = dimcounty.CountyName join dimrace on factdata.race = dimrace.Race join dimsex on factdata.sex = dimsex.Sex</span></pre><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es le"><img src="../Images/09e0a10cd8a1f32ed1e2b55dce2d79f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PtK2clg2y-3-co0L.jpg"/></div></div></figure><ul class=""><li id="b4c1" class="jd je hi jf b jg kz ji la jk lb jm lc jo ld jq jr js jt ju bi translated">正如您在上面看到的，我们正在连接事实和维度，并显示来自两者的列，以确认它是否可以连接。</li><li id="8a77" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">这只是为了验证。</li><li id="b794" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">从配置单元 QL 移动时，可能存在依赖关系和数据类型不匹配</li><li id="28a4" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">还有 UDF(用户自定义函数)，这是另一个值得关注的东西。</li><li id="bf75" class="jd je hi jf b jg jv ji jw jk jx jm jy jo jz jq jr js jt ju bi translated">这也仅适用于将 HIVEQL 用作 ETL 并希望移植到 Spark SQL 的情况。</li></ul></div><div class="ab cl lf lg gp lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="hb hc hd he hf"><p id="57ef" class="pw-post-body-paragraph lm ln hi jf b jg kz lo lp ji la lq lr jk ls lt lu jm lv lw lx jo ly lz ma jq hb bi translated"><em class="mb">最初发表于</em><a class="ae ka" href="https://github.com/balakreshnan/Accenture/blob/master/cap/sparksqlmultijoin.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="mb">。</em></p></div></div>    
</body>
</html>