<html>
<head>
<title>Python 3 Migration- Valuable Lessons</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 3迁移——宝贵的经验</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/python-3-migration-valuable-lessons-efd0d0061609?source=collection_archive---------17-----------------------#2020-09-26">https://medium.com/analytics-vidhya/python-3-migration-valuable-lessons-efd0d0061609?source=collection_archive---------17-----------------------#2020-09-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="06e7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我最近得到一个机会，通过移动应用程序，迁移分布在面向消费者的应用程序的多个回购中的26K行代码，为数百万客户提供服务。这是运行在gevent上的flask应用程序，在AWS ECS中有许多后台任务。我觉得这次经历对社区很有帮助。我试着把学到的东西写在这里。</p><p id="a830" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">注意:您可以在上找到格式更好的版本</p><p id="db4b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">idea—<a class="ae jk" href="https://www.notion.so/Python-3-Migration-Valuable-Lessons-78abf495e1e4486a81116c98d2c3fc66" rel="noopener ugc nofollow" target="_blank">https://www . idea . so/Python-3-Migration-valued-Lessons-78 abf 495 E1 e 4486 a 81116 c 98 D2 C3 fc 66</a></p><p id="cbcd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://gist.github.com/mthipparthi/2e5b9b4e224390959f6143e9bd94e1e7" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/mthipparthi/2 e5b 9 B4 e 224390959 f 6143 e 9 BD 94 E1 e 7</a></p><h1 id="19ea" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">测试</h1><p id="baba" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">迁移首先需要的是——单元测试的存在。如果根本没有单元测试，请首先编写它们。如果你有单元测试，并且你觉得它们不够充分，首先花时间写那些单元测试用例。在没有测试的情况下，不要尝试迁移。</p><p id="12c0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">智慧</p><ul class=""><li id="7a5a" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj kt ku kv kw bi translated">创造。用Py2和Py3做所有的测试。这节省了很多时间</li><li id="1332" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">创建<code class="du lc ld le lf b">locust</code>测试(负载测试)来测试<code class="du lc ld le lf b">uat</code>中的端到端流程。</li></ul><h1 id="bee2" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">分支</h1><p id="03b2" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在现实世界中，特性添加将优先于迁移。因此，当您为迁移创建一个分支时，这将比您想象的持续时间更长。为大量合并冲突做好准备。</p><h1 id="8f19" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">承诺</h1><p id="532e" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在逻辑上解决一个问题时，创建尽可能多的提交。一旦你解决了一些逻辑问题，提交它并创建尽可能多的提交，当你将来需要引用时，它们会有很大的帮助。当您有多个repos要迁移时，您最终会引用它们。</p><h1 id="ca9d" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">冲突</h1><p id="38dc" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">如果这个项目是长期运行的，请试着用你的<code class="du lc ld le lf b">develop/staging</code>重新调整几个星期。如果你有很长一段时间没有更新，你会有很多惊喜。</p><p id="6b3a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">智慧</p><ul class=""><li id="b48f" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj kt ku kv kw bi translated">这个命令<code class="du lc ld le lf b">git config --global rerere.enabled true</code>会有很大的帮助，因为它会记住你做的所有解决方案，并在随后的冲突中重放。它节省了很多时间。</li><li id="41b5" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">有时你会忘记解析一些(非python文件，隐藏的(circleci config))，这会导致以后的混乱。为了避免这个命令会有很大的帮助<code class="du lc ld le lf b">ag "&gt;&gt;&gt;&gt;&gt;" --hidden --ignore-dir .git</code>总是在你做之前执行它<code class="du lc ld le lf b">git add .;git rebase --continue</code></li></ul><h1 id="994f" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">代码审查</h1><p id="797d" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">如果值得一次或在提交级别审查所有代码，请在团队中工作。拥有尽可能多的提交肯定会对评审者有所帮助。只要单元测试通过，这就是代码工作的良好迹象。你可以在你的团队中决定什么是正确的策略。因为变更很难审核。如果你删除了一些代码或者测试用例或者库，让你的团队保持循环。</p><h1 id="ef62" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">生产部署。</h1><h1 id="3358" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">金丝雀</h1><p id="cbe1" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">除了在低影响的情况下，我们应该结束并行运行Py2和Py3应用程序，直到Py3为您的所有流量提供服务。根据您的设置，如果您的应用面向CDN，则很容易将流量转移到两个应用，否则您需要使用自己版本的canary进行迁移，而不会出现任何停机。使用共享资源运行Py2和Py3有其自身的挑战。</p><p id="ce1b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您使用ECS，您可以为Py2和Py3创建两个单独的服务，并相应地转移流量。</p><h1 id="1910" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">禁止共享腌制物品。</h1><p id="2d0a" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在迁移中，缓存是您的敌人。我得到了惨痛的教训。Py2和Py3更是如此，它们将对象缓存为pickle对象。Python 2使用协议0–2来挑选对象，而Python3使用协议3–5。如果您通过任何缓存(redis)共享这些对象，它们是不兼容的，并且应用程序会在生产中造成很大的影响。</p><p id="5308" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">智慧:</p><ul class=""><li id="62c7" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj kt ku kv kw bi translated">永远不要将选取的对象存储在缓存中</li><li id="99c0" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">总是存储压缩的json blobs。</li></ul><p id="b333" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://gist.github.com/024c2a044bd802472b5b4bb19b3a279e" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/024c2a044bd802472b5b4bb19b3a279e</a></p><ul class=""><li id="493d" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj kt ku kv kw bi translated">如果您想要存储它们，请确保在Py2和Py3上使用相同的协议。这个库有助于解决这个问题。我不建议这样做。例如，如果您存储了会话或令牌，这将对上游系统造成压力。</li></ul><h1 id="a97e" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">错误监视器</h1><p id="9f0f" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">监控监控监控。如果你有大量的代码，没有单元测试会覆盖所有的极限情况。生产流量总是会有一些惊喜。在弹性APM或任何错误监控工具中记录所有异常。当您看到错误时，检查它们是否都在Py2和Py3中，或者它们是否是带有那些异常和调用堆栈的Py3特定日志票据。如果错误增加，回滚代码(关闭金丝雀流量)。提醒你，你总是有惊喜。这很好地展示了如何限制流量。</p><h1 id="ed1c" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">利益</h1><p id="1eff" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">迁移带给我们许多惊喜和意想不到的好处。</p><ul class=""><li id="1013" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj kt ku kv kw bi translated">Python3.8的内存消耗少了20%多一点</li><li id="fab2" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">这使我们使用的容器减少了21%。我们运行95–100个任务，现在减少到75个。</li><li id="3c63" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">网络吞吐量增加。</li><li id="78be" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">CPU使用率没有太大变化</li><li id="f178" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj kt ku kv kw bi translated">我们将平均响应时间从110–120秒降低到90–100秒。P95和P99我们将它降低了近100毫秒——300毫秒。</li></ul><h1 id="ec2d" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">更少…..</h1><ul class=""><li id="d2d2" class="ko kp hi io b ip kj it kk ix lg jb lh jf li jj kt ku kv kw bi translated">假设您正在迁移您的主要应用程序和一些支持主要应用程序的内部库。在整个代码投入生产之前，请不要将代码提升到各自内部库的<code class="du lc ld le lf b">master</code>分支。请在您的<code class="du lc ld le lf b">feature</code>分支之外创建预发布(<a class="ae jk" href="https://packaging.python.org/guides/distributing-packages-using-setuptools/#id68" rel="noopener ugc nofollow" target="_blank">https://packaging . python . org/guides/distributing-packages-using-setup tools/# id68</a>)版本的内部库，并在主代码中使用它们，直到一切稳定。当你因为任何原因不得不恢复时，这将省去很多麻烦。</li></ul><h1 id="3d29" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">技术工具和微小差异</h1><ol class=""><li id="ff46" class="ko kp hi io b ip kj it kk ix lg jb lh jf li jj lj ku kv kw bi translated"><code class="du lc ld le lf b">modernize</code>是比别人更好的选择</li></ol><p id="8163" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://gist.github.com/2d9b941fab741135ead1b57b1f494d78" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/2d9b941fab741135ead1b57b1f494d78</a></p><ol class=""><li id="c8f0" class="ko kp hi io b ip iq it iu ix kq jb kr jf ks jj lj ku kv kw bi translated">解码和编码— —检查你在哪里使用了字节串——小心</li><li id="aa7a" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated">请注意<code class="du lc ld le lf b">enum</code>它们在Python 3中略有不同</li><li id="b66a" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated">当心<code class="du lc ld le lf b">copy</code>功能</li><li id="76a7" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><code class="du lc ld le lf b">cmp</code>Python 3中没有吗</li><li id="ec8a" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated">用lambda替换<code class="du lc ld le lf b">string.lower</code></li><li id="4a2d" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated">如果你在测试用例中使用<code class="du lc ld le lf b">gevent</code>来猴子补丁，使用这个Anthony包- <code class="du lc ld le lf b">pytest-gevent</code></li><li id="972e" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated">用<code class="du lc ld le lf b">caniusepython3</code>了解哪些库不适合。</li></ol><h1 id="2409" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">一些常见的错误</h1><ol class=""><li id="98bd" class="ko kp hi io b ip kj it kk ix lg jb lh jf li jj lj ku kv kw bi translated">RuntimeError:字典在迭代过程中改变了大小</li><li id="3014" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated">类型错误:'&lt;=’ not supported between instances of ‘str’ and ‘int’</li></ol><p id="4b06" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://gist.github.com/272edf113ad8130c0b7c1755da504957" rel="noopener ugc nofollow" target="_blank">https://gist.github.com/272edf113ad8130c0b7c1755da504957</a></p><h1 id="066e" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">参考</h1><ol class=""><li id="8a3d" class="ko kp hi io b ip kj it kk ix lg jb lh jf li jj lj ku kv kw bi translated"><a class="ae jk" href="https://www.techrepublic.com/article/migrating-from-python-2-to-python-3-a-guide-to-preparing-for-the-2020-deadline/" rel="noopener ugc nofollow" target="_blank">https://www . techrepublic . com/article/migrating-from-python-2-to-python-3-a-guide-to-preparating-for-the-2020-deadline/</a></li><li id="f860" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" rel="noopener" href="/@boxed/moving-a-large-and-old-codebase-to-python3-33a5a13f8c99">https://medium . com/@ boxed/moving-a-large-old-code base-to-python 3-33 a5a 13 F8 c 99</a></li><li id="2bac" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" href="http://python3porting.com/preparing.html" rel="noopener ugc nofollow" target="_blank">http://python3porting.com/preparing.html</a></li><li id="f2f9" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" href="https://www.digitalocean.com/community/tutorials/how-to-port-python-2-code-to-python-3" rel="noopener ugc nofollow" target="_blank">https://www . digital ocean . com/community/tutorials/how-to-port-python-2-code-to-python-3</a></li><li id="5083" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" href="https://diveintopython3.net/case-study-porting-chardet-to-python-3.html" rel="noopener ugc nofollow" target="_blank">https://dive into python 3 . net/case-study-porting-char det-to-python-3 . html</a></li><li id="9893" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" href="https://link.springer.com/content/pdf/bbm%3A978-1-4302-2416-7%2F1.pdf" rel="noopener ugc nofollow" target="_blank">https://link . springer . com/content/pdf/bbm % 3a 978-1-4302-2416-7% 2 f1 . pdf</a></li><li id="5627" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" href="https://docs.python.org/3/reference/datamodel.html#object.__bool__" rel="noopener ugc nofollow" target="_blank">https://docs . python . org/3/reference/data model . html # object . bool</a></li><li id="62eb" class="ko kp hi io b ip kx it ky ix kz jb la jf lb jj lj ku kv kw bi translated"><a class="ae jk" href="https://stackoverflow.com/questions/55695479/typeerror-not-supported-between-instances-of-dict-and-dict" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/55695479/type error-not-supported-between-instances-of-dict-and-dict</a></li></ol></div></div>    
</body>
</html>