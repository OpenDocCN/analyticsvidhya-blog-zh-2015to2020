<html>
<head>
<title>An Airflow sensor for stamp files in Google Cloud Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种用于谷歌云存储中印章文件的气流传感器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/an-airflow-sensor-for-stamp-files-in-google-cloud-storage-d2d51f9c756b?source=collection_archive---------13-----------------------#2019-11-14">https://medium.com/analytics-vidhya/an-airflow-sensor-for-stamp-files-in-google-cloud-storage-d2d51f9c756b?source=collection_archive---------13-----------------------#2019-11-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8951" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博客最初发表在<a class="ae jd" href="https://burntbit.com/an-airflow-sensor-for-stamp-files-in-google-cloud-storage/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">大数据日报</strong> </a>，也可以在<a class="ae jd" href="https://www.linkedin.com/pulse/airflow-sensor-stamp-files-google-cloud-storage-boning-zhang" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>上找到。源代码可以在<a class="ae jd" href="https://github.com/BoningZhang/Learning_Airflow/tree/master/common/sensors" rel="noopener ugc nofollow" target="_blank"> Git </a>中找到。</p><p id="8e20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Airflow是一个用python编写的开源工作流控制平台。使用气流，我们可以定义任务依赖关系和调度我们的管道。不熟悉气流的可以看我其他的帖子或者这个很有帮助的<a class="ae jd" rel="noopener" href="/@dustinstansbury/understanding-apache-airflows-key-concepts-a96efed52b1a">教程</a>。它很好地解释了气流中的关键概念。</p><p id="0160" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">气流的一个关键特征是传感器，它在等待事情发生。例如，如果我们的数据管道正在等待一些上游数据，那么我们可以使用传感器来检查其标记文件是否存在。我们的管道将在那里等待，直到传感器从它的标记文件中得到一个肯定的信号。假设我们需要在其分区<code class="du je jf jg jh b">ds=2019-11-04</code>上处理一个hive表A，那么一旦HDFS文件<em class="ji"> </em> <code class="du je jf jg jh b">hdfs://hive/A/ds=2019-11-04/_SUCCESS</code>被填充，它的下一个任务将被触发来进行处理。</p><p id="bb20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是用于图章文件的气流传感器的实现。</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="jo jp l"/></div></figure><p id="8492" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Airflow的BaseSensorOperator类中最重要的方法是poke()函数，该函数将在一定的间隔内被调用，直到传感器找到stamp文件或达到其运行时间限制。</p><p id="ff4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以实现一个传感器就是实现它的<code class="du je jf jg jh b">poke()</code>功能。在上面的例子中，我们首先在代码中生成一个stamp文件路径的数组作为<code class="du je jf jg jh b">stamp_files</code>。我们的目标是使用<code class="du je jf jg jh b">check_stamp_files_gcp()</code>检查<code class="du je jf jg jh b">stamp_files</code>中的所有文件是否都存在。如果<code class="du je jf jg jh b">check_stamp_files_gcp()</code>返回true，那么我们在<code class="du je jf jg jh b">poke()</code>函数中返回true，否则<code class="du je jf jg jh b">poke()</code>将返回false，稍后将再次调用它来检查戳文件。</p><p id="8782" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么实现的关键就变成了检查图章文件，即<code class="du je jf jg jh b">check_stamp_files_gcp()</code>。如果HDFS戳记文件位于本地Hadoop集群中，则可以使用子流程轻松实现check_stamp_files()，如下所示:</p><pre class="jj jk jl jm fd jq jh jr js aw jt bi"><span id="bb63" class="ju jv hi jh b fi jw jx l jy jz">ls_command = ["hadoop", "fs", "-ls"]</span><span id="fe50" class="ju jv hi jh b fi ka jx l jy jz">ls_command += stamp_files</span><span id="10c3" class="ju jv hi jh b fi ka jx l jy jz"><a class="ae jd" href="http://logging.info/" rel="noopener ugc nofollow" target="_blank">logging.info</a>("Running command: %s" %(" ".join(ls_command)))</span><span id="cdf5" class="ju jv hi jh b fi ka jx l jy jz">ret_code = subprocess.call(ls_command)==None</span></pre><p id="9fe5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们的表驻留在Google云存储中，我们需要调用Google Cloud的API来检查stamp文件。</p><figure class="jj jk jl jm fd jn"><div class="bz dy l di"><div class="jo jp l"/></div></figure><p id="2748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du je jf jg jh b">check_stamp_files_gcp()</code>中，service_account是Google Cloud项目中的一个json密钥文件，用来认证本地计算机，建立与Google云存储的连接。获取这个密钥文件的方法可以在GCP的<a class="ae jd" href="https://cloud.google.com/storage/docs/reference/libraries" rel="noopener ugc nofollow" target="_blank">文档中找到。</a></p></div></div>    
</body>
</html>