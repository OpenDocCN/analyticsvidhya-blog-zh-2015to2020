<html>
<head>
<title>How to delete huge data from DynamoDB table?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从DynamoDB表中删除庞大的数据？</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-delete-huge-data-from-dynamodb-table-f3be586c011c?source=collection_archive---------0-----------------------#2020-04-30">https://medium.com/analytics-vidhya/how-to-delete-huge-data-from-dynamodb-table-f3be586c011c?source=collection_archive---------0-----------------------#2020-04-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="66b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我的任务是从AWS DynamoDB表中删除万亿字节的数据时，我尝试了以下方法。</p><p id="e3ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1)删除现有表并重新创建它</p><p id="51ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2)更新TTL(生存时间)列</p><p id="cf6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3)使用删除-项目删除</p><p id="06cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4)使用批量写入项目删除</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/3b98f7b08c6d089db448446d47cfee1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*0KUJ9xhIbkGlSbDSBR6y0A.jpeg"/></div></figure><p id="1934" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Amazon DynamoDB中，表中的每一项都由其主键唯一标识。因此，写入DynamoDB表的每一项都必须包含主键。在我的例子中，它是复合主键，其中第一个属性是分区/散列键，第二个属性是排序/范围键。</p><div class="jl jm ez fb jn jo"><a href="http://satya-dba.blogspot.com/" rel="noopener  ugc nofollow" target="_blank"><div class="jp ab dw"><div class="jq ab jr cl cj js"><h2 class="bd hj fi z dy jt ea eb ju ed ef hh bi translated">Satya的DBA博客</h2><div class="jv l"><h3 class="bd b fi z dy jt ea eb ju ed ef dx translated">MySQL backup-defaults-file =/usr/local/MySQL/my . CNF-compress-user = backup admin-password-port = 3309 backup…</h3></div><div class="jw l"><p class="bd b fp z dy jt ea eb ju ed ef dx translated">satya-dba.blogspot.com</p></div></div></div></a></div><h1 id="3fbb" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak"> 1)删除现有的表&amp;重新创建它</strong></h1><p id="763e" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">如果需要删除所有项目，可以考虑删除并重新创建DynamoDB表。</p><p id="1631" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果要从表中删除所有项目，这是最快最简单的方法，不需要花时间扫描和删除每个项目。</p><p id="c3ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="la"> DeleteTable </em>命令/API删除表格及其所有项目。删除表格可能需要大约2-4分钟。</p><p id="9cc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想保留之前的设置，您需要获得模式匹配<em class="la"> - generate-cli-skeleton </em>标志。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="e5d0" class="lg jy hi lc b fi lh li l lj lk">aws dynamodb delete-table --table-name <strong class="lc hj"><em class="la">test_data</em></strong></span><span id="dcc4" class="lg jy hi lc b fi ll li l lj lk">aws dynamodb create-table --table-name <strong class="lc hj"><em class="la">test_data</em></strong> --attribute-definitions AttributeName=<em class="la">primary_key</em>,AttributeType=S AttributeName=<em class="la">time_stamp</em>,AttributeType=N --key-schema AttributeName=<em class="la">primary_key</em>,KeyType=HASH AttributeName=<em class="la">time_stamp</em>,KeyType=RANGE --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1</span></pre><p id="bcc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是会有<strong class="ih hj">停机</strong>换台。停机时间取决于表删除时间、创建时间以及更改/更新DynamoDB表属性的时间。</p><p id="c82d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在非生产数据库中尝试了这种方法，但是在生产环境中却无法遵循这种停机方法。</p><p id="d721" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您可以使用新的表名(这涉及到应用程序代码的更改),那么创建一个全新的表并开始写入该表，稍后您可以删除旧的表。<strong class="ih hj">没有直接重命名</strong> DynamoDB表的方法。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="924e" class="lg jy hi lc b fi lh li l lj lk">aws dynamodb create-table --table-name <strong class="lc hj"><em class="la">test_data_new</em></strong> --attribute-definitions AttributeName=<em class="la">primary_key</em>,AttributeType=S AttributeName=<em class="la">time_stamp</em>,AttributeType=N --key-schema AttributeName=<em class="la">primary_key</em>,KeyType=HASH AttributeName=<em class="la">time_stamp</em>,KeyType=RANGE --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1</span><span id="0a48" class="lg jy hi lc b fi ll li l lj lk">aws dynamodb delete-table --table-name <strong class="lc hj"><em class="la">test_data</em></strong></span></pre><h1 id="2d80" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak"> 2)更新TTL列以从DynamoDB中删除项目</strong></h1><p id="486f" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">TTL(生存时间)属性是DynamoDB表项的过期时间戳。TTL属性必须是<em class="la">数字</em>数据类型。</p><p id="88bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，数据被插入到DynamoDB表中，而没有填充TTL列。</p><p id="6ad2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更改表中项目的TTL需要更新每个项目的TTL属性值。因此，您必须执行扫描并过滤您想要删除的结果，然后对所有项目执行<em class="la"> update-item </em>以更新TTL值。</p><p id="a4dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们不能使用<em class="la">批量写入项目</em>中的更新项目，我们只能使用上传和删除请求。</p><p id="348e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我尝试用当前/过去的纪元时间格式(例如1587191489)更新TTL列(如果它是零)。纪元时间不应超过5年。</p><p id="9fa6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">纪元时间是自1970年1月1日以来经过的秒数。</p><p id="49d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了获得当前的纪元时间，我们可以在任何UNIX风格的机器上运行"<em class="la"> date +%s </em>"命令。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="abca" class="lg jy hi lc b fi lh li l lj lk">aws dynamodb scan --table-name <strong class="lc hj"><em class="la">test_data</em></strong> --projection-expression "<em class="la">primary_key, time_stamp</em>" --expression-attribute-names '<em class="la">{"#ttlive":"ttl"}</em>' --max-items 1000 --filter-expression "<em class="la">#ttlive = :ttzero AND time_stamp &lt; :oldest_date</em>" --expression-attribute-values '<em class="la">{":ttzero":{"N":"0"}, ":oldest_date":{"S":"2020-02-01"}}</em>' &gt; $SCAN_OUTPUT_FILE</span><span id="ec32" class="lg jy hi lc b fi ll li l lj lk">aws dynamodb update-item --table-name <strong class="lc hj"><em class="la">test_data</em></strong> --key file://$SCAN_OUTPUT_FILE --update-expression "<em class="la">SET #ttlive = :ttvalue</em>" --condition-expression "<em class="la">#ttlive = :ttzero</em>" --expression-attribute-names '<em class="la">{"#ttlive":"ttl"}</em>' --expression-attribute-values '<em class="la">{":ttvalue":{"N":"1587191489"},":ttzero":{"N":"0"}}</em>'</span></pre><p id="1adc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行<em class="la">扫描</em>操作之前，如果没有足够的rcu可用或者不是按需的，您必须增加rcu(读取容量单位)。</p><p id="fd59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TTL将当前时间与项目的TTL属性中存储的时间进行比较。</p><p id="ee4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DynamoDB尽最大努力删除过期项，以确保其他数据操作的吞吐量(wcu)可用性。</p><p id="1c65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TTL到期后，记录将被标记为删除，将在48小时内<strong class="ih hj">被删除(根据AWS)。我观察到这需要更长的时间，甚至超过15天，这取决于表的大小&amp;工作量。</strong></p><p id="a201" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TTL删除不计入容量单位或请求单位。TTL删除是免费的。</p><p id="1bbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想减小表的大小或者想删除旧的数据，更新TTL是<strong class="ih hj">而不是</strong>推荐的方法。</p><h1 id="bbf0" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak"> 3)使用delete-item命令/API从DynamoDB中删除记录</strong></h1><p id="906c" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">在大多数RDBMS数据库中，删除命令将与接受精确值或模式的条件一起工作，我们可以通过在where子句中使用非主键列来运行删除查询。</p><p id="4acc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是在NoSQL数据库中，比如Dynamo DB，我们必须在删除条件中提供精确的值，并且我们必须传递每一项的主键和范围键值。</p><blockquote class="lm ln lo"><p id="c9ad" class="if ig la ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">在Amazon DynamoDB中，DeleteItem API一次删除一个项目。</p></blockquote><p id="fa8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="la"> delete-item </em>中，条件删除(使用<em class="la">条件表达式</em>参数)仅在满足特定条件时对删除项目有用。</p><p id="800c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除项目时，它们会从任何本地辅助索引和全局辅助索引(如果有)中删除。</p><p id="a916" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我正在执行扫描，并从表中过滤项目以删除它们。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="816e" class="lg jy hi lc b fi lh li l lj lk">aws dynamodb scan --table-name "$TABLE_NAME" --projection-expression "<em class="la">primary_key, time_stamp</em>" --filter-expression <em class="la">"time_stamp &lt; :oldest_date" --expression-attribute-values '{":oldest_date":{"S":"2020-02-01"}}</em>' --max-items 1000 --total-segments "$TOTAL_SEGMENT" --segment "$SEGMENT_NUMBER" &gt; $SCAN_OUTPUT_FILE</span><span id="bc27" class="lg jy hi lc b fi ll li l lj lk">cat $SCAN_OUTPUT_FILE | jq -r ".Items[] | tojson" | tr '\n' '\0' | xargs -0 -I keyItem aws dynamodb delete-item --table-name "$TABLE_NAME" --key=keyItem</span></pre><p id="46e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单次<em class="la">扫描</em>操作最多读取- <em class="la">最大项目数/限制</em>指定的最大项目数。</p><p id="8111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">扫描操作按顺序进行，为了在较大的表上获得更快的性能，我们可以通过提供<em class="la"> Segment </em>和<em class="la"> TotalSegments </em>参数来请求并行扫描操作。</p><p id="935a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="la"> TotalSegments </em>表示将同时访问表的工人总数。</p><p id="889e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="la">段</em>表示将由调用工作器/脚本访问的表的单个段。<em class="la">段</em>必须大于等于0，且小于为<em class="la">总段</em>提供的值。</p><p id="c00a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用分段/分页，分10段运行，每段删除1000个项目，耗时20-30分钟。因此，要删除10，000个项目，脚本大约需要20-30分钟。</p><h1 id="d050" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak"> 4)使用(AWS CLI)批量写入项目来批量删除DynamoDB项目</strong></h1><p id="941e" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated"><em class="la"> BatchWriteItem </em>操作在一个或多个表格中放置或删除多个项目。</p><p id="63df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了加快处理速度，您可以在一次<em class="la"> BatchWriteItem </em>调用中删除多达25个项目，而不是逐个删除项目。</p><p id="7927" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CLI中的批量写入项目需要一个<em class="la"> RequestItems </em> JSON来指定单个删除请求。</p><blockquote class="lm ln lo"><p id="6455" class="if ig la ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">通过使用JQ实用程序，我们可以将扫描结果页面转换为请求项目格式。</p></blockquote><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="e8fd" class="lg jy hi lc b fi lh li l lj lk">aws dynamodb scan --table-name "<strong class="lc hj"><em class="la">test_data</em></strong>" --projection-expression "<em class="la">primary_key, time_stamp</em>" --filter-expression "<em class="la">time_stamp &lt; :oldest_date" --expression-attribute-values '{":oldest_date":{"S":"2021-04-01"}}</em>' --max-items 25 --total-segments "$TOTAL_SEGMENT" --segment "$SEGMENT_NUMBER" &gt; $SCAN_OUTPUT_FILE</span><span id="a67c" class="lg jy hi lc b fi ll li l lj lk">cat $SCAN_OUTPUT_FILE | jq -r ".Items[] | tojson" | awk '{ print "{\"DeleteRequest\": {\"Key\": " $0 " }}," }' | sed '$ s/.$//' | sed '1 i { "<strong class="lc hj"><em class="la">test_data</em></strong>": [' | sed '$ a ] }' &gt; $INPUT_FILE</span><span id="7ca4" class="lg jy hi lc b fi ll li l lj lk">aws dynamodb batch-write-item --request-items file://$INPUT_FILE</span></pre><p id="aa70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行<em class="la"> scan </em>命令之前，<strong class="ih hj">增加rcu</strong>(读取容量单位)，在运行<em class="la"> batch-write-item </em> CLI/API命令<em class="la">，</em> <strong class="ih hj">增加wcu</strong>(写入容量单位)。</p><p id="b553" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了更多的段，这可能会减少每个扫描段的结果集，这将有助于根据段的数量进行等效的并行<em class="la"> delete-item </em>调用。这将增加删除的并行性，并有助于加快从表中删除项目的速度。</p><p id="9184" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="la">在<em class="la"> BatchWriteItem </em>中提到的DeleteItem </em>操作是原子的。如果操作因任何错误而失败，输出中只会返回失败的操作。</p><p id="3514" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">截至2023年3月，<strong class="ih hj"> 25 </strong> <strong class="ih hj">请求<em class="la">批写项</em>中的</strong>是迪纳摩DB中的硬限制，不能增加。</p><p id="51de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">显然，我们的记录列表中将有超过25条记录需要删除，所以我们必须使用循环来遍历所有记录。</p><h1 id="a35c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">使用循环扫描</strong>(针对每个片段):</h1><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="4d27" class="lg jy hi lc b fi lh li l lj lk">vi scan_dynamo_table.sh</span><span id="6045" class="lg jy hi lc b fi ll li l lj lk">TOTAL_SEGMENTS=$1<br/>SEGMENT_NUMBER=$2<br/>SCAN_OUTPUT="scan-output-segment${SEGMENT_NUMBER}.json"<br/>SCAN_AGGREGATE="scan-agg-segment${SEGMENT_NUMBER}.json"</span><span id="0e70" class="lg jy hi lc b fi ll li l lj lk">aws dynamodb scan --table-name "<strong class="lc hj"><em class="la">test_data</em></strong>" --projection-expression "<em class="la">primary_key, time_stamp</em>" --filter-expression "<em class="la">time_stamp &gt;= :start_date and time_stamp &lt;= :end_date</em>" --expression-attribute-values '<em class="la">{":start_date":{"S":"2021-01-01"}, ":end_date":{"S":"2021-03-31"}}</em>' --max-items "1000" --total-segments "${TOTAL_SEGMENTS}" --segment "${SEGMENT_NUMBER}" &gt; ${SCAN_OUTPUT}</span><span id="12f8" class="lg jy hi lc b fi ll li l lj lk">NEXT_TOKEN="$(cat ${SCAN_OUTPUT} | jq '.NextToken')"<br/>cat ${SCAN_OUTPUT} | jq -r ".Items[] | tojson" &gt; ${SCAN_AGGREGATE}</span><span id="f74a" class="lg jy hi lc b fi ll li l lj lk">while [ ! -z "$NEXT_TOKEN" ] &amp;&amp; [ ! "$NEXT_TOKEN" == null ]<br/>do</span><span id="d84e" class="lg jy hi lc b fi ll li l lj lk">aws dynamodb scan --table-name "<strong class="lc hj"><em class="la">test_data</em></strong>" --projection-expression "<em class="la">primary_key, time_stamp</em>" --filter-expression "<em class="la">time_stamp &gt;= :start_date and time_stamp &lt;= :end_date</em>" --expression-attribute-values '<em class="la">{":start_date":{"S":"2021-01-01"}, ":end_date":{"S":"2021-03-31"}}</em>' --max-items "1000" --total-segments "${TOTAL_SEGMENTS}" --segment "${SEGMENT_NUMBER}" --starting-token "${NEXT_TOKEN}" &gt; ${SCAN_OUTPUT}<br/><br/>NEXT_TOKEN="$(cat ${SCAN_OUTPUT} | jq '.NextToken')"<br/>cat ${SCAN_OUTPUT} | jq -r ".Items[] | tojson" &gt;&gt; ${SCAN_AGGREGATE}</span><span id="8d47" class="lg jy hi lc b fi ll li l lj lk">done</span></pre><p id="ba79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用N个片段进行扫描，符合所需的选择标准，这将生成N个文件(<em class="la"> scan-agg-segment*)。json </em>)，所有需要的记录都被删除。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="7c4f" class="lg jy hi lc b fi lh li l lj lk">vi run_scan_table.sh</span><span id="ec74" class="lg jy hi lc b fi ll li l lj lk">TOTAL_SEGMENTS=100          # N, total number of segments</span><span id="5742" class="lg jy hi lc b fi ll li l lj lk">for SEGMENT in `seq 0 $((${TOTAL_SEGMENTS}-1))`<br/>do<br/> nohup sh scan_dynamo_table.sh ${TOTAL_SEGMENTS} ${SEGMENT} &amp;<br/>done</span></pre><h1 id="7780" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">使用循环删除</strong>(针对每段):</h1><p id="5e94" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">然后，您可以运行N个<em class="la">批处理写项目</em>脚本，如下所示，这些脚本将读取相应的文件(上面生成的),并在循环中一次删除25条记录。这里N可以是10、1000或任何数字(取决于您的服务器)。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="cf24" class="lg jy hi lc b fi lh li l lj lk">vi batch_write_item_delete.sh</span><span id="bb62" class="lg jy hi lc b fi ll li l lj lk">SEGMENT_NUMBER=$1<br/>SCAN_AGGREGATE="scan-agg-segment${SEGMENT_NUMBER}.json"<br/>SEGMENT_FILE="delete-segment${SEGMENT_NUMBER}.json"<br/>MAX_ITEMS=25      # maximum number of items batch-write-item accepts</span><span id="a480" class="lg jy hi lc b fi ll li l lj lk">printf "starting segment - ${SEGMENT_NUMBER} \n" &gt; ${SEGMENT_FILE}</span><span id="0d58" class="lg jy hi lc b fi ll li l lj lk">until [[ ! -s ${SEGMENT_FILE} ]] ;<br/>do</span><span id="f241" class="lg jy hi lc b fi ll li l lj lk">awk "NR&gt;${CNT:=0} &amp;&amp; NR&lt;=$((CNT+MAX_ITEMS))" ${SCAN_AGGREGATE} | awk '{ print "{\"DeleteRequest\": {\"Key\": " $0 " }}," }' | sed '$ s/.$//' | sed '1 i { "<strong class="lc hj"><em class="la">test_data</em></strong>": [' | sed '$ a ] }' &gt; ${SEGMENT_FILE}<br/> <br/>aws dynamodb batch-write-item --request-items file://${SEGMENT_FILE}</span><span id="2b73" class="lg jy hi lc b fi ll li l lj lk">CNT=$((CNT+MAX_ITEMS))</span><span id="6878" class="lg jy hi lc b fi ll li l lj lk">done</span></pre><p id="e177" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行上面的删除脚本。</p><pre class="je jf jg jh fd lb lc ld le aw lf bi"><span id="f001" class="lg jy hi lc b fi lh li l lj lk">vi run_batch_delete.sh</span><span id="6441" class="lg jy hi lc b fi ll li l lj lk">TOTAL_SEGMENTS=100        # N, total number of segments/files exists</span><span id="cd5b" class="lg jy hi lc b fi ll li l lj lk">for SEGMENT in `seq 0 $((${TOTAL_SEGMENTS}-1))`<br/>do<br/> nohup sh batch_write_item_delete.sh ${SEGMENT} &amp;<br/>done</span></pre><p id="9283" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过使用<em class="la"> delete-item </em>命令，使用100个片段，脚本能够每分钟删除2500-2700个项目(在c5.4xlarge EC2机器上)。</p><p id="9bd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过使用<em class="la"> batch-write-item </em>命令，使用100个段，脚本能够每分钟删除28000-45000个项目(在c5.4xlarge EC2机器上)。</p><p id="db22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在r5 (r5.4xlarge)和m5 (m5.4xlarge) EC2机器上尝试了相同的删除操作。</p><blockquote class="lm ln lo"><p id="7b8d" class="if ig la ih b ii ij ik il im in io ip lp ir is it lq iv iw ix lr iz ja jb jc hb bi translated">使用m5/r5/c5实例类型，批量写入项目<em class="hi">帮助我每小时删除超过500万条记录。</em></p></blockquote><h1 id="f2ea" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">总结</strong></h1><p id="f9f2" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated"><strong class="ih hj">JSON查询处理器jq </strong>非常有用，通过它我们可以播放和格式化DynamoDB查询提供的JSON输出。</p><p id="d507" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于预生产数据库或任何非关键的AWS DynamoDB表，最好遵循停机方法，在这种情况下，您必须删除现有的表，重新创建一个空白表并开始使用它。</p><p id="28dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于生产数据库和关键的Amazon DynamoDB表，建议使用<em class="la"> batch-write-item </em>来清除万亿字节的数据。</p><p id="48b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="la">批量写项</em>(带<em class="la">删除请求</em>)比<em class="la">删除项</em>快10到15倍。</p></div></div>    
</body>
</html>