<html>
<head>
<title>How I made a mask detection algorithm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何制作一个面具检测算法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-i-made-a-mask-detector-algorithm-10244fb2e39a?source=collection_archive---------9-----------------------#2020-12-11">https://medium.com/analytics-vidhya/how-i-made-a-mask-detector-algorithm-10244fb2e39a?source=collection_archive---------9-----------------------#2020-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5a6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">将一个简单的分类器变成一个对象检测模型，同时在我的隔离区练习深度学习</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/cdfa365fea22db59fb2bd9735d21bcbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Ld_5o2DTWOFl40SYGddsQ.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">照片由<a class="ae ju" href="https://unsplash.com/@jannerboy62?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">尼克·费因斯</a>在<a class="ae ju" href="https://unsplash.com/s/photos/stay-safe?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="d392" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在冠状病毒传播期间，意大利进入了秋季的第二次封锁，这给了我很多空闲时间。</p><p id="9213" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想创建一个系统，能够检测人们是否戴着面具，无论是在图像中还是在实时视频流中。我只是想用一些计算机视觉任务来挑战一下自己，但这个系统可以很容易地扩展到现实生活的安全目的(例如，商店、机场、街道等)。).</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jv"><img src="../Images/b5c218c833e33d4d7b8e968bd734d5ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*nQ4QFMHnWfaaJ88mxRiMuA.gif"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">作者的面具检测演示</figcaption></figure><h1 id="f77e" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">问题是</h1><p id="a3f6" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">我刚才描述的是一个物体检测任务；因此，理想情况下，应该使用一个大数据集，该数据集不仅标记有“with _ mask”/“with _ mask”，还标记有面部位置。顺着这个思路，我遇到了第一个问题:没有这样的数据集。我所找到的是一个由大约 7600 张图片组成的数据集:50%“带遮罩”，50%“不带遮罩”，这要感谢<a class="ae ju" href="https://www.kaggle.com/omkargurav/face-mask-dataset" rel="noopener ugc nofollow" target="_blank">这个 Kaggle 数据集</a>；另一种方法可能是考虑人脸数据集，然后人为地给人脸添加面具。<br/>此外，实时检测增加了另一个困难:模型必须非常快，在数据流到达时即时处理图像。理想的架构应该是 MobilenetSSD 或类似的端到端网络，但缺少标注了标签和位置的大型数据集将它们淘汰出局。</p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="22eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我有两种可能的解决方案:</p><ol class=""><li id="ae3a" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated">考虑具有不同形状的锚盒，并在多个尺度上执行滑动窗口，寻找被遮掩/未被遮掩的面部，然后应用非最大抑制；</li><li id="0879" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated">考虑预先存在的面部检测算法，然后对来自第一算法的所选框执行分类。</li></ol><p id="8d85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定采用第二种选择，因为从计算角度来看，这是一个更好的解决方案，这对于实时检测至关重要。事实上，第一选择甚至可以为每一帧处理数千个子图像！</p><p id="4e9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，一旦我得到了数据集，我就决定使用 MobilenetV2，以便对那些子图像进行二进制分类(“有掩码”-“无掩码”)；这个模型非常准确，而且没有其他模型复杂:这正是我要找的组合！</p><p id="4664" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这种方式，我能够<strong class="ih hj">将一个简单的分类器变成一个对象检测模型</strong>:我甚至可以选择一个 KNN、随机森林或者另一个经典的统计分类器。</p><h1 id="fef9" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">模特培训</h1><p id="220b" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">Keras 为在 Imagenet 上训练的原始 MobilenetV2 模型提供了权重，因此我添加了一个平均池和两个更密集的层(带有 dropout ),以实现我的目标，获得图中所示的架构。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lu"><img src="../Images/0d3212349ecdafa5f58ca0bc0d16f54c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*sdXgDfFa69aL9RmI47-12Q.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">原始 Mobilenet 的架构，几乎没有附加层。</figcaption></figure><p id="8946" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了增强模型的功能，我使用 Keras 提供的 ImageDataGenerator 类添加了一个图像增强生成器，在训练集(总图像的 70%)和验证集中(20%)都使用了以下代码:</p><pre class="jf jg jh ji fd lv lw lx ly aw lz bi"><span id="d754" class="ma jx hi lw b fi mb mc l md me">from tensorflow.keras.preprocessing.image import ImageDataGenerator</span><span id="5989" class="ma jx hi lw b fi mf mc l md me">aug = ImageDataGenerator(rotation_range=20,<br/>                         zoom_range=0.15,<br/>                         width_shift_range=0.2,<br/>                         height_shift_range=0.2,<br/>                         shear_range=0.15,<br/>                         horizontal_flip=True,<br/>                         fill_mode="nearest",<br/>                         validation_split=0.2)</span><span id="f37c" class="ma jx hi lw b fi mf mc l md me"># data augmentation on training set<br/>train_generator = aug.flow(x_train, y_train, batch_size=BS, subset="training")</span><span id="e964" class="ma jx hi lw b fi mf mc l md me"># data augmentation on validation set<br/>val_generator = aug.flow(x_train, y_train, batch_size=BS, subset="validation")</span></pre><p id="2576" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个模型以惊人的好结果超过了我。添加早期停止我防止了模型过度拟合训练数据，让模型按照它需要的历元，这给了我测试集上的结果(10%):</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mg"><img src="../Images/8b613f56e1604077de28cdc4ce341da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*zGJc5SR6wkQqj6tndeRSrg.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在测试集上评估的模型的度量</figcaption></figure><p id="17bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这条学习曲线是:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jv"><img src="../Images/f9e9b9d275072a1ad5c507def5256747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*zraC6t9Dtfdg6Kv_M0aYPA.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">训练期间模型的准确性和损失</figcaption></figure><p id="60c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于人脸检测部分，我尝试了两个 CascadeClassifier，一个 CV2 算法，两个 MTCNN 库，它们都给了我很好的结果；就我个人而言，我选择了第一个，但即使是第二个也应该是一个很好的选择。CascadeClassifier 检测人脸及其位置，因此我可以为每个人脸提取原始图像的一部分，并将其作为独立图像传递给 MobilenetV2，以便对其进行分类。</p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><h1 id="167b" class="jw jx hi bd jy jz mh kb kc kd mi kf kg kh mj kj kk kl mk kn ko kp ml kr ks kt bi translated">Flask web 应用程序</h1><p id="33c4" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">为了让我所做的一切更容易理解，我构建了一个用 Flask 开发的简单 web 应用程序，这是一个有用的 Python 框架，添加了一些 jQuery 和 Ajax magics。<br/>它由两个页面组成:在主页上，您可以尝试实时检测；在第二种情况下，您可以上传自定义图像，在该图像上执行遮罩检测。实时流显然需要访问您的相机，因此系统可以逐帧处理图像，并在每个人脸周围绘制一个边界框(支持多次检测)。</p><p id="1dc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实时处理部分并不容易，但我跟踪了一个很好的资源:如果你对 web 应用感兴趣，我建议你看看 Miguel Grinbergs 的网站。</p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="5372" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我如何开发一个实时面具检测器的:如果你想更深入地了解代码，这里有 Github 库的<a class="ae ju" href="https://github.com/GalileoParise/CV-Mask-detection" rel="noopener ugc nofollow" target="_blank">链接。</a></p><p id="ed1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好好享受，戴上口罩！</p></div></div>    
</body>
</html>