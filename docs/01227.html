<html>
<head>
<title>IoT Data Pipelines in GCP, multiple ways</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP的物联网数据管道，多种方式</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/iot-data-pipelines-in-gcp-multiple-ways-part-2-893269d56371?source=collection_archive---------8-----------------------#2019-10-09">https://medium.com/analytics-vidhya/iot-data-pipelines-in-gcp-multiple-ways-part-2-893269d56371?source=collection_archive---------8-----------------------#2019-10-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d025" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">第2部分:加载实时数据、转换和存储</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d2aaf52bc4011b1a1cc150b992e320b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bF_e2iaOmxqK-F8n"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://unsplash.com/@victor_g?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">维克多</a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="9658" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">欢迎阅读本系列的第2部分。《T4》前情提要第1部分我们配置了发布/订阅主题和BigQuery，并对虚拟数据运行了一些测试查询。</p><p id="288f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，我们开始实际接收一些实时数据，将其转换并存储到我们的BigQuery表中。</p><p id="17b5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">正如我之前提到的，有多种方法可以做到这一点，在这一部分，我们将重点关注一款名为<a class="ae jn" href="https://cloud.google.com/dataflow/" rel="noopener ugc nofollow" target="_blank">云数据流</a>的产品。</p><blockquote class="kk kl km"><p id="e4f1" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">云数据流是一种完全托管的服务，用于以流(实时)和批处理(历史)模式转换和丰富数据，具有同等的可靠性和表达能力，不需要更复杂的解决方案或妥协。借助其无服务器的资源配置和管理方法，您可以获得几乎无限的容量来解决您最大的数据处理挑战，同时只需为您使用的资源付费。</p></blockquote><p id="c46a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了省去用Java或Python编写自己的束流的麻烦，我们将利用Google 的<a class="ae jn" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates" rel="noopener ugc nofollow" target="_blank">预制模板，并使用我们定制的DST转换器来处理数据。</a></p><blockquote class="kk kl km"><p id="bc62" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">云数据流模板允许您在云存储上暂存管道，并从各种环境中运行它们。<br/> Google提供了一套<a class="ae jn" href="https://github.com/GoogleCloudPlatform/DataflowTemplates" rel="noopener ugc nofollow" target="_blank">开源</a>云数据流模板。</p></blockquote></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="74a0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因此，让我们为数据流设置我们的项目。首先，我们需要一些新的环境变量，记得使用和第1部分中相同的变量。<br/>你也可以使用<a class="ae jn" href="https://github.com/jerryjj/iot-pipelines-series" rel="noopener ugc nofollow" target="_blank"> Git库</a>并按照那里的指示来设置它们。</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="c414" class="ld le hi kz b fi lf lg l lh li">export GCP_ZONE=$GCP_REGION-b # choose a zone from selected region<br/>export BUCKET_NAME=$GCP_PROJECT_ID-dataflow<br/>export PIPELINE_FOLDER=gs://${BUCKET_NAME}/devices</span></pre><p id="dce4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在让我们使用gcloud在项目中启用新的API</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="7270" class="ld le hi kz b fi lf lg l lh li">ENABLE_APIS=(<br/>"storage-api.googleapis.com" \<br/>"dataflow.googleapis.com"<br/>)</span><span id="babe" class="ld le hi kz b fi lj lg l lh li">gcloud services enable --project=$GCP_PROJECT_ID ${ENABLE_APIS[@]}</span></pre><p id="8014" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，让我们创建我们的云存储空间</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="1a3e" class="ld le hi kz b fi lf lg l lh li"># If your region is outside EU, change accordingly<br/>gsutil mb -p $GCP_PROJECT_ID -l eu gs://$BUCKET_NAME</span></pre><p id="adf2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如前所述，我们将为我们的Pub/Sub to BigQuery流管道使用Google提供的模板，更具体地说，我们将使用此模板<a class="ae jn" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-streaming#cloud-pubsub-topic-to-bigquery" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/data flow/docs/guides/templates/provided-streaming # cloud-Pub Sub-topic-to-big query</a>，并且我们将利用该模板的UDF(用户定义函数)支持。</p><p id="2557" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了开始部署模板，我们首先需要定义我们的UDF函数，并将其存储到Google云存储中，以便数据流运行程序可以访问它。</p><p id="aa91" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们编写下面的UDF变换函数，并将其保存为udf.js</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="0137" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后，让我们将这个文件复制到我们的云存储桶中</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="e96a" class="ld le hi kz b fi lf lg l lh li">gsutil cp udf.js $PIPELINE_FOLDER/udf.js</span></pre></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="4ecb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们准备在数据流中启动管道，一旦我们执行以下命令，管道将创建一个订阅我们的发布/订阅主题，并开始侦听传入的消息，解析它们并将它们存储到BigQuery。</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="69c0" class="ld le hi kz b fi lf lg l lh li">JOB_NAME=device-signals-`date +"%Y%m%d-%H%M%S"`</span><span id="4b94" class="ld le hi kz b fi lj lg l lh li">gcloud dataflow jobs run $JOB_NAME \<br/>--project=$GCP_PROJECT_ID \<br/>--region $GCP_REGION --zone $GCP_ZONE \<br/>--gcs-location gs://dataflow-templates/2019-07-10-00/PubSub_to_BigQuery \<br/>--parameters \<br/>"inputTopic=projects/$GCP_PROJECT_ID/topics/$PS_TOPIC_ID,\<br/>outputTableSpec=$GCP_PROJECT_ID:$BQ_DATASET_ID.$BQ_TABLE_ID,\<br/>outputDeadletterTable=$GCP_PROJECT_ID:$BQ_DATASET_ID.${BQ_TABLE_ID}_deadletter,\<br/>javascriptTextTransformFunctionName=transformDeviceSignalEvent,\<br/>javascriptTextTransformGcsPath=$PIPELINE_FOLDER/udf.js"</span></pre><p id="4666" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，我们可以转到GCP控制台中的数据流仪表板来监控管道。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lm"><img src="../Images/4f43017225f62a98e94d4c9e1400c8ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5hhSCm4cUdk4Nd2xtq2vrQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">管道正在预热</figcaption></figure><p id="773e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，正如您所看到的，尽管发布/订阅主题中没有可用的数据，但已经有最少数量的虚拟机在运行并等待数据。</p><p id="a7e1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因此，让我们给他们一些事情做，并启动我们的设备模拟器，开始向我们的发布/订阅主题发送一些数据。</p><p id="9643" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为此，首先必须从Github 中克隆这个文章系列<a class="ae jn" href="https://github.com/jerryjj/iot-pipelines-series" rel="noopener ugc nofollow" target="_blank">库，并设置模拟器/自述文件中提到的先决条件。</a></p><p id="74be" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要使用10台设备运行模拟器，请运行以下命令</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="ec42" class="ld le hi kz b fi lf lg l lh li"># this will launch 10 devices in Helsinki, Finland by default<br/>cd simulator/<br/>DEVICE_COUNT=10 node src/index.js</span></pre><p id="9a4b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您应该会看到发送不同信号的设备的一些调试输出</p><p id="32fb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，如果您返回到GCP控制台的数据流视图，您应该会看到处理数据的步骤。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lm"><img src="../Images/066de70e7f121df5c0d7ad67318ab242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YTYDnNha65xynKNMXH_45A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">处理传入数据的管道</figcaption></figure><p id="18d4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在打开BigQuery仪表板，执行下面的查询，查看数据库中最新的100个条目(替换您的项目ID)</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="2b5e" class="ld le hi kz b fi lf lg l lh li">SELECT * FROM `YOUR_PROJECT_ID.devices.signals` ORDER BY timestamp DESC LIMIT 100</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ln"><img src="../Images/17c9a02713ac323d03cb4553f1e709ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TMlorMZTHJVbFG2D5_XsjQ.png"/></div></div></figure><p id="1bb0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">好了，你拿到了。现在，您有了一个数据流管道，可以处理从设备到BigQuery表的所有数据。</p><p id="ee96" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">点击云控制台用户界面，查看数据流日志，查看发布/订阅主题和订阅视图，以熟悉其他设置。</p><p id="a70c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">例如，当您检查您的订阅仪表板时，您将看到未确认消息的峰值。发生这种情况是因为我们的模拟器正在向主题发送事件，但是数据流还没有准备好开始从订阅中读取它们。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lo"><img src="../Images/e2e77263061df28fe06693dd7df181ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*57Aefp44Pj28bwA6ms4okA.png"/></div></figure><p id="51e0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如您所见，一旦管道准备就绪，它就会提取所有旧消息并进行处理。</p><p id="50a0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">记住停止你的数据流管道，这样它就不会继续产生费用。为此，请停止模拟器(CTRL-C)并运行以下命令</p><pre class="iy iz ja jb fd ky kz la lb aw lc bi"><span id="48a5" class="ld le hi kz b fi lf lg l lh li">JOB_ID=$(gcloud --project $GCP_PROJECT_ID dataflow jobs list --region $GCP_REGION --status active --filter=name:device --format="value(id)")</span><span id="7528" class="ld le hi kz b fi lj lg l lh li">gcloud --project $GCP_PROJECT_ID dataflow jobs drain --region $GCP_REGION $JOB_ID</span></pre><p id="f3c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">数据流的定价基于所选的机器类型、最大工人数量、磁盘大小等。根据数据量，该管道(默认情况下)每月的成本约为256-768美元。</p></div><div class="ab cl kr ks gp kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="hb hc hd he hf"><p id="43ef" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这就结束了我们这个系列的第二部分。在下一部分，我们将讨论如何使用云函数在没有数据流的情况下做到这一点。</p><p id="31a3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您的阅读，这里是第三部分的链接。</p></div></div>    
</body>
</html>