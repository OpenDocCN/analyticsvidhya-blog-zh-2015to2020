<html>
<head>
<title>Pitch Predict — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">音高预测—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/pitch-predict-part-1-7001516d9f40?source=collection_archive---------7-----------------------#2019-10-17">https://medium.com/analytics-vidhya/pitch-predict-part-1-7001516d9f40?source=collection_archive---------7-----------------------#2019-10-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="613f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用机器学习来预测下一次投球</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/320f89a6a0934429bafbcf56a2ff582b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJPdjnI381y_B_RaUm1bEw.png"/></div></div></figure><p id="10e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是涵盖Lambda School最近的数据科学项目的一系列文章中的第1部分。项目<a class="ae jp" href="https://github.com/labs15-baseball-pitch-predictor" rel="noopener ugc nofollow" target="_blank"> github repo可以在这里找到</a>。为了获得一些使用<a class="ae jp" href="https://plot.ly/dash/" rel="noopener ugc nofollow" target="_blank"> Plotly Dash </a>的经验，我还创建了一个<a class="ae jp" href="https://pitch-predict.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">仪表盘应用，这里是</a>。这个系列的第2部分可以在这里找到<a class="ae jp" rel="noopener" href="/@jmancuso82/pitch-predict-part-2-637e3578d3e8">，第3部分</a><a class="ae jp" rel="noopener" href="/@jmancuso82/pitch-predict-part-3-2f648d8fe825">在这里</a>。</p><h1 id="dde4" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="13ba" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated"><em class="kt">项目和我们目标的概述</em></p><p id="0348" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在美国职业棒球大联盟中击球的任务是极其困难的。考虑一个伟大的击球手的基准是0.300的平均击球率——这只是30%的成功率。如果击球手知道投手下一次可能投什么球，他成功的机会就会大大增加。投手比击球手(或一般人)意识到的更容易预测吗？对于一个协作数据科学组项目，基于封装了投手的先前倾向、击球手的先前倾向、游戏状态、最近n次按时间顺序排列的投球和投手-击球手先前比赛历史的数据，我们开始使用机器学习模型来尝试回答这个问题。</p><p id="35ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该项目旨在为进一步的研究奠定基础，并有可能成为一个应用程序，该应用程序将投球预测功能与当前比赛、投手和击球手的实时信息结合在一起，呈现在一个有吸引力的用户界面中。在制定设计决策时考虑到了这种可能性，许多组件都被设计成通用的，并且可以根据弹性资源进行扩展。</p><h1 id="9b1f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">数据采集</h1><p id="0db3" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated"><em class="kt">解释我们的数据来自哪里，其高级特征，我们如何存储和访问它，以及它是如何细分的</em></p><p id="3d71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过<a class="ae jp" href="https://github.com/jldbc/pybaseball" rel="noopener ugc nofollow" target="_blank"> pybaseball </a>包从Statcast收集音高数据。Pybaseball的statcast类允许我们按日期范围查询球场。在确定了2017年、2018年和2019年*(直到8/31/19)常规赛的开始和结束日期后，我们能够将数据加载到包含每个常规赛的每个记录球场的熊猫数据帧中。这些数据帧随后要进行初步的数据清理。清理之后，数据帧被压缩并作为pickle文件存储在github中。</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="6594" class="kz jr hi kv b fi la lb l lc ld">import pandas as pd<br/>from pybaseball import statcast</span><span id="ee25" class="kz jr hi kv b fi le lb l lc ld">drop_cols = ['spin_dir','spin_rate_deprecated', 'break_angle_deprecated','break_length_deprecated', <br/>             'game_type', 'tfs_deprecated', 'tfs_zulu_deprecated', 'umpire']</span><span id="67dc" class="kz jr hi kv b fi le lb l lc ld">#2017<br/>df = statcast('2017-04-02', '2017-10-02')<br/>df = df.drop(columns=drop_cols)</span><span id="4b41" class="kz jr hi kv b fi le lb l lc ld">df.to_pickle(path='pitches_2017.pkl', compression='zip')</span></pre><p id="7cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">考虑到未来的项目开发，数据除了被压缩并作为pickle文件存储在主项目GitHub存储库中之外，还作为pickle文件和csv文件存储在S3存储桶中。这些csv文件随后被用于创建红移表，包含2010年至2019年的所有常规赛投球。这种存储架构是为这个项目的未来迭代而设计的，以便扩展模型将被训练的投手的数量，并创建实时投球预测web应用程序。对于当前项目的范围，模型训练和预测是在Jupyter实验室笔记本上的AWS sage maker ml . m 4 . 4x大型实例上生成的。项目<a class="ae jp" href="https://pitch-predict.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">仪表盘</a>是使用Plotly Dash创建的，托管在Heroku上。</p><h1 id="5655" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">数据预处理/特征工程</h1><p id="7bee" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated"><em class="kt">工程特征和方法的解释</em></p><p id="f6c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如在数据科学领域经常出现的情况一样，花费在这个项目上的大部分时间都用于数据清理、处理和特性工程。一开始，我们对项目进行了高层次的概述，并试图规划所有必要步骤的蓝图，以及我们希望如何将来自Statcast的原始音高数据转换为我们希望的格式，以作为机器学习模型的输入向量。</p><p id="10f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">清理坏的/错误的数据</strong></p><p id="a2d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在不深入细节的情况下，在数据争论和功能工程的过程中，我们在数据中遇到了一些小故障，所以我们在前面添加了一些代码，试图解决大部分问题。基本上，这包括剔除少量未安装Statcast摄像机跟踪系统的海外比赛，用NaN值替换未知的球场类型，在少数情况下将球数从4个固定为3个，以及其他一些类似错误数据的小例子。</p><p id="7220" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">一个<em class="kt"> ll </em>节距数据的工程特征:</strong></p><p id="ca11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然原始Statcast数据本身包括大量的特征，但我们试图发挥创造力，提出一些非常酷的附加特征，试图增强我们的预测模型的性能。由于每个投手都有独特的球路和个人倾向，试图用所有投手的数据建立一个预测模型是徒劳的。由于这个原因，我们知道我们想要预测的每个投手都必须从所有投球的完整数据集中筛选出来。在达到这一步之前，我们设计了许多适用于所有投手的功能。</p><p id="83ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">游戏状态特征</strong></p><p id="c4dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Statcast数据包括计数的当前状态(通过球的特征和击球的特征)，但我们还想使用12个可能的计数作为分类变量。我们将球和击球组合成一个字符串表示，其中0–0计数编码为“00”，3–2编码为“32”，等等。此外，我们进一步将计数映射为3个类别，代表计数是否偏向投手、击球手或计数是否中立。有理由认为，投手处理这些情况的方式不同，他们对投球的选择应该根据计数的有利程度而有很大的变化。</p><p id="8a80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们创建了一个特征来表示得分差异，或者投手团队领先或落后多少分。接下来，使用baserunners的数据，我们将baserunner特性从使用baserunner id转换为二进制1/0，不管每个垒上是否有一个跑步者。此外，我们增加了一个功能，是否有任何球员在任何基地对基地空，也有一个功能，是否基地加载。当跑垒员在垒上连续投球时，投手可能在他的倾向上有微妙的不同，而当垒上是空的时，则相反。一垒上的跑垒员有偷垒和前进的潜力，所以也许一些投手不太可能在泥土中扔出那么多可能远离捕手并让跑垒员前进到得分位置的破球。也许一个在二垒上的跑垒员清楚地看到接球手的投球信号，并有可能偷到信号，并用自己的信号提示击球手，这可能会影响投手的投球选择。也许这些趋势中的一些可以有助于机器学习模型进行预测。</p><p id="902b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">打击区和击球手挥棒/追逐特征</strong></p><p id="d591" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用来自Statcast摄像系统的位置数据，基于特定击球手的高度/姿势的击球区边界，以及本垒板的尺寸，我们创建了一个特征，将每个投球分类为在击球区内或击球区外(不管裁判称之为球还是击球)。此外，使用来自Statcast的<em class="kt">‘描述’</em>特征，我们提取了指示击球手在投球时挥杆的描述，并创建了表示击球手是否挥杆的二元特征。通过组合这些工程特征，我们创建了一个特征来表示击球手<em class="kt"/>是否追逐了一个在好球区之外的球。我们认为这在以后创建关于每个击球手的球探报告时会很有用，因为如果击球手倾向于在好球带外追逐某些类型的球，投手可能会在比赛前知道这些信息，并且他可能更有可能对该球员投出某些类型的球。</p><pre class="je jf jg jh fd ku kv kw kx aw ky bi"><span id="283f" class="kz jr hi kv b fi la lb l lc ld">def make_strikezone_swung_and_chase_features(df):<br/>    df = df.copy()<br/>    <br/>    #create swung column<br/>    def swung(x):<br/>        swung = ['foul','hit_into_play','swinging_strike',<br/>                 'hit_into_play_no_out', 'hit_into_play_score',<br/>                 'foul_tip','swinging_strike_blocked',<br/>                 'foul_bunt','missed_bunt']<br/>        return 1 if x in swung else 0</span><span id="d9d9" class="kz jr hi kv b fi le lb l lc ld">    df['batter_swung'] = df['description'].apply(swung)<br/>    <br/>    #initialize in_strikezone and chased features:<br/>    df['in_strikezone'] = 1<br/>    df['chased'] = 0<br/>    <br/>    df['ball_high'] = df['plate_z'] &gt; df['sz_top']<br/>    df['ball_low'] = df['plate_z'] &lt; df['sz_bot']<br/>    df['ball_left'] = df['plate_x'].apply(lambda x: x &lt; -0.73)<br/>    df['ball_right'] = df['plate_x'].apply(lambda x: x &gt; 0.73)<br/>    df['in_strikezone'] = df['ball_high'] + df['ball_low'] +    df['ball_left'] + df['ball_right']<br/>    <br/>    df['in_strikezone'] = df['in_strikezone'].apply(lambda x: 0 if x    &gt; 0 else 1)<br/>    <br/>    df['chased'] = df['batter_swung'] - df['in_strikezone']<br/>    df['chased'] = df['chased'].apply(lambda x: 1 if x == 1 else 0)<br/>    return df</span></pre><p id="25f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">音高类别和空值插补</strong></p><p id="e27f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，Statcast数据库中很小一部分(约0.4%)的音高，可能是由于相机系统中的随机故障或其他原因，缺少该音高的音高类型分类值。为了保持每场比赛的球场连续性，而不是简单地从数据帧中删除所有这些行，我们决定估算这些值。我们的插补策略只是使用给定投手的音高类型的总体分布，并进行随机猜测，使用这些分布作为随机猜测的权重。接下来，我们将不同的投球类型映射成一个更一般的投球类型类别:快速球(4缝线、2缝线、切球、伸卡球)、破球(曲球、滑球、指节曲球、螺旋球)和变速球(变速球、指节球和易夫球)。</p><p id="3127" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">接下来:</strong></p><p id="5d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，<a class="ae jp" rel="noopener" href="/@jmancuso82/pitch-predict-part-2-637e3578d3e8">第2部分</a>将继续进行特征工程，包括创建击球手侦察报告(趋势和成功与不同类型的投球)，投手侦察报告，比赛流程/尾随投球特征，以及来自投手/击球手先前比赛历史的投球趋势。最后，<a class="ae jp" rel="noopener" href="/@jmancuso82/pitch-predict-part-3-2f648d8fe825">第3部分</a>将涵盖模型选择、训练和模型预测分析。</p></div></div>    
</body>
</html>