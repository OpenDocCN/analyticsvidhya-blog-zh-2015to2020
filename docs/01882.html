<html>
<head>
<title>AWS Lex/Chatbot Python Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lex/聊天机器人Python Lambda</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/aws-lex-chatbot-python-lambda-84a17c2418ac?source=collection_archive---------9-----------------------#2019-11-19">https://medium.com/analytics-vidhya/aws-lex-chatbot-python-lambda-84a17c2418ac?source=collection_archive---------9-----------------------#2019-11-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0a1a66f811dd1524206f81c81ee606f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vAW_BPBsEpEc6U9q"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">萨法尔·萨法罗夫在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="82d1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文的目的是分享我在为AWS Lex机器人编写Lambdas时的心得。请注意，聊天机器人的对话可以更自然，但本文的重点是在Lambda方面。</p><ol class=""><li id="4188" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">启用对用户提供的信息的动态验证。根据某些条件，您可以将某个插槽设置为强制/可选。</li><li id="2705" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">用复杂的嵌套JSON发回复杂的响应。</li><li id="a0d6" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">使用sessionAttributes维护用户的上下文。</li><li id="4ef0" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">开发过程中可能遇到的一些常见错误及其根本原因。</li></ol><p id="3900" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，支付流程和ui的显示不在本文讨论范围内。api调用已经被静态JSON取代。<strong class="ix hj">请注意，还添加了一个新的插槽客户名称</strong>。</p><p id="94c0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kh">如果你想更好的理解文章请参考聊天机器人Lex </em> </strong>的基础知识</p><p id="b989" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" rel="noopener" href="/@shuchitaprasad/aws-lex-chatbots-basics-static-bot-d6a1083609f7">https://medium . com/@ shuchitaprasad/AWS-lex-chatbots-basics-static-bot-d6a 1083609 f 7</a></p><p id="2cf8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将继续我们最初的电影订票机器人用例，在上面的链接中，我们刚刚制作了一个静态机器人。现在，我们将使它充满活力。</p><p id="547d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">λ创建</strong></p><p id="b5af" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">进入服务，搜索Lambda并点击创建函数，如下所示。请注意，您选择的角色应该附加有<a class="ae iu" href="https://console.aws.amazon.com/iam/home#/policies/arn%3Aaws%3Aiam%3A%3Aaws%3Apolicy%2Fservice-role%2FAWSLambdaBasicExecutionRole" rel="noopener ugc nofollow" target="_blank">awslambdabasiceexecutionrole</a>策略。</p><p id="d29c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.aws.amazon.com/lex/latest/dg/ex1-sch-appt-create-lambda-function.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/lex/latest/DG/ex1-sch-appt-create-lambda-function . html</a></p><p id="a98e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Lambda基本上是一个web挂钩，我们将它与可以附加的AWS Lex bot联系在一起</p><p id="1a97" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">1.在动态填充用于验证的槽时。</p><p id="f8cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.当所有空位都被填充时/履行阶段</p><p id="1e32" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请参考下面显示如何在验证时附加Lambda的截图。</p><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/332ef894dd4cc1dedc625d0a33573ae4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gtF3QWF6A14u9YuvmB-EDA.png"/></div></div></figure><p id="00f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">履行时附加。</p><figure class="kj kk kl km fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/d929f754054c8611fd383ed4691eaf3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gP1QhcqAd-_GqFzJlckgww.png"/></div></div></figure><p id="ef3c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将整个流程分成几个步骤。</p><ol class=""><li id="98d3" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">验证用户在预订日期中没有输入过去日期的有效数据的时段。此外，在任何槽验证失败的情况下，将使用要正确填充的槽的名称调用excite _ slot方法。</li><li id="cbff" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">在我们的用例中，我们希望显示用户提到的预订日期正在播放的电影列表，理想情况下，这必须是一个API调用。(参考github库时请注意下面的代码)，为了简单起见，有一个硬编码的JSON。我们可以使用请求模块进行api调用。硬编码的JSON存在于github的movielist.py文件中。</li></ol><pre class="kj kk kl km fd ko kp kq kr aw ks bi"><span id="966b" class="kt ku hi kp b fi kv kw l kx ky">[<br/>  {<br/>    'name': 'Mangal Mission',<br/>    'slotDetails': [<br/>      {<br/>        'slots': '9am',<br/>        'price': '500'<br/>      },<br/>      {<br/>        'slots': '1pm',<br/>        'price': '700'<br/>      }<br/>    ]<br/>  },<br/>  {<br/>    'name': 'WAR',<br/>    'slotDetails': [<br/>      {<br/>        'slots': '10pm',<br/>        'price': '400'<br/>      },<br/>      {<br/>        'slots': '12pm',<br/>        'price': '600'<br/>      }<br/>    ]<br/>  }<br/>]</span></pre><ol class=""><li id="a6f1" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">如果选择了电影名称，则从会话属性中找到该电影的可用时段，并要求用户选择该时段，一旦完成，要求用户提供其他详细信息，在成功验证后，将达到完成状态，继续进行预订。</li><li id="ee68" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">使用Lex的会话属性，聊天应该在上下文中包含的内容、选定的日期、选定的电影、时段以及他的个人详细信息。</li></ol><p id="ebcc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">///用于验证的代码段</p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><pre class="kj kk kl km fd ko kp kq kr aw ks bi"><span id="f228" class="kt ku hi kp b fi kv kw l kx ky"># fetch all the slot values<br/>bookingDate = get_slots(intent_request)["bookingDate"]<br/>movieName = get_slots(intent_request)["movieName"]<br/>bookingSlot = get_slots(intent_request)["bookingSlot"]<br/>numbrOfTickets = get_slots(intent_request)['numbrOfTickets']<br/>customername = get_slots(intent_request)['customerName']<br/><br/># validation for booking date not null<br/>if bookingDate is None:<br/>    "-- if the user has not selected any movie --"<br/>    return build_validation_result(False, 'bookingDate', 'PlainText', 'Please specify the date of booking', None)<br/><br/>else:<br/>    # validation for invalid booking date<br/>    if not isvalid_date(bookingDate):<br/>        return build_validation_result(False, 'bookingDate', 'PlainText',<br/>                                       'I did not understand that, what date would you like to book the tickets '<br/>                                       'for?', None)<br/>    elif datetime.datetime.strptime(bookingDate, '%Y-%m-%d').date() &lt; datetime.date.today():<br/>        return build_validation_result(False, 'bookingDate', 'PlainText', 'Booking date cannot be of the past',<br/>                                       None)<br/>"-- fetch movie name by api call/ being fetch from hard coded JSON --"<br/>if movieName is None:<br/>    moviedetailslist = movielist.fetchMovieList();<br/><br/>    movie_lookup = createmovielookupmap(moviedetailslist)<br/>    movienamesonly = []<br/>    for moviedetails in moviedetailslist:<br/>        movienamesonly.append(moviedetails['name'])<br/><br/>    return build_validation_result(False, 'movieName', 'PlainText',<br/>                                   'Please choose from the given movies ' + ','.join(movienamesonly),<br/>                                   json.dumps(movie_lookup))<br/><br/>    # return build_validation_result(False, 'movieName', 'CustomPayload', json.dumps(moviedetailslist),<br/>    # json.dumps(movie_lookup))<br/><br/>if bookingSlot is None:<br/>    "-- if the user has  selected  movie, it should be present in the list of movies which the  user was shown to--"<br/>    if sessionAttributes.get('moviedetails_lookup', None) is None:<br/>        return build_validation_result(False, 'movieName', 'PlainText',<br/>                                       'Please enter movie name from the list only',<br/>                                       None)<br/>    # fetch the slot details based on movie selected<br/>    else:<br/>        slotdetails =[]<br/>        time_slots = []<br/>        moviedetails_lookup = sessionAttributes['moviedetails_lookup']<br/>        """---find the booking slot as per the movie selected----"""<br/>        slotdetails = moviedetails_lookup[movieName]<br/>        for slot in slotdetails:<br/>            time_slots.append(slot['slots'])<br/>        return build_validation_result(False, 'bookingSlot', 'PlainText',<br/>                                       'Please find the slots for the movie' + ','.join(time_slots) + 'Select one',<br/>                                       None)<br/><br/>else:<br/>    if len(bookingSlot) != 5:<br/>        # Not a valid time; use a prompt defined on the build-time model.<br/>        return build_validation_result(False, 'bookingSlot', 'PlainText', 'Not a valid time', None)<br/><br/>    hour, minute = bookingSlot.split(':')<br/>    hour = parse_int(hour)<br/>    minute = parse_int(minute)<br/>    if math.isnan(hour) or math.isnan(minute):<br/>        # Not a valid time; use a prompt defined on the build-time model.<br/>        return build_validation_result(False, 'bookingSlot', 'PlainText', 'Not a valid time', None)<br/><br/>    <br/><br/>if customername is None:<br/>    return build_validation_result(False, 'customerName', 'PlainText', 'Please specify the name against which the '<br/>                                                                       'booking needs to be done', None)<br/><br/>if numbrOfTickets is None:<br/>    return build_validation_result(False, 'numbrOfTickets', 'PlainText', 'Please specify the number of tickets '<br/>                                                                         'required', None)</span></pre><p id="2f7e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">//用于上下文保存的会话变量的代码段</p><p id="628d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，我们简单地创建一个映射，用key作为电影名称，用value作为位置细节和它们的价格。</p><pre class="kj kk kl km fd ko kp kq kr aw ks bi"><span id="78f2" class="kt ku hi kp b fi kv kw l kx ky"># Create a map with movie name as key and slots timing with prices as  values<br/>def createmovielookupmap(movienamesList):<br/>    logger.debug("Creating Category Map {}".format(movienamesList))<br/>    moviesLookup = {}<br/><br/>    for moviename in movienamesList:<br/>        synonyms = moviename['name']<br/>        moviesLookup[synonyms] = moviename['slotDetails']<br/><br/>    logger.debug("Created Category Map:: {}".format(moviesLookup))<br/>    return moviesLookup</span></pre><p id="bf8f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">//根据所选电影找出可用时段的代码段，将会话属性字符串转换为字典，并根据键、电影名称检索时段计时。</p><pre class="kj kk kl km fd ko kp kq kr aw ks bi"><span id="12b3" class="kt ku hi kp b fi kv kw l kx ky">if bookingSlot is None:<br/>        "-- if the user has  selected  movie, it should be present in the list of movies which the  user was shown to--"<br/><br/>        if sessionAttributes.get('moviedetails_lookup', None) is None:<br/>            return build_validation_result(False, 'movieName', 'PlainText',<br/>                                           'Please enter movie name from the list only',<br/>                                           None)<br/>        # fetch the slot details based on movie selected<br/>        else:<br/>            <br/>            time_slots = []<br/>            # convert the session attribute string to dictionary/map<br/>            moviedetails_lookup = eval(sessionAttributes['moviedetails_lookup'])<br/>            <br/>            logger.debug("SELECTED MOVIE :: {}".format(moviedetails_lookup.get(movieName)))<br/>            <br/>            """---find the booking slot as per the movie selected----"""<br/>            for slot in moviedetails_lookup.get(movieName):<br/>            <br/>                time_slots.append(slot['slots'])<br/>            return build_validation_result(False, 'bookingSlot', 'PlainText',<br/>                                           'Please select from  the available slots for the movie ' + ','.join(time_slots),<br/>                                           None)</span></pre><p id="9e37" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">有用的常见例外/提示</strong></p><ol class=""><li id="50f1" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">重试机制。如果Lambda无法成功地向LEX bot发送响应，将会观察到重试。如果您从AWS sdks调用Lex bot，这将在SDK级别设置。</li><li id="5be2" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">如果响应处于错误状态。—请注意，如果你试图像访问字典一样访问字符串，它会给出错误，<strong class="ix hj">【错误】类型错误:字符串索引必须是整数。</strong>这就是为什么，我使用了<strong class="ix hj"> eval </strong>函数将字符串地图转换成字典。</li><li id="da45" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">如果超过响应限制。从Lambda发送回LEX的响应大小是有限的。当超过此限制时，您将看到重试发生。请参考<a class="ae iu" href="https://docs.aws.amazon.com/lambda/latest/dg/limits.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/lambda/latest/dg/limits.html</a></li><li id="4b85" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">如果您的api需要更多时间，请确保在<strong class="ix hj">基本设置</strong>下增加您的超时值。</li><li id="6d5c" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">使用环境变量来外部化api urls和其他值，并使用python OS模块来访问它。</li><li id="18d5" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">如果您使用的是boto3不支持的外部包，使用下面的命令将所有依赖项放在一个文件夹中，并与代码一起压缩。<strong class="ix hj"> pip安装请求-t /path/to/project-dir </strong></li><li id="e9c8" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">要返回一个复杂的JSON，其中有一个使用和显示JSON的客户端，使用下面的代码。如果消息的内容类型是文本，将返回纯文本，自定义有效负载代表复杂的嵌套JSON。</li></ol><pre class="kj kk kl km fd ko kp kq kr aw ks bi"><span id="9a8d" class="kt ku hi kp b fi kv kw l kx ky">return build_validation_result(False, 'movieName', 'CustomPayload', json.dumps(moviedetailslist),json.dumps(movie_lookup))<br/><br/>#the build_validation_result<br/><br/>def build_validation_result(is_valid, violated_slot, content, message_content, sessionAttributes):<br/>    if message_content is None:<br/>        return {<br/>            "isValid": is_valid,<br/>            "violatedSlot": violated_slot,<br/>        }<br/><br/><br/>    return {<br/>        'isValid': is_valid,<br/>        'violatedSlot': violated_slot,<br/>        'message': {'contentType': content, 'content': message_content},<br/>        'sessionAttributes': sessionAttributes<br/>    }</span></pre><p id="4f57" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请找到lambda代码的git hub存储库。<a class="ae iu" href="https://github.com/shuchitaprasad/moviebookinglambda" rel="noopener ugc nofollow" target="_blank">https://github.com/shuchitaprasad/moviebookinglambda</a></p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="02a4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kh">最初发表于</em><a class="ae iu" href="https://www.linkedin.com/pulse/aws-lexchatbot-python-lambda-shuchita-prasad" rel="noopener ugc nofollow" target="_blank">T5【https://www.linkedin.com】</a><em class="kh">。</em></p></div></div>    
</body>
</html>