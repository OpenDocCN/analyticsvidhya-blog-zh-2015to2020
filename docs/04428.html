<html>
<head>
<title>Efficiently Debug Google Cloud Composer PyPi Package Installation Issues</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高效调试Google Cloud Composer PyPi包安装问题</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/fix-pypi-package-installation-issues-on-cloud-composer-6a01d9a85790?source=collection_archive---------4-----------------------#2020-03-19">https://medium.com/analytics-vidhya/fix-pypi-package-installation-issues-on-cloud-composer-6a01d9a85790?source=collection_archive---------4-----------------------#2020-03-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1d27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cloud Composer是Google为Apache Airflow提供的托管服务。它的环境预装了许多软件包，但是版本可能会过期。您可以更新这些软件包并安装您需要的其他软件包。</p><p id="872f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，您可能会在软件包依赖关系中遇到冲突，这会阻止新软件包的更新或安装。此外，Google经常更新新环境下可用的Composer/Airflow图像，因此如果您遇到冲突，您可能需要在每次更新图像版本时解决一组新的冲突。</p><p id="af1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尤其令人痛苦的是，Composer可能需要20-40分钟来应用您的更新并抛出错误，这使得尝试任何解决方案都是一个非常缓慢的过程。</p><p id="75a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面描述了如何在本地重新创建Composer环境中安装的内容，并使用pipenv包管理器来解决相互冲突的依赖关系。这允许快速测试和修改。最后可以将需要的更改上传到Composer。</p><h1 id="5180" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">1.连接到集群工作器并执行pip冻结</h1><p id="8a45" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">从此处采取的步骤<a class="ae kg" href="https://cloud.google.com/composer/docs/how-to/using/installing-python-dependencies#viewing_installed_python_packages" rel="noopener ugc nofollow" target="_blank"/>。从Composer的环境配置选项卡中获取集群和区域。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/7bf4cea06294752991177eb049157fda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X2tVP-MAlP0u55wv.png"/></div></div></figure><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="4523" class="ky je hi ku b fi kz la l lb lc">$ gcloud container clusters get-credentials projects/bought-by-many/zones/europe-west2-c/clusters/europe-west2-test-data-ware-8052197d-gke --zone europe-west2-c</span></pre><p id="ce44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打印出所有名称空间:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="c03f" class="ky je hi ku b fi kz la l lb lc">$ kubectl get pods --all-namespaces</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ld"><img src="../Images/92ccd44f914b85111b623f14df25ac1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zbxuCtN_ApsF2NQw.png"/></div></div></figure><p id="5130" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从名称空间列获取一个<code class="du le lf lg ku b">composer-*</code>行的名称，从名称列获取一个<code class="du le lf lg ku b">airflow-worker-*</code>行的名称。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="ca06" class="ky je hi ku b fi kz la l lb lc">$ kubectl exec -itn composer-1-10-0-airflow-1-10-6-5983e0fe airflow-worker-8d8c49c87-9v7c4 -- /bin/bash</span></pre><p id="d52e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接到一个工人:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="7799" class="ky je hi ku b fi kz la l lb lc">$ kubectl exec -itn composer-1-10-0-airflow-1-10-6-5983e0fe airflow-worker-8d8c49c87-9v7c4 -- /bin/bash</span></pre><p id="f2bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后在连接时打印出要求:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="e7e3" class="ky je hi ku b fi kz la l lb lc">airflow@airflow-worker-8d8c49c87-9v7c4:~$ pip freeze</span></pre><p id="1fff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将输出复制/粘贴到一个名为<code class="du le lf lg ku b">original_req.txt</code>的文本文件中。稍后会用它来比较变化。</p><p id="1f42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在pip冻结输出中，我得到了以下几行</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="c5dc" class="ky je hi ku b fi kz la l lb lc"># Editable install with no version control (apache-airflow===1.10.6-composer)<!-- --> <br/>-e /usr/local/lib/airflow</span></pre><p id="f764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并手动将其更改为:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="5ad3" class="ky je hi ku b fi kz la l lb lc">apache-airflow==1.10.6<!-- --> </span></pre><h1 id="ad29" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">2.创建新的pipenv环境</h1><p id="b85e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">将<code class="du le lf lg ku b">original_req.txt</code>文件放入一个新文件夹，并使用</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="5551" class="ky je hi ku b fi kz la l lb lc">$ pipenv install -r path/to/requirements.txt<!-- --> </span></pre><h1 id="c14b" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">3.添加您的包并解决冲突</h1><p id="6b22" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在pip文件中添加您需要的额外的包，并更新需要它的预安装包的版本号。</p><p id="f15b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里使用<code class="du le lf lg ku b">my-package= “*”</code>或<code class="du le lf lg ku b">my-package= “&gt;=1.2.0”</code>有助于更容易地解决冲突。</p><p id="c2e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">试试<code class="du le lf lg ku b">pipenv lock</code>。如果标记了冲突，如下例所示，请记下导致问题的包。<code class="du le lf lg ku b">grpc-google-iam-v1</code>在下面的案例中。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="99eb" class="ky je hi ku b fi kz la l lb lc">...<br/>[pipenv.exceptions.ResolutionFailure]: Warning: Your dependencies could not be resolved. You likely have a mismatch in your sub-dependencies.</span><span id="f826" class="ky je hi ku b fi lh la l lb lc">First try clearing your dependency cache with $ pipenv lock --clear, then try the original command again.</span><span id="d284" class="ky je hi ku b fi lh la l lb lc">Alternatively, you can use $ pipenv install --skip-lock to bypass this mechanism, then run $ pipenv graph to inspect the situation.</span><span id="0ebe" class="ky je hi ku b fi lh la l lb lc">Hint: try $ pipenv lock --pre if it is a pre-release dependency.</span><span id="0cea" class="ky je hi ku b fi lh la l lb lc">ERROR: ERROR: Could not find a version that matches <strong class="ku hj">grpc-google-iam-v1</strong>&lt;0.12dev,&lt;0.13dev,&gt;=0.11.4,&gt;=0.12.3</span><span id="46d2" class="ky je hi ku b fi lh la l lb lc">Tried: 0.9.0, 0.10.0, 0.10.1, 0.11.1, 0.11.3, 0.11.4, 0.12.0, 0.12.1, 0.12.2, 0.12.3<!-- --> </span><span id="11bb" class="ky je hi ku b fi lh la l lb lc">...</span></pre><p id="f6c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du le lf lg ku b">pipenv install —-skip-lock</code>允许软件包被安装。</p><p id="99c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后使用<code class="du le lf lg ku b">pipenv graph &gt; graph.txt</code>输出依赖列表。</p><p id="dfd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du le lf lg ku b">graph.txt</code>文件中搜索发布包(例如<code class="du le lf lg ku b">grpc-google-iam-v1</code>)。寻找使用它的包，这些包具有导致冲突的依赖关系。</p><p id="0cc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于那些包，在pipfile中更新它们的版本或者把它改成<code class="du le lf lg ku b">xyz = “*”</code>。</p><p id="0868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次尝试<code class="du le lf lg ku b">pipenv lock</code>并重复该过程。最终，pipenv安装应该没有错误。</p><h1 id="0ad9" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">4.创建一个requirements.txt，包含所有已更改的和附加的包</h1><p id="c3d7" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">用<code class="du le lf lg ku b">pipenv run pip freeze &gt; new_req.txt</code>输出新的需求。</p><p id="1364" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将其与<code class="du le lf lg ku b">original_req.txt</code>文件进行比较，并将所有更改的行放入一个新的<code class="du le lf lg ku b">diffed.txt</code>文件。下面的bash命令会自动完成这项工作。命令的<code class="du le lf lg ku b">tr</code>部分使所有内容都变成小写，因为这是上传列表到Composer时需要的。</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="0f22" class="ky je hi ku b fi kz la l lb lc">$ diff original_req.txt new_req.txt | grep "&gt;" | cut -c 3- | tr A-Z a-z &gt; diffed.txt</span></pre><p id="b093" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些修改可以上传到Composer:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="e8af" class="ky je hi ku b fi kz la l lb lc"><em class="li">gcloud </em>composer environments update test-data-warehouse-bought-by-many \<br/>  --update-pypi-packages-from-file=diffed.txt \<br/>  --location=europe-west2 \<br/>  --async</span></pre></div></div>    
</body>
</html>