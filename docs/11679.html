<html>
<head>
<title>Automate Neo4j Database Construction with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python自动构建Neo4j数据库</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automate-neo4j-database-construction-with-python-d9c1ada7413e?source=collection_archive---------4-----------------------#2020-12-14">https://medium.com/analytics-vidhya/automate-neo4j-database-construction-with-python-d9c1ada7413e?source=collection_archive---------4-----------------------#2020-12-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d41e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">详细介绍如何通过Python脚本导入数据和创建图形数据库的教程。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/96b53937c9221714363d58b7ca9dbf20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sX35n3pZFZbwvIhg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">由<a class="ae jn" href="https://unsplash.com/@cgower?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯托弗·高尔</a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="ef78" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我最近的一个项目涉及在Neo4j中创建一个<strong class="jq hj">大规模</strong>(超过一百万个节点和关系)图形数据库。当有那么多要处理的时候，拥有一个自动化的脚本就成了关键。这篇文章概述了我给处于类似情况的人的一些建议。</p><p id="34e8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">代码链接贯穿始终，请评论任何额外的提示！</p><h1 id="66f6" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">先决条件</h1><ol class=""><li id="6a24" class="lc ld hi jq b jr le ju lf jx lg kb lh kf li kj lj lk ll lm bi translated">需要安装Python(最好是2.7或更高版本)</li><li id="68df" class="lc ld hi jq b jr ln ju lo jx lp kb lq kf lr kj lj lk ll lm bi translated">应该创建Neo4j数据库，并设置所需的任何插件或设置<br/>(我使用APOC和GDSL插件，并将最大堆大小增加到3GB)</li><li id="26ff" class="lc ld hi jq b jr ln ju lo jx lp kb lq kf lr kj lj lk ll lm bi translated">Cypher查询将按照您的意愿构建数据库</li></ol><h1 id="1f61" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">设置:Python目录和虚拟环境</h1><ol class=""><li id="193d" class="lc ld hi jq b jr le ju lf jx lg kb lh kf li kj lj lk ll lm bi translated">导航到图表的目录。我Mac上的目录看起来像<code class="du ls lt lu lv b">/Library/Application Support/Neo4j Desktop/Application/neo4jDatabases/database-asdfjkl-1234-etc/installation-4.1.1/</code>。我把它钉在我的边栏上以便于访问。</li><li id="c12f" class="lc ld hi jq b jr ln ju lo jx lp kb lq kf lr kj lj lk ll lm bi translated">在<code class="du ls lt lu lv b">installation</code>目录中创建一个<code class="du ls lt lu lv b">python</code>目录。</li><li id="0200" class="lc ld hi jq b jr ln ju lo jx lp kb lq kf lr kj lj lk ll lm bi translated">可选:在<code class="du ls lt lu lv b">python</code>目录中，创建一个虚拟环境。我真的很喜欢使用venv，因为我可以很容易地与队友或其他项目分别共享或转移所有必需的包的<code class="du ls lt lu lv b">requirements.txt</code>。<a class="ae jn" href="https://docs.python-guide.org/dev/virtualenvs/" rel="noopener ugc nofollow" target="_blank">该资源</a>帮助我在Mac和PC上成功设置了虚拟环境。</li><li id="250b" class="lc ld hi jq b jr ln ju lo jx lp kb lq kf lr kj lj lk ll lm bi translated">一旦创建了虚拟环境，就可以通过<code class="du ls lt lu lv b">pip</code>安装<code class="du ls lt lu lv b">py2neo</code>包。</li><li id="43f7" class="lc ld hi jq b jr ln ju lo jx lp kb lq kf lr kj lj lk ll lm bi translated">如果您的Cypher查询从任何文件导入数据，请将这些文件放在<code class="du ls lt lu lv b">import</code>目录中(应该在同一个<code class="du ls lt lu lv b">installation</code>目录中)。</li></ol></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="a300" class="kk kl hi bd km kn md kp kq kr me kt ku io mf ip kw ir mg is ky iu mh iv la lb bi translated">编码时间</h1><p id="ffa0" class="pw-post-body-paragraph jo jp hi jq b jr le ij jt ju lf im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated"><em class="ml">注意:这个项目的完整代码在下面的存储库中，所以你可以参考下面的gists的上下文或者检查我正在导入的数据。</em></p><div class="mm mn ez fb mo mp"><a href="https://github.com/mgipson/Text-Similarity" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab dw"><div class="mr ab ms cl cj mt"><h2 class="bd hj fi z dy mu ea eb mv ed ef hh bi translated">mgi pson/文本相似性</h2><div class="mw l"><h3 class="bd b fi z dy mu ea eb mv ed ef dx translated">GitHub是超过5000万开发人员的家园，他们一起工作来托管和审查代码、管理项目和构建…</h3></div><div class="mx l"><p class="bd b fp z dy mu ea eb mv ed ef dx translated">github.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd jh mp"/></div></div></a></div><h2 id="f154" class="ne kl hi bd km nf ng nh kq ni nj nk ku jx nl nm kw kb nn no ky kf np nq la nr bi translated">脚本框架</h2><p id="0c19" class="pw-post-body-paragraph jo jp hi jq b jr le ij jt ju lf im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated">我们导入数据或构建节点和关系的主要Python脚本将存在于这个方便的Python文件夹和虚拟环境中。</p><p id="e4b2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这个代码块做了最少的工作:<br/> 1。导入<code class="du ls lt lu lv b">py2neo</code> <br/> 2。建立数据库连接<br/> 3。运行单个查询</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="ns nt l"/></div></figure><p id="f5c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">使用<a class="ae jn" href="https://py2neo.org/2020.1/" rel="noopener ugc nofollow" target="_blank"> Py2Neo </a>，您可以按原样运行Cypher查询，或者使用Py2Neo函数来执行类似的操作。我的个人偏好是按原样运行Cypher查询，因为我可以简单地在Neo4j浏览器中复制和粘贴代码。</p><p id="1d61" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您想要一些超级简单的东西，您可以用您不同的查询重复<code class="du ls lt lu lv b">graph.run()</code>调用，它将完成工作。然而，我在开发自己的脚本时发现了一些非常有用的东西；如果你想知道这些对你是否有用，请继续阅读。</p><h2 id="9306" class="ne kl hi bd km nf ng nh kq ni nj nk ku jx nl nm kw kb nn no ky kf np nq la nr bi translated">批处理和自动提交</h2><p id="a0ae" class="pw-post-body-paragraph jo jp hi jq b jr le ij jt ju lf im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated">我利用了<a class="ae jn" href="https://neo4j.com/labs/apoc/4.1/graph-updates/periodic-execution/" rel="noopener ugc nofollow" target="_blank">定期提交(也称为批处理</a>)，因为我的大型查询经常遇到内存问题。</p><p id="3ce9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您确实在批处理中运行，您将希望使用一个开放的事务(通过下面代码中的<code class="du ls lt lu lv b">begin(), run(), commit()</code>序列完成)而不是一个关闭的事务(独立的<code class="du ls lt lu lv b">run()</code>调用)。<br/>这是因为关闭的事务会自动提交，这意味着如果您使用批处理和关闭的事务，它将执行并提交您的第一个批处理，但不会继续执行其他批处理。肯定不是我们想要的。</p><pre class="iy iz ja jb fd nu lv nv nw aw nx bi"><span id="edb9" class="ne kl hi lv b fi ny nz l oa ob">#Without Periodic Commits</span><span id="3c58" class="ne kl hi lv b fi oc nz l oa ob">graph.run("""LOAD CSV WITH HEADERS<br/>FROM 'file:///womeninstem.csv' AS line<br/>MERGE (person:Person { name: line.personLabel })<br/>ON CREATE SET person.birth = line.birthdate, person.death = line.deathdate""")</span><span id="058e" class="ne kl hi lv b fi oc nz l oa ob">#With Periodic Commits</span><span id="be4c" class="ne kl hi lv b fi oc nz l oa ob">query_list = []</span><span id="8b45" class="ne kl hi lv b fi oc nz l oa ob">query_list.append("""CALL apoc.periodic.iterate("<br/>LOAD CSV WITH HEADERS<br/>FROM 'file:///womeninstem.csv' AS line<br/>RETURN line<br/>","<br/>MERGE (person:Person { name: line.personLabel })<br/>ON CREATE SET person.birth = line.birthdate, person.death = line.deathdate", {batchSize:1000, parallel:false, retries: 10}) YIELD operations""")</span><span id="8ade" class="ne kl hi lv b fi oc nz l oa ob">#would have more queries in query_list</span><span id="eaa1" class="ne kl hi lv b fi oc nz l oa ob">for query in query_list:        <br/>   g = graph.begin() # open transaction        <br/>   result = g.run(query).to_data_frame() # execute query<br/>   g.commit() # close transaction</span></pre><h2 id="8e38" class="ne kl hi bd km nf ng nh kq ni nj nk ku jx nl nm kw kb nn no ky kf np nq la nr bi translated">查询失败警报</h2><p id="7e1e" class="pw-post-body-paragraph jo jp hi jq b jr le ij jt ju lf im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated">通过Python代码而不是在浏览器中运行Cypher查询的问题是，它并不总是告诉您查询是否失败——它会提醒您语法错误，但仅此而已。</p><p id="7682" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因此，如果一个查询没有完全完成，实现一些提示是很重要的。</p><pre class="iy iz ja jb fd nu lv nv nw aw nx bi"><span id="e8d3" class="ne kl hi lv b fi ny nz l oa ob">query_list = []</span><span id="b365" class="ne kl hi lv b fi oc nz l oa ob">query_list.append("""CALL apoc.periodic.iterate("<br/>LOAD CSV WITH HEADERS<br/>FROM 'file:///womeninstem.csv' AS line<br/>RETURN line<br/>","<br/>MERGE (person:Person { name: line.personLabel })<br/>ON CREATE SET person.birth = line.birthdate, person.death = line.deathdate", {batchSize:1000, parallel:false, retries: 10}) YIELD operations""")</span><span id="6fa6" class="ne kl hi lv b fi oc nz l oa ob">#would have more queries in query_list</span><span id="8ae7" class="ne kl hi lv b fi oc nz l oa ob">for query in query_list:        <br/>   g = graph.begin() # open transaction        <br/>   result = g.run(query).to_data_frame() # execute query<br/>   try:            <br/>      if result['operations'][0]['failed'] &gt; 0: #means batch failed<br/>         print('Could not finish query')<br/>      else: #means batch succeeded                <br/>         g.commit() # close transaction<br/>         print('Completed query ')<br/>   except Exception as e: #means there's a syntax or other error         <br/>      g.commit() # close transaction  <br/>      print('Completed query')</span></pre><h2 id="6889" class="ne kl hi bd km nf ng nh kq ni nj nk ku jx nl nm kw kb nn no ky kf np nq la nr bi translated">参数化查询</h2><p id="6e39" class="pw-post-body-paragraph jo jp hi jq b jr le ij jt ju lf im jw jx mi jz ka kb mj kd ke kf mk kh ki kj hb bi translated">我就此写了一篇单独的短文——长话短说，您可以在Cypher查询的末尾添加简单的<code class="du ls lt lu lv b">.format()</code>替换。</p><div class="mm mn ez fb mo mp"><a href="https://madisongipson.medium.com/running-a-cypher-query-with-parameters-through-a-python-script-f0089e245b4d" rel="noopener follow" target="_blank"><div class="mq ab dw"><div class="mr ab ms cl cj mt"><h2 class="bd hj fi z dy mu ea eb mv ed ef hh bi translated">通过Python脚本运行带参数的密码查询</h2><div class="mw l"><h3 class="bd b fi z dy mu ea eb mv ed ef dx translated">教程详细介绍了如何使用Python库“Py2Neo”来动态参数化和执行Cypher查询。</h3></div><div class="mx l"><p class="bd b fp z dy mu ea eb mv ed ef dx translated">madisongipson.medium.com</p></div></div><div class="my l"><div class="od l na nb nc my nd jh mp"/></div></div></a></div></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="1f17" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我还没有写这些，但是我有一些构建Neo4j数据库的技巧(并行查询、显示脚本进度的简单GUI等)。);然而，他们应该有自己的文章，我还没有写那些。我计划一旦我做了，就把它们链接到这里！</p><p id="29a9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您想查看从中提取的更大的项目，请查看这个资源库。</p><div class="mm mn ez fb mo mp"><a href="https://github.com/mgipson/Text-Similarity" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab dw"><div class="mr ab ms cl cj mt"><h2 class="bd hj fi z dy mu ea eb mv ed ef hh bi translated">mgi pson/文本相似性</h2><div class="mw l"><h3 class="bd b fi z dy mu ea eb mv ed ef dx translated">GitHub是超过5000万开发人员的家园，他们一起工作来托管和审查代码、管理项目和构建…</h3></div><div class="mx l"><p class="bd b fp z dy mu ea eb mv ed ef dx translated">github.com</p></div></div><div class="my l"><div class="oe l na nb nc my nd jh mp"/></div></div></a></div></div></div>    
</body>
</html>