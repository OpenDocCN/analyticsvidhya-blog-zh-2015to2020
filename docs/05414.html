<html>
<head>
<title>Building data pipelines with airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用气流构建数据管道</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/building-data-pipelines-with-airflow-15537730063c?source=collection_archive---------7-----------------------#2020-04-20">https://medium.com/analytics-vidhya/building-data-pipelines-with-airflow-15537730063c?source=collection_archive---------7-----------------------#2020-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f875642335d35fe5ecd87fb39ea336da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iPF_70zBWvdhV_G5Ft41Wg.png"/></div></div></figure><p id="4782" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">嘿大家，这是一个相当长的时间张贴。这是一个由airbnb开发并由apache org授权的美妙的工作流程编排工具。Airflow主要用于创建、调度和监控数据工作流。</p><h2 id="c2a1" class="jo jp hi bd jq jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki bi translated">它是如何工作的？</h2><p id="b4fd" class="pw-post-body-paragraph iq ir hi is b it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj kn jl jm jn hb bi translated">如前所述，它让您创作代码，从而支持版本控制和可维护性。工作流的基本构件被称为任务，任务的集合被称为DAG(有向无环图)。</p><p id="175c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">DAG只不过是一个python脚本，由多个具有依赖性的任务组成。任务只不过是一个可执行的操作符。这已经根据任务的性质进行了分类。下面是一些常见的运营商目前在气流做我们的任务。您可以在他们的文档中找到更多关于他们的信息。</p><p id="472c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">核心组件:</strong></p><ol class=""><li id="3185" class="ko kp hi is b it iu ix iy jb kq jf kr jj ks jn kt ku kv kw bi translated">Bash操作符(执行bash操作符)</li><li id="d2ed" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">Python运算符(调用python函数)</li><li id="fe02" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">电子邮件操作员(发送电子邮件通知)</li><li id="0e3d" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">http操作员(发送http请求)</li><li id="80fc" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">mysql运算符、postgres运算符、mssql运算符等。，(执行sql命令)</li><li id="1637" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">除了这些我们还有docker操作符，hive操作符等等。</li></ol><p id="1442" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">气流的核心构件:</p><ol class=""><li id="d92f" class="ko kp hi is b it iu ix iy jb kq jf kr jj ks jn kt ku kv kw bi translated">达格的</li><li id="6ed5" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">DAG运行</li><li id="9cba" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">操作员</li><li id="af22" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">工作</li><li id="746c" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">任务实例</li><li id="2a60" class="ko kp hi is b it kx ix ky jb kz jf la jj lb jn kt ku kv kw bi translated">执行日期。</li></ol><p id="a4a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为我们对气流这个术语有点熟悉。让我们从一些实用的编码开始。理解上述术语所需要的一切。由于我最近在azure平台上工作，我想用它来帮助我们完成这个例子。我将建立一个简单的数据管道，将数据从您的服务器移动到azure blob存储。如果你使用的是linux系统，这很好，但是在这篇文章中，我将在windows上构建它。</p><p id="8a04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">安装前应遵循的步骤:</strong></p><p id="a045" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要从windows应用商店安装ubuntu应用程序，因此在此之前，请转到控制面板|程序和功能|打开或关闭Windows功能为Linux启用Windows子系统。现在从windows商店安装ubuntu。</p><p id="9cf5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">安装步骤:</strong></p><p id="a4c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤1: </strong>安装并更新PIP</p><p id="fd52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">sudo apt-get安装软件-属性-通用</p><p id="b5f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">sudo apt-add-repository宇宙</p><p id="fb83" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">sudo apt-get更新</p><p id="64f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">apt-get安装python-pip</p><p id="0f11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤2: </strong> pip安装apache-airflow</p><p id="9f16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第三步:</strong>导出AIRFLOW_HOME=~/airflow</p><p id="f886" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤4: </strong>初始化数据库</p><p id="bcff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">气流initdb</p><p id="9b97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤5: </strong>启动airflow web服务器</p><p id="deb5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">气流网络服务器-p 8080</p><p id="70d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您的本地主机URL已准备好查看airflow主页，在那里您可以找到所有示例DAG。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/c1f07e2defdc096c391f1adaee31ff80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6NnnPvchRzgiO9s_Ha154Q.jpeg"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">气流-主页</figcaption></figure><p id="c3bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您的气流已经启动并运行。让我们创建一个DAG。已经用配置文件创建了一个airflow文件夹，导航到该文件夹，并在运行上述命令的位置创建一个名为dags的文件夹，这是我们保存所有脚本的位置。</p><p id="8b9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">例如:</strong></p><p id="dbfb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Azure blob集成在wasb连接的帮助下发生。有关wasb的详细说明可在气流文件中找到。这是开始前的关键一步。</p><p id="2a96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">需要的详细信息:</strong>创建wasb连接的blob名称和密钥。</p><p id="f426" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航到管理→连接，创建一个类型为wasb的新连接。</p><p id="014e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">登录:blob名称</p><p id="e0a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">密码:密钥</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/b9ddd7f7f8facfa84db560ad52b9dcb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hqbKkiXfV7mdDzhyKRjY2A.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">连接页面</figcaption></figure><p id="34a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦完成，让我们编码。</p><pre class="ld le lf lg fd lm ln lo lp aw lq bi"><span id="77a6" class="jo jp hi ln b fi lr ls l lt lu">from airflow import DAG<br/>from airflow.operators.bash_operator import BashOperator<br/>from airflow.operators.python_operator import PythonOperator<br/>from airflow.contrib.hooks.wasb_hook import WasbHook</span><span id="ed37" class="jo jp hi ln b fi lv ls l lt lu">wb = WasbHook(wasb_conn_id=’azure_blob’)<br/>container_name = “inputdata”<br/>blob_name = “xxxxx.csv”<br/>file_path =”/home/xxx/xxxx.csv”</span><span id="309b" class="jo jp hi ln b fi lv ls l lt lu">def check_connection():<br/> return(wb.check_for_blob(container_name,blob_name))</span><span id="96c7" class="jo jp hi ln b fi lv ls l lt lu">def file_upload():<br/> wb.load_file(file_path,container_name,blob_name)<br/> return(“Blob uploaded sucessfully”)</span><span id="fc50" class="jo jp hi ln b fi lv ls l lt lu">def respond():<br/> return ‘Task ended’</span><span id="da27" class="jo jp hi ln b fi lv ls l lt lu">default_args = {<br/> ‘owner’: ‘airflow’,<br/> ‘start_date’: dt.datetime(2018, 9, 24, 10, 00, 00),<br/> ‘concurrency’: 1,<br/> ‘retries’: 0<br/>}</span><span id="65d1" class="jo jp hi ln b fi lv ls l lt lu">with DAG(‘airflow_file_uploader’,<br/> catchup=False,<br/> default_args=default_args,<br/> schedule_interval=’*/10 * * * *’,<br/> # schedule_interval=None,<br/> ) as dag:<br/> opr_hello = BashOperator(task_id=’Start_operation’,<br/> bash_command=’echo “Staring operation”’)</span><span id="4eb4" class="jo jp hi ln b fi lv ls l lt lu">check_connection_opr = PythonOperator(task_id=’connection’,<br/> python_callable=check_connection)<br/> file_upload_opr = PythonOperator(task_id=’file_uploader’,<br/> python_callable=file_upload)</span><span id="b2c2" class="jo jp hi ln b fi lv ls l lt lu">opr_respond = PythonOperator(task_id=’task_end’,<br/> python_callable=respond)</span><span id="148e" class="jo jp hi ln b fi lv ls l lt lu">opr_hello &gt;&gt; check_connection_opr &gt;&gt; file_upload_opr &gt;&gt; opr_respond</span></pre><p id="296d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，第一个操作符检查给定的blob是否存在，第二个操作符将文件从本地驱动器上传到blob存储器，第三个操作符标记任务结束。下面的部分定义了一些基本的配置，你可以根据自己的需要来做。<strong class="is hj">的拥有者</strong>应该总是气流，<strong class="is hj">的开始日期</strong>你可以定义。<strong class="is hj">并发</strong>和<strong class="is hj">重试</strong>将在高级侧。让我们暂时把它放在一边，保持原样。</p><p id="1464" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在with DAG路径中写入python脚本文件的名称，您可以根据需要定义计划间隔。</p><pre class="ld le lf lg fd lm ln lo lp aw lq bi"><span id="af0e" class="jo jp hi ln b fi lr ls l lt lu">default_args = {<br/> ‘owner’: ‘airflow’,<br/> ‘start_date’: dt.datetime(2018, 9, 24, 10, 00, 00),<br/> ‘concurrency’: 1,<br/> ‘retries’: 0<br/>}</span><span id="43ef" class="jo jp hi ln b fi lv ls l lt lu">with DAG(‘airflow_file_uploader’,<br/> catchup=False,<br/> default_args=default_args,<br/> schedule_interval=’*/10 * * * *’,<br/> # schedule_interval=None,<br/> ) as dag:</span></pre><p id="8758" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">哇哦..让我们运行它看看。保存文件并转到airflow的主页。启动您的计划程序。</p><pre class="ld le lf lg fd lm ln lo lp aw lq bi"><span id="5814" class="jo jp hi ln b fi lr ls l lt lu">airflow scheduler</span></pre><p id="f15b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您将能够在dag列表中看到您的脚本。打开脚本。它将开始运行。绿色边框表示成功，这样你可以用颜色来标识你的工作状态。一旦完成，所有将变成绿色。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/4c9efdb7b274c7d72a8234d881d4d7ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O0T2aPA6RxEC916ehMrpbA.png"/></div></div></figure><p id="36ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">剩下的我就交给你们了，你们可以进一步探索，并定制任务。您可以连接到它的aws和服务列表。确保在开始使用管道之前创建或编辑连接。就这样，伙计们。很快就能看到大家的新帖子了。</p><p id="ab90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谢了。</p></div></div>    
</body>
</html>