<html>
<head>
<title>lambda inside VPC with internet access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">lambda位于VPC，可接入互联网</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/vpc-lambda-internet-access-f70a55dc7a39?source=collection_archive---------14-----------------------#2019-12-24">https://medium.com/analytics-vidhya/vpc-lambda-internet-access-f70a55dc7a39?source=collection_archive---------14-----------------------#2019-12-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/72566773874948e16ca3d6418e7ca14c.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*zZ5t7dRYYMN1GyzEzUICKw.png"/></div></figure><p id="418a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行lambda函数，执行简单而简短的任务，受欢迎程度不断增长。</p><p id="ed3f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">无需供应或管理服务器，运行简单的单任务应用程序，已经证明非常有用。</p><p id="d7ae" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">正确使用AWS lambda函数可以成为执行小型、临时任务的服务的一种经济高效、易于管理且方便的替代方式。</p><p id="7bde" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">作为一个例子，我将解决一个微服务，轮询SQS队列或订阅SNS主题，对每条消息或通知进行数据库查询，处理结果并通过第三方提供商发送SMS通知。</p><p id="30c4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">到目前为止，这是一个非常简单的任务。这就是事情变得棘手的地方。</p><h1 id="2dbe" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">为什么？</h1><p id="7793" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">AWS RDS实例在VPC内部启动。通常，组织会阻止对其数据库的所有公共访问，并在没有公共访问点的VPC内管理它们。在上面的例子中，我们可以得出结论，除了RDS实例之外，我们的lambda函数也需要访问互联网。</p><h1 id="9d2d" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">那么，问题出在哪里呢？</h1><p id="8a52" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">研究AWS ENI文档会发现，lambda要访问VPC内部的资源，它需要一个弹性网络接口(ENI)。分配给λ函数的ENI仅与私有IP地址相关联。因此，lambda函数没有互联网连接，每个公共HTTP调用都会导致超时。</p><p id="25b5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于限制、性能和可伸缩性问题，在VPC中包含lambda是好是坏还有很多争议。我写这篇教程只是因为当我需要解决这个问题时，作为将微服务迁移到无服务器应用的任务的一部分，在线上没有例子、有效的文档或解决方案。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/dd47d7b3db3df1d2b83b2cf2f0a89ce2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*2TM6AMzU3CLxzPRnjN_yjA.png"/></div></figure><h1 id="e57e" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">解决方案</h1><p id="dd63" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">必须条件:</p><ul class=""><li id="b0aa" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj kx ky kz la bi translated"><strong class="io hj">RDS实例必须在帐户的默认VPC中启动。</strong></li><li id="3baf" class="ks kt hi io b ip lb it lc ix ld jb le jf lf jj kx ky kz la bi translated"><strong class="io hj">必须创建一个新的默认子网。</strong></li><li id="1047" class="ks kt hi io b ip lb it lc ix ld jb le jf lf jj kx ky kz la bi translated"><strong class="io hj">一个公共子网和一个私有子网。</strong></li></ul><p id="c168" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">实现</strong>:</p><ul class=""><li id="3395" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj kx ky kz la bi translated"><strong class="io hj">创建新的公共子网:<br/> </strong>公共子网必须包含一个路由表，其中至少包含一个公共互联网网关:</li></ul><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/382bc278550b4d914663dc63d1c2cb33.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/1*eKchE_YuFUqWrV_vuL8ncg.jpeg"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">公共子网</figcaption></figure><ul class=""><li id="7f17" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj kx ky kz la bi translated"><strong class="io hj">创建新的私有子网:<br/> </strong>私有子网必须包含一个路由表，其中至少包含一个NAT实例。</li></ul><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es ll"><img src="../Images/6744568d1c0cc0345cd88c060f6b26f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*qmourUU_grNQMClCcND7Zw.jpeg"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">私有子网</figcaption></figure><ul class=""><li id="f77b" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj kx ky kz la bi translated"><strong class="io hj">创建新的默认子网:</strong> <br/>新的默认子网不应分配给任何实例或服务。<br/>应该将两条路由添加到其路由表中，一条到internet网关，一条到NAT实例。两个目标都应该在0.0.0.0上。我们不能将两个目的地分配给0.0.0.0/0，因此我们将0.0.0.0/0分配给IGW，0.0.0.0/x分配给NAT实例。</li></ul><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es ll"><img src="../Images/79d59e614c25fce6b5385f35578d1f19.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*54LLjgDkUFKjoEvA2USAhw.jpeg"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">新默认子网</figcaption></figure><p id="b73c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">通过CLI创建新的默认子网</p><pre class="ko kp kq kr fd lm ln lo lp aw lq bi"><span id="2dfc" class="lr jl hi ln b fi ls lt l lu lv">aws ec2 create-default-subnet —-availability-zone &lt;availablity zone&gt;</span></pre><ul class=""><li id="0876" class="ks kt hi io b ip iq it iu ix ku jb kv jf kw jj kx ky kz la bi translated"><strong class="io hj">配置lambda函数:<br/> </strong>完成所有这些第一步后，最后一步是将lambda函数分配给默认的VPC id，该id包含我们的私有和公共子网以及出站规则为0.0.0.0的安全组。<br/>请注意，尽管AWS最佳实践指导我们使用at list两个子网，但只将私有子网分配给lambda函数就足够了，它可以访问互联网。请注意，只分配公共网络是行不通的。</li></ul><h1 id="cb59" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">总之:</h1><p id="129e" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">正如我们所见，在可以访问互联网的VPC中使用lambda函数并不简单。AWS要求我们，作为开发人员，不时地要有灵活性和创造性。如果这是你所面临的问题，我建议的解决方案会帮你解决。</p><p id="a5ea" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一般的无服务器架构，特别是lambda函数的使用。最近变得超级流行，非常推荐使用。</p><p id="497a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我接下来的故事将继续关注AWS服务和一些常见问题，并提出一些重要的解决方案。</p><p id="4e51" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">敬请期待:)…</p></div></div>    
</body>
</html>