# ä½¿ç”¨ Numpy çš„å·ç§¯ç¥ç»ç½‘ç»œ

> åŸæ–‡ï¼š<https://medium.com/analytics-vidhya/convolutional-neural-networks-using-numpy-part-1-f4f8ab26cccb?source=collection_archive---------5----------------------->

## ç¬¬ 1 éƒ¨åˆ†:åœ¨ä¸¤ç±»æ—¶å°š MNIST å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸Šä½¿ç”¨å•å±‚å·ç§¯æ»¤æ³¢å™¨å’Œå•ä¸ªå¯†é›†å±‚

![](img/747283f81b1f312d6f9ac129a47cea16.png)

åœ¨ [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) ä¸Šç”± [Franck V.](https://unsplash.com/@franckinjapan?utm_source=medium&utm_medium=referral) æ‹æ‘„çš„ç…§ç‰‡

æœ‰è®¸å¤šå¼ºå¤§çš„å·¥å…·ï¼Œå¦‚ Keras å’Œ Tensorflowï¼Œå¯ä»¥ç”¨æ¥åˆ¶ä½œå·ç§¯ç¥ç»ç½‘ç»œ(CNN)ã€‚ç„¶è€Œï¼Œé™¤éæˆ‘å·²ç»æ‰“å¼€äº†å¼•æ“ç›–ï¼Œå·çœ‹äº†é‡Œé¢ï¼Œæˆ‘å¹¶ä¸çœŸæ­£æ»¡æ„æˆ‘çŸ¥é“ä¸€äº›äº‹æƒ…ã€‚å¦‚æœæ‚¨å’Œæˆ‘ä¸€æ ·ï¼Œè¯·ç»§ç»­é˜…è¯»ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Numpy(å’Œ Scipy)ä»å¤´æ„å»º CNNã€‚

*è¿™ä¸ªå¸–å­çš„ä»£ç åœ¨æˆ‘çš„* [*èµ„æºåº“*](https://github.com/borundev/DNN_Lectures) *é‡Œæœ‰ã€‚*

æˆ‘å°†è¿™ç¯‡æ–‡ç« åˆ†æˆå¤šä¸ªéƒ¨åˆ†ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘å·²ç»è®¡åˆ’äº†ä¸¤ä¸ªéƒ¨åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘å°†åªåšä¸€ä¸ªå…³äºæ—¶å°š MNIST çš„ä¸¤ç±»åˆ†ç±»é—®é¢˜ï¼Œä»…é™äºä¸¤ç±»ã€‚å›¾åƒæ˜¯å•è‰²çš„ï¼ŒCNN å°†åªæœ‰ä¸€ä¸ªå·ç§¯æ»¤æ³¢å™¨ï¼Œåé¢æ˜¯ä¸€ä¸ªè‡´å¯†å±‚ã€‚è¿™ç§ç®€å•æ€§å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸“æ³¨äºå·ç§¯çš„ç»†èŠ‚ï¼Œè€Œä¸å¿…æ‹…å¿ƒé™„å¸¦çš„å¤æ‚æ€§ã€‚åœ¨ç¬¬äºŒç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å¤„ç†å®Œæ•´çš„æ—¶å°š MNIST æ•°æ®é›†(10 ç±»)å’Œå¤šé‡å·ç§¯æ»¤æ³¢å™¨ã€‚æˆ‘è¿˜å°†æŸ¥çœ‹ CIFAR-10 æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†åŒ…å« 10 ç±»å½©è‰²å›¾åƒã€‚æˆ‘å¯èƒ½ä¼šåœ¨ç¬¬ä¸‰ç¯‡æ–‡ç« ä¸­å¼ºè°ƒä¸€äº›å…³äºå·ç§¯çš„å…¶ä»–æ–¹é¢ã€‚

è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯æ€§çš„èŒä½ï¼Œå¹¶ä¸”å‡å®šä½ å¯¹ä»£æ•°å’Œå¾®ç§¯åˆ†æœ‰ä¸€å®šçš„äº†è§£ã€‚è™½ç„¶æˆ‘çŸ¥é“ä¸€ä¸ªä¸æ‡‚é«˜ç­‰æ•°å­¦çš„äººå¯ä»¥ç”¨ tensorflow åšå¾ˆå¤šäº‹æƒ…ï¼Œä½†æˆ‘ä¸æ˜ç™½æ²¡æœ‰ tensor flow æ€ä¹ˆå¯èƒ½åœ¨å¼•æ“ç›–ä¸‹å·çœ‹ã€‚ä»£æ•°åœ¨å‰å‘ä¼ é€’ä¸­æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå¹¶ä¸”ä»£æ•°å’Œå¾®ç§¯åˆ†å¯¹äºè®¡ç®—æŸå¤±å‡½æ•°ç›¸å¯¹äºç½‘ç»œæƒé‡çš„å¯¼æ•°æ˜¯æœ‰ç”¨çš„ï¼Œè¿™æ˜¯æˆ‘ä»¥å°é—­å½¢å¼å¯¼å‡ºçš„ã€‚è¿™äº›ç”¨äºæ›´æ–°æƒé‡ï¼Œé€šå¸¸ç§°ä¸ºåå‘ä¼ æ’­ã€‚ä¸æ„¿æ„ç»å†æ¨å¯¼è¿‡ç¨‹ä½†èƒ½å¤Ÿç†è§£æœ€ç»ˆè¡¨è¾¾å¼çš„è¯»è€…ä»ç„¶å¯ä»¥é€šè¿‡ç†è§£æœ€ç»ˆç»“æœå¹¶åœ¨ numpy ä¸­å®ç°(æˆ–éµå¾ªæˆ‘çš„å®ç°)è€Œå—ç›Šã€‚

# ç›˜æ—‹

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå›¾åƒå¤„ç†ä¸­å·ç§¯çš„ç¡®åˆ‡å«ä¹‰ï¼Œä»¥åŠå®ƒä¸ scipy ä¸­å®ç°çš„å…³ç³»ã€‚è¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸º scipy å®ç°æ¯”ç®€å•çš„ numpy å®ç°å¿«å¾—å¤šã€‚æœ€åï¼Œæˆ‘ä»¬å°†è€ƒè™‘ä¸€ä¸ªæ‰‹åŠ¨è®¡ç®—å·ç§¯çš„ä¾‹å­ï¼Œå¹¶ä½¿ç”¨ scipy ä½œä¸ºå¥å…¨æ€§æ£€æŸ¥ã€‚ä¸ºç®€å•èµ·è§ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†åœ¨ 1 ç»´ä¸­å·¥ä½œï¼Œä½†è®ºç‚¹å¯ä»¥ç®€å•åœ°æ‰©å±•åˆ°ä»»ä½•ç»´æ•°ã€‚

æ•°å­¦ä¸Šï¼Œå‡½æ•° f ä¸å‡½æ•° g çš„å·ç§¯è¢«å®šä¹‰ä¸º

![](img/0194eec2caa7e4f778ab1cd08c581e52.png)

ç‰©ç†å­¦ä¸­çš„å·ç§¯

è¿™ä¸ªå®šä¹‰åœ¨ç‰©ç†å­¦å’Œä¿¡å·å¤„ç†ä¸­æ˜¯æœ‰ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ç”µç£å­¦ä¸­ï¼Œg å¯ä»¥æ˜¯ç”µè·å¯†åº¦ï¼Œf(åœ¨è¿™ç§æƒ…å†µä¸‹ç§°ä¸ºæ ¼æ—å‡½æ•°)å°†å¸®åŠ©æˆ‘ä»¬è®¡ç®—ç”±äºæ‰€è¿°ç”µè·åˆ†å¸ƒè€Œäº§ç”Ÿçš„ç”µåŠ¿ã€‚(è¯¦è§æ°å…‹é€Šç­‰ç”µç£å­¦ä¹¦ç±æˆ–ä½©æ–¯é‡‘ã€æ–½ç½—å¾·ç­‰ç²’å­ç‰©ç†å­¦ä¹¦ç±)ã€‚

åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œè¿™ä¸ªå®šä¹‰æœ‰ç‚¹è½åï¼Œå› ä¸ºå¯¹äºé•¿åº¦ä¸º *ğ¾ã€*çš„å·ç§¯çª— gï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ *ğ‘¥* çš„å·ç§¯æ˜¯ *ğ‘“* çš„åŠ æƒå¹³å‡å€¼ï¼Œä½¿å¾—åœ¨*ğ‘¥*-*ğ¾*/2+*ğ‘¦*çš„å€¼è¢« *ğ‘”* ( *ğ‘¦* )åŠ æƒã€‚å› æ­¤ï¼Œä¸ºäº†å›¾åƒå¤„ç†çš„ç›®çš„ï¼Œæ­£ç¡®çš„å®šä¹‰æ˜¯

![](img/a96902a933d034892a52d898df11d8dc.png)

å›¾åƒå¤„ç†å·ç§¯

*è¯·æ³¨æ„ï¼Œè¿™å°†éœ€è¦ f(x)çš„å€¼ä½œä¸º x çš„è´Ÿå€¼ï¼Œå¦‚æœæŒ‰åŸæ ·æ”¾å…¥ï¼Œåˆ™ numpy ä¼šå°†è´Ÿæ•°è§£é‡Šä¸ºä»æ•°ç»„æœ«å°¾å¼€å§‹çš„ç´¢å¼•ã€‚å› æ­¤ï¼Œåœ¨ numpy ä¸­å®ç°è¿™ä¸€ç‚¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿åŸå§‹æ•°ç»„åµŒå…¥åˆ°ä¸€ä¸ªæ›´å¤§çš„ 0 å¡«å……æ•°ç»„ä¸­ï¼Œå¹¶ä¸”æ­£ç¡®ç†è§£è´Ÿç´¢å¼•ã€‚*

åœ¨æˆ‘ä»¬çš„ CNN å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ scipy.convolveï¼Œå› ä¸ºå®ƒå°†æ¯” numpy ä¸­çš„ç®€å•å®ç°æ›´å¿«ã€‚å› æ­¤ï¼Œäº†è§£ scipy.convolve ä¸æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿ä¹‹é—´çš„è”ç³»æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚Scipy çš„å·ç§¯ç”¨äºä¿¡å·å¤„ç†ï¼Œå› æ­¤å®ƒç±»ä¼¼äºä¼ ç»Ÿçš„ç‰©ç†å®šä¹‰ï¼Œä½†ç”±äºæ•°ç»„ä½ç½®ä» 0 å¼€å§‹çš„ numpy çº¦å®šï¼Œg çš„çª—å£ä¸­å¿ƒä¸åœ¨ 0 å¤„ï¼Œè€Œæ˜¯åœ¨ K/2 å¤„ã€‚æ‰€ä»¥ scipy.convolve ä½¿ç”¨äº†è¿™ä¸ªå®šä¹‰

![](img/a9f5a65c99540fc24a7514ac1c245744.png)

scipy .æ—‹èŠ±

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åè½¬è¿™ä¸ªå·ç§¯çª—ï¼Œæˆ‘ä»¬å¾—åˆ° y ->K-yï¼Œè¿™å°±æ˜¯ç§¯åˆ†

![](img/42e750ced7b5d5463c2f5f7c2baad1d3.png)

åœ¨å°†å·ç§¯æ»¤æ³¢å™¨æ•°ç»„äº¤ç»™ scipy.convolve ä¹‹å‰å¯¹å…¶è¿›è¡Œåè½¬çš„ç»“æœ

å› æ­¤**æˆ‘ä»¬å°†é€šè¿‡æŠŠå·ç§¯çª—å£çš„åè½¬æ•°ç»„äº¤ç»™ scipy.convolve æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚**

ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸‹é¢ç»™å‡ºçš„ä¿¡å·å’Œæ»¤æ³¢å™¨ã€‚

![](img/38c44a487b7aa85caa81e15976a16b3a.png)

ä¿¡å·å’Œä¸ä¹‹å·ç§¯çš„æ»¤æ³¢å™¨

ç„¶åï¼Œæˆ‘ä»¬æ‰‹åŠ¨å®ç°å·ç§¯ï¼Œå¹¶åœ¨ä¸‹é¢çš„å‘½ä»¤ä¸­ä½¿ç”¨ scipy

```
convolve(sig,win[::-1],'same')
```

ç»“æœç»˜åˆ¶å¦‚ä¸‹ã€‚å»ºè®®è¯»è€…é€šè¿‡ç›®æµ‹å›¾è¡¨æˆ–è‡ªå·±å®æ–½è¿™ä¸¤ç§æ–¹æ³•æ¥è¯´æœè‡ªå·±ç»“æœæ˜¯ç›¸åŒçš„ã€‚

![](img/4164bef00765f68bad46f89f5c0fcbd2.png)

æ‰‹åŠ¨å’Œæ‰‹åŠ¨å·ç§¯çš„ç»“æœã€‚

æˆ‘ä»¬ç°åœ¨å‡†å¤‡ä½¿ç”¨ numpy å®ç° CNNã€‚

# ä¸¤çº§åˆ†ç±»

ä½œä¸ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ numpy å®ç°äº†ä¸¤ä¸ªç±»çš„åˆ†ç±»ã€‚æˆ‘ä¼šè¯¦ç»†è®¨è®ºè¿™ä¸€ç‚¹ï¼Œå¯¹äºåé¢å¸–å­ä¸­çš„å…¶ä»–ç¤ºä¾‹ï¼Œæˆ‘å¸Œæœ›è¯»è€…å·²ç»è¯¦ç»†ç†è§£äº†è¿™ä¸ªç¤ºä¾‹ï¼Œå¹¶ä¸”ç†è§£å¾—æ›´å¿«ä¸€äº›ã€‚

å¯¹äºæ•°æ®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ—¶å°š MNISTã€‚æˆ‘ä»¬ä» Keras é‚£é‡Œå¾—åˆ°è¿™ä¸ªï¼Œå› ä¸ºå®ƒå¾ˆå®¹æ˜“å¾—åˆ°ï¼Œä½†æ˜¯è¯·æ³¨æ„è¿™æ˜¯ Keras åœ¨è¿™ç¯‡æ–‡ç« ä¸­çš„å”¯ä¸€ç”¨é€”ã€‚

```
(X_train_full, y_train_full), (X_test, y_test) = keras.datasets.fashion_mnist.load_data()
```

ç„¶åæˆ‘ä»¬å°†æ•°æ®é›†é™åˆ¶åœ¨ç¬¬ 1 ç±»å’Œç¬¬ 3 ç±»ã€‚

```
cond=np.any([y_train_full==1,y_train_full==3],0)X_train_full=X_train_full[cond]
y_train_full=y_train_full[cond]
X_test=X_test[np.any([y_test==1,y_test==3],0)]
y_test=y_test[np.any([y_test==1,y_test==3],0)]y_train_full=(y_train_full==3).astype(int)
y_test=(y_test==3).astype(int)
```

ç„¶åï¼Œæˆ‘ä»¬å°†è®­ç»ƒé›†åˆ†æˆè®­ç»ƒé›†å’ŒéªŒè¯é›†

```
X_train, X_valid = X_train_full[:-1000], X_train_full[-1000:]
y_train, y_valid = y_train_full[:-1000], y_train_full[-1000:]
```

æœ€åï¼Œæˆ‘ä»¬å°†æ•°æ®æ ‡å‡†åŒ–ï¼Œå› ä¸ºç¥ç»ç½‘ç»œæœ€é€‚åˆå¤„ç†å¹³å‡å€¼å’Œå•ä½æ ‡å‡†åå·®ä¸ºé›¶çš„æ•°æ®ã€‚

```
X_mean = X_train.mean(axis=0, keepdims=True)
X_std = X_train.std(axis=0, keepdims=True) + 1e-7
X_train = (X_train - X_mean) / X_std
X_valid = (X_valid - X_mean) / X_std
X_test = (X_test - X_mean) / X_std
```

æˆ‘ä»¬çš„æ•°æ®æ˜¯å•è‰²å›¾åƒï¼Œä»¥ LÃ—L(è¿™é‡Œ L=28)çš„çŸ©é˜µå½¢å¼å‡ºç°ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå·ç§¯å±‚(æˆ‘ä»¬å°†åœ¨åé¢çš„æ–‡ç« ä¸­æ”¾å®½è¿™ä¸€é™åˆ¶)ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º KÃ—K(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æˆ‘ä»¬å– K=3)çš„çŸ©é˜µï¼Œå…¶æƒé‡å¯ä»¥å­¦ä¹ ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå¯†é›†å±‚ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º(L*L) x 1 çš„çŸ©é˜µã€‚æ³¨æ„ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¿ç•™åè§æœ¯è¯­ï¼Œä¸€æ—¦è¯»è€…ç†è§£äº†è¿™ä¸ªä¾‹å­ï¼Œå°±å¯ä»¥æŠŠå®ƒä»¬ä½œä¸ºç»ƒä¹ ã€‚

æˆ‘ä»¬ç°åœ¨è¯¦ç»†æè¿°æ­£å‘ä¼ é€’ã€è¯¯å·®å’Œåå‘ä¼ æ’­ã€‚

## å‰è¿›ä¼ çƒ

*   æˆ‘ä»¬å¾—åˆ°çš„å›¾åƒï¼Œå¹¶å°†å…¶ä½œä¸ºç¬¬ 0 å±‚ğ‘™
*   æˆ‘ä»¬å°†å±…ä¸­çš„å›¾åƒåµŒå…¥åˆ°å¤§å°ä¸º( *ğ¿* + *ğ¾* ï¼Œ *ğ¿* + *ğ¾* )çš„å›¾åƒä¸­ï¼Œå¹¶å¡«å……é›¶

![](img/18a1898d52bee9954aa9834f78f57d4b.png)

*   ç„¶åï¼Œæˆ‘ä»¬å°†å®ƒé€šè¿‡ä¸€ä¸ªå·ç§¯å±‚å’Œä¸€ä¸ªæ¿€æ´»å‡½æ•° f1(æˆ‘ä»¬å°†æŠŠå®ƒç§°ä¸º Relu)ã€‚è¿™æ˜¯ç¬¬ä¸€å±‚ l1ã€‚

![](img/81f583609adc75be772d0db79fe66398.png)

*   æœ€åï¼Œæˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªåŒ…è£¹åœ¨å‡½æ•° f2 ä¸­çš„ç¨ å¯†å±‚(åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ª sigmoid å‡½æ•°)ã€‚è¿™æ˜¯ç¬¬äºŒå±‚ l2ã€‚

![](img/a9d556009ba4b5d4ff238dd1c4bff263.png)

*è¯·æ³¨æ„ï¼Œå°½ç®¡æƒé‡ W2 æ˜¯é’ˆå¯¹å¯†é›†å±‚çš„ï¼Œä½†æˆ‘ä»¬åœ¨æ­¤å¤„å†™å…¥çš„æŒ‡æ•°æ²¡æœ‰è¿›è¡Œå±•å¹³ï¼Œå› ä¸ºå®ƒæœ‰ä¸€ä¸ªç›´è§‚çš„è§£é‡Šï¼Œå³å®ƒå–å·ç§¯å›¾åƒçš„æ¯ä¸ªåƒç´ å¹¶è¿›è¡ŒåŠ æƒæ±‚å’Œã€‚ç„¶è€Œï¼Œå°†ä¸¤è€…æ‹‰å¹³å¹¶åšä¸€ä¸ªæ•°å­—ç‚¹ä¼šæ›´æœ‰æ€§èƒ½ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨ä¸‹é¢çš„ä»£ç ä¸­æ‰€åšçš„ã€‚*

## æŸå¤±å‡½æ•°

å¯¹äºæŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬é‡‡ç”¨é€šå¸¸çš„å¯¹æ•°æŸå¤±

![](img/b1a160eee45233ac8f062baeb393c8f1.png)

æŸå¤±å‡½æ•°

å…¶ä¸­ y æ˜¯çœŸå®ç»“æœã€‚

## åå‘ä¼ æ’­

åå‘ä¼ æ’­åªæ˜¯ä¸€ä¸ªèŠ±å“¨çš„è¯ï¼Œç”¨æ¥è¡¨ç¤ºæ‰€æœ‰å¯å­¦ä¹ çš„æƒé‡éƒ½é€šè¿‡æŸå¤±å‡½æ•°ç›¸å¯¹äºæ­£åœ¨å­¦ä¹ çš„æƒé‡çš„æ¢¯åº¦æ¥æ ¡æ­£ã€‚ä½¿ç”¨é“¾å¼æ³•åˆ™æ¥åŒºåˆ†å…³äº W1 å’Œ W2 çš„æŸå¤±å‡½æ•°æ˜¯å¾ˆç®€å•çš„ã€‚

*   æŸå¤±å‡½æ•°ç›¸å¯¹äºå±‚ 2 çš„å¯¼æ•°ä¸º

![](img/12c026073412835c90f1d6d379113642.png)

*   æŸå¤±å‡½æ•°ç›¸å¯¹äºå¯†é›†å±‚æƒé‡çš„**å¯¼æ•°ä¸º**

![](img/932295a8567db7cd3a997033bb0695dc.png)

å…¶ä¸­æˆ‘ä»¬ä½¿ç”¨äº† l2 æ˜¯ sigmoid å‡½æ•° s(x)çš„è¾“å‡ºä»¥åŠ s'(x)=s(x)(1-s(x))çš„äº‹å®ã€‚

*   ç±»ä¼¼åœ°ï¼ŒæŸå¤±å‡½æ•°ç›¸å¯¹äºå±‚ 1 çš„å¯¼æ•°ä¸º

![](img/8bca4c9ff0d708c2951f05c96342b99a.png)

*   æŸå¤±å‡½æ•°ç›¸å¯¹äºå·ç§¯æ»¤æ³¢å™¨çš„**å¯¼æ•°ä¸º**

![](img/8eb733eaa5018211bf128a8d00a1a98a.png)

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†æŸå¤±å‡½æ•°çš„å¯¼æ•°ç›¸å¯¹äºå·ç§¯æ»¤æ³¢å™¨çš„æƒé‡ä»¥åŠæœ€ç»ˆå¯†é›†çŸ©é˜µçš„å°é—­å½¢å¼çš„è¡¨è¾¾å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†æƒé‡(å…·æœ‰å­¦ä¹ é€Ÿç‡çš„è¶…å‚æ•°)æ›´æ–°ä¸º

![](img/dcb27d2f0ce2aff35361a4997514aa88.png)

**å°±è¿™æ ·ã€‚**

è¿™å°±æ˜¯ç¼–å†™ CNN å®ç°æ‰€éœ€çš„å…¨éƒ¨å†…å®¹ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ³¨æ„åˆå§‹éšæœºæƒé‡çš„æŸå¤±å‡½æ•°å’Œå‡†ç¡®æ€§ï¼Œä»¥ä¾¿æœ‰ä¸€ä¸ªåŸºå‡†ã€‚

## è®­ç»ƒå‰çš„æŸå¤±å’Œå‡†ç¡®æ€§

åœ¨è®­ç»ƒå¼€å§‹ä¹‹å‰ï¼Œå¹³å‡æŸå¤±å¯ä»¥ä»æŸå¤±çš„è¡¨è¾¾å¼ä¸­åˆ†æè·å¾—ï¼Œå¹¶ä¸”æ˜¯ 1ã€‚ç²¾åº¦ä¸º 0.5ã€‚æˆ‘ä»¬å°†åœ¨äº”ä¸ªæ—¶æœŸå†…è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œå¹¶åœ¨æµ‹è¯•å’ŒéªŒè¯é›†ä¸ŠæŸ¥çœ‹æŸå¤±å’Œå‡†ç¡®æ€§ã€‚

## ä»£ç 

é¦–å…ˆï¼Œæˆ‘ä»¬ä¸º Reluã€å®ƒçš„å¯¼æ•°å’Œ sigmoid å‡½æ•°ç¼–å†™ä¸€äº›è‡ªå®šä¹‰å‡½æ•°ï¼Œè¿™æ˜¯ä¸»ä»£ç å’Œä¸€ä¸ªå‡½æ•°æ‰€éœ€è¦çš„ï¼Œè¯¥å‡½æ•°åªè¿›è¡Œå‰å‘ä¼ é€’ï¼Œå¹¶åœ¨éªŒè¯é›†ä¸Šè®¡ç®—æŸå¤±å’Œç²¾åº¦

```
def relu(x):
    return np.where(x>0,x,0)

def relu_prime(x):
    return np.where(x>0,1,0)def sigmoid(x):
    return 1./(1.+np.exp(-x))def forward_pass(W1,W2,X,y):
    l0=X
    l0_conv=convolve(l0,W1[::-1,::-1],'same','direct') l1=relu(l0_conv) l2=sigmoid(np.dot(l1.reshape(-1,),W2))
    l2=l2.clip(10**-16,1-10**-16) loss=-(y*np.log(l2)+(1-y)*np.log(1-l2))
    accuracy=int(y==np.where(l2>0.5,1,0)) return accuracy,loss
```

ç°åœ¨æˆ‘ä»¬ç¼–å†™ä»£ç çš„ä¸»è¦éƒ¨åˆ†

```
# learning rate
eta=.001for epoch in range(5): # custom code to keep track of quantities to 
    # keep a running average. it is not shown for clarity. 
    # the reader can implement her own or ask me in the comments. train_loss, train accuracy=averager(), averager()

    for i in range(len(y_train)):

        # Take a random sample from train set
        k=np.random.randint(len(y_train))
        X=X_train[k]
        y=y_train[k]

        ##### FORWARD PASS ###### # First layer is just the input
        l0=X

        # Embed the image in a bigger image. 
        # It would be useful in computing corrections 
        # to the convolution filter lt0=np.zeros((l0.shape[0]+K-1,l0.shape[1]+K-1))
        lt0[K//2:-K//2+1,K//2:-K//2+1]=l0

        # convolve with the filter
        # Layer one is Relu applied on the convolution        l0_conv=convolve(l0,W1[::-1,::-1],'same','direct')
        l1=relu(l0_conv) # Compute layer 2
        l2=sigmoid(np.dot(l1.reshape(-1,),W2))
        l2=l2.clip(10**-16,1-10**-16)

        ####### LOSS AND ACCURACY #######
        loss=-(y*np.log(l2)+(1-y)*np.log(1-l2))
        accuracy=int(y==np.where(l2>0.5,1,0))

        # Save the loss and accuracy to a running averager
        train_loss.send(loss)
        train_accuracy.send(accuracy) ##### BACKPROPAGATION #######

        # Derivative of loss wrt the dense layer
        dW2=(((1-y)*l2-y*(1-l2))*l1).reshape(-1,)

        # Derivative of loss wrt the output of the first layer
        dl1=(((1-y)*l2-y*(1-l2))*W2).reshape(28,28)

        # Derivative of the loss wrt the convolution filter f1p=relu_prime(l0_conv)
        dl1_f1p=dl1*f1p
        dW1=np.array([[
           (lt0[alpha:+alpha+image_size,beta:beta+image_size]\
           *dl1_f1p).sum() for beta in range(K)
        ]for alpha in range(K)]) W2+=-eta*dW2
        W1+=-eta*dW1 loss_averager_valid=averager()
    accuracy_averager_valid=averager()   

    for X,y in zip(X_valid,y_valid):
        accuracy,loss=forward_pass(W1,W2,X,y)
        loss_averager_valid.send(loss)
        accuracy_averager_valid.send(accuracy)

    train_loss,train_accuracy,valid_loss,valid_accuracy\
            =map(extract_averager_value,[train_loss,train_accuracy,
                 loss_averager_valid,accuracy_averager_valid])

    # code to print losses and accuracies suppressed for clarity
```

åœ¨æˆ‘çš„è¯•è¿è¡Œä¸­ï¼Œæˆ‘å¾—åˆ°äº†ä»¥ä¸‹ç»“æœã€‚ä½ çš„åº”è¯¥å·®ä¸å¤š

![](img/35dee857ab08ba32ef83ec1a8f22c1cd.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿è¿™ä¸ªç®€å•çš„æ¨¡å‹ä¹Ÿå°†æŸå¤±ä»å¤§çº¦ 1 å‡å°‘åˆ° 0.1ï¼Œå¹¶å°†å‡†ç¡®åº¦ä» 0.5 å¢åŠ åˆ°å¤§çº¦ 0.96(åœ¨éªŒè¯é›†ä¸Š)ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»˜åˆ¶ä¸€äº›(æ ‡å‡†åŒ–çš„)å›¾åƒä»¥åŠå®ƒä»¬ä¸åŸå§‹éšæœºæ»¤æ³¢å™¨å’Œæœ€ç»ˆè®­ç»ƒçš„æ»¤æ³¢å™¨çš„å·ç§¯æ¥å¯è§†åŒ–å·ç§¯ã€‚

![](img/d02c7f80a73b34b7155b695027744f0b.png)

ä½¿ç”¨åˆå§‹éšæœºæ»¤æ³¢å™¨å’Œæœ€ç»ˆå­¦ä¹ æ»¤æ³¢å™¨çš„å›¾åƒ 1 çš„å·ç§¯

![](img/8e9ab4f383a8b282427c50e2842ab710.png)

ä½¿ç”¨åˆå§‹éšæœºæ»¤æ³¢å™¨å’Œæœ€ç»ˆå­¦ä¹ æ»¤æ³¢å™¨çš„å›¾åƒ 2 çš„å·ç§¯

![](img/1a5ad32ecf688ca5b27241e349fe4613.png)

ä½¿ç”¨åˆå§‹éšæœºæ»¤æ³¢å™¨å’Œæœ€ç»ˆå­¦ä¹ æ»¤æ³¢å™¨çš„å›¾åƒ 3 çš„å·ç§¯

æˆ‘ä»¬çœ‹åˆ°å·ç§¯æ»¤æ³¢å™¨ä¼¼ä¹å·²ç»å­¦ä¼šäº†è¯†åˆ«å³è¾¹ç¼˜ã€‚å½“æˆ‘ä»¬è®­ç»ƒå¤šä¸ªè¿‡æ»¤å™¨æ—¶åº”è¯¥æ›´å¥½ï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡åªæœ‰ä¸€ä¸ªè¿‡æ»¤å™¨æ¥ä¿æŒäº‹æƒ…ç®€å•ã€‚(è¿™ä¸ªé€‰æ‹©æœ¬èº«å°±æ˜¯ä¸€ä¸ªè¶…å‚æ•°)ã€‚åœ¨ç»“æŸè¿™ç¯‡æ–‡ç« çš„ç¬¬ä¸€éƒ¨åˆ†ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åšä¸€ä»¶äº‹ã€‚æˆ‘ä»¬å¯ä»¥åˆ¶ä½œå¦å¤–ä¸¤ä¸ªæ¨¡å‹:1)æˆ‘ä»¬å†»ç»“å·ç§¯å±‚æƒé‡ï¼Œ2)æˆ‘ä»¬å†»ç»“å¯†é›†å±‚æƒé‡ã€‚è¿™å°†æœ‰åŠ©äºæˆ‘ä»¬äº†è§£è¿™äº›å±‚æ˜¯å¦æœ‰åŠ©äºè¯¥è¿‡ç¨‹ã€‚è¿™å¾ˆå®¹æ˜“ã€‚å¯¹äºå‰è€…ï¼Œæˆ‘ä»¬æ³¨é‡Šæ‰ W1 çš„æ›´æ–°è¡Œ

```
W2+=-eta*dW2
# W1+=-eta*dW1
```

å¯¹äºåè€…ï¼Œæˆ‘ä»¬æ³¨é‡Šæ‰ W2 çš„æ›´æ–°è¡Œ

```
# W2+=-eta*dW2
W1+=-eta*dW1
```

ç”±æ­¤äº§ç”Ÿçš„æŸè€—å’Œç²¾åº¦ä¸º

![](img/8cc22a0243a3716de12291222efc7c38.png)

å†»ç»“å·ç§¯å±‚çš„æ€§èƒ½

å’Œ

![](img/c2b2f588758a08e249466bc68f7c126e.png)

å†»ç»“è‡´å¯†å±‚çš„æ€§èƒ½

åˆ†åˆ«æ˜¯ã€‚å¾ˆæ˜æ˜¾ï¼Œå¤§éƒ¨åˆ†å·¥ä½œæ˜¯ç”±å¯†é›†å±‚å®Œæˆçš„ï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡å·ç§¯å±‚è·å¾— 0.5 çš„æŸå¤±å’Œ 0.8 çš„ç²¾åº¦ã€‚æ®æ¨æµ‹ï¼Œéšç€è¿‡æ»¤å™¨æ•°é‡çš„å¢åŠ ï¼Œè¿™ç§æ€§èƒ½å°†ä¼šæé«˜ã€‚æˆ‘ä»¬å°†åœ¨ä»¥åçš„æ–‡ç« ä¸­æ¢è®¨è¿™ä¸ªé—®é¢˜ã€‚