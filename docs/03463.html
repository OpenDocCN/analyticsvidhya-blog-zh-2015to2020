<html>
<head>
<title>Building Python Lambdas as a Package (LaaP)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Python Lambdas构建为一个包(LaaP)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/building-python-lambdas-as-a-package-laap-a3565eea2a1f?source=collection_archive---------18-----------------------#2020-02-02">https://medium.com/analytics-vidhya/building-python-lambdas-as-a-package-laap-a3565eea2a1f?source=collection_archive---------18-----------------------#2020-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c95c3f3a989052aef24d83f3986dfa91.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*JG0nijmy0NiNa95VqP2FAg.png"/></div></figure><p id="efdd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有很多关于构建Python Lambdas的文章。有些甚至在<a class="ae jk" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>中。令人恼火的是，这些例子中有许多没有考虑到在生产代码中最好将代码与测试放在一起，以及许多不必要的复制步骤来移动已安装的需求。</p><p id="9ba8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用pip，再加上它的命令行参数，你可以免费得到很多东西。那么，我们如何开始，创建一个演示目录:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="af9f" class="ju jv hi jq b fi jw jx l jy jz">mkdir demo_lambda<br/>cd demo_lambda</span></pre><p id="a245" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">添加一个模块，这将包含我们的Lambda函数:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="505e" class="ju jv hi jq b fi jw jx l jy jz">mkdir todo_lambda<br/>touch todo_lambda/__init__.py</span></pre><p id="448d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，让我们编写我们的Lambda函数，把它放在<code class="du ka kb kc jq b">todo_lambda/todo_lambda_function.py</code>中:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="6921" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">相当简单！它将调用<a class="ae jk" href="https://jsonplaceholder.typicode.com/" rel="noopener ugc nofollow" target="_blank"> JSONPlaceholder </a>并获得一个todo。为了使Lambda的路径更简单，在<code class="du ka kb kc jq b">todo_lambda/__init__.py</code>中添加一个相对导入:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="1cd6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这意味着我们现在可以把处理者称为<code class="du ka kb kc jq b">todo_lambda.todo_handler</code>。这在设置Lambda函数时很有用。</p><p id="5879" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，作为优秀的编码人员，让我们编写一些测试，首先制作测试模块:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="5e17" class="ju jv hi jq b fi jw jx l jy jz">mkdir tests<br/>touch tests/__init__.py</span></pre><p id="7092" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们在<code class="du ka kb kc jq b">tests/test_todo_lambda_function.py</code>中编写一个简单的测试:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="a26f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你现在可以用<code class="du ka kb kc jq b">pytest</code>从你的根目录运行这些。</p><p id="5df3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以你可能会说“酷，一些简单的Python代码，那又怎么样？”，嗯，我们还没有到酷的地步，以上都是标准。这才是重点。</p><h2 id="4e28" class="ju jv hi bd kf kg kh ki kj kk kl km kn ix ko kp kq jb kr ks kt jf ku kv kw kx bi translated">好的一面</h2><p id="5bdf" class="pw-post-body-paragraph im in hi io b ip ky ir is it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj hb bi translated">对，我们到了，在好地方。让我们把这个代码打包。添加您的<code class="du ka kb kc jq b">setup.py</code>:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="kd ke l"/></div></figure><p id="45ce" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在来制作拉链。首先，进行安装:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="ac72" class="ju jv hi jq b fi jw jx l jy jz">python3 -m pip install . -t output/install</span></pre><p id="79df" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将把所有的Lambdas需求安装到安装目录中。那是<code class="du ka kb kc jq b">-t output/install</code>位。现在让我们闭嘴:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="59d1" class="ju jv hi jq b fi jw jx l jy jz">cd <!-- -->output/install<br/>zip -r ../lambda.zip *<br/>cd -</span></pre><p id="06cf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们现在有一个Lambda zip，现在让我们发布它。首先，创建角色:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="5ccc" class="ju jv hi jq b fi jw jx l jy jz">aws iam create-role --role-name lambda-role --assume-role-policy-document '{"Version": "2012-10-17","Statement": [{ "Effect": "Allow", "Principal": {"Service": "lambda.amazonaws.com"}, "Action": "sts:AssumeRole"}]}'</span></pre><p id="a4e2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">并附加一个基本的lambda策略:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="4d06" class="ju jv hi jq b fi jw jx l jy jz">aws iam attach-role-policy --role-name lambda-role --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole</span></pre><blockquote class="ld le lf"><p id="a16e" class="im in lg io b ip iq ir is it iu iv iw lh iy iz ja li jc jd je lj jg jh ji jj hb bi translated">我们在这里偷懒，使用管理策略。显然，您会创建自己的策略，并可能使用一些<strong class="io hj">基础设施作为代码</strong>工具，如<code class="du ka kb kc jq b"><em class="hi">terraform</em></code>。</p></blockquote><p id="683b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用以下内容发布Lambda函数:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="c49b" class="ju jv hi jq b fi jw jx l jy jz">aws lambda create-function --function-name todo-lambda --runtime <!-- -->python3.7 <!-- -->--role <!-- -->arn:aws:iam::<!-- -->${<!-- -->AWS_ACCOUNT_ID<!-- -->}<!-- -->:role/lambda-role<!-- --> --handler todo_lambda.todo_handler --zip-file fileb://<!-- -->output/lambda.zip<!-- --> --region eu-west-1</span></pre><blockquote class="ld le lf"><p id="b41e" class="im in lg io b ip iq ir is it iu iv iw lh iy iz ja li jc jd je lj jg jh ji jj hb bi translated"><code class="du ka kb kc jq b"><em class="hi">export AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)</em></code>在这里知道这是一个很好的命令。</p></blockquote><p id="d466" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们现在可以用以下方式调用它:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="debb" class="ju jv hi jq b fi jw jx l jy jz">aws lambda invoke --function-name todo-lambda --payload '{"todo_id": 1}' response.json</span></pre><p id="e4e6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果一切顺利，您的<code class="du ka kb kc jq b">response.json</code>应该是这样的:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="3831" class="ju jv hi jq b fi jw jx l jy jz">{<br/>  "userId": 1,<br/>  "id": 1,<br/>  "title": "delectus aut autem",<br/>  "completed": false<br/>}</span></pre><h2 id="cd35" class="ju jv hi bd kf kg kh ki kj kk kl km kn ix ko kp kq jb kr ks kt jf ku kv kw kx bi translated">结尾注释</h2><p id="2207" class="pw-post-body-paragraph im in hi io b ip ky ir is it kz iv iw ix la iz ja jb lb jd je jf lc jh ji jj hb bi translated">使用这种方法，您可以以一种简洁的方式编写代码，进行良好的测试，并使其易于部署。这是一种模式，您可以很容易地在您的代码库中复制，并将其用作一个好的标准。</p><p id="8d79" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">从这里开始，你可以玩其他东西:</p><ul class=""><li id="0970" class="lk ll hi io b ip iq it iu ix lm jb ln jf lo jj lp lq lr ls bi translated">Pip安装也可以使用需求文件，比如<code class="du ka kb kc jq b">pip install . -r requirements.txt</code>，那些需求文件可以有需求文件…有戏！</li><li id="5e3f" class="lk ll hi io b ip lt it lu ix lv jb lw jf lx jj lp lq lr ls bi translated">试着把这个土改一下，从长远来看会有很大帮助。</li><li id="5ca2" class="lk ll hi io b ip lt it lu ix lv jb lw jf lx jj lp lq lr ls bi translated">Pip是Python，这意味着你可以从Python运行它…请注意pip变化很大，你可能需要在更新前测试版本。</li><li id="ea51" class="lk ll hi io b ip lt it lu ix lv jb lw jf lx jj lp lq lr ls bi translated">集成测试总是可以放在一个单独的目录中，它们也可以放在一起…很好！</li></ul></div></div>    
</body>
</html>