# 快速可靠的股票市场回溯测试。熊猫并行。

> 原文：<https://medium.com/analytics-vidhya/fast-and-reliable-stockmarket-backtesting-pandas-parallel-tips-4-data-structure-optimization-91bb5e16a40a?source=collection_archive---------11----------------------->

## 技巧#4:数据结构优化。

![](img/bf446513e04aad7e6a41fe55708fe7f5.png)

在[之前的技巧](https://alasko.medium.com/fast-and-reliable-stockmarket-backtesting-pandas-tips-2-5f17130a0f3b)中，我展示了如何实现并行处理过程来加速计算。在这个过程中，我们发现一些 Pandas 函数在处理大数据集时，需要大量的执行时间。我提出了优化基于报价机分割数据的函数的方法，这让我们节省了更多的时间。然而，还有另一种更有效的方法(加速高达 5 倍)来处理这些计算中的时间问题。

“上梁不正下梁歪”。因此，如果算法，以它被编码的方式，看起来不是时间有效的，最好的解决方法是从头开始。以及“最初是……”包含股票价格的数据集。尤其是我们将数据分成块的方式。

初始数据集具有以下结构:

给定这样的结构:

*   我们以这样一种方式分割数据集，即一个股票的所有价格应该在同一个块中；
*   然后，我们运行并行计算，导出每个块中可用的跑马灯的所有力矩；
*   之后，我们将所有数据块合并到一个数据集中；
*   按日期和动量值对数据集进行排序；
*   保持理想数量的绩优股。

这里的一个弱点是我们部分修复了不使用熊猫切片的函数(这对于大数据来说很耗时)。但另一个，并行处理后的排序，是不固定的。显然，在分块计算中运行排序会更好。但是对于这样的数据分割，这是不可能的，因为两个不同的块包含交叉的日期。如果我们开始以这种方式对顶级股票进行排序和保存，在合并大块之后，我们将多次获得每个日期的顶级股票数量；因此有必要再次进行整理和保存。

所以我们能做的是根据日期分割数据。但是另一个问题也暴露出来了:我们失去了在期望的时间内改变价格的机会。例如，拆分数据后，某个块中可用的第一个日期是“2010 年 1 月 1 日”:由于没有“2010 年 12 月 1 日”的价格，我们如何计算月动量？这里的解决方法是创建两个数据集:第一个包含“当前”日期价格，第二个包含价格变化，但代表相同的“当前”日期。例如:

检查第一个表中“2020–04–03”的价格和第二个表中“2020–08–07”的价格，它们是相同的，因为应用了 3 天轮班。将第一个表除以第二个表得到 3 天的时刻。

下面是针对这种数据结构的优化函数:

下面是执行代码，包括将数据重新整形为所需的结构:

正如我们所看到的，1800 万行数据集的当前处理时间减少到了不到 8 秒钟。这比最初接近时的 5 倍加速度还要大。最终的输出表与之前相同:

有人可能会说，比较这种方法和以前的方法的时间是不公平的，因为我们在这里没有计算数据整形的时间(大约需要 10-12 秒)。当然，如果你打算使用一次计算，你不会看到最后一个的优势。但是一旦需要多项研究，数据整形就在开始时完成，然后每次计算为您节省 17 秒(与[技巧#3](https://alasko.medium.com/fast-and-reliable-stockmarket-backtesting-pandas-tips-2-5f17130a0f3b) 方法相比)。