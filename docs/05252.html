<html>
<head>
<title>Provisioning a Test PostgreSQL database on Heroku for your Django App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Heroku上为Django应用程序提供一个测试PostgreSQL数据库</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/provisioning-a-test-postgresql-database-on-heroku-for-your-django-app-febb2b5d3b29?source=collection_archive---------7-----------------------#2020-04-15">https://medium.com/analytics-vidhya/provisioning-a-test-postgresql-database-on-heroku-for-your-django-app-febb2b5d3b29?source=collection_archive---------7-----------------------#2020-04-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3657026d2a3ce429d94d6b9127aecde4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUJWB-PX9NPK1kNKyWvkrw.png"/></div></div></figure><p id="188f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Heroku已经成为一个流行的后端应用程序托管平台。Heroku支持的流行框架之一是Django。Django是一个python框架，最初是为了加速新的相关网站的开发而构建的，但现在正被用于通过REST APIs支持各种应用程序。</p><p id="ba44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用Heroku部署Django的众多优势之一是Heroku提供的Postgres插件。这实质上允许后端开发人员在同一个平台上管理应用程序和数据库。</p><p id="6350" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于Heroku提供的Postgres数据库的性质和Django中运行测试的方式，如果您已经将Heroku Postgres附加组件连接到您的Django应用程序，那么在尝试运行测试时会遇到错误。</p><p id="59cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文向您展示了如何解决这个问题，从而仍然能够使用Heroku的Postgres数据库，并且仍然能够轻松地运行测试。</p><p id="8b35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">名词（noun的缩写）b:我假设你熟悉Django框架和连接Heroku Postgres数据库。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="549d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">问题</strong></p><p id="95e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Settings.py</p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="jz ka l"/></div></figure><p id="4570" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个设置显示Django应用程序当前正在使用Heroku Postgres附加组件。</p><p id="3c48" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尝试运行测试命令会导致此错误</p><pre class="jv jw jx jy fd kb kc kd ke aw kf bi"><span id="8759" class="kg kh hi kc b fi ki kj l kk kl">$bash: python manage.py test</span><span id="ff96" class="kg kh hi kc b fi km kj l kk kl">Creating test database for alias 'default'...<br/>RuntimeWarning: Normally Django will use a connection to the 'postgres' database to avoid running initialization queries against the production database when it's not needed (for example, when running tests). Django was unable to create a connection to the 'postgres' database and will use the first PostgreSQL database instead.<br/>Got an error creating the test database: permission denied to create database</span></pre><p id="251e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里的关键字是“创建数据库的权限被拒绝”。</p><p id="3239" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Heroku提供Postgres数据库的方式是，用户没有创建新数据库的权限。您可以通过使用Heroku CLI检查这一点，进入PSQL并检查用户在Heroku提供的数据库中的访问权限。</p><p id="e101" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是我们的解决方法。</p><ol class=""><li id="4cb0" class="kn ko hi is b it iu ix iy jb kp jf kq jj kr jn ks kt ku kv bi translated">创建一个附加的Postgres数据库。我们将使用它作为我们的测试数据库</li></ol><figure class="jv jw jx jy fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/0d8a6eb6a88f2545523b618fecbb09d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*OdGOAg9oM6l5f2xsPR80oQ.png"/></div></div></figure><p id="bda4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在settings.py中，对其进行配置，以便Django根据CLI命令有选择地选择一个数据库。本质上，当测试运行时，它指向测试数据库。对于正常操作，将使用您的临时或生产数据库。将{ ' TEST ':{ ' NAME ':your _ testdb _ NAME } }添加到测试数据库配置的数据库字典中是很重要的。这为Django指明了正确的方向。</p><figure class="jv jw jx jy fd ij"><div class="bz dy l di"><div class="jz ka l"/></div></figure><p id="7126" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.运行带有标记'— keepdb '的测试命令。这确保了Django不会试图创建新的数据库</p><pre class="jv jw jx jy fd kb kc kd ke aw kf bi"><span id="1cfd" class="kg kh hi kc b fi ki kj l kk kl">$bash: python manage.py test --keepdb<br/>System check identified no issues (0 silenced).<br/>..<br/>----------------------------------------------------------------------<br/>Ran 2 tests in 6.954s</span><span id="872d" class="kg kh hi kc b fi km kj l kk kl">OK</span></pre><p id="8434" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">恭喜你。你可以走了。测试愉快！</p><p id="6e06" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你喜欢这个，你可以在这里或者在推特上关注我。https://twitter.com/pelumi_sa<a class="ae kx" href="https://twitter.com/pelumi_sa" rel="noopener ugc nofollow" target="_blank">有时我会在那里谈论技术</a></p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="3d31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">页（page的缩写）S</p><p id="7eb3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个解决方法非常适合这个用例。凭直觉，您可能想知道为什么Django不提供定义TEST_DATABASE配置的能力？Django认为用于测试的数据库应该与生产中使用的数据库相同。当前设置强制执行此操作。</p><p id="8bea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想通过本地PostgreSQL服务器运行您的测试，您可以简单地重新配置数据库配置以指向该服务器。</p><p id="444a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Liko Health，我们最初使用docker映像作为Postgresql实例，但决定切换到Heroku Postgres作为通用数据库，尽管我们可以继续使用该映像进行测试，但我们决定也切换到附加组件进行测试。</p></div></div>    
</body>
</html>