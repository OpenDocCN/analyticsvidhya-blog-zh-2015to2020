<html>
<head>
<title>Getting Started with Snowflake for Data Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开始使用雪花进行数据分析</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/data-analysis-with-snowflake-3e6773eb6575?source=collection_archive---------4-----------------------#2020-10-10">https://medium.com/analytics-vidhya/data-analysis-with-snowflake-3e6773eb6575?source=collection_archive---------4-----------------------#2020-10-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b522" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">加载70年美国NOAA天气数据的示例</h2></div><p id="5292" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">雪花和谷歌BigQuery等无服务器云数据库平台正在彻底改变数据分析和数据处理管道的实施方式，无需复杂的云基础设施设计、构建和维护任务。</p><p id="1933" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这篇博文介绍了使用<a class="ae jt" href="https://www.snowflake.com/" rel="noopener ugc nofollow" target="_blank">雪花数据库</a>处理160万行<a class="ae jt" href="https://www.noaa.gov/" rel="noopener ugc nofollow" target="_blank"> NOAA </a>美国天气事件数据的步骤。按照数据分析的标准，这个数据集并不庞大，但它是一个太大而无法用Excel电子表格管理的例子——这个话题最近在英国成为主流新闻:【https://www.bbc.co.uk/news/technology-54423988<a class="ae jt" href="https://www.bbc.co.uk/news/technology-54423988" rel="noopener ugc nofollow" target="_blank"/></p><p id="3ecf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这主要是一个技术操作指南，演示在云存储桶中暂存数据的过程，并自动执行以下过程</p><ul class=""><li id="74d5" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">从远程中转区接收数据，向提供数据的第三方服务认证</li><li id="8af2" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">以可重复的方式加载数据，以实现可靠的处理。</li><li id="bcf6" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">以可重复的自动化方式在数据加载到数据库时清理数据。</li><li id="8bc5" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">在按使用付费的基础上分析和处理云SQL服务中的数据，无需基础架构配置和部署任务，不需要系统管理员。</li></ul><p id="7037" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文最后还提供了从数据的初步检查中获得的一些有限的见解，但是其主要目的纯粹是一个技术指南。</p><p id="a307" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将包括Python和Jupyter笔记本在内的其他工具与雪花服务集成起来非常容易。以下GitHub repo中以<a class="ae jt" href="https://github.com/edbullen/Snowflake/blob/master/NOAA_weather_analysis_with_Snowflake.ipynb" rel="noopener ugc nofollow" target="_blank"> Python Jupyter notebook </a>形式的独立链接文章:</p><p id="0f21" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://github.com/edbullen/Snowflake" rel="noopener ugc nofollow" target="_blank">https://github.com/edbullen/Snowflake</a></p><p id="75db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">展示了将SQL与分析工具结合起来进行数据可视化和统计分析的强大功能。在这本笔记本中，对NOAA数据集的处理显示了风暴天气事件显著增加的趋势，特定的州比其他州受影响更大。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/b56b3f1b8c6ae6b1127c2ee5bab2b6f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R4mTG9amDUml6mUvUgKP0w.png"/></div></div></figure><h1 id="9a11" class="ku kv hi bd kw kx ky kz la lb lc ld le io lf ip lg ir lh is li iu lj iv lk ll bi translated">入门指南</h1><p id="8218" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated"><em class="lr">雪花免费试用:</em>如果您没有付费雪花云帐户，可以在<a class="ae jt" href="https://trial.snowflake.com" rel="noopener ugc nofollow" target="_blank">https://trial.snowflake.com</a>注册雪花免费30天试用</p><p id="9910" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lr">文档:</em>产品有完整的文档记录，免费文档可在<a class="ae jt" href="https://docs.snowflake.com/" rel="noopener ugc nofollow" target="_blank">https://docs.snowflake.com/</a>获得</p><p id="2bdd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lr">连接:</em>一般来说，你通过一个遵循以下格式的网址进行连接</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="73b6" class="lx kv hi lt b fi ly lz l ma mb">https://&lt;accountid&gt;.&lt;region&gt;.&lt;cloud-provider&gt;.snowflakecomputing.com</span></pre><p id="43c7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其中<code class="du mc md me lt b">&lt;accountid&gt;</code>是在您注册免费试用或获得访问雪花的权限时分配给您的帐户。帐户id与您登录时使用的用户名不同。<code class="du mc md me lt b">&lt;cloud-provider&gt;</code>是底层云平台(即谷歌GCP、亚马逊AWS、微软Azure)，被选为云基础设施提供商来运行雪花计算和存储服务。通常，云提供商资源将托管在地理上的<code class="du mc md me lt b">&lt;region&gt;</code>，这也需要在URL中说明。</p><p id="4200" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">示例—连接到在欧洲西部2地区(伦敦)的GCP上运行的雪花:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="36d4" class="lx kv hi lt b fi ly lz l ma mb">https://dd12345.europe-west2.gcp.snowflakecomputing.com</span></pre><p id="24db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">按照上述格式在网络浏览器中输入一个web URL，将启动雪花网络控制台，类似于下面的屏幕截图</p><p id="a58c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lr">工作表</em>视图默认选中):</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mf"><img src="../Images/14e29497c2d740510473ae009beaab59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IaCY6F2T89-HMrURUxLfhQ.png"/></div></div></figure><p id="434b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">顶部菜单栏可用于在SQL工作表视图、管理仓库计算资源、数据共享选项和数据库管理之间切换。</p><p id="7790" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在SQL工作表视图中，突出显示了当前的活动角色，以及为运行SQL命令而选择的仓库和要操作的默认数据库。</p><h1 id="c2d3" class="ku kv hi bd kw kx ky kz la lb lc ld le io lf ip lg ir lh is li iu lj iv lk ll bi translated">基本概念</h1><p id="7ca1" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">开始时需要了解一些简单的术语:</p><p id="5954" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> <em class="lr">仓库:</em> A </strong> n分配计算资源，为DML(数据操作)和查询活动提供处理能力:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/warehouses-overview.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/Warehouses-overview . html</a></p><p id="3434" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">雪花仓库运行在亚马逊AWS、谷歌GCP或微软Azure提供的计算服务上。运行服务的云提供商在创建帐户时选择。</p><p id="c7e6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">30天的免费试用期来自一个预先配置的名为<em class="lr"> COMPUTE_WH </em>的默认仓库。</p><p id="efff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【https://docs.snowflake.com/en/user-guide/databases.html】<em class="lr">数据库:</em> 由数据表、视图和其他数据结构组成的模式集合:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/databases.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="ad6c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> <em class="lr">表:</em> </strong>标准数据库表与其他数据库服务器类似，用于存储和处理数据。</p><p id="86f7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> <em class="lr">外部表:</em> </strong>这些表提供对已经存放在亚马逊S3存储桶、谷歌云存储桶或微软Azure blobs中的数据的访问:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/tables-external.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flak . com/en/user-guide/Tables-External . html</a></p><p id="ef46" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关于所有能力和功能的更多细节记录在这里:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/ui-using.html" rel="noopener ugc nofollow" target="_blank">https://docs.snowflake.com/en/user-guide/ui-using.html</a></p><h2 id="44f9" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">雪花仓库控制台视图</h2><p id="7231" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated"><em class="lr">仓库</em>控制台视图可用于查看和管理分配给雪花处理操作的计算资源。</p><p id="7315" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仓库可以手动启动，也可以配置为在执行引用计算资源仓库的查询时自动启动。默认情况下，仓库在闲置10分钟后暂停(离线)。可以配置启动和自动停止仓库的选项。</p><p id="1389" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仓库的计算使用时间是雪花使用的两个收费指标之一(另一个是存储利用率)。仓库可以手动调整大小，以分配更多或更少的计算资源，这决定了它们在活动时产生的成本。</p><p id="60ac" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在计算资源启动时，对非活动仓库执行的第一个查询可能需要几分钟的响应时间。如果在Worksheets视图中执行了一个查询，并且需要时间来响应，那么您可以在同一个控制台窗口中切换到Warehouses视图，并检查那里的资源状态。在此示例中，一个查询正在等待COMPUTE_WH仓库启动。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mt"><img src="../Images/abe814729c32e5026d31a090a85c49fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xqbSGHRKlLXgo_F5ET-xg.png"/></div></div></figure><h1 id="ce7a" class="ku kv hi bd kw kx ky kz la lb lc ld le io lf ip lg ir lh is li iu lj iv lk ll bi translated">认证选项</h1><p id="7805" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">向雪花认证的选项是经过深思熟虑的，它们是全面的，并且有清晰的文档记录。一些可用选项的摘要如下:</p><ul class=""><li id="408f" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">基本用户名/密码验证</li><li id="d9f3" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">在智能手机上使用Duo安全性的MFA(无需单独注册Duo)</li><li id="280f" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">SSO和联合身份验证，包括Ping、Microsoft Azure AD和Google G-Suite身份验证</li><li id="f49b" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">OAuth，包括与Tableau Online和Looker的集成</li><li id="8b2b" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">密钥对认证:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/snowsql-start.html#using-key-pair-authentication" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/snow SQL-start . html # using-key-Pair-authentic ation</a></li></ul><p id="ad4e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更多详细信息请访问<a class="ae jt" href="https://docs.snowflake.com/en/user-guide-admin-security.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide-admin-security . html</a></p><h1 id="aae5" class="ku kv hi bd kw kx ky kz la lb lc ld le io lf ip lg ir lh is li iu lj iv lk ll bi translated">连接到雪花</h1><p id="8352" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">除了如前所述通过Web UI使用雪花之外，还有许多其他方式与数据服务交互，包括:</p><ul class=""><li id="cf73" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">名为SnowSQL的雪花CLI工具(适用于Windows、Mac和Linux):<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/snowsql-install-config.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/snow SQL-install-config . html</a></li><li id="427a" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">JDBC:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/jdbc-download.html" rel="noopener ugc nofollow" target="_blank">https://docs.snowflake.com/en/user-guide/jdbc-download.html</a></li><li id="49fd" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">Python和Jupyter笔记本:</li></ul><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="b36c" class="lx kv hi lt b fi ly lz l ma mb">pip install snowflake-connector-python</span></pre><p id="764c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(这将安装许多依赖项，包括Panadas、SSL库和GCP、Azure和AWS支持包)</p><ul class=""><li id="5222" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">标准的数据库开发工具，如DBeaver。</li></ul><h1 id="0e5a" class="ku kv hi bd kw kx ky kz la lb lc ld le io lf ip lg ir lh is li iu lj iv lk ll bi translated">将数据加载到雪花中</h1><p id="1da7" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">可以通过多种机制和方法将数据加载到雪花中，包括:</p><ul class=""><li id="5d47" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated"><em class="lr">雪花复制命令:</em>从云存储或雪花内部暂存区暂存的数据中批量加载数据。Snowflake <em class="lr"> put </em>实用程序可用于将本地文件“放”入内部暂存区。</li><li id="86db" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><em class="lr">外部表:</em>以CSV、JSON、AVRO或PARQUET格式查询暂存在AWS / GCP / Azure存储中的数据</li><li id="3464" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><em class="lr"> Snowflake Snowpipe: </em>在临时区域接收文件时，持续加载(微批处理)数据</li><li id="36c4" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated"><em class="lr">用于雪花的Kafka连接器:</em>从Kafka主题中读取数据并加载到雪花表中。</li></ul><p id="c472" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将数据加载到雪花:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide-data-load.html" rel="noopener ugc nofollow" target="_blank">https://docs.snowflake.com/en/user-guide-data-load.html</a></p><h1 id="43d4" class="ku kv hi bd kw kx ky kz la lb lc ld le io lf ip lg ir lh is li iu lj iv lk ll bi translated">示例-通过外部表格加载NOAA天气事件数据</h1><p id="bd21" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">在这个工作示例中，大约70年的历史天气事件数据是从美国国家海洋和大气管理局(NOAA)服务加载的。数据集详细描述如下:<a class="ae jt" href="https://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf" rel="noopener ugc nofollow" target="_blank">https://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf</a></p><p id="ddff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">数据首先存放在谷歌云存储桶中，在一个独立于雪花账户的云账户中。接下来，创建一个雪花外部数据集成服务，以允许从远程云源加载数据，然后最终将数据加载到雪花数据库模式中进行查询和分析。</p><p id="39cc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个过程模拟了从云数据暂存区或数据湖中提取原始数据，并使其可用于在雪花SQL仓库中加载、清理和分析的过程。</p><h2 id="41e3" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">1.下载数据并转移到云存储</h2><p id="8c33" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">在这个例子中，我使用的是谷歌GCP存储。对于AWS或Azure，可以采用相同的一般方法，但是需要不同的CLI工具(我使用Google <code class="du mc md me lt b">gsutil</code>命令将数据复制到Google云存储桶)。</p><p id="c3d8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用<code class="du mc md me lt b">curl</code>将一个CSV文件从位于<a class="ae jt" href="https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/" rel="noopener ugc nofollow" target="_blank">的NOAA存储库https://www1 . ncdc . NOAA . gov/pub/data/swdi/storm events/CSV files/</a>复制到云存储桶，开始使用:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="27e1" class="lx kv hi lt b fi ly lz l ma mb">curl https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/StormEvents_details-ftp_v1.0_d2020_c20200819.csv.gz<br/>| gsutil cp - gs://&lt;my_bucket&gt;/StormEvents_details-ftp_v1.0_d2020_c20200819.csv.gz</span></pre><p id="9a8d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个命令应该在一行中，没有回车。将文本<code class="du mc md me lt b">gs://&lt;my_bucket&gt;</code>替换为您已设置并可访问的存储桶的详细信息。</p><h2 id="dab2" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">2.创建雪花存储集成</h2><p id="8072" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">创建一个<em class="lr">存储集成</em>以支持对远程云登台资源的访问，然后创建一个外部<em class="lr">登台</em>资源，用于将集成映射到一个<em class="lr">外部表</em>定义。</p><p id="357f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建外部集成的DDL必须作为<strong class="iz hj"> <em class="lr">帐户管理员</em> </strong>(不是<em class="lr">系统管理员</em>)运行，方法是在SQL工作表模式选项中选择适当的角色，而不仅仅是在顶部菜单栏中选择(见下图):</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mu"><img src="../Images/39d9cc0406f9d09fff200e04ca1d10eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jjExXSqfzIv-ZY1P6Gyzw.png"/></div></div></figure><p id="f59d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">示例:为外部GCS (Google云存储)存储桶创建存储集成<strong class="iz hj"> </strong>:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="c3b9" class="lx kv hi lt b fi ly lz l ma mb">CREATE STORAGE INTEGRATION noaa_ext<br/>TYPE = EXTERNAL_STAGE<br/>STORAGE_PROVIDER = GCS<br/>ENABLED = TRUE<br/>STORAGE_ALLOWED_LOCATIONS = ('gcs://my_bucket/');</span></pre><p id="a106" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个例子是针对Google GCS bucket的，但是类似的语法也用于AWS和Azure。注意雪花端的网址是<code class="du mc md me lt b">gcs</code>而不是<code class="du mc md me lt b">gs</code>。</p><p id="b80d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，启用存储集成IAM安全访问，以允许雪花访问远程云存储桶中暂存的数据。</p><p id="2227" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">详细的<em class="lr">谷歌GCP </em>说明在这里:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/data-load-gcs-config.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/data-load-GCS-config . html</a></p><p id="372c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">详细的<em class="lr">亚马逊AWS </em>说明在这里:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/data-load-s3-config.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/data-load-S3-config . html</a></p><p id="5a7a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">详细的<em class="lr">微软Azure </em>说明在这里:<a class="ae jt" href="https://docs.snowflake.com/en/user-guide/data-load-azure-config.html" rel="noopener ugc nofollow" target="_blank">https://docs . snow flake . com/en/user-guide/data-load-Azure-config . html</a></p><h2 id="52e0" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">3.启用<strong class="ak"> IAM权限</strong> <strong class="ak">进行外部云数据访问</strong></h2><p id="42a9" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">这个例子是谷歌GCP。可以采用类似的方法在AWS和Azure上启用IAM访问。</p><ol class=""><li id="2a9e" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js mv ka kb kc bi translated">通过描述已创建的存储集成，获取已为此雪花环境自动创建的GCS存储集成帐户:</li></ol><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="8864" class="lx kv hi lt b fi ly lz l ma mb">DESC STORAGE INTEGRATION noaa_ext ;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mw"><img src="../Images/8180750dd7ef1d43c1ebb95903c253b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8cXXIm81OJR5uRJxvYfrHw.png"/></div></div></figure><p id="b9d8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.登录<em class="lr"> Google Cloud Console </em>中存放数据的帐户，然后创建一个IAM角色，该角色有权访问Google storage bucket并获取对象:</p><p id="df70" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.a)以项目管理员身份登录<em class="lr">谷歌云控制台</em>，在控制台web界面选择“IAM&amp;admin”—&gt;“Roles”。</p><p id="4839" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.b)为雪花访问GCS存储中暂存的数据创建一个角色(在本例中为<em class="lr"> NOAA_SNOWFLAKE_ACCESS </em></p><p id="e072" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.c)向角色添加所需的权限:</p><p id="cf27" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me lt b">storage.objects.get</code> <code class="du mc md me lt b">storage.objects.list</code></p><p id="757c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.在<em class="lr">谷歌云控制台存储浏览器</em>中找到桶；编辑存储桶的详细信息，以添加a)在步骤1中确定的<em class="lr">存储_ GCP _服务_帐户</em>和b)在步骤2中创建的角色。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mx"><img src="../Images/2112d60196470bd1b9d413b694a2c921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oYwWJakrbdVpwdKGL_r3EQ.png"/></div></div></figure><h2 id="a62b" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">4.创建雪花数据阶段和外部表</h2><p id="f02b" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">雪花<em class="lr">阶段</em>资源将之前创建的存储集成映射到云存储URL(即正在使用的GCS存储桶)。然后，在创建外部表时可以引用Stage资源，该外部表创建可以用SQL查询的表定义(模式),并映射到云存储位置中的原始数据文件。</p><ol class=""><li id="db5b" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js mv ka kb kc bi translated">创建映射到存储集成的外部<strong class="iz hj">阶段</strong>资源。这个例子在<em class="lr">demo _ db</em><em class="lr">public</em>模式中。</li></ol><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="609a" class="lx kv hi lt b fi ly lz l ma mb">USE ROLE ACCOUNTADMIN;<br/>CREATE STAGE demo_db.public.noaa_ext_stage url = 'gcs://my_bucket/'<br/>storage_integration = noaa_ext;</span><span id="8cd7" class="lx kv hi lt b fi my lz l ma mb">GRANT USAGE ON STAGE demo_db.public.noaa_ext_stage TO ROLE SYSADMIN;</span></pre><p id="2e62" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.基于阶段和集成创建一个<strong class="iz hj">外部表</strong>。</p><p id="350c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，如果存储桶中添加了新文件，我们必须手动刷新外部表。稍后将展示一个这样的示例。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="f947" class="lx kv hi lt b fi ly lz l ma mb">USE ROLE SYSADMIN;<br/>CREATE EXTERNAL TABLE demo_db.public.noaa_ext<br/>LOCATION = @noaa_ext_stage<br/>AUTO_REFRESH = FALSE  -- feature not available on Google GCP<br/>file_format = (TYPE=CSV<br/>    , FIELD_DELIMITER = ','<br/>    , FIELD_OPTIONALLY_ENCLOSED_BY='"'<br/>    , SKIP_HEADER=1<br/>    , COMPRESSION=GZIP);  -- .gz files can be read</span></pre><p id="e358" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个例子没有将模式映射到正在被访问的文件中的数据行。</p><p id="4916" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.验证外部表是否正常工作</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="4105" class="lx kv hi lt b fi ly lz l ma mb">SELECT count(*) FROM demo_db.public.noaa_ext;</span></pre><p id="51cd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该看到返回了22，353行。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="3b9e" class="lx kv hi lt b fi ly lz l ma mb">SELECT * FROM demo_db.public.noaa_ext limit 10;</span></pre><p id="ea2a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">单击返回的输出中的一行，查看详细信息。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mz"><img src="../Images/ee90ba294c5b286cf5cb434aae387633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M2DEria8x2GQD7l369lIPg.png"/></div></div></figure><p id="e524" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">外部表中的每一行数据都作为单个值返回。c1、c2、c3…引用是源数据中的列排序位置，可用于以映射到有意义的列名的列格式来组织数据。空值已被排除。</p><p id="ab7e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.使用列表达式<strong class="iz hj">映射外部表字段</strong></p><p id="f093" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用此引用，<a class="ae jt" href="https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/Storm-Data-Bulk-csv-Format.pdf" rel="noopener ugc nofollow" target="_blank">https://www1 . ncdc . NOAA . gov/pub/Data/swdi/Storm events/CSV files/Storm-Data-Bulk-CSV-format . pdf</a>，将外部数据映射到适当类型的表列名(包括空值)。使用列表达式将外部表中的列定义映射到外部文件中的数据，如下例所示。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="d9b6" class="lx kv hi lt b fi ly lz l ma mb">USE SCHEMA demo_db.public;<br/>USE ROLE SYSADMIN;</span><span id="66df" class="lx kv hi lt b fi my lz l ma mb">-- handle dates where year = 51 means 1951, 02 means 2002<br/>ALTER SESSION SET TWO_DIGIT_CENTURY_START=1940 </span><span id="b915" class="lx kv hi lt b fi my lz l ma mb">CREATE OR REPLACE EXTERNAL TABLE noaa_ext<br/>( begin_yearmonth int as  (value:c1::int)<br/>, begin_day int       as  (value:c2::int)<br/>, begin_time int      as  (value:c3::int)<br/>, end_yearmonth int   as  (value:c4::int)<br/>, end_day int         as  (value:c5::int)<br/>, end_time int        as  (value:c6::int)<br/>, episode_id  varchar as  (value:c7::varchar)<br/>, event_id varchar    as  (value:c8::varchar)<br/>, state varchar       as  (value:c9::varchar)<br/>, state_fips int      as (value:c10::int)<br/>, year int            as (value:c11::int)<br/>, month_name varchar  as (value:c12::varchar)<br/>, event_type varchar  as (value:c13::varchar)<br/>, cz_type varchar     as (value:c14::varchar)<br/>, cz_fips varchar     as (value:c15::varchar)<br/>, cz_name varchar     as (value:c16::varchar)<br/>, wfo varchar         as (value:c17::varchar)<br/>, begin_date_time timestamp as <br/>      TO_TIMESTAMP((value:c18::varchar),'DD-MON-YY HH24:MI:SS')<br/>, cz_timezone varchar as (value:c19::varchar)<br/>, end_date_time timestamp as <br/>      TO_TIMESTAMP((value:c20::varchar),'DD-MON-YY HH24:MI:SS')<br/>, injuries_direct int as (value:c21::int)<br/>, injuries_indirect int as (value:c22::int)<br/>, deaths_direct int   as (value:c23::int)<br/>, deaths_indirect int as (value:c24::int)<br/>, damage_property varchar as (value:c25::varchar)<br/>, damage_crops varchar as(value:c26::varchar)<br/>, source varchar      as (value:c27::varchar)<br/>, magnitude  float as (value:c28::float)<br/>, magnitude_type varchar as (value:c29::varchar)<br/>, flood_cause varchar as (value:c30::varchar)<br/>, category  varchar   as (value:c31::varchar)<br/>, tor_f_scale varchar as (value:c32::varchar)<br/>, tor_length float    as (value:c33::float)<br/>, tor_width float     as (value:c34::float)<br/>, tor_other_wfo varchar as (value:c35::varchar)<br/>, tor_other_cz_state varchar as (value:c36::varchar)<br/>, tor_other_cz_fips varchar as (value:c37::varchar)<br/>, tor_other_cz_name varchar as (value:c38::varchar)<br/>, begin_range float   as (value:c39::float)<br/>, begin_azimuth varchar as (value:c40::varchar)<br/>, begin_location varchar as (value:c41::varchar)<br/>, end_range float     as (value:c42::float)<br/>, end_azimuth varchar as (value:c43::varchar)<br/>, end_location varchar as (value:c44::varchar)<br/>, begin_lat float     as (value:c45::float)<br/>, begin_lon float     as (value:c46::float)<br/>, end_lat float       as (value:c47::float)<br/>, end_lon float       as (value:c48::float)<br/>, episode_narrative varchar as (value:c49::varchar)<br/>, event_narrative varchar as (value:c50::varchar)<br/>)<br/>LOCATION = <a class="ae jt" href="http://twitter.com/noaa_ext_stage" rel="noopener ugc nofollow" target="_blank">@noaa_ext_stage</a><br/>AUTO_REFRESH = FALSE<br/>file_format = (TYPE=CSV<br/>                 ,FIELD_DELIMITER = ','<br/>                 ,FIELD_OPTIONALLY_ENCLOSED_BY='"'<br/>                 ,SKIP_HEADER=1<br/>                 ,COMPRESSION=GZIP);</span></pre><p id="b060" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.测试外部表并<strong class="iz hj">探索数据结构</strong></p><p id="edfc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从外部表中选择前10行数据，并计算记录总数:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="957e" class="lx kv hi lt b fi ly lz l ma mb">SELECT * FROM demo_db.public.noaa_ext LIMIT 10;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es na"><img src="../Images/659ca080ab352f055281877718385196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mjFuuQ-2IwDSTgal2dYRNA.png"/></div></div></figure><p id="7f77" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行几个聚合函数来检查数据集的结构，例如:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="2747" class="lx kv hi lt b fi ly lz l ma mb">SELECT distinct(DAMAGE_PROPERTY)<br/>FROM demo_db.public.noaa_ext limit 10;</span></pre><p id="dcdd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这给出了如下结果:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="32e8" class="lx kv hi lt b fi ly lz l ma mb">0.00K<br/>1.00K<br/>0.25K<br/>6.00K<br/>NULL<br/>2.00K<br/>1.50M<br/>25.00K<br/>30.00K<br/>0.50K</span></pre><p id="f59f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们对损害_财产和损害_作物字段进行有用的分析之前，我们需要清理和标准化数据。记录以混合单位(K代表1000个，M代表1000，000个等)记录，单位附加到数值上。</p><h2 id="da29" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">5.将数据批量复制到云暂存桶</h2><p id="ae1b" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">到目前为止，我们一直在处理一个zip文件，以获得我们的存储集成和外部表工作的结构。现在，将剩余的数据复制到云存储区域。</p><p id="ee0c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面的shell脚本依靠<code class="du mc md me lt b">curl</code>从NOAA HTTP资源复制数据，并使用<code class="du mc md me lt b">gsutil</code>将其写入Google存储桶。这种通用方法可用于使用适当的CLI工具将数据复制到其他云存储目的地(例如，AWS的<code class="du mc md me lt b">aws s3 cp</code>)。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="a948" class="lx kv hi lt b fi ly lz l ma mb">#!/bin/bash<br/>URL=https://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/</span><span id="8703" class="lx kv hi lt b fi my lz l ma mb">BUCKET_URL=gs://my_bucket/</span><span id="97fe" class="lx kv hi lt b fi my lz l ma mb">for htmlpath in $(curl -s $URL)<br/>do<br/>    file=$(echo "${htmlpath}" \<br/>         | grep StormEvents_details \<br/>         | sed -e 's/href\=\"\(.*\)\".*/\1/')<br/>    if [ ! -z "${file}" ]<br/>    then<br/>        echo "Copying ${file}"<br/>        curl ${URL}${file} | gsutil cp - ${BUCKET_URL}${file}<br/>    fi<br/>done</span></pre><p id="554d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当文件在云存储桶中时，我们需要<strong class="iz hj"> <em class="lr">刷新外部表</em> </strong>以便它注册新数据。这是因为谷歌GCP托管版本的雪花不支持外部表格的自动刷新。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="69d4" class="lx kv hi lt b fi ly lz l ma mb"><strong class="lt hj">ALTER EXTERNAL TABLE noaa_ext REFRESH;</strong></span></pre><p id="0879" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，如果我们选择记录计数以及最小和最大开始和结束数据时间字段，我们会看到以下内容:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="69ef" class="lx kv hi lt b fi ly lz l ma mb">SELECT count(*) FROM demo_db.public.noaa_ext;</span></pre><p id="7edf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi">1,633,697</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="1dea" class="lx kv hi lt b fi ly lz l ma mb">SELECT min(begin_date_time), max(end_date_time) <br/>FROM demo_db.public.noaa_ext;</span></pre><p id="6d5c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lr">1950–01–03 11:00:00.000</em>，<em class="lr">2020–06–30 23:59:00.000</em></p><ul class=""><li id="e726" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">因此，现在我们有超过150万条历史风暴数据记录要处理，时间跨度从1950年到2020年。</li></ul><h2 id="0643" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">6.将清理后的数据集加载到雪花数据库表中</h2><p id="b459" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">数据加载过程的最后一步是将外部表数据加载到一个本地存储在雪花中的表中(不是基于外部存储文件)。作为此过程的一部分，我们选择了可用数据列的子集，并清理了财产和作物损失列。</p><p id="2d05" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们需要从数字金额中去除K/M/B标识符，并将它们转换为适当的数字乘数值(1000、1000000、10x10⁹等)。最后，我们需要用零替换空值，以便我们可以分析风暴的货币影响。</p><p id="25be" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这些任务可以作为用于从外部表填充表的select语句的一部分来执行，使用SQL <code class="du mc md me lt b">SUBSTR</code>、<code class="du mc md me lt b">DECODE</code>和<code class="du mc md me lt b">CASE</code>函数将不同的字符串值映射到不同的数值。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="1a43" class="lx kv hi lt b fi ly lz l ma mb">CREATE OR REPLACE TABLE demo_db.public.noaa_events<br/>AS<br/>SELECT event_id<br/>, state<br/>, state_fips<br/>, cz_name<br/>, cz_fips<br/>, event_type<br/>, begin_date_time<br/>, end_date_time<br/>, injuries_direct<br/>, injuries_indirect<br/>, deaths_direct<br/>, deaths_indirect<br/>, damage_property<br/>, CASE <br/>    WHEN ( LEN(damage_property) &gt; 1 <br/>      AND UPPER(SUBSTR(damage_property,LENGTH(damage_property), 1)) <br/>      IN ('H','K','M','B') ) THEN<br/>      TO_DOUBLE(SUBSTR(damage_property,1,LENGTH(damage_property)-1))<br/>    WHEN ( LEN(damage_property) = 1 <br/>      AND UPPER(SUBSTR(damage_property,LENGTH(damage_property), 1)) <br/>      IN ('H','K','M','B') ) THEN 0<br/>    WHEN damage_property IS NULL THEN 0<br/>    WHEN damage_property = '0' THEN 0<br/>  ELSE TO_DOUBLE(damage_property)<br/>  END AS damage_property_num<br/>, CASE<br/>    WHEN UPPER(SUBSTR(damage_property,LENGTH(damage_property), 1)) <br/>    IN ('H','K','M','B') THEN<br/>    DECODE (UPPER(SUBSTR(damage_property,LENGTH(damage_property), 1)) , 'H', TO_DOUBLE('100'), 'K', TO_DOUBLE('1000'), 'M', TO_DOUBLE('1000000'), 'B',TO_DOUBLE('1000000000'))<br/>  ELSE 1<br/>  END AS damage_property_units<br/>, damage_crops<br/>, CASE<br/>    WHEN damage_crops='0T' THEN 0 -- clean up single edge case<br/>    WHEN SUBSTR(damage_crops,LENGTH(damage_crops), 1)='?' THEN 0<br/>    WHEN ( LEN(damage_crops) &gt; 1 <br/>      AND UPPER(SUBSTR(damage_crops,LENGTH(damage_crops), 1)) <br/>      IN ('H','K','M','B') ) THEN <br/>      TO_DOUBLE(SUBSTR(damage_crops,1,LENGTH(damage_crops)-1))<br/>    WHEN ( LEN(damage_crops) = 1 <br/>      AND UPPER(SUBSTR(damage_crops,LENGTH(damage_crops), 1)) <br/>      IN ('H','K','M','B')  ) THEN 0<br/>    WHEN damage_crops IS NULL THEN 0<br/>    WHEN damage_crops = '0' THEN 0<br/>  ELSE TO_DOUBLE(damage_crops)<br/>  END AS damage_crops_num<br/>, CASE<br/>    WHEN UPPER(SUBSTR(damage_crops,LENGTH(damage_crops), 1)) <br/>    IN ('H','K','M','B') THEN <br/>    DECODE (UPPER(SUBSTR(damage_crops,LENGTH(damage_crops), 1)) , 'H', TO_DOUBLE('100'), 'K', TO_DOUBLE('1000'), 'M', TO_DOUBLE('1000000'), 'B',TO_DOUBLE('1000000000'))<br/>  ELSE 1<br/>  END AS damage_crops_units<br/>, magnitude<br/>, magnitude_type<br/>, begin_lat<br/>, begin_lon<br/>, end_lat<br/>, end_lon<br/>FROM demo_db.public.noaa_ext;</span></pre><p id="11d0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="lr">最后</em>我们有了一个表格，里面有我们需要的所有数据，可以进行分析。</p><h2 id="6122" class="lx kv hi bd kw mg mh mi la mj mk ml le jg mm mn lg jk mo mp li jo mq mr lk ms bi translated">7.初步分析</h2><p id="5464" class="pw-post-body-paragraph ix iy hi iz b ja lm ij jc jd ln im jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">我们可以使用Python和Jupyter笔记本对我们现在可以访问的数据集进行一些详细的分析和研究。然而，为了快速获得早期视图，我们可以使用Snowflake worksheet web界面通过一些快速SQL查询找到很多信息。</p><p id="f872" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">风暴损害成本最高的州</strong></p><p id="dbf4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个相当直截了当的衡量标准，因为美元金额将按事件发生时的价值记录(即1950年的一美元价值远低于2020年)。然而，考虑到数据的数量，对于一个广泛的相对测量来说应该是足够好的。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="a3d4" class="lx kv hi lt b fi ly lz l ma mb">SELECT state<br/>     , round(sum((damage_property_num * damage_property_units) <br/>          + (damage_crops_num * damage_crops_units)))  cost_dollars<br/>FROM noaa_events<br/>GROUP BY state<br/>ORDER BY cost_dollars DESC<br/>LIMIT 10;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es nb"><img src="../Images/c0b5688103462cc4e49535246b169912.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/1*QOgkopjRzjbRxrELGzM0iA.png"/></div></figure><p id="0485" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们看看前3个州的位置，我们可以看到南部各州的集群:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nc"><img src="../Images/dd106800673a52372c7c31572dbc691a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*seEmznQvh_9IZA9e7h7jvQ.gif"/></div></div></figure><p id="e8b6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">造成伤害或死亡的十大事件</strong></p><p id="f7eb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">伤害和死亡是一个更为稳定的影响指标，不受年份的影响:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="db54" class="lx kv hi lt b fi ly lz l ma mb">SELECT event_type<br/>     , sum(injuries_direct + injuries_indirect <br/>             + deaths_direct + deaths_indirect) injuries_and_death<br/>     , sum(injuries_direct + injuries_indirect) injuries<br/>     , sum(deaths_direct + deaths_indirect) deaths<br/>FROM noaa_events<br/>GROUP BY event_type<br/>ORDER BY 2 DESC<br/>LIMIT 10;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es nd"><img src="../Images/30e9a82b302589a33b8bf1710487c400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*9Z07e0Ej35t76YwoUmkb-w.png"/></div></figure><p id="7140" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">龙卷风似乎是最严重的天气事件(就对人的直接影响而言)，与其他事件相比，其影响几乎大10倍。</p><p id="2011" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">数据质量和一致性</strong></p><p id="49fe" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们查看记录的事件数量以及随着时间的推移记录的事件类型数量，我们可以看到，随着时间的推移，记录的数据的细节和数量都发生了变化。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="6641" class="lx kv hi lt b fi ly lz l ma mb">SELECT to_char(begin_date_time, 'YYYY') year<br/>     , count(*) events<br/>     , count(distinct(event_type)) event_types<br/>FROM noaa_events<br/>GROUP BY to_char(begin_date_time, 'YYYY') <br/>ORDER BY 1;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ne"><img src="../Images/cc7ddd968db784d4e4b1ecf20f97d276.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/1*_IkFJsg2oyZqsFd4D5Aoww.png"/></div></figure><p id="e432" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">柱状图显示了一些令人惊讶的趋势:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es nf"><img src="../Images/56b1a2e211d9c4fa604906004f820e22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JUTR8lR4a6sCue_inE4WIQ.png"/></div></div></figure><p id="8d49" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在20世纪90年代中期，所收集数据的数量和详细程度似乎发生了巨大变化。这使得比较本世纪和上个世纪变得更加困难。</p><p id="316a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们把注意力集中在1955年记录的三种事件类型上，我们可以看到一组更加一致的数据被记录下来。</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="efb6" class="lx kv hi lt b fi ly lz l ma mb">SELECT DISTINCT event_type <br/>FROM noaa_events WHERE to_char(begin_date_time, 'YYYY') = 1955</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ng"><img src="../Images/03fc2f331fe63bd197cee626dd85336c.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/1*WRx1fPRYytbCAnu8PKFeRw.png"/></div></figure><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="67d7" class="lx kv hi lt b fi ly lz l ma mb">SELECT to_char(begin_date_time, 'YYYY') year<br/>    , count(DISTINCT(event_type)) event_types<br/>    , count(event_id)  event_count<br/>FROM noaa_events<br/>WHERE event_type in ('Tornado', 'Thunderstorm Wind', 'Hail')<br/>AND to_char(begin_date_time, 'YYYY') &gt; 1954<br/>GROUP BY to_char(begin_date_time, 'YYYY') <br/>ORDER BY 1;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es nh"><img src="../Images/bc189667df58b63f61b7ef06bc1a749f.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/format:webp/1*Kb8qRcbJp0SMJPYUkE23hw.png"/></div></figure><p id="feca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以看到，从1955年到今天，同样的三种事件类型一直被记录。</p><p id="78a3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们绘制一段时间内记录的这三个类别的事件数量，我们会看到以下情况:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ni"><img src="../Images/b322b7d9311f5230631cbbdd6e92d69c.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*dSaqCp-gGL5Mj3UIvWMwjQ.png"/></div></figure><p id="48ff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">很难确定这种上升趋势是由于报告准确性的提高还是事件数量的增加。</p><p id="9060" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">位于https://www.ncdc.noaa.gov/stormevents/faq.jsp<a class="ae jt" href="https://www.ncdc.noaa.gov/stormevents/faq.jsp" rel="noopener ugc nofollow" target="_blank">的美国国家环境信息中心提供了关于数据准确性和来源的更多细节</a></p><p id="d4d1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">长期趋势——龙卷风和雷暴</strong></p><p id="60c7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一种试图消除由数据记录中不断增加的努力所引起的任何不一致的方法是，只考虑一个事件(龙卷风)记录的死亡人数，该事件在很长一段时间内一直被记录，并且也是人员死亡和受伤的主要原因。</p><p id="3188" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们考虑每个事件的平均死亡人数和总死亡人数，随着时间的推移，没有明显的趋势——考虑到气候变化可能带来的影响，这可能不是我们所预期的:</p><pre class="kj kk kl km fd ls lt lu lv aw lw bi"><span id="f0e8" class="lx kv hi lt b fi ly lz l ma mb">SELECT to_char(begin_date_time, 'YYYY') year<br/>    , avg(deaths_direct) deaths_mean<br/>    , max(deaths_direct) deaths_max<br/>    , sum(deaths_direct) deaths_annual<br/>FROM noaa_events WHERE to_char(begin_date_time, 'YYYY') &gt; 1954<br/>AND event_type = 'Tornado'<br/>GROUP BY to_char(begin_date_time, 'YYYY')<br/>ORDER BY 1;</span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es nj"><img src="../Images/1dad6a1268c7abd4aca06366bf477b0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*IVDnxQSErnGyY1-EziqT8Q.png"/></div></figure><p id="4869" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这一初步分析表明:</p><ul class=""><li id="76b2" class="ju jv hi iz b ja jb jd je jg jw jk jx jo jy js jz ka kb kc bi translated">处理真实世界的数据很有挑战性，尤其是当数据是在很长一段时间内收集的时候，因为收集数据的方法和数据的质量也会随着时间的推移而改变，这需要在任何分析中加以考虑。</li><li id="e4a3" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">SQL和基于云的无服务器SQL分析工具(如雪花)使灵活清理和查询杂乱和不一致的数据集(如NOAA历史天气事件数据)变得更加容易。数据可以以可重复和可控的方式进行处理和分析。也更容易发现所提供数据质量的异常和不一致之处。</li><li id="aaa0" class="ju jv hi iz b ja kd jd ke jg kf jk kg jo kh js jz ka kb kc bi translated">在这项分析中，没有立即明显的“确凿证据”来证明或否定气候变化的影响，但天气事件对生活的影响以及它的财务影响是非常清楚的。同样明显的是，这种影响对于特定的地理区域来说更加显著。</li></ul><p id="4777" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是对实际数据集的更详细分析:</p><p id="54db" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae jt" href="https://github.com/edbullen/Snowflake" rel="noopener ugc nofollow" target="_blank">https://github.com/edbullen/Snowflake</a></p></div></div>    
</body>
</html>