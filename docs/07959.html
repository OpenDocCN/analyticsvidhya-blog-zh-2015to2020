<html>
<head>
<title>Getting Started with Google’s Data Loss Prevention API in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python开始使用Google的数据丢失防护API</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/getting-started-with-googles-data-loss-prevention-api-in-python-d90ee354047a?source=collection_archive---------2-----------------------#2020-07-13">https://medium.com/analytics-vidhya/getting-started-with-googles-data-loss-prevention-api-in-python-d90ee354047a?source=collection_archive---------2-----------------------#2020-07-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2016967dde04f5029e555fd5610877ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwQvOr-2sOBQ9OUSkwXZmQ.jpeg"/></div></div></figure><p id="07e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">云数据丢失防护(DLP)是谷歌必须提供的许多云安全产品之一，允许用户掩盖其数据中的个人身份信息(PII)。</p><p id="4141" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌的DLP可以通过GCP控制台或API使用；出于本文的目的，我将重点讨论后者。</p><p id="43ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您的数据包括电子邮件地址等PII，DLP提供了几种方法来掩盖这些信息。例如，我们可以用标签替换PII:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/18eddc4a81ec547fdb195a48311c2fdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g79pDR-5AJOtesJCWGr1UA.png"/></div></div></figure><p id="bc53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者，我们可以通过用它的[信息类型]替换它来屏蔽信息:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/bac26af96e4328ec77b4d40f1e39dc54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bEXkG1YHqqZ1OFeUZ7PRog.png"/></div></div></figure><p id="372e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看如何用Python和<a class="ae ju" href="https://cloud.google.com/dlp/docs/reference/rest" rel="noopener ugc nofollow" target="_blank"> DLP API </a>实现这一点。</p><p id="83e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第一步:认证</strong></p><p id="7c86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们首先通过提供我们的GCP凭据进行身份验证。一个简单的方法是通过<a class="ae ju" href="https://cloud.google.com/iam/docs/creating-managing-service-accounts" rel="noopener ugc nofollow" target="_blank">创建一个服务账户</a>并将其添加为环境变量(使用Python的OS模块)。</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="9d99" class="ka kb hi jw b fi kc kd l ke kf">import os</span><span id="19ab" class="ka kb hi jw b fi kg kd l ke kf">os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = 'data-loss-prevention-test-74b082472d34.json'</span><span id="25e1" class="ka kb hi jw b fi kg kd l ke kf">print('Credentials from environ: {}'.format(os.environ.get('GOOGLE_APPLICATION_CREDENTIALS')))</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/0c74aed4e28ccaa123dd2fd5121f11d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sO_hbEZkJbQPdI9WvMzi9A.png"/></div></div></figure><p id="26d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">或者，如果您已经启动并运行了gcloud命令行接口<a class="ae ju" href="https://cloud.google.com/sdk/gcloud" rel="noopener ugc nofollow" target="_blank">,以下命令将允许您进行身份验证:</a></p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="30a5" class="ka kb hi jw b fi kc kd l ke kf">gcloud auth application-default login</span></pre><p id="287c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第二步:查阅谷歌文档，找到适用的DLP函数</strong></p><p id="0537" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在是时候使用DLP API了。下面是在Google的<a class="ae ju" href="https://cloud.google.com/dlp/docs/deidentify-sensitive-data#specifying_detection_criteria" rel="noopener ugc nofollow" target="_blank">文档</a>中找到的一个Python函数。该函数使用google.cloud.dlp库，读取一个文本字符串(<em class="ki"> input_str参数</em>)，并打印出基于info_types参数屏蔽的文本。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kj"><img src="../Images/d5fc20e28d78f35bf6f0444765ddf513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*murLmsvvq7myQ_0aByovZQ.png"/></div></div></figure><p id="abe4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我对上面的函数做的一个修改在最后一行，在下面的截图中突出显示。这将返回<em class="ki"> response.item.value，而不仅仅是打印它。</em></p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/e0534e10888a8edbb5edb8ae60ef62d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z1RTAF6jsDl1T_jFmFdjNw.png"/></div></div></figure><p id="3301" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是该函数，带有上面的编辑:</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="c722" class="ka kb hi jw b fi kc kd l ke kf">def deidentify_with_mask(<br/>    project, input_str, info_types, masking_character=None, number_to_mask=0<br/>):<br/>    """Uses the Data Loss Prevention API to deidentify sensitive data in a<br/>    string by masking it with a character.<br/>    Args:<br/>        project: The Google Cloud project id to use as a parent resource.<br/>        input_str: The string to deidentify (will be treated as text).<br/>        masking_character: The character to mask matching sensitive data with.<br/>        number_to_mask: The maximum number of sensitive characters to mask in<br/>            a match. If omitted or set to zero, the API will default to no<br/>            maximum.<br/>    Returns:<br/>        None; the response from the API is printed to the terminal.<br/>    """</span><span id="3da7" class="ka kb hi jw b fi kg kd l ke kf"># Import the client library<br/>    import google.cloud.dlp</span><span id="27de" class="ka kb hi jw b fi kg kd l ke kf"># Instantiate a client<br/>    dlp = google.cloud.dlp_v2.DlpServiceClient()</span><span id="52b5" class="ka kb hi jw b fi kg kd l ke kf"># Convert the project id into a full resource id.<br/>    parent = dlp.project_path(project)</span><span id="05cb" class="ka kb hi jw b fi kg kd l ke kf"># Construct inspect configuration dictionary<br/>    inspect_config = {<br/>        "info_types": [{"name": info_type} for info_type in info_types]<br/>    }</span><span id="ac40" class="ka kb hi jw b fi kg kd l ke kf"># Construct deidentify configuration dictionary<br/>    deidentify_config = {<br/>        "info_type_transformations": {<br/>            "transformations": [<br/>                {<br/>                    "primitive_transformation": {<br/>                        "character_mask_config": {<br/>                            "masking_character": masking_character,<br/>                            "number_to_mask": number_to_mask,<br/>                        }<br/>                    }<br/>                }<br/>            ]<br/>        }<br/>    }</span><span id="3a6c" class="ka kb hi jw b fi kg kd l ke kf"># Construct item<br/>    item = {"value": input_str}</span><span id="b594" class="ka kb hi jw b fi kg kd l ke kf"># Call the API<br/>    response = dlp.deidentify_content(<br/>        parent,<br/>        inspect_config=inspect_config,<br/>        deidentify_config=deidentify_config,<br/>        item=item,<br/>    )</span><span id="bd0c" class="ka kb hi jw b fi kg kd l ke kf"># Print out the results.<br/>    print(response.item.value)<br/>    <br/>    <strong class="jw hj">return response.item.value</strong></span></pre><p id="6fd4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">info_types参数用于指定想要屏蔽的PII数据类型。谷歌有一个长长的<a class="ae ju" href="https://cloud.google.com/dlp/docs/infotypes-reference" rel="noopener ugc nofollow" target="_blank">列表</a>列出了你可以屏蔽的信息类型，从普通的信息类型如<em class="ki"> PERSON_NAME </em>和<em class="ki"> EMAIL_ADDRESS </em>到更具体的信息类型如特定国家的护照号码(即<em class="ki"> FRANCE_PASSPORT </em>)。</p><p id="f32a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">出于本教程的目的，我的信息类型如下:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kl"><img src="../Images/f945579d2b0f6db419eb04930723fca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgwNiPlHGDe6tRpVPBkjow.png"/></div></div></figure><p id="8c18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我们尝试对包含敏感信息的字符串运行deidentify_with_mask函数时，会返回以下内容:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/7d6e0d5536dfac048e0801c1044d23aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6F0POrMq8Jtz6sR1CdcY_w.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">DLP会隐藏此人的姓名、电话号码和街道地址</figcaption></figure><p id="0091" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第三步:对PII数据运行DLP函数</strong></p><p id="0fa1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">既然我们已经正确连接到DLP API，我们就可以在包含敏感数据的数据集上运行它了。</p><p id="1027" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们读入一些数据供DLP屏蔽:</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="dd38" class="ka kb hi jw b fi kc kd l ke kf">import pandas as pd</span><span id="637b" class="ka kb hi jw b fi kg kd l ke kf">df = pd.read_csv('test_pii_data.csv')</span></pre><p id="c231" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ki">仅供参考:该数据集是随机生成的</em> <a class="ae ju" href="https://www.generatedata.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ki">数据集</em> </a> <em class="ki">，其中包含姓名、电话号码和电子邮件地址，以及财富500强总部的地址列表(DLP不会识别或屏蔽虚假地址，因此随机生成的位置不适用于本演示)。</em></p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kl"><img src="../Images/5f4f31cf71f65370d909be8a9a0eb637.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mMY_PB3QB_LP_dXnInDdWw.png"/></div></div></figure><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kr"><img src="../Images/4cf93ac8d6b3e9047fb369996cbad926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ib7Ejw_NMYsakOHuRxLgw.png"/></div></div></figure><p id="cece" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我们在上面看到的，<em class="ki"> Unmasked_Text </em>列包含我们的姓名、地址、电子邮件和电话号码数据，这些数据被连接在一起以模拟实际的文本数据。现在，让我们将DLP函数应用于数据集:</p><pre class="jp jq jr js fd jv jw jx jy aw jz bi"><span id="f6d5" class="ka kb hi jw b fi kc kd l ke kf">df['Content_masked'] = df.apply(lambda row: deidentify_with_mask(row['Content']) ,axis=1)</span></pre><p id="b86f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们返回一个数据集，其中一个新列<em class="ki"> Content_Masked，</em>包含我们的原始文本数据，所有敏感信息都被屏蔽。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/69de547bea204c14fdd709237a906654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I48JeaqSLPTu4ND14KE7Bg.png"/></div></div></figure><p id="0087" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是用谷歌的DLP API掩盖你的PII有多容易。结果总体上非常好，无论句子结构如何，数据的敏感信息都被正确地屏蔽了。</p><p id="f92d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在实践中，通用信息类型有时会导致一些PII未被捕获，包括不太传统的名称(即<em class="ki"> Tiger </em>)或拼写错误的地址(即<em class="ki">405 Lexington</em><strong class="is hj"><em class="ki">e</em></strong><em class="ki">Ave)。</em>这可以通过使用<a class="ae ju" href="https://cloud.google.com/dlp/docs/creating-custom-infotypes" rel="noopener ugc nofollow" target="_blank">定制的</a>信息类型来避免，这允许用户针对其使用情形更好地优化DLP。</p><p id="991c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望你喜欢这篇文章，并请让我知道任何问题。回购可以在<a class="ae ju" href="https://github.com/stefangouyet/cloud_dlp_intro" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p></div></div>    
</body>
</html>