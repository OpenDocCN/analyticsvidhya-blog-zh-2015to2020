<html>
<head>
<title>Apache Spark: Optimization Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Spark:优化技术</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/apache-spark-optimization-techniques-3e984444ea07?source=collection_archive---------11-----------------------#2020-06-08">https://medium.com/analytics-vidhya/apache-spark-optimization-techniques-3e984444ea07?source=collection_archive---------11-----------------------#2020-06-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a1e9cb14d11f9fcc356c719ebe5945e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n_-zwFU0wmy2G9Zmte7d-g.png"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="aeb3" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj"> Apache Spark </strong>是目前市场上知名的大数据处理引擎。它在很多用例中都有帮助，从实时处理(火花流)到图形处理(GraphX)。作为一个机构，对星火科技的投资已经成为必然之举。对收养的狂热源于两个主要因素，</p><ol class=""><li id="34a9" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">大型社区以及与其他知名项目的良好集成</li><li id="fc7c" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">易用性(API使用起来非常简单和优雅)</li></ol></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="32c5" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">与所有大数据项目一样，仅仅使用它们并不能解决您的问题。为了优化您的工作负载，您需要了解它的复杂性及其基本架构。</p><p id="4a52" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我试图根据我的学习列出一些Spark批处理优化，希望这有助于微调您的过程。:)</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="2094" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">介绍</h1><p id="757e" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">要理解Spark及其用例，请通读他们的<a class="ae lm" href="https://spark.apache.org/docs/latest/index.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>。开源项目的最佳文档之一。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/77d6faea48dc4c780df74e1e3ad73ee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tDFvMHX5YXTYR3EcBaNEZw.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">演职员表:<a class="ae lm" href="https://www.edureka.co/blog/spark-architecture/#:~:text=Spark%20Architecture%20Overview,Resilient%20Distributed%20Dataset%20(RDD)" rel="noopener ugc nofollow" target="_blank"> Edureka Page </a></figcaption></figure><p id="b08f" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">为了更快地理解——在阅读这篇文章之前，</p><ol class=""><li id="0f52" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated"><a class="ae lm" href="https://databricks.com/spark/getting-started-with-apache-spark" rel="noopener ugc nofollow" target="_blank">数据块</a></li><li id="4ad7" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated"><a class="ae lm" href="https://www.edureka.co/blog/spark-tutorial/" rel="noopener ugc nofollow" target="_blank">爱德华卡</a></li><li id="26f6" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated"><a class="ae lm" href="https://www.tutorialspoint.com/apache_spark/apache_spark_introduction.htm" rel="noopener ugc nofollow" target="_blank">辅导点</a></li></ol></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h1 id="101f" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">最佳化</h1><p id="0103" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">让我们跳到优化，</p><ol class=""><li id="c1d3" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">窄转换比宽转换更好</li><li id="1724" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">对结构化数据使用列数据格式</li><li id="42bd" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">在源位置对数据进行分区，以提高整体性能</li><li id="e6cb" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">将数据帧转换为RDD数据代价高昂，请不惜一切代价避免</li><li id="e3bf" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">对所有较小的表连接使用<strong class="iz hj">广播</strong>提示</li><li id="9452" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">为你的程序使用熟知的<strong class="iz hj">火花配置参数</strong></li></ol></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="cdad" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">窄转换比宽转换更好</h2><p id="7b79" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated"><strong class="iz hj">洗牌</strong>意味着跨分区移动数据——有时也跨节点移动，这会导致数据通过网络移动</p><p id="9dd6" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj">窄转换</strong>是<em class="mk"> map() </em>、<em class="mk"> filter() </em>函数的结果，这些计算数据位于单个分区上，这意味着在执行窄转换时分区之间不会有任何数据移动</p><p id="d459" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">鉴于，<strong class="iz hj">更广泛的转换</strong>是<em class="mk"> groupByKey() </em>和<em class="mk"> reduceByKey() </em>函数的结果，这些函数计算驻留在许多分区上的数据，这意味着将在分区之间移动数据以执行更广泛的转换</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div class="er es ml"><img src="../Images/a42c7571b39978be2870a737250b0359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*VzAzk1WNSmzhE0vnrkGUTQ.png"/></div></figure><p id="8f31" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">由于数据驻留在同一个分区上，执行窄转换非常快。因此，尝试在更大范围的转换(洗牌)之前执行大多数小范围的转换</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="bf35" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">对结构化数据使用列数据格式</h2><p id="a807" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">Spark数据帧类似于RDBMS中的表。它包含数据的模式，这有助于catalyst optimiser了解数据的确切大小，进而有助于在特定列上执行计算，而不是读取整个行</p><p id="e5fa" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">柱状形式，如拼花地板、ORC等。提供了额外的优化，将过滤器下推到文件，而不是将完整的数据加载到内存中，然后只选择所需的列</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="4782" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">在源位置对数据进行分区，以提高整体性能</h2><p id="7737" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">source中存在的数据分区数是spark并行执行的任务数。除非我们明确执行repartition()、coalesce()或任何更广泛的转换，否则并行任务的数量将不会改变。这将有助于使处理更接近较小的数据，并且比在一个大数据集上更快地执行任务</p><p id="f14b" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">基于数据的域和用途，对数据进行分区，以便更好地查询和处理。有时<em class="mk">重新分区(或)合并</em>是不可避免的，如果数据在某些转换后有偏差，比如过滤一些数据模式。在下面的示例中，在写入HDFS之前，我们执行了重新分区，这使得所有操作都更快，因为没有数据被打乱。为了提高存储中的写入效率，我们执行了重新分区。确保在DAG中对进一步处理有效的阶段执行重新分区。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/a078ae2c76131f50861fc7e8e2316243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5F37G3RbJAF1YrCzk8Ni_w.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx translated">源数据分区</figcaption></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="9173" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">将数据帧转换为RDD数据代价高昂，请不惜一切代价避免</h2><p id="a73c" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">有一个将数据帧转换为RDD并在其上执行处理的选项。但是这个手术很贵，要不惜一切代价避免！！</p><p id="f15f" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">假设我们有以下数据，</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mn mo l"/></div></figure><p id="5531" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我模拟了直接在数据帧上执行相同的操作，而不是将其转换成RDD后再执行</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mn mo l"/></div></figure><pre class="lo lp lq lr fd mp mq mr ms aw mt bi"><span id="4c6c" class="lw kk hi mq b fi mu mv l mw mx">Running groupBy using [df]: Time take: 8705 ms<br/>Running groupBy using [rdd]: Time take: 12122 ms</span></pre><p id="dda6" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">使用本地spark会话和所有默认配置在500万行上执行</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="ce14" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">对所有较小的表连接使用<strong class="ak">广播</strong>提示</h2><p id="e56d" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">对于大型表(事实)与相对较小的表(维度)之间的连接，广播连接可能非常有效，这些表可用于执行<strong class="iz hj">星型模式连接</strong>。它可以避免通过网络发送大表的所有数据</p><p id="c9c9" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这将有助于将表传输给执行者，而不是将数据混在一起连接，这将增加总的执行成本</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mn mo l"/></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="f5cc" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">为你的程序使用消息灵通的<strong class="ak">火花配置参数</strong></h2><p id="0c62" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated"><a class="ae lm" href="https://spark.apache.org/docs/latest/configuration.html" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj">火花配置</strong> </a> <strong class="iz hj"> </strong>在我们进行任何优化的时候，大多数时候都是罪魁祸首。如果配置不好，即使最高效的代码也会降低执行速度。</p><p id="7e8a" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">例如，如果我们有一个巨大的数据—有200个分区。如果每个分区的大小达到10G。</p><p id="6e64" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">现在，如果我们配置<code class="du my mz na mq b">--executor-memory 2G</code>，那么每个分区都不适合内存——这将在执行过程中导致大量的GC。因此，火花配置是寻找优化的相当重要的参数。</p><p id="d758" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj">关键配置:</strong></p><ul class=""><li id="4522" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju nb kb kc kd bi translated">在群集中运行时，默认情况下启用动态分配，以便有效利用空闲节点</li><li id="1608" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju nb kb kc kd bi translated">确保每个内核都有足够的执行器内存</li></ul><pre class="lo lp lq lr fd mp mq mr ms aw mt bi"><span id="ab77" class="lw kk hi mq b fi mu mv l mw mx">(executor-memory / no.of cores) &gt; per partition data size <br/>// But not at all times, depends on your data and your code</span></pre><ul class=""><li id="1c95" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju nb kb kc kd bi translated">仅仅增加执行者的数量并不能保证速度</li></ul><pre class="lo lp lq lr fd mp mq mr ms aw mt bi"><span id="1e2d" class="lw kk hi mq b fi mu mv l mw mx">(no.of executors * no.of cores) is the parallelism</span></pre><ul class=""><li id="24b6" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju nb kb kc kd bi translated">序列化和压缩有助于我们混洗或保存数据块。默认情况下，使用“Kryo”序列化并启用压缩。</li><li id="dfca" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju nb kb kc kd bi translated"><code class="du my mz na mq b">spark.sql.shuffle.partitions</code>用于对连接或聚合的数据进行洗牌。因此，请根据您的数据使用所需的并行度(默认值为200，对于大数据来说非常少)</li></ul></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="4291" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">结论</h2><p id="7494" class="pw-post-body-paragraph ix iy hi iz b ja lh jc jd je li jg jh ji lj jk jl jm lk jo jp jq ll js jt ju hb bi translated">虽然<strong class="iz hj"> Spark </strong>是非常流行和突出的大数据处理引擎，但优化始终是一个具有挑战性的话题。因此，理解底层数据和您的过程中所有可能的spark配置是非常重要的。</p><p id="e660" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">没有<em class="mk">银弹</em> <strong class="iz hj"> </strong>为任何过程配置火花参数。这完全取决于您的数据和代码。建议在为您的程序决定优化技术之前执行不同的基准测试</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="697a" class="lw kk hi bd kl lx ly lz kp ma mb mc kt ji md me kx jm mf mg lb jq mh mi lf mj bi translated">参考/代码</h2><div class="nc nd ez fb ne nf"><a href="https://spark.apache.org/docs/latest/configuration.html" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">火花配置</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">火花提供了三个位置来配置系统:火花属性控制大多数应用参数，可以…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">spark.apache.org</p></div></div><div class="no l"><div class="np l nq nr ns no nt io nf"/></div></div></a></div><div class="nc nd ez fb ne nf"><a href="https://jaceklaskowski.gitbooks.io/mastering-spark-sql/" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">介绍</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">欢迎阅读Spark SQL在线手册的内部内容！我很高兴你能来这里，希望你会喜欢探索…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">jaceklaskowski.gitbooks.io</p></div></div></div></a></div><div class="nc nd ez fb ne nf"><a href="https://github.com/subashprabanantham/hakuna-matata/tree/master/spark-optimization" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab dw"><div class="nh ab ni cl cj nj"><h2 class="bd hj fi z dy nk ea eb nl ed ef hh bi translated">subashprabanantham/hakuna-matata</h2><div class="nm l"><h3 class="bd b fi z dy nk ea eb nl ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nn l"><p class="bd b fp z dy nk ea eb nl ed ef dx translated">github.com</p></div></div><div class="no l"><div class="nu l nq nr ns no nt io nf"/></div></div></a></div></div></div>    
</body>
</html>