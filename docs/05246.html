<html>
<head>
<title>Moving Average using DAX (Power BI)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用DAX的移动平均线(幂BI)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/moving-average-using-dax-power-bi-413a31099091?source=collection_archive---------1-----------------------#2020-04-15">https://medium.com/analytics-vidhya/moving-average-using-dax-power-bi-413a31099091?source=collection_archive---------1-----------------------#2020-04-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/464601073e5178719a8346fbfd2d68af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qFlrflYdFUAV4w2RAoAV9g.png"/></div></div></figure><div class=""/><p id="0d8c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最初发布</p><div class="hh hi ez fb hj jo"><a href="https://www.vivran.in/post/moving-average-using-dax" rel="noopener  ugc nofollow" target="_blank"><div class="jp ab dw"><div class="jq ab jr cl cj js"><h2 class="bd hu fi z dy jt ea eb ju ed ef hs bi translated">使用DAX的移动平均线</h2><div class="jv l"><h3 class="bd b fi z dy jt ea eb ju ed ef dx translated">移动平均法使用时间序列中最近k个数据值的平均值。我们称之为移动…</h3></div><div class="jw l"><p class="bd b fp z dy jt ea eb ju ed ef dx translated">www.vivran.in</p></div></div><div class="jx l"><div class="jy l jz ka kb jx kc hp jo"/></div></div></a></div><p id="70df" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们考虑一组销售数据。目标是分析每天的销售量。如果我们只是构建一个按天划分销售额的报告，结果很难理解。</p><p id="b141" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是每日总销售额的时间序列:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="bb2a" class="km kn ht ki b fi ko kp l kq kr">Total Sales = SUM(Orders[Sales])<br/></span></pre><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ks"><img src="../Images/2c5ffeda3ca6ee6832f032fd9dd71248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXMMTdF4IgtXnjVNiWszaA.png"/></div></div></figure><p id="f607" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上图显示了总销售额的巨大变化和水平趋势模式。</p><p id="6f54" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在统计数据建模中，一种常见的方法是计算某段时间内高于一天水平的平均值，特别是当时间序列在一段时间内显示水平模式时。它也被称为移动平均线。</p><h1 id="116f" class="kt kn ht bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">什么是均线？</h1><p id="1032" class="pw-post-body-paragraph iq ir ht is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated"><strong class="is hu"> <em class="lv">移动平均值</em> </strong>方法使用时间序列中最近的<em class="lv"> k </em>数据值的平均值。我们称之为移动，是因为每当一个新的观察值对时间序列可用时，它就用最新的值替换等式中最早的观察值，并计算新的平均值。因此，计算平均值的周期随着每个随后的周期而变化或移动。</p><p id="edd8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是3期移动平均线的示例(<em class="lv"> k = </em> 3)</p><figure class="kd ke kf kg fd hk er es paragraph-image"><div class="er es lw"><img src="../Images/7a0d342678a14552b9b5f6bad0c49d1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/1*31cJNiVqp6yC5FK0N9mVvQ.gif"/></div></figure><h1 id="af64" class="kt kn ht bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">计算功率BI中的移动平均值</h1><p id="c425" class="pw-post-body-paragraph iq ir ht is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">这里的目标是计算过去30天的移动平均值。</p><p id="58ae" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，<em class="lv"> k = </em> 30</p><p id="61fc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">专家建议在数据模型中至少创建一个日历表。在当前模型中，我已经创建了一个日历表并建立了关系:</p><figure class="kd ke kf kg fd hk er es paragraph-image"><div class="er es lx"><img src="../Images/f80a26e52963fee174286b08230514ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*V7nlvuClTpy5AiZPOSNwfg.png"/></div></figure><p id="622a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以参考下面这篇关于<a class="ae ly" href="https://community.powerbi.com/t5/Community-Blog/Time-Intelligence-Calendar-Table/ba-p/1000565" rel="noopener ugc nofollow" target="_blank">日历表</a>的文章。</p><p id="f688" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，使用以下代码创建一个度量:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="0093" class="km kn ht ki b fi ko kp l kq kr">Avg Sales (MA 30 days) =</span><span id="44ac" class="km kn ht ki b fi lz kp l kq kr">//Selecting the date in the range</span><span id="5a90" class="km kn ht ki b fi lz kp l kq kr">VAR _LastDate =</span><span id="6b43" class="km kn ht ki b fi lz kp l kq kr">MAX ( dtCalendar[Date] )</span><span id="1c2d" class="km kn ht ki b fi lz kp l kq kr">//Defining the duration to be considered for average calculation(k)</span><span id="cf29" class="km kn ht ki b fi lz kp l kq kr">VAR _Duration = 30</span><span id="4c70" class="km kn ht ki b fi lz kp l kq kr">//Filtering the Calendar Table for the defined range</span><span id="adf5" class="km kn ht ki b fi lz kp l kq kr">VAR _CalculationPeriod =</span><span id="ca92" class="km kn ht ki b fi lz kp l kq kr">FILTER (</span><span id="e02e" class="km kn ht ki b fi lz kp l kq kr">ALL ( dtCalendar ), — Removing any external filters context applied</span><span id="1bf9" class="km kn ht ki b fi lz kp l kq kr">AND (</span><span id="5ead" class="km kn ht ki b fi lz kp l kq kr">dtCalendar[Date] &gt; _LastDate — _Duration, — the range start date</span><span id="c7f7" class="km kn ht ki b fi lz kp l kq kr">dtCalendar[Date] &lt;= _LastDate — the range end date</span><span id="3081" class="km kn ht ki b fi lz kp l kq kr">)</span><span id="48fd" class="km kn ht ki b fi lz kp l kq kr">)</span><span id="4ccd" class="km kn ht ki b fi lz kp l kq kr">//Calculating the Moving Average</span><span id="7a37" class="km kn ht ki b fi lz kp l kq kr">VAR _MovingAverage =</span><span id="af7f" class="km kn ht ki b fi lz kp l kq kr">IF (</span><span id="6706" class="km kn ht ki b fi lz kp l kq kr">COUNTROWS ( _CalculationPeriod ) &gt;= _Duration, — Condition to check minimum number of days for the calculation.</span><span id="2c47" class="km kn ht ki b fi lz kp l kq kr">CALCULATE (</span><span id="8a81" class="km kn ht ki b fi lz kp l kq kr">AVERAGEX(dtCalendar,[Total Sales]), — Calculating average of the total sales amount</span><span id="d0c6" class="km kn ht ki b fi lz kp l kq kr">_CalculationPeriod</span><span id="31e3" class="km kn ht ki b fi lz kp l kq kr">)</span><span id="1766" class="km kn ht ki b fi lz kp l kq kr">)</span><span id="5668" class="km kn ht ki b fi lz kp l kq kr">RETURN</span><span id="6352" class="km kn ht ki b fi lz kp l kq kr">_MovingAverage</span></pre><p id="b6d8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该公式首先确定最后可见的日期；在视觉化中，因为视觉化设定的筛选内容是在日期层级，所以它会传回选取的日期(VAR _LastDate)</p><p id="176c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，它创建一个集合，包含最后一个日期和最后一个日期减去30天之间的所有日期(VAR _CalculationPeriod)。</p><p id="2b5c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，最后一步是在CALCULATE中使用这个时间段作为过滤器，以便最终的AVERAGEX在30天内迭代，计算每日销售额的平均值。</p><p id="5463" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">计算结果如下图所示:</p><figure class="kd ke kf kg fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ma"><img src="../Images/11d81074cb56122de79a4eb36364c4f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mZVC3sfpahU854INOBc9sw.png"/></div></div></figure><p id="4fff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">均线比日线销售更平滑，简化了趋势分析过程。</p><p id="3809" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以在这里找到示例pbix文件<a class="ae ly" href="https://vivranin-my.sharepoint.com/:u:/g/personal/vivek_ranjan_vivran_in/EZFIRiLR_ulLlTE5_l-5UWYBh1VWA66j15gcxJZ-uq3L5Q?e=iOyCae" rel="noopener ugc nofollow" target="_blank"/></p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="e618" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lv">我写关于</em><a class="ae ly" href="https://www.vivran.in/my-blog/categories/excel" rel="noopener ugc nofollow" target="_blank"><em class="lv">MS Excel</em></a><em class="lv"/><a class="ae ly" href="https://www.vivran.in/my-blog/categories/powerquery" rel="noopener ugc nofollow" target="_blank"><em class="lv">权力查询</em></a><em class="lv"/><a class="ae ly" href="https://www.vivran.in/my-blog/categories/powerbi" rel="noopener ugc nofollow" target="_blank"><em class="lv">权力毕</em></a><em class="lv"/><a class="ae ly" href="https://www.vivran.in/my-blog/categories/power-pivot" rel="noopener ugc nofollow" target="_blank"><em class="lv">权力中枢</em></a><em class="lv"/><a class="ae ly" href="https://www.vivran.in/my-blog/categories/dax" rel="noopener ugc nofollow" target="_blank"><em class="lv">DAX</em></a><em class="lv"/><a class="ae ly" href="https://www.vivran.in/my-blog/categories/data-analytics" rel="noopener ugc nofollow" target="_blank"><em class="lv">数据分析【数据</em></a></p><p id="2996" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ly" href="https://twitter.com/imvivran" rel="noopener ugc nofollow" target="_blank"> @imVivRan </a></p></div></div>    
</body>
</html>