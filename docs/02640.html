<html>
<head>
<title>Simple Method to choose Number of Partitions in Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spark中选择分区数的简单方法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/simple-method-to-choose-number-of-partitions-in-spark-75315c636a94?source=collection_archive---------1-----------------------#2019-12-27">https://medium.com/analytics-vidhya/simple-method-to-choose-number-of-partitions-in-spark-75315c636a94?source=collection_archive---------1-----------------------#2019-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6d14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文结束时，您将能够分析您的spark作业，并确定您是否拥有适用于您的Spark环境的正确配置设置，以及您是否利用了所有资源。</p><p id="d55c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每当你从事spark工作时，你应该考虑两件事。</p><ul class=""><li id="f458" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">避免溢出</li><li id="765b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过利用所有内核最大限度地提高并行性。</li></ul><p id="7bc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这两者是相辅相成的，你应该能够充分利用它们。</p><p id="97bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">溢出:<br/> </strong>每当出现洗牌，数据必须四处移动，而执行器无法将数据保存在其内存中时，就会发生溢出。所以它必须使用存储器将数据保存在内存中一段时间。<br/>如果分区大小不对，就会出现溢出。务必避免溅出。对于读取50 GB，溢出可能高达500 GB。</p><p id="9f5b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">分区:</strong></p><p id="32c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从一些基本的默认和期望的火花配置参数开始。</p><ul class=""><li id="6165" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">默认火花混洗分区— 200</li><li id="9951" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">期望的分区大小(目标大小)= 100或200 MB</li><li id="8217" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">分区数量=输入阶段数据大小/目标大小</li></ul><p id="c72f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是如何选择分区计数的示例。</p><p id="e084" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例1 </strong>:</p><ul class=""><li id="b56e" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">输入阶段数据100GB</li><li id="382a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">目标大小= 100MB</li><li id="e709" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">核心数= 1000</li><li id="9537" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">最佳分区数= 100，000 MB / 100 = 1000个分区</li><li id="51ff" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">spark . conf . set(" spark . SQL . shuffle . partitions "，1000)</li><li id="266f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><strong class="ih hj">分区数量不应少于核心数量</strong></li></ul><p id="4b71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例二</strong>:</p><ul class=""><li id="ab98" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">输入大小数据— 100GB</li><li id="a8de" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">目标大小= 100MB</li><li id="bf62" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">核心数= 96</li><li id="15fc" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">最佳分区数= 100，000 MB / 100 MB = 1000个分区</li><li id="9591" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">spark . conf . set(" spark . SQL . shuffle . partitions "，960)</li><li id="74c8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">当分区数大于核心数时，分区数应该是核心数的一个因子。否则，我们在最后一次运行中就不会使用内核。</li></ul><p id="2e3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">输入:</strong></p><ul class=""><li id="9200" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">读取与您的核心数匹配的分区数的输入数据</li><li id="6826" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">spark . conf . set(" spark . SQL . files . maxpartitionbytes "，1024 * 1024 * 128)-将分区大小设置为128 MB</li><li id="0a7c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">应用此配置，然后读取源文件。它会将文件分割成128MB的倍数</li><li id="5752" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">验证df.rdd.partitions.size</li><li id="120e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过这样做，我们将能够非常快地读取文件</li></ul><p id="8dba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">输出:</strong></p><ul class=""><li id="4adc" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">保存数据时，尽量利用所有内核。</li><li id="8be7" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果分区的数量与内核数量相匹配，或者是内核数量的一个因素，我们将实现并行性，从而减少时间。</li></ul><p id="c64c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">外卖:</strong></p><ul class=""><li id="33d2" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">分区太少会导致并发性降低。</li><li id="cd6e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">分区太多会导致很多洗牌。</li><li id="3fdf" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">分区数量通常在100到10，000之间。</li><li id="ac6f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">下限:群集中至少2倍数量的核心。</li><li id="b5ac" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">上限:确保任务至少需要100ms。</li></ul></div></div>    
</body>
</html>