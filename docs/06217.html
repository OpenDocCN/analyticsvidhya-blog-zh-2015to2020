<html>
<head>
<title>SCD Type2 Implementation in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的SCD Type2实现</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/scd-type2-implementation-in-python-95bb08878ce2?source=collection_archive---------0-----------------------#2020-05-15">https://medium.com/analytics-vidhya/scd-type2-implementation-in-python-95bb08878ce2?source=collection_archive---------0-----------------------#2020-05-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fa79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文的目标是理解使用Python数据处理库Pandas实现SCD Type2。</p><p id="8295" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是SCD？</strong></p><p id="17f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在实施SCD之前，了解SCD是非常重要的。<strong class="ih hj"> SCD </strong>代表<strong class="ih hj">缓变尺寸</strong>。SCD是数据仓库(DWH)操作中最常见和最完整的概念之一。</p><p id="4af4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">缓变维度是数据缓慢变化的维度，而不是按时间规律变化的维度。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/7730e57c3314c33849a4818b09909ede.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5z6aWCeXJR8oCpTzgR5NVQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">DWH建筑图</figcaption></figure><p id="220e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是SCD Type2？</strong></p><p id="f2c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实施SCD类型2方法，其中在维度表中维护历史数据。这种方法不会用新数据覆盖维度表中的旧数据，也许它会使用标志或时间戳保持以前的数据和新数据的正确版本。</p><p id="939e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以为了更好地理解这个过程，我必须把这篇文章分成两部分。然而，实际上只需编写一个代码就可以同时处理这两种情况。</p><p id="4503" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第1部分:</strong>第一次数据加载，我们有一个源表和一个空的目标表，所有的数据都是新的，需要加载到OLAP目标。</p><p id="caf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第2部分:</strong>满足现有数据和新记录的变化。例如，如果源中的实体发生变化，并且目标中存在特定记录，则观察到变化，并且将这些变化插入到具有更新版本的目标中，并且先前记录的版本发生变化，这被认为是历史记录。</p><p id="9ce3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第1部分和第2部分共同定义了<strong class="ih hj"> SCD类型2 </strong>。</p><p id="dd4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用案例简介:</strong>ABC公司有一个年中评估流程，一些最优秀的员工获得了加薪，一些新员工也加入了进来。因此，对于加薪的现有员工，在维护历史数据的同时更新他们的工资，对于新员工，插入新记录。</p><p id="bed7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很多功能方面，对吗？现在是时候为我们理解的功能编码了。好了，让我们跳到<strong class="ih hj">“编码”</strong>部分。</p><p id="6a21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一部分。初始数据加载，目标表中没有记录</strong></p><p id="3b67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步。导入所需的库和数据提取。</p><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="2b0f" class="jy jz hi ju b fi ka kb l kc kd">import pandas as pd<br/>from sqlalchemy import create_engine<br/>engine = create_engine(‘oracle://scott:scott@orcl’, echo=False)</span><span id="930a" class="jy jz hi ju b fi ke kb l kc kd">emp_df=pd.read_sql_query(‘select * from emp_src’,engine)<br/>emp_df.head(20)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kf"><img src="../Images/50d650bf8111b8e8530ff83feadb9739.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*2TnY5Rymjoi-TGetAJ0nOQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">源记录</figcaption></figure><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="bb8f" class="jy jz hi ju b fi ka kb l kc kd">#query target table<br/>emp_delta_df=pd.read_sql_query(‘select * from emp_scd2’,engine)<br/>emp_delta_df.head(20)</span></pre><blockquote class="kg kh ki"><p id="be95" class="if ig kj ih b ii ij ik il im in io ip kk ir is it kl iv iw ix km iz ja jb jc hb bi translated">这是第一次加载，所以到目前为止目标表数据是空的。</p></blockquote><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="da6e" class="jy jz hi ju b fi ka kb l kc kd">e_fload_df=emp_df[[‘empno’,’ename’,’sal’,’deptno’]]</span><span id="6771" class="jy jz hi ju b fi ke kb l kc kd">#for first time load versioning is 1 to identify records as latest<br/>e_fload_df[‘flag’]=1</span><span id="0432" class="jy jz hi ju b fi ke kb l kc kd">e_fload_df.head(10)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kn"><img src="../Images/40ffda46eb0b5ae2efd595220236e5e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/1*B4QeNKYTy6auFwfjc_dW8Q.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">满载数据集</figcaption></figure><p id="44df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代理键在数据库级别处理。</p><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="1a58" class="jy jz hi ju b fi ka kb l kc kd">#sequence is created in Oracle Database<br/>create sequence seq_eid;</span><span id="8aee" class="jy jz hi ju b fi ke kb l kc kd">#to insert value of sequence key, before row trigger is created<br/>create or replace trigger trig_emp_seq<br/>before insert on emp_scd2<br/>for each row<br/>begin<br/> if :new.EID is null<br/> then<br/> select seq_id_scd2 into :new.EID from dual;<br/> end if;<br/>end;<br/>/</span><span id="2c4b" class="jy jz hi ju b fi ke kb l kc kd">#insert records into database <br/>e_fload_df.to_sql(‘emp_scd2’,con=engine,if_exists=’append’,index=False)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ko"><img src="../Images/e4ee0d75e7ab74263b7c2281b10f1eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*bpqMyfxMllA4yn1trqdX3w.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">EMP_SCD2表格数据</figcaption></figure><p id="87c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SCD类型2的第1部分按预期工作，目标表的初始加载成功完成。</p><p id="aa6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在故事的下一部分，我们将理解如何执行插入作为更新和更新操作并编写代码。</p><p id="cc3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二部分。如果存在，作为更新插入</p><p id="ed79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步。源和目标数据提取</p><p id="5ff7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个警告:我已经更新了一些记录，并从后端向源表中插入了新记录，所以请注意这些新手。</p><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="54d8" class="jy jz hi ju b fi ka kb l kc kd">emp_src=pd.read_sql_query(‘select * from emp_src’,engine)<br/>emp_src.head(20)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kp"><img src="../Images/b315ec4ddfe1c44167f2bb36c9c91583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*x9HwgkWxL5K1SOn1qxzkEA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">更新的源表</figcaption></figure><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="31fa" class="jy jz hi ju b fi ka kb l kc kd">emp_scd=pd.read_sql_query(‘select * from emp_scd2’,engine)<br/>emp_scd.head(20)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kq"><img src="../Images/2695e1d7776f35aa2ad17db5bb300663.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*KBy9RCv4ZxHux0qpxkDuew.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">EMP_SCD2目标数据</figcaption></figure><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="3734" class="jy jz hi ju b fi ka kb l kc kd">#rename columns is source and target for identification</span><span id="ddd9" class="jy jz hi ju b fi ke kb l kc kd">emp_src=emp_src[[‘empno’,’ename’,’sal’,’deptno’]]<br/>emp_src.rename(columns={‘empno’:’empno_src’,’sal’:’sal_src’},inplace=True)<br/>emp_scd.rename(columns={‘empno’:’empno_tgt’,’sal’:’sal_tgt’},inplace=True)<br/></span><span id="91ef" class="jy jz hi ju b fi ke kb l kc kd">#left join both the source and target dataframes to identify new records<br/>join_df=pd.merge(emp_src,emp_scd,left_on=’empno_src’,right_on=’empno_tgt’,how=’left’)<br/>join_df.head(20)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kr"><img src="../Images/15fa31287ddca9de5296ff6f5d877486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*4XvZNN64oXejU0_aZyJouA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">连接的数据框架</figcaption></figure><p id="c734" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">识别新记录并为插入记录创建单独的数据框。</p><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="3358" class="jy jz hi ju b fi ka kb l kc kd">join_df[‘INS_FLAG’]=join_df[[‘empno_src’,’empno_tgt’]].apply(lambda x:’I’ if pd.isnull(x[1]) else ’N’, axis=1)</span><span id="c665" class="jy jz hi ju b fi ke kb l kc kd">ins_rec=join_df[join_df['INS_FLAG']=='I']<br/>ins_rec=ins_rec[['empno_src','ename_x','sal_src','deptno_x']]<br/>ins_rec.rename(columns={'empno_src':'empno','ename_x':'ename','sal_src':'sal','deptno_x':'deptno'},inplace=True)</span><span id="304e" class="jy jz hi ju b fi ke kb l kc kd">ins_df=ins_rec[['empno','ename','sal','deptno']]</span><span id="240b" class="jy jz hi ju b fi ke kb l kc kd">#flag=1 for versioning of new records<br/>ins_df['flag']=1<br/>ins_df.head(5)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ks"><img src="../Images/c39bf934b49488a9efb361aefd3434be.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*3F5Ds8oSmbq8BE7moakp3Q.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">插入记录</figcaption></figure><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="b9b3" class="jy jz hi ju b fi ka kb l kc kd">ins_df.to_sql(‘emp_scd2’,con=engine,if_exists=’append’,index=False)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kt"><img src="../Images/4f449e49e0bbaf7d5978b3a68b8e17cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*6Is8if8YivQvFgKxtYSfnQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">EMP_SCD2新记录</figcaption></figure><p id="ad3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确定薪资发生变化的记录，更新其先前的标志并插入新记录。</p><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="1fe7" class="jy jz hi ju b fi ka kb l kc kd">join_df[‘INS_UPD_FLAG’]=join_df[[‘empno_src’,’empno_tgt’,<br/> ‘sal_src’,’sal_tgt’]].apply(lambda x:’UI’ if x[0]==x[1] and x[2]!=x[3] else ’N’, axis=1)</span><span id="0566" class="jy jz hi ju b fi ke kb l kc kd">ins_upd_rec=join_df[join_df[‘INS_UPD_FLAG’]==’UI’]<br/>ins_upd_rec=ins_upd_rec[[‘empno_src’,’ename_x’,’sal_src’,’deptno_x’]]<br/>ins_upd_rec[‘flag’]=1<br/>ins_upd_rec.rename(columns={‘empno_src’:’empno’,’ename_x’:’ename’,’sal_src’:’sal’,’deptno_x’:’deptno’},inplace=True)<br/>ins_upd_rec</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ku"><img src="../Images/71fbf8b943c9b1c3944214b1f2b03682.png" data-original-src="https://miro.medium.com/v2/resize:fit:596/format:webp/1*pLBEsOGQh2kRk3O-hBpgoQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">检测到薪金变化</figcaption></figure><p id="955c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，是时候更新检测到工资变化的记录的标志了，之后将插入新的记录。</p><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="1636" class="jy jz hi ju b fi ka kb l kc kd">import sqlalchemy as sqla<br/>from sqlalchemy.orm import sessionmaker<br/>metadata = sqla.MetaData(bind=engine)<br/>datatable = sqla.Table(‘emp_scd2’, metadata, autoload=True)<br/>Session = sessionmaker(bind=engine)<br/>session = Session()</span><span id="9f18" class="jy jz hi ju b fi ke kb l kc kd">#Flag updation process to mark them as previous records<br/>for ind, row in ins_upd_rec.iterrows():<br/>    upd=sqla.sql.update(datatable)\<br/>        .values({'flag':0})\<br/>        .where (sqla.and_(datatable.c.empno==row.empno))<br/>    session.execute(upd)<br/>session.flush()<br/>session.commit()</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kv"><img src="../Images/f091ea6d691e260003ddb110b8898f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*OghPpkR_NlcB6No2gcCMrg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">EMP_SCD2标志已更新</figcaption></figure><pre class="je jf jg jh fd jt ju jv jw aw jx bi"><span id="7407" class="jy jz hi ju b fi ka kb l kc kd">ins_upd_rec.to_sql(‘emp_scd2’,con=engine,if_exists=’append’,index=False)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kw"><img src="../Images/78020b7dec25087b790a108c5f1d5c9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:790/format:webp/1*as5In89KMCyhYqYNpA5tog.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">EMP_SCD2最终数据</figcaption></figure><p id="7da7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是用Python实现的SCD Type2，为了更好地理解流程和过程，它被分成了两个部分。</p><h1 id="9907" class="kx jz hi bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">总结:</h1><p id="57a8" class="pw-post-body-paragraph if ig hi ih b ii lu ik il im lv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">理解SCD类型2</p><p id="3905" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用例实现分为两个部分</p><p id="e238" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所需的库和数据提取</p><p id="898e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">初始数据加载(满载)</p><p id="e32e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据库序列和触发器</p><p id="914b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果存在实施，则作为更新插入</p><p id="1b11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用sql_alchemy库插入和更新记录</p><p id="4ee0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢所有人阅读我的博客，如果你喜欢我的内容和解释，请在媒体上关注我并分享你的反馈，这将永远帮助我们所有人提高我们的知识。</p><p id="b41d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢</p><p id="89a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Vivek Chaudhary</p></div></div>    
</body>
</html>