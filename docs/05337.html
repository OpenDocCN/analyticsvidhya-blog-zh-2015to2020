<html>
<head>
<title>Pyspark DataFrame For SQL Analyst</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL分析师的Pyspark数据框架</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/pyspark-dataframe-for-sql-aanalyst-99de486627b0?source=collection_archive---------9-----------------------#2020-04-18">https://medium.com/analytics-vidhya/pyspark-dataframe-for-sql-aanalyst-99de486627b0?source=collection_archive---------9-----------------------#2020-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c727" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我在《火花深潜》中的一个故事</p><div class="jd je ez fb jf jg"><a rel="noopener follow" target="_blank" href="/@somanathsankaran"><div class="jh ab dw"><div class="ji ab jj cl cj jk"><h2 class="bd hj fi z dy jl ea eb jm ed ef hh bi translated">somanath sankaran —中等</h2><div class="jn l"><h3 class="bd b fi z dy jl ea eb jm ed ef dx translated">阅读索马纳特·桑卡兰在媒介上的作品。对python和spark感兴趣的大数据开发者。每天，索马纳特…</h3></div><div class="jo l"><p class="bd b fp z dy jl ea eb jm ed ef dx translated">medium.com</p></div></div><div class="jp l"><div class="jq l jr js jt jp ju jv jg"/></div></div></a></div><p id="474a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗨，这个博客是专为sql开发人员和Sql分析师</p><p id="66c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一名sql分析师，我们可能会使用spark sql来进行分析。</p><p id="1f0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是让你惊讶的是,<strong class="ih hj"> <em class="jw"> spark有一些强大的功能，允许你表达sql，这就是为什么它被正确地命名为expr </em> </strong></p><p id="5f59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用的主子句是select、join、groupby和where子句。</p><p id="6488" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看下面的子句和它们的spark DF等价物</p><p id="d207" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择-&gt;选择表达式</p><p id="14d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">分组依据-&gt;分组依据+表达式</p><p id="3810" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接-&gt;连接+表达式</p><p id="65b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">where -&gt; where + expr</p><p id="f7b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据集:为此我使用了一个巨大的数据集</strong>样本表</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es jx"><img src="../Images/d4f20e54da38b359925ecc49afe43fe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qf4OyokjjGDsIZbSQrINlA.png"/></div></div></figure><p id="83e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">选择- &gt;选择表达式</strong></p><p id="b89e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你是sql /Hive用户，我也是，如果你错过了spark中强大的select和other语句。</p><p id="8b96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要担心selectExpr会来救援</p><p id="4513" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.SelectExpr对于灵活的sql语句和添加字段非常有用</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div class="er es ki"><img src="../Images/ed1faf81d2744e6124a3f86f097a9971.png" data-original-src="https://miro.medium.com/v2/resize:fit:60/0*-yOTb6s6gCKsV7oH"/></div></figure><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es kj"><img src="../Images/0dfc49a7ae955daafd89859e111f6579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d6Sk_hI9LEB2apoK.png"/></div></div></figure><p id="f4cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.使用所有内置的配置单元函数</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div class="er es ki"><img src="../Images/8cb87565e371c26a4133c77542013225.png" data-original-src="https://miro.medium.com/v2/resize:fit:60/0*JTIJp_w62zWkn4Lt"/></div></figure><figure class="jy jz ka kb fd kc er es paragraph-image"><div class="er es kk"><img src="../Images/5c43ad2d4df3727f8431f2b20ef4a396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/format:webp/0*txwi1BiX-CDUkn9x.png"/></div></figure><p id="ce6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.使用selectExpr转换数据类型很容易</p><p id="21a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们将幸存的dtypes从string转换为int</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div class="er es ki"><img src="../Images/2170004f16cae0e6194e0359461c95fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:60/0*7xMG0eIbu13kbP07"/></div></figure><figure class="jy jz ka kb fd kc er es paragraph-image"><div class="er es kl"><img src="../Images/16a0aac1b787df0c4af4428018d328a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*xVtFGfu68eeRmwV-.png"/></div></figure><p id="a11a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.用SelectExpr添加常数</p><p id="5810" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个常见的用例是添加像current_date这样的常量字段</p><p id="334f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可以用SelectExpr轻松完成</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es km"><img src="../Images/446ed97923acc0eacf74df68134c848f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*o2swULBfBxasMLl5.png"/></div></div></figure><p id="46cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">分组依据- &gt;分组依据+表达式</strong></p><p id="de4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">spark有一个groupby子句，groupby的一个重要用例是检查重复计数</p><p id="ef34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">通过计数(*) &gt; 200 </strong>的pclass从钛组中选择pclass，count(*)的</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es kn"><img src="../Images/ea493c1b127519f1af5aca939948ff30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tD5MdwdmV83bXKVrF08Ztg.png"/></div></div></figure><p id="edd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在上面的步骤中，我们使用了expr，这是spark中一个强大但被低估的函数</strong></p><p id="4681" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Expr允许您将sql语句转换成spark等价物，如上图所示</strong></p><p id="0220" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们也可以按多列分组，并使用其他聚合函数，如max、min avg等，如下所示</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es ko"><img src="../Images/fb61768693758b41e211e4439f70cb72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FpEkAx57gNYsAzNCKTrEQQ.png"/></div></div></figure><p id="c826" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:这里的强制转换是因为年龄作为字符串存储在源数据中</p><p id="86df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> join - &gt; join + expr </strong></p><p id="59f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看如何将连接查询转换成spark数据帧等价物</p><p id="cc41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">“从泰坦尼克a上选择*加入泰坦尼克b上a . name = b . name”</strong></p><p id="b2d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">df.alias("a ")。join(df.alias("b ")，on=f.expr("a.Name=b.Name ")，how="inner ")。展示(1)</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es kp"><img src="../Images/2e8198f7feb757991dc184c07671b06d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RPvMCNE_vMOp3_m3kw3Cbg.png"/></div></div></figure><p id="325f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的一行代码简洁而强大，我们正在创建一个别名并进行内部连接，如果我们使用子查询并进行如下所示的连接，这将会很有帮助</p><p id="2af6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"><em class="jw">select * from titanic a left join(select name，sex from titanic where sex = " male ")on a . name = b . name and a . sex = b . sex</em></strong></p><p id="70f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> df.alias("a")\ <br/>。join(df.select("name "，" sex ")。where(f.expr("sex='male ' ")。别名(" b ")，<br/> on=f.expr(" a.name=b.name和a.sex=b.sex") <br/>，how="left ")。selectExpr("a.name "，" b.name ")。显示(</strong> 1)</p><p id="2c6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第1行:选择别名为a的df</p><p id="7024" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第2行:选择df姓名和性别，用where子句选择男性乘客</p><p id="bb04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第3行:用与sql相同的方式指定连接条件</p><p id="88db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第4行:选择所需的列</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es kq"><img src="../Images/e750a188e1b6f7e418e47c2f822713ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NSNlKgxMu0a7A-3crFiAdg.png"/></div></div></figure><p id="9ed5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> where - &gt; where + expr </strong></p><p id="a347" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">sql的一个常见用例是在连接后过滤记录。</p><p id="f166" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">比方说，我们必须找到一个不匹配的记录，所以我们将添加一个连接后为空的过滤器，如下所示</p><p id="2025" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">T3】select * from titanic a left join(select name，sex from titanic where sex = " male ")on a . name = b . name and a . sex = b . sex where b . name为空T5】</strong></p><p id="8618" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用where和expr可以很容易地添加同样的内容，除了where子句之外，几乎不用添加任何东西</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es kr"><img src="../Images/aa1e174434c274fb3e450234a44dac2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ULim0D_ZjR9BeZxRfMIF6g.png"/></div></div></figure><p id="5bdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Github链接:<a class="ae ks" href="https://github.com/SomanathSankaran/spark_medium/tree/master/spark_csv" rel="noopener ugc nofollow" target="_blank">https://github . com/SomanathSankaran/spark _ medium/tree/master/spark _ CSV</a></p><p id="2ef4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jw">请给我发spark中我必须涉及的话题，并给我改进写作的建议:)</em> </strong></p><p id="841f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">学习并让别人学习！！</strong></p></div></div>    
</body>
</html>