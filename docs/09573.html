<html>
<head>
<title>Image classification using Fast.ai</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Fast.ai 的图像分类</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/image-classification-using-fast-ai-a67078f6954e?source=collection_archive---------4-----------------------#2020-09-11">https://medium.com/analytics-vidhya/image-classification-using-fast-ai-a67078f6954e?source=collection_archive---------4-----------------------#2020-09-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/7ca6de5e99f3d9a9970eba0ea14a5560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*q49Nh7mjdd1rdLJvW2H6kQ.png"/></div></figure><p id="4625" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">问题陈述:</strong></p><p id="cb3b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">问题陈述是将车辆图像分类为属于紧急车辆或非紧急车辆类别。同样，我们提供了训练和测试数据集。</p><ul class=""><li id="db9e" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj jp jq jr js bi translated">急救车辆通常包括警车、救护车和消防队。</li><li id="7e01" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">非紧急车辆包括通常用于通勤的所有其他车辆。</li></ul><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es jy"><img src="../Images/2953e8b3488447ba85b9c98db614eafb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*-kEXlqPoU35tde19ReHbEQ.jpeg"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx translated"><a class="ae kl" href="https://s3-ap-south-1.amazonaws.com/av-blog-media/wp-content/uploads/2018/08/Emgen.jpg" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="f672" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">数据描述:</strong></p><ol class=""><li id="45b3" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj km jq jr js bi translated">train.csv — ['image_names '，' emergency_or_not']包含 1646 (70%)个列车图像的图像名称和正确类别</li><li id="bd99" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated">图像—包含 2352 幅训练集和测试集的图像</li><li id="9799" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated">test.csv: ['image_names']仅包含 706 个(30%)测试图像的图像名称</li></ol><p id="0100" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">本问题陈述由 Analytics Vidhya 提供:<a class="ae kl" href="https://datahack.analyticsvidhya.com/contest/janatahack-computer-vision-hackathon/" rel="noopener ugc nofollow" target="_blank">计算机视觉黑客马拉松</a></p></div><div class="ab cl kn ko gp kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hb hc hd he hf"><p id="39fa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们快速地将训练和测试图像从用于训练的图像文件夹中分离出来</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="8b9d" class="kz la hi kv b fi lb lc l ld le">import numpy as np<br/>import pandas as pd<br/>import os<br/>import glob<br/>from PIL import Image</span><span id="7359" class="kz la hi kv b fi lf lc l ld le">train_csv = pd.read_csv('train_av_cv.csv')<br/>test_csv = pd.read_csv('test_av_cv.csv')<br/>path = 'images'<br/>os.chdir(path)</span><span id="bdf6" class="kz la hi kv b fi lf lc l ld le">train_csv_emergency = train_csv[train_csv['emergency_or_not']==1]<br/>train_csv_non_emergency = train_csv[train_csv['emergency_or_not']==0]</span><span id="60c5" class="kz la hi kv b fi lf lc l ld le">for i in range(0,train_csv_emergency.shape[0]):<br/>    name = train_csv_emergency['image_names'].iloc[i]<br/>    im = Image.open(name)<br/>    to_save = 'emergency/'+ name<br/>    im.save(to_save, 'JPEG')<br/>    <br/>for i in range(0,train_csv_non_emergency.shape[0]):<br/>    name = train_csv_non_emergency['image_names'].iloc[i]<br/>    im = Image.open(name)<br/>    to_save = 'non_emergency/'+ name<br/>    im.save(to_save, 'JPEG')<br/>    <br/>for i in range(0,test_csv.shape[0]):<br/>    name = test_csv['image_names'].iloc[i]<br/>    im = Image.open(name)<br/>    to_save = 'test_images/'+ name<br/>    im.save(to_save, 'JPEG')</span></pre></div><div class="ab cl kn ko gp kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hb hc hd he hf"><p id="d3c5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们来看一下图片的尺寸</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="fab2" class="kz la hi kv b fi lb lc l ld le">from PIL import Image</span><span id="41c2" class="kz la hi kv b fi lf lc l ld le">def get_num_pixels(filepath):<br/>    width, height = Image.open(filepath).size<br/>    return width,height</span><span id="c2c4" class="kz la hi kv b fi lf lc l ld le">print(get_num_pixels("images/1.jpg"))</span><span id="b3b2" class="kz la hi kv b fi lf lc l ld le">Output: (224,224)</span></pre><p id="5360" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">既然我们已经分离了训练和测试图像，让我们开始构建分类模型。该解决方案的端到端流程分为以下 6 个步骤:</p><ol class=""><li id="6bde" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj km jq jr js bi translated"><strong class="io hj">读取数据</strong></li><li id="6def" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated"><strong class="io hj">定义模型</strong></li><li id="5501" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated"><strong class="io hj">定义学习率</strong></li><li id="132a" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated"><strong class="io hj">拟合模型</strong></li><li id="1929" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated"><strong class="io hj">解读结果</strong></li><li id="3632" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj km jq jr js bi translated"><strong class="io hj">推论</strong></li></ol><p id="97b3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们从<strong class="io hj">从文件夹</strong>中读取数据开始</p><p id="84ff" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">ImageDataBunch 帮助我们创建训练、验证和测试数据集</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="8d01" class="kz la hi kv b fi lb lc l ld le">xtra = [(contrast(scale=(0.1,2.0), p = 0.5)),<br/>(brightness(change = 0.6, p = 0.25)),<br/>(perspective_warp(magnitude = 0.25, p = 0.25)),<br/>(squish(scale = 1.2, p = 0.25))]</span><span id="6934" class="kz la hi kv b fi lf lc l ld le">augmentations = get_transforms(do_flip=True,flip_vert=False, max_rotate=None, max_zoom=1.5,max_warp=None, p_affine = 0.5, max_lighting=0.2,p_lighting=0.5, xtra_tfms=xtra)</span><span id="86de" class="kz la hi kv b fi lf lc l ld le"><br/>data=ImageDataBunch.from_folder('/content/gdrive/My Drive/', train =  'train_images', valid= 'train_images' ,size=224, bs=16, ds_tfms = get_transforms(do_flip=True,<br/>max_rotate=None, ## amount of rotaion<br/>max_zoom=1.2, ## amount of zoom<br/>max_warp=0.2, ## amount of wraping<br/>p_affine = 0.5, ## probability by which above 3 tfms will take place<br/>max_lighting=0.2, ## amount of lightin<br/>p_lighting=0.5 ## probability for lighting))</span><span id="3de9" class="kz la hi kv b fi lf lc l ld le">data.normalize(imagenet_stats)</span><span id="8d45" class="kz la hi kv b fi lf lc l ld le">#for extra augmentations - <br/>#ds_tfms = augmentations.normalize(imagenet_stats)</span></pre><p id="bf32" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们检查数据中出现的类</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="7d46" class="kz la hi kv b fi lb lc l ld le">data.classes</span><span id="ef74" class="kz la hi kv b fi lf lc l ld le">Output: ['emergency', 'non_emergency']</span></pre><p id="c069" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们<strong class="io hj">定义模型</strong></p><p id="d24b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">cnn_learner 方法用于快速获得适合迁移学习的模型。简而言之，它是一个用于使用预定义/训练的模型来训练我们的模型的概念。目前，我们正在建立一个模型，该模型将图像作为输入，并将输出每个类别的预测概率。</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="f2cc" class="kz la hi kv b fi lb lc l ld le">## Defining callbacks</span><span id="64a4" class="kz la hi kv b fi lf lc l ld le">Save_Model_Callback=partial(SaveModelCallback, every='improvement', monitor='accuracy', name='av_cv')<br/>EarlyStoppingCallback = partial(EarlyStoppingCallback, monitor='valid_loss', min_delta=0.01, patience=5)</span><span id="a81c" class="kz la hi kv b fi lf lc l ld le">#defining model and optimizer</span><span id="5d0b" class="kz la hi kv b fi lf lc l ld le">learn  = cnn_learner(data, models.resnet152 , pretrained= True ,opt_func=optim.Adam, metrics=[accuracy,error_rate,FBeta(beta=1),Precision(),Recall()], callback_fns=[Save_Model_Callback,EarlyStoppingCallback])</span></pre><p id="f42d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用预训练模型的原因是为了避免从头开始训练模型。使用 ImageNet 数据集，使用数百万张图像和数千个类别对预训练模型进行了良好的训练。ImageNet 的最后一层由 1000 列组成，对应于 1000 个不同的类别。不能保证预定义的类别包含我们需求的类别，但是有一点我们很有信心，那就是这个模型知道一些东西，并且能够区分一只狗和一辆卡车(比如说)。</p><p id="3cd8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有许多针对不同图像数据集进行训练的预训练架构。在这里，我采用了在 ImageNet 数据集上训练的 resnet152。</p><p id="a12e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就优化程序而言，我已经尝试了 Adam 和 SGD，而 Adam 给出了更好的结果。</p><p id="4584" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在训练时可以使用一堆指标，我已经提到了准确性、错误率、FBeta(beta=1)、精度()、召回()。</p><p id="84c2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">“保存模型回调”用于在训练期间自动保存新的“最佳损失”模型。在训练结束时，它加载顶部模型。人们可以指定定义最佳模型的标准。我指定的标准是“准确性”。</p><p id="a5f0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">“EarlyStoppingCallback”用于在损失连续三次增加或损失连续三次变化小于 0.01 时自动停止训练</p><p id="e74e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">定义学习率</strong></p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="34bb" class="kz la hi kv b fi lb lc l ld le"># This helps to find best learning rate for model.</span><span id="d330" class="kz la hi kv b fi lf lc l ld le">learn.lr_find()</span><span id="55bb" class="kz la hi kv b fi lf lc l ld le">#Plot of LR</span><span id="a7f2" class="kz la hi kv b fi lf lc l ld le">learn.recorder.plot()</span></pre><p id="1474" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们可能希望在拟合模型(下一步)时给出学习率，以获得更好的结果。它定义了模型中参数更新的速度。剧情大概是这样的。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/4d26cafbb32413aa148ca08313a48eb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:766/format:webp/1*7eHB0DIq8uEFtCXoVFZNkA.png"/></div></figure><p id="3328" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">考虑曲线显示急剧下降的范围。我们可以观察到，学习率在范围[1e-04，1e-02]内急剧下降。</p><p id="c95b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">拟合模型</strong></p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="8610" class="kz la hi kv b fi lb lc l ld le">num_of_epochs = 20</span><span id="ed89" class="kz la hi kv b fi lf lc l ld le">learn.fit_one_cycle(num_of_epochs,max_lr=slice(1e-04,1e-02),moms=(0.95,0.85))</span><span id="f3ea" class="kz la hi kv b fi lf lc l ld le">learn.recorder.plot_losses()</span><span id="b7ef" class="kz la hi kv b fi lf lc l ld le">#Iterations Vs LR and Iterations Vs Moms</span><span id="497a" class="kz la hi kv b fi lf lc l ld le">learn.recorder.plot_lr(show_moms=True)</span><span id="d1ab" class="kz la hi kv b fi lf lc l ld le">#Plot Metrics across Iterations</span><span id="1f3e" class="kz la hi kv b fi lf lc l ld le">learn.recorder.plot_metrics()</span></pre><p id="797f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这里，历元数是整个数据应该通过模型学习的次数。</p><p id="939a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">解读结果</strong></p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="911d" class="kz la hi kv b fi lb lc l ld le">learn.load('av_cv')</span><span id="222d" class="kz la hi kv b fi lf lc l ld le">interpret=ClassificationInterpretation.from_learner(learn)</span><span id="d98c" class="kz la hi kv b fi lf lc l ld le">interpret.plot_confusion_matrix(figsize=(5,5),dpi=100)</span></pre><p id="56e6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">绘制混淆矩阵有助于我们理解模型的性能。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es lh"><img src="../Images/890a671505c5907c8007ddd470ade0d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1066/format:webp/1*6yDCzGDXU7C55RUTUa7tWA.png"/></div></figure><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="3849" class="kz la hi kv b fi lb lc l ld le">interpret.plot_top_losses(6, heatmap=True)</span></pre><p id="7367" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">plot_top_losses 显示被错误预测且对损失有最大影响的图像。</p><p id="f968" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">推理</strong></p><p id="073e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将模型导出为. pkl 格式，以便在对未知数据进行预测时使用。</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="9322" class="kz la hi kv b fi lb lc l ld le">learn.export('av_cv.pkl')</span></pre><p id="7380" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下一步是向学习者加载测试数据并进行预测</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="32dc" class="kz la hi kv b fi lb lc l ld le">test = ImageList.from_folder(base_path + 'test_images')</span><span id="e628" class="kz la hi kv b fi lf lc l ld le">learn = load_learner(base_path, file = 'av_cv.pkl', test = test)</span><span id="7666" class="kz la hi kv b fi lf lc l ld le"><br/>thresh = 0.5</span><span id="26e5" class="kz la hi kv b fi lf lc l ld le">preds, _ = learn.get_preds(ds_type=DatasetType.Test)</span><span id="8eef" class="kz la hi kv b fi lf lc l ld le">labelled_preds = [' '.join([learn.data.classes[i] for i,p in enumerate(pred) if p &gt; thresh]) for pred in preds]</span><span id="b421" class="kz la hi kv b fi lf lc l ld le">fnames = [f.name[:-4] for f in learn.data.test_ds.items]</span><span id="89f4" class="kz la hi kv b fi lf lc l ld le">df = pd.DataFrame({'image_name':fnames, 'tags':labelled_preds}, columns=['image_name', 'tags'])</span><span id="b4ce" class="kz la hi kv b fi lf lc l ld le">df.to_csv('fastai_adam.csv', index=False)</span></pre><p id="4534" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">预测以 csv 文件的形式保存。</p></div><div class="ab cl kn ko gp kp" role="separator"><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks kt"/><span class="kq bw bk kr ks"/></div><div class="hb hc hd he hf"><p id="dc27" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">该车型可做出的进一步改进</strong>:</p><pre class="jz ka kb kc fd ku kv kw kx aw ky bi"><span id="3609" class="kz la hi kv b fi lb lc l ld le">learn.freeze_to(-4)</span></pre><p id="a5e0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">freeze_to(-4)冻结除最后四层之外的所有层，并且只在这四层上训练。这可以在定义模型时添加。</p><p id="90f5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">可以尝试增加测试时间来改善结果。</p><p id="97a9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">参考文献:</strong></p><p id="9471" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Fast.ai</p><div class="li lj ez fb lk ll"><a rel="noopener follow" target="_blank" href="/analytics-vidhya/image-classification-using-fastai-5ff5b374d414"><div class="lm ab dw"><div class="ln ab lo cl cj lp"><h2 class="bd hj fi z dy lq ea eb lr ed ef hh bi translated">使用 fastai 的图像分类</h2><div class="ls l"><h3 class="bd b fi z dy lq ea eb lr ed ef dx translated">我将使用 fastai 库来实现图像分类。</h3></div><div class="lt l"><p class="bd b fp z dy lq ea eb lr ed ef dx translated">medium.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz ik ll"/></div></div></a></div></div></div>    
</body>
</html>