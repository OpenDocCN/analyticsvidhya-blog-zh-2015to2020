<html>
<head>
<title>Trying fastai — the deep learning library that sits on top of Pytorch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">尝试fastai——位于Pytorch之上的深度学习库</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/fastai-the-deep-learning-library-that-sits-on-top-of-pytorch-fd1da07ff1b2?source=collection_archive---------22-----------------------#2020-03-26">https://medium.com/analytics-vidhya/fastai-the-deep-learning-library-that-sits-on-top-of-pytorch-fd1da07ff1b2?source=collection_archive---------22-----------------------#2020-03-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="5f9b" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">Fastai有多快？</h2><div class=""/><div class=""><h2 id="852d" class="pw-subtitle-paragraph io hr hi bd b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf dx translated">图像分类的遍历</h2></div><p id="cdf2" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">TensorFlow和Pytorch是当下最流行的深度学习库。除此之外，还有高级深度学习库。</p><p id="fc86" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">Tensorflow上面有Keras一个流行的高级深度学习框架，模块化且用户友好。喀拉的大部分特征都可以在Pytorch找到。然而Pytorch有自己的高级深度学习框架，称为fastai。</p><p id="d101" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">fastai承诺为常见的深度学习任务提供更快的开发周期。fastai有多快？我在这个库中尝试了一个简单的图像分类任务，以检验它是否真的那么快。</p><h2 id="3d5c" class="kc kd hi bd ke kf kg kh ki kj kk kl km jp kn ko kp jt kq kr ks jx kt ku kv ho bi translated">法斯泰精神</h2><p id="9309" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">在开始之前，让我们比较一下fastai和Keras。</p><p id="23d8" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">Keras提供模块化构建模块来帮助构建自己的网络，fastai则为常见的机器学习任务提供完整的工作流程，如图像分类、推荐和对象检测。</p><p id="fbe4" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">Fast努力为这些任务实施最先进的体系结构。它让用户专注于他们的应用程序所特有的内容。通常这是为你自己的数据集写一个数据管道，用你自己的数据训练网络。下面我们进一步谈这些。</p><h1 id="053f" class="lb kd hi bd ke lc ld le ki lf lg lh km ix li iy kp ja lj jb ks jd lk je kv ll bi translated">图像数据助手</h1><p id="8b10" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">fastai有一些有用的助手来处理图像数据，比如<code class="du lm ln lo lp b">download_images</code>、<code class="du lm ln lo lp b">verify_images</code>和<code class="du lm ln lo lp b">open_image</code>。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="6bee" class="kc kd hi lp b fi ly lz l ma mb">download_images('chairs.csv', 'data/chairs')<br/>download_images('tables.csv', 'data/tables')</span></pre><p id="4a6d" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">我将搜索椅子图片和桌子图片的URL导出到文本文件中。<code class="du lm ln lo lp b">download_images downloads</code>将图片放入两个目录，<code class="du lm ln lo lp b">data/chairs</code>和<code class="du lm ln lo lp b">data/tables.</code></p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="a7f1" class="kc kd hi lp b fi ly lz l ma mb">Most of the time we want to apply some augmentations on image data. And  we want to split the data into train, validation, and test sets. The  fastai library offers the <!-- -->ImageDataBunch<!-- -->  class which does  just that and a bunch of other tasks that usually  need to be handled  when working with images. This includes  normalization and resizing.verify_images('data/chairs', delete=True, max_size=2000)<br/>verify_images('data/tables', delete=True, max_size=2000)</span></pre><p id="1f1c" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">一些图像可能已损坏；删除那些文件。此外，它还会调整像素超过<code class="du lm ln lo lp b">max_size</code>的图像的大小。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="14ca" class="kc kd hi lp b fi ly lz l ma mb">open_image('data/chair/00000000.jpg')</span></pre><figure class="lq lr ls lt fd md er es paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="er es mc"><img src="../Images/54f92e6c862beec4d9d75c8560461284.png" data-original-src="https://miro.medium.com/v2/resize:fit:442/format:webp/1*P0I1GPFEzSAVJ-JsSuYVCw.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">图像对象的笔记本表示</figcaption></figure><p id="7593" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated"><code class="du lm ln lo lp b">open_image</code>返回一个<code class="du lm ln lo lp b">fastai.vision.image.Image</code>对象。在笔记本电脑环境中，图像文件会自动加载并呈现在笔记本电脑中。</p><h1 id="6d85" class="lb kd hi bd ke lc ld le ki lf lg lh km ix li iy kp ja lj jb ks jd lk je kv ll bi translated">数据加载器</h1><p id="86e9" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">对于大多数深度学习任务，我们希望对数据进行一些转换。通常我们也想增加它。我们希望将数据分为训练集、验证集和测试集。</p><p id="29b2" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">Fastai提供了<code class="du lm ln lo lp b">ImageDataBunch</code>类来做这件事。它执行一些常见的任务，包括规范化和调整大小。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="0447" class="kc kd hi lp b fi ly lz l ma mb">data = ImageDataBunch.from_folder(path, train=".", valid_pct=0.2,<br/>    ds_tfms=get_transforms(), size=224, <br/>    num_workers=4).normalize(imagenet_stats)</span></pre><p id="9550" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">此外，<code class="du lm ln lo lp b">ImageDataBunch</code>还为Juptyer笔记本提供了便捷的可视化方法。如果您想检查训练集中的一些示例，无需编写自己的matplotlib代码</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="d098" class="kc kd hi lp b fi ly lz l ma mb">data.show_batch(rows=3, figsize=(7,8))</span></pre><figure class="lq lr ls lt fd md er es paragraph-image"><div class="er es mo"><img src="../Images/eb481d99216e3183764c9eba4a4a1f25.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*cTGNG81fx0AHI02DcY3wkw.png"/></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">来自训练集的样本</figcaption></figure><p id="03ef" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">关于训练和验证集的更多信息很容易获得。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="503d" class="kc kd hi lp b fi ly lz l ma mb">ImageDataBunch;<br/><br/>Train: LabelList (1032 items)<br/>x: ImageList<br/>Image (3, 224, 224),Image (3, 224, 224),Image (3, 224, 224),Image (3, 224, 224),Image (3, 224, 224)<br/>y: CategoryList<br/>desk,desk,desk,desk,desk<br/>Path: data;<br/><br/>Valid: LabelList (258 items)<br/>x: ImageList<br/>Image (3, 224, 224),Image (3, 224, 224),Image (3, 224, 224),Image (3, 224, 224),Image (3, 224, 224)<br/>y: CategoryList<br/>desk,chair,chair,chair,chair<br/>Path: data;<br/><br/>Test: None</span></pre><p id="707d" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">摘要显示训练集包含1032个项目。验证集包含258个项目。默认情况下，没有测试集。此外，我们看到图像大小是224像素，正如所期望的</p><h1 id="07b7" class="lb kd hi bd ke lc ld le ki lf lg lh km ix li iy kp ja lj jb ks jd lk je kv ll bi translated">加载预训练模型</h1><p id="2b5e" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated"><code class="du lm ln lo lp b">ccn</code>是图像分类的标准工具。作为基线，resnet架构从来都不是一个坏的选择。</p><p id="36ef" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">Fastai使用提供标准模型的<code class="du lm ln lo lp b">learner</code>对象，以及训练它们的方法。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="724a" class="kc kd hi lp b fi ly lz l ma mb">learn = cnn_learner(data, models.resnet34, metrics=error_rate)</span></pre><p id="10b9" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">下载和训练模型的功能由<code class="du lm ln lo lp b">learner</code>类包装。默认情况下，学习者下载预先训练好的模型。<code class="du lm ln lo lp b">resnet34</code>模型在ImageNet上进行了预训练。</p><p id="3554" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">对于迁移学习，循环学习计划在大多数情况下都很有效。这是fastai默认提供的学习方法。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="450b" class="kc kd hi lp b fi ly lz l ma mb">learn.lr_find()</span></pre><p id="7034" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">lr_find()方法有助于确定一个好的学习率。</p><figure class="lq lr ls lt fd md er es paragraph-image"><div class="er es mp"><img src="../Images/9507fed5d2ed5fb93f564f739e3b1f9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/1*Ij48DoegQTbUun5GhhR11g.png"/></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">使用lr_find()调整学习率</figcaption></figure><p id="28b7" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">在这种情况下，<code class="du lm ln lo lp b">1e-2</code>似乎是一个不错的选择。</p><h1 id="2799" class="lb kd hi bd ke lc ld le ki lf lg lh km ix li iy kp ja lj jb ks jd lk je kv ll bi translated">培养</h1><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="8a42" class="kc kd hi lp b fi ly lz l ma mb">learn.fit_one_cycle(4, max_lr=1e-2)</span></pre><figure class="lq lr ls lt fd md er es paragraph-image"><div class="er es mq"><img src="../Images/2491c971a618645e0d6b68d0b5461465.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*lsEwKwFqCM2M-mSXjWGc7Q.png"/></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">培训结果</figcaption></figure><p id="f0a7" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">短短一分钟后，error _ rate(1-准确率)在9%以下；那相当快。</p><pre class="lq lr ls lt fd lu lp lv lw aw lx bi"><span id="ea23" class="kc kd hi lp b fi ly lz l ma mb">learn.recorder.plot_losses()</span></pre><figure class="lq lr ls lt fd md er es paragraph-image"><div class="er es mp"><img src="../Images/9507fed5d2ed5fb93f564f739e3b1f9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/1*Ij48DoegQTbUun5GhhR11g.png"/></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">训练和验证损失</figcaption></figure><p id="359d" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">损失图表明有更大的改进空间；这在一分钟的训练后并不奇怪。</p><h1 id="1397" class="lb kd hi bd ke lc ld le ki lf lg lh km ix li iy kp ja lj jb ks jd lk je kv ll bi translated">GPU利用率</h1><figure class="lq lr ls lt fd md er es paragraph-image"><div class="er es mr"><img src="../Images/6b208d1a67248ff15f12bd4414090e6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*WrjmdxcO4pQiyWsTeNDKOA.png"/></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">96%的CPU利用率</figcaption></figure><p id="7b24" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">提高GPU利用率并不总是容易的，所以我检查了我的K80的利用率。基于默认设置，96%的利用率是很好的。</p><h1 id="eaba" class="lb kd hi bd ke lc ld le ki lf lg lh km ix li iy kp ja lj jb ks jd lk je kv ll bi translated">结论</h1><p id="5d00" class="pw-post-body-paragraph jg jh hi ji b jj kw is jl jm kx iv jo jp ky jr js jt kz jv jw jx la jz ka kb hb bi translated">有了Fastai，一个简单的分类任务可以在半小时内完成。那相当快。我对开箱即用的默认选择印象特别深刻。</p><p id="6c92" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">帮助器函数节省写锅炉板代码的时间。分割数据集是我们反复重复的任务之一。</p><p id="d0aa" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">绘制带有标签的样本图像网格也是一项常见任务。这不应该花太多时间，但实际上却经常花。有了fastai，只需一分钟就能把情节显示在屏幕上。</p><p id="0f87" class="pw-post-body-paragraph jg jh hi ji b jj jk is jl jm jn iv jo jp jq jr js jt ju jv jw jx jy jz ka kb hb bi translated">总的来说，我对这个深度学习库持肯定态度。我有一个问题是关于灵活性的。对于标准任务，fastai提供了高效的工作流程。但是不那么常见的任务呢？Fastai很难适应特定的需求吗？也许这将是未来帖子的主题。</p></div></div>    
</body>
</html>