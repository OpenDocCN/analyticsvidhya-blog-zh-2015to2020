<html>
<head>
<title>Azure Synapse Analytics — Workspace — Run Automated ML using Azure Machine learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Synapse Analytics-Workspace-使用 Azure 机器学习运行自动化 ML</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-synapse-analytics-workspace-run-automated-ml-using-azure-machine-learning-577b25423c46?source=collection_archive---------28-----------------------#2020-12-01">https://medium.com/analytics-vidhya/azure-synapse-analytics-workspace-run-automated-ml-using-azure-machine-learning-577b25423c46?source=collection_archive---------28-----------------------#2020-12-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e957" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">统一的分析工具，可摄取、计算或处理数据、存储数据、高级分析或机器学习，并在一个工具中显示所有内容。端到端数据分析平台专为扩展和易用性而构建。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/3f95169b8eb2ab5e4d6e58b8401e3118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FYomYCj--BTqsIlx.JPG"/></div></div></figure><h1 id="28df" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">Synapse 高级分析</h1><p id="cc2e" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">Synapse 能够运行基于 spark 的代码，从而实现数据工程或特征工程以及机器学习。本文描述了如何在 synapse 中使用 spark 训练机器学习模型。</p><h1 id="1780" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">先决条件</h1><ul class=""><li id="0a79" class="ks kt hi ih b ii kn im ko iq ku iu kv iy kw jc kx ky kz la bi translated">创建 Azure 机器学习服务。选择与 synapse analytics 相同的区域。</li><li id="9a23" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">创建 github repo</li><li id="11d1" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">连接到管理部分中的回购</li><li id="7484" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">创建 pyspark 笔记本。</li><li id="70a9" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">在笔记本的单独单元格中运行每个批处理语句。</li></ul><h1 id="85bd" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">设置工作区信息</h1><ul class=""><li id="c7dd" class="ks kt hi ih b ii kn im ko iq ku iu kv iy kw jc kx ky kz la bi translated">让我们配置要访问的工作区</li><li id="57de" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">需要订阅 id、工作区名称和资源组名称</li><li id="5e8e" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">让我们导入工作空间</li></ul><pre class="je jf jg jh fd lg lh li lj aw lk bi"><span id="fbd8" class="ll jq hi lh b fi lm ln l lo lp">from azureml.core import Workspace</span><span id="f88c" class="ll jq hi lh b fi lq ln l lo lp">import azureml.core <br/>print(azureml.core.VERSION)</span></pre><ul class=""><li id="6969" class="ks kt hi ih b ii ij im in iq lr iu ls iy lt jc kx ky kz la bi translated">当我测试时，它是 1.16.0</li><li id="d504" class="ks kt hi ih b ii lb im lc iq ld iu le iy lf jc kx ky kz la bi translated">配置工作区</li></ul><pre class="je jf jg jh fd lg lh li lj aw lk bi"><span id="46b9" class="ll jq hi lh b fi lm ln l lo lp">ws = Workspace.get(name="wsname", subscription_id='subid', resource_group='rgname')</span><span id="03ee" class="ll jq hi lh b fi lq ln l lo lp">print('Workspace name: ' + ws.name, 'Azure region: ' + ws.location, 'Subscription id: ' + ws.subscription_id, 'Resource group: ' + ws.resource_group, sep = '\n')</span><span id="a480" class="ll jq hi lh b fi lq ln l lo lp">ws.write_config(path='.azureml')</span><span id="5330" class="ll jq hi lh b fi lq ln l lo lp">from azureml.core import Workspace<br/>from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException</span><span id="8a01" class="ll jq hi lh b fi lq ln l lo lp">ws = Workspace.from_config() # This automatically looks for a directory .azureml<br/># Choose a name for your CPU cluster<br/>cpu_cluster_name = "cpu-cluster"<br/># Verify that the cluster does not exist already<br/>try:<br/>cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)<br/>print('Found existing cluster, use it.')<br/>except ComputeTargetException:<br/>compute_config = AmlCompute.provisioning_configuration(vm_size='STANDARD_D2_V2',idle_seconds_before_scaledown=2400,min_nodes=0,max_nodes=4)<br/>cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)<br/>cpu_cluster.wait_for_completion(show_output=True)</span></pre><h1 id="3daf" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">获取机器学习模型的数据集</h1><pre class="je jf jg jh fd lg lh li lj aw lk bi"><span id="859f" class="ll jq hi lh b fi lm ln l lo lp">from azureml.opendatasets import NycTlcGreen<br/>import pandas as pd<br/>from datetime import datetime<br/>from dateutil.relativedelta import relativedelta</span><span id="92b2" class="ll jq hi lh b fi lq ln l lo lp">green_taxi_df = pd.DataFrame([])<br/>start = datetime.strptime("1/1/2015","%m/%d/%Y")<br/>end = datetime.strptime("1/31/2015","%m/%d/%Y")<br/><br/>for sample_month in range(12):<br/>    temp_df_green = NycTlcGreen(start + relativedelta(months=sample_month), end + relativedelta(months=sample_month)) \<br/>        .to_pandas_dataframe()<br/>    green_taxi_df = green_taxi_df.append(temp_df_green.sample(2000))<br/><br/>green_taxi_df.head(10)</span><span id="2463" class="ll jq hi lh b fi lq ln l lo lp">def build_time_features(vector):<br/>    pickup_datetime = vector[0]<br/>    month_num = pickup_datetime.month<br/>    day_of_month = pickup_datetime.day<br/>    day_of_week = pickup_datetime.weekday()<br/>    hour_of_day = pickup_datetime.hour<br/><br/>    return pd.Series((month_num, day_of_month, day_of_week, hour_of_day))<br/><br/>green_taxi_df[["month_num", "day_of_month","day_of_week", "hour_of_day"]] = green_taxi_df[["lpepPickupDatetime"]].apply(build_time_features, axis=1)<br/>green_taxi_df.head(10)</span><span id="f929" class="ll jq hi lh b fi lq ln l lo lp">columns_to_remove = ["lpepPickupDatetime", "lpepDropoffDatetime", "puLocationId", "doLocationId", "extra", "mtaTax",<br/>                     "improvementSurcharge", "tollsAmount", "ehailFee", "tripType", "rateCodeID",<br/>                     "storeAndFwdFlag", "paymentType", "fareAmount", "tipAmount"<br/>                    ]<br/>for col in columns_to_remove:<br/>    green_taxi_df.pop(col)<br/><br/>green_taxi_df.head(5)</span><span id="fef1" class="ll jq hi lh b fi lq ln l lo lp">green_taxi_df.describe()</span><span id="f298" class="ll jq hi lh b fi lq ln l lo lp">final_df = green_taxi_df.query("pickupLatitude&gt;=40.53 and pickupLatitude&lt;=40.88")<br/>final_df = final_df.query("pickupLongitude&gt;=-74.09 and pickupLongitude&lt;=-73.72")<br/>final_df = final_df.query("tripDistance&gt;=0.25 and tripDistance&lt;31")<br/>final_df = final_df.query("passengerCount&gt;0 and totalAmount&gt;0")<br/><br/>columns_to_remove_for_training = ["pickupLongitude", "pickupLatitude", "dropoffLongitude", "dropoffLatitude"]<br/>for col in columns_to_remove_for_training:<br/>    final_df.pop(col)</span><span id="bfc8" class="ll jq hi lh b fi lq ln l lo lp">final_df.describe()</span></pre><h1 id="eee9" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建机器学习模型</h1><pre class="je jf jg jh fd lg lh li lj aw lk bi"><span id="c984" class="ll jq hi lh b fi lm ln l lo lp">from sklearn.model_selection import train_test_split<br/><br/>x_train, x_test = train_test_split(final_df, test_size=0.2, random_state=223)</span><span id="47e0" class="ll jq hi lh b fi lq ln l lo lp">import logging<br/><br/>automl_settings = {<br/>    "iteration_timeout_minutes": 2,<br/>    "experiment_timeout_hours": 0.3,<br/>    "enable_early_stopping": True,<br/>    "primary_metric": 'spearman_correlation',<br/>    "featurization": 'auto',<br/>    "verbosity": logging.INFO,<br/>    "n_cross_validations": 5<br/>}</span><span id="0abf" class="ll jq hi lh b fi lq ln l lo lp">from azureml.train.automl import AutoMLConfig<br/><br/>automl_config = AutoMLConfig(task='regression',<br/>                             debug_log='automated_ml_errors.log',<br/>                             training_data=x_train,<br/>                             label_column_name="totalAmount",<br/>                             **automl_settings)</span><span id="5068" class="ll jq hi lh b fi lq ln l lo lp">from azureml.core.experiment import Experiment<br/>experiment = Experiment(ws, "taxi-experiment-fromsynapsews")<br/>local_run = experiment.submit(automl_config, show_output=True)</span><span id="cf7f" class="ll jq hi lh b fi lq ln l lo lp">best_run, fitted_model = local_run.get_output()<br/>print(best_run)<br/>print(fitted_model)</span><span id="660a" class="ll jq hi lh b fi lq ln l lo lp">y_test = x_test.pop("totalAmount")<br/><br/>y_predict = fitted_model.predict(x_test)<br/>print(y_predict[:10])</span><span id="62d6" class="ll jq hi lh b fi lq ln l lo lp">from sklearn.metrics import mean_squared_error<br/>from math import sqrt<br/><br/>y_actual = y_test.values.flatten().tolist()<br/>rmse = sqrt(mean_squared_error(y_actual, y_predict))<br/>rmse</span></pre><p id="9e77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">-计算 MAPE 和精确度</p><pre class="je jf jg jh fd lg lh li lj aw lk bi"><span id="c23d" class="ll jq hi lh b fi lm ln l lo lp">from sklearn.metrics import mean_squared_error<br/>from math import sqrt<br/><br/>y_actual = y_test.values.flatten().tolist()<br/>rmse = sqrt(mean_squared_error(y_actual, y_predict))<br/>rmse</span><span id="aaf6" class="ll jq hi lh b fi lq ln l lo lp">Output:<br/>Model MAPE: 0.1393469862795163 Model Accuracy: 0.8606530137204838</span></pre></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="b2f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mb">最初发表于</em><a class="ae mc" href="https://github.com/balakreshnan/synapseAnalytics/blob/master/synapseworkspace/azureMLtest.md" rel="noopener ugc nofollow" target="_blank"><em class="mb">【https://github.com】</em></a><em class="mb">。</em></p></div></div>    
</body>
</html>