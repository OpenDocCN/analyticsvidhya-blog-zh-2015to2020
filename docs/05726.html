<html>
<head>
<title>Basic Django Database Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基本Django数据库查询</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/basic-django-postgresql-database-queries-6b45795f26eb?source=collection_archive---------21-----------------------#2020-04-30">https://medium.com/analytics-vidhya/basic-django-postgresql-database-queries-6b45795f26eb?source=collection_archive---------21-----------------------#2020-04-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9838" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Django附带了一个强大的数据库抽象API，可以让您轻松地创建、检索、更新和删除对象。Django <strong class="ih hj">对象关系映射器</strong>与MySQL、PostgreSQL、SQLite和Oracle兼容。请记住，您可以在您项目的<em class="jd"> settings.py </em>文件的<em class="jd">数据库</em>设置中定义您项目的数据库。Django可以同时处理多个数据库，您可以对数据库路由器进行编程，以创建定制的路由方案。</p><p id="b3ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你创建了你的数据模型，Django会给你一个免费的API来与它们交互。你可以在<a class="ae je" href="https://docs.djangoproject.com/en/2.2/ref/models/" rel="noopener ugc nofollow" target="_blank">https://docs.djangoproject.com/en/2.2/ref/models/</a>找到官方文档的数据模型参考。</p><h2 id="0784" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">创建对象</h2><p id="3d67" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">打开终端并运行以下命令打开Python shell:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="1cb0" class="jf jg hi kk b fi ko kp l kq kr"><strong class="kk hj">python manage.py shell</strong></span></pre><p id="227c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，键入以下几行:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="5830" class="jf jg hi kk b fi ko kp l kq kr"><strong class="kk hj">&gt;&gt;&gt; from django.contrib.auth.models import User</strong><br/><strong class="kk hj">&gt;&gt;&gt; from blog.models import Post</strong><br/><strong class="kk hj">&gt;&gt;&gt; user = User.objects.get(username='admin')</strong><br/><strong class="kk hj">&gt;&gt;&gt; post = Post(title='Another post',</strong><br/><strong class="kk hj">                slug='another-post',</strong><br/><strong class="kk hj">                body='Post body.',</strong><br/><strong class="kk hj">                author=user)</strong><br/><strong class="kk hj">&gt;&gt;&gt; post.save()</strong></span></pre><p id="aafd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们来分析一下这段代码是做什么的。首先，我们检索用户名为<em class="jd"> admin </em>的<em class="jd">用户</em>对象:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="3d3e" class="jf jg hi kk b fi ko kp l kq kr">user = User.objects.get(username='admin')</span></pre><p id="5ec0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd"> get() </em>方法允许您从数据库中检索单个对象。请注意，该方法期望得到与查询匹配的结果。如果数据库没有返回结果，该方法将引发一个<em class="jd">不存在</em>异常，如果数据库返回多个结果，将引发一个<em class="jd">多对象返回</em>异常。这两个例外都是执行查询的模型类的属性。</p><p id="2b24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们创建一个带有自定义标题、slug和body的<em class="jd"> Post </em>实例，并将之前检索到的用户设置为帖子的作者:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="6a4e" class="jf jg hi kk b fi ko kp l kq kr">post = Post(title='Another post', slug='another-post', body='Post body.', author=user)</span></pre><p id="9a39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">对象在内存中，没有保存到数据库中。</em></p><p id="fc63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们使用<em class="jd"> save() </em>方法将<em class="jd"> Post </em>对象保存到数据库:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="1918" class="jf jg hi kk b fi ko kp l kq kr">post.save()</span></pre><p id="4b48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">前面的操作在后台执行一个<em class="jd"> INSERT </em> SQL语句。我们必须首先在内存中创建一个对象，然后将它持久化到数据库中，但是我们也可以使用<em class="jd"> create() </em>方法在一个操作中创建该对象并将其持久化到数据库中，如下所示:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="4794" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.create(title='One more post', slug='one-more-post', body='Post body.', author=user)</span></pre><h2 id="f0ac" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">更新对象</h2><p id="8688" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">现在，将文章的标题改为不同的名称，并再次保存对象:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="d751" class="jf jg hi kk b fi ko kp l kq kr"><strong class="kk hj">&gt;&gt;&gt; post.title = 'New title'</strong><br/><strong class="kk hj">&gt;&gt;&gt; post.save()</strong></span></pre><p id="d77b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，<em class="jd"> save() </em>方法执行一个<em class="jd"> UPDATE </em> SQL语句。</p><p id="ea4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">在调用</em><strong class="ih hj"><em class="jd">save()</em></strong><em class="jd">方法之前，您对对象所做的更改不会持久保存到数据库中。</em></p><h2 id="830a" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">检索对象</h2><p id="c918" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">Django <strong class="ih hj">对象关系映射</strong> ( <strong class="ih hj"> ORM </strong>)是基于QuerySets的。QuerySet是数据库中对象的集合，可以有几个过滤器来限制结果。您已经知道如何使用<em class="jd"> get() </em>方法从数据库中检索单个对象。我们已经使用<em class="jd"> Post.objects.get() </em>访问了这个方法。每个Django模型至少有一个管理器，默认的管理器叫做<strong class="ih hj"> objects </strong>。您使用模型管理器获得了一个<em class="jd"> QuerySet </em>对象。要从表中检索所有对象，只需使用默认对象管理器上的<em class="jd"> all() </em>方法，如下所示:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="b4d8" class="jf jg hi kk b fi ko kp l kq kr"><strong class="kk hj">&gt;&gt;&gt; all_posts = Post.objects.all()</strong></span></pre><p id="b932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我们如何创建一个返回数据库中所有对象的QuerySet。请注意，这个QuerySet尚未执行。django query sets<em class="jd">懒</em>；只有当他们需要被强迫时，他们才会被评估。这种行为使得<em class="jd">查询集</em>非常高效。如果我们不将<em class="jd"> QuerySet </em>设置为一个变量，而是将它直接写在Python shell上，QuerySet的SQL语句将被执行，因为我们强制它输出结果:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="25a5" class="jf jg hi kk b fi ko kp l kq kr"><strong class="kk hj">&gt;&gt;&gt; Post.objects.all()</strong></span></pre><h2 id="2b85" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">使用filter()方法</h2><p id="53b3" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">要过滤一个查询集，可以使用管理器的<em class="jd"> filter() </em>方法。例如，我们可以使用以下查询集检索2020年发布的所有帖子:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="b993" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.filter(publish__year=2020)</span></pre><p id="3b7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以筛选多个字段。例如，我们可以用用户名<em class="jd"> admin </em>检索作者在2020年发表的所有帖子:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="6d02" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.filter(publish__year=2020, author__username='admin')</span></pre><p id="1e8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这相当于构建相同的查询集链接多个过滤器:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="70ba" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.filter(publish__year=2020) \<br/>            .filter(author__username='admin')</span></pre><p id="b5d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">具有字段查找方法的查询是使用两个下划线构建的，例如</em><strong class="ih hj"><em class="jd">publish _ _ year</em></strong><em class="jd">，但是访问相关模型的字段也使用相同的表示法，例如</em><strong class="ih hj"><em class="jd">author _ _ username</em></strong><em class="jd">。</em></p><h2 id="346a" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated"><strong class="ak">使用exclude() </strong></h2><p id="06e1" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">您可以使用管理器的<em class="jd"> exclude() </em>方法从查询集中排除某些结果。例如，我们可以检索2020年发布的标题不以<em class="jd">开头的所有帖子，为什么</em>:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="015c" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.filter(publish__year=2020) \<br/>            .exclude(title__startswith='Why')</span></pre><h2 id="4a4b" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated"><strong class="ak">使用order_by() </strong></h2><p id="d4e8" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">您可以使用管理器的<em class="jd"> order_by() </em>方法按不同的字段对结果进行排序。例如，您可以检索按标题排序的所有对象，如下所示:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="fc75" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.order_by('title')</span></pre><p id="5958" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">升序是隐含的。您可以用负号前缀表示降序，如下所示:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="e033" class="jf jg hi kk b fi ko kp l kq kr">Post.objects.order_by('<strong class="kk hj">-</strong>title')</span></pre><h2 id="4304" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">删除对象</h2><p id="2e01" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">如果您想要删除一个对象，您可以使用<em class="jd"> delete() </em>方法从对象实例中删除它:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="c65c" class="jf jg hi kk b fi ko kp l kq kr">post = Post.objects.get(id=1)<br/>post.delete()</span></pre><p id="f534" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">请注意，删除对象也会删除任何依赖关系。</em></p><h1 id="774a" class="ks jg hi bd jh kt ku kv jl kw kx ky jp kz la lb js lc ld le jv lf lg lh jy li bi translated">评估查询集时</h1><p id="fbd6" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">您可以将任意数量的过滤器连接到一个QuerySet，并且在对QuerySet进行评估之前，您不会命中数据库。查询集仅在以下情况下计算:</p><ol class=""><li id="3b4f" class="lj lk hi ih b ii ij im in iq ll iu lm iy ln jc lo lp lq lr bi translated">第一次迭代它们时</li><li id="c54d" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">例如，当您对它们进行切片时，<em class="jd"> Post.objects.all()[:3] </em></li><li id="f8c0" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">当你腌制或储藏它们时</li><li id="9d91" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">当你在上面呼叫<em class="jd"> repr() </em>或<em class="jd"> len() </em>时</li><li id="2f6a" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">当您显式地对它们调用<em class="jd"> list() </em>时</li><li id="bda7" class="lj lk hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">当你在一个语句中测试它们的时候，比如<em class="jd"> bool() </em>，<em class="jd">或者</em>，<em class="jd">和</em>，或者<em class="jd"> if </em></li></ol></div></div>    
</body>
</html>