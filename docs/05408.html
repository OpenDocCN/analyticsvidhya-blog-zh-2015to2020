<html>
<head>
<title>Azure Functions &amp; Event Hub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure功能和活动中心</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-functions-event-hub-2603e8804f73?source=collection_archive---------1-----------------------#2020-04-20">https://medium.com/analytics-vidhya/azure-functions-event-hub-2603e8804f73?source=collection_archive---------1-----------------------#2020-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a9ff34fda279ef2385ce39a1a060fa55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PrCwQ5zJtUo-MSIzIioZzA.png"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="5d5f" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">在我的上一篇文章中，我解释了什么是Azure Function及其组件。在本文中，我们将讨论什么是事件中心，以及如何使用Azure函数处理来自事件中心的事件。代码将在Python中。</p><p id="94c4" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">要查看我之前关于Azure函数的文章，请点击下面的链接:</p><div class="jv jw ez fb jx jy"><a rel="noopener follow" target="_blank" href="/@maheshwari.mohit/microsoft-azure-functions-e1d8acd246a1"><div class="jz ab dw"><div class="ka ab kb cl cj kc"><h2 class="bd hj fi z dy kd ea eb ke ed ef hh bi translated">微软Azure函数</h2><div class="kf l"><h3 class="bd b fi z dy kd ea eb ke ed ef dx translated">什么是Azure函数？</h3></div><div class="kg l"><p class="bd b fp z dy kd ea eb ke ed ef dx translated">medium.com</p></div></div><div class="kh l"><div class="ki l kj kk kl kh km io jy"/></div></div></a></div></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><blockquote class="kn ko kp"><p id="0a8f" class="ix iy kq iz b ja jb jc jd je jf jg jh kr jj jk jl ks jn jo jp kt jr js jt ju hb bi translated"><strong class="iz hj">什么是活动中心？</strong></p></blockquote><p id="730a" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">Azure Event Hub是一个大数据流平台&amp;事件摄取系统。它基于发布-订阅模型。类似阿帕奇卡夫卡。Event Hub提供低延迟的分布式流处理平台，并与Azure内外的数据和分析服务无缝集成。</p><blockquote class="kn ko kp"><p id="1ece" class="ix iy kq iz b ja jb jc jd je jf jg jh kr jj jk jl ks jn jo jp kt jr js jt ju hb bi translated"><strong class="iz hj">关键术语&amp;活动中心的组成部分。</strong></p></blockquote><ol class=""><li id="0947" class="ku kv hi iz b ja jb je jf ji kw jm kx jq ky ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq">事件中心名称空间→ </em> </strong>这些是包含或存储事件中心的容器。也称为阿帕奇卡夫卡式的话题。单个事件中心命名空间可以存储多个事件中心。</li><li id="45d3" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq"> Event Hub → </em> </strong>这些是记录发布的存储。它类似于卡夫卡中的主题。它由我们可以在Azure Portal上创建事件中心时定义的分区组成。</li><li id="d24f" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq">事件数据→ </em> </strong>它包含事件的主体，是一个二进制流。事件以二进制形式存储在分区中。</li><li id="8abd" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq">发布者→ </em> </strong>任何向事件中心发送/发布数据/事件的实体。Publisher可以使用两种类型的协议来发送/发布数据，即HTTP和AMQP。对于少量数据，使用HTTP，对于大量数据，使用AMQP。</li><li id="f9e2" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq">分区→ </em> </strong>分区就像事件中心的一个大块，发布者将在这里发布事件。在Event Hubs中，即使消费者已经读取了数据，分区也会保留数据。此外，它还维护一个可自定义的保留期，并且不可能手动删除事件。</li><li id="33ed" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq">消费群体→ </em> </strong>消费群体就像是一个事件的观点枢纽。单个消费者群体可以由不同的消费者消费，每个消费者都有单独的事件视图，并且可以相应地以他们自己的速度和偏移量消费。一个活动中心可以有多个消费者群体。</li><li id="efcb" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj"> <em class="kq">捕获数据→ </em> </strong>创建活动中心时，我们可以启用捕获数据选项。如果我们希望在以后的某个时间点，甚至在保留期结束后，在事件中心保留生产者发送的事件，这个选项是很有帮助的。</li></ol></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="3f3e" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">在本帖中，我们将看到如何查看代码和部署azure函数，只要事件中心的生产者发布任何事件，就会触发该函数。然后，将使用函数中的输出绑定或实际代码将该事件数据存储到blob存储中。</p><p id="6a73" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated"><strong class="iz hj">先决条件→ </strong></p><ul class=""><li id="c9a3" class="ku kv hi iz b ja jb je jf ji kw jm kx jq ky ju li la lb lc bi translated">Azure功能核心工具</li><li id="aedf" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated">Azure CLI</li><li id="8b6f" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated">计算机编程语言</li><li id="9f15" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated">一个函数应用程序[在本地系统上][查看我以前的一篇关于如何创建函数应用程序的文章]</li></ul><blockquote class="kn ko kp"><p id="fe1c" class="ix iy kq iz b ja jb jc jd je jf jg jh kr jj jk jl ks jn jo jp kt jr js jt ju hb bi translated">遵循以下步骤→</p></blockquote><ol class=""><li id="2bad" class="ku kv hi iz b ja jb je jf ji kw jm kx jq ky ju kz la lb lc bi translated"><strong class="iz hj">打开您在本地系统创建的功能app。</strong></li><li id="7361" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju kz la lb lc bi translated"><strong class="iz hj">打开local.settings.json文件</strong></li></ol><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="2b35" class="ls lt hi lo b fi lu lv l lw lx">{</span><span id="d73f" class="ls lt hi lo b fi ly lv l lw lx">"IsEncrypted": false,</span><span id="879c" class="ls lt hi lo b fi ly lv l lw lx">"Values": {</span><span id="afbf" class="ls lt hi lo b fi ly lv l lw lx">"FUNCTIONS_WORKER_RUNTIME": "python",</span><span id="ea2b" class="ls lt hi lo b fi ly lv l lw lx"><strong class="lo hj">"AzureWebJobsStorage"</strong>: <strong class="lo hj">[Paste the Storage account connection string which is linked with your Azure function that you have Created on Azure Portal]</strong>,</span><span id="5cbe" class="ls lt hi lo b fi ly lv l lw lx">"FUNCTIONS_EXTENSION_VERSION": "~2",</span><span id="a169" class="ls lt hi lo b fi ly lv l lw lx"><strong class="lo hj">"receiverConnectionString":</strong> <strong class="lo hj">[Paste the Endpoint Connection String of the EventHubNamespace here in double quotes and remove these brackets.],</strong></span><span id="a703" class="ls lt hi lo b fi ly lv l lw lx"><strong class="lo hj">"MyStorageConnectionString": [Paste the Endpoint Connection String of the blob storage account here in double quotes and remove these brackets.]</strong></span><span id="4adf" class="ls lt hi lo b fi ly lv l lw lx">},</span><span id="09b1" class="ls lt hi lo b fi ly lv l lw lx">"ConnectionStrings": {}</span><span id="d829" class="ls lt hi lo b fi ly lv l lw lx">}</span></pre><p id="39af" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">3.<strong class="iz hj">打开function.json文件。</strong></p><p id="76e9" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">在这个文件中，我们将编写代码将azure函数与事件中心绑定，这样它将在生成器发布任何新事件时自动运行，并将为blob存储指定输出绑定。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="1574" class="ls lt hi lo b fi lu lv l lw lx">{</span><span id="1509" class="ls lt hi lo b fi ly lv l lw lx">"scriptFile": "__init__.py",</span><span id="4009" class="ls lt hi lo b fi ly lv l lw lx">"bindings": [{</span><span id="703f" class="ls lt hi lo b fi ly lv l lw lx"><strong class="lo hj">"type": "eventHubTrigger"</strong>,</span><span id="8419" class="ls lt hi lo b fi ly lv l lw lx">"name": "events",</span><span id="a750" class="ls lt hi lo b fi ly lv l lw lx">"direction": "in",</span><span id="4cd2" class="ls lt hi lo b fi ly lv l lw lx"><strong class="lo hj">"eventHubName"</strong>: <strong class="lo hj">[Enter the name of your event hub in double quotes and remove these brackets.]</strong>,</span><span id="be59" class="ls lt hi lo b fi ly lv l lw lx"><strong class="lo hj">"connection":</strong> <strong class="lo hj">"receiverConnectionString"</strong>,</span><span id="cfbc" class="ls lt hi lo b fi ly lv l lw lx">"cardinality": "many",</span><span id="a66c" class="ls lt hi lo b fi ly lv l lw lx">"consumerGroup": "$Default",</span><span id="13a7" class="ls lt hi lo b fi ly lv l lw lx">"dataType": "binary"</span><span id="0d04" class="ls lt hi lo b fi ly lv l lw lx">},<br/>{<br/><strong class="lo hj">"name": "outputblob"</strong>,       <br/>"type": "blob",       <br/><strong class="lo hj">"path": [Enter the path of the folder where you want to store the data in double quotes and remove these brackets.]</strong>,       <br/><strong class="lo hj">"connection": "MyStorageConnectionString"</strong>,       <br/>"direction": "out"</span><span id="29ce" class="ls lt hi lo b fi ly lv l lw lx">}]</span><span id="86f6" class="ls lt hi lo b fi ly lv l lw lx">}</span></pre><ul class=""><li id="2124" class="ku kv hi iz b ja jb je jf ji kw jm kx jq ky ju li la lb lc bi translated">在上面的代码中,<code class="du lz ma mb lo b">"type":"eventHubTrigger"</code>指定了azure函数在事件中心的触发器。</li><li id="6e1f" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated"><code class="du lz ma mb lo b">"eventHubName":"Value"</code>指定事件将被接收到哪个事件中心，以便azure函数将被触发。</li><li id="ecff" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated">确保local.setting.json文件中存在“连接”的值，即<code class="du lz ma mb lo b">"connection":"receiverConnectionString"</code>。如果您向上滚动并检查local.setting.json的代码，您会看到<em class="kq">“receiver connection string”键出现在其中。</em></li><li id="cc02" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated"><code class="du lz ma mb lo b">"name":"outputblob"</code>是blob存储的输出绑定的名称，将在代码中使用它来引用输出blob。您可以给出任何名称，只要确保在代码中使用相同的名称即可，例如__init__。py文件。</li><li id="b732" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated"><code class="du lz ma mb lo b">"path":"Value"</code>这将是你想要存储由函数处理的输出数据的文件夹或目录的路径。</li><li id="10eb" class="ku kv hi iz b ja ld je le ji lf jm lg jq lh ju li la lb lc bi translated">确保local.setting.json文件中存在“connection”的值，即<code class="du lz ma mb lo b">"connection":"MyStorageConnectionString"</code>。如果您向上滚动并检查local.setting.json的代码，您会看到<em class="kq">“MyStorageConnectionString”键出现在其中。</em></li></ul><p id="bcd3" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">4.<strong class="iz hj">打开__Init__。py文件</strong></p><p id="01c4" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">以下代码将在生产者发布任何新事件后立即触发，并使用输出blob绑定变量<em class="kq">“output blob”</em>将事件数据放入输出blob中</p><blockquote class="kn ko kp"><p id="7b25" class="ix iy kq iz b ja jb jc jd je jf jg jh kr jj jk jl ks jn jo jp kt jr js jt ju hb bi translated"><strong class="iz hj">注意→ </strong>这里我考虑的是，生产者发布到事件中心的事件是json格式的。</p></blockquote><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="e9f2" class="ls lt hi lo b fi lu lv l lw lx">import logging <br/>import azure.functions as func   </span><span id="842a" class="ls lt hi lo b fi ly lv l lw lx">def main(events: List[func.EventHubEvent],outputblob: func.Out[func.InputStream]):   <br/>  <br/>    for event in events:<br/>        event_data = event.get_body()</span><span id="621c" class="ls lt hi lo b fi ly lv l lw lx">        logging.info(event_data)</span><span id="870d" class="ls lt hi lo b fi ly lv l lw lx">        my_json = event_data.decode('utf8').replace("'", '"')</span><span id="e0ed" class="ls lt hi lo b fi ly lv l lw lx">        event_data_json = json.loads(my_json)<br/>      <br/>        outputblob.set(event_data_json)</span></pre><blockquote class="kn ko kp"><p id="8180" class="ix iy kq iz b ja jb jc jd je jf jg jh kr jj jk jl ks jn jo jp kt jr js jt ju hb bi translated"><strong class="iz hj">注意→ </strong>上面代码的问题是输出的blob与<em class="hi"> function.json </em>文件中提到的特定路径相关联。所以每次这个函数触发时，数据都会被重写到同一个文件中。此外，非常少的定制是可能的。如果你需要更多的定制方式，然后检查第5步。</p></blockquote><p id="9c94" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">5.<strong class="iz hj">从__init__中删除之前的代码。复制文件并粘贴下面的代码。</strong></p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="fcd0" class="ls lt hi lo b fi lu lv l lw lx">import logging<br/>import azure.functions as func<br/>from azure.storage.blob import BlobServiceClient<br/>import uuid</span><span id="961e" class="ls lt hi lo b fi ly lv l lw lx">def main(events: List[func.EventHubEvent]):<br/>   <br/>    blob_service_client =BloBlobServiceClient.from_connection_string<br/>       (conn_str=<strong class="lo hj"><em class="kq">[Enter the Endpoint connection string for the blob storage account in double quotes and remove these brackets.]</em></strong>)</span><span id="0b37" class="ls lt hi lo b fi ly lv l lw lx">    try:<br/>        container_client = blob_service_client.getContainer_client("myContainer")</span><span id="7bf5" class="ls lt hi lo b fi ly lv l lw lx">    except:<br/>        container_client = blob_service_client.create_container("myContainer")</span><span id="313d" class="ls lt hi lo b fi ly lv l lw lx">    for event in events:<br/>        event_data = event.get_body()<br/>        logging.info(event_data)<br/>        my_json = event_data.decode('utf8').replace("'", '"')<br/>        event_data_json = json.loads(my_json)    <br/>    <br/>        container_client.upload_blob(name= uuid.uuid4(), data=event_data_json)<br/></span></pre><p id="4c3c" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">6.<strong class="iz hj">保存所有文件。</strong></p><p id="fdc8" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">7.<strong class="iz hj">运行命令</strong> <code class="du lz ma mb lo b"><strong class="iz hj">func start</strong></code> <strong class="iz hj">并享受🙂。</strong></p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><blockquote class="kn ko kp"><p id="f744" class="ix iy kq iz b ja jb jc jd je jf jg jh kr jj jk jl ks jn jo jp kt jr js jt ju hb bi translated"><strong class="iz hj">感谢您阅读本教程。我希望你喜欢并理解了什么是event hub，以及如何使用它作为azure功能的触发器。</strong></p></blockquote></div></div>    
</body>
</html>