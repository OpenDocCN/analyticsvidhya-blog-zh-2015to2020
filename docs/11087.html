<html>
<head>
<title>Sales Report in Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫销售报告</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/sales-report-in-pandas-c4ef777cc490?source=collection_archive---------4-----------------------#2020-11-17">https://medium.com/analytics-vidhya/sales-report-in-pandas-c4ef777cc490?source=collection_archive---------4-----------------------#2020-11-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="109b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将使用<a class="ae jd" href="https://www.kaggle.com/carrie1/ecommerce-data" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/carrie1/ecommerce-data</a>。我在 Colab 工作，将数据存储在我的 Google Drive 上。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3dd1" class="jn jo hi jj b fi jp jq l jr js">import pandas as pd</span><span id="4479" class="jn jo hi jj b fi jt jq l jr js">df = pd.read_csv('drive/My Drive/data/ecommerce-data.zip',encoding = "cp1252")</span><span id="a1d4" class="jn jo hi jj b fi jt jq l jr js">df.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ju"><img src="../Images/85b4e916b14a8456e688b2c6c8d0086a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dFWnQHWQmUXTDGwTF6t1Q.png"/></div></div></figure><p id="e480" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看缺失值。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="c498" class="jn jo hi jj b fi jp jq l jr js">df.isna().mean()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es kc"><img src="../Images/f366891f14511b9fb4a38b0bd9d82957.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*61Q_QPRTrRUhQWaFCubQJw.png"/></div></figure><p id="d7ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用某个数字填充缺少的 CustomerID，以便将这些客户归入 groupby:默认情况下，group by 忽略 NaN。我用负数填充它以保留数字类型。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="1cdf" class="jn jo hi jj b fi jp jq l jr js">df['CustomerID'].fillna(-999,inplace=True)</span></pre><p id="f5bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将文本日期转换为 python 日期。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4d1a" class="jn jo hi jj b fi jp jq l jr js">df['InvoiceDate'] = pd.to_datetime(df['InvoiceDate'],format='%m/%d/%Y %H:%M')</span></pre><p id="65b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看我们有什么时间段。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="04b2" class="jn jo hi jj b fi jp jq l jr js">df['InvoiceDate'].min()</span></pre><p id="c551" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">时间戳(“2010 年 12 月 1 日 08:26:00”)</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="12cf" class="jn jo hi jj b fi jp jq l jr js">df['InvoiceDate'].max()</span></pre><p id="c546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">时间戳(“2011 年 12 月 9 日 12:50:00”)</p><p id="b4de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大概一年吧。好的。现在让我们创建一份月度销售报告。</p><h1 id="bed2" class="kd jo hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">1.创建包含唯一用户的表</h1><p id="9a85" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">在现实生活中，数据库中总有这样一个表。但在这种情况下，我们没有它。我还在这个表中添加了一个注册日期，这只是每个客户的最小发票日期。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="271a" class="jn jo hi jj b fi jp jq l jr js">user = df.groupby(['CustomerID'])['InvoiceDate'].min().reset_index()<br/>user.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es lf"><img src="../Images/cbe09e06fb359113fb23d98aab4c2e33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*qEFrpSFo2Wdc9Lgg5q97ww.png"/></div></figure><p id="c705" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重命名列。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="4bae" class="jn jo hi jj b fi jp jq l jr js">user.columns = ['CustomerID','reg_date']</span></pre><p id="8378" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加注册月份。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="dc56" class="jn jo hi jj b fi jp jq l jr js">user['reg_month'] = user['reg_date'].values.astype('datetime64[M]')</span></pre><p id="05fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不用担心)。这只是谷歌关于“熊猫如何获得月的第一天”的第一个链接<a class="ae jd" href="https://stackoverflow.com/questions/45304531/extracting-the-first-day-of-month-of-a-datetime-type-column-in-pandas" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/45304531/extracting-a-datetime-type-column-in-pandas</a></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="980b" class="jn jo hi jj b fi jp jq l jr js">user</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es lg"><img src="../Images/57d7a8fbafb270c637171b8dd3ec6cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KRM8mD9Ae3vjpnyKGYOmGA.png"/></div></div></figure><h1 id="a103" class="kd jo hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">2.为每个用户生成每个可能月份的模板表。</h1><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d4f2" class="jn jo hi jj b fi jp jq l jr js">min_month = df['InvoiceDate'].values.astype('datetime64[M]').min()<br/>max_month = df['InvoiceDate'].values.astype('datetime64[M]').max()<br/>dr = pd.DataFrame(pd.date_range(min_month,max_month,freq='MS'))<br/>dr.columns = ['month']</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es lh"><img src="../Images/da7ec335ba7094516cd11d56b93bfa83.png" data-original-src="https://miro.medium.com/v2/resize:fit:520/format:webp/1*GDkIIdmvp1RLB21pfhfNKQ.png"/></div></figure><p id="0235" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们必须对用户表执行交叉连接，并获取</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="59bf" class="jn jo hi jj b fi jp jq l jr js">len(user)*len(dr)</span></pre><p id="a77c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">行。在熊猫身上，它可以像这样表演。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d956" class="jn jo hi jj b fi jp jq l jr js">dr['key'] = 1<br/>user['key'] = 1<br/>report = dr.merge(user,on='key')<br/>report.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es li"><img src="../Images/cad9978358cdc5dbda3d615a3d2efe30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-jsXNitG1yZdFE7JmWYvoA.png"/></div></div></figure><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a4cc" class="jn jo hi jj b fi jp jq l jr js">len(report)</span></pre><p id="2517" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">56849</p><p id="e190" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如我所料。但是我们有一些额外的行:一些用户在最小日期(2010-12)之后很久才来，在用户来之前就有他的记录是愚蠢的。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="41dc" class="jn jo hi jj b fi jp jq l jr js">report = report[report['month']&gt;=report['reg_month']]</span></pre><p id="7ca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看一些特定的用户，以便做一个理智的检查。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="c8e0" class="jn jo hi jj b fi jp jq l jr js">report[report['CustomerID'] == 12346.0]</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es lj"><img src="../Images/67262e722964f30617f1efd0dc510f5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_3nFL1No3-h4bu0XL-NMQA.png"/></div></div></figure><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2d68" class="jn jo hi jj b fi jp jq l jr js">report[report['CustomerID'] == 12448.0]</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es lk"><img src="../Images/47e4e8f5c1dca443343fe39e4d77e670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SEfGA5Hi_JM4OaV7upAYdQ.png"/></div></div></figure><p id="941a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以将销售信息加入到这个模板中。但是在做之前，我们应该做一些准备。</p><h1 id="bc56" class="kd jo hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">3.在与模板连接之前预聚合数据。</h1><p id="889a" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">计算每个客户每月的总销售额。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="635f" class="jn jo hi jj b fi jp jq l jr js">df['month'] = df['InvoiceDate'].values.astype('datetime64[M]')<br/>df['revenue'] = df['UnitPrice'] * df['Quantity']<br/>sales_month = df.groupby(['CustomerID','month'])[['revenue']].agg('sum').reset_index()<br/>sales_month.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es ll"><img src="../Images/3261f93da2d54fbdfbd3c67314cc2803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*to1G5c_o9TsrIe8nmm7biw.png"/></div></figure><p id="642e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你创建新的表格时，你应该确保你的总数是一致的。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7d40" class="jn jo hi jj b fi jp jq l jr js">df['revenue'].sum()</span></pre><p id="0ebf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">9747747.933999998</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6317" class="jn jo hi jj b fi jp jq l jr js">sales_month['revenue'].sum()</span></pre><p id="8ff1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">9747747.934000025</p><p id="73fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吧。如果你关心小小数，请阅读 https://stackoverflow.com/a/11873114/4527289 的<a class="ae jd" href="https://stackoverflow.com/a/11873114/4527289" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="b6a8" class="kd jo hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">4.加入模板</h1><p id="d3a7" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">使用左连接非常重要！使用左连接，我们保留了报告表中的所有行—这就是我们理解客户活动中的差距的方式。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9bfd" class="jn jo hi jj b fi jp jq l jr js">report = report.merge(sales_month,how='left',on=['CustomerID','month'])<br/>report.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es lm"><img src="../Images/572cb7f38383079c1afc10d849c4f7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GyoAKlXx3smOih1IGow1xA.png"/></div></div></figure><p id="ed97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查总数。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="618c" class="jn jo hi jj b fi jp jq l jr js">df['revenue'].sum()</span></pre><p id="62bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">9747747.933999998</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6e42" class="jn jo hi jj b fi jp jq l jr js">report['revenue'].sum()</span></pre><p id="4981" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">9747747.934000023</p><p id="7763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">酷毙了。现在对一位顾客进行另一项健康检查。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="db80" class="jn jo hi jj b fi jp jq l jr js">report[report['CustomerID'] == 12347.0]</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ln"><img src="../Images/f38879288f694c6ebf5af333e6be41d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OxvARs1nSsU9qViTrZEUvg.png"/></div></div></figure><p id="1258" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到这个客户的活动并不规律！例如，在 2011 年 1 月 1 日之后有两个月的暂停购买。然后购买又开始了。</p><h1 id="1a04" class="kd jo hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">5.基本指标</h1><p id="9764" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">添加总用户数、活跃用户数和新用户数。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="3815" class="jn jo hi jj b fi jp jq l jr js">report['user'] = 1<br/>report['new'] = (report['reg_month'] == report['month']) * 1<br/>report['active'] = (report['revenue'] &gt; 0) * 1<br/>report.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es lo"><img src="../Images/77ebf5be5569166c8b390439a029415d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ykPfO4O0T6fWtAoj7VYDgw.png"/></div></div></figure><p id="e4bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您可以从该表创建月度报告。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2bd6" class="jn jo hi jj b fi jp jq l jr js">report.groupby('month')[['revenue','user','new','active']].agg('sum')</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es lp"><img src="../Images/634039d0e00f48f69ace200d27cfbe8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Kow8AHMbxXM9ANtc3QDBg.png"/></div></div></figure><p id="896e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">多酷啊。</p><p id="bec7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是创建各种报告的非常健壮的方法:每天、每周、每月。如果你生成所有可能的日期，你将不会错过任何事情。但是请记住，由于交叉连接的原因，这种方法是不可伸缩的:如果您有很多客户，您将会得到一个巨大的模板表。但根据我经验，它在拥有 20 万客户的中型企业中运行得很好:monty report 运行得很好。但是请不要每天都尝试)。</p><p id="94a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，你最好用 sql 来做这件事。Sql 在处理这类操作时要强大得多。</p><p id="afc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我认为有很多更聪明的方法来创建销售报告，而不需要如此庞大稀疏的表格，但我喜欢这种简单的方法。因为很简单，所以省了你很多痛苦。但这是有代价的。</p><p id="17bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里是 colab 笔记本:<a class="ae jd" href="https://colab.research.google.com/drive/1WP3Mtj_8MvroC4ucVlh0a_ChuBzeNe8f?usp=sharing" rel="noopener ugc nofollow" target="_blank">https://colab . research . Google . com/drive/1 WP 3 mtj _ 8 mvroc 4 ucvlh 0 a _ chub zene 8 f？usp =共享</a></p><p id="7ed5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的阅读。也可以在 https://www.glebmikhaylov.com/的<a class="ae jd" href="https://www.glebmikhaylov.com/" rel="noopener ugc nofollow" target="_blank">和 https://www.youtube.com/channel/UCLdAnxmoGVySnh691CwDz9Q 的</a><a class="ae jd" href="https://www.youtube.com/channel/UCLdAnxmoGVySnh691CwDz9Q" rel="noopener ugc nofollow" target="_blank">我的 YouTube 频道</a>找到我。</p></div></div>    
</body>
</html>