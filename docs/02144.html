<html>
<head>
<title>Airflow XCom pull and push under the hood: Multiple values, from different DAGs and etc</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通风橱下的气流XCom推拉:来自不同Dag等的多个值</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/airflow-xcom-pull-and-push-under-the-hood-multiple-value-from-different-dags-and-etc-2b9b3a942299?source=collection_archive---------1-----------------------#2019-12-03">https://medium.com/analytics-vidhya/airflow-xcom-pull-and-push-under-the-hood-multiple-value-from-different-dags-and-etc-2b9b3a942299?source=collection_archive---------1-----------------------#2019-12-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a1ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不久前，我的一个大学问了我一个不难的问题。但是看起来，这个问题的范围在官方文件中没有足够的强调。</p><p id="9cb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题是:</strong>“我如何获得由另一个DAG的任务推送的Xcom？”</p><p id="2e39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你在这里，我想，你知道那是阿帕奇气流中的Xcom。如果没有——首先阅读官方文件【https://airflow.apache.org/concepts.html? T2】highlight = xcom # xcom</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/2f160108fb9bf3364a0eb5116dc0e214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*09C8p8QzCnYTluTZMn4j3w.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">Apache Airflow UI中的Xcom</figcaption></figure><p id="71e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们理解这是作为Python语言本质的<strong class="ih hj"> Xcom </strong>:它如何定义，它如何找到默认情况下只与你的DAG运行相关的值等等。</p><h2 id="ec91" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">作为Python类的Xcom</h2><p id="5e52" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Xcom是一个数据模型，它被定义为一个SQL-alchemy类，上面有一些额外的方法。如果你会进入Apache Airflow sources并且会看一看它:<a class="ae jd" href="https://github.com/apache/airflow/blob/v1-10-stable/airflow/models/xcom.py#L41" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/air flow/blob/v1-10-stable/air flow/models/xcom . py # L41</a>你会看到，我没有骗你:)</p><p id="cae8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，离开这段代码，回到作为开发人员的Xcom是如何拉和推的？您通常在Jinja模板中的运算符中使用同名方法，如'<strong class="ih hj">{ { ti . xcom _ push(…)} '</strong>，或者在Python函数(可调用对象)中使用in with Python operator或smth relative with<strong class="ih hj">context[' ti ']。xcom_pull(key=None，task_ids='push_values') </strong>。这两种方式都使用相同的方法:task的实例方法pull和push。</p><p id="309f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哪里也没有魔法。让我们转到任务实例类。</p><h1 id="d140" class="ku jv hi bd jw kv kw kx ka ky kz la ke lb lc ld kh le lf lg kk lh li lj kn lk bi translated">任务实例方法</h1><h2 id="75b2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">xcom_push</h2><p id="4af5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我们到了:<a class="ae jd" href="https://github.com/apache/airflow/blob/v1-10-stable/airflow/models/taskinstance.py#L1485" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/air flow/blob/v1-10-stable/air flow/models/task instance . py # l 1485</a></p><p id="9f11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个任务实例的方法<strong class="ih hj"> xcom_push </strong>，您使用它来发送Apache Airflow后端数据库中<strong class="ih hj"> Xcom </strong>表中的一些值。正如您在这段代码的“从源代码复制粘贴”部分所看到的:</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="96bd" class="ju jv hi lm b fi lq lr l ls lt">XCom.set(<br/>    key=key, <br/>    value=value, <br/>    task_id=self.task_id,<br/>    dag_id=self.dag_id,<br/>    execution_date=execution_date or self.execution_date)</span></pre><p id="1724" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它只是用params调用<strong class="ih hj"> Xcom </strong>对象的<strong class="ih hj"> set </strong>方法。你可以自己看看这个方法(Xcom源代码的链接在上面)，这不是很重要。</p><p id="e4ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于<strong class="ih hj"> execution_date </strong>一直存在于你的<strong class="ih hj"> xcom-record </strong>的问题，这是导入。第二件事——您可以手动传递不同于执行日期，所以，是的，<strong class="ih hj">您可以将execution_date作为参数提供给xcom_push </strong></p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="6de1" class="ju jv hi lm b fi lq lr l ls lt">context['ti'].xcom_push(key='some_key',  value='some_value'     execution_date=) # xcom_push with sending different execution date</span></pre><h2 id="8120" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">xcom_pull</h2><p id="3873" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在，<strong class="ih hj"> xcom_pull </strong>时间。让我们来看看来源:</p><p id="37b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/apache/airflow/blob/v1-10-stable/airflow/models/taskinstance.py#L1517" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/air flow/blob/v1-10-stable/air flow/models/task instance . py # l 1517</a></p><p id="9cff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，这段代码总是将execution_date作为参数发送给xcom_pull，所以这就是您如何仅从当前DAGRun获得<strong class="ih hj"> Xcoms </strong>的方法——因为在幕后它发送两个参数— <strong class="ih hj"> execution_date </strong>和<strong class="ih hj"> dag_id。这就是你如何得到相对于你的DAGRun的值。</strong>默认情况下，Xcom pull总是搜索具有一对一执行日期和dag_id的记录。</p><h2 id="9756" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">拆分问题“我如何获得由另一个DAG的任务提取的Xcom？”</h2><p id="1398" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">因此，要回答这个问题，我们需要在2:</p><ol class=""><li id="b2c1" class="lu lv hi ih b ii ij im in iq lw iu lx iy ly jc lz ma mb mc bi translated">我如何获得与当前运行不同的<strong class="ih hj">执行日期</strong>的<strong class="ih hj"> Xcoms </strong></li><li id="0b09" class="lu lv hi ih b ii md im me iq mf iu mg iy mh jc lz ma mb mc bi translated">如何从不同的DAG(不同的<strong class="ih hj"> dag_id </strong>)获取<strong class="ih hj"> Xcoms </strong></li></ol><p id="df2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们混合这两个问题的答案。</p><h2 id="2177" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated"><strong class="ak">获取以前运行的Xcoms】</strong></h2><p id="75f5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">现在来看看关于<a class="ae jd" href="https://github.com/apache/airflow/blob/master/airflow/models/taskinstance.py#L1327" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> xcom_pull </strong> </a>的论点:</p><p id="6ee0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/apache/airflow/blob/v1-10-stable/airflow/models/taskinstance.py#L1524" rel="noopener ugc nofollow" target="_blank">https://github . com/Apache/air flow/blob/v1-10-stable/air flow/models/task instance . py # l 1524</a></p><p id="215f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以看到，我们可以传递给Xcom拉几个参数:</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="6b63" class="ju jv hi lm b fi lq lr l ls lt">dag_id: Optional[str] = None   # answer on our question #2 </span><span id="2222" class="ju jv hi lm b fi mi lr l ls lt">include_prior_dates: bool = False  # answer on our question number #1</span></pre><p id="3b51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj"> dag_id arg </strong>全部清除的情况下，需要1个字符串— <strong class="ih hj"> dag_id </strong>，该字符串推动了<strong class="ih hj"> Xcom </strong>，这是您想要获取的。</p><p id="85eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">包含先前日期</strong>是一个标志。如果是“真”的，Airflow将搜索具有相同执行日期的记录，但也会搜索最早的记录。因此，如果您有<strong class="ih hj">execution _ date</strong>2019–12–03 23:00:00并设置<strong class="ih hj"> include_prior_dates=True，</strong>它可以找到以前推送的xcom记录，<strong class="ih hj">例如，如果我们的DAG每小时运行一次，</strong>在<strong class="ih hj"/>2019–12–03 22:00:00<strong class="ih hj">中以前运行。</strong></p><p id="76b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">什么时候会有用？如果你有一个任务，那么在你的<strong class="ih hj"> DAGRun </strong>开始时，从上一次运行中取出<strong class="ih hj"> Xcom </strong>来获取你想要处理的数据的左边界。</p><p id="8d1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，任务实例方法<strong class="ih hj"> xcom_pull </strong>返回与请求匹配的最新值。但是有时候你想在一个值的时候得到更多，所以，你需要从<strong class="ih hj"> Xcom类中<strong class="ih hj"> get_many </strong>方法。是的。</strong>您可以直接使用Xcom类方法，只需提供必要的参数，例如:</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="a1b2" class="ju jv hi lm b fi lq lr l ls lt">from airflow.models import XCom</span><span id="1f27" class="ju jv hi lm b fi mi lr l ls lt">XCom.get_many(<br/>    execution_date=make_aware(datetime(2019, 12, 3, 0, 51, 00, 00)),<br/>    dag_ids=["write_to_xcom"], include_prior_dates=True)</span></pre><p id="3616" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在<strong class="ih hj"> Xcom </strong>类中找到同样的方法，那也许会对你有用。</p><h2 id="cc79" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">注意“关键”Xcom参数</h2><p id="1fca" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">注意Xcom pull方法的docstring中的这个描述。<strong class="ih hj">默认情况下，X </strong> com使用<strong class="ih hj"> key = 'return_value '，</strong>搜索记录，因此，如果您想要获得所有关键字的记录或只是删除关键字过滤器，您必须将其设置为<strong class="ih hj"> key=None </strong>！别忘了这件事。</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="9e9b" class="ju jv hi lm b fi lq lr l ls lt"><em class="mj">The default key is 'return_value', also<br/>available as a constant XCOM_RETURN_KEY. This key is automatically<br/>given to XComs returned by tasks (as opposed to being pushed<br/>manually). To remove the filter, pass key=None.</em></span></pre><p id="f217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">代码示例</strong></p><p id="f28a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我准备了一个使用dag的代码示例，你可以在这里得到它们(一次DAG写，二次读，示例如何使用xcom . get _ many):<a class="ae jd" href="https://github.com/xnuinside/airflow_examples/blob/master/xcom_diff_dag_and_multiply/xcom_dag.py" rel="noopener ugc nofollow" target="_blank">https://github . com/xnuinside/air flow _ examples/blob/master/xcom _ diff _ DAG _ and _ multiply/xcom _ DAG . py</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mk"><img src="../Images/fe03fa3002654ed85775b57a66e38b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aV4yGl7qSeoHFMkUPfewBA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在不同的Dag中读写xcom</figcaption></figure><p id="51ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果有帮助的话，点击“鼓掌”(这真的只是了解是否有用的一种方式，也许可以停下来写这样的文章)，如果你有什么要补充的，留下评论。</p></div></div>    
</body>
</html>