<html>
<head>
<title>MARKET BASKET ANALYSIS IN PYTHON</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PYTHON中的购物篮分析</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/market-basket-analysis-in-python-8c857d0d357d?source=collection_archive---------3-----------------------#2020-12-15">https://medium.com/analytics-vidhya/market-basket-analysis-in-python-8c857d0d357d?source=collection_archive---------3-----------------------#2020-12-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/f79ddd04e2113dc73263ae6ed2441674.png" data-original-src="https://miro.medium.com/v2/format:webp/1*L-EbLPPLV70xbj47RNbUcQ.png"/></div></figure><h1 id="8f8f" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">购物篮分析有什么用？</h1><ol class=""><li id="a606" class="jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">构建一个推荐引擎。</li><li id="3c9e" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">完善产品推荐。</li><li id="c660" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">交叉销售产品。</li><li id="8c92" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">改善库存管理。</li><li id="520d" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">追加销售产品。</li></ol><p id="0c6a" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">让我们理解如何使用本文中解释的用例。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="777e" class="lh in hi ld b fi li lj l lk ll">#Loading packages<br/>import numpy as np<br/>import pandas as pd<br/>from mlxtend.frequent_patterns import apriori<br/>from mlxtend.frequent_patterns import association_rules</span><span id="8f9e" class="lh in hi ld b fi lm lj l lk ll">#Reading Data <br/>retaildata = pd.read_excel('online_retail.xlsx')<br/>retaildata.head()</span></pre><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/fc94ed188fd7c1c885cf9fca24565bff.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wRoGGBVP00mXC0GWFwZu4A.png"/></div></figure><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="98da" class="lh in hi ld b fi li lj l lk ll">retaildata.shape</span><span id="6d40" class="lh in hi ld b fi lm lj l lk ll">(541909, 8)</span></pre><p id="b8ac" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">该数据记录了8个变量的541909个观察值。</p><p id="ddd7" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">然而，对于这种数据，在用于进一步分析之前，需要进行一些预处理。</p><h1 id="263d" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">预处理步骤</h1><p id="ab4f" class="pw-post-body-paragraph kh ki hi jm b jn jo kk kl jp jq kn ko jr ln kq kr jt lo kt ku jv lp kw kx jx hb bi translated">这包括:</p><ol class=""><li id="6efd" class="jk jl hi jm b jn kj jp km jr lq jt lr jv ls jx jy jz ka kb bi translated">删除多余的空格</li><li id="4415" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">删除重复项</li><li id="80cd" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">将发票号转换为字符串值</li><li id="c7e4" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">删除信用交易</li></ol><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="00dd" class="lh in hi ld b fi li lj l lk ll">#Cleaning the data<br/>retaildata['Description'] = retaildata['Description'].str.strip() <br/>retaildata.dropna(axis=0, subset=['InvoiceNo'], inplace=True) <br/>retaildata['InvoiceNo'] = retaildata['InvoiceNo'].astype('str')<br/>retaildata = retaildata[~retaildata['InvoiceNo'].str.contains('C')] <br/>retaildata.head()</span></pre><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/fc94ed188fd7c1c885cf9fca24565bff.png" data-original-src="https://miro.medium.com/v2/format:webp/1*wRoGGBVP00mXC0GWFwZu4A.png"/></div></figure><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="f62e" class="lh in hi ld b fi li lj l lk ll">retaildata.shape</span><span id="7906" class="lh in hi ld b fi lm lj l lk ll">(532621, 8)</span></pre><p id="5538" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">现在数据已经准备好用于8个变量的532621个观察值。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="905a" class="lh in hi ld b fi li lj l lk ll">retaildata['Country'].value_counts()</span><span id="3e95" class="lh in hi ld b fi lm lj l lk ll">United Kingdom          487622<br/>Germany                   9042<br/>France                    8408<br/>EIRE                      7894<br/>Spain                     2485<br/>Netherlands               2363<br/>Belgium                   2031<br/>Switzerland               1967<br/>Portugal                  1501<br/>Australia                 1185<br/>Norway                    1072<br/>Italy                      758<br/>Channel Islands            748<br/>Finland                    685<br/>Cyprus                     614<br/>Sweden                     451<br/>Unspecified                446<br/>Austria                    398<br/>Denmark                    380<br/>Poland                     330<br/>Japan                      321<br/>Israel                     295<br/>Hong Kong                  284<br/>Singapore                  222<br/>Iceland                    182<br/>USA                        179<br/>Canada                     151<br/>Greece                     145<br/>Malta                      112<br/>United Arab Emirates        68<br/>European Community          60<br/>RSA                         58<br/>Lebanon                     45<br/>Lithuania                   35<br/>Brazil                      32<br/>Czech Republic              25<br/>Bahrain                     18<br/>Saudi Arabia                 9<br/>Name: Country, dtype: int64</span></pre><p id="9c34" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">检查基于国家人口统计的值，可以看到英国在交易数量上居首位。</p><p id="ae3a" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">现在让我们对数据进行子集划分，仅包括1185笔澳大利亚交易，如下所示:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="6991" class="lh in hi ld b fi li lj l lk ll">#Separating transactions for Australia<br/>transaction_basket = (retaildata[retaildata['Country'] =="Australia"]<br/>          .groupby(['InvoiceNo', 'Description'])['Quantity']<br/>          .sum().unstack().reset_index().fillna(0)<br/>          .set_index('InvoiceNo'))</span></pre><p id="66d3" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">接下来，我们对这些值进行编码，1表示交易的存在，否则为0，然后继续进行购物篮分析。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="7a8e" class="lh in hi ld b fi li lj l lk ll">#Converting all positive values to 1 and everything else to 0<br/>def encode_units(x):<br/>    if x &lt;= 0:<br/>        return 0<br/>    if x &gt;= 1:<br/>        return 1<br/><br/>transaction_basket_sets = transaction_basket.applymap(encode_units)<br/><br/>#Removing "postage" as an item<br/>transaction_basket_sets.drop('POSTAGE', inplace=True, axis=1)</span><span id="8304" class="lh in hi ld b fi lm lj l lk ll">#Viewing the transaction basket<br/>transaction_basket.head()</span></pre><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/f41a237cd345f600fe8c36e0e5152308.png" data-original-src="https://miro.medium.com/v2/format:webp/1*9cDxSq2hPhjA1edScvaLyg.png"/></div></figure><h1 id="d64d" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">关键步骤</h1><p id="0838" class="pw-post-body-paragraph kh ki hi jm b jn jo kk kl jp jq kn ko jr ln kq kr jt lo kt ku jv lp kw kx jx hb bi translated">购物篮分析包括:</p><ol class=""><li id="b99c" class="jk jl hi jm b jn kj jp km jr lq jt lr jv ls jx jy jz ka kb bi translated">构建关联规则</li><li id="eb96" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">识别经常一起购买的物品</li></ol><p id="23b0" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">关联规则解释了以下关系:</p><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/d44d16566b41b6feac002f5c78f83aa4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*0hueZXEbahMMKVSCnbpdoA.png"/></div></figure><p id="ecc7" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">重要的关联规则如下:</p><p id="2c8e" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">支持</p><p id="80d0" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">它决定了产品的购买频率:</p><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/3d6be4c95a0427ac7fbca90fc924fc2a.png" data-original-src="https://miro.medium.com/v2/format:webp/1*eMq6GKsYV-x-Ck0snMpPGw.png"/></div></figure><p id="6d7d" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">信心</p><p id="723a" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">它测量Y中的项目在包含X的交易中出现的频率，如下所示:</p><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/d4aa3916abf3f1d34f73c69031d96e1d.png" data-original-src="https://miro.medium.com/v2/format:webp/1*66KyRXsqaTs7Htha64XBow.png"/></div></figure><p id="fb70" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">电梯</p><p id="1c17" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">它告诉我们商品Y与商品x一起购买的可能性有多大。Lift &gt; 1表示这些商品有可能一起购买，并强调关联规则更擅长预测结果，而不仅仅是假设。因此，提起&lt; 1 signifies a poor association rule.</p><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/ca50513680e60dde0eadeda9d979df8d.png" data-original-src="https://miro.medium.com/v2/format:webp/1*HwfZ7gTroizBUVXu1UHhww.png"/></div></figure><h1 id="6e51" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">Market Basket Analysis and making recommendations</h1><p id="d5b7" class="pw-post-body-paragraph kh ki hi jm b jn jo kk kl jp jq kn ko jr ln kq kr jt lo kt ku jv lp kw kx jx hb bi translated">In this section let us find out the most frequent items by setting a minimum support threshold of 0.7 and then generate rules using the lift metric as seen below:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="e51e" class="lh in hi ld b fi li lj l lk ll">#Generating frequent itemsets<br/>frequent_itemsets = apriori(transaction_basket_sets, min_support=0.07, use_colnames=True)</span><span id="2cd6" class="lh in hi ld b fi lm lj l lk ll">#Generating rules<br/>rules = association_rules(frequent_itemsets, metric="lift", min_threshold=1)</span><span id="fb8c" class="lh in hi ld b fi lm lj l lk ll">#viewing top 100 rules<br/>rules.head(10)</span></pre><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/0ce4a2d63c85610d5727baaca060f740.png" data-original-src="https://miro.medium.com/v2/format:webp/1*YgLxS_yTnWNjYoLs9iL4QA.png"/></div></figure><p id="74d4" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">Let us now consider the first rule where the antecedent is the ’36 PENCILS TUBE RED RETROSPOT’ and the consequent is the ‘RED RETROSPOT CAKE STAND’. To begin with this is a strong rule as it has a lift value &gt; 1。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="d20e" class="lh in hi ld b fi li lj l lk ll">transaction_basket_sets['36 PENCILS TUBE RED RETROSPOT'].sum()</span><span id="992c" class="lh in hi ld b fi lm lj l lk ll">4</span><span id="2f94" class="lh in hi ld b fi lm lj l lk ll">transaction_basket_sets['RED RETROSPOT CAKE STAND'].sum()</span><span id="c5cb" class="lh in hi ld b fi lm lj l lk ll">4</span></pre><p id="fd5d" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">在查看这种前因后果规则的交易篮时，可以说购买“36支铅笔管红色追溯点”的4个人也是购买“红色追溯点蛋糕架”的人。</p><p id="9a30" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">可以建议将这些物品放在一起，增加销售数量。</p><h1 id="316a" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">针对结果可视化一个先行lhs项目的结果</h1><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="110c" class="lh in hi ld b fi li lj l lk ll"># Viewing results for one antecedent lhs item against consequents <br/>import seaborn as sns<br/>import matplotlib.pyplot as plt<br/><br/># Replacing the sets with strings<br/>rules['antecedents_'] = rules['antecedents'].apply(lambda a: ','.join(list(a)))<br/>rules['consequents_'] = rules['consequents'].apply(lambda a: ','.join(list(a)))<br/><br/># Transforming the dataframe of rules into a matrix using the lift metric<br/>pivot = rules.pivot(index = 'antecedents_',columns = 'consequents_', values= 'lift')<br/><br/># Generating a heatmap<br/>sns.heatmap(pivot, annot = True)<br/>plt.yticks(rotation=0)<br/>plt.xticks(rotation=90)<br/>plt.show()</span></pre><figure class="ky kz la lb fd ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/69502f0ecc2590dc197db6504aad1017.png" data-original-src="https://miro.medium.com/v2/format:webp/1*17sf4Oxv_9oKL_FDN9fvQg.png"/></div></figure><p id="9ae5" class="pw-post-body-paragraph kh ki hi jm b jn kj kk kl jp km kn ko jr kp kq kr jt ks kt ku jv kv kw kx jx hb bi translated">注意:这种可视化可以为其他规则定制，这些规则的每个结果都有一个以上的前提。</p></div></div>    
</body>
</html>