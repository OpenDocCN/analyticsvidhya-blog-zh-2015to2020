<html>
<head>
<title>An Introduction to the TD Ameritrade API in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中的TD Ameritrade API简介</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/an-introduction-to-the-td-ameritrade-api-in-python-8c9d462e966c?source=collection_archive---------1-----------------------#2020-05-27">https://medium.com/analytics-vidhya/an-introduction-to-the-td-ameritrade-api-in-python-8c9d462e966c?source=collection_archive---------1-----------------------#2020-05-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c79497eab0fb32623ea1ca052c4c15ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*oEgHNJvsEdkYHuJvqBuEVg.png"/></div></figure><p id="f61f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用TD Ameritrade API，分析股票市场数据从未如此简单。只需一点设置和几行代码，用户就可以访问大量的股票和期权数据。</p><p id="e124" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">生成消费者密钥</strong></p><p id="151a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了使用TD Ameritrade API，我们需要一个消费者密钥。这可以通过访问TD的开发者<a class="ae jk" href="https://developer.tdameritrade.com/user/me/apps" rel="noopener ugc nofollow" target="_blank">网站</a>，创建一个账户，然后请求一个令牌来找到。授予API访问权限后，您将获得一个消费者密钥:</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jl"><img src="../Images/89dd99638f6703e1d2c85e2fe87aacbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQOdJS82QlZk6edMX8p5Qg.png"/></div></div></figure><p id="70f1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们已经完成了身份验证，我们可以继续编写Python代码了:</p><p id="da35" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">设置</strong></p><p id="1389" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，让我们导入我们需要的包。我使用<em class="ju">请求</em>进行API请求，使用JSON解析数据。</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="c594" class="ka kb hi jw b fi kc kd l ke kf">import requests<br/>import json</span></pre><p id="eded" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，我们需要将消费者密钥作为变量传递:</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kg"><img src="../Images/a8101e95d11229dff9a049832f157980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pdvRmImGj_Yu9gvH1i042A.png"/></div></div></figure><p id="5016" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们连接到API。我将用几个不同的端点来证明这一点:</p><ol class=""><li id="62c3" class="kh ki hi io b ip iq it iu ix kj jb kk jf kl jj km kn ko kp bi translated"><strong class="io hj">股票报价</strong></li></ol><p id="6772" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您希望获得股票报价，端点如下:</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="1fbf" class="ka kb hi jw b fi kc kd l ke kf">endpoint = '<a class="ae jk" href="https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/quotes?'" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/quotes?'</a></span></pre><p id="dc3f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要获取有关美国航空公司股票的信息，我们可以将“AAL”输入到{stock_ticker}占位符中。</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="b11d" class="ka kb hi jw b fi kc kd l ke kf">full_url = endpoint.format(stock_ticker='AAL')</span><span id="d98b" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=full_url,<br/>                    params={'apikey' : td_consumer_key})</span><span id="1b5b" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><p id="6671" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将返回关于美国航空公司的当前股票数据，包括当前价格、52周范围、波动性和交易量。</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kr"><img src="../Images/49ab9f66181a1f951ebead107e08f85f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GG52gXT5ndcmrizTNLxgNQ.png"/></div></div></figure><p id="fe16" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> 2。历史价格</strong></p><p id="e725" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还可以查看股票的历史股价。代码看起来非常类似于quotes端点，只是端点中的<em class="ju"> pricehistory </em>替换了<em class="ju"> quotes </em>:</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="3e68" class="ka kb hi jw b fi kc kd l ke kf">endpoint = '<a class="ae jk" href="https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/pricehistory'" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/pricehistory'</a></span><span id="879d" class="ka kb hi jw b fi kq kd l ke kf">full_url = endpoint.format(stock_ticker='AAL')</span><span id="7812" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=full_url,<br/>                    params={'apikey' : td_consumer_key})</span><span id="0d75" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><p id="9a75" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们返回一个长长的蜡烛列表，对应不同的时间戳:</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ks"><img src="../Images/471c9a2e935d0cee4de9e801b188b411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GyUnDuiELfzT2QI8j41I9g.png"/></div></div></figure><p id="327d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ju"> pricehistory </em>端点有很多<a class="ae jk" href="https://developer.tdameritrade.com/price-history/apis/get/marketdata/%7Bsymbol%7D/pricehistory" rel="noopener ugc nofollow" target="_blank">参数</a>，对应不同的周期和频率。</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kt"><img src="../Images/a5706ba85667bf0015d482f0e29ad777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eVE312djU14JyJ2nOA4CQ.png"/></div></div></figure><p id="ea83" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如，要检索过去一年AAL股票价格的<strong class="io hj">周</strong>历史数据，我们可以使用与上面相同的端点，但是添加了四个新参数:</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="6ef7" class="ka kb hi jw b fi kc kd l ke kf">endpoint = '<a class="ae jk" href="https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/pricehistory?periodType={periodType}&amp;period={period}&amp;frequencyType={frequencyType}&amp;frequency={frequency}'" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/pricehistory?periodType={periodType}&amp;period={period}&amp;frequencyType={frequencyType}&amp;frequency={frequency}'</a></span><span id="0721" class="ka kb hi jw b fi kq kd l ke kf">full_url = endpoint.format(stock_ticker='AAL',periodType='year',period=1,frequencyType='weekly',frequency=1)</span><span id="4fd1" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=full_url,<br/>                    params={'apikey' : td_consumer_key})</span><span id="e7d7" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><p id="629f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将给我们带来一年的蜡烛:</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ku"><img src="../Images/b07a89de6dc9964798c59c57eb7807c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e7uWkE8aNZMqFitx7a0h2Q.png"/></div></div></figure><p id="1d2f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> 3。基本面数据</strong></p><p id="b8ff" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还可以通过<em class="ju">仪器</em>端点收集基本面数据:</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="6a5b" class="ka kb hi jw b fi kc kd l ke kf">base_url = '<a class="ae jk" href="https://api.tdameritrade.com/v1/instruments?&amp;symbol={stock_ticker}&amp;projection={projection}'" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/instruments?&amp;symbol={stock_ticker}&amp;projection={projection}'</a></span><span id="7e57" class="ka kb hi jw b fi kq kd l ke kf">endpoint = base_url.format(stock_ticker = 'AAL',<br/>    projection = 'fundamental')</span><span id="4f1a" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=endpoint, <br/>            params={'apikey' : td_consumer_key})</span><span id="4dbd" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><p id="4ade" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们得到的是一大堆信息，从市盈率、负债率到客户满意度。</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kv"><img src="../Images/d9730119b63ba0025e1a2ec0f97c96b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dL5mj1nAZczxFziHO0m5Q.png"/></div></div></figure><p id="3d02" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该端点允许不同类型的“预测”，如下所述:</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kw"><img src="../Images/29e4b10bfc1294b1f13c75fb25d37df6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P7j0gDnpDho4PwTRKcJViA.png"/></div></div></figure><p id="195e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> 4。选项数据</strong></p><p id="978b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们还可以使用TD Ameritrade API收集选项数据:</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="e08b" class="ka kb hi jw b fi kc kd l ke kf">base_url = '<a class="ae jk" href="https://api.tdameritrade.com/v1/marketdata/chains?&amp;symbol={stock_ticker}'" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/marketdata/chains?&amp;symbol={stock_ticker}'</a></span><span id="a625" class="ka kb hi jw b fi kq kd l ke kf">endpoint = base_url.format(stock_ticker = 'AAL')</span><span id="fd47" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=endpoint, <br/>            params={'apikey' : td_consumer_key})</span><span id="c0c7" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kx"><img src="../Images/6410539245610b9e834d51fd5d672eb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UiBotBnRl59bhtwha_kGUg.png"/></div></div></figure><p id="528c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上面的API调用将返回一长串期权合约(本例中是740份！).对于这种要求，最好说得更具体一些。</p><p id="dd2c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们具体看看2020年11月20日<strong class="io hj">到期的<strong class="io hj">看跌</strong>期权:</strong></p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="b7ae" class="ka kb hi jw b fi kc kd l ke kf">base_url = '<a class="ae jk" href="https://api.tdameritrade.com/v1/marketdata/chains?&amp;symbol={stock_ticker}\" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/marketdata/chains?&amp;symbol={stock_ticker}</a>&amp;contractType={contractType}&amp;fromDate={date}&amp;toDate={date}'</span><span id="bed0" class="ka kb hi jw b fi kq kd l ke kf">endpoint = base_url.format(stock_ticker = 'AAL',<br/>    contractType = 'PUT',<br/>    date='2020-11-20')</span><span id="5f1a" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=endpoint, <br/>            params={'apikey' : td_consumer_key})</span><span id="81fe" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><p id="11a0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里，我们添加了几个参数:fromDate和toDate，它们都设置为“2020–11–20”，contractType设置为“PUT”。</p><p id="0b2e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们现在只得到22份期权合约:</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ky"><img src="../Images/b0d584fe935086c69370f0eed89665e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OL3F-TNyhWwRIiKzuD1swQ.png"/></div></div></figure><p id="4cce" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您想设置特定的执行价格，您可以通过{strike}参数来设置:</p><pre class="jm jn jo jp fd jv jw jx jy aw jz bi"><span id="dd14" class="ka kb hi jw b fi kc kd l ke kf">base_url = '<a class="ae jk" href="https://api.tdameritrade.com/v1/marketdata/chains?&amp;symbol={stock_ticker}\" rel="noopener ugc nofollow" target="_blank">https://api.tdameritrade.com/v1/marketdata/chains?&amp;symbol={stock_ticker}\</a><br/>&amp;contractType={contract_type}&amp;strike={strike}&amp;fromDate={date}&amp;toDate={date}'</span><span id="b68d" class="ka kb hi jw b fi kq kd l ke kf">endpoint = base_url.format(stock_ticker = 'AAL',<br/>    contract_type = 'PUT',<br/>    strike = 9,<br/>    date='2020-06-19')</span><span id="8fe3" class="ka kb hi jw b fi kq kd l ke kf">page = requests.get(url=endpoint, <br/>            params={'apikey' : td_consumer_key})</span><span id="a075" class="ka kb hi jw b fi kq kd l ke kf">content = json.loads(page.content)</span></pre><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kz"><img src="../Images/7fbd5a2ebb2bd6cfa4ea488c87d65a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmPBcCdT44zf9gen55KUiw.png"/></div></div></figure><p id="bdfd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi">— -</p><p id="2dbf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">还有其他有趣的API端点可用，如交易历史(如果您使用TD Ameritrade进行交易)和“movers”，它跟踪不同指数内的高/低表现股票(即今天DJI指数内前10名上涨股票)。更多信息可以在TD Ameritrade的<a class="ae jk" href="https://developer.tdameritrade.com/apis" rel="noopener ugc nofollow" target="_blank">文档</a>中找到。</p><p id="3a08" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi">— —</p><p id="ac71" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这篇博文后来被转载到我的博客<a class="ae jk" href="https://www.dataarchitecting.com/post/an-introduction-to-the-td-ameritrade-api-in-python" rel="noopener ugc nofollow" target="_blank">数据架构</a>上。</p></div></div>    
</body>
</html>