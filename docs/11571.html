<html>
<head>
<title>Custom Strava heatmap</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自定义 Strava 热图</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/custom-strava-heatmap-231267dcd084?source=collection_archive---------12-----------------------#2020-12-09">https://medium.com/analytics-vidhya/custom-strava-heatmap-231267dcd084?source=collection_archive---------12-----------------------#2020-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/8c8b80a093e8e7c851fad1e10f54c7e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*tOfCb7JJWzyve4Mght07Ig.png"/></div></figure><blockquote class="im"><p id="12c5" class="in io hi bd ip iq ir is it iu iv iw dx translated">我喜欢骑自行车。因为我住在世界上对自行车最友好的国家之一，所以我每周骑几次自行车。我也热爱数据。在过去的 3 年里，我用 Strava 监控我的自行车骑行，现在我有很多这样的工具了。我有很多很多对坐标，几乎是每次骑车的每一秒钟！那么当我把对骑行的热爱和数据结合起来会怎么样呢？当然是定制的 Strava 热图！</p></blockquote></div><div class="ab cl ix iy gp iz" role="separator"><span class="ja bw bk jb jc jd"/><span class="ja bw bk jb jc jd"/><span class="ja bw bk jb jc"/></div><div class="hb hc hd he hf"><p id="1086" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">让我们一步一步来。</p><p id="5752" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated"><a class="ae kb" href="https://www.strava.com/" rel="noopener ugc nofollow" target="_blank"> Strava </a>很乐意向我们提供我们的<a class="ae kb" href="https://support.strava.com/hc/en-us/articles/216918437-Exporting-your-Data-and-Bulk-Export" rel="noopener ugc nofollow" target="_blank">数据</a>:<a class="ae kb" href="https://support.strava.com/hc/en-us/articles/216918437-Exporting-your-Data-and-Bulk-Export" rel="noopener ugc nofollow" target="_blank">https://support . Strava . com/HC/en-us/articles/216918437-Exporting-your-Data-and-Bulk-Export</a>。下载完之后，我得到了一堆 gpx 文件，每个活动一个(骑自行车)。我想做的是使用 Python 将我所有的骑行合并在一个热图中，并查看我在过去 3 年中在 NL 的什么地方骑行了多少次。出于这个原因，我不得不使用<a class="ae kb" href="https://docs.python.org/3/library/xml.etree.elementtree.html" rel="noopener ugc nofollow" target="_blank"> ElementTree </a>和<a class="ae kb" href="https://docs.python.org/3/library/glob.html" rel="noopener ugc nofollow" target="_blank"> glob </a>包加载并解析所有的 gpx 文件，并将它们组合成一个<a class="ae kb" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> Pandas </a> dataframe。最后一步是使用<a class="ae kb" href="https://matplotlib.org/" rel="noopener ugc nofollow" target="_blank"> matplotlib </a>和<a class="ae kb" href="https://scitools.org.uk/cartopy/docs/latest/" rel="noopener ugc nofollow" target="_blank"> cartopy </a>绘制一个很酷的热图。</p><p id="18d2" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">一如既往，第一步是导入上述库:</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="4c2c" class="kl km hi kh b fi kn ko l kp kq">import xml.etree.ElementTree as ET<br/>import glob<br/>import numpy as np<br/>import pandas as pd<br/>import matplotlib.pyplot as plt<br/>import cartopy.crs as ccrs<br/>import cartopy.feature as cfeature</span></pre><p id="7855" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">然后，我想创建一个循环来打开并解析我下载的 Strava 数据文件夹中的每个 gpx 文件。最终，我想把我骑车的所有坐标存储在一个列表中。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="9444" class="kl km hi kh b fi kn ko l kp kq">coordlist = [] # Create an empty list<br/><br/>for file in glob.glob(".../export_30791752/activities/*.gpx"):<br/>    tree = ET.parse(file) # Parse each of the gpx files<br/>    root = tree.getroot() # Get the root of each file<br/>    coords = [coord.attrib for coord in root.iter('{<a class="ae kb" href="http://www.topografix.com/GPX/1/1}trkpt'" rel="noopener ugc nofollow" target="_blank">http://www.topografix.com/GPX/1/1}trkpt'</a>)] <br/># Get the pairs of coordinates (lat &amp; lon) from the elements of the gpx file that contain them. That means, several thousands of pairs per bike ride (gpx file).</span><span id="5d60" class="kl km hi kh b fi kr ko l kp kq">    coordlist.extend(coords) <br/># Add the coordinates from each gpx file to the list that I created above. I use extend because I don't care about separating the coordinates from different rides. I want to have them all in one big list.</span></pre><p id="d24b" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated"><strong class="jg hj">始终</strong>检查您在上一步中创建的内容！</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="ccc0" class="kl km hi kh b fi kn ko l kp kq">coordlist[:10]</span></pre><p id="9a9c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">让我们把这个列表变成一个漂亮、整洁的数据框架(我爱他们！):</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="203d" class="kl km hi kh b fi kn ko l kp kq">df = pd.DataFrame(coordlist)</span></pre><p id="5a08" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">正如我之前所说:<strong class="jg hj">总是</strong>检查你在前一步创造了什么！</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="ba67" class="kl km hi kh b fi kn ko l kp kq">df.head() # Look at the first few rows of the dataframe</span><span id="6eef" class="kl km hi kh b fi kr ko l kp kq">df.shape # Check out the shape (rows, columns) of the dataframe</span></pre><p id="747b" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">现在到了棘手的部分。我想绘制一张热图…</p><div class="kc kd ke kf fd ab cb"><figure class="ks ij kt ku kv kw kx paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><img src="../Images/03b269fa7a39fa4652358f9a58971579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*xkDVvhezAe8i1XgPcRO04w.jpeg"/></div></figure><figure class="ks ij lc ku kv kw kx paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><img src="../Images/fa2c2de00bb727b4b036dc00ee3e9914.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*ZYLBdDGCvdASDBU7QWBMIw.jpeg"/></div></figure></div><p id="7aa9" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">…但是热图需要 3 个变量，足球场的宽度、长度和在每个位置花费的时间，或者<a class="ae kb" href="https://commons.wikimedia.org/wiki/File:Annual_Average_Temperature_Map.jpg" rel="noopener ugc nofollow" target="_blank">经度、纬度和温度</a>。</p><p id="637c" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">我的数据框架只有两列:经度和纬度。因此，这意味着我还需要第三个变量，以便给我的热图添加颜色，嗯…我该如何解决这个问题呢？</p><p id="245d" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated"><a class="ae kb" href="https://numpy.org/doc/stable/index.html" rel="noopener ugc nofollow" target="_blank"> Numpy </a>有个神奇的东西叫<a class="ae kb" href="https://numpy.org/doc/stable/reference/generated/numpy.histogram2d.html" rel="noopener ugc nofollow" target="_blank"> histogram2d </a>。它允许我将我的数据分成 10，000 个正方形的箱(你可以选择想要多少个箱)，并计算每个箱包含多少个经度对。基本上，它将网络分成 10，000 个方块(一个有 100 行[lat] &amp; 100 列[lon]的表格)，并计算我在每个方块中的次数！</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="a3fe" class="kl km hi kh b fi kn ko l kp kq">Z, xedges, yedges = np.histogram2d(np.array(df.lon, dtype=float), <br/>                                   np.array(df.lat, dtype=float), bins = 100)</span><span id="1d0b" class="kl km hi kh b fi kr ko l kp kq"># Z is the number of coordinate pairs each of the 10000 bins contains. You can imagine it as a 100 x 100 table, and in each cell there is a number telling how many times I've been in this cell during my bike rides.</span></pre><p id="4fda" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">正如我之前已经说过两次的:<strong class="jg hj">总是</strong>检查你在前一步中创建了什么！</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="5f7a" class="kl km hi kh b fi kn ko l kp kq">Z.min(), Z.max(), Z.mean(), np.median(Z) <br/># have a look at basic statistics of the Z thing (it's a numpy ndarray, or multidimensional array) you created, just to get a feeling of the values it contains.</span></pre><p id="5ca2" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">然后我用几个荷兰城市的名字和坐标做了一个<a class="ae kb" href="https://www.w3schools.com/python/python_dictionaries.asp" rel="noopener ugc nofollow" target="_blank">字典</a>，然后<a class="ae kb" href="https://www.geeksforgeeks.org/how-to-create-dataframe-from-dictionary-in-python-pandas/" rel="noopener ugc nofollow" target="_blank">把它变成了一个漂亮整洁的数据框架</a>。我说过我有多喜欢整洁的数据框吗？</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="fab1" class="kl km hi kh b fi kn ko l kp kq">cities = pd.DataFrame({'City': ['Utrecht', 'Amsterdam', 'Rotterdam', 'The Hague', 'Arnhem', 'Hilversum', 'Amersfoort', 'Almere',  'Lelystad', 'Apeldoorn', 'Den Burg', 'Harlingen', 'Zwolle', 'Gorinchem'], <br/>                       'Lon': [5.1214, 4.9041, 4.4777, 4.3007, 5.8987, 5.1669, 5.3878, 5.2647, 5.4714, 5.9699, 4.7997, 5.4252, 6.0830, 4.9758], <br/>                       'Lat': [52.0907, 52.3676, 51.9244, 52.0705, 51.9851, 52.2292, 52.1561, 52.3508, 52.5185, 52.2112, 53.0546, 53.1746, 52.5168, 51.8372]})</span></pre><p id="a94b" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">正如我之前已经说过三次的:<strong class="jg hj">总是</strong>检查你在前一步中创建了什么！</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="ec50" class="kl km hi kh b fi kn ko l kp kq">cities # or print(cities), but I am too lazy to write it...</span></pre><p id="4896" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">现在，是热图的时间了！首先，我准备了图形的尺寸。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="3d4f" class="kl km hi kh b fi kn ko l kp kq">fig = plt.figure(figsize=(12, 12)) # I created a new figure and set up its size</span><span id="eb16" class="kl km hi kh b fi kr ko l kp kq">ax = fig.add_subplot(1, 1, 1, projection=ccrs.PlateCarree()) # I used the PlateCarree projection from cartopy<br/>ax.set_extent([3.5, 6.2, 51.2, 53.5]) # I set the extent of the plot, using min and max coordinates</span></pre><p id="6aee" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">然后，我添加了所有我想要的特征:海岸线、湖泊和河流(虚线)。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="92b2" class="kl km hi kh b fi kn ko l kp kq">ax.coastlines(resolution='10m', color='black', linewidth=1)</span><span id="5676" class="kl km hi kh b fi kr ko l kp kq">lakes_50m = cfeature.NaturalEarthFeature('physical', 'lakes', '10m', edgecolor='black', facecolor='None')<br/>ax.add_feature(lakes_50m)</span><span id="c213" class="kl km hi kh b fi kr ko l kp kq">rivers_50m = cfeature.NaturalEarthFeature('physical',  'rivers_lake_centerlines', '10m')<br/>ax.add_feature(rivers_50m, facecolor='None', edgecolor='black', linestyle = 'dotted')</span></pre><p id="4e56" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">我添加了热图(我使用了<a class="ae kb" href="https://matplotlib.org/3.3.3/api/_as_gen/matplotlib.pyplot.pcolormesh.html" rel="noopener ugc nofollow" target="_blank"> pcolormesh </a>)作为地图上的图层。我使用了“cividis”色图，因为这是我最喜欢的颜色之一，但也可以随意尝试<a class="ae kb" href="https://matplotlib.org/3.1.1/gallery/color/colormap_reference.html" rel="noopener ugc nofollow" target="_blank">色图</a>。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="47b7" class="kl km hi kh b fi kn ko l kp kq">ax.pcolormesh(xedges, yedges, Z.T, vmin = 0, vmax = 5000, cmap = 'cividis') <br/># I set the maximum at 5000, after some experimentation. Higher values make all the areas, except Utrecht, very dim. Lower values make almost all the areas bright.</span></pre><p id="bee6" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">最后一步是在热图上绘制城市作为额外的图层。我使用了先前创建的“城市”数据框架中的坐标和名称。在这里，一个好的老式散点图将完成这项工作。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="e1fb" class="kl km hi kh b fi kn ko l kp kq">plt.scatter(cities.Lon, cities.Lat, marker = 'o', color = 'red', s = 50)</span><span id="10de" class="kl km hi kh b fi kr ko l kp kq">for i in range(cities.shape[0]):<br/>    plt.text(cities.Lon[i] + 0.02, cities.Lat[i], cities.City[i], color = 'red')<br/># The loop takes the name of each city and plots it next to its red dot, using its lon and lat values. </span><span id="2a7f" class="kl km hi kh b fi kr ko l kp kq">plt.show()</span></pre><p id="2a07" class="pw-post-body-paragraph je jf hi jg b jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka iw hb bi translated">Tadaaaaaa！</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div class="er es if"><img src="../Images/8c8b80a093e8e7c851fad1e10f54c7e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*tOfCb7JJWzyve4Mght07Ig.png"/></div></figure></div><div class="ab cl ix iy gp iz" role="separator"><span class="ja bw bk jb jc jd"/><span class="ja bw bk jb jc jd"/><span class="ja bw bk jb jc"/></div><div class="hb hc hd he hf"><blockquote class="im"><p id="5ed1" class="in io hi bd ip iq ld le lf lg lh iw dx translated">我希望你喜欢我的例子，并希望你感到鼓舞，走出去，使自己疯狂的数据项目，享受乐趣，并可能节省一些钱；) .</p></blockquote></div></div>    
</body>
</html>