<html>
<head>
<title>1, 2, 3: Docker, Heroku, MongoDB Atlas, Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">1，2，3: Docker，Heroku，MongoDB Atlas，Python</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/1-2-3-docker-heroku-mongodb-atlas-python-952958423bea?source=collection_archive---------9-----------------------#2020-12-22">https://medium.com/analytics-vidhya/1-2-3-docker-heroku-mongodb-atlas-python-952958423bea?source=collection_archive---------9-----------------------#2020-12-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="05e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated">这是一个讲解如何使用 MongoDB Atlas 在 Heroku 上对接和部署 Python 应用程序的演练。</p><blockquote class="jm"><p id="5f42" class="jn jo hi bd jp jq jr js jt ju jv jc dx translated">为什么是 1–2–3？关注简单的本质方面，清晰的代码样本和相关参考。</p></blockquote><figure class="jx jy jz ka kb kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es jw"><img src="../Images/ba22ede9509e18c90aee85612d709741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*foT3BHbi9d_c8eNxP2E4Iw.jpeg"/></div></div></figure></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="b2c1" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">应用程序</h1><p id="cefe" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">这一切都从源代码开始。当然，让我们在<a class="ae lt" href="https://flask.palletsprojects.com/en/1.1.x/" rel="noopener ugc nofollow" target="_blank"> Flask </a>框架上创建一个 Python 应用程序。</p><p id="8e46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该应用程序提供了几个 REST 端点和一个 DAO 层来访问数据库。</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="3771" class="md kr hi lz b fi me mf l mg mh"># app.py <br/>from flask import Flask, request, Response<br/>import logging<br/>import requests, import os<br/><br/>try:<br/>    app = Flask(__name__)<br/><br/>    logging.basicConfig(level=logging.DEBUG)<br/>    logging.getLogger(<strong class="lz hj">'werkzeug'</strong>).setLevel(logging.ERROR)<br/>except Exception as e:<br/>    logging.exception(<strong class="lz hj">"Error at startup"</strong>)<br/><br/><br/>@app.route(<strong class="lz hj">'/ping'</strong>)<br/>def ping():<br/>    <em class="mi">"""<br/>    Ping the endpoint<br/>    :return:<br/>    """<br/></em>    return <strong class="lz hj">"ping Ok"<br/><br/><br/></strong>def get_port():<br/>    <em class="mi">"""<br/>    Retrieves port for env variable<br/>    :return:<br/>    """<br/>    </em>return int(os.environ.get(<strong class="lz hj">"PORT"</strong>, 5000))<br/><br/><br/>if __name__ == <strong class="lz hj">'__main__'</strong>:<br/>    app.run(debug=True, port=get_port(), host=<strong class="lz hj">'0.0.0.0'</strong>)</span></pre><p id="df72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证您可以在您最喜欢的 IDE (PyCharm 是我的)中或从命令行(`<em class="mi"> python app.py` </em>)运行该应用程序，它应该响应<a class="ae lt" href="http://localhost:5000/ping" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/ping</a></p><h1 id="a5a8" class="kq kr hi bd ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj mn ll lm ln bi translated">MongoDB 地图集</h1><p id="dc38" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">注册 MongoDB Atlas(如果您还没有帐户)并设置您的免费 MongoDB。按照 Atlas 一步一步的向导，这是非常简单的。</p><figure class="lu lv lw lx fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es mo"><img src="../Images/b2ac001c6ed2adbf16d3296feb6ee01b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ielULk_-cy_pJ8NG61uI8A.jpeg"/></div></div></figure><p id="1850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，你需要:</p><ul class=""><li id="3d62" class="mp mq hi ih b ii ij im in iq mr iu ms iy mt jc mu mv mw mx bi translated">创建一个集群</li><li id="351f" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated">创建数据库用户</li><li id="d628" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated">允许传入连接(编辑防火墙规则)</li><li id="fc19" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated">连接</li></ul><p id="a25b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个常见的错误是忘记允许您的 IP 地址(上面的步骤 3):输入您当前的 IP 地址，或者如果您的存储库没有存储关键数据，则允许所有的 IP 地址(例如对于本教程)。</p><figure class="lu lv lw lx fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es nd"><img src="../Images/8da05b648cd6aca5c52f4a4a3b5dcfc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qVy_PUQXLd2RPmm2OQ37A.jpeg"/></div></div></figure><p id="827c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后也是最有趣的一步是从 Python 应用程序连接到 MongoDB Atlas</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="6ec5" class="md kr hi lz b fi me mf l mg mh">#db_client.py</span><span id="4e42" class="md kr hi lz b fi ne mf l mg mh">from pymongo import MongoClient</span><span id="4d9b" class="md kr hi lz b fi ne mf l mg mh">connect_string = 'mongodb+srv://{db_username}:{db_password}@devcluster.s4lc7.mongodb.net/{db_name}?retryWrites=true&amp;w=majority'</span><span id="5b62" class="md kr hi lz b fi ne mf l mg mh">client = MongoClient(connect_string)<br/>db = client.get_default_database()<br/><br/># get user by name<br/>def get_user_by_name(name):<br/>    return db.user.find_one({<strong class="lz hj">"name"</strong>: name})<br/><br/># add new user<br/>def add_user(name):<br/><br/>    ret = get_user_by_name(name)<br/><br/>    if ret is None:<br/>        new_user = {<strong class="lz hj">"name"</strong>: name}<br/>        x = db.user.insert_one(new_user)<br/>        ret = x.inserted_id<br/><br/>    return ret</span></pre><p id="541a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mi"> `connect_string` </em>在源代码中是硬编码的(不要忘记用实际的 MongoDB 用户名、密码和 DB 名称替换占位符)，这样做是为了简化示例。您应该真正避免这种情况，而是将连接字符串(和任何其他配置)定义为环境变量。</p><h1 id="7edf" class="kq kr hi bd ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj mn ll lm ln bi translated">赫罗库码头工人</h1><p id="95ac" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">我们现在有了一个可以工作的应用程序(你也可以添加一些单元测试)，是时候部署了。</p><p id="9f73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Heroku Docker Registry 是部署您的应用程序的一个很好的解决方案，原因如下:</p><ul class=""><li id="e620" class="mp mq hi ih b ii ij im in iq mr iu ms iy mt jc mu mv mw mx bi translated">您构建了一个可以在其他 Docker 运行时上部署的通用映像</li><li id="ab4f" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated">与从 git 存储库部署不同，Docker 映像不受大小限制(最大 500MB)</li></ul><h2 id="b4b5" class="md kr hi bd ks nf ng nh kw ni nj nk la iq nl nm le iu nn no li iy np nq lm nr bi translated">先决条件</h2><p id="0b59" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">首先创建一个新的 Heroku 应用程序(使用 Heroku CLI 或 web 界面),选择一个好名字☺️</p><p id="8055" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其次(也是非常重要的),登录 Heroku 和 Heroku Docker 注册表</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="bfd1" class="md kr hi lz b fi me mf l mg mh">heroku login<br/>heroku container:login</span></pre><h2 id="6032" class="md kr hi bd ks nf ng nh kw ni nj nk la iq nl nm le iu nn no li iy np nq lm nr bi translated">Dockerfile 文件</h2><p id="0be1" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">这是我们示例的 docker 文件，从<code class="du ns nt nu lz b">python-slim</code>基本图像开始。</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="2603" class="md kr hi lz b fi me mf l mg mh">FROM python:3.9-slim<br/><br/>COPY app/ /app<br/><br/>EXPOSE 5000<br/><br/>WORKDIR /app<br/>RUN pip install -r requirements.txt<br/><br/>ENTRYPOINT ["python"]<br/>CMD ["app.py"]</span></pre><h2 id="c52d" class="md kr hi bd ks nf ng nh kw ni nj nk la iq nl nm le iu nn no li iy np nq lm nr bi translated">构建、推送、发布</h2><p id="4d8c" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">摇滚的时间到了:让我们将应用程序 Dockerize 并将其推送到 Heroku。注意图像标签(registry.heroku.com)和流程类型(web)。</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="769f" class="md kr hi lz b fi me mf l mg mh"># build the image<br/>docker build -t myapp .<br/># tag<br/>docker tag myapp registry.heroku.com/myapp/web<br/># push<br/>docker push registry.heroku.com/myapp/web<br/># release (when deployment starts)<br/>heroku container:release web -a myapp</span></pre><p id="4b20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查日志，看看它是否真的发生了</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="e6d8" class="md kr hi lz b fi me mf l mg mh">heroku logs -a myapp</span></pre><p id="28c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">调用 https://myapp.herokuapp.com/ping<code class="du ns nt nu lz b">/ping </code>端点<a class="ae lt" href="https://dockerherokumongotutorial.herokuapp.com/ping" rel="noopener ugc nofollow" target="_blank">的</a></p><h1 id="cad9" class="kq kr hi bd ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj mn ll lm ln bi translated"><strong class="ak"> TADAAAA！！！</strong>😀</h1><h1 id="c012" class="kq kr hi bd ks kt mj kv kw kx mk kz la lb ml ld le lf mm lh li lj mn ll lm ln bi translated">配置变量</h1><p id="a517" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">最后一步是删除硬编码的数据库连接字符串(调皮的开发者！)并使用环境变量。</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="9212" class="md kr hi lz b fi me mf l mg mh"># read env variable<br/>def get_mongo_connect_string():<br/>    return os.environ.get(<strong class="lz hj">"MONGO_CONNECT_STRING"</strong>, <strong class="lz hj">""</strong>)</span></pre><p id="ab3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的本地开发环境中，创建一个通常被 gitignored 的<code class="du ns nt nu lz b">.env</code>文件并使用 Python <a class="ae lt" href="https://pypi.org/project/python-dotenv/" rel="noopener ugc nofollow" target="_blank">是一个好主意。dotenv </a>包来加载这些值。</p><p id="f1a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 Heroku 上，您希望将环境变量定义为<a class="ae lt" href="https://devcenter.heroku.com/articles/config-vars" rel="noopener ugc nofollow" target="_blank"> Config Vars </a>:在部署时，Heroku 会将变量(连接字符串、令牌、秘密)注入为您的应用程序提供的 Dyno 中。</p><figure class="lu lv lw lx fd kc er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es nv"><img src="../Images/e72422be78a64c9959832b5f01f27b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qvrYvThw35uhabCIAmmZw.jpeg"/></div></div></figure></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><h1 id="ed64" class="kq kr hi bd ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln bi translated">结论</h1><p id="3d0b" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">我希望这对开始使用 Docker 和 Heroku 的开发人员有所帮助:重点主要是提供清晰的代码和配置示例，因为这是最好的学习方法。</p><p id="804c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">欢迎反馈！打<a class="ae lt" href="https://twitter.com/beppecatanese" rel="noopener ugc nofollow" target="_blank"> @beppecatanese </a>找我</p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><p id="8dd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong></p><p id="276c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae lt" href="https://github.com/gcatanese/1-2-3-Heroku-Docker-Python-MongoDB" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上查看演练源代码</p><p id="5a44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">devcenter.heroku.com<a class="ae lt" href="https://devcenter.heroku.com/articles/container-registry-and-runtime" rel="noopener ugc nofollow" target="_blank">码头集装箱登记文件</a></p><p id="f382" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae lt" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" rel="noopener ugc nofollow" target="_blank">docker.com</a>创建 docker 文件的最佳实践</p></div></div>    
</body>
</html>