# 为什么 Apache Kafka 要用 Avro 数据格式？

> 原文：<https://medium.com/analytics-vidhya/why-use-avro-data-format-with-apache-kafka-85ff15044ca5?source=collection_archive---------33----------------------->

![](img/0e792ad2674b8b4f826aa648e5f6c2bc.png)

*图片来源:* [*马库斯·斯皮斯克*](https://unsplash.com/@markusspiske)

Avro 是一种开源的二进制序列化格式。但是为什么要和卡夫卡一起用呢？为什么不发送 JSON 或 XML 消息？它给了我们什么好处？这就是我们今天要探索的。

# 序列化

理解主题中的记录只是字节数组是很重要的。Kafka broker 不关心我们发送的数据类型。为了使这些字节数组在我们的应用程序中有用，生产者和消费者必须知道如何解释它们。我们发送的是 CSV 数据还是 JSON 或 XML？生产者和消费者使用序列化(反序列化)将数据转换为字节数组，然后再转换回来。然而，这仅仅是开始。

# (计划或理论的)纲要

每当我们使用数据作为集成机制时，数据的模式就变得非常重要，因为它成为生产者和消费者之间的契约。生产者和消费者背后的团队需要在以下方面达成一致:

*   记录中有哪些字段
*   哪些字段是可选的，哪些是必填的
*   这应该在哪里以及如何记录
*   消费者应该为记录中缺少的字段使用哪些默认值
*   应该如何处理对模式的更改

# 数据格式

现在，您可以通过 JSON 模式使用 JSON，或者通过 XSD 模式使用 XML 来描述消息格式。但是这样做有一个缺点:由于 JSON 和 XML 的性质，这些格式的消息通常使用更多的空间来传递相同的信息。

# 那么有没有更好的办法呢？

是的。你可以用阿帕奇 Avro。Avro 是在 Apache 框架下开发的一种数据序列化格式，建议由 Apache Kafka 的创建者自己用于 Kafka 消息。为什么？

通过以 Avro 格式序列化数据，您可以获得以下好处:

*   Avro 依赖于一个模式。这意味着每个字段都被适当地描述和记录
*   Avro 数据格式是一种紧凑的二进制格式，因此它在线路和磁盘上都占用较少的空间
*   它支持多种编程语言
*   在 Avro 中，每个消息都包含用于序列化它的模式。这意味着当您读取消息时，您总是知道如何反序列化它们，即使模式已经改变

然而，有一件事使 Avro 不适合在 Kafka 中使用，至少不是开箱即用的，因为…

**每个 Avro 消息包含用于序列化消息的模式**

请想一想:如果您计划每天向 Kafka 发送数百万条消息，那么一遍又一遍地发送相同的模式信息是对带宽和存储空间的极大浪费。

所以，克服这一点的方法是…

# 将模式与消息分开

这就是模式注册中心发挥作用的地方。Schema Registry 是由 Apache Kafka 背后的公司 Confluent 开发的，它提供了一个 RESTful 接口来存储和接收 Avro 模式。

生产者不是在 Kafka 记录中发送模式，而是先检查模式是否已经存在于模式注册中心。如果没有，它将在那里写入模式(下面的步骤 1)。然后，生产者将获得模式的 id(步骤 2)，并将该 id 发送到记录中(步骤 3)，这样可以节省大量空间。消费者将读取消息(步骤 4)，然后使用记录中的模式 id 联系模式注册中心，以获取完整的模式(步骤 5)并在本地缓存它。

![](img/a1b3c49c1adfd8cf5b61c18143e704df.png)

好的，看起来不错。但是这并不是 Schema Registry 发挥作用的唯一地方。让我们看看当你想…

# 发展模式

想象一下，在发布 producer 应用程序两年后，您决定更改消息的格式，在您看来，这样做不会破坏兼容性，因此不会影响消费者。现在你有两个选择:

*   你可以做一个好人，找到所有的消费者，检查建议的改变是否会影响他们，如果会，请他们改变
*   或者你可以做出改变，等着拿着火把、铲子和耙子的暴徒来找你

假设你选择了避免把你的照片放在每个火车站的下面并有金钱奖励的选项，那么第一个选项的可能结果是什么？

那些在公司环境中工作过的人知道答案:大量的计划、预算、谈判，有时甚至因为有更紧迫的问题而推迟。让 10 个或 100 个消费者来执行升级，然后才能继续对生产者进行更改，这肯定会导致庇护。

Apache Avro 和 Schema Registry 再次伸出援手。Schema Registry 允许我们在修改模式时执行验证模式兼容性的规则。如果新消息破坏了模式兼容性，生产者将拒绝编写该消息。

通过这种方式，您的用户可以避免有人突然将字段的数据类型从 long 更改为 string，或者删除强制字段。

同时，它为您提供了关于允许对模式进行哪些更改的清晰指导。因此，不再需要花费数周或数月的时间来协调更改，只是为了删除邮件中的可选字段。

# 你想更多地了解卡夫卡吗？

我创建了一个卡夫卡迷你课程，你可以完全免费获得。[在编码港](https://codingharbour.com/)报名。

【https://codingharbour.com】最初发表于[](https://codingharbour.com/apache-kafka/why-use-avro-data-format-with-apache-kafka/)**。**