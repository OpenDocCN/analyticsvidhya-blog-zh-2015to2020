<html>
<head>
<title>Apache Airflow: A Real-life Use Case</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇气流:一个真实的用例</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/apache-airflow-a-real-life-use-case-faf3b2439e86?source=collection_archive---------1-----------------------#2019-08-30">https://medium.com/analytics-vidhya/apache-airflow-a-real-life-use-case-faf3b2439e86?source=collection_archive---------1-----------------------#2019-08-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="5d9d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在这篇文章中，我将指导你如何为一个实际的用例编写一个气流调度器。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/d74a3309b86895cbb57e40efb295c46e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r72v-91g4NRyZZd0SZqaMA.jpeg"/></div></div></figure></div><div class="ab cl jj jk gp jl" role="separator"><span class="jm bw bk jn jo jp"/><span class="jm bw bk jn jo jp"/><span class="jm bw bk jn jo"/></div><div class="hb hc hd he hf"><h1 id="993d" class="jq jr hi bd js jt ju jv jw jx jy jz ka io kb ip kc ir kd is ke iu kf iv kg kh bi translated"><strong class="ak">概述</strong></h1><p id="1d26" class="pw-post-body-paragraph ki kj hi kk b kl km ij kn ko kp im kq kr ks kt ku kv kw kx ky kz la lb lc ld hb bi le translated"><span class="l lf lg lh bm li lj lk ll lm di">一个</span> irflow是一个简单的工具，让我们以编程方式安排和监控我们的工作流程。当处理复杂的管道时，其中许多部分相互依赖，使用Airflow可以帮助我们用Python和WebUI编写一个清晰的调度程序，以可视化管道，监控进度并在需要时解决问题。</p><h1 id="abe6" class="jq jr hi bd js jt ln jv jw jx lo jz ka io lp ip kc ir lq is ke iu lr iv kg kh bi translated">现实生活中的例子</h1><p id="1894" class="pw-post-body-paragraph ki kj hi kk b kl km ij kn ko kp im kq kr ks kt ku kv kw kx ky kz la lb lc ld hb bi translated">理解气流力量的最好方法是编写一个简单的管道调度程序。Airflow的一个常见用例是定期检查当前文件目录，并基于这些目录运行bash作业。在这篇文章中，我将编写一个气流调度程序，它检查HDFS目录并根据现有的HDFS文件运行简单的bash作业。高层管道如下图所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ls"><img src="../Images/38e9503040e2a041664522d974be1bb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*zPaDyybq3GhGBtMu67hUFg.png"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">管道概述</figcaption></figure><p id="b98a" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">如您所见，首先我们将尝试检查今天的<strong class="kk hj">目录1 </strong>和<strong class="kk hj">目录2 </strong>，如果其中一个不存在(由于一些失败的作业、损坏的数据……)，我们将获得昨天的目录。对于<strong class="kk hj">作业2 </strong>和<strong class="kk hj">作业3 </strong>，我们也有一个规则，它们依赖于<strong class="kk hj">作业1 </strong>。因此，如果<strong class="kk hj">作业1 </strong>失败，预期的结果是<strong class="kk hj">作业2 </strong>和<strong class="kk hj">作业3 </strong>也会失败。这是一种常见的管道模式，使用气流时很容易做到。</p><h1 id="edc6" class="jq jr hi bd js jt ln jv jw jx lo jz ka io lp ip kc ir lq is ke iu lr iv kg kh bi translated">安装</h1><p id="502a" class="pw-post-body-paragraph ki kj hi kk b kl km ij kn ko kp im kq kr ks kt ku kv kw kx ky kz la lb lc ld hb bi translated">有很多关于气流安装和故障排除的好资料。在这里，我只是简单地告诉你如何在你的本地机器上设置气流。</p><p id="295e" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">使用<strong class="kk hj"> pip </strong>安装气流:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="9bb5" class="mh jr hi md b fi mi mj l mk ml">pip install apache-airflow</span></pre><p id="8269" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">初始化气流数据库:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="4cee" class="mh jr hi md b fi mi mj l mk ml">airflow initdb</span></pre><p id="b73b" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">启动web服务器:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="8569" class="mh jr hi md b fi mi mj l mk ml">airflow webserver -p 8080</span></pre><p id="8003" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">运行调度程序:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="fd23" class="mh jr hi md b fi mi mj l mk ml">airflow scheduler</span></pre><p id="d933" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">如果全部运行成功，您可以通过:<a class="ae mm" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>查看Airflow UI</p><h1 id="3802" class="jq jr hi bd js jt ln jv jw jx lo jz ka io lp ip kc ir lq is ke iu lr iv kg kh bi translated">好了，写吧！</h1><p id="a601" class="pw-post-body-paragraph ki kj hi kk b kl km ij kn ko kp im kq kr ks kt ku kv kw kx ky kz la lb lc ld hb bi translated">首先，我们需要定义一组管道将使用的默认参数。因为我们的管道需要检查目录1和目录2，所以我们也需要指定这些变量。幸运的是，</p><blockquote class="mn mo mp"><p id="2686" class="ki kj mq kk b kl lx ij kn ko ly im kq mr lz kt ku ms ma kx ky mt mb lb lc ld hb bi translated">Airflow利用了<a class="ae mm" href="http://jinja.pocoo.org/docs/dev/" rel="noopener ugc nofollow" target="_blank"> Jinja模板</a>的能力，并为管道作者提供了一组内置参数和宏。Airflow还为管道作者提供了钩子来定义他们自己的参数、宏和模板。</p></blockquote><p id="5f88" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">我们是这样定义的:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mu mv l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">定义默认参数</figcaption></figure><p id="0da7" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">以下是每个参数的简要描述:</p><ul class=""><li id="daa2" class="mw mx hi kk b kl lx ko ly kr my kv mz kz na ld nb nc nd ne bi translated"><strong class="kk hj">所有者:</strong>管道的所有者，这将显示在webUI上。</li><li id="f647" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj"> depends_on_past: </strong>该管道是否依赖于过去的管道实例。因此，如果您过去的管道失败了，当前的管道将不会被触发。</li><li id="de3e" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj">开始日期:</strong>您管道的开始日期。</li><li id="3fad" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj">邮件:</strong>要通知的邮件。</li><li id="c5ea" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj"> email_on_failure: </strong>指定当您的管道出现故障时将被通知的电子邮件。</li><li id="6cdb" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj"> email_on_retry: </strong>重试时是否通知邮件。</li><li id="027b" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj">重试次数:</strong>重试次数。</li><li id="18dd" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj"> catchup_by_default: </strong>如果您的开始日期是过去的日期，是否运行所有以前调度的管道。</li><li id="484a" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj"> params: </strong>该管道的自定义参数，将由<a class="ae mm" href="https://jinja.palletsprojects.com/en/master/" rel="noopener ugc nofollow" target="_blank"> Jinja模板</a><strong class="kk hj">{ { params . my _ param } }</strong>访问。</li></ul><p id="20d8" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">对于<strong class="kk hj"> build_params </strong>函数，该函数只是从<strong class="kk hj"> yml </strong>文件中加载用户自定义变量。从yml文件加载变量是一个很好的做法:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mu mv l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">从yml文件中读取用户定义的变量</figcaption></figure><p id="cf3c" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">因为我们需要决定是使用今天目录还是昨天目录，所以我们需要为每个目录指定两个变量(一个代表昨天，一个代表今天)。用于函数加载的文件很简单:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mu mv l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">yml文件</figcaption></figure><p id="81b1" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">指定默认参数后，我们创建管道实例来调度我们的任务。在气流术语中，我们称之为DAG:</p><blockquote class="mn mo mp"><p id="f0f0" class="ki kj mq kk b kl lx ij kn ko ly im kq mr lz kt ku ms ma kx ky mt mb lb lc ld hb bi translated">一个<code class="du nk nl nm md b">DAG</code>——或者一个有向无环图——是你想要运行的所有任务的集合，以一种反映它们的关系和依赖的方式组织。</p></blockquote><p id="fc38" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">我们是这样定义的:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mu mv l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">定义DAG</figcaption></figure><p id="7003" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">这里，我们希望通过使用<strong class="kk hj"> schedule_interval </strong>参数来安排DAG每天运行。</p><p id="3a4f" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">接下来，我们写下每个作业将如何执行。具体来说，我们希望编写2个bash作业来检查HDFS目录，编写3个bash作业来运行<strong class="kk hj"> job1、job2 </strong>和<strong class="kk hj"> job3 </strong>。这里，bash作业只是简单的命令，但是我们可以任意创建更复杂的作业:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mu mv l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">Bash工作函数</figcaption></figure><p id="3be3" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">因为我们想把检查过的目录传递给<strong class="kk hj"> job1 </strong>，我们需要一些方法在操作者之间进行交叉通信。幸运的是，气流确实为我们提供了操作员交叉通信的功能，称为<strong class="kk hj"> XCom </strong>:</p><blockquote class="mn mo mp"><p id="df48" class="ki kj mq kk b kl lx ij kn ko ly im kq mr lz kt ku ms ma kx ky mt mb lb lc ld hb bi translated">x<strong class="kk hj">com</strong>让任务交换信息，允许更微妙的控制形式和共享状态。名字是“交叉传播”的缩写。XCom主要由键、值和时间戳定义，但也跟踪属性，如创建XCom的任务/DAG以及它何时应该可见。任何可以被pickled的对象都可以用作XCom值，所以用户应该确保使用大小合适的对象。</p></blockquote><p id="29a6" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">在这里的<strong class="kk hj"> check_dir1 </strong>和<strong class="kk hj"> check_dir2 </strong>函数中，我们回显了<strong class="kk hj"> job1 </strong>的目录，我们可以通过使用以下Jinja语法获得这些目录:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="9387" class="mh jr hi md b fi mi mj l mk ml">{{ ti.xcom_pull(task_ids='Your task ID here') }}</span></pre><p id="b8cb" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">我们需要做的最后一件事是实例化airflow作业，并指定每个作业的顺序和依赖关系:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mu mv l"/></div></figure><p id="4d86" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">语法<strong class="kk hj">【A，B】&gt;&gt;C</strong>的意思是C将需要等待A和B结束后才能运行。你可以这样写的另一种方式是使用<strong class="kk hj"> set_downstream </strong>函数:<strong class="kk hj"> A.set_downstream(B) </strong>意味着A需要在B可以运行之前完成。</p><p id="883a" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">每个bash作业实例都有一个触发规则，它指定了该作业运行所需的条件，在这段代码中，我们使用了两种类型的触发规则:</p><ul class=""><li id="3bef" class="mw mx hi kk b kl lx ko ly kr my kv mz kz na ld nb nc nd ne bi translated"><strong class="kk hj"> all_done: </strong>无论成功与否，之前的所有操作都已经完成工作。</li><li id="913c" class="mw mx hi kk b kl nf ko ng kr nh kv ni kz nj ld nb nc nd ne bi translated"><strong class="kk hj"> all_success: </strong>之前的所有操作都已成功完成。</li></ul><p id="5178" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">在创建了整个管道之后，您需要做的就是启动这个调度程序:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="02ff" class="mh jr hi md b fi mi mj l mk ml">python scheduler_demo.py</span></pre><p id="415e" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated"><strong class="kk hj">注意:</strong>默认DAG目录为<strong class="kk hj"> ~/airflow/dags/ </strong>。所以你所有的代码都应该在这个文件夹里。</p><p id="61e6" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">您需要等待几分钟，然后登录到<a class="ae mm" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>来查看您的调度程序管道:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nn"><img src="../Images/7ea4365a9ffe7fe156160ea446365e42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WhTxx053EeWtPLoCpOUJzg.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">气流UI</figcaption></figure><p id="76d3" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">您可以通过点按播放图标来手动触发DAG。您还可以监视您的调度程序进程，只需单击<strong class="kk hj"> DAG运行</strong>部分中的一个圆圈:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es no"><img src="../Images/b8f772474f1cbc4c783695e3a09bb3f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6l5srWACYivNUgEB6TBt9A.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">单击DAG运行部分</figcaption></figure><p id="fb05" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">单击DAG运行中的进程后，将会出现管道进程:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es np"><img src="../Images/213f18379a176b29e06076c07df7cd02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qOTy0OpCVswugEsHQ7HcTA.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">调度程序进程</figcaption></figure><p id="be1f" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">这表明整个管道已经成功运行。</p><p id="6114" class="pw-post-body-paragraph ki kj hi kk b kl lx ij kn ko ly im kq kr lz kt ku kv ma kx ky kz mb lb lc ld hb bi translated">这就是如何创建一个简单的气流管道调度程序。整个剧本可以在这个<a class="ae mm" href="https://github.com/Elvenson/Airflow" rel="noopener ugc nofollow" target="_blank"> <strong class="kk hj">回购</strong> </a>中找到。谢谢你一直读到最后，这是我在媒体上的第一篇文章，所以欢迎任何反馈！</p></div></div>    
</body>
</html>