<html>
<head>
<title>Deploy an NLP model with Streamlit and Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Streamlit和Heroku部署NLP模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploy-an-nlp-model-with-streamlit-and-heroku-5f0ae4b9048c?source=collection_archive---------10-----------------------#2020-10-31">https://medium.com/analytics-vidhya/deploy-an-nlp-model-with-streamlit-and-heroku-5f0ae4b9048c?source=collection_archive---------10-----------------------#2020-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ece58f49c0b05cc23872703197c2ff06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YKFvTZ8zCdUI-cZl"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@mr_fresh?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">尤拉鲜</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="d372" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在完成最近的一个<a class="ae iu" href="https://merb92.medium.com/too-good-to-be-true-nlp-c97868c2db55" rel="noopener">假新闻分类项目</a>后，我想建立一个使用我的模型的简单webapp。因为它们易于实现，我选择用<a class="ae iu" href="https://www.streamlit.io/" rel="noopener ugc nofollow" target="_blank"> Streamlit </a>构建应用程序，用<a class="ae iu" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>部署它。虽然这两个平台还可以做更多的事情，但接下来是一步一步的指导，以我的应用程序为例，开始一个简单的项目。</p><h1 id="190b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">安装细流</h1><p id="a770" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">请注意，Streamlit需要Python 3.6或更高版本。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a579" class="lf ju hi lb b fi lg lh l li lj">pip install streamlit</span></pre><p id="1a14" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装完成后，使用内置的“hello world”应用程序测试安装。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="0178" class="lf ju hi lb b fi lg lh l li lj">streamlit hello</span></pre><p id="037e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切正常，这将在浏览器中打开一个窗口，其中有一个提供几个演示的网页。</p><p id="a0f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，您可以返回终端窗口，用<em class="lk"> control-c </em>停止Streamlit。</p><h1 id="4a38" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">为应用程序创建基本的Python脚本</h1><p id="35a7" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">既然有了Streamlit，就该做个app了。打开一个文本编辑器，创建一个新的Python文件，例如<code class="du ll lm ln lb b">my_app.py</code> <br/>现在你可以创建自己的“Hello World”应用程序了。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="ae4c" class="lf ju hi lb b fi lg lh l li lj">import streamlit as st</span><span id="e844" class="lf ju hi lb b fi lo lh l li lj">st.title('Hello World')</span></pre><p id="d7e0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保存文件并运行应用程序。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d9f2" class="lf ju hi lb b fi lg lh l li lj">$ streamlit run my_app.py</span></pre><p id="c4f4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你的Hello World应用程序将打开一个新的浏览器窗口或标签。<br/>接下来，向您的应用程序添加另一行代码，如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a529" class="lf ju hi lb b fi lg lh l li lj">import streamlit as st</span><span id="b0ad" class="lf ju hi lb b fi lo lh l li lj">st.title('Hello World')</span><span id="efc1" class="lf ju hi lb b fi lo lh l li lj">st.write('Change is Coming')</span></pre><p id="7adb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保存后，Streamlit会注意到并询问您是否要使用新代码重新运行应用程序。这非常方便，因为你不必每次做出改变都重新启动应用程序。</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/030a41237106907c150f32d8b1ac0945.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AD2DJOS_HaQB-vpSm0lpOA.png"/></div></div></figure><h1 id="7cbd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">是时候让应用做点什么了</h1><p id="e57c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">正如你从一些Streamlit演示中看到的，它非常适合快速启动和运行一个简单但好看的应用程序。从创建“Hello World”应用程序所需的两行代码中可以看出，它在后台为你处理很多事情。</p><p id="b77d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为它在幕后处理很多事情，我发现即使是我做的这个简单的应用程序也有一些权衡。每当用户与应用程序交互时，整个脚本都会重新运行。对于我的应用程序，这在界面上产生了一些焦点问题。我要求用户输入新闻故事的标题，在他们按下enter键后，整个脚本再次运行，现在他们能够输入新闻故事的文本，但焦点仍然在新闻标题的第一个单元格上。我的脚本中还需要很多嵌套的if thens来跟踪应用程序的状态。</p><p id="9aad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">也就是说，如果您想轻松地探索数据集或展示一些数据的可视化效果，Streamlit看起来是一个不错的框架。</p><p id="a817" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望我的应用程序接受一个新闻标题和一个新闻故事，使用我训练的模型对其进行分类，然后输出结果。我的模型基于新闻故事中使用的停用词进行分类，所以我也想输出该版本的故事，以便用户可以看到它。</p><p id="8c81" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如我上面提到的，每当有某种用户输入时，Streamlit都会重新运行您的脚本。如果你有任何功能需要一些时间，你的应用程序可能会变得非常慢。Streamlit通过允许你用<code class="du ll lm ln lb b">@st.cache</code>来修饰你的函数来处理这个问题，它将缓存这个函数，直到这个函数的某些东西改变。我需要在加载我训练过的模型/管道时使用它。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7e39" class="lf ju hi lb b fi lg lh l li lj"><a class="ae iu" href="http://twitter.com/st" rel="noopener ugc nofollow" target="_blank">@st</a>.cache<br/>def load_pipeline(model_path, model_file_name):<br/>    """<br/>    Load the Text Processing and Classifier Pipeline<br/>    """<br/>    return pickle.load(open(model_path + model_file_name, 'rb'))</span><span id="85c9" class="lf ju hi lb b fi lo lh l li lj">pipeline = load_pipeline()</span></pre><p id="5dcb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我已经加载了管道，我需要从文本字段和文本区域获取一些输入。Streamlit有两个内置函数来处理这个问题。<code class="du ll lm ln lb b">st.text_input</code>和<code class="du ll lm ln lb b">st.text_area</code>。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9b2b" class="lf ju hi lb b fi lg lh l li lj">news_title = st.text_input('Enter a News Title')<br/>news_story = st.text_area('Enter a News Story', height=400)</span></pre><p id="572a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我使用我的模型对新闻故事进行分类，并输出结果。我使用了<code class="du ll lm ln lb b">st.write</code>，它可以像我一样输出文本，也可以输出可视化或数据帧。据细流说，这是他们“细流指挥的瑞士军刀”</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="8656" class="lf ju hi lb b fi lg lh l li lj">st.write('Your news story is classified as ', class_text, 'with a ',<br/>          probability, '% probability.')</span></pre><h1 id="7a1d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">在Heroku上部署您的应用</h1><p id="6d3d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在你已经创建了你的应用程序，是时候让它在本地机器之外的地方运行了。Streamlit正在推出一种自己处理部署的方法，但目前还有一个等待列表。现有的解决方案是使用Heroku。</p><p id="9d89" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Heroku提供付费和免费的应用托管服务。因为你可能刚刚开始，免费选项应该没问题。</p><p id="8cfa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以选择从github上传你的应用，也可以选择Heroku命令行界面(CLI)。我将使用Heroku CLI进行演示。</p><p id="bdfb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，您需要安装Heroku CLI。你可以按照Heroku <a class="ae iu" href="https://devcenter.heroku.com/articles/getting-started-with-python#set-up" rel="noopener ugc nofollow" target="_blank">提供的指示在这里</a>。</p><h2 id="abb0" class="lf ju hi bd jv lq lr ls jz lt lu lv kd jg lw lx kh jk ly lz kl jo ma mb kp mc bi translated">登录Heroku</h2><p id="b4f8" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在打开一个终端，转到包含您的应用程序的目录，并登录Heroku。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="bdb6" class="lf ju hi lb b fi lg lh l li lj">$ heroku login</span></pre><p id="b2f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上述命令将打开一个新的浏览器窗口，您可以在其中输入您的Heroku登录信息。</p><h2 id="34b7" class="lf ju hi bd jv lq lr ls jz lt lu lv kd jg lw lx kh jk ly lz kl jo ma mb kp mc bi translated">创建一个新的Heroku实例</h2><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e09b" class="lf ju hi lb b fi lg lh l li lj">$ heroku create</span></pre><p id="83c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该命令将为您的应用程序创建一个新的Heroku实例，并给它一个随机名称。</p><h2 id="79d0" class="lf ju hi bd jv lq lr ls jz lt lu lv kd jg lw lx kh jk ly lz kl jo ma mb kp mc bi translated">为Heroku准备您的应用程序</h2><p id="96cb" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在上传你的应用程序之前，需要创建几个额外的文件，让Heroku知道如何运行你的应用程序，以及需要哪些依赖项。</p><p id="78b9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">过程文件</strong></p><p id="4eda" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Procfile将告诉Heroku运行什么命令来启动你的应用程序。打开一个文本编辑器，输入下面的命令，用名字或者你的脚本替换<code class="du ll lm ln lb b">web_app.py</code>。请注意，Procfile没有文件扩展名。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9c65" class="lf ju hi lb b fi lg lh l li lj">web: streamlit run --server.enableCORS false --server.port $PORT web_app.py</span></pre><p id="1052" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，您也可以在单独的shell脚本文件中设置<code class="du ll lm ln lb b">enableCORS</code>和<code class="du ll lm ln lb b">port</code>参数，但是我发现这种方法更简单。</p><p id="8c5b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> requirements.txt </strong></p><p id="741a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个文件中，您将列出您的应用程序需要运行的Python包。请确保只包含您真正需要的包，否则您最终会得到一个臃肿的实例。创建这个文件的一个简单方法是使用<code class="du ll lm ln lb b">pipreqs</code>。首先安装这个包。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b387" class="lf ju hi lb b fi lg lh l li lj">$ pip install pipreqs</span></pre><p id="396f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，从您的应用程序所在的位置向上一级目录，然后以您的应用程序的文件夹名称作为参数运行pipreqs。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b987" class="lf ju hi lb b fi lg lh l li lj">$ pipreqs &lt;path&gt;</span></pre><p id="2013" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它将在您指定的目录中创建<code class="du ll lm ln lb b">requirements.txt</code>文件，其中只包含您需要的Python包和相应的版本。它看起来会像下面这样:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="2f25" class="lf ju hi lb b fi lg lh l li lj">nltk==3.4.5<br/>matplotlib==3.1.1<br/>pandas==1.0.3<br/>streamlit==0.69.2<br/>numpy==1.16.5<br/>scikit_learn==0.23.2</span></pre><p id="fed8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> runtime.txt </strong></p><p id="b216" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此文件包含您希望应用程序使用的Python版本。该文件的内容如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="68d4" class="lf ju hi lb b fi lg lh l li lj">python-3.6.9</span></pre><p id="ee2e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> nltk.txt </strong></p><p id="5eed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不是每个应用程序都需要这个文件，但是因为我使用nltk标记器，所以我需要告诉Heroku一些额外的信息。如果你使用nltk并且没有把它放在这个文件中，当你试图运行你的应用程序时你会得到一个错误，这个错误会告诉你你需要把什么放在这个文件中。在我的情况下，我只需要在文件中放一件东西。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7e54" class="lf ju hi lb b fi lg lh l li lj">punkt</span></pre><h1 id="c21b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">设置Git存储库</strong></h1><p id="d682" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">如果您还没有这样做，您需要为您的应用程序建立一个Git存储库。在应用程序的目录中输入以下命令:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a43d" class="lf ju hi lb b fi lg lh l li lj">git init</span></pre><p id="5d3d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果目录中的所有东西都是你的应用程序运行所必需的，你可以用一个命令把它们都推送到Heroku，如果不是，你需要对每个你需要的文件使用<code class="du ll lm ln lb b">$ git add</code>。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d06f" class="lf ju hi lb b fi lg lh l li lj">$ git add .<br/>$ git commit -m 'First commit'<br/>$ git push heroku master</span></pre><p id="5512" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此时，git将收集文件，Heroku将开始为您的应用程序构建一个源文件，其中包含运行它所需的一切。如果几分钟后一切顺利，您将看到以下消息。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d0e6" class="lf ju hi lb b fi lg lh l li lj">remote: Verifying deploy... done.</span></pre><p id="2a67" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，您需要运行以下命令来运行您的应用程序。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="70c3" class="lf ju hi lb b fi lg lh l li lj">$ heroku ps:scale web=1</span></pre><h1 id="5f5f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">让我们看看应用程序</h1><p id="4af1" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在是关键时刻了。在终端中输入以下命令，将会打开一个包含您的应用程序的新浏览器窗口。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="92b8" class="lf ju hi lb b fi lg lh l li lj">$ heroku open</span></pre><figure class="kw kx ky kz fd ij er es paragraph-image"><div class="er es md"><img src="../Images/ad75d929d43fdb601e82f62e5769f282.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*J8Ehynl-eOW1IQiCOT5NyQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://www.reuters.com/article/us-usa-election-earlyvoting/early-voting-in-u-s-election-tops-90-million-idUSKBN27G0S2" rel="noopener ugc nofollow" target="_blank">https://www . Reuters . com/article/us-USA-election-early voting/early-voting-in-u-s-election-tops-9000万-idUSKBN27G0S2 </a></figcaption></figure><p id="30dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以上是我在路透社的一篇文章上运行的应用程序。它认为这篇文章是真实的。</p><p id="c032" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这个指南对你有所帮助。</p></div></div>    
</body>
</html>