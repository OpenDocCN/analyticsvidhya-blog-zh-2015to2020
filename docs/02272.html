<html>
<head>
<title>Spring Cloud Config Server and Good Practice of Refresh Scope Usage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring云配置服务器和刷新范围使用的良好实践</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spring-cloud-config-server-and-good-practice-of-refresh-scope-usage-ef65d0fee379?source=collection_archive---------1-----------------------#2019-12-09">https://medium.com/analytics-vidhya/spring-cloud-config-server-and-good-practice-of-refresh-scope-usage-ef65d0fee379?source=collection_archive---------1-----------------------#2019-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/04373cc2d0034d64dc290c54852e3e29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IATFaBFEtv_hCzJc"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">奥斯卡·伊尔迪兹在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="986d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">十二因素应用程序开发方法强烈建议“<strong class="ix hj">将配置与代码严格分离。”[1] </strong></p><p id="cde1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Spring Cloud通过Spring Cloud Config Server为这个问题提供了一个解决方案。Spring Cloud配置服务器定义如下。</p><p id="228c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“Spring Cloud Config为分布式系统中的外部化配置提供了服务器端和客户端支持。通过配置服务器，您可以集中管理所有环境中应用程序的外部属性。”[2]</p><p id="5c34" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在一个中心位置管理您的配置是一个超级简单而且非常高效的特性。缺乏集中配置会导致经常出错。</p><p id="102c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另一个好的特性是在改变你的配置后，你可以很容易地从你的应用程序中得到这些，而不需要重启。有很多教程演示了如何在运行时创建配置服务器和刷新属性。我认为<strong class="ix hj">为什么文章</strong>比<strong class="ix hj">如何文章</strong>更重要。所以我没有说明如何创建配置服务器等。我想描述为什么我们在处理运行时属性刷新时使用配置属性。</p><p id="7b2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你在网上搜索，有大量的资源只是显示如下控制器的刷新范围。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="2ea1" class="kc kd hi jy b fi ke kf l kg kh">@EnableAutoConfiguration<br/>@ComponentScan<br/>@RestController<br/>@RefreshScope // important!<br/>public class SpringApp {<br/>    @Value("${bar:World!}")<br/>    String bar;<br/><br/>    @RequestMapping("/")<br/>    String hello() {<br/>        return "Hello " + bar + "!";<br/>    }<br/><br/>    public static void main(String[] args) {<br/>        SpringApplication.run(SpringApp.class, args);<br/>    }<br/>}</span></pre><p id="1fd3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是在正确的位置选择刷新范围并不容易，如图所示。让我想想下面的场景</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="1f97" class="kc kd hi jy b fi ke kf l kg kh">test:<br/>    value: MyTestValue</span></pre><p id="b173" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">控制器:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="8c83" class="kc kd hi jy b fi ke kf l kg kh">@RestController("/test")<br/>public class TestController {<br/><br/>    private final TestService testService;<br/><br/>    public TestController(TestService testService) {<br/>        this.testService = testService;<br/>    }<br/><br/>    @GetMapping("/v1")<br/>    public String test() {<br/>        return testService.getValueWithDelay();<br/>    }<br/><br/>    @GetMapping("/v2")<br/>    public String test2()  {<br/>        return testService.getValue();<br/>    }<br/>}</span></pre><p id="a58c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">服务:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="911e" class="kc kd hi jy b fi ke kf l kg kh">@RefreshScope<br/>@Service<br/>public class TestService {<br/><br/>    @Value("${test.value}")<br/>    private String value;<br/><br/>    public String getValueWithDelay() {<br/>        try {<br/>            Thread.<em class="ki">sleep</em>(30000L);<br/>        } catch (InterruptedException e) {<br/>            e.printStackTrace();<br/>        }<br/>        return value;<br/>    }<br/><br/>    public String getValue() {<br/>        return value;<br/>    }<br/>}</span></pre><p id="bc01" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">调用<a class="ae iu" href="http://127.0.0.1:8080/test/v1" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8080/test/v1</a>。有30秒的时间延迟。30秒后返回。</p><p id="31a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">调用<a class="ae iu" href="http://127.0.0.1:8080/test/v1" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8080/test/v</a>2。它在6毫秒后返回。</p><p id="b865" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">似乎一切都很完美。我们换个场景吧。</p><ul class=""><li id="51c5" class="kj kk hi ix b iy iz jc jd jg kl jk km jo kn js ko kp kq kr bi translated"><strong class="ix hj">调用</strong><a class="ae iu" href="http://127.0.0.1:8080/test/v1" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">http://127 . 0 . 0 . 1:8080/test/v1</strong></a></li><li id="2282" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js ko kp kq kr bi translated"><strong class="ix hj">将测试值更改为MyTestValueChanged </strong></li><li id="b2aa" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js ko kp kq kr bi translated"><strong class="ix hj">刷新属性localhost:8080/actuator/Refresh</strong></li><li id="9ee6" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js ko kp kq kr bi translated"><strong class="ix hj">调用</strong><a class="ae iu" href="http://127.0.0.1:8080/test/v1" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">http://127 . 0 . 0 . 1:8080/test/v</strong></a><strong class="ix hj">2</strong></li></ul><p id="b9aa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> V2端点大约在10-20秒后返回。(你需要在v1执行完成之前完成这些操作)</strong></p><p id="a834" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们在服务类中使用了刷新范围。如果值在服务类中使用，那么其他方法将等待，直到这个值被上下文替换。在我们现代的软件开发环境中，甚至毫秒都很重要。V1和V2是不同的操作，但由于刷新范围的使用，它们会相互阻塞。更糟糕的是，跟踪哪个值将影响哪个服务变得非常困难。</p><p id="8cd3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这一点上，配置属性的概念变得复杂起来。如果在配置属性中使用刷新范围而不是服务，那么可以解决不同服务相互阻塞的问题。因为上下文只刷新配置属性bean。并且刷新速度非常快。这就是为什么你应该使用配置属性并在其中使用刷新范围。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="7bdd" class="kc kd hi jy b fi ke kf l kg kh">@RefreshScope<br/>@Configuration<br/>@ConfigurationProperties(prefix = "test")<br/>public class TestConfiguration {<br/><br/>    private String value;<br/><br/>    public String getValue() {<br/>        return value;<br/>    }<br/><br/>    public void setValue(String value) {<br/>        this.value = value;<br/>    }<br/>}</span></pre><p id="80e6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">服务:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="d88a" class="kc kd hi jy b fi ke kf l kg kh">@Service<br/>public class TestService {<br/>    private final TestConfiguration testConfiguration;<br/><br/>    public TestService(TestConfiguration testConfiguration) {<br/>        this.testConfiguration = testConfiguration;<br/>    }<br/><br/>    public String getValueWithDelay() {<br/>        try {<br/>            Thread.<em class="ki">sleep</em>(30000L);<br/>        } catch (InterruptedException e) {<br/>            e.printStackTrace();<br/>        }<br/>        return testConfiguration.getValue();<br/>    }<br/><br/>    public String getValue() {<br/>        return testConfiguration.getValue();<br/>    }<br/>}</span></pre><ul class=""><li id="d5ed" class="kj kk hi ix b iy iz jc jd jg kl jk km jo kn js ko kp kq kr bi translated">致电<a class="ae iu" href="http://127.0.0.1:8080/test/v1" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8080/test/v1</a></li><li id="ad22" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js ko kp kq kr bi translated">将测试值更改为MyTestValueChangedAgain</li><li id="a701" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js ko kp kq kr bi translated">刷新属性本地主机:8080/actuator/refresh</li><li id="3ac0" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js ko kp kq kr bi translated">致电<a class="ae iu" href="http://127.0.0.1:8080/test/v1" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8080/test/v</a>2</li></ul><p id="b7c4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">V2端点大约在10毫秒后返回。没有障碍。</p><p id="6195" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">问题解决了。</p><p id="bfbb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">PS:特别感谢Ercan Sormaz。</p><p id="eb45" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><ol class=""><li id="d669" class="kj kk hi ix b iy iz jc jd jg kl jk km jo kn js kx kp kq kr bi translated"><a class="ae iu" href="https://12factor.net/config" rel="noopener ugc nofollow" target="_blank">https://12factor.net/config</a></li><li id="214c" class="kj kk hi ix b iy ks jc kt jg ku jk kv jo kw js kx kp kq kr bi translated"><a class="ae iu" href="https://cloud.spring.io/spring-cloud-config/reference/html/" rel="noopener ugc nofollow" target="_blank">https://cloud.spring.io/spring-cloud-config/reference/html/</a></li></ol></div></div>    
</body>
</html>