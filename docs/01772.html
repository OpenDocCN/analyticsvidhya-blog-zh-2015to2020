<html>
<head>
<title>Apply a business plan for your micro-service in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes为你的微服务申请商业计划</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/apply-a-business-plan-for-your-micro-service-in-kubernetes-33e46bf33f15?source=collection_archive---------21-----------------------#2019-11-12">https://medium.com/analytics-vidhya/apply-a-business-plan-for-your-micro-service-in-kubernetes-33e46bf33f15?source=collection_archive---------21-----------------------#2019-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/049b328bc0824492627a19518fee9576.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xE3Eg49ITc8OkenIjhZy7w.png"/></div></div></figure><p id="2828" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在kuberenetes中部署微服务已经在很短的时间内在容器化技术中取得了很大的进展。随着kubernetes带来的部署微服务的便利，合并业务计划来管理这些微服务的需求也在增加。</p><p id="c524" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看如何将商业计划应用到你的微服务中，并通过4个步骤将它作为一个管理API。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="fedb" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">先决条件</h1><ol class=""><li id="42e8" class="kt ku hi is b it kv ix kw jb kx jf ky jj kz jn la lb lc ld bi translated"><a class="ae le" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li><li id="c0b0" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn la lb lc ld bi translated"><a class="ae le" href="https://kubernetes.io/docs/setup/" rel="noopener ugc nofollow" target="_blank"> Kubernetes v1.12或以上</a></li><li id="006d" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn la lb lc ld bi translated">DockerHub或私有docker注册表中的帐户</li><li id="3fc6" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn la lb lc ld bi translated">Kubernetes的API操作员。下载<a class="ae le" href="https://github.com/wso2/k8s-apim-operator/releases/download/v1.0.0/api-k8s-crds-1.0.0.zip" rel="noopener ugc nofollow" target="_blank"> api-k8s-crds-1.0.0.zip </a>并解压</li><li id="645e" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn la lb lc ld bi translated">从<a class="ae le" href="https://github.com/wso2/product-apim-tooling/releases/" rel="noopener ugc nofollow" target="_blank">https://github.com/wso2/product-apim-tooling/releases/</a>下载适用于您的操作系统的API控制器3.0.0版</li></ol></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="0266" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们亲自动手，一步一步地钻研这个过程。</p><h1 id="d85f" class="jv jw hi bd jx jy lk ka kb kc ll ke kf kg lm ki kj kk ln km kn ko lo kq kr ks bi translated">步骤1:为Kubernetes部署API操作符</h1><p id="f681" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lp jd je jf lq jh ji jj lr jl jm jn hb bi translated">用于Kubernetes的API Operator是一个方便的工具，可以在Kubernetes中将您的微服务部署为托管API，并使用业务计划和安全计划来管理它们，没有任何麻烦。在这里，我将使用Kubernetes的API操作符来将我们的微服务部署为Kubernetes中的托管API，并应用业务计划来限制资源的API请求数量。</p><ol class=""><li id="a5b7" class="kt ku hi is b it iu ix iy jb ls jf lt jj lu jn la lb lc ld bi translated">导航到先决条件4中解压缩的zip中的<em class="lv"> api-k8s-crds-1.0.0 </em>目录</li><li id="229e" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn la lb lc ld bi translated">部署与API操作符相关的工件</li></ol><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="3c68" class="mf jw hi mb b fi mg mh l mi mj">kubectl apply -f apim-operator/controller-artifacts/</span></pre><p id="04be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.Kubernetes的API操作符通过将托管API映像推送到DockerHub，使它可以在另一个集群中重用。您可以按如下方式输入DockerHub信息，并部署控制器配置。</p><ul class=""><li id="7eb8" class="kt ku hi is b it iu ix iy jb ls jf lt jj lu jn mk lb lc ld bi translated">打开apim-operator/controller-configs/controller _ conf . YAML，更新<em class="lv">用户的docker注册表</em>。</li></ul><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="6628" class="mf jw hi mb b fi mg mh l mi mj">dockerRegistry: &lt;username-docker-registry&gt;</span></pre><ul class=""><li id="5479" class="kt ku hi is b it iu ix iy jb ls jf lt jj lu jn mk lb lc ld bi translated">打开apim-operator/controller-configs/Docker _ secret _ template . YAML .<br/>输入Docker-Hub帐户的base 64编码用户名和密码</li></ul><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="e1e3" class="mf jw hi mb b fi mg mh l mi mj">data:<br/> username: ENTER YOUR BASE64 ENCODED USERNAME<br/> password: ENTER YOUR BASE64 ENCODED PASSWORD</span></pre><ul class=""><li id="4fcb" class="kt ku hi is b it iu ix iy jb ls jf lt jj lu jn mk lb lc ld bi translated">执行以下命令来部署控制器配置。</li></ul><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="b20e" class="mf jw hi mb b fi mg mh l mi mj">kubectl apply -f apim-operator/controller-configs/</span></pre><p id="37d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.配置<a class="ae le" href="https://wso2.com/api-management/tooling/" rel="noopener ugc nofollow" target="_blank"> API控制器</a>，这是一个综合的命令行工具，用于处理与API操作符相关的操作。</p><ul class=""><li id="37b1" class="kt ku hi is b it iu ix iy jb ls jf lt jj lu jn mk lb lc ld bi translated">提取API控制器发行版，并使用命令行工具在提取的文件夹中导航</li><li id="fd20" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn mk lb lc ld bi translated">将提取的文件夹的位置添加到系统的PATH变量中，以便能够从任何地方访问可执行文件。</li><li id="11bb" class="kt ku hi is b it lf ix lg jb lh jf li jj lj jn mk lb lc ld bi translated">将API控制器的模式设置为Kubernetes</li></ul><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="cd6c" class="mf jw hi mb b fi mg mh l mi mj">apictl set --mode k8s</span></pre><h1 id="3c8a" class="jv jw hi bd jx jy lk ka kb kc ll ke kf kg lm ki kj kk ln km kn ko lo kq kr ks bi translated">步骤2:在集群中部署您的业务计划</h1><p id="e330" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lp jd je jf lq jh ji jj lr jl jm jn hb bi translated">您可以使用RateLimiting类型定义您的业务计划，并在集群中部署它。</p><p id="8bba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有3种限速类型:<em class="lv">提前、订阅</em>和<em class="lv">申请</em>；这允许您在不同的基础上限制API请求的数量。在这篇博客中，我们将讨论高级类型，这实际上是最简单的类型，它允许您限制所有用户对特定资源或API的API请求数量。</p><p id="13e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们定义我们的业务策略，每分钟只允许3个请求。</p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="8799" class="mf jw hi mb b fi mg mh l mi mj">apiVersion: wso2.com/v1alpha1<br/>kind: RateLimiting<br/>metadata:<br/>  name: advancethreepolicy<br/>spec:<br/>  type: advance<br/>  description: Allow 3 requests per minute   # optional<br/>  timeUnit: min<br/>  unitTime: 1<br/>  requestCount:<br/>    limit: 3</span></pre><p id="f0d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在kubernetes集群中部署它。(rlpolicy.yaml是上述策略的文件名)</p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="a607" class="mf jw hi mb b fi mg mh l mi mj">apictl apply -f rlpolicy.yaml</span></pre><figure class="lw lx ly lz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/f7c992ccd8244926f0cebdbba756f647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8pX77wq2DHzKULaGTeyptg.png"/></div></div><figcaption class="mm mn et er es mo mp bd b be z dx translated">限速控制器的体系结构</figcaption></figure><p id="729d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您在业务计划中部署速率限制CRD时，速率限制控制器会创建一个包含您已部署的所有策略的配置图。</p><h1 id="0c96" class="jv jw hi bd jx jy lk ka kb kc ll ke kf kg lm ki kj kk ln km kn ko lo kq kr ks bi translated"><strong class="ak">第三步:在招摇定义中引用你的商业计划</strong></h1><p id="9395" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lp jd je jf lq jh ji jj lr jl jm jn hb bi translated">您可以使用swagger定义，用您的业务计划策略、安全策略和微服务的端点来定义您的托管API。</p><p id="c8dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以在这里 找到一个swagger定义<a class="ae le" href="https://github.com/RameshaKaru/crd-demo/blob/master/swagger.yaml" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">的例子。我已经用扩展“x-wso2-throttling-tier”定义了要应用于整个API的策略。如果您想要限制对一个资源的API请求的数量，您可以在资源级别以同样的方式定义它。</strong></a></p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="0ec6" class="mf jw hi mb b fi mg mh l mi mj">x-wso2-throttling-tier: <!-- -->advancethreepolicy</span></pre><p id="3837" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在示例swagger文件中，我使用了来自swagger.io的样本Petstore。</p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="2644" class="mf jw hi mb b fi mg mh l mi mj">x-wso2-production-endpoints: <br/>  urls: — <a class="ae le" href="https://petstore.swagger.io/v2" rel="noopener ugc nofollow" target="_blank">https://petstore.swagger.io/v2</a></span></pre><p id="4505" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以通过“x-wso2-production-endpoints”扩展以同样的方式使用部署在kubernetes中的微服务的端点。</p><h1 id="ef87" class="jv jw hi bd jx jy lk ka kb kc ll ke kf kg lm ki kj kk ln km kn ko lo kq kr ks bi translated"><strong class="ak">步骤4:使用swagger部署您的托管API</strong></h1><p id="32ae" class="pw-post-body-paragraph iq ir hi is b it kv iv iw ix kw iz ja jb lp jd je jf lq jh ji jj lr jl jm jn hb bi translated">最后一步，让我们在Kubernetes中部署我们的托管API。</p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="ac73" class="mf jw hi mb b fi mg mh l mi mj">apictl add api -n adpetstore --from-file=swagger.yaml</span></pre><p id="b2f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">API操作者将运行kaniko作业，用给定的swagger文件和在步骤2中创建的策略配置图来创建微网关的映像。</p><p id="d397" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">API服务需要一些时间才可用。在API服务可用之后，我们可以调用API并测试我们的业务计划是否得到应用。</p><figure class="lw lx ly lz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/9f9a820768aa7973a55aedb484df49e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5y8YjRdOq-vP-ywPmvrXmw.png"/></div></div></figure><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="fc0a" class="mf jw hi mb b fi mg mh l mi mj">TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IlpqUm1ZVE13TlRKak9XVTVNbUl6TWpnek5ESTNZMkl5TW1JeVkyRXpNamRoWmpWaU1qYzBaZz09In0.eyJhdWQiOiJodHRwOlwvXC9vcmcud3NvMi5hcGltZ3RcL2dhdGV3YXkiLCJzdWIiOiJhZG1pbkBjYXJib24uc3VwZXIiLCJhcHBsaWNhdGlvbiI6eyJvd25lciI6ImFkbWluIiwidGllciI6IlVubGltaXRlZCIsIm5hbWUiOiJzYW1wbGUtY3JkLWFwcGxpY2F0aW9uIiwiaWQiOjMsInV1aWQiOm51bGx9LCJzY29wZSI6ImFtX2FwcGxpY2F0aW9uX3Njb3BlIGRlZmF1bHQiLCJpc3MiOiJodHRwczpcL1wvd3NvMmFwaW06MzIwMDFcL29hdXRoMlwvdG9rZW4iLCJ0aWVySW5mbyI6e30sImtleXR5cGUiOiJQUk9EVUNUSU9OIiwic3Vic2NyaWJlZEFQSXMiOltdLCJjb25zdW1lcktleSI6IjNGSWlUM1R3MWZvTGFqUTVsZjVVdHVTTWpsUWEiLCJleHAiOjM3MTk3Mzk4MjYsImlhdCI6MTU3MjI1NjE3OSwianRpIjoiZDI3N2VhZmUtNTZlOS00MTU2LTk3NzUtNDQwNzA3YzFlZWFhIn0.W0N9wmCuW3dxz5nTHAhKQ-CyjysR-fZSEvoS26N9XQ9IOIlacB4R5x9NgXNLLE-EjzR5Si8ou83mbt0NuTwoOdOQVkGqrkdenO11qscpBGCZ-Br4Gnawsn3Yw4a7FHNrfzYnS7BZ_zWHPCLO_JqPNRizkWGIkCxvAg8foP7L1T4AGQofGLodBMtA9-ckuRHjx3T_sFOVGAHXcMVwpdqS_90DeAoT4jLQ3darDqSoE773mAyDIRz6CAvNzzsWQug-i5lH5xVty2kmZKPobSIziAYes-LPuR-sp61EIjwiKxnUlSsxtDCttKYHGZcvKF12y7VF4AqlTYmtwYSGLkXXXw</span></pre><p id="9233" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们用默认的JWT令牌调用API，它允许所有用户。</p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="eecc" class="mf jw hi mb b fi mg mh l mi mj">curl -X GET "https://&lt;external IP of LB service&gt;:9095/petstoreadvance/v1/pet/55" -H "accept: application/xml" -H "Authorization:Bearer $TOKEN" -k</span></pre><p id="6bf5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您使用GKE集群，您可以使用我们部署的托管API服务的外部IP(adpet store)。如果您使用的是minikube，您可以使用节点端口，该服务与minikube IP一起公开。</p><p id="4c2c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为一个例子，你可以看到我在minikube中使用的以下命令。</p><pre class="lw lx ly lz fd ma mb mc md aw me bi"><span id="9804" class="mf jw hi mb b fi mg mh l mi mj">curl -X GET "https://192.168.99.121:32111/petstoreadvance/v1/pet/55?[1-4]" -H "accept: application/xml" -H "Authorization:Bearer $TOKEN" -k</span></pre><p id="b2ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为我们应用了我们的商业计划，允许我们的微服务每分钟只有3个请求，从下面的截图你可以看到第4个请求已经被抑制了。</p><figure class="lw lx ly lz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/4a507945675eee768f335624d865f259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CwLoUP8fI4H_5v6Bc4APsg.png"/></div></div></figure><p id="4101" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇博客中，我们能够用4个简单的步骤为我们的微服务应用一个商业计划，每分钟只允许3个请求。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><p id="6cb6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望你喜欢我的博客，如果你想监控我们上面部署的API的统计数据，你可以关注下面的文章。</p><p id="1a19" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae le" rel="noopener" href="/@ramesha.karu/monitor-the-statistics-of-your-micro-service-in-kubernetes-f649f8960b0a">https://medium . com/@ ramesha . karu/monitor-the-statistics-of-your-micro-service-in-kubernetes-f 649 f 8960 b0a</a></p></div></div>    
</body>
</html>