<html>
<head>
<title>Data Visualisation and Web Scraping using Python | USA Corn Export Sales</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python实现数据可视化和网络抓取|美国玉米出口销售</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/data-visualisation-and-web-scraping-using-python-usa-corn-export-sales-17979e851ec2?source=collection_archive---------13-----------------------#2019-12-03">https://medium.com/analytics-vidhya/data-visualisation-and-web-scraping-using-python-usa-corn-export-sales-17979e851ec2?source=collection_archive---------13-----------------------#2019-12-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7e3d4d633ffa080986569638b4296bab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lU8X54vcPS-_FO2bqGTQ9w.png"/></div></div></figure><p id="bf4a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章将告诉你我如何从一个网站解析数据，保存为dataframe，然后可视化为上面的条形图。作为一个数据分析的新手，我在网上查阅了大量的文章来完成这个项目。我希望你能在这里找到有用的东西。完整的脚本可以在我的Github页面上找到。</p><p id="a23a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下章节将提到4个主题:</p><ol class=""><li id="ab21" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">网页抓取</li><li id="910c" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">数据操作</li><li id="5eb7" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">Matplotlib可视化</li><li id="7cbf" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">释文</li></ol></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h1 id="e067" class="kj kk hi bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">1.网页抓取</h1><p id="0128" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">我试图解析由FAS(外国农业服务)、USDA(美国农业部)发布的2017年和2018年玉米出口销售数据</p><p id="90fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据来自:<a class="ae lm" href="https://apps.fas.usda.gov/export-sales/myfiaug.htm" rel="noopener ugc nofollow" target="_blank">https://apps.fas.usda.gov/export-sales/myfiaug.htm</a></p><p id="e554" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌浏览器中的开发者工具可以用来检查网页的元素。我们可以找到我们想要的表(玉米—未碾磨的)存储在标签<pre>下</pre></p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/930dcf54d1eb5e12f1b6461e89234d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gziRJaX3hOY9GRRpjFzrWw.png"/></div></div></figure><p id="0eac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从这个项目中使用的库开始:</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="9f14" class="lx kk hi lt b fi ly lz l ma mb">import requests<br/>from bs4 import BeautifulSoup<br/>import numpy as np<br/>import pandas as pd<br/>import matplotlib.pyplot as plt</span><span id="9161" class="lx kk hi lt b fi mc lz l ma mb">source = requests.get("<a class="ae lm" href="https://apps.fas.usda.gov/export-sales/myfiaug.htm" rel="noopener ugc nofollow" target="_blank">https://apps.fas.usda.gov/export-sales/myfiaug.htm</a>").text<br/>soup = BeautifulSoup(source, 'lxml')</span><span id="29ca" class="lx kk hi lt b fi mc lz l ma mb">pre = soup.find('pre')<br/>start_text = 'CORN - UNMILLED'<br/>end_text = 'OPTIONAL ORIGIN'</span><span id="140c" class="lx kk hi lt b fi mc lz l ma mb">page_text = pre.text.strip()<br/>start_position = page_text.find(start_text)<br/>end_position = page_text.find(end_text)<br/>table_text = page_text[start_position:end_position]<br/>lines = table_text.splitlines()<br/>lines = lines[10:-2] # select the countries part</span></pre><p id="b258" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我使用BeautifulSoup解析来自USDA网站的文本。网页中有三个表格，因为我只需要使用第一个表格(Corn)，所以设置了“start_text”和“end_text”来选择范围。</p><p id="02c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae lm" href="https://www.geeksforgeeks.org/python-string-splitlines/" rel="noopener ugc nofollow" target="_blank"> splitlines() </a>函数有助于拆分行，使我的“表格文本”变得更具可读性。(见下图)</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/1999694e61754fd1e4065b8a38c55844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*06XqRTtkKysqjo-XOBOVjw.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">table_text(在splitlines()之前)</figcaption></figure><figure class="lo lp lq lr fd ij er es paragraph-image"><div class="er es mi"><img src="../Images/fde1b2f388321769fee760ba1a0fd14c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*oSeQhTWuiQ1sEBMHy1wT6A.png"/></div><figcaption class="me mf et er es mg mh bd b be z dx translated">行(在splitlines()之后)</figcaption></figure><h1 id="c484" class="kj kk hi bd kl km mj ko kp kq mk ks kt ku ml kw kx ky mm la lb lc mn le lf lg bi translated">2.数据操作</h1><p id="b8b0" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">我的想法是将“国家”和“数字”保存到单独的列表中，然后浏览每一行数字，以获得“2017年”和“2018年”的出口数据。我想单独处理三个列表(国家，2017年出口和2018年出口)，将它们保存到数据框中，最后将它们合并在一起。(这只是为了我自己的方便，我确信一定有更有效的方法来这样做)</p><p id="c18c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为我的图表将显示美国出口最多的前五个国家，所以我决定先对数据框中的值进行排序，然后再进行可视化。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="4f8d" class="lx kk hi lt b fi ly lz l ma mb">country = [l.split(':')[0] for l in lines]<br/>numbers = [l.split(':')[-1] for l in lines]</span><span id="64fa" class="lx kk hi lt b fi mc lz l ma mb">ex_2017 = []<br/>ex_2018 = []</span><span id="1d0a" class="lx kk hi lt b fi mc lz l ma mb">for n in numbers:<br/>    if len(n) == 0: # to exclude the empty '' in numbers<br/>        pass<br/>    elif len(n) == 80: # to exclude the dash line '---------'<br/>        pass<br/>    else:<br/>        x = n.split()<br/>        ex_2018.append(x[-2])<br/>        ex_2017.append(x[-1])</span><span id="9284" class="lx kk hi lt b fi mc lz l ma mb">country = [c.strip() for c in country] <br/># use .strip() to remove the spaces in text</span><span id="df92" class="lx kk hi lt b fi mc lz l ma mb">new_country = []<br/>for c in country:<br/>    if len(c) == 0:<br/>        pass<br/>    elif len(c) == 80:<br/>        pass<br/>    else:<br/>        new_country.append(c)</span><span id="d187" class="lx kk hi lt b fi mc lz l ma mb">df1 = pd.DataFrame(new_country)<br/>df1.rename(columns={0:'Country'}, inplace=True)</span><span id="7214" class="lx kk hi lt b fi mc lz l ma mb">df2 = pd.DataFrame(ex_2017)<br/>df2.rename(columns={0:'2017'}, inplace=True)</span><span id="ffd9" class="lx kk hi lt b fi mc lz l ma mb">df3 = pd.DataFrame(ex_2018)<br/>df3.rename(columns={0:'2018'}, inplace=True)</span><span id="1640" class="lx kk hi lt b fi mc lz l ma mb">df = pd.concat([df1['Country'], df2['2017'], df3['2018']], axis=1)<br/>df.set_index('Country', inplace=True)</span><span id="b9a8" class="lx kk hi lt b fi mc lz l ma mb">df['2017'] = pd.to_numeric(df['2017'], errors='coerce') <br/>df['2018'] = pd.to_numeric(df['2018'], errors='coerce')<br/>#By setting errors=’coerce’, you’ll transform the non-numeric values into NaN.</span><span id="be78" class="lx kk hi lt b fi mc lz l ma mb">"""<br/>Save the top five countries in another Series for further visualisation<br/>"""</span><span id="1879" class="lx kk hi lt b fi mc lz l ma mb">top5_2017 = df.sort_values(['2017'], ascending=False).drop(index={<br/>    'TOTAL KNOWN', 'WESTERN HEMISPHERE', 'OTHER ASIA AND OCEANIA'})['2017'].head()<br/>top5_2018 = df.sort_values(['2018'], ascending=False).drop(index={<br/>    'TOTAL KNOWN', 'WESTERN HEMISPHERE', 'OTHER ASIA AND OCEANIA'})['2018'].head()</span><span id="7d40" class="lx kk hi lt b fi mc lz l ma mb">top5_2017.rename({'KOR REP':'KOREA', 'COLOMB':'COLOMBIA'}, inplace=True)<br/>top5_2018.rename({'KOR REP':'KOREA', 'COLOMB':'COLOMBIA'}, inplace=True)</span></pre><h1 id="61c5" class="kj kk hi bd kl km mj ko kp kq mk ks kt ku ml kw kx ky mm la lb lc mn le lf lg bi translated">3.Matplotlib可视化</h1><p id="9cb8" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">我们先来看看<a class="ae lm" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.barh.html" rel="noopener ugc nofollow" target="_blank"> pyplot.barh() </a>的参数。</p><p id="1390" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du mo mp mq lt b">barh</code> ( <em class="mr"> y </em>，<em class="mr">宽度</em>，<em class="mr">高度=0.8 </em>，<em class="mr">左侧=无</em>，<em class="mr"> * </em>，<em class="mr"> align='center' </em>，<em class="mr"> **kwargs </em>)</p><p id="2da7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们知道y轴上的“y”应该是一个数组，“width”是条形的宽度(沿x轴)。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/9296a2cca01b0481c9eb171e13c58e81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1R4M30A6Lg4c4CcPYUNBzA.png"/></div></div></figure><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="4efd" class="lx kk hi lt b fi ly lz l ma mb">labels2017 = top5_2017.index.to_list()<br/>export2017 = top5_2017.to_list()<br/>labels2018 = top5_2018.index.to_list()<br/>export2018 = top5_2018.to_list()</span><span id="02c7" class="lx kk hi lt b fi mc lz l ma mb">y = np.arange(len(labels2018))<br/>width = 0.35 <br/># The width here means the width for the 'bar' (ie the 'height' in parameters)</span><span id="f412" class="lx kk hi lt b fi mc lz l ma mb">fig, ax = plt.subplots(figsize=(18,8))<br/>rects3 = ax.barh(y+width/2, export2017, width, label='2017', alpha=0.8)<br/>rects4 = ax.barh(y-width/2, export2018, width, label='2018', alpha=0.8)<br/>ax.set_title('2017 &amp; 2018 USA Corn Export Sales top 5 countries', fontsize=25)<br/>ax.set_xlabel('Export Sales (1000MT)')<br/>ax.set_yticks(y)<br/>ax.set_yticklabels(labels2018, fontsize=15)<br/>ax.legend(loc='upper right', prop={'size':15})<br/>autolabel_2_MT(rects3)<br/>autolabel_2_MT(rects4) # This is for annotations </span></pre><h1 id="3d80" class="kj kk hi bd kl km mj ko kp kq mk ks kt ku ml kw kx ky mm la lb lc mn le lf lg bi translated">4.释文</h1><p id="a667" class="pw-post-body-paragraph iq ir hi is b it lh iv iw ix li iz ja jb lj jd je jf lk jh ji jj ll jl jm jn hb bi translated">我遵循了这篇<a class="ae lm" href="https://matplotlib.org/3.1.1/gallery/lines_bars_and_markers/barchart.html#sphx-glr-gallery-lines-bars-and-markers-barchart-py" rel="noopener ugc nofollow" target="_blank">帖子</a>中关于如何在条形图旁边制作文本标签的介绍。我对参数做了一些调整，因为我的条形图是水平的，但这篇文章是为垂直的而写的。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="7c4d" class="lx kk hi lt b fi ly lz l ma mb">def autolabel_2_MT(rects): # for two-years graph, unit in 1000MT<br/> for rect in rects:<br/>   width = rect.get_width()<br/>   ax.annotate(‘{}’.format(width),<br/>    xy=(width, rect.get_y() + rect.get_height()/2),<br/>    xytext=(25,-5),<br/>    textcoords=’offset points’,<br/>    ha=’center’, va=’bottom’)</span></pre></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="0622" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我的<a class="ae lm" href="https://github.com/mysterycatt/USA_Corn_Export_Sales" rel="noopener ugc nofollow" target="_blank">脚本</a>包含了一年和两年图形的代码，并且使用不同的单位(%或1000MT)。有兴趣的话看看吧。如果能听到您的任何反馈或问题，我将不胜感激。下次见。</p><figure class="lo lp lq lr fd ij"><div class="bz dy l di"><div class="mt mu l"/></div></figure></div></div>    
</body>
</html>