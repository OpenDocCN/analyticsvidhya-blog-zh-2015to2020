<html>
<head>
<title>How To Carry Out K-Fold Cross-Validation On An Imbalanced Classification Problem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何对不平衡分类问题进行K重交叉验证</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-carry-out-k-fold-cross-validation-on-an-imbalanced-classification-problem-6d3d942a8016?source=collection_archive---------2-----------------------#2020-07-10">https://medium.com/analytics-vidhya/how-to-carry-out-k-fold-cross-validation-on-an-imbalanced-classification-problem-6d3d942a8016?source=collection_archive---------2-----------------------#2020-07-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0222105ba10e45a3257de12a02d36ec5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ntbhAGG0fBx6A7sCYZs9qw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd iu">来源:</strong>【megapixl.com】T2</figcaption></figure><p id="a066" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在本文中，我们将陈述在不平衡类分布问题上应用k-fold交叉验证的适当标准；并演示如何通过Jupyter notebook用python实现它。</p><p id="0011" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">本文将涵盖以下几个部分:</p><blockquote class="ju jv jw"><p id="0d09" class="iw ix jx iy b iz ja jb jc jd je jf jg jy ji jj jk jz jm jn jo ka jq jr js jt hb bi translated"><strong class="iy hj">K倍交叉验证的快速概述</strong></p><p id="51a5" class="iw ix jx iy b iz ja jb jc jd je jf jg jy ji jj jk jz jm jn jo ka jq jr js jt hb bi translated"><strong class="iy hj">数据源概述</strong></p><p id="237e" class="iw ix jx iy b iz ja jb jc jd je jf jg jy ji jj jk jz jm jn jo ka jq jr js jt hb bi translated"><strong class="iy hj">在不平衡类别分布模型上正确应用K-Fold交叉验证的规则</strong></p><p id="70d9" class="iw ix jx iy b iz ja jb jc jd je jf jg jy ji jj jk jz jm jn jo ka jq jr js jt hb bi translated"><strong class="iy hj">如何在Python中对不平衡分类问题应用K-Fold交叉验证</strong></p></blockquote><h2 id="18a1" class="kb kc hi bd iu kd ke kf kg kh ki kj kk jh kl km kn jl ko kp kq jp kr ks kt ku bi translated"><strong class="ak">K倍交叉验证的快速概述</strong></h2><p id="2737" class="pw-post-body-paragraph iw ix hi iy b iz kv jb jc jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt hb bi translated">仅评估一次模型的性能在统计上是不可靠的。最好是多次重复性能评估，以创建性能评估值的分布，然后对该分布进行汇总统计(比如均值和标准差)。这确保了我们获得模型的真实性能值的真实的代表性估计，以及方差。这个概念叫做重复随机抽样。</p><p id="1175" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="iy hj"> k-fold交叉验证</strong> (k-fold cv)利用重复随机抽样技术，通过将数据分成5个或10个等份，然后在每个等份上评估模型的性能，来评估模型的性能。具体来说，它通过执行以下有序步骤来评估模型的性能:</p><ol class=""><li id="58f0" class="la lb hi iy b iz ja jd je jh lc jl ld jp le jt lf lg lh li bi translated">打乱主要数据，</li><li id="f502" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">将主数据分成k组而不替换，</li><li id="4c59" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">取第一组作为测试数据，剩下的k-1组作为训练数据集，然后进行模型性能评估，</li><li id="e9cf" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">每隔一组(第二组，第三组…第k组)重复上述步骤3，例如将第二组作为测试数据，剩余的k-1组作为训练数据集，然后执行模型性能评估。</li><li id="ef5e" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">对每个k倍交叉验证评估的模型性能(准确性、roc_auc等)进行评分，以及</li><li id="9b20" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">取分数分布的均值和方差来估计模型的整体性能。</li></ol><p id="2a8e" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">下图突出显示了交叉验证评估的数量(进行了5次评估),这些评估是在5倍分割的基础上进行的，以评估模型性能:</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/42483573c6ff73d4d263e4ded3cbf55d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*fb-rdCbeErLMzDXBa4IGDw.png"/></div></figure><p id="9d7c" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">一般来说，从上图可以看出，在模型性能交叉验证评估期间，k组拆分的每个组都将是一个测试组<strong class="iy hj">一次</strong>，以及一个训练数据集<strong class="iy hj"> k-1次</strong>的成员。</p><p id="0473" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">有四种类型的k-fold交叉验证，即:训练/测试分割、LOOCV、分层和重复。</p><h2 id="279b" class="kb kc hi bd iu kd ke kf kg kh ki kj kk jh kl km kn jl ko kp kq jp kr ks kt ku bi translated"><strong class="ak">数据源概述</strong></h2><p id="a5de" class="pw-post-body-paragraph iw ix hi iy b iz kv jb jc jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt hb bi translated">本文中使用的数据是尼日利亚人口与健康调查(DHS)的免费二手数据，名为NDHS 2018。它是在2018年进行的，因此得名。DHS是在发展中国家进行的一项具有全国代表性的调查。本文使用的数据是整个数据集中农村受访者的样本。这个子样本来源于我的文章中进行的预处理— <a class="ae iv" rel="noopener" href="/analytics-vidhya/basic-example-of-a-machine-learning-model-prediction-predicting-modern-contraceptive-use-in-rural-c5e35e8aa877"> <strong class="iy hj">机器学习预测的基本示例</strong> </a></p><p id="539d" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">要从DHS项目中获取任何国家级的免费数据，请访问<a class="ae iv" href="https://dhsprogram.com/data/dataset_admin/login_main.cfm?CFID=6656492&amp;CFTOKEN=ce6ca5b288d60002-2AFF6515-C723-702A-D46EDCBB32A8BDBD" rel="noopener ugc nofollow" target="_blank"> <strong class="iy hj"> DHS项目</strong> </a>，注册并申请。</p><h2 id="bbd6" class="kb kc hi bd iu kd ke kf kg kh ki kj kk jh kl km kn jl ko kp kq jp kr ks kt ku bi translated"><strong class="ak">在不平衡类分布模型上正确应用K-Fold交叉验证的规则</strong></h2><p id="e8ab" class="pw-post-body-paragraph iw ix hi iy b iz kv jb jc jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt hb bi translated">使用k倍交叉验证的经验法则是直接将数据分成10或5倍或组。一般来说，k-fold交叉验证性能评估方法依赖于这样的假设——每个fold数据都是主数据的代表性样本，并反映主数据中目标特征的类别分布。最终，它假设主数据中目标特征的类别分布是50:50。</p><p id="0c34" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">然而，将此规则应用于不平衡分类问题会产生一个分布问题，可能会导致<strong class="iy hj">有偏估计或</strong>过度拟合而有利于多数类。在不平衡类别分布问题中正确使用k-fold交叉验证需要:</p><ol class=""><li id="a325" class="la lb hi iy b iz ja jd je jh lc jl ld jp le jt lf lg lh li bi translated">每个k倍数据被分层以捕捉主数据中目标特征的不平衡类别分布。这可以通过使用<strong class="iy hj">分层k倍交叉验证</strong>来实现；</li><li id="5638" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">在每次交叉验证评估时，只有训练集被过采样(使用合成少数过采样技术或其他类别平衡技术)。这可以通过使用<strong class="iy hj">机器学习流水线</strong>来实现。设置管道有助于防止数据泄漏；</li><li id="3f33" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">在每次交叉验证评估中，测试数据不会被过采样，即不受过采样的影响，尽管它保持了主数据中目标特征的不平衡类别分布；</li><li id="d73e" class="la lb hi iy b iz lj jd lk jh ll jl lm jp ln jt lf lg lh li bi translated">在每次k倍交叉验证评估期间，不会对主数据进行<strong class="iy hj">过采样，而是对训练数据集进行过采样。</strong></li></ol><blockquote class="ju jv jw"><p id="ec5a" class="iw ix jx iy b iz ja jb jc jd je jf jg jy ji jj jk jz jm jn jo ka jq jr js jt hb bi translated">作为一个例子，让我们假设我们正在处理一个避孕药具使用二元分类问题，样本大小为5000个观察值或指数。如果使用避孕药具的比例为10%(样本值为500)，不使用的比例为90%(样本值为4500)；那么我们就会有一个1:9比例不平衡的分类问题。</p></blockquote><p id="d687" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在这种情况下，我们将应用分层k-fold交叉验证，将5000分为10个折叠，每个折叠的样本量为500。</p><p id="dabd" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">分层k-fold交叉验证确保每个fold的样本是随机选择的，没有替换，以反映主要数据中目标特征的1:9比例不平衡分布。</p><p id="8711" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在每个交叉验证评估(其中一组用作测试数据，其余9组用作训练数据，以评估模型的性能)期间，仅训练数据集被过采样。虽然测试数据没有被过采样，但是它保持了主数据中目标特征的继承的1:9不平衡比率分布。</p><p id="0526" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">此外，在每次交叉验证评估时，不会对主数据进行过采样，而是对训练数据集进行过采样。此外，<strong class="iy hj"> </strong>部署流水线以确保仅在对训练数据的每次交叉验证评估期间进行过采样。使用管道有助于防止数据泄漏。</p><h2 id="3838" class="kb kc hi bd iu kd ke kf kg kh ki kj kk jh kl km kn jl ko kp kq jp kr ks kt ku bi translated"><strong class="ak">如何在Python中对不平衡分类问题应用K-Fold交叉验证</strong></h2><p id="041b" class="pw-post-body-paragraph iw ix hi iy b iz kv jb jc jd kw jf jg jh kx jj jk jl ky jn jo jp kz jr js jt hb bi translated">在本节中，我们将对不平衡的二元分类数据进行k重交叉验证评估</p><p id="25c5" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">首先，我们将通过Jupyter notebook将数据导入并加载到python中</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="a2a2" class="kb kc hi lu b fi ly lz l ma mb">path=r'B:\Rural_Nig_data_only.csv'</span><span id="e8ca" class="kb kc hi lu b fi mc lz l ma mb">Rural_data_only=pd.read_csv(path)</span></pre><p id="78e8" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">数据的样本大小为24，837，总列数为35。</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="cbe5" class="kb kc hi lu b fi ly lz l ma mb">Rural_data_only.shape</span></pre><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es md"><img src="../Images/14989cc968fe53805db612809e16d445.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*VOdDOqkED4WcuUAuWiCjuQ.png"/></div></figure><p id="904d" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">“v313 _使用现代方法”是该数据集的目标功能。这一特征表明了被调查者使用现代避孕药具的状况</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="1cf1" class="kb kc hi lu b fi ly lz l ma mb">Rural_data_only.info()</span></pre><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es me"><img src="../Images/30a5c2b2c3e0224e7488b4b4208f1d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*lh_Mq7uMcHSs5g6MM3nHGw.png"/></div></figure><p id="338a" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">“v313 _使用现代方法”有2个响应类别，即—“目前使用现代避孕方法”，表示为1；和“目前没有使用现代避孕药”，表示为0。“使用现代方法”的v313有一个不平衡分类，如下所示:</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="dd30" class="kb kc hi lu b fi ly lz l ma mb">Rural_data_only['v313_Using modern method'].value_counts()</span><span id="7546" class="kb kc hi lu b fi mc lz l ma mb">Rural_data_only['v313_Using modern method'].value_counts(normalize=True) * 100</span></pre><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es mf"><img src="../Images/c69635f56da0fb5d9410070a59e103c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*XRzWqB5Q41h8aYrCVJYfDg.png"/></div></figure><p id="444f" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们定义数据集并选择X(预测要素)和y(目标要素)</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="a05b" class="kb kc hi lu b fi ly lz l ma mb"># define dataset<br/>array=Rural_data_only.values</span><span id="b34d" class="kb kc hi lu b fi mc lz l ma mb">#select the X, and y <br/>X=array[:,0:34]  <br/>y=array[:,34]</span></pre><p id="59e8" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">接下来，我们将在每个交叉验证评估过程中定义一个管道来设置训练数据的过采样(使用SMOTE)。</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="8ebc" class="kb kc hi lu b fi ly lz l ma mb">steps = [('over', SMOTE()), ('model', LogisticRegression())]<br/>pipeline = Pipeline(steps=steps)</span></pre><p id="e4f2" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">然后我们将使用分层的k-fold交叉验证将我们的主要数据分成具有代表性的10个折叠。分层k-fold交叉验证确保每一个fold中的训练和测试数据反映了目标特征在主数据中的不平衡分布。回想一下，在每次交叉验证评估中，将仅对训练数据组进行过采样，而不对测试数据进行过采样。</p><p id="f1bf" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们将使用管道和分层k-fold交叉验证在不平衡数据集上评估逻辑模型的性能，如下所示:</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="a46e" class="kb kc hi lu b fi ly lz l ma mb"># evaluate pipeline<br/>for scoring in["accuracy", "roc_auc"]:<br/>    cv = RepeatedStratifiedKFold(n_splits=10, n_repeats=3, random_state=0)<br/>    scores = cross_val_score(pipeline, X, y, scoring=scoring, cv=cv, n_jobs=-1)<br/>    print("Model", scoring, " mean=", scores.mean() , "stddev=", scores.std())</span></pre><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/dbce9753a4bd30f59dccaff8aa98690e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*84cQzLYG6gQUmAp55jOs_Q.png"/></div></div></figure><p id="8ed6" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">根据以上所述，逻辑模型的估计平均准确度值为84%±0.7，并且在控制分类的不平衡特征时，受试者操作特征曲线下的面积(ROC_AUC)具有77±1.1的估计平均值。</p><p id="b0ab" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">用于此分析的Jupyter笔记本可从<a class="ae iv" href="https://github.com/ayobamiakiode/My-projects/blob/master/k_fold_CV_imbalance_class.ipynb" rel="noopener ugc nofollow" target="_blank"> <strong class="iy hj">此处</strong> </a>获得</p><p id="9df2" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="iy hj">这就对了。</strong>希望你觉得这有用？请放下您的评论，在LinkedIn上关注我，地址为<a class="ae iv" href="https://www.linkedin.com/in/ayobami-akiode-38528839/" rel="noopener ugc nofollow" target="_blank"> Ayobami Akiode LinkedIn </a></p><p id="b70b" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="iy hj">参考文献</strong></p><div class="mh mi ez fb mj mk"><a href="https://machinelearningmastery.com/smote-oversampling-for-imbalanced-classification/" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">使用Python实现不平衡分类的SMOTE机器学习掌握</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">不平衡分类涉及在具有严重类别的分类数据集上开发预测模型…</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">machinelearningmastery.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my io mk"/></div></div></a></div><p id="5f41" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><a class="ae iv" href="#stratified-k-fold" rel="noopener ugc nofollow">https://sci kit-learn . org/0.15/modules/cross _ validation . html # layered-k-fold</a></p><p id="7e97" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><a class="ae iv" href="https://www.bmc.com/blogs/create-machine-learning-pipeline/" rel="noopener ugc nofollow" target="_blank">https://www.bmc.com/blogs/create-machine-learning-pipeline/</a></p><p id="1f3a" class="pw-post-body-paragraph iw ix hi iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><a class="ae iv" href="https://machinelearningmastery.com/cross-validation-for-imbalanced-classification/" rel="noopener ugc nofollow" target="_blank">https://machine learning mastery . com/cross-validation-for-unbalanced-class ification/</a></p></div></div>    
</body>
</html>