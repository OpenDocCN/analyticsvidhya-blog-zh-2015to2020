<html>
<head>
<title>CI/CD to Lambda Function using AWS Code Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS代码管道将CI/CD转换为Lambda函数</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/ci-cd-to-lambda-function-using-aws-code-pipeline-87b8098c1a8c?source=collection_archive---------12-----------------------#2020-02-27">https://medium.com/analytics-vidhya/ci-cd-to-lambda-function-using-aws-code-pipeline-87b8098c1a8c?source=collection_archive---------12-----------------------#2020-02-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e23c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，我将为您提供一个快速指南，告诉您如何建立一个自动化的部署管道，将Lambda映射的不同别名的更改推送到不同的开发阶段。</p><p id="3add" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">先决条件</strong>:我们将用于部署的lambda函数和API网关，将不同的阶段映射到Lambda函数的不同别名。</p><p id="1801" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用的组件:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/8b847e7b061d4c91c4ad766249609401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*oFuJ5EHXQmQX4cPZ4hIZsg.png"/></div></figure><ol class=""><li id="2038" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated"><strong class="ih hj">代码提交</strong> —触发源(branch — dev，uat，prod)，包含代码构建所需的构建文件。</li><li id="7b73" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><strong class="ih hj">代码构建</strong> —运行<strong class="ih hj"> buildspec.yml </strong>文件中的指令，创建lambda部署包并更新Lambda代码，发布新版本，然后更新指向该版本的Alias。我们在不同的开发阶段使用不同的别名(开发、用户验收测试、生产)</li><li id="52cb" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><strong class="ih hj"> AWS Lambda </strong> —用于部署的Lambda功能。</li><li id="1d1f" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><strong class="ih hj">代码管道</strong> —将1、2、3打包在一起。</li><li id="aa6d" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><strong class="ih hj"> API网关</strong> —我们lambda函数的接口。API gateway中的不同阶段(dev、uat、prod)指向我们的Lambda函数的不同别名。</li></ol><p id="3554" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们为每个阶段(开发、用户验收测试、生产)创建不同的管道。管道的来源是代码提交存储库，分支指向包含该阶段代码的存储库。</p><p id="b5fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们使用standard:2.0 Linux环境添加代码构建模块。我们还在这里添加了STAGE环境变量，并提供了构建YAML文件的参考路径。这里最重要的组件是构建文件"<strong class="ih hj"> buildspec.yml" </strong>，该文件包含代码构建环境运行的所有指令。在我们的示例中，它包含以下指令…</p><ol class=""><li id="01bc" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">安装应用程序所需的依赖项。</li></ol><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="a660" class="ke kf hi ka b fi kg kh l ki kj">python3 -m pip install --target ./package -r requirements.txt</span></pre><p id="6a3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.打包源代码和依赖项，并创建Lambda部署包。</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="9352" class="ke kf hi ka b fi kg kh l ki kj">zip -r9 function.zip package api</span></pre><p id="56a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.更新lambda函数代码。该命令为每次更新返回一个唯一的哈希代码，该哈希代码在创建新版本时使用。这里<strong class="ih hj"> my_lambda_function </strong>是部署的lambda函数的名称。</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="4e93" class="ke kf hi ka b fi kg kh l ki kj">CODE_SHA_256=$(aws lambda update-function-code --function-name my_lambda_function --zip-file fileb://function.zip --query CodeSha256 --output text)</span></pre><p id="a544" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击阅读更多关于AWS lambda命令行选项的信息:</p><p id="27b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.发布新版本。传递更新的哈希代码，以验证自我们更新以来代码没有发生更改。如果最新的发布代码与我们推送的不同，这将引发一个错误，构建将会失败。</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="82f8" class="ke kf hi ka b fi kg kh l ki kj">FUNCTION_VERSION=$(aws lambda publish-version --function-name my_lambda_function --code-sha256 $CODE_SHA_256 --query Version --output text)</span></pre><p id="063f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.用版本更新阶段别名。将<strong class="ih hj">阶段变量设置为代码构建环境变量</strong>，并引用我们要更新的别名。</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="f32f" class="ke kf hi ka b fi kg kh l ki kj">RESPONSE=$(aws lambda update-alias --function-name my_lambda_function --name $STAGE --function-version $FUNCTION_VERSION --output text)</span></pre><p id="aec0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是完整的代码:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kl km l"/></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">buildspec.yml</figcaption></figure><p id="3aad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS lambda命令行返回多个参数。我们通过使用<strong class="ih hj">查询</strong>参数过滤结果，它只返回我们感兴趣的参数。此外，AWS命令行工具通常以字典的形式返回结果，我们通过在命令行中设置<strong class="ih hj">输出</strong>标志来更改它，对于我们的例子，我们希望它是文本格式的，这在后续指令中易于处理和使用。</p><p id="c0a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，通过将提交推送到分支来触发管道。</p><p id="1d58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们没有在管道中使用单独的部署模块，因为这只是在构建阶段使用AWS命令行完成的。</p></div></div>    
</body>
</html>