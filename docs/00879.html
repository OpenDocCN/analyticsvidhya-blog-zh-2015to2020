<html>
<head>
<title>Delivering ML Models to the Business SOA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向业务SOA交付ML模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/delivering-ml-models-to-the-business-soa-47ee326674ec?source=collection_archive---------10-----------------------#2019-09-15">https://medium.com/analytics-vidhya/delivering-ml-models-to-the-business-soa-47ee326674ec?source=collection_archive---------10-----------------------#2019-09-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0d10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为你公司的机器学习工程师，你刚刚“烘焙”了你的机器学习预测模型，那么，现在呢？为了让你的公司从模型中获益，你需要交付它。我将通过一家科技公司的实际用例来展示如何做到这一点，该公司使用基于<a class="ae jd" href="https://microservices.io/" rel="noopener ugc nofollow" target="_blank">微服务</a>的<a class="ae jd" href="https://en.wikipedia.org/wiki/Service-oriented_architecture" rel="noopener ugc nofollow" target="_blank">面向服务架构</a>，并使用Python作为编程语言。</p><h1 id="4f2d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">关于模型</h1><p id="b1d8" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于那些不熟悉ML的人来说，预测模型是一个可以将输入X映射到预测输出Y的函数，如将图像映射为输入，将标记为猫或不猫作为输出(分类)，或将房子的一些特征(m、位置……)映射到预测价格(回归)。</p><p id="ccb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于我们的实际用例，假设我们是一家房地产代理机构，为了示例的目的，我们将只关注房屋租赁。我们的机构需要一种方法来预测基于某些特征的房价，如m，因为有些房子不是由评估师定价的。为了预测价格，我们将使用一个最简单的预测模型，即<a class="ae jd" href="https://en.wikipedia.org/wiki/Linear_regression" rel="noopener ugc nofollow" target="_blank">线性回归</a>。</p><h1 id="5fd2" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">架构概述</h1><p id="791a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">微服务架构的一个基本规则是用一个应用程序来管理一个业务单元，就像我们机构的房屋。大多数关于如何将ML模型部署到生产的教程都将模型映射到web服务中，但请注意，模型本身并不是一个业务单位，它更像是houses microservice用来预测无价格房屋的工具。</p><p id="6d07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为基本功能创建单一服务是一种微服务反模式，称为nanoservice。为了避免这种情况，我们可以将我们的模型作为一个库来分发，houses microservice将把它定义为一个依赖项。请注意，这种方法有一个缺点—如果您的微服务架构非常异构，并且您有很多编程语言，您的库可能不兼容，因此您仍然需要使用web服务作为公共集成接口。在这种情况下，我建议将您的模型作为一个库进行分发，并在一个单独的项目中创建web服务，然后将您的库设置为一个依赖项。这种方法尊重<a class="ae jd" href="https://12factor.net/" rel="noopener ugc nofollow" target="_blank"> 12factor </a>应用程序，将界面与功能分离将允许您为您的模型创建不同的界面，如CLI或桌面GUI。</p><p id="8c8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我将向您展示两种方法，直接集成到python houses微服务中，并创建一个web服务作为公共接口，让您的不同微服务使用该模型。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/392cc064098a8e33565213ef68c20c4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*pZbi_aa9nr-rWlIUzeCZsg.jpeg"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">通过独立的web服务连接ML模型。</figcaption></figure><h1 id="6205" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">构建模型</h1><p id="1f73" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于Python软件开发，我喜欢PyCharm作为IDE，但是对于数据来说，<a class="ae jd" href="https://jupyterlab.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> JupyterLab </a>是一个好得多的IDE，它的接口在你的浏览器中运行，而内核(解释器)在主机中。您可以在单独的单元格中创建代码块，这样您就可以预处理一些需要花费大量时间的数据，然后在下一个单元格中处理这些数据，而不会在执行之间丢失它们。</p><p id="6b31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">JupyterLab的问题是，它使用ipynb格式，你的库需要用py源代码来构建，而且版本化笔记本可能真的很难，因为它的格式。为了解决这个问题，我推荐<a class="ae jd" href="https://github.com/mwouts/jupytext#jupytext-commands-in-jupyterlab" rel="noopener ugc nofollow" target="_blank"> Jupytext </a>扩展，它可以将你的笔记本同步到多种格式，包括py源。您需要从<a class="ae jd" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> NodeJS </a>安装第一个节点和npm包来管理JupyterLab扩展。我还推荐使用<a class="ae jd" href="https://docs.pipenv.org/en/latest/" rel="noopener ugc nofollow" target="_blank"> pipenv </a>进行包含依赖锁的项目开发。</p><p id="fe12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">聊够了，让我们建立我们的线性回归模型吧！</p><p id="7bf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要数据来训练，所以我从我的城市(巴塞罗那)拿了几个房屋租赁的例子，然后从原始的数据中合成了更多的数据。有了熊猫图书馆，我们可以轻松地保存/加载csv或excel文件和管理数据。一旦我们有了数据，我们应该把它分成80%的训练和20%的测试。然后，训练模型，测试，保存。出于示例的目的，我们将只使用m作为输入特征。</p><p id="e4af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">培训:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="43aa" class="ky jf hi ku b fi kz la l lb lc">class HouseRentModelBuilder(object):<br/>    ''' House rent model builder '''<br/>    <br/>    def __init__(self, rentals_dataset=None):<br/>        ''' Model constructor '''<br/>        self.model = linear_model.LinearRegression()<br/>        self.rentals_dataset = rentals_dataset<br/>    <br/>    def train(self):<br/>        ''' Use the dataset to train the model '''<br/>        m2_X_train, price_Y_train = self.rentals_dataset.train_sample()<br/>        self.model.fit(m2_X_train, price_Y_train)</span></pre><p id="4d48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用scikit-learn库，训练代码就是这么简单！</p><p id="d5b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦模型被训练，我们就可以用它来进行预测。我为模型用法创建了一个facade类，其中包含预测、加载和保存模型的方法:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="6add" class="ky jf hi ku b fi kz la l lb lc">class HouseRentModel(object):<br/>    ''' House rent model with price predictions '''<br/>    <br/>    MODEL_FILE = 'model.pkl'<br/>    <br/>    def __init__(self, model):<br/>        ''' Model constructor '''<br/>        self.model = model<br/>    <br/>    def predict(self, m2):<br/>        ''' Accepts a scalar or list of values, then returns the predicted value/s '''<br/>        m2_type = type(m2)<br/>        if m2_type == int or m2_type == float:<br/>            m2_values = np.array([[m2]])<br/>        elif m2_type == list or m2_type == tuple:<br/>            m2_values = np.array([m2]).T<br/>        elif m2_type == np.array:<br/>            pass<br/>        else:<br/>            raise ValueError(f'Unexpected type {m2_type}, expected int/float as scalar or list/tuple of scalars')<br/>        return self.model.predict(m2_values).astype(int)<br/>    <br/>    def save_model(self):<br/>        ''' Saves the model into file '''<br/>        module_path = os.path.dirname(os.path.abspath(__file__))<br/>        model_file = os.path.join(module_path, self.MODEL_FILE)<br/>        with open(model_file,'wb') as model_file:<br/>            pickle.dump(self.model, model_file)<br/>    <br/>    def load_model(self):<br/>        ''' Loads the model from file '''<br/>        module_path = os.path.dirname(os.path.abspath(__file__))<br/>        model_file = os.path.join(module_path, self.MODEL_FILE)<br/>        with open(model_file,'rb') as model_file:<br/>            self.model = pickle.load(model_file)</span></pre><p id="6c88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，要保存scikit-learn模型，您可以使用内置的pickle库将其序列化为一个文件，我们将<a class="ae jd" href="https://packaging.python.org/tutorials/packaging-projects/" rel="noopener ugc nofollow" target="_blank">打包该文件并随源代码一起分发</a>，因此导入我们模型的其他项目只需加载它，而无需再次训练它。</p><p id="65e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看<a class="ae jd" href="https://gitlab.com/ml-house-rent/housemodel/tree/master" rel="noopener ugc nofollow" target="_blank">项目</a>以了解更多信息。</p><h1 id="baaa" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">案例1:将库直接导入微服务</h1><p id="7bb3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">首先，你需要<a class="ae jd" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> docker </a>和<a class="ae jd" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> docker-compose </a>来运行一切。</p><p id="45d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这个例子，我用Flask微框架和一些库创建了一个RESTful微服务。Connexion library使用API first方法开发微服务，这意味着在编写API本身之前，以OpenAPI 3格式设计和记录REST接口。此外，elasticsearch-dsl作为业务模型持久性的“ORM”。这个API的目的是对房屋执行CRUD操作，并在没有提供价格时预测价格。</p><p id="40f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以使用以下命令从PyPI存储库或直接从git存储库安装我们的模型库:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="f4a0" class="ky jf hi ku b fi kz la l lb lc">pipenv install git+<a class="ae jd" href="https://gitlab.com/ml-house-rent/housemodel@1.0.0#egg=housemodel" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/ml-house-rent/housemodel@1.0.0#egg=housemodel</a></span></pre><p id="f18a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们将在管理房屋模型时包括此功能:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="78a8" class="ky jf hi ku b fi kz la l lb lc">from ml.house import predictive_model</span><span id="f763" class="ky jf hi ku b fi ld la l lb lc">class HouseService(object):<br/>    def get_house(self) -&gt; object:<br/>        return HouseFactory.create()<br/><br/>    def fill_house(self, payload):<br/>        house = self.get_house()<br/>        if 'price' not in payload:<br/>            # Predict price if not provided<br/>            price = predictive_model.predict(payload['m2'])[0]<br/>            predicted = True<br/>        else:<br/>            price = payload['price']<br/>            predicted = False<br/>        filled_house = house(<br/>            uuid=payload['uuid'],<br/>            m2=payload['m2'],<br/>            rooms=payload['rooms'],<br/>            location=payload['location'],<br/>            zipcode=payload['zipcode'],<br/>            price=price,<br/>            predicted=predicted<br/>        )<br/>        return filled_house</span></pre><p id="f3a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">predictive_model对象只是一个从模块中导入的对象，该模块只是为我们加载它:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="808e" class="ky jf hi ku b fi kz la l lb lc">from housemodel.model import HouseRentModelBuilder<br/><br/>predictive_model = HouseRentModelBuilder().get_model()<br/>predictive_model.load_model()</span></pre><p id="bfc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看一下<a class="ae jd" href="https://gitlab.com/ml-house-rent/house-rentals/tree/master" rel="noopener ugc nofollow" target="_blank">项目</a>，了解关于构建微服务的更多信息。</p><h1 id="d3cb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">案例2:创建独立的web服务</h1><p id="4521" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果您的houses微服务是X语言的，并且您不能导入您的模型库，您可以在web服务接口中映射它的功能。这一次，我们将制作一个香草烧瓶应用程序。</p><p id="fc8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">同样，我们将首先实例化我们的模型对象:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="2c9c" class="ky jf hi ku b fi kz la l lb lc">from housemodel.model import HouseRentModelBuilder<br/><br/>model = HouseRentModelBuilder().get_model()<br/>model.load_model()</span></pre><p id="9a82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，这就是将它映射到一个简单的web服务所需的所有代码:</p><pre class="ki kj kk kl fd kt ku kv kw aw kx bi"><span id="a3ca" class="ky jf hi ku b fi kz la l lb lc">from flask import Flask, request, jsonify<br/>from housemodel_service import model<br/><br/><br/>app = Flask(__name__)<br/><br/>@app.route('/')<br/>def url_doc():<br/>    urls = {'predict': '/predict'}<br/>    response = jsonify(urls)<br/>    response.status_code = 200<br/>    return response<br/><br/>@app.route('/predict')<br/>def hello_world():<br/>    m2_list = request.args.get('m2')<br/>    if not m2_list:<br/>        err = {'error': 'Need the m2 parameter'}<br/>        response = jsonify(err)<br/>        response.status_code = 400<br/>        return response<br/>    m2_list = m2_list.split(',')<br/>    try:<br/>        m2_list = list(map(int, m2_list))<br/>    except ValueError as e:<br/>        err = {'error': 'Some value is not an integer'}<br/>        print(e)<br/>        response = jsonify(err)<br/>        response.status_code = 400<br/>        return response<br/>    predictions = model.predict(m2_list)<br/>    results = {}<br/>    i = 0<br/>    for m2 in m2_list:<br/>        results[m2] = int(predictions[i])<br/>        i += 1<br/>    response = jsonify(results)<br/>    response.status_code = 200<br/>    return response<br/><br/><br/>if __name__ == '__main__':<br/>    # WARNING: Only for development!<br/>    app.run(port=8080)</span></pre><p id="530e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">见<a class="ae jd" href="https://gitlab.com/ml-house-rent/housemodel-service/tree/master" rel="noopener ugc nofollow" target="_blank">项目</a>文档获取并测试。</p><h1 id="53ed" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">结论</h1><p id="021b" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">将我们的模型作为一个库发布，将它的生命周期从微服务中分离出来，并将其集成到不同的接口中，如web服务或GUI。保存/加载一个模块就是序列化/反序列化它。保持模型所需的最少信息是线性回归中的学习参数、线性函数的系数，但请注意，使用scikit-learn和pickle这样的高级库，我们可以从中抽象出我们。</p></div></div>    
</body>
</html>