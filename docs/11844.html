<html>
<head>
<title>Excluding values in multi-column mean calculations in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">排除R中多列平均值计算中的值</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/excluding-values-in-multi-column-mean-calculations-in-r-7776c2588414?source=collection_archive---------28-----------------------#2020-12-20">https://medium.com/analytics-vidhya/excluding-values-in-multi-column-mean-calculations-in-r-7776c2588414?source=collection_archive---------28-----------------------#2020-12-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4b1b13d3885d3a27d60d10470aa94f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OeiKgPBgM_CYEiCb.jpg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">只是另一个争论数据的帖子</figcaption></figure><h1 id="b9f8" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">任务</h1><p id="40ac" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我有每人一行的数据，其中人们报告了他们在特定时间段内的饮酒量。这些列是不同的时间段，但参与者也可以提供其他不同编码的答案:</p><ul class=""><li id="6c0d" class="kq kr hi ju b jv ks jz kt kd ku kh kv kl kw kp kx ky kz la bi translated">意味着他们根本不喝酒</li><li id="631d" class="kq kr hi ju b jv lf jz lg kd lh kh li kl lj kp kx ky kz la bi translated"><code class="du lb lc ld le b">0</code>表示他们当时没有饮料</li><li id="ead3" class="kq kr hi ju b jv lf jz lg kd lh kh li kl lj kp kx ky kz la bi translated"><code class="du lb lc ld le b">-999</code>指的是他们在那个时间段确实喝了酒，但他们不记得喝了多少。</li></ul><p id="2f57" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">有趣的部分来了。我们想估算出<code class="du lb lc ld le b">-999</code>的典型个人均值。在实践中，这意味着如果一个人报告他们在时间段内喝了酒，但不记得喝了多少，我们建议他们喝任何对他们来说典型的酒。</p><p id="11a7" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">然而，我们想要估算的平均值需要排除<code class="du lb lc ld le b">-999</code>、<code class="du lb lc ld le b">0</code>和<code class="du lb lc ld le b">NA</code>。</p><h1 id="f659" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">图书馆</h1><p id="1032" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我将使用下面的库来完成这个任务。</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="6734" class="lv iv hi le b fi lw lx l ly lz"># Read in the .csv file <br/>library(readr) <br/># Chains using the pipe <br/>library(dplyr) <br/># Other functions <br/>library(purrr)</span></pre><h1 id="8116" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">数据</h1><p id="061a" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我完成这个任务所用的数据最初有<code class="du lb lc ld le b">2,348</code>个变量和大约<code class="du lb lc ld le b">500</code>个观测值。因为原始数据是保密的，所以我创建了这个数据的假版本。这个假数据被储存在<a class="ae ma" href="https://github.com/lsouthard/Excluding-values-in-multiple-column-mean-calculations/blob/main/fakedata.csv" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="66db" class="lv iv hi le b fi lw lx l ly lz">#Read in the data<br/>fd.df &lt;- read.csv("fakedata.csv", header = T, sep = ",", <br/>                  na.strings = "NA")</span><span id="5223" class="lv iv hi le b fi mb lx l ly lz">#preview the data<br/>head(fd.df)</span></pre><p id="9229" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">确保您的数据确实是1行/人总是一个好主意。我通过<code class="du lb lc ld le b">ResponseID</code>检查了重复项，以确保:</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="88ae" class="lv iv hi le b fi lw lx l ly lz">fd.df$ResponseId[duplicated(fd.df$ResponseId)]</span></pre><figure class="ln lo lp lq fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/a650853778c4fdbff3dbe12225b3aa54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*ZGhTvHaV361t3HBRfLBm-A.png"/></div></figure><p id="97d0" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated"><code class="du lb lc ld le b">character(0)</code>已返回，因此没有重复项。</p><h1 id="0824" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">该功能</h1><p id="07ed" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我将创建一个执行以下操作的函数:对于数据帧中右索引<code class="du lb lc ld le b">fd.df[2:121]</code>内的所有列，按行取平均值，只要它大于<code class="du lb lc ld le b">0</code>而不是<code class="du lb lc ld le b">NA</code>。为此，我们首先需要确保所有内容都以数字形式读入。这在从<code class="du lb lc ld le b">mutate_at()</code>开始的第二行中完成。这里，所有应该以这种方式计算的列(索引<code class="du lb lc ld le b">[2:121]</code>)也以“AD”开始。因此，我提取所有以“AD”开头的列，并使它们成为数字(<code class="du lb lc ld le b">as.numeric()</code>)，让它识别任何<code class="du lb lc ld le b">NA</code>值都是实数(<code class="du lb lc ld le b">na.rm = T</code>)。我使用了<code class="du lb lc ld le b">starts_with()</code>来展示不同的功能。</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="e945" class="lv iv hi le b fi lw lx l ly lz">final.df &lt;- fd.df %&gt;% <br/>   mutate_at(vars(starts_with("AD")), as.numeric, na.rm = T) %&gt;%<br/>   mutate(avg = apply(.[2:121],1, function(.) mean(.[.&gt;0], <br/>                      na.rm =T)))</span></pre><p id="e32e" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">对于以<code class="du lb lc ld le b">mutate()</code>开始的第三行代码:<code class="du lb lc ld le b">(.)</code>指的是整个数据帧，但是我在这里指定了我希望函数应用的索引:<code class="du lb lc ld le b">(.[2,121]</code>如果数据帧中有其他数据，比如ID号，这是必需的。<code class="du lb lc ld le b">1</code>指的是行方向。如果这是我的目标的话，我可以在列上加上一个<code class="du lb lc ld le b">2</code>。这是使用<code class="du lb lc ld le b">group_by(ResponseID)</code>的一种优雅的替代方式，也是一种选择。</p><p id="c682" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">接下来，我告诉<code class="du lb lc ld le b">apply()</code>我想(应用)使用一个函数，只要数据帧中的值大于0，这个函数就是数据帧<code class="du lb lc ld le b">(.)</code>的<code class="du lb lc ld le b">mean()</code>，我想保留我的<code class="du lb lc ld le b">NA</code>值(<code class="du lb lc ld le b">(.[.&gt;0], na.rm =T </code>)。使用任何大于0的值也将排除我的<code class="du lb lc ld le b">-999</code>,我想以后估算。</p><h1 id="5a00" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">估算平均值</h1><p id="d74d" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我将把这行代码添加到上面的代码:<code class="du lb lc ld le b"> mutate_at(vars(starts_with("AD")), ~if_else(. == -999, avg, .))</code>中，它将显示为:</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="7add" class="lv iv hi le b fi lw lx l ly lz">final.df &lt;- fd.df %&gt;% <br/>   mutate_at(vars(starts_with("AD")), as.numeric, na.rm = T) %&gt;% <br/>   mutate(avg = apply(.[2:121],1, function(.) mean(.[.&gt;0], <br/>                      na.rm =T)))%&gt;% <br/>mutate_at(vars(starts_with("AD")), ~if_else(. == -999, avg, .))</span></pre><h2 id="620a" class="lv iv hi bd iw md me mf ja mg mh mi je kd mj mk ji kh ml mm jm kl mn mo jq mp bi translated">我们来分析一下。</h2><ul class=""><li id="02d6" class="kq kr hi ju b jv jw jz ka kd mq kh mr kl ms kp kx ky kz la bi translated">我们正在用<code class="du lb lc ld le b">mutate_at()</code>做同样的事情，只是为了展示功能。你也可以用索引来做这件事。</li><li id="40a1" class="kq kr hi ju b jv lf jz lg kd lh kh li kl lj kp kx ky kz la bi translated">我之所以保存了一个名为<code class="du lb lc ld le b">avg</code>的列，是因为我可以检查以确保接下来一切正常。</li><li id="4e92" class="kq kr hi ju b jv lf jz lg kd lh kh li kl lj kp kx ky kz la bi translated">现在，我的第四行代码如下所示:对于所有以“AD”开头的列(也称为index 2，121)，将下面的<code class="du lb lc ld le b">if_else()</code>语句应用于整个dataframe(用<code class="du lb lc ld le b">~</code>表示)。</li><li id="3e8e" class="kq kr hi ju b jv lf jz lg kd lh kh li kl lj kp kx ky kz la bi translated"><code class="du lb lc ld le b">if_else()</code>语句如下:如果数据帧中的任何地方(由<code class="du lb lc ld le b">(.)</code>表示)也等于<code class="du lb lc ld le b">-999</code>，则替换为<code class="du lb lc ld le b">avg</code>。如果不是，保持不变(再次用<code class="du lb lc ld le b">(.)</code>表示)。</li></ul><p id="ecce" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">输出将成功地保留所有其他数据(如ID、人口统计、联系信息等)，并且只处理<code class="du lb lc ld le b">starts_with()</code>中指定的列和/或您给出的索引。</p><h1 id="8503" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">检查它是否工作</h1><p id="14a5" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">在我的所有代码中，我总是鼓励检查以确保你的函数/代码按照你期望的方式工作。在这个例子中，我最初使用的是<code class="du lb lc ld le b">rowMeans()</code>，它没有忽略小于0的值。如果我放弃这次数据检查，我就不会发现这一点。</p><p id="4624" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">对于这个检查，我想要一个我以前知道值为<code class="du lb lc ld le b">-999</code>的列。我知道使用以下代码选择列<code class="du lb lc ld le b">AD1B3</code>:</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="2bea" class="lv iv hi le b fi lw lx l ly lz">check.df &lt;- fd.df %&gt;% <br/>   mutate_at(vars(starts_with("AD")), as.numeric, na.rm = T) %&gt;% <br/>   mutate(avg = apply(.[2:121],1, function(.) mean(.[.&gt;0], <br/>                      na.rm =T))) %&gt;% <br/>   select(2:121, avg) %&gt;% <br/>   select_if(~min(., na.rm = TRUE) &lt; 0)</span></pre><p id="15f3" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">当我运行这个代码时，第一行有<code class="du lb lc ld le b">-999</code>和其他值，这很好。否则，我可能需要想出一个更好的方法来检查我到底想要什么(欢迎建议)。</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/0503d862d6731b7c89e3f942f78eb4e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S1aouv72wuw3mMCF66zYCw.png"/></div></div></figure><p id="c5b6" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">如果我在第1行的<code class="du lb lc ld le b">check.df</code>上运行相同的代码，使用<code class="du lb lc ld le b">slice(1)</code>和<code class="du lb lc ld le b">select_if</code>删除值为<code class="du lb lc ld le b">0</code>或<code class="du lb lc ld le b">NA</code>的所有列(因为这两个值都不应该计入我的平均值)，我可以计算出<code class="du lb lc ld le b">avg</code>列应该是什么:</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="8b03" class="lv iv hi le b fi lw lx l ly lz">check.df &lt;- fd.df %&gt;% <br/>   mutate_at(vars(starts_with("AD")), as.numeric, na.rm = T) %&gt;% <br/>   mutate(avg = apply(.[2:121],1, function(.) mean(.[.&gt;0], <br/>                      na.rm =T))) %&gt;% <br/>   select(2:121, avg) %&gt;% <br/>   slice(1) %&gt;% <br/>   select_if(~max(., na.rm = TRUE) &gt; 0)</span></pre><figure class="ln lo lp lq fd ij er es paragraph-image"><div class="er es mu"><img src="../Images/265b6a95bb8f0a379c0eb850471ed376.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*FSXMSXixpx9dMzCv8O5faA.png"/></div></figure><p id="3552" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">现在，我可以看到3.5是正确的平均值。</p><p id="50ce" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">我已经将我处理过的数据保存到一个名为<code class="du lb lc ld le b">final.df</code>的数据帧中。首先，我检查了一下，以确保means的<code class="du lb lc ld le b">apply()</code>函数实际上排除了我希望它排除的所有值。</p><pre class="ln lo lp lq fd lr le ls lt aw lu bi"><span id="cbda" class="lv iv hi le b fi lw lx l ly lz">final.df %&gt;% <br/>   select(2:121, avg) %&gt;% <br/>   slice(1) %&gt;% <br/>   select_if(~max(., na.rm = TRUE) &gt; 0)</span></pre><p id="a88e" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">这是将要打印的内容:</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/391f3f80022c6b8ea543fc46179f7bc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NSPSw8Fqqyrs_UyLoE9KPg.png"/></div></div></figure><p id="7a4b" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">我从我的<code class="du lb lc ld le b">check.df</code>数据帧中知道<code class="du lb lc ld le b">AD1B3</code>是<code class="du lb lc ld le b">-999</code>，现在被替换为<code class="du lb lc ld le b">avg</code>中的值。一切看起来都很好！</p><p id="b1e5" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated">我真的希望我的apply函数在<code class="du lb lc ld le b">if_else()</code>语句中工作，这样一旦我知道它工作了，我就可以运行它而不保存<code class="du lb lc ld le b">avg</code>列。此外，我是第一次使用<code class="du lb lc ld le b">apply()</code>功能，所以任何优化它的方法都是受欢迎的。</p></div><div class="ab cl mw mx gp my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hb hc hd he hf"><p id="12ae" class="pw-post-body-paragraph js jt hi ju b jv ks jx jy jz kt kb kc kd lk kf kg kh ll kj kk kl lm kn ko kp hb bi translated"><em class="nd">原载于https://github.com</em><a class="ae ma" href="https://github.com/lsouthard/Excluding-values-in-multiple-column-mean-calculations/blob/main/README.md" rel="noopener ugc nofollow" target="_blank"><em class="nd"/></a><em class="nd">。</em></p></div></div>    
</body>
</html>