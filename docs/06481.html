<html>
<head>
<title>How using a “Code Profiler” can be a Powerful Skill!!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用“代码分析器”是多么强大的技能啊！！</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-using-a-python-code-profiler-will-change-your-life-feac074671d0?source=collection_archive---------36-----------------------#2020-05-23">https://medium.com/analytics-vidhya/how-using-a-python-code-profiler-will-change-your-life-feac074671d0?source=collection_archive---------36-----------------------#2020-05-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d36b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对我来说幸运的是，在作为计算机科学专业人员开始工作的前几周，我有机会与一位非常资深的开发人员坐在一起，探讨如何调试某个应用程序的性能问题，在那里我目睹了“魔术”——代码剖析的简单技巧。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/b9673d6916240cdd85251a07ced1ee94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NBk0kNlV6KikV_x2ANxw9A.jpeg"/></div></div></figure><h1 id="5925" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">使用代码分析器的基本原理</strong></h1><blockquote class="kn ko kp"><p id="c418" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated">“过早的<strong class="ih hj">优化</strong>是万恶之源”</p></blockquote><p id="451d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">软件行业的每个人(希望)都知道Donald Knuth的这句话。这只是总结了为什么单纯的启发和直觉不应该强迫进行大量的优化迭代，也就是说，即使在调查原因之前也不要进行重构，一些看起来非常琐碎的事情可能会损害性能，反之亦然。</p><p id="8b19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一件非常明显和琐碎的事情，大多数人实际上都意识到了这一点，但是由于我们在如何优化代码、寻找一些我们认为有问题的东西时存在一些固有的偏见，我们没有利用工具来提供更清晰的画面，一些小问题只是在雷达下滑动。</p><h1 id="aca0" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">何时进行优化</strong>——需要记住的事情</h1><ol class=""><li id="d288" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">预感—“<strong class="ih hj"><em class="kq">这可能会更快</em> </strong>”，当你有这种感觉，资源可能会被不必要的浪费，使用一个分析器来找出。</li><li id="e09e" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">在你想要花多少时间写/重复一段代码和你想要它有多高的性能之间的权衡。</li><li id="180c" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">对于小脚本来说，这可能非常方便，有时我们在开发脚本来完成一些琐碎的任务(如报告或抓取)时，并不会仔细查看，但这些事情可以优化，并有助于提高您作为计算机科学专业人员的技能。</li></ol><h2 id="dedb" class="lk jq hi bd jr ll lm ln jv lo lp lq jz iq lr ls kd iu lt lu kh iy lv lw kl lx bi translated"><strong class="ak">TL；博士</strong></h2><p id="3ad6" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated"><em class="kq">在看一个非常琐碎的例子之前，建议你看一下Jake VanderPlas </em>  <em class="kq">关于</em> <a class="ae mb" href="https://www.youtube.com/watch?v=zQeYx87mfyw" rel="noopener ugc nofollow" target="_blank"> <em class="kq">优化你的数字代码的七个策略</em> </a> <em class="kq">的PyCon演讲，这实际上会让你感受到这个东西有多强大，以及每个人都必须至少知道的一些正确的策略/实践。</em></p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h1 id="e288" class="jp jq hi bd jr js mj ju jv jw mk jy jz ka ml kc kd ke mm kg kh ki mn kk kl km bi translated"><strong class="ak"> &gt; &gt;导入线条轮廓图</strong></h1><p id="93f9" class="pw-post-body-paragraph if ig hi ih b ii kw ik il im kx io ip iq ly is it iu lz iw ix iy ma ja jb jc hb bi translated">幸运的是，在Python中进行代码剖析相当容易，因为有一堆工具，其中两个最受欢迎</p><ol class=""><li id="ad13" class="ku kv hi ih b ii ij im in iq mo iu mp iy mq jc lb lc ld le bi translated"><a class="ae mb" href="https://docs.python.org/3/library/profile.html" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">c profile</strong></a><strong class="ih hj"/>—这是Python标准库中内置的代码分析器</li><li id="6ea6" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">这是另一个实用程序，我个人认为它非常方便，下面的阅读涵盖了一个简单的例子。</li></ol><p id="f4e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的脚本只是将格式化的日期写入一个文件，要使用这个工具，您需要导入line_profiler(当然首先下载它),然后我们可以使用<em class="kq"> @profile </em> decorator和我们想要查看的方法。</p><p id="d46c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我通常从main方法开始，然后单步执行每个报告大部分时间消耗的调用。</p><p id="4a62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行这个，有几个选项，首先我们将使用line_profiler提供的“kernprof”实用程序</p><pre class="je jf jg jh fd mr ms mt mu aw mv bi"><span id="300f" class="lk jq hi ms b fi mw mx l my mz">$kernprof -v -l temp/main.py</span></pre><p id="15fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将运行脚本并在终端中显示结果，为了将输出保存到文件中并在以后进行可视化/分析，您也可以使用-o选项。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="a645" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从上面的结果可以看出，<em class="kq"> main() </em>方法似乎没什么奇怪的，但是对于<em class="kq"> formatted_dates() </em>方法，在L:10我们花费了大部分时间，70%的时间在<em class="kq">out . append(date . strftime(" % Y-% m-% d))</em></p><p id="87f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们能改进这个吗？—“将日期格式化为字符串的最快方法”，让我们看看</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="4b79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过删除方法调用<em class="kq"> strftime </em>，我们看到从<strong class="ih hj"> <em class="kq"> 145.0下降到33.0！！</em>T25】</strong></p><p id="b7f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kq"> [ </em> <strong class="ih hj"> <em class="kq">注意</em> </strong> <em class="kq">:每次运行时都会有变化，因为使用@profile会有一些开销，所以最好是平均一下，然后再做一个推断】</em></p><p id="57a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们试着看看我们是否能进一步改进主要功能—</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="6c40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过改变strftime和我们写行的方式，通过在列表中添加条目时添加' \n '，我们看到调用减少了——</p><p id="43e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kq">dates = formatted _ dates(start)</em>从<strong class="ih hj">调用<em class="kq"> 169.0到</em>74.0</strong></p></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h2 id="fc10" class="lk jq hi bd jr ll lm ln jv lo lp lq jz iq lr ls kd iu lt lu kh iy lv lw kl lx bi translated">总结—</h2><ol class=""><li id="aeb0" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">了解你的工具并利用它们，而不是仅仅依靠你的直觉。</li><li id="c9a8" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">从根方法开始，然后分别深入每个函数，实际查看可以改进的地方。</li><li id="0fb4" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">永远记住，<strong class="ih hj"><em class="kq"/></strong>在优化一个片段所需的努力和它给你的整个脚本带来的性能提升比率之间的权衡。</li><li id="8da5" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated"><strong class="ih hj"> <em class="kq"> line_profiler </em> </strong>还有一些更多的特性供你探索，比如忽略加载一个模块所花费的时间等等，还有输出文件生成的方式，有一些不同的方式可以可视化以做出更好的推断。</li><li id="51cd" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">有一种方法可以使用魔术方法，并使用line_profiler模块提供的魔术方法在jupyter笔记本中进行分析。</li><li id="3cbe" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">此外，您可以使用<a class="ae mb" href="https://docs.python.org/3.7/library/atexit.html" rel="noopener ugc nofollow" target="_blank"> atexit </a>向line_profiler实例注册一个函数并使脚本工作，而不必使用<strong class="ih hj"> <em class="kq"> kernprof </em> </strong>，更多信息请参见<a class="ae mb" href="https://lothiraldan.github.io/2018-02-18-python-line-profiler-without-magic/" rel="noopener ugc nofollow" target="_blank">https://lothiral Dan . github . io/2018-02-18-python-line-profiler-without-magic/</a></li></ol></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><h2 id="7031" class="lk jq hi bd jr ll lm ln jv lo lp lq jz iq lr ls kd iu lt lu kh iy lv lw kl lx bi translated">参考文献—</h2><ul class=""><li id="42e5" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc nc lc ld le bi translated"><a class="ae mb" href="https://www.youtube.com/watch?v=zQeYx87mfyw" rel="noopener ugc nofollow" target="_blank">Jake Vander plas——Performance Python:优化数字代码的七种策略</a></li><li id="aba0" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc nc lc ld le bi translated"><a class="ae mb" href="https://www.youtube.com/watch?v=yrRqNzJTBjk" rel="noopener ugc nofollow" target="_blank">马特·戴维斯— Python性能示例调查— PyCon 2018 </a></li><li id="0ee7" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc nc lc ld le bi translated">Github — <a class="ae mb" href="https://github.com/pyutils/line_profiler" rel="noopener ugc nofollow" target="_blank"> line_profiler </a></li><li id="2d5d" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc nc lc ld le bi translated"><a class="ae mb" href="https://zapier.com/engineering/profiling-python-boss/" rel="noopener ugc nofollow" target="_blank">像老板一样剖析Python</a></li><li id="ca03" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc nc lc ld le bi translated"><a class="ae mb" href="https://lothiraldan.github.io/2018-02-18-python-line-profiler-without-magic/" rel="noopener ugc nofollow" target="_blank">利用astexit注册一个个人资料</a></li></ul></div></div>    
</body>
</html>