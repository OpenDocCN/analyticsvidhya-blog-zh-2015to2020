<html>
<head>
<title>Retrieving conversation history from Dialogflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从对话流中检索对话历史记录</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/retrieving-conversation-history-from-dialogflow-bf3d41320420?source=collection_archive---------4-----------------------#2020-05-02">https://medium.com/analytics-vidhya/retrieving-conversation-history-from-dialogflow-bf3d41320420?source=collection_archive---------4-----------------------#2020-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/00a1c37d4e318e9c17f38a4e8f0b0c40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1A1nQpgWMs818yJQKIIkig.png"/></div></div></figure><h1 id="43c2" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">什么是Dialogflow？</h1><p id="061a" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">根据Dialogflow的官方文档，</p><blockquote class="km kn ko"><p id="a200" class="jo jp kp jq b jr kq jt ju jv kr jx jy ks kt kb kc ku kv kf kg kw kx kj kk kl hb bi translated">Dialogflow是一个自然语言理解平台，可以轻松设计对话式用户界面并将其集成到您的移动应用程序、web应用程序、设备、机器人、交互式语音响应系统等中。使用Dialogflow，您可以为用户提供新的、引人入胜的方式来与您的产品进行交互。</p><p id="d318" class="jo jp kp jq b jr kq jt ju jv kr jx jy ks kt kb kc ku kv kf kg kw kx kj kk kl hb bi translated">Dialogflow可以分析来自客户的多种类型的输入，包括文本或音频输入(如来自电话或录音)。它还能以几种方式回应你的客户，通过文本或合成语音。</p></blockquote><p id="ca10" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">嘿，如果你还没有在Dialogflow上训练你自己的聊天机器人，请访问他们的<a class="ae ky" href="https://cloud.google.com/dialogflow/docs/" rel="noopener ugc nofollow" target="_blank">文档</a>开始吧。简单又好玩！！</p><p id="ccc0" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">如果您已经将Dialogflow聊天机器人集成到您的网站、移动应用程序或社交媒体页面，并且您想要检索对话历史，以便您可以执行某种分析并了解您的客户或用户，这就是您的理想选择！！</p><h1 id="3637" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">对话流分析</h1><p id="d6ea" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">Dialogflow包含一个分析页面，让您深入了解您的代理的表现，以便您可以进一步改善您提供的用户体验。它显示了与代理及其参与的对话相关的两种数据类型:</p><ul class=""><li id="d757" class="kz la hi jq b jr kq jv kr jz lb kd lc kh ld kl le lf lg lh bi translated">使用数据:会话数和每个会话的查询数。</li><li id="48bb" class="kz la hi jq b jr li jv lj jz lk kd ll kh lm kl le lf lg lh bi translated">NLU数据:最常用的意向和退出百分比。</li></ul><p id="046c" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">点击左侧菜单中的<strong class="jq hj">分析</strong>将带您进入UI仪表板。在这里，您可以查看与特定代理相关的统计信息。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div class="er es ln"><img src="../Images/2b286451a1c8f722654c8c23707077df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*EZWRq97BGAUX19LwZ8s9xw.png"/></div></figure><figure class="lo lp lq lr fd ij er es paragraph-image"><div class="er es ls"><img src="../Images/d63fc0d32c58cc5265cfa08e12eb8dd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*AtJ994-luqz1KufBCBo5Ew.png"/></div></figure><figure class="lo lp lq lr fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/219b45328bcf8cec2682b860d6c2c992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*lGuaGmzsB0ZITPl8Y-aRzw.png"/></div></figure><h1 id="4163" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">登录对话流</h1><p id="ee07" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">Dialogflow不提供任何API来直接检索对话历史。你必须将对话记录到谷歌云，并从那里检索。要在Dialogflow中启用日志记录，请通过单击控制台左侧菜单中的⚙️图标并在<code class="du lu lv lw lx b">LOG SETTINGS</code>下启用<code class="du lu lv lw lx b">Log interactions to Google Cloud</code>来进入聊天机器人设置。这将把Dialogflow日志写到<a class="ae ky" href="https://en.wikipedia.org/wiki/Stackdriver" rel="noopener ugc nofollow" target="_blank"> Google Stackdriver </a>。点击<code class="du lu lv lw lx b">GOOGLE PROJECT</code>下的<code class="du lu lv lw lx b">project id</code>，将带你进入谷歌云控制台。在云控制台转到<code class="du lu lv lw lx b">Logs View</code>。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div class="er es ly"><img src="../Images/7e724cafcf3ed06b3a9a343fd7259921.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*dYn5MxPwNNTeQsx7pYNrxA.png"/></div></figure><p id="2539" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">这将向您显示来自Dialogflow的日志，您可以通过运行查询来过滤结果。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/1dc3ed08c4aec5db467e87033f14b210.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g6CUscpIpYivQqgc1dhJsQ.png"/></div></div></figure><h1 id="005b" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">将日志导出到本地计算机</h1><p id="3520" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">现在你的Dialogflow日志在Google Stackdriver里了。您可以将这些日志存储在云中，也可以将日志导出到第三方服务器。为此，您必须配置一个<a class="ae ky" href="https://cloud.google.com/logging/docs/routing/overview" rel="noopener ugc nofollow" target="_blank">日志路由器</a>。根据谷歌云文档，</p><blockquote class="km kn ko"><p id="9ddd" class="jo jp kp jq b jr kq jt ju jv kr jx jy ks kt kb kc ku kv kf kg kw kx kj kk kl hb bi translated">所有日志，包括审计日志、平台日志和用户日志，都被发送到云日志API，在那里它们通过日志路由器。日志路由器根据现有规则检查每个日志条目，以确定要丢弃的日志条目、要在云日志中接收(存储)的日志条目以及要使用日志接收器导出的日志条目。</p></blockquote><p id="7d23" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">下图说明了日志条目的路由:</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/6395536ba897093639edfc8278272cb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y49v-Wuwxip32jhK53-YXA.png"/></div></div></figure><blockquote class="km kn ko"><p id="3854" class="jo jp kp jq b jr kq jt ju jv kr jx jy ks kt kb kc ku kv kf kg kw kx kj kk kl hb bi translated">云日志记录收到的每个日志条目都会与排除过滤器和包含过滤器进行比较。这些比较是独立的。</p><p id="4291" class="jo jp kp jq b jr kq jt ju jv kr jx jy ks kt kb kc ku kv kf kg kw kx kj kk kl hb bi translated">为了确定日志条目是否被导出到目标，将日志条目与包含过滤器的日志接收器查询进行比较。当出现匹配时，日志条目被导出到接收器目标。一个日志条目可能匹配多个包含过滤器。</p><p id="7939" class="jo jp kp jq b jr kq jt ju jv kr jx jy ks kt kb kc ku kv kf kg kw kx kj kk kl hb bi translated">为了确定日志条目是被丢弃还是被保存在云日志存储中，将日志条目与排除过滤器进行比较。如果它匹配任何排除过滤器，日志条目将被丢弃。否则，日志条目将保存在云日志存储中。</p></blockquote><p id="b682" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">欲了解更多信息，请访问<a class="ae ky" href="https://cloud.google.com/logging/docs/routing/overview" rel="noopener ugc nofollow" target="_blank">文档</a>页面。</p><p id="787e" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">为了更好地控制日志，您需要将它们保存在本地环境的文件或数据库中。因此，您必须将它们路由到<a class="ae ky" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank"> Google Cloud Pub/Sub </a>。点击<code class="du lu lv lw lx b">Logs Router -&gt; CREATE SINK</code>。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/785f2b5ede366431856a5f726b7113cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YA49vtasT6LAjhOgW1I3iQ.png"/></div></div></figure><p id="4570" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">在下一个视图中，为您的<strong class="jq hj">接收器</strong>命名，并选择<code class="du lu lv lw lx b">Pub/Sub</code>作为<strong class="jq hj">接收器服务</strong>。在<strong class="jq hj">接收目的地</strong>下拉菜单中选择<code class="du lu lv lw lx b">Create new Cloud Pub/Sub topic</code>。为您的发布/订阅主题命名，然后点击<code class="du lu lv lw lx b">Create</code>。然后点击<code class="du lu lv lw lx b">Create Sink</code>。这会将您的日志路由到云发布/订阅。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/2e04db95c1551f08a78ed7c04034edee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3vG77E8_Un_B7hpRA6mTKQ.png"/></div></div></figure><p id="bbf6" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">从云控制台菜单中选择<code class="du lu lv lw lx b">Pub/Sub -&gt; Topics</code>。</p><figure class="lo lp lq lr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/61f1772db83e9d2ca03cdfb6728cbdbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1PLi6mo4a7BXjW1icXyXVA.png"/></div></div></figure><p id="ed7e" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">您可以看到您的主题已经创建。我在这里创建的题目是<code class="du lu lv lw lx b">chitti-logs</code>。要将日志放到您的本地环境中，您需要订阅您的主题。让我们创建一个订阅。点击主题旁边的⋮，然后选择<code class="du lu lv lw lx b">Create subscription</code>。给你的订阅起一个名字，其他的都保持默认，选择<code class="du lu lv lw lx b">Create</code>。您的日志已经准备好被拉到您的本地机器上。但在此之前，请遵循此处的教程<a class="ae ky" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank">并在您的机器中设置Google Cloud SDK。</a></p><p id="24b4" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">在你的命令行运行<a class="ae ky" href="https://cloud.google.com/sdk/gcloud/reference/init" rel="noopener ugc nofollow" target="_blank"> gcloud init </a>来初始化SDK。</p><pre class="lo lp lq lr fd me lx mf mg aw mh bi"><span id="5bcb" class="mi ir hi lx b fi mj mk l ml mm">./google-cloud-sdk/bin/gcloud init</span></pre><p id="03cb" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">一旦一切都设置好了，下面的命令将在命令行或终端中打印您的日志。这里，<code class="du lu lv lw lx b">chitti-sub</code>是我的发布/订阅id。<br/> <code class="du lu lv lw lx b">gcloud pubsub subscriptions pull --auto-ack chitti-sub</code></p><p id="06a5" class="pw-post-body-paragraph jo jp hi jq b jr kq jt ju jv kr jx jy jz kt kb kc kd kv kf kg kh kx kj kk kl hb bi translated">将Dialogflow日志导出到本地机器的目的是为了执行某种分析并了解您的客户或用户。在我的例子中，我想为我的聊天机器人开发一个仪表板，这样我就可以在一个地方查看我分析过的所有信息。为了实现这一点，我必须将发布/订阅消息写到<a class="ae ky" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>。我将在下一篇文章中解释我是如何与<a class="ae ky" href="https://spring.io/projects/spring-cloud-gcp" rel="noopener ugc nofollow" target="_blank">Spring Boot·GCP</a>一起实现这一点的。敬请关注…</p></div></div>    
</body>
</html>