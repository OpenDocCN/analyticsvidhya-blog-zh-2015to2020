<html>
<head>
<title>Plotting Geo-scatter plot using Plotly and Dash</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Plotly和Dash绘制地理散点图</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/plotting-geo-scatter-plot-using-plotly-and-dash-778b8afbdf68?source=collection_archive---------3-----------------------#2019-12-16">https://medium.com/analytics-vidhya/plotting-geo-scatter-plot-using-plotly-and-dash-778b8afbdf68?source=collection_archive---------3-----------------------#2019-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2fff8d1aeeaa77097f7db1d6d9a36f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oR5vDwODQMMXC2RNhAm9DA.png"/></div></div></figure><p id="6061" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据可视化已经成为从数据中挖掘模式和洞察的有效工具。可视化与地理坐标相结合有助于探索地理空间数据。地理散点图是一种散点图，其中数据点绘制在地理坐标上，而不是笛卡尔坐标上。我们将使用<a class="ae jo" href="https://dash.plot.ly/" rel="noopener ugc nofollow" target="_blank"> <em class="jp">破折号</em> </a>组件和<a class="ae jo" href="https://docs.mapbox.com/api/maps/" rel="noopener ugc nofollow" target="_blank"><em class="jp">mapbox maps API</em></a><em class="jp"/>在mapbox地图上创建地理散点图。Dash是一个高效的框架，用于构建基于flask、react.js、plotly.js编写的web应用程序。它非常适合使用python构建具有高度自定义接口的数据可视化应用程序。我们在这里使用dash的两个主要组件。Dash HTML组件(<a class="ae jo" href="https://dash.plot.ly/dash-html-components" rel="noopener ugc nofollow" target="_blank"><em class="jp">dash _ HTML _ component</em></a>)提供了围绕HTML、CSS和javascript的python抽象，而dash core组件(<a class="ae jo" href="https://dash.plot.ly/dash-core-components" rel="noopener ugc nofollow" target="_blank"><em class="jp">dash _ core _ component</em></a>)提供了交互式用户界面的组件。</p><h1 id="97c7" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">数据描述</h1><p id="e1f9" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">智能手机用户的快速增长为全球新的智能手机进入者铺平了道路。在这里，我创建了2015年至2019年高知地区(印度喀拉拉邦)智能手机用户的数据集。这些数据是为了学习dash和plotly的唯一目的而创建的，因此不应该从观想中推断出任何东西。数据是使用python <em class="jp"> faker </em>和<em class="jp"> random </em>库生成的(数据创建的范围在本文之外)。该数据包含以下属性:</p><p id="517d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">年份，纬度，经度，移动</em></p><h1 id="4af9" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">属国</h1><p id="b9a7" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">某些python库不能作为python中的内置库。其中包括<a class="ae jo" href="https://pypi.org/project/pandas/" rel="noopener ugc nofollow" target="_blank"> <em class="jp">熊猫</em></a><a class="ae jo" href="https://pypi.org/project/Shapely/" rel="noopener ugc nofollow" target="_blank"><em class="jp">身材匀称</em> </a>和<a class="ae jo" href="https://pypi.org/project/dash/" rel="noopener ugc nofollow" target="_blank"> <em class="jp"> Dash </em> </a>。这些需要使用pip或conda安装程序进行安装(取决于我们创建的环境)。</p><p id="1094" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了使用交互式定制在线地图，我们还需要创建mapbox帐户并生成访问令牌。访问令牌有助于将API请求与我们的mapbox帐户相关联。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/0c4697fde68a6227008ed5d1aebc17ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lhny6kYjVvfp0n20IqtEdA.png"/></div></div></figure><p id="1114" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">概括一下:</p><blockquote class="ky"><p id="7fa5" class="kz la hi bd lb lc ld le lf lg lh jn dx translated">1.安装所需的python库— Pandas、Shapely、Dash</p><p id="7445" class="kz la hi bd lb lc ld le lf lg lh jn dx translated">2.创建地图框帐户</p><p id="3eb1" class="kz la hi bd lb lc ld le lf lg lh jn dx translated">3.创建API访问令牌</p></blockquote><h1 id="8efa" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb li kd ke kf lj kh ki kj lk kl km kn bi translated">数据准备</h1><p id="7cc5" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">在绘制地理散点图之前，需要根据要求划定地理边界。这有助于分析分散点和划定边界内的地理位置之间的相关性(如果有的话)。首先，通过<a class="ae jo" href="http://geojson.io/" rel="noopener ugc nofollow" target="_blank"> geojson.io </a>设置多边形边界，然后使用python shapely库检查数据点是否落在有界位置内，可以明确排除有界位置外的散射点。绘制多边形并保存geojson文件。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/9802f019f5a748191cada3ef16041ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qDKjGGvpxVMmZJRPB0QB2w.jpeg"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">为所需位置创建geojson文件</figcaption></figure><p id="91f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要导入数据和geojson文件。使用geojson文件过滤数据框(df)中的位置。过滤完成后，我们将数据保存在csv文件中。该文件稍后可用于绘制地理散点图。</p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="f9e3" class="lv jr hi lr b fi lw lx l ly lz">import json<br/>import pandas as pd<br/>from shapely.geometry import Point<br/>from shapely.geometry.polygon import Polygon</span><span id="ed68" class="lv jr hi lr b fi ma lx l ly lz">with open(‘KochiMainland.geojson’) as data_file: <br/> data = json.load(data_file)</span><span id="656f" class="lv jr hi lr b fi ma lx l ly lz">df = pd.read_csv(‘KochiMobile.csv’)</span><span id="d873" class="lv jr hi lr b fi ma lx l ly lz">lon = []<br/>lat = []<br/>mob = []<br/>year = []<br/>for i in range(len(df)):<br/> if(polygon.contains(Point(df[‘Longitude’][i],df[‘Latitude’][i]))):<br/>  lon.append(df[‘Longitude’][i])<br/>  lat.append(df[‘Longitude’][i])<br/>  year.append(df[‘Year’][i])<br/>  mob.append(df[‘Year’][i])<br/><br/>newDf = pd.DataFrame({‘Year’:year,’Longitude’:lon,’Latitude’:lat,’Mobile’:mob})<br/>newDf.to_csv(‘KochiMobile.csv’)</span></pre><p id="cd5b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦数据被过滤并准备好绘制，现在我们可以开始创建地理散点图。让我们开始导入必要的库并初始化dash应用程序。</p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="4abf" class="lv jr hi lr b fi lw lx l ly lz">import dash<br/>import json<br/>import random<br/>import numpy as np<br/>import pandas as pd<br/>import plotly.graph_objs as go<br/>import dash_core_components as dcc<br/>import dash_html_components as html</span><span id="8610" class="lv jr hi lr b fi ma lx l ly lz">from faker import Faker<br/>from collections import Counter<br/>from dash.dependencies import Input,Output,State</span><span id="47e2" class="lv jr hi lr b fi ma lx l ly lz">app=dash.Dash()</span></pre><p id="2ba8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于手机的数量很大，每年都在变化，我更喜欢随机分配不同的颜色来描绘不同的智能手机用户。我们还需要为文本创建一个背景色和颜色。</p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="cc63" class="lv jr hi lr b fi lw lx l ly lz">colors = {<br/> ‘backgroundMain’: ‘#ffffff’,<br/> ‘backgroundSub’ : ‘#000000’,<br/> ‘textMain’: ‘#000000’,<br/> ‘textSub’ : ‘##ffffff’<br/>}<br/>r = np.rint(np.random.uniform(0,255,len(df[‘Mobile’].unique())))<br/>g = np.rint(np.random.uniform(0,255,len(df[‘Mobile’].unique())))<br/>b = np.rint(np.random.uniform(0,255,len(df[‘Mobile’].unique())))</span><span id="01b5" class="lv jr hi lr b fi ma lx l ly lz">def rgb(r,g,b):<br/> return ‘rgb(‘+str(r)+’,’+str(g)+’,’+str(b)+’)’</span></pre><p id="3b60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(r，g，b)组合稍后用于为每部智能手机设置标记颜色。现在，让我们使用dash html组件来设置整个仪表板的布局。该脚本类似于以下内容:</p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="0b5b" class="lv jr hi lr b fi lw lx l ly lz">app.layout = <br/>html.Div([html.Div([html.H1(‘Dummy Mobile Usage’)],style= {‘textAlign’:’center’,’color’:colors[‘textMain’]}),<br/>html.Div(html.P(id=’title-rangeslider-break’),style={‘padding-top’:’10px’}),<br/>html.Div([dcc.RangeSlider(id = ‘range-slider’,min = 2015,max = 2019, marks = {i:{‘label’:str(i),’style’:‘color’:colors[‘backgroundSub’]}}<br/>for i in range(2015,2020)},value = [2015,2019])],style = {‘width’:’20%’,’padding-left’:’80px’}),<br/>html.Div(html.P(id=’rangeslider-graph-break’)),<br/>html.Div([html.Div(dcc.Graph(id = ‘geoscatterplot-graph’),<br/>style={‘width’:’70%’,’float’:’left’}),<br/>html.Div(html.Pre(id = ‘json-data’),style={‘width’:’10%’,’float’:’right’,’padding-top’:’100px’})],style={‘display’:’flex’,’justify-content’:’space-between’}),],style={‘height’:’70%’})</span></pre><p id="b2d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">web应用程序的前端将有4个主要组件。一个<em class="jp">表头组件</em>、<em class="jp">范围滑块组件</em>、<em class="jp">图形组件</em>和<em class="jp">输出显示组件</em>。顾名思义，Header组件将包含仪表板的标题。范围滑块允许用户选择要绘制散点图的年份范围。图形组件保存地理散点图。最后，如果在散点图中进行了任何选择，我们需要显示我们定义的HTML容器的详细信息，以保存这些组件。在这些主要组件之间，我们需要提供HTML段落组件<em class="jp">。这是为了分配每个主要组件前后的空间。在设置了前端用户界面之后，我们必须提供回调装饰器来包含组件之间的交互性。首先，让我们为地理散点图构建回调。</em></p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="8ba7" class="lv jr hi lr b fi lw lx l ly lz"><a class="ae jo" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.callback(Output(‘geoscatterplot-graph’,’figure’),[Input(‘range-slider’,’value’)])<br/>def chloroplethGraphPlot(value):<br/> data = []<br/> year = [i for i in range(value[0],value[1]+1)]<br/> print(‘year::’,year)<br/> for i,mob in enumerate(df[‘Mobile’].unique()):<br/>  data.append(go.Scattermapbox(<br/>  lat=df[(df.Mobile==mob) &amp; (df.Year.isin(year))][‘Latitude’],<br/>  lon=df[(df.Mobile==mob) &amp; (df.Year.isin(year))][‘Longitude’],<br/>  mode=’markers’,<br/>  marker=go.scattermapbox.Marker(<br/>  opacity=0.8,size=4,color=rgb(r[i],g[i],b[i])<br/>  ),<br/>  text=df[df[‘Mobile’]==mob][‘Mobile’],name = mob<br/>  ))<br/>  layout = go.Layout(<br/>  #title = ‘Dummy Chloropeth’,<br/>  autosize=True,<br/>  hovermode=’closest’,<br/>  height=900,<br/>  width=1400,<br/>  mapbox=go.layout.Mapbox(<br/>  accesstoken=mapbox_access_token,<br/>  bearing=0,<br/>  center=go.layout.mapbox.Center(<br/>  lat=9.934200203046808,<br/>  lon=76.2551855659548),<br/>  pitch=60,<br/>  #style=shaz13_custom_style,<br/>  zoom=15<br/>  ))<br/> return{‘data’:data,’layout’:layout}</span></pre><p id="c99a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">我们之前已经解释过，mapbox_access_token </em>需要从mapbox帐户生成。令牌值需要硬编码或作为全局变量提供。</p><p id="98af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回调装饰器中有一个输出参数和一个输入参数。正如我们所讨论的，地理散点图将是输出。范围滑块将是输入。最小值和最大值(来自范围滑块)作为值传递给函数。基于这些值，创建数据跟踪列表。在图形布局中设置图形的宽度、高度和其他布局。一旦数据跟踪和布局准备就绪，返回它们。</p><p id="5936" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">类似地，需要创建一个新的装饰器来定义地理散点图和输出显示之间的交互性。</p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="f9fc" class="lv jr hi lr b fi lw lx l ly lz"><a class="ae jo" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.callback(Output(‘json-data’,’children’),[Input(‘geoscatterplot-graph’,’selectedData’)])<br/>def selectedDataPlot(selectedData):<br/>    try:<br/>      SelectedMobile = []<br/>      for i in range(len(selectedData[‘points’])):<br/>        SelectedMobile.append(selectedData[‘points’][i][‘text’])<br/>        print(Counter(SelectedMobile)<br/>      return json.dumps(Counter(SelectedMobile),indent=2)<br/>    except:<br/>      print(‘NoneType Error’)<br/>    return</span></pre><p id="c2fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出显示组件是回调装饰器的输出参数。输入将是从地理散点图中选择的区域。这里我们统计一下各个智能手机公司旗下的智能手机数量。</p><p id="e246" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如前所述，我们已经开展了必要的兴趣活动。让我们启动dash应用服务器。</p><pre class="ku kv kw kx fd lq lr ls lt aw lu bi"><span id="739c" class="lv jr hi lr b fi lw lx l ly lz">if __name__=='__main__':<br/>    app.run_server(host='0.0.0.0',port=80)</span></pre><p id="4514" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在查看位于<a class="ae jo" href="http://0.0.0.0/" rel="noopener ugc nofollow" target="_blank"> http://0.0.0.0:80 </a>的可视化应用程序。总而言之，我们已经实现了基于范围滑块选择的兴趣活动，如下所示:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/b812d832a452eb5006b1264a871b3140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n5X324o9cYuisYYMlf-pLA.jpeg"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">左:2015–2019，右:2015:2016</figcaption></figure><p id="2623" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">类似地，我们还实现了基于图形中套索/框选择的交互性。兴趣活动如下所示:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/35c63f3c21a39b8bedbfb7d1d9ae2f26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VDXKtmTgqSo9IjDFurifBQ.jpeg"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">左:方框选择，右:套索选择</figcaption></figure><p id="dfc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还有许多其他简单的组件和交互性可以添加到应用程序中。例如，我们可以绘制一个更清晰、更吸引人的饼状图，而不是显示字典数据。另外，你可以尝试用日期范围选择器来代替普通的范围选择器。</p></div></div>    
</body>
</html>