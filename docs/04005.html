<html>
<head>
<title>Setting up Airflow to run with Docker Swarm’s orchestration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Docker Swarm的编排设置气流运行</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/setting-up-airflow-to-run-with-docker-swarms-orchestration-b16459cd03a2?source=collection_archive---------4-----------------------#2020-03-01">https://medium.com/analytics-vidhya/setting-up-airflow-to-run-with-docker-swarms-orchestration-b16459cd03a2?source=collection_archive---------4-----------------------#2020-03-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3f31" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">设置可靠调度程序的代码片段</h2></div><p id="1c6a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不久前，我在<a class="ae jt" rel="noopener" href="/analytics-vidhya/orchestrating-airflow-tasks-with-docker-swarm-69b5fb2723a7">上发布了一个故事</a>,描述了如何使用气流和容器编排层(比如Docker Swarm)来构建弹性任务调度器。在这个故事中，我想分享启动和运行它所需要的极简代码。我们将设置气流来运行Docker Swarm上的任务。对于不熟悉Airflow或Docker Swarm的读者，我建议先看看<a class="ae jt" rel="noopener" href="/analytics-vidhya/orchestrating-airflow-tasks-with-docker-swarm-69b5fb2723a7">之前的故事</a>。</p><p id="fd54" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">在本文结束时，您将拥有一个正在运行的Airflow实例，它的任务可以在任何具有足够资源的服务器上(从您的服务器池中)自动运行。如果你只是想学习设置气流并在其上运行任务，这可能仍然是一个好地方。</strong></p><h1 id="5836" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">内容</h1><p id="1602" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">以下是我们将要遵循的步骤。安装Docker(随<em class="kr"> Docker Swarm </em>内置)<br/> 2。建立一个Docker集群<br/> 3。安装气流<br/> 4。在Docker Swarm上利用气流运行您的任务</p><p id="7825" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以让我们开始吧。</p><h1 id="d515" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">安装Docker</h1><p id="d6af" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">这是唯一一部分，我不会说太多细节，因为它非常依赖于操作系统，并且已经在<a class="ae jt" href="https://docs.docker.com/install/#supported-platforms" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/install/#supported-platforms</a>做了很好的记录。如果你在安装时仍然发现任何问题，请随时在评论中或在<a class="ae jt" href="https://stackoverflow.com/" rel="noopener ugc nofollow" target="_blank"> Stackoverflow </a>上问我。</p><p id="aaff" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦您的系统上运行了Docker(或者已经运行了Docker ),并且可以通过命令行访问它，您就可以跳到下一节。</p><h1 id="a76d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">建立Docker群集群</h1><p id="0903" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">从您的终端，运行这个命令—<strong class="iz hj"><em class="kr">docker swarm init</em></strong></p><p id="06cb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当您运行下面给出的命令时，现在应该能够看到群集中的一个节点:</p><blockquote class="ks kt ku"><p id="239c" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">停靠节点ls</p></blockquote><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ky"><img src="../Images/a994075e49019f1579d6c552b32a4c62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qts6h_XPN0epYzupvaKr1g.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">具有1个节点的Docker群集</figcaption></figure><h2 id="aea5" class="lo jv hi bd jw lp lq lr ka ls lt lu ke jg lv lw kg jk lx ly ki jo lz ma kk mb bi translated">向群集中添加更多节点(可选)</h2><p id="215b" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">现在我们有一个Docker Swarm集群，其中有一个节点，足以看到实际情况，所以您可以跳过这一步。<br/>如果您有更多的节点(服务器)并希望看到编排层(Docker Swarm)做一些“真正的”工作，您可以使用之前运行的“<em class="kr">init”</em>命令(例如对于<code class="du mc md me mf b">docker swarm join --token SWMTKN-some-long-string-token-here some-ip-or-hostname-here:2377</code>)得到的命令向Docker Swarm集群添加更多的节点。一旦您向Swarm集群添加更多的workers，您将会看到命令<code class="du mc md me mf b">docker node ls</code>返回更多的节点。</p><h1 id="cf60" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">安装气流</h1><p id="7c50" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">因为我们已经安装了Docker，所以我们可以简单地运行气流的Docker映像，并让它启动和运行。还有一个PostgreSQL实例，我们将运行它来存储Airflow的元数据(支持许多其他数据库)。为此，请运行以下命令:</p><blockquote class="ks kt ku"><p id="ea43" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">mkdir air flow-swarm-operator-blog<br/>CD air flow-swarm-operator-blog/<br/>curl-XGET<a class="ae jt" href="https://gist.githubusercontent.com/akki/cd89c9caff5bf19454cdf913ceb59c32/raw/085f4f538c2d48e01d7789aa8701f9f00e3a0a81/stack.yml" rel="noopener ugc nofollow" target="_blank">https://gist . githubusercontent . com/akki/CD 89 c 9 caff 5 BF 19454 CDF 913 CEB 59 c 32/raw/085 F4 f 538 c 2d 48 e 01d 7789 aa 8701 f 9f 00 e 3a 0 a 81/stack . yml</a>&gt;&gt;stack . yml【T11</p></blockquote><p id="d175" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意:</strong> Windows用户可能需要将<code class="du mc md me mf b">stack.yml</code>文件(由上述命令创建)<a class="ae jt" href="https://stackoverflow.com/a/41005007/3061686" rel="noopener ugc nofollow" target="_blank">中的<code class="du mc md me mf b">/var/run/docker.sock:/var/run/docker.sock</code>更改为<code class="du mc md me mf b">//var/run/docker.sock:/var/run/docker.sock</code>，如这里所述</a>。</p><p id="3d8c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您应该看到以下输出(确保您没有看到任何错误):</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mg"><img src="../Images/87cab3126ed4a37b84d37923452ef67c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZBDYanDWnDXEymsjw3QYDQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">部署Docker堆栈后的输出</figcaption></figure><p id="404b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">简单地说，我们只是创建了一个Docker堆栈文件并部署了它。这将启动2个Docker服务，可以使用以下命令进行确认:</p><blockquote class="ks kt ku"><p id="e0a2" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">码头服务</p></blockquote><p id="083c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切正常，输出应该如下所示:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mh"><img src="../Images/520eea5a2a58cfee5149cdf7f311a680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tc7VVvnZNHrB75n2UyUZMw.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">气流和邮船在码头群中运行</figcaption></figure><p id="f7b9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，您现在应该能够在<a class="ae jt" href="http://localhost:18080" rel="noopener ugc nofollow" target="_blank"> http://localhost:18080 </a>看到Airflow漂亮的用户界面。</p><h1 id="6a77" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">Docker Swarm中的任务调度</h1><p id="a5af" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">既然我们已经设置并运行了气流，下一步就是在Docker Swarm上运行我们的气流任务。这里需要注意的一点是，如果你是Docker Swarm的新手，那么在Swarm中，所有的容器都作为一个“服务”运行，所以无论你计划运行什么任务(在Airflow中称为DAG ),都将作为一个Docker服务运行。</p><h2 id="f9ec" class="lo jv hi bd jw lp lq lr ka ls lt lu ke jg lv lw kg jk lx ly ki jo lz ma kk mb bi translated">使用DockerSwarmOperator添加DAG</h2><p id="a1bb" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">由于Airflow在Docker容器中运行，我们需要<strong class="iz hj">将DAG文件复制到容器</strong>中，以便将DAG添加到Airflow中。为此，只需遵循以下步骤:</p><ol class=""><li id="c222" class="mi mj hi iz b ja jb jd je jg mk jk ml jo mm js mn mo mp mq bi translated">通过运行<code class="du mc md me mf b">curl -XGET <a class="ae jt" href="https://gist.githubusercontent.com/akki/4c95805ce1617e2765fecb73bb98230c/raw/cf58ec0391957d50f5ae548f7f618a58c9395156/example_dockerswarmoperator.py" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/akki/4c95805ce1617e2765fecb73bb98230c/raw/cf58ec0391957d50f5ae548f7f618a58c9395156/example_dockerswarmoperator.py</a> &gt;&gt; example_dockerswarmoperator.py</code>下载DAG文件。</li><li id="1d40" class="mi mj hi iz b ja mr jd ms jg mt jk mu jo mv js mn mo mp mq bi translated">在您的终端中运行<code class="du mc md me mf b">docker ps</code>。</li><li id="0b06" class="mi mj hi iz b ja mr jd ms jg mt jk mu jo mv js mn mo mp mq bi translated">查找容器名<code class="du mc md me mf b">airflow_pod</code>，并在上一步的命令中复制其容器id(下图中高亮显示)。</li></ol><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mw"><img src="../Images/152d44e6e21197236fe1796f3480a53c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0TPaUXqAtDX6j7LXqwvoaQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">气流堆栈运行时“docker ps”命令的结果</figcaption></figure><p id="be7c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.运行<code class="du mc md me mf b">docker cp example_dockerswarmoperator.py &lt;copy-container-id-here&gt;:/root/airflow/dags/example_dockerswarmoperator.py</code>。确保你没有错误。</p><p id="af96" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.现在再次刷新<a class="ae jt" href="http://localhost:18080" rel="noopener ugc nofollow" target="_blank">UI</a>——在几分钟内(通常为3-5分钟),您应该会在UI中看到您的DAG。祝贺您—您的DAG现在正在气流中运行！👏</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mx"><img src="../Images/2564fd3ba1b162d7338eef2625468c3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bRwkihwuPEWqDG27ovFJKg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">DAG添加到气流中</figcaption></figure><h2 id="78a9" class="lo jv hi bd jw lp lq lr ka ls lt lu ke jg lv lw kg jk lx ly ki jo lz ma kk mb bi translated">确认你的任务正在Docker Swarm上运行</h2><p id="f109" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">原来如此！你刚刚在Docker Swarm上运行了你的第一个气流任务。</p><p id="2a6d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是我们怎么能确定呢？我们可以通过注意到当我们触发我们的气流任务时，一个新的Docker服务启动来确认这一点。以下是如何做到这一点:</p><ol class=""><li id="09a0" class="mi mj hi iz b ja jb jd je jg mk jk ml jo mm js mn mo mp mq bi translated">通过点击“触发DAG”按钮，即“链接”部分下的“播放”按钮，通过Airflow UI启动(触发)您的任务。</li></ol><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es my"><img src="../Images/2c77fee09586a45964a9fb489451d8f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f-ZNNa1qX00R5pNPhlG0YQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">触发Dag按钮</figcaption></figure><p id="0f6e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.确认您的任务正在气流中运行，即有一个状态为“正在运行”的任务。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es mz"><img src="../Images/f9f733b7b836480d41e52742d57fa6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qlieyNQByJ0JxO2y1dOozg.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">正在运行的任务的气流DAG(浅绿色圆圈表示“正在运行”)</figcaption></figure><p id="cda6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.转到终端并运行<code class="du mc md me mf b">docker service ls</code> —几秒钟后，您应该能够看到一个新的服务正在运行，其名称的形式为- &gt; <code class="du mc md me mf b">airflow-&lt;8-character-random-string&gt;</code>。(注意服务只运行45秒，所以之后，你的服务就会终止，从这里消失)。</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es na"><img src="../Images/5c8821bdc71de8a577b0b1744304a494.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3c7BxLz45AmT5VzJo8foUA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">气流任务作为Docker服务运行。</figcaption></figure><p id="a956" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就对了。您的任务作为Docker服务运行。如果您在Docker Swarm集群中添加了多个节点(如前面可选步骤中所述)，那么当一个节点资源不足时，您会看到它在不同的节点上运行。</p><p id="e0b4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，如果您熟悉Airflow，您可以打印DAG中的一些内容，然后<a class="ae jt" href="https://stackoverflow.com/a/60584746/3061686" rel="noopener ugc nofollow" target="_blank">检查它是否显示在Airflow DAG的日志中</a>。</p><h1 id="ebc4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">关闭一切</h1><p id="173e" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">如果您想停止我们开始的一切，以下是实现这一目的的命令:</p><ol class=""><li id="b9b9" class="mi mj hi iz b ja jb jd je jg mk jk ml jo mm js mn mo mp mq bi translated">移除Docker堆栈</li></ol><blockquote class="ks kt ku"><p id="eb99" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">码头堆栈rm气流</p></blockquote><p id="6d14" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.确保没有任何服务正在运行</p><blockquote class="ks kt ku"><p id="5e82" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">码头服务</p></blockquote><p id="0364" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.离开码头群集群</p><blockquote class="ks kt ku"><p id="0202" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">码头工人成群结队离去</p></blockquote><p id="8c56" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.或者，删除为此博客创建的目录</p><blockquote class="ks kt ku"><p id="6ddc" class="ix iy kr iz b ja jb ij jc jd je im jf kv jh ji jj kw jl jm jn kx jp jq jr js hb bi translated">激光唱片..&amp;&amp; rm -r气流-群体-操作员-博客</p></blockquote><h1 id="3ada" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">结论</h1><p id="9140" class="pw-post-body-paragraph ix iy hi iz b ja km ij jc jd kn im jf jg ko ji jj jk kp jm jn jo kq jq jr js hb bi translated">在运行完所有这些步骤之后，你应该能够通过<code class="du mc md me mf b">DockerSwarmOperator</code>在Docker Swarm中运行你的Airflow作业了(<a class="ae jt" rel="noopener" href="/analytics-vidhya/orchestrating-airflow-tasks-with-docker-swarm-69b5fb2723a7">参见这个</a>以了解更多信息)。如果你有任何问题，请在下面的评论中提出来，如果可以的话，我很乐意帮忙。</p><p id="5ed0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于任何好奇的人来说，这里是akkidx/airflow的docker file:blog 1—<a class="ae jt" href="https://gist.github.com/akki/55eae1e196b05377bd7b3031d9c16bc6" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/akki/55 EAE 196 b 05377 BD 7b 3031d 9 c 16 BC 6</a>。</p></div></div>    
</body>
</html>