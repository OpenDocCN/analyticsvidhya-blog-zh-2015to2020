<html>
<head>
<title>Working efficiently with Large Data in pandas and MySQL (or any other RDBMS)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在pandas和MySQL(或任何其他RDBMS)中高效地处理大量数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/working-efficiently-with-large-data-in-pandas-and-mysql-or-any-other-rdbms-1d7376936763?source=collection_archive---------0-----------------------#2020-07-03">https://medium.com/analytics-vidhya/working-efficiently-with-large-data-in-pandas-and-mysql-or-any-other-rdbms-1d7376936763?source=collection_archive---------0-----------------------#2020-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/68a5de3c816c40da1eba1f8053e551cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uBZUavwNPL-gd_c52pNG3Q.jpeg"/></div></div></figure><p id="a0f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大家好，这个简短的教程将向大家展示如何使用pandas从csv、excel或外部数据库中高效地读取大型数据集，并将其存储在一个集中的数据库中。</p><p id="d3b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> pandas </strong> </a>是一款快速、强大、灵活且易于使用的开源数据分析和操作工具，构建在<a class="ae jo" href="https://www.python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a>编程语言之上。</p><p id="0d72" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将读取的数据集是首尔空气污染的csv文件。你可以从<a class="ae jo" href="https://www.kaggle.com/bappekim/air-pollution-in-seoul" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">这里</strong> </a>(如果你有kaggle账号的话)或者<a class="ae jo" href="https://data.seoul.go.kr/dataList/OA-15526/S/1/datasetView.do" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">这里</strong> </a>下载。</p><blockquote class="jp jq jr"><p id="f73f" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">感谢首尔市、首尔开放数据广场、空气质量分析中心提供数据。</p></blockquote><p id="6350" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不占用您太多的时间，让我们直接开始吧…</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><ol class=""><li id="23ff" class="kd ke hi is b it iu ix iy jb kf jf kg jj kh jn ki kj kk kl bi translated"><strong class="is hj">导入所需的库</strong></li></ol><p id="decf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">import pandas as pd<br/>import mysql.connector as sql</code></p><p id="1ba5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.<strong class="is hj">读取csv文件(传统方式)</strong></p><p id="3aa1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df = pd.read_csv(‘Measurement_item_info.csv’,sep=’,’)</code></p><p id="1ef0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们预览一下文件的外观</p><p id="b834" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df.head()</code></p><figure class="kr ks kt ku fd ij er es paragraph-image"><div class="er es kq"><img src="../Images/1b573fe512c813b748f03241f9466cf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*FIH4hgVHdtWXd3RCkh6zxQ.png"/></div></figure><p id="a691" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们检查一下我们有多少行和列</p><p id="59be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df.shape &gt;&gt; (3885066, 5)</code></p><p id="7e1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这大约是390万行和5列。</p><p id="ecc2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于我们使用传统的方式，我们的<strong class="is hj"> <em class="js">内存管理</em>效率不高。让我们看看每一列消耗了多少内存，以及消耗内存的总和。<strong class="is hj">注意:输出以字节为单位</strong></strong></p><p id="83e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df.memory_usage(index=False, deep=True)</code></p><pre class="kr ks kt ku fd kv kp kw kx aw ky bi"><span id="722a" class="kz la hi kp b fi lb lc l ld le">Measurement date     283609818<br/>Station code          31080528<br/>Item code             31080528<br/>Average value         31080528<br/>Instrument status     31080528</span></pre><p id="cc94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df.memory_usage(index=False, deep=True).sum()</code></p><p id="0d7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">407931930 bytes.</code></p><p id="a885" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="js">大约408MB </em>、<strong class="is hj">、<em class="js">而磁盘</em>、</strong>上实际文件大小为124.4MB。不好！！！</p><p id="cdd9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 3。内存管理</strong></p><p id="d893" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">虽然有时我们可能会侥幸逃脱，但像上面那样使用内存并不是最好的做法。为了能够管理内存，我们需要能够理解数据帧的数据类型。让我们这样做…</p><p id="07c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df.dtypes</code></p><pre class="kr ks kt ku fd kv kp kw kx aw ky bi"><span id="27a5" class="kz la hi kp b fi lb lc l ld le">Measurement date      object<br/>Station code           int64<br/>Item code              int64<br/>Average value        float64<br/>Instrument status      int64</span></pre><blockquote class="jp jq jr"><p id="829e" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">默认情况下，pandas分配上述“dtypes ”,以防止任何数据太大而不适合存储。例如，带符号的int64(即64位整数)的最大值是9，223，372，036，854，775，807。</p></blockquote><p id="b0f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们检查是否有任何int64 dtypes实际上接近这个数字</p><p id="8525" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df[‘Station code’].max() &gt;&gt; 125</code></p><p id="545c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df[‘Item code’].max() &gt;&gt; 9</code></p><p id="0b5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df[‘Instrument status’].max()&gt;&gt; 9</code></p><p id="0bd2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df[‘Average value’].max() &gt;&gt; 6256</code></p><p id="2902" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的值没有一个接近分配的内存空间！！<strong class="is hj"> <em class="js">让我们更有效地重新分配内存</em> </strong>。</p><blockquote class="lf"><p id="8546" class="lg lh hi bd li lj lk ll lm ln lo jn dx translated">注意:作为一名开发人员，尤其是在使用DBMS时，知道或预测数据所能容纳的最大值总是很重要的</p></blockquote><p id="5c4b" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在本例中，我们读取了一个新的数据帧</p><p id="e935" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df_eff_memory = pd.read_csv(‘Measurement_info.csv’,sep=’,’,dtype={‘Station code’:’int8',’Item code’:’int8',’Instrument status’:’int8',<br/> ‘Average value’:’float16',’Measurement date’:’string’})</code></p><p id="65e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">df_eff_memory.memory_usage(index=False,deep=True)</code></p><pre class="kr ks kt ku fd kv kp kw kx aw ky bi"><span id="4939" class="kz la hi kp b fi lb lc l ld le">Measurement date     31080528<br/>Station code          3885066<br/>Item code             3885066<br/>Average value         7770132<br/>Instrument status     3885066</span></pre><p id="b713" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b"># total memory used<br/>df_eff_memory.memory_usage(index=False,deep=True).sum()</code></p><pre class="kr ks kt ku fd kv kp kw kx aw ky bi"><span id="7376" class="kz la hi kp b fi lb lc l ld le">50505858 bytes</span></pre><p id="c879" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js">约51MB </em> </strong>。这减少了<strong class="is hj"> 87.61% </strong>的内存使用！！！</p><p id="58ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 4。在MySQL中存储数据</strong></p><p id="183f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有时，我们希望集中管理和保护我们组织的数据。在这种情况下，我们将使用社区版本的MySQL。</p><p id="8202" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js"> a)让我们创建我们的凭证</em> </strong></p><p id="cea1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">db=’mysql’<br/>user=’db_admin’<br/>paswd=’db_admin_password'###SHOULD BE KEPT HIGHLY SECRETIVE!!!!<br/>host=’localhost’</code></p><p id="b678" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js"> b)创建连接对象</em> </strong></p><p id="afc8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">conn = sql.connect(db=db,user=user,host=host,password=paswd,use_unicode=True, <br/> charset=”utf8", auth_plugin=’mysql_native_password’)</code></p><p id="eba2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js"> c)创建光标读或写</em> </strong> <br/> <code class="du km kn ko kp b">cur = conn.cursor()</code></p><p id="1a8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js"> d)插入查询</em> </strong> <br/> <code class="du km kn ko kp b">measurement_insert_query = “””<br/>insert into measurement_info (measurement_date,average_value,instrument_status,measurement_item_info_id,<br/>measurement_station_info_id) values(%s,%s,%s,(select measurement_item_info.id from measurement_item_info <br/>where item_code = %s),(select measurement_station_info.id from measurement_station_info where station_code = %s))<br/>“””</code></p><p id="e95f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js"> e)数据插入</em> </strong></p><p id="6bda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">data = list(zip(df_eff_memory[‘Measurement date’],df_eff_memory[‘Average value’],df_eff_memory[‘Instrument status’],<br/> df_eff_memory[‘Item code’],df_eff_memory[‘Station code’]))</code></p><p id="690e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="js"> f)现在终于插入数据</em> </strong></p><p id="3bbd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">try:<br/> cur.executemany(measurement_insert_query,data)<br/> conn.commit()<br/> print(‘success’)</code></p><p id="ba2d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du km kn ko kp b">except (sql.Error,sql.Warning) as e:<br/> print(e)</code></p><pre class="kr ks kt ku fd kv kp kw kx aw ky bi"><span id="f1ba" class="kz la hi kp b fi lb lc l ld le"><strong class="kp hj">2055: Lost connection to MySQL server at 'localhost:3306', system error: 32 Broken pipe</strong></span></pre><blockquote class="jp jq jr"><p id="38be" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">等等！刚刚发生了什么！几分钟后，我们收到一个错误，尽管我们有效地利用了内存。似乎服务器厌倦了等待，关闭了连接，尽管我们没有在代码中要求这样做</p></blockquote></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="b6d4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 5。读取和插入数据的最后一步</strong></p><p id="506f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于我们无法将数据作为一个整体插入MySQL，我们将分块或小块插入。pandas在最初读取数据时提供了<strong class="is hj"> <em class="js"> chunksize </em> </strong>选项，因此我们需要编写某种迭代/循环来进行读写</p><figure class="kr ks kt ku fd ij"><div class="bz dy l di"><div class="lu lv l"/></div></figure><blockquote class="jp jq jr"><p id="8a35" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">这里我们一次读取10000行并写入数据库。在每次插入之后，我们还会得到一个成功的输出</p></blockquote><pre class="kr ks kt ku fd kv kp kw kx aw ky bi"><span id="5296" class="kz la hi kp b fi lb lc l ld le">success<br/>success<br/>success<br/>success<br/>success</span></pre><p id="b960" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们终于能够成功地读写<strong class="is hj">大数据</strong>到我们的数据库！！</p></div><div class="ab cl jw jx gp jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="hb hc hd he hf"><p id="8164" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi lw translated"><span class="l lx ly lz bm ma mb mc md me di"> B </span> onus</p><blockquote class="jp jq jr"><p id="a907" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated"><strong class="is hj">使用numpy矢量提高速度</strong></p></blockquote><p id="596c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">NumPy是用Python进行科学计算的基础包。通过对数据块进行小的调整，我们可以更快地读取数据。</p><p id="29ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你所需要做的就是在每个专栏的末尾添加<code class="du km kn ko kp b">to_numpy()</code></p><figure class="kr ks kt ku fd ij"><div class="bz dy l di"><div class="lu lv l"/></div></figure><h1 id="cd30" class="mf la hi bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">结论</h1><p id="796e" class="pw-post-body-paragraph iq ir hi is b it nc iv iw ix nd iz ja jb ne jd je jf nf jh ji jj ng jl jm jn hb bi translated">根据您使用的计算机，您的输出和内存使用可能与我的略有不同。</p><blockquote class="jp jq jr"><p id="c8c8" class="iq ir js is b it iu iv iw ix iy iz ja jt jc jd je ju jg jh ji jv jk jl jm jn hb bi translated">如果您无法完全读取数据，您可能处于<strong class="is hj"> <em class="hi"> BigData </em> </strong>区域。您应该考虑像pyspark这样的库，它们主要是为处理它们而构建的。</p></blockquote><p id="aa38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在用Python进行数据分析时，pandas是一个很好的工具。我仅仅触及了数据的表面，我鼓励你做更多的实验和研究。</p><p id="5b07" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">非常感谢你抽出时间。快乐编码:)</p><h1 id="061c" class="mf la hi bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">关于作者</h1><p id="13cd" class="pw-post-body-paragraph iq ir hi is b it nc iv iw ix nd iz ja jb ne jd je jf nf jh ji jj ng jl jm jn hb bi translated">James在信息技术(软件开发、数据科学和web开发)领域拥有超过15年的经验，在推动业务增长、领导力和组织效率领域的战略创新方面拥有丰富的经验和能力。他为网络和独立系统设计和构建数据分析和可视化算法。</p><p id="cdd3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">James还是一名飞行操作和调度员执照持有人，拥有超过7年的航空经验。他的职责是确保安全、安保、效率和应急标准始终得到执行。他还参与控制和协调航空公司整个航线网络(国际、地区和国内)的日常机队运营。</p></div></div>    
</body>
</html>