# 通过 30 个 SQL 查询学习数据分析

> 原文：<https://medium.com/analytics-vidhya/learn-data-analysis-with-30-sql-queries-2f791f5d4012?source=collection_archive---------0----------------------->

![](img/e602f5a17ca4ff563dd86b41642c36b4.png)

让我们用 SQL 做一些数据分析。查看我之前的[帖子](/analytics-vidhya/lets-do-some-data-analysis-with-sql-postgresql-71a861e23619)，在那里我用强大的 SQL 查询回答了 **30** 个有趣的问题。在这篇文章中，我准备了另外一组 **30 个**问题，我将带你解决它们。我将使用 DVD 租赁数据库中的下列表格。

*演员* ( **演员 id** ，名字，姓氏)

*影片* ( **film_id** ，片名，描述，上映年份，语言 _id，出租 _ 时长，出租 _ 费率，重置 _ 成本，评级)

f*ILM _ actor*(**film _ id，actor_id** )

客户(**客户标识**，名字，姓氏，地址标识)

付款(**付款标识**，客户标识，金额，日期)

地址( **address_id** ，街道，城市 _id，电话)

租赁(**租赁标识**，租赁日期，客户标识，库存标识)

库存(**库存标识**，胶片标识，商店标识)

使用 30 个查询，我将演示，自连接，自然连接，左和右外连接，子查询，联合，相交，差异，存在，不存在，成员运算符(in，not in)，分组，排序，聚合函数，汇总，正则表达式等。让我们开始娱乐吧。

1.  在 actor 表中是否有共享全名的 actor，如果有，显示这些共享名。

为了回答这个问题，首先我们需要知道 actor 表中是否有共享全名的 actor。因此，我将从计算分享全名的演员数量开始。

![](img/4baafafa55af8ca802bca0c46749b895.png)![](img/74c29d86a25db9f23c47643c206efe35.png)

结果显示，在 200 个演员中，我们有 199 个不同的演员全名，这意味着 2 个演员共享相同的全名。

现在，我要找出那个演员的名字。

![](img/4f91237e17df5eb812db96a4b77f98ae.png)![](img/b9de13a4a3f323f8e713581743653917.png)

如果我们在上面的查询中没有使用 **DISTINCT** ，我们会看到 Susan Davis 两次，因为它为两个不同的演员出现了两次。

2.**显示地址相同的客户名称(如丈夫和妻子)。**

为了回答这个问题，我们需要寻找多个具有相同 address_id 但不同 customer _ ids 的客户。这意味着我们将把客户表连接到它的自身( **self join** )。

![](img/7aedfc5a6d8c7d26b3f8b91ab0f27d5a.png)

**3。在付款表中显示所有客户支付的总金额。**

在这里，我将对付款表中的 amount 列使用聚合函数 **SUM()** 。

![](img/1e9a78da5ca607c20fd9dffa2aa4c21b.png)![](img/50931fc92829fe1650e1bfcb7118304d.png)

**4。在付款表中显示每个客户支付的总金额。**

![](img/b993e350e35592cd5c5832e050de2b5f.png)

以下是结果的示例:

![](img/3516d5606456c9b827a6a10a8bee6821.png)

**5。最高的总付款是多少？**

在这里，我对每个 customer_id 支付的金额进行了分组，然后计算了 **Sum()** ，对 total _ payments**进行了降序排序**，并仅选择了最高值(**限制** 1)。

![](img/de500d095a2b5a4ca608857c6c080f2d.png)![](img/926c6ddb36a5db2a7267198c3297a59e.png)

**6。支付总额最高的客户的名字是什么？**

为了回答这个问题，我编写了一个子查询来选择最大 total_payments，然后编写了另一个子查询来选择获得最大 total_payment 的 customer_id，然后编写了另一个查询来选择获得最大 total_payment 的客户的名字和姓氏。

![](img/e4c196bacc0dcd8b585557efdbe44aaf.png)

请注意，当我们想要对 GROUP BY 的结果设置条件时，具有的**与 GROUP BY 一起使用。**

![](img/41b229d8f8cd4a03e1c7db6f97d67701.png)

**7。租得最多的电影是什么？**

我将从选择每部电影和租借次数开始。对于租赁电影，在租赁表中保存一行。为了知道租了哪个 film_id，可以在 inventory_id 上连接租赁和库存表。

![](img/97a2b167f9280b018f296819f5640e90.png)

我将按**计数(film_id) DESC** 排序，然后选择最上面的第一行，这将是最大计数。

![](img/b4ef1b42520374cb9feefa7a49e07d31.png)![](img/560551499fb12e63043a1fc2a0b5db06.png)

一部电影被租借的最高次数是 34 次，现在的问题是哪部电影或哪套电影被租借了 34 次。

![](img/7032470c8066243c022bfb788f3332b4.png)![](img/330c20ca3523bbdd60a1ea9bcdd73787.png)

**8。到目前为止租了哪些电影。**

我们需要理解，电影表中的所有电影没有必要都已经租出去了。我编写了一个子查询来选择到目前为止租用的所有不同的 film _ ids。为此，我需要在公共列 inventory_id 上连接租赁和库存表。然后，如果电影的 id 在子查询选择的 film _ ids 集合中，我从电影表中选择电影的标题。

![](img/a5689036addcc4b723c0fce63819e9f4.png)![](img/2526fb779fe48395bec085e68afa121c.png)

当统计电影名称时，我们会发现 1000 部电影中有 958 部电影出现在结果中。

**9。哪些电影至今未租。**

![](img/34c4debb69cd7cf40e6c47acf985723d.png)![](img/fd3e3237632c7a441f6f4e676b230078.png)

在统计电影片名的时候，我们会发现至今有 42 部电影是不租的。

10.**哪些客户至今没有租借过任何电影。**

客户可能已经注册为 dvd 租赁店的客户，但是还没有开始租赁 DVD。

解决方案 1: 不在。

选择客户 id。

![](img/b72510fbff32ce90065b47902cc677ec.png)

选择客户名称。

![](img/797ae773c8bcb1e6c3e522912149f927.png)

**解决方案 2:** 不存在。

选择客户 id。

![](img/b7686dbf1c53c82476c0697938bba8c1.png)

选择客户名称。

![](img/35c8241b84ee5dccb50ff87d5dba9c91.png)

11。显示每部电影及其出租次数。

![](img/be958ef863c9f59acd164191dbdce2aa.png)

12。显示每个演员出演的电影数量。

![](img/107551c8336b6662fa948cedc212d025.png)

上面的查询返回演员 id 和他/她出演的电影数量。在下面的查询中，我将选择演员的名和姓。

![](img/a7369a8dc09c4a4d08b3e95ee75d91c3.png)

输出示例:

![](img/e28be04a05c7cc1f33a6320ac13de25c.png)

13。显示 20 多部电影中的演员姓名。

我使用了前一个问题中的相同查询，并添加了一个电影数量大于 20 部电影的条件。

![](img/e47d315091f4bd9d32820fb981d7793e.png)

输出示例:

![](img/981c26b742a0ff72431695e68fff8b61.png)

**14。有多少演员的名字只有 8 个字母？**

![](img/c6b98b7caef36948fdd007eaceb08dec.png)

输出示例:

![](img/c3343f58aaf3297027da9884f5e82e3c.png)

**15** 。**对于所有分级为“PG”的电影，给我看看这部电影以及它被租借的次数。**

我编写了一个子查询来选择到目前为止已经租出去的所有 film _ ids。为此，我需要在公共列 inventory_id 上连接租赁和库存表。我还需要得到每部电影的评分。为此，我需要在公共列 film_id 上连接 inventory 和 film 表。我只过滤了等级 I 等于“PG”的那些行。然后，我选择了每个 film_id 及其计数。

![](img/f3aa874be07d87ad2088a7fa8ed0986c.png)

输出示例:

![](img/fe61e52ab4bb982d542294c9a521b41e.png)

16。显示 store_id 1 中提供出租而 store_id 2 中不提供的电影。

![](img/d1151c2ca201d7c8bf542ad7110a404b.png)

**17。在两个商店 1 和 2 中的任何一个中显示提供出租的电影。**

我将选择 store_id 1 中提供出租的 film_id，并使用 **UNION** 将它们添加到 store_id 2 中提供出租的 film_id。

![](img/551cf5570972826794d138c0df50421b.png)

18。同时显示两个商店中提供的电影的电影名称。

**解决方案 1:**

![](img/cfe1eea47b20f9ddeefd545766c0c89c.png)

**解决方案 2:** 使用**相交**

![](img/a0d532662801f26f5a3a26c7d8ed165c.png)

**解决方案 3** :使用**存在**。

![](img/2b0531cb586313db27eb402df37ed8b0.png)

19。对于每个商店，显示属于该商店成员的客户数量。

![](img/fb9312e38f93f11948fce78cafa505c2.png)![](img/77c85384d733646d2ca4b57ea8b80ef2.png)

20。显示 store_id 为 1 的商店中租赁次数最多的电影的电影标题。

首先，我会检查每部电影在 store_id 1 中的租借次数。

![](img/77eede432ff120b4c2b0fb5faf25c436.png)

我看到一部电影被租借的次数最多是 20 次。我将选择租借 20 次的电影的所有电影名称。

![](img/b588002e9f07b522f86d6a1b28a36992.png)![](img/66b748811188c171970026c5246ba8ec.png)

21。商店里还有多少电影没有出租。只有 1 和 2 两家店。

首先，我们必须计算商店 1 和商店 2 中的电影数量。然后我们统计电影表中的电影数量。我们将两个计数相减。

![](img/d188fa47fa6facbc56ffffc531e6cbdf.png)

所有电影的数量是 1000 部电影，两家商店的电影数量是 958 部。1000–958 = 42 部电影。

**22。为多次租借电影 DVD 的客户显示 customer_id。**

要回答这个问题，我们首先需要知道每个客户租用的 film _ ids。我们需要连接两个表来获取信息。库存表中有 Film_id，租赁表中有租赁 id、租赁日期、客户 id，我们可以在库存 id 上连接它们。

![](img/668408376a4afb28898bdfde5a9e0b8d.png)

下一步，我们需要将上一个表的结果连接到自身(self join ),并找到客户是同一个人、租借的影片是同一部影片但租借日期不同的那些行，以表明客户不止一次租借了同一部影片。我使用带有语句的**创建了一个带有上述查询的表，我将它连接到自身，按 customer_id 分组，并选择每个 customer_id 和客户不止一次租用的电影的数量。**

![](img/303566c84c39e33544eff888964126f4.png)

**23。在每个评价下显示租借的电影数量。**

要回答这个问题，我们首先需要知道租赁的电影 id(连接租赁和库存表)和每部电影的评级(连接电影表)。这里使用了 RIGHT JOIN，这样我可以确保如果没有电影被租借给某个特定的分级类别，那么在结果中显示该分级时，计数为 0。

![](img/e857a88dea497df79b749db63391808b.png)![](img/ac05350ca303f4ef4933fcc5da17b122.png)

**24。显示商店 1 和商店 2 的利润。**

要回答这个问题，我们需要知道通过 join 租赁的每部电影的付款金额和 inventory_id(租赁和付款表)以及该租赁交易的 store _ id(join inventory 表)。我按每个 store_id 分组，并对支付的金额使用聚合函数 SUM()。

![](img/2006346b5d229044a6c2947dfb5d7069.png)![](img/754b225598a7a7647fc4623c89ddd17c.png)

25。 **显示商店 1 和商店 2 的利润，然后显示两家商店的总利润。**

我将使用上面相同的查询，并向其中添加 **ROLLUP** 。

![](img/136a185118e3b81fb5f799fe228a0daf.png)![](img/9ed020f1944f7befbb17f75d755d5018.png)

商店 1 的利润为 30628.91 美元，商店 2 的利润为 30683.13 美元，总利润为 61312.04 美元。

**26。数一数名字不是以 A 开头的演员的数量。**

![](img/cd2d25a2f546f225f452f56246fb71fe.png)![](img/81ceb7510856a73aaa5ceeb4e08e3e5b.png)

**27。查找以“P”开头，后跟任何其他字母(e 或 a)的演员的名字。**

我将使用 SIMILAR TO 来匹配以 P 开头的字符串，P 是字母 e 或 a，用(e|a)表示，%表示任何其他字符。

![](img/bbe9c2e9bfbe40c41281053d62bf4c65.png)![](img/b3ce4e4418b912abb9ed923f8b065a21.png)

**28。查找以“P”开头，后跟任意 5 个字母的客户名字。**

**解决方案 1:**

我将使用 SIMILAR TO 来匹配一个以 P 开头，后面跟五个(_)的字符串，每个 _ 代表一个字符。

![](img/8568c1b5db09272f15a294a0a1b0bbe4.png)

**解决方案 2:**

我将使用 SIMILAR TO 来匹配一个以 P 开头的字符串，后面是从 a 到 z 的五个字母，这是用方括号[a-z]将 a-z 括起来表示的，而{5}表示 5 个字母。

![](img/9314303d0db1b0afc4200168036461d6.png)

输出示例:

![](img/939dc36012c42987a7b8fc83415e148b.png)

29。查找以 PaRkEr 作为名字的演员，忽略字母大小写。然后选择名为 PaRkEr 的演员并匹配字母大小写。

选择名为 parker 的演员而忽略字母大小写

**Solution1** :我会用 **~*** 忽略字母大小写。

![](img/ffea434d77c72deae61041543918e805.png)

**解决方案 2:** 我将使用 **ilike** 来忽略字母大小写。

![](img/6674c005b2977c8058c68479a08f642e.png)

用于在匹配字母大小写时选择名为 PaRkEr 的演员。

**解决方案 1:** 我将使用~来匹配字母大小写

![](img/037886c5caa3f1b8cbc49fd5806476c9.png)

**解决方案 2:** 我会像使用一样使用**来忽略字母大小写。**

![](img/e2dbbdc65e3baf749950d393ad3a984c.png)

**解决方案 3** :使用比较运算符( **=** )。

![](img/3951f17b09ce362df3d3c4241ca4a688.png)

**三十。查找以“P”开头，后跟 a 到 e 中任何一个字母，然后是任何其他字母的演员姓名。**

我将使用 SIMILAR TO 来匹配以 P 开头的字符串，从 a 到 e 的字母将由[a-e]表示，%表示任何其他字符。

![](img/d493d23951cc29f9e67e053f22552597.png)![](img/0aeb45a485923954ebe6aa3a1778511e.png)

我希望你对这篇文章感兴趣，并且我能够以一种好的和清晰的方式展示这个主题。