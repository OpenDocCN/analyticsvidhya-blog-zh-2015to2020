<html>
<head>
<title>Dockerize Your Python Flask application and deploy it onto Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的 Python Flask 应用程序打包并部署到 Heroku 上</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/dockerize-your-python-flask-application-and-deploy-it-onto-heroku-650b7a605cc9?source=collection_archive---------2-----------------------#2020-12-03">https://medium.com/analytics-vidhya/dockerize-your-python-flask-application-and-deploy-it-onto-heroku-650b7a605cc9?source=collection_archive---------2-----------------------#2020-12-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/0b15d38040fb5a33f566cb6256efec3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*2VN3ZV84RGADRLu39KfbCA.jpeg"/></div></figure><p id="52bb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这篇博客中，我们可以看到如何将一个简单的 python flask 应用程序 dockerize 并将其部署到 Heroku 上。这篇博客假设你已经在你的电脑上安装了 Docker 和 Heroku。如果不是这样，可以从<a class="ae jk" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> <em class="jl">这里</em> </strong> </a>和<a class="ae jk" href="https://devcenter.heroku.com/articles/heroku-cli#download-and-install" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> <em class="jl">这里</em> </strong> </a>轻松安装。</p><p id="db3a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，创建一个新目录<code class="du jm jn jo jp b">my-dir</code>并在目录中移动。</p><p id="1cb8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建一个名为<code class="du jm jn jo jp b">app.py</code>的 python 文件，其中包含以下内容</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="5742" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">from flask import Flask, render_template<br/>import os</strong></span><span id="7d91" class="jy jz hi jp b fi ke kb l kc kd"><strong class="jp hj">app = Flask(__name__)</strong></span><span id="1fa5" class="jy jz hi jp b fi ke kb l kc kd"><strong class="jp hj">@app.route('/')<br/>def fun():<br/>    return render_template('index.html')</strong></span><span id="6490" class="jy jz hi jp b fi ke kb l kc kd"><strong class="jp hj">if __name__ == '__main__':<br/>    port = int(os.environ.get('PORT', 5000))<br/>    app.run(host='0.0.0.0', port=port, debug=True)</strong></span></pre><p id="8080" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建一个名为<code class="du jm jn jo jp b"><strong class="io hj">templates</strong></code>的新目录(在<code class="du jm jn jo jp b"><strong class="io hj">my-dir</strong></code> <strong class="io hj"> </strong>目录内)，并在其中创建一个名为<code class="du jm jn jo jp b"><strong class="io hj">index.html</strong></code> <strong class="io hj"> </strong>的 HTML 文件，内容如下。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="4077" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">&lt;!DOCTYPE html&gt;<br/>&lt;html lang="en"&gt;<br/>    &lt;head&gt;<br/>        &lt;title&gt;Document&lt;/title&gt;<br/>    &lt;/head&gt;<br/>    &lt;body&gt;<br/>        &lt;h1&gt;Successfully dockerized your python app&lt;/h1&gt;<br/>    &lt;/body&gt;<br/>&lt;/html&gt;</strong></span></pre><p id="6bb6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在用下面的内容创建一个<code class="du jm jn jo jp b"><strong class="io hj">requirements.txt</strong></code>。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="819b" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">Flask==1.1.1</strong></span></pre><p id="ab73" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，我们创建了一个基本的 flask 应用程序设置。现在，我们需要对应用程序进行归档。</p><h1 id="e336" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">创建 Dockerfile 文件</h1><p id="c37f" class="pw-post-body-paragraph im in hi io b ip lc ir is it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj hb bi translated">为了对我们的 python Flask 应用程序进行 docker 化，我们需要一个<strong class="io hj">Docker 文件</strong>，其中包含构建<strong class="io hj"> Docker 映像</strong>所需的指令，该映像包含创建一个可以在 Docker 平台上运行的<strong class="io hj"> docker 容器</strong>的指令集。</p><p id="0be3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">用以下内容创建一个名为<code class="du jm jn jo jp b"><strong class="io hj">Dockerfile</strong></code>(注意:没有任何扩展名)的文件。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="9625" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">FROM python:3.6-buster<br/>WORKDIR /app<br/>COPY requirements.txt .<br/>RUN pip install -r requirements.txt<br/>COPY . .<br/>CMD ["python", "app.py"]</strong></span></pre><p id="febb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于 Docker 文件中的每个指令/命令，Docker 图像生成器生成一个图像层，并将其堆叠在前面的图像层上，因此每一层仅包含来自其前面的层的变化。因此，如此获得的 Docker 图像是组成层的只读堆栈。</p><h2 id="1d8c" class="jy jz hi bd kg lh li lj kk lk ll lm ko ix ln lo ks jb lp lq kw jf lr ls la lt bi translated"><strong class="ak">逐行解释:</strong></h2><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="2b77" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">1. FROM python:3.6-buster</strong></span></pre><blockquote class="lu lv lw"><p id="4325" class="im in jl io b ip iq ir is it iu iv iw lx iy iz ja ly jc jd je lz jg jh ji jj hb bi translated">通过，我们可以在基础映像上构建所需的映像。这里我们选择的基础映像是 buster，它是一个<a class="ae jk" href="https://github.com/docker-library/python/blob/12d6c5c56a2d39defa4431cfaeed2b5581e05f19/3.6/buster/Dockerfile" rel="noopener ugc nofollow" target="_blank"> Docker 自己的“官方”python 映像</a>。这个映像本身很大，但这些包是通过其他官方 Docker 映像将使用的公共映像层安装的，因此总体磁盘使用率会很低。</p></blockquote><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="c4f8" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">2. WORKDIR /app</strong></span></pre><blockquote class="lu lv lw"><p id="abc5" class="im in jl io b ip iq ir is it iu iv iw lx iy iz ja ly jc jd je lz jg jh ji jj hb bi translated">设置当前工作目录。</p></blockquote><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="a48e" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">3. COPY requirements.txt .</strong></span></pre><blockquote class="lu lv lw"><p id="bc6d" class="im in jl io b ip iq ir is it iu iv iw lx iy iz ja ly jc jd je lz jg jh ji jj hb bi translated">将依赖关系文件从您的主机复制到当前工作目录。</p></blockquote><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="2443" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">4. RUN pip install -r requirements.txt</strong></span></pre><blockquote class="lu lv lw"><p id="f3d3" class="im in jl io b ip iq ir is it iu iv iw lx iy iz ja ly jc jd je lz jg jh ji jj hb bi translated">安装所有依赖项或 pip 包。</p></blockquote><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="9e49" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">5. COPY . .</strong></span></pre><blockquote class="lu lv lw"><p id="8dc4" class="im in jl io b ip iq ir is it iu iv iw lx iy iz ja ly jc jd je lz jg jh ji jj hb bi translated">将您的应用程序的其余源代码从您的机器复制到容器的当前工作目录中。</p></blockquote><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="bc9b" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">6. CMD ["python", "app.py"]</strong></span></pre><blockquote class="lu lv lw"><p id="4436" class="im in jl io b ip iq ir is it iu iv iw lx iy iz ja ly jc jd je lz jg jh ji jj hb bi translated">CMD 是在容器启动时运行的命令。它指定了映像中的一些元数据，这些元数据描述了如何运行基于该映像的容器。在这种情况下，它表示该映像要支持的容器化进程是 python app.py。每个 Dockerfile 只能有一个 CMD 命令，如果有更多，则最后一个 CMD 命令将生效。</p></blockquote><p id="cbdb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们已经完成了所有需要的源代码。目前，目录结构如下:</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="1593" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">my-dir<br/>      </strong>----<strong class="jp hj">app.py<br/>     </strong> ----<strong class="jp hj">templates<br/>              </strong>----<strong class="jp hj">index.html<br/>      </strong>----<strong class="jp hj">Dockerfile<br/>      </strong>----<strong class="jp hj">requirements.txt</strong> </span></pre><h1 id="dc3e" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">让我们创建 Docker 图像</h1><p id="909d" class="pw-post-body-paragraph im in hi io b ip lc ir is it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj hb bi translated">让我们在本地构建 Docker 映像，并运行以确保服务在本地运行。在终端中运行以下命令，从 my-dir 目录创建 docker 映像。<code class="du jm jn jo jp b">-<strong class="io hj">t</strong></code>标志用于给新创建的图像命名。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="40a7" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ docker image build -t my-app .</strong></span></pre><p id="1b34" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以上命令可能需要 16 分钟才能运行完毕，这取决于您的网速。</p><p id="3de6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行以下命令，验证您是否成功构建了 docker 映像。如果你看到你的图片(<code class="du jm jn jo jp b"><strong class="io hj">my-app</strong></code>)列在那里，那意味着你成功了。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="fe83" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ docker image ls</strong></span></pre><h1 id="aa97" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">运行 docker 容器</h1><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="218c" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ docker run -p 5000:5000 -d my-app</strong></span></pre><p id="51c5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在上面的命令中,<code class="du jm jn jo jp b">-<strong class="io hj">p</strong></code>标志用于向主机发布容器的端口。在这里，我们将 docker 容器中的端口 5000 映射到主机上的端口 5000，这样我们就可以访问位于<a class="ae jk" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> localhost:5000 </a>的应用程序，<code class="du jm jn jo jp b">-<strong class="io hj">d</strong></code>标志在后台运行容器，并打印<strong class="io hj"> <em class="jl">容器 ID </em> </strong> <em class="jl">。</em></p><p id="8539" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">检查<a class="ae jk" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> localhost:5000 </a>，如果您看到标题“<strong class="io hj">成功对接您的 python 应用程序”，</strong>那么我们成功对接了应用程序。</p><h2 id="0057" class="jy jz hi bd kg lh li lj kk lk ll lm ko ix ln lo ks jb lp lq kw jf lr ls la lt bi translated">停止并移除 docker 容器</h2><p id="4f3f" class="pw-post-body-paragraph im in hi io b ip lc ir is it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj hb bi translated">下面的命令停止并从 localhost:5000 中删除 dockerized 容器。<strong class="io hj">集装箱 id </strong>预先打印在终端上。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="f191" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ docker container stop &lt;container id&gt;<br/>$ docker system prune</strong></span></pre><h1 id="6bf0" class="kf jz hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">部署到 Heroku</h1><p id="cfcc" class="pw-post-body-paragraph im in hi io b ip lc ir is it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj hb bi translated">首先，您需要登录 Heroku CLI。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="084b" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ heroku container:login</strong></span></pre><p id="baed" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它将打开浏览器，并提示您使用 Heroku 凭证登录，如果您尚未登录，或者如果您已经在浏览器中登录了 Heroku 帐户，只需在新的浏览器选项卡上单击登录即可。</p><p id="e92e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果登录成功，您将会收到“登录成功<em class="jl">”消息。</em></p><p id="3c3e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行下面的命令在 Heroku 中创建一个应用程序，让 Heroku 准备好接收您的源代码。为您的应用程序输入任意名称。Heroku 不允许使用已经被使用的名字。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="e1da" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ heroku create &lt;name-for-your-app&gt;</strong></span></pre><p id="e4f9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，你会收到一个链接，</p><p id="f27d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jl"> https:// </em> <strong class="io hj"> <em class="jl"> &lt;为你的应用命名&gt;</em></strong><em class="jl">. heroku app . com/</em></p><p id="7983" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，运行下面的命令将容器推入 Heroku(下面的命令可能需要几个小时，这取决于您的网速)。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="4028" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ heroku container:push web --app &lt;name-for-your-app&gt;</strong></span></pre><p id="42fb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">。此时，docker 容器被推送到 Heroku，但没有部署或释放。以下命令将部署容器。</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="950d" class="jy jz hi jp b fi ka kb l kc kd"><strong class="jp hj">$ heroku container:release web --app &lt;name-for-your-app&gt;</strong></span></pre><p id="c2ca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，这款应用已经发布并在 Heroku 上运行，你可以在下面的网站上看到它</p><p id="5713" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jl"> https:// </em> &lt;为你的应用命名&gt; <em class="jl"> .herokuapp.com/ </em></p><p id="d508" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，我们成功地将 Python Flask 应用程序对接并部署到 Heroku 上。</p></div></div>    
</body>
</html>