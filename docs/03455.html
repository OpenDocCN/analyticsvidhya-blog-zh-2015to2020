<html>
<head>
<title>Aotpy 52x faster than Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Aotpy比Python快52倍</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/aotpy-52x-faster-than-python-2bda98ab5e57?source=collection_archive---------10-----------------------#2020-02-02">https://medium.com/analytics-vidhya/aotpy-52x-faster-than-python-2bda98ab5e57?source=collection_archive---------10-----------------------#2020-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b4b42c72ae7ecd89fbf0418bb844f18f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vVYLcaHD3cCx4Az1kZNWsA.png"/></div></div></figure><p id="9093" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">aotpy.py构建脚本将尝试提前编译您的python脚本。它生成一个新的TPython解释器，链接到您编译的AOT模块中。</p><figure class="jo jp jq jr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6d4ee6f67de5a346333aeb3c92c82e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOxJcL6TUsa8ZAwPfj4meg.png"/></div></div></figure><p id="f231" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Richards benchmark AOT兼容版本源代码<a class="ae js" href="https://gitlab.com/hartsantler/tpythonpp/blob/master/benchmarks/richards_AOT.py" rel="noopener ugc nofollow" target="_blank"> richards_AOT.py </a></p><h1 id="bf43" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">过敏症</h1><p id="2257" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated"><a class="ae js" href="https://gitlab.com/hartsantler/tpythonpp/blob/master/aotpy.py" rel="noopener ugc nofollow" target="_blank"> aotpy.py </a>默认使用Clang和PGO (profile guided optimization)。对于Richards基准测试，最终优化的构建比Python3快52倍，比PyPy快4倍。</p><p id="71d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">示例:</p><p id="71bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kw kx ky kz b">./atopy.py myscript.py</code></p><p id="21b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面将最终的可执行文件保存到<code class="du kw kx ky kz b">/tmp/myscript.py.bin</code></p><p id="69f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">AOT只支持python的一个静态子集，所有的类必须有唯一的成员和方法名，这样它们才能在一个<a class="ae js" href="https://en.wikipedia.org/wiki/Union_type" rel="noopener ugc nofollow" target="_blank">联合</a>中兼容。</p><p id="2ad9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以选择使用<code class="du kw kx ky kz b">#AOT begin</code>和<code class="du kw kx ky kz b">#AOT end</code>来标记你的代码块为AOT兼容。</p><h2 id="c79e" class="la ju hi bd jv lb lc ld jz le lf lg kd jb lh li kh jf lj lk kl jj ll lm kp ln bi translated">特应性vs努卡塔</h2><p id="3dfe" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">Nuikta 对Richards的翻译产生了25400行C代码。<a class="ae js" href="https://gitlab.com/hartsantler/tpythonpp/blob/master/aotpy.py" rel="noopener ugc nofollow" target="_blank"> Atopy.py </a>只输出613行C++。</p><pre class="jo jp jq jr fd lo kz lp lq aw lr bi"><span id="2e8e" class="la ju hi kz b fi ls lt l lu lv">def isHoldWait(self):<br/>  return self.tskholding or ((not self.pktpending) and self.tskwaiting)</span></pre><p id="122d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Aotpy将函数<code class="du kw kx ky kz b">isHoldWait</code>翻译成3行代码。特应性翻译:</p><pre class="jo jp jq jr fd lo kz lp lq aw lr bi"><span id="dc3c" class="la ju hi kz b fi ls lt l lu lv">tp_obj isHoldWait() {<br/>   return this-&gt;tskholding or ((not this-&gt;pktpending) and this-&gt;tskwaiting);<br/>  return None;}// end of function: isHoldWait</span></pre><p id="f604" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">函数<code class="du kw kx ky kz b">isHoldWait</code>由<a class="ae js" href="https://github.com/Nuitka/Nuitka" rel="noopener ugc nofollow" target="_blank"> Nuitka </a>翻译成220行代码。努特卡语翻译:</p><pre class="jo jp jq jr fd lo kz lp lq aw lr bi"><span id="d797" class="la ju hi kz b fi ls lt l lu lv">static PyObject *impl___main__$$$function_17_isHoldWait(struct Nuitka_FunctionObject const *self, PyObject **python_pars) {<br/>    // Preserve error status for checks<br/>#ifndef __NUITKA_NO_ASSERT__<br/>    NUITKA_MAY_BE_UNUSED bool had_error = ERROR_OCCURRED();<br/>#endif</span><span id="0ff4" class="la ju hi kz b fi lw lt l lu lv">// Local variable declarations.<br/>    PyObject *par_self = python_pars[0];<br/>    struct Nuitka_FrameObject *frame_cb2ffef26946a1662d24a216157d24ee;<br/>    NUITKA_MAY_BE_UNUSED char const *type_description_1 = NULL;<br/>    PyObject *tmp_return_value = NULL;<br/>    PyObject *exception_type = NULL;<br/>    PyObject *exception_value = NULL;<br/>    PyTracebackObject *exception_tb = NULL;<br/>    NUITKA_MAY_BE_UNUSED int exception_lineno = 0;<br/>    int tmp_res;<br/>    static struct Nuitka_FrameObject *cache_frame_cb2ffef26946a1662d24a216157d24ee = NULL;</span><span id="ad40" class="la ju hi kz b fi lw lt l lu lv">// Actual function body.<br/>    MAKE_OR_REUSE_FRAME(cache_frame_cb2ffef26946a1662d24a216157d24ee, codeobj_cb2ffef26946a1662d24a216157d24ee, module___main__, sizeof(void *));<br/>    frame_cb2ffef26946a1662d24a216157d24ee = cache_frame_cb2ffef26946a1662d24a216157d24ee;</span><span id="d8f6" class="la ju hi kz b fi lw lt l lu lv">// Push the new frame as the currently active one.<br/>    pushFrameStack(frame_cb2ffef26946a1662d24a216157d24ee);</span><span id="a9e7" class="la ju hi kz b fi lw lt l lu lv">// Mark the frame object as in use, ref count 1 will be up for reuse.<br/>    assert(Py_REFCNT(frame_cb2ffef26946a1662d24a216157d24ee) == 2); // Frame stack</span><span id="ff35" class="la ju hi kz b fi lw lt l lu lv">// Framed code:<br/>    {<br/>        int tmp_or_left_truth_1;<br/>        PyObject *tmp_or_left_value_1;<br/>        PyObject *tmp_or_right_value_1;<br/>        PyObject *tmp_source_name_1;<br/>        int tmp_and_left_truth_1;<br/>        PyObject *tmp_and_left_value_1;<br/>        PyObject *tmp_and_right_value_1;<br/>        PyObject *tmp_operand_name_1;<br/>        PyObject *tmp_source_name_2;<br/>        PyObject *tmp_source_name_3;<br/>        CHECK_OBJECT(par_self);<br/>        tmp_source_name_1 = par_self;<br/>        tmp_or_left_value_1 = LOOKUP_ATTRIBUTE(tmp_source_name_1, const_str_plain_tskholding);<br/>        if (tmp_or_left_value_1 == NULL) {<br/>            assert(ERROR_OCCURRED());</span><span id="6ea0" class="la ju hi kz b fi lw lt l lu lv">FETCH_ERROR_OCCURRED(&amp;exception_type, &amp;exception_value, &amp;exception_tb);</span><span id="006b" class="la ju hi kz b fi lw lt l lu lv">exception_lineno = 114;<br/>            type_description_1 = "o";<br/>            goto frame_exception_exit_1;<br/>        }<br/>        tmp_or_left_truth_1 = CHECK_IF_TRUE(tmp_or_left_value_1);<br/>        if (tmp_or_left_truth_1 == -1) {<br/>            assert(ERROR_OCCURRED());</span><span id="9054" class="la ju hi kz b fi lw lt l lu lv">FETCH_ERROR_OCCURRED(&amp;exception_type, &amp;exception_value, &amp;exception_tb);<br/>            Py_DECREF(tmp_or_left_value_1);</span><span id="1587" class="la ju hi kz b fi lw lt l lu lv">exception_lineno = 114;<br/>            type_description_1 = "o";<br/>            goto frame_exception_exit_1;<br/>        }<br/>        if (tmp_or_left_truth_1 == 1) {<br/>            goto or_left_1;<br/>        } else {<br/>            goto or_right_1;<br/>        }<br/>        or_right_1:;<br/>        Py_DECREF(tmp_or_left_value_1);<br/>        CHECK_OBJECT(par_self);<br/>        tmp_source_name_2 = par_self;<br/>        tmp_operand_name_1 = LOOKUP_ATTRIBUTE(tmp_source_name_2, const_str_plain_pktpending);<br/>        if (tmp_operand_name_1 == NULL) {<br/>            assert(ERROR_OCCURRED());</span><span id="21a1" class="la ju hi kz b fi lw lt l lu lv">FETCH_ERROR_OCCURRED(&amp;exception_type, &amp;exception_value, &amp;exception_tb);</span><span id="214d" class="la ju hi kz b fi lw lt l lu lv">exception_lineno = 114;<br/>            type_description_1 = "o";<br/>            goto frame_exception_exit_1;<br/>        }<br/>        tmp_res = CHECK_IF_TRUE(tmp_operand_name_1);<br/>        Py_DECREF(tmp_operand_name_1);<br/>        if (tmp_res == -1) {<br/>            assert(ERROR_OCCURRED());</span><span id="e48f" class="la ju hi kz b fi lw lt l lu lv">FETCH_ERROR_OCCURRED(&amp;exception_type, &amp;exception_value, &amp;exception_tb);</span><span id="1049" class="la ju hi kz b fi lw lt l lu lv">exception_lineno = 114;<br/>            type_description_1 = "o";<br/>            goto frame_exception_exit_1;<br/>        }<br/>        tmp_and_left_value_1 = (tmp_res == 0) ? Py_True : Py_False;<br/>        tmp_and_left_truth_1 = CHECK_IF_TRUE(tmp_and_left_value_1);<br/>        if (tmp_and_left_truth_1 == -1) {<br/>            assert(ERROR_OCCURRED());</span><span id="2924" class="la ju hi kz b fi lw lt l lu lv">FETCH_ERROR_OCCURRED(&amp;exception_type, &amp;exception_value, &amp;exception_tb);</span><span id="9114" class="la ju hi kz b fi lw lt l lu lv">exception_lineno = 114;<br/>            type_description_1 = "o";<br/>            goto frame_exception_exit_1;<br/>        }<br/>        if (tmp_and_left_truth_1 == 1) {<br/>            goto and_right_1;<br/>        } else {<br/>            goto and_left_1;<br/>        }<br/>        and_right_1:;<br/>        CHECK_OBJECT(par_self);<br/>        tmp_source_name_3 = par_self;<br/>        tmp_and_right_value_1 = LOOKUP_ATTRIBUTE(tmp_source_name_3, const_str_plain_tskwaiting);<br/>        if (tmp_and_right_value_1 == NULL) {<br/>            assert(ERROR_OCCURRED());</span><span id="b351" class="la ju hi kz b fi lw lt l lu lv">FETCH_ERROR_OCCURRED(&amp;exception_type, &amp;exception_value, &amp;exception_tb);</span><span id="1bd9" class="la ju hi kz b fi lw lt l lu lv">exception_lineno = 114;<br/>            type_description_1 = "o";<br/>            goto frame_exception_exit_1;<br/>        }<br/>        tmp_or_right_value_1 = tmp_and_right_value_1;<br/>        goto and_end_1;<br/>        and_left_1:;<br/>        Py_INCREF(tmp_and_left_value_1);<br/>        tmp_or_right_value_1 = tmp_and_left_value_1;<br/>        and_end_1:;<br/>        tmp_return_value = tmp_or_right_value_1;<br/>        goto or_end_1;<br/>        or_left_1:;<br/>        tmp_return_value = tmp_or_left_value_1;<br/>        or_end_1:;<br/>        goto frame_return_exit_1;<br/>    }</span><span id="b602" class="la ju hi kz b fi lw lt l lu lv">#if 0<br/>    RESTORE_FRAME_EXCEPTION(frame_cb2ffef26946a1662d24a216157d24ee);<br/>#endif</span><span id="2e72" class="la ju hi kz b fi lw lt l lu lv">// Put the previous frame back on top.<br/>    popFrameStack();</span><span id="9aeb" class="la ju hi kz b fi lw lt l lu lv">goto frame_no_exception_1;</span><span id="c3ff" class="la ju hi kz b fi lw lt l lu lv">frame_return_exit_1:;<br/>#if 0<br/>    RESTORE_FRAME_EXCEPTION(frame_cb2ffef26946a1662d24a216157d24ee);<br/>#endif</span><span id="6849" class="la ju hi kz b fi lw lt l lu lv">// Put the previous frame back on top.<br/>    popFrameStack();</span><span id="37b7" class="la ju hi kz b fi lw lt l lu lv">goto function_return_exit;</span><span id="1e61" class="la ju hi kz b fi lw lt l lu lv">frame_exception_exit_1:;</span><span id="b25f" class="la ju hi kz b fi lw lt l lu lv">#if 0<br/>    RESTORE_FRAME_EXCEPTION(frame_cb2ffef26946a1662d24a216157d24ee);<br/>#endif</span><span id="39fc" class="la ju hi kz b fi lw lt l lu lv">if (exception_tb == NULL) {<br/>        exception_tb = MAKE_TRACEBACK(frame_cb2ffef26946a1662d24a216157d24ee, exception_lineno);<br/>    }<br/>    else if (exception_tb-&gt;tb_frame != &amp;frame_cb2ffef26946a1662d24a216157d24ee-&gt;m_frame) {<br/>        exception_tb = ADD_TRACEBACK(exception_tb, frame_cb2ffef26946a1662d24a216157d24ee, exception_lineno);<br/>    }</span><span id="bdc4" class="la ju hi kz b fi lw lt l lu lv">// Attachs locals to frame if any.<br/>    Nuitka_Frame_AttachLocals(<br/>        (struct Nuitka_FrameObject *)frame_cb2ffef26946a1662d24a216157d24ee,<br/>        type_description_1,<br/>        par_self<br/>    );</span><span id="7a66" class="la ju hi kz b fi lw lt l lu lv">// Release cached frame.<br/>    if (frame_cb2ffef26946a1662d24a216157d24ee == cache_frame_cb2ffef26946a1662d24a216157d24ee) {<br/>        Py_DECREF(frame_cb2ffef26946a1662d24a216157d24ee);<br/>    }<br/>    cache_frame_cb2ffef26946a1662d24a216157d24ee = NULL;</span><span id="1d63" class="la ju hi kz b fi lw lt l lu lv">assertFrameObject(frame_cb2ffef26946a1662d24a216157d24ee);</span><span id="61e9" class="la ju hi kz b fi lw lt l lu lv">// Put the previous frame back on top.<br/>    popFrameStack();</span><span id="7574" class="la ju hi kz b fi lw lt l lu lv">// Return the error.<br/>    goto function_exception_exit;</span><span id="1d0e" class="la ju hi kz b fi lw lt l lu lv">frame_no_exception_1:;</span><span id="26f8" class="la ju hi kz b fi lw lt l lu lv">// Return statement must have exited already.<br/>    NUITKA_CANNOT_GET_HERE(__main__$$$function_17_isHoldWait);<br/>    return NULL;</span><span id="ebce" class="la ju hi kz b fi lw lt l lu lv">function_exception_exit:<br/>    CHECK_OBJECT(par_self);<br/>    Py_DECREF(par_self);    assert(exception_type);<br/>    RESTORE_ERROR_OCCURRED(exception_type, exception_value, exception_tb);</span><span id="a8b9" class="la ju hi kz b fi lw lt l lu lv">return NULL;</span><span id="3d5f" class="la ju hi kz b fi lw lt l lu lv">function_return_exit:<br/>   // Function cleanup code if any.<br/>    CHECK_OBJECT(par_self);<br/>    Py_DECREF(par_self);</span><span id="af06" class="la ju hi kz b fi lw lt l lu lv">// Actual function exit with return value, making sure we did not make<br/>   // the error status worse despite non-NULL return.<br/>   CHECK_OBJECT(tmp_return_value);<br/>   assert(had_error || !ERROR_OCCURRED());<br/>   return tmp_return_value;<br/>}</span></pre></div></div>    
</body>
</html>