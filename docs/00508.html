<html>
<head>
<title>Finding Waldo — Feature Matching for OpenCV in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">寻找Waldo——Python中OpenCV的特征匹配</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/finding-waldo-feature-matching-for-opencv-9bded7f5ab10?source=collection_archive---------0-----------------------#2019-07-14">https://medium.com/analytics-vidhya/finding-waldo-feature-matching-for-opencv-9bded7f5ab10?source=collection_archive---------0-----------------------#2019-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="475a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">1.介绍</h1><p id="7e62" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在本文中，我们将进行简单的特征匹配，以便在开始通过视频分析进行对象检测之前进行预热。我们将首先用静态图像做一些检测。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/2ffd07b2a51cd9eca3ad222604ca0477.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wCKISiDxA7bHzsR8xmfSwg.jpeg"/></div></div></figure><p id="0df9" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">《沃利在哪里》是一部很受欢迎的英国系列益智书，引起了儿童和成人的兴趣。找到Waldo从来都不容易，OpenCV有一种方法可以让我们快速找到Waldo:)</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><h1 id="a9b0" class="if ig hi bd ih ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc bi translated">2.用于模板匹配的概念</h1><p id="02a7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">OpenCV有一个函数，<strong class="jf hj"> cv2。MatchTemplate() </strong>支持模板匹配来识别目标图像。</p><p id="98fb" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">模板匹配是在源图像(输入)上滑动目标图像(模板)的思想。将模板与输入进行比较。匹配由输入中邻域像素与模板的匹配程度决定。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es le"><img src="../Images/541f54bbe39cb3e3f468e0dd20ac942d.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*kVybdvLGy84-e32T6e8sLQ.png"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">来源:<a class="ae lj" href="https://docs.opencv.org/2.4/doc/tutorials/imgproc/histograms/template_matching/template_matching.html" rel="noopener ugc nofollow" target="_blank">https://docs . opencv . org/2.4/doc/tutorials/img proc/histograms/template _ matching/template _ matching . html</a></figcaption></figure><p id="ea0b" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">关于如何确定相似性的计算，有各种方法。对于这个例子，我们将使用<strong class="jf hj"> TM。CCOEFF_NORMED </strong></p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lk"><img src="../Images/30bf66a62200116b20cffc1faadc64cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MouMPPYnxm6sLIS971lMqw.png"/></div></div></figure><p id="470c" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">模板补丁在具有该矩阵的输入上滑动，并且它确定将指示是否有匹配的分数。<strong class="jf hj"> TM_CCOEFF_NORMED找到模板的平均值，并将其与输入</strong>的平均值进行匹配。1分是完美匹配，-1分是糟糕匹配，0分是中性。</p><h1 id="7461" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">3.寻找沃尔多</h1><p id="faad" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">下面是我们将使用的图像，这将形成我们的输入！</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/2ffd07b2a51cd9eca3ad222604ca0477.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wCKISiDxA7bHzsR8xmfSwg.jpeg"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">这肯定是一团糟</figcaption></figure><p id="a3b7" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">现在，我们需要一个模板图像，当然是瓦尔多本人的照片。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es ll"><img src="../Images/199f6e604aec3d3290174feb3dcff5a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:48/format:webp/1*ZfDl6V4zC1_LaIwVDXeryA.png"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">这个人自己</figcaption></figure><pre class="kc kd ke kf fd lm ln lo lp aw lq bi"><span id="277d" class="lr ig hi ln b fi ls lt l lu lv">import cv2<br/>import numpy as np</span></pre><p id="f395" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">OpenCV需要的两个神圣库</p><pre class="kc kd ke kf fd lm ln lo lp aw lq bi"><span id="9bff" class="lr ig hi ln b fi ls lt l lu lv">img_rgb = cv2.imread('find_waldo.jpg')<br/>img_gray = cv2.cvtColor(img_rgb, cv2.COLOR_BGR2GRAY)<br/>template = cv2.imread('waldo.png',0)<br/>#saves the width and height of the template into 'w' and 'h'<br/>w, h = template.shape[::-1]</span></pre><p id="0f7f" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated"><em class="lw"> cv2.imread </em>读取图像，而<em class="lw"> cv2.cvtColor </em>将彩色图像转换为灰度。这就是我们通常如何在OpenCV中执行任何类型的操作，因为我们降低了图像的维度和复杂性。</p><pre class="kc kd ke kf fd lm ln lo lp aw lq bi"><span id="f8cb" class="lr ig hi ln b fi ls lt l lu lv">res = cv2.matchTemplate(img_gray,template,cv2.TM_CCOEFF_NORMED)<br/>threshold = 0.6<br/># finding the values where it exceeds the threshold</span></pre><p id="af2c" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated"><em class="lw"> cv2.matchTemplate() </em>是我们放入输入的函数，模板和我们使用的方法(上面解释过)。<strong class="jf hj">阈值是我们用来确定匹配的值，通常选择值0.8</strong>。我选择0.6是因为find_waldo图像中的大多数人看起来是多么的聚集和相似。</p><pre class="kc kd ke kf fd lm ln lo lp aw lq bi"><span id="4427" class="lr ig hi ln b fi ls lt l lu lv">loc = np.where( res &gt;= threshold)<br/>for pt in zip(*loc[::-1]):<br/>    #draw rectangle on places where it exceeds threshold<br/>    cv2.rectangle(img_rgb, pt, (pt[0] + w, pt[1] + h), (0,255,0), 2)</span><span id="3993" class="lr ig hi ln b fi lx lt l lu lv">cv2.imwrite('found_waldo.png',img_rgb)</span></pre><p id="e267" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">对于不熟悉的人来说，<em class="lw"> zip() </em>是python中的一个函数，将2个变量合并成1个元组。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es ly"><img src="../Images/9bc5385a3ea4229712e043b03646a490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EN9BZD5QM1Pi8xnBkzdFkQ.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">来源:<a class="ae lj" href="https://www.w3schools.com/python/showpython.asp?filename=demo_ref_zip" rel="noopener ugc nofollow" target="_blank">https://www.w3schools.com/python/showpython.asp?filename=demo_ref_zip </a></figcaption></figure><p id="1e2d" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">因此，我们正在尝试将宽度和高度合并成一个称为“pt”的元组。因此，我们将宽度pt[0]加上w，高度pt[1]加上h。</p><p id="91a1" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated"><em class="lw"> cv2。矩形</em>允许我们通过提供左下角和右上角的坐标来绘制矩形。</p><p id="b1e3" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">我们将这个结果写入一个名为found_waldo.png的PNG文件(:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/224b95c2ccc982113c55b74fb2df1662.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yzwl5p3OinA3DHlYxMe2tQ.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">我希望你能看到这张照片右上角的绿色矩形！</figcaption></figure><p id="90df" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">就这样，我们找到了瓦尔多/沃利，并通过在他周围画一个绿色的长方形来识别他！</p><p id="2877" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">完整代码如下，真的很短很甜。</p><pre class="kc kd ke kf fd lm ln lo lp aw lq bi"><span id="d21d" class="lr ig hi ln b fi ls lt l lu lv">import cv2<br/>import numpy as np<br/>from matplotlib import pyplot as plt</span><span id="8591" class="lr ig hi ln b fi lx lt l lu lv">img_rgb = cv2.imread('find_waldo.jpg')<br/>img_gray = cv2.cvtColor(img_rgb, cv2.COLOR_BGR2GRAY)<br/>template = cv2.imread('waldo.png',0)<br/># saves the width and height of the template into 'w' and 'h'<br/>w, h = template.shape[::-1]</span><span id="d7f2" class="lr ig hi ln b fi lx lt l lu lv">res = cv2.matchTemplate(img_gray,template,cv2.TM_CCOEFF_NORMED)<br/>threshold = 0.6<br/># finding the values where it exceeds the threshold<br/>loc = np.where( res &gt;= threshold)<br/>for pt in zip(*loc[::-1]):<br/>    #draw rectangle on places where it exceeds threshold<br/>    cv2.rectangle(img_rgb, pt, (pt[0] + w, pt[1] + h), (0,255,0), 2)</span><span id="35e9" class="lr ig hi ln b fi lx lt l lu lv">cv2.imwrite('found_waldo.png',img_rgb)</span></pre><h1 id="b140" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">4.附加注释</h1><p id="a5fb" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">模板匹配执行起来很有趣，但也有它的缺点。</p><p id="7666" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">简单模板匹配无法对旋转图像、翻转图像或任何其他方向的图像进行操作。</p><p id="e3cc" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">我们必须做<strong class="jf hj">多尺度</strong>来考虑这样的影响。</p><p id="4a34" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">虽然这很有趣，但在动态情况下(如视频)检测物体将被证明更有用。我期待着很快分享复杂的模板匹配，甚至视频中的对象检测。</p><p id="0959" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">与此同时，你可以先用一些你自己的图片和玩具进行简单的搭配。</p><p id="83da" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">你可以在我的github链接中获得带照片的完整代码:</p><p id="80fd" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">【https://github.com/k-choonkiat/TemplateMatching/tree/master T4】</p><h1 id="e698" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">参考</h1><ol class=""><li id="58c6" class="lz ma hi jf b jg jh jk jl jo mb js mc jw md ka me mf mg mh bi translated"><a class="ae lj" href="https://docs.opencv.org/trunk/dc/dc3/tutorial_py_matcher.html" rel="noopener ugc nofollow" target="_blank">https://docs . opencv . org/trunk/DC/dc3/tutorial _ py _ matcher . html</a></li></ol><p id="328f" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">2.<a class="ae lj" href="https://pdfs.semanticscholar.org/8ffd/b8a1f629a3bbbd1426206e09c7d9115b8f4b.pdf" rel="noopener ugc nofollow" target="_blank">https://pdfs . semantic scholar . org/8 ffd/b 8 a1f 629 a3 bbbd 1426206 e 09 c7d 9115 b 8 f4b . pdf</a></p><p id="2901" class="pw-post-body-paragraph jd je hi jf b jg kn ji jj jk ko jm jn jo kp jq jr js kq ju jv jw kr jy jz ka hb bi translated">3.<a class="ae lj" href="https://docs.opencv.org/2.4/doc/tutorials/imgproc/histograms/template_matching/template_matching.html" rel="noopener ugc nofollow" target="_blank">https://docs . opencv . org/2.4/doc/tutorials/img proc/histograms/template _ matching/template _ matching . html</a></p></div></div>    
</body>
</html>