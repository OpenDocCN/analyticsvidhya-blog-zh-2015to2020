<html>
<head>
<title>Keras Model to Frozen Model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Keras模型到冻结模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/keras-model-to-frozen-model-36514eadf3ec?source=collection_archive---------2-----------------------#2019-11-17">https://medium.com/analytics-vidhya/keras-model-to-frozen-model-36514eadf3ec?source=collection_archive---------2-----------------------#2019-11-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5cab6cdcb59c1a78e205db002e8b3364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7pArAqjZ4FTMskkO"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">萨法尔·萨法罗夫在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="b57c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Keras上的Stackoverflow或Github repository中，被问得最多的一个问题是模型转换。为了快速测试和容易获得图像分类器的预训练模型，大多数开发人员/研究人员倾向于使用Keras。使用Keras库可以轻松下载VGG16/19、Inception、Resnet等图像分类器模型。在大多数情况下，这些模型被用作主干架构。诸如图像定位和图像分割(Mask RCNN)的计算机视觉任务使用图像分类器模型作为骨干架构。</p><p id="43a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">来自Keras的图像分类器模型只能以h5格式保存，即Keras模型的原生格式。但是，当这个模型必须用于推理时，它应该是proto buffer格式[注意* h5模型可以使用flask]。</p><p id="ed07" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们直接进入代码。导入可以下载Keras模型(Inception)的Keras模块。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="f221" class="kc kd hi jy b fi ke kf l kg kh">import keras<br/>import json<br/>import os<br/>import sys<br/>import tensorflow as tf<br/>from keras.applications.inception_v3 import InceptionV3<br/>from keras.layers import Input</span></pre><p id="7172" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们创建一个目录，以Keras格式保存模型，以便稍后导入h5模型。这将说明在Keras中保存到模型和加载模型的方法。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="0a6a" class="kc kd hi jy b fi ke kf l kg kh">base_path = "/tmp/tfmodeldir/kerasmodel"<br/>inception_model = InceptionV3(weights=’imagenet’,    input_tensor=Input(shape=(299, 299, 3)))<br/>inception_model.save(os.path.join(base_path,’inception.h5'))</span></pre><p id="a6f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以转到base_path目录，查看模型是否已经保存。</p><p id="15cf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们将从您的磁盘中加载保存的h5格式的模型，并检查初始模型的概要(大型网络如此巨大的层概要)。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="8e04" class="kc kd hi jy b fi ke kf l kg kh">model = tf.keras.models.load_model(os.path.join(base_path, ‘inception.h5’))<br/>model.summary()</span><span id="fed1" class="kc kd hi jy b fi ki kf l kg kh">Model: "inception_v3"<br/>__________________________________________________________________________________________________<br/>Layer (type)                    Output Shape         Param #     Connected to                     <br/>==================================================================================================<br/>input_2 (InputLayer)            [(None, 299, 299, 3) 0                                            <br/>__________________________________________________________________________________________________<br/>conv2d_95 (Conv2D)              (None, 149, 149, 32) 864         input_2[0][0]                    <br/>__________________________________________________________________________________________________<br/>batch_normalization_95 (BatchNo (None, 149, 149, 32) 96          conv2d_95[0][0]<br/>.     .    .      .    .      .        .        .      .       .<br/>.     .    .      .    .      .        .        .      .       .<br/>avg_pool (GlobalAveragePooling2 (None, 2048)         0           mixed10[0][0]                    <br/>__________________________________________________________________________________________________<br/>predictions (Dense)             (None, 1000)         2049000     avg_pool[0][0]                   <br/>==================================================================================================<br/>Total params: 23,851,784<br/>Trainable params: 23,817,352<br/>Non-trainable params: 34,432</span></pre><p id="cb90" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同时，您可以检查加载的模型是否可以对输入图像进行预测。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="6c33" class="kc kd hi jy b fi ke kf l kg kh"><strong class="jy hj">from </strong>keras.applications.inception_v3 <strong class="jy hj">import </strong>decode_predictions</span><span id="5653" class="kc kd hi jy b fi ki kf l kg kh">image = load_img(<strong class="jy hj">'/tmp/elephant.jpg'</strong>, target_size=(224, 224))<br/>image = img_to_array(image)<br/>image = image.reshape(1, image.shape[0], image.shape[1], image.shape[2])<br/>image = preprocess_input(image)</span><span id="4989" class="kc kd hi jy b fi ki kf l kg kh">y_ = model.predict(image)<br/><br/>label = decode_predictions(y_)<br/>print(label[0][0])</span><span id="2398" class="kc kd hi jy b fi ki kf l kg kh">&gt;&gt;('n02504458', 'African_elephant', 0.71297616)</span></pre><p id="10ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Keras模型以71.298%的置信度预测“非洲象”。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="bce2" class="kc kd hi jy b fi ke kf l kg kh">tf.keras.backend.set_learning_phase(0)</span><span id="f698" class="kc kd hi jy b fi ki kf l kg kh">export_dir = os.path.join(‘/tmp/tfmodeldir/kerasmodel’, ‘1’)</span><span id="6811" class="kc kd hi jy b fi ki kf l kg kh">with tf.keras.backend.get_session() as sess:<br/> tf.saved_model.simple_save(sess, export_dir, <br/>                      inputs= {“keys”:model.input},<br/>                      outputs= {t.name: t for t in model.outputs})</span></pre><p id="0a86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要转换Keras model tp proto buffer (Pb)格式，让我们创建模型版本为“1”的输出路径，因为Tensorflow serving会查找版本号。</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div class="er es kj"><img src="../Images/2f851d5e27191c87e47e00108b618008.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*n2zl8IKvPlbK_m-0Hml14A.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">图:保存的incepetion _ v3冻结模型</figcaption></figure><p id="0b93" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用saved_model_cli检查保存的模型的签名定义。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="8dc0" class="kc kd hi jy b fi ke kf l kg kh">$ saved_model_cli show --dir /tmp/tfmodeldir/kerasmodel/1/ --all</span><span id="8703" class="kc kd hi jy b fi ki kf l kg kh">signature_def[‘serving_default’]:<br/> The given SavedModel SignatureDef contains the following input(s):<br/> inputs[‘keys’] tensor_info:<br/> dtype: DT_FLOAT<br/> shape: (-1, 299, 299, 3)<br/> name: input_3_2:0<br/> The given SavedModel SignatureDef contains the following output(s):<br/> outputs[‘predictions_4/Softmax:0’] tensor_info:<br/> dtype: DT_FLOAT<br/> shape: (-1, 1000)<br/> name: predictions_4/Softmax:0<br/> Method name is: tensorflow/serving/predict</span></pre><p id="07f3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">默认情况下，签名定义为“serving_default”。现在我们可以使用tensorflow_serving来服务冻结模型(inception_v3 pb模型)。</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/03a9207ba3319bac31ab3bfa202eec5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uKXpzSOUSpncbKZWQMbxAA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图:服务TensorFlow serving中的Inception_v3模型</figcaption></figure><p id="1666" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，如果服务运行良好，我们可以编写客户端部分。在这种情况下，我们不能只使用curl，不像在其他部分，我们可以使用curl从服务器进行推理。这里，我们需要图像特征提取，所以需要使用库来获取图像的特征。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="0df6" class="kc kd hi jy b fi ke kf l kg kh">from keras.preprocessing.image import load_img<br/>from keras.preprocessing.image import img_to_array<br/>from keras.applications.vgg16 import preprocess_input<br/>from keras.applications.vgg16 import decode_predictions<br/>import requests</span><span id="8e78" class="kc kd hi jy b fi ki kf l kg kh">image = load_img(‘/tmp/elephant.jpg’, target_size=(224, 224))<br/>image = img_to_array(image)<br/>image = image.reshape(1, image.shape[0], image.shape[1], image.shape[2])<br/>image = preprocess_input(image)</span><span id="dc81" class="kc kd hi jy b fi ki kf l kg kh">endpoint = “<a class="ae iu" href="http://localhost:8501/v1/models/inception:predict" rel="noopener ugc nofollow" target="_blank">http://localhost:8501/v1/models/inception:predict</a>"<br/>headers = {“content-type”:”application-json”}<br/>instances = image.tolist()<br/>data = json.dumps({“signature_name”:”serving_default”,”instances”: instances})<br/>response = requests.post(endpoint, data=data, headers=headers)<br/>prediction = json.loads(response.text)[‘predictions’]<br/>prediction[0].index(max(prediction[0]))</span><span id="de67" class="kc kd hi jy b fi ki kf l kg kh">&gt;&gt;916</span></pre><p id="2d3f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">输出是916，我们可以从inception class dictionary中导入类/标签，看看key 916的标签名称(值)是否是“African Elephant ”,就像上面的例子一样。</p></div></div>    
</body>
</html>