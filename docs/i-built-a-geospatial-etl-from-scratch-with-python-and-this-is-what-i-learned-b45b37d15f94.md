# 我用 python 建立了一个地理空间 ETL 管道，这就是我所学到的

> 原文：<https://medium.com/analytics-vidhya/i-built-a-geospatial-etl-from-scratch-with-python-and-this-is-what-i-learned-b45b37d15f94?source=collection_archive---------3----------------------->

![](img/538d9032af725efc02f99aea68ecb8d3.png)

最近，当我们在[道路生态实验室](https://www.ufrgs.br/nerf/?view=featured)被要求为 S [泰特公路公司](https://www.egr.rs.gov.br/inicial)提供公路死亡热点模型时，我面临了一个新的挑战。他们在寻找一种工具来收集现场数据，然后在地图上显示出来。我们谈论的是一个生物学家团队，他们每月一次在该州的大部分道路上行驶，并记录下他们能找到的所有路杀动物，然后将所有数据绘制在地图上，以便我们进行一些分析。

![](img/a424f5a219436c96d0bd594fe5a31ac8.png)

我处理的就是这种收银机。我知道看着超级震撼，所以我保证这将是这篇文章里唯一的一篇！

# 我在这里做什么？

在我们的第一次会面中，我准备向客户展示数据收集开源软件的选项，如 [ODK 收集](https://opendatakit.org/)和 [Kobo 工具箱](https://kf.kobotoo)。会议刚刚开始时，他们说他们已经有了一个工作数据收集应用程序，他们按月付费使用——我最近才知道这被称为 SaaS，“解决方案即服务”。

我们了解到他们的问题并不在于收集数据本身，而是他们的工作流程的每一部分都有几个工具，但是这些工具并没有相互连接。这意味着他们有一整个团队的人，主要是地理学家，致力于从数据收集应用程序下载数据，使用 QGIS 将数据分成多个部分，上传到 PostgreSQL 数据库，然后上传到地理服务器，以便以更具空间功能的格式提供数据，最后再上传到他们之前收购的地图可视化应用程序。

![](img/404bee99c1d2d0354c3e351e86df792b.png)

这家[公司的系统](http://www.infoambiente.stesa.com.br/egr)依赖于一个 PostGIS 数据库、Geoserver 和 OpenLayers 可视化，它们被很好地包装在一个 Laravel PHP 服务器上。我不知道这是怎么回事。

# 我到底要怎么做？

因此，当他们清楚需要一种工具来使数据在所有这些步骤中无缝流动时，我意识到我必须开始担心“我到底要怎么做？”。我知道许多 WebGIS 系统依赖于 PostGIS 数据库和地理服务器，但我从未真正使用过它。到目前为止， [Carto](https://translatorswithoutborders.org/language-diversity-in-the-covid-19-pandemic/) 、 [ArcGIS Online](https://codexremote.maps.arcgis.com/apps/opsdashboard/index.html#/bc74b62d8f8c4fb6a131ba580c5e4db8) 和[简单的传单脚本](http://plano-c.com/nobodyliveshere.html)对我来说已经很不错了！但这一次这些都没用。

无论如何，我必须从某个地方开始。我以前听说过 ETL 管道，但是这个概念对我来说不是很清楚。维基百科声明如下:

> 在[计算](https://en.wikipedia.org/wiki/Computing)、**提取、转换、加载** ( **ETL** )是将数据从一个或多个源复制到目标系统的一般过程，该目标系统以不同于源的方式或在不同于源的上下文中表示数据。[数据提取](https://en.wikipedia.org/wiki/Data_extraction)涉及从同类或异类来源提取数据；[数据转换](https://en.wikipedia.org/wiki/Data_transformation)通过[数据清洗](https://en.wikipedia.org/wiki/Data_cleansing)处理数据，并将其转换成合适的存储格式/结构，以便查询和分析；最后，数据加载描述了将数据插入到最终目标数据库中，例如[操作数据存储库](https://en.wikipedia.org/wiki/Operational_data_store)、[数据集市](https://en.wikipedia.org/wiki/Data_mart)、[数据湖](https://en.wikipedia.org/wiki/Data_lake)或数据仓库。

这听起来正是我必须要做的，但它仍然没有提供我应该如何做的答案。地理空间社区或多或少习惯于 [FME](https://www.safe.com/) ，这是一个专有软件，它可以帮助你在一个用户友好的图形界面中构建 ETL 管道，但是学习曲线有点陡。尽管 FME 有一些强大的工具，但是这些工具仍然需要你知道在每一步中你想要传递的参数。

![](img/7cd82bb24d1aac2134088a4d0d49e093.png)

这就是 FME ETL 流程的样子。老实说，没有我想象的那么友好。

我也很快意识到 python 中有许多库来执行这些操作，所以我觉得这是一个在解决现实世界问题的同时提高 python 水平的好机会。

所以我们有自己的问题和选择的工具。现在怎么办？我继续我的(真正的)架构师朋友最讨厌的步骤:软件架构。

通过一点谷歌搜索，不需要很好地理解我路线上的每一站，我可以建立一个模型来跟随。此时，我只需要知道我想做的事情是可能的，并且有 python 库可以完成这项工作。

![](img/58287fd949f8405ae7705a822d5c8c0e.png)

当我第一次画它的时候，它看起来像 f*一样可怕。

当我着手开始编码时，我发现仅仅使用一个好的文本编辑器——我总是喜欢使用[SublimeText](https://www.sublimetext.com/)——是不够的。我必须选择一个 [Python IDE](https://www.datacamp.com/community/tutorials/data-science-python-ide) 和一个环境管理器。什么-什么？

IDE 代表集成开发环境。这是一个编码工具，允许你以更简单的方式编写、测试和调试你的代码。最近闹得沸沸扬扬的一个 IDE 是 Jupyter Notebooks，它通过提供一个非常用户友好的界面吸引了许多新用户加入 python 社区，在这个界面中，您可以在同一个浏览器窗口中看到您的代码和结果，并且可以单独运行您的代码片段来找出问题所在。

![](img/3264be2ce4c8aa658a3cfbf4a09b2991.png)

这就是 Jupyter 笔记本的样子。一小段 python 代码，你可以在它下面看到结果。

在开始之前，我不得不选择的最后一件事是一个包管理器。使用 python 时，您可能需要使用非常复杂的函数来完成某些任务。好消息是，有人可能已经遇到了这个问题，并创建了一个您可以使用的功能包，就像您安装在机器上的软件一样，只是这些库只能通过代码访问。当你在你的机器上安装 python 的时候，它会自带`pip`，我之前用过。最近，一个名为 Conda 的新包管理器因致力于做比`pip`更多的事情而受到了很多关注；处理 Python 包的之外的库依赖*以及 Python 包本身。简而言之，它更安全，包装更好。所以我顺其自然。*

这意味着，对于我希望使用的每个包，我必须首先打开我的终端窗口并运行如下内容:

`$ conda install package-name`

# 我不敢相信我们还没有开始编码

所以。回到我们系统的架构。我们要做的第一件事就是从数据采集 app 中提取数据，这个 app 叫做 [Inventsys](https://www.inventsys.com.br/) 。这实际上是一个非常酷的系统，它使得创建一个新项目、分配现场工作人员和设计收集数据的表格变得非常容易。幸运的是，除了有一个用于实际数据收集和网络界面的移动应用程序，这个平台还有一个 RESTful API。我肯定你以前听说过这个术语，但是也许你和我一样，从来没有完全理解开发人员使用它的意思。

![](img/2fe819d3a0f684efd5635dc7ca107fb2.png)

一个很酷的系统来存储你所有的动物尸体的照片。

所以我去了维基百科:

> 一个**应用编程接口** ( **API** )是一个[计算接口](https://en.wikipedia.org/wiki/Interface_(computing))，它定义了多个软件中介之间的交互。它定义了可以进行的调用或请求的种类、如何进行、应该使用的数据格式、应该遵循的约定等等。**具象状态转移** ( **REST** )是一个[软件架构](https://en.wikipedia.org/wiki/Software_architecture) [风格](https://en.wikipedia.org/wiki/Architectural_style)，它定义了一组用于创建 [Web 服务](https://en.wikipedia.org/wiki/Web_service)的约束。符合 REST 架构风格的 Web 服务被称为 RESTful Web 服务，提供互联网上计算机系统之间的互操作性。

不是很有帮助，至少对我来说。基本上，这意味着我们可以通过向系统发送某些消息，使用一组预定义的规则来与该应用程序及其数据进行交互。例如，我可以向 Inventsys 发送一个调用，对其说*“嘿，* `GET` *给我一份你存储在那里的所有项目的列表”*，或者“`GET` *给我上个月注册的所有动物”。*基本上，我们通常可以对 RESTful APIs 进行五种类型的调用:`GET`、`POST`、`PUT`、`PATCH`和`DELETE`，它们被称为 HTTP 方法。

# 步骤 1:访问 RESTful API

我当时必须做的是查阅 Inventsys API 文档，检查哪些方法是允许的，以及为了得到有效的响应我必须提供哪些参数。这就清楚了:我必须发出一个`POST`调用来发送我的登录凭证，作为交换，我必须使用这个令牌来进行所有后续调用。这个特定的 API 要求用户和密码包含在*主体有效载荷*中，并且帐户名作为*头*传递。最后，为了用 python 进行这些调用，我使用了`requests`包。

虽然我只与“*动物保护计划*合作，但 Inventsys 应用程序实际上存储了更多不同用例的数据，如道路资产监控计划。这意味着如果我想获取我感兴趣的寄存器，我必须准确地告诉 API 我想要的寄存器属于哪个项目和类别。我实际上使用了一个叫做 iPyWidgets 的东西，这样用户就可以从列表中选择那些变量，但是为了简单起见，我在这里只展示一个使用预定义值的例子。

它所做的是向 API 发送一个`GET`调用，使用一个现在有我们的令牌的新头，告诉它获取特定项目和类别中的寄存器。这里的问题是这个 API 构建在一个分页结构中，所以如果我们只发送一次请求，我们将只得到前 50 个寄存器。因为我们需要获取所有的数据，所以我们必须遍历所有的页面。

我决定用一个`while`循环来实现，这是 python 中许多类似 C 的结构之一。我费了很大的劲才弄明白这一点，但是声明`while`T3 意味着循环将无限期运行，直到循环中的某个东西`return`或`break`。然后在里面，我用`except`运行了一个`try`，这是一个做一些事情和处理异常的好方法，这些异常是你期望你的代码可能产生的错误。如果请求成功并且不为空(因此检查长度是否等于零)，这将把越来越多的数据追加到`registros`数组中。

这是我们请求的内容。`registros`列表由一个`json`结构填充，该结构包含我们的脚本可以用给定参数找到的所有项目。这是单个寄存器的样子:

# 步骤 2:上传到 PostgreSQL

好的，太好了！现在我有了我需要的数据。ETL 中的 *E* 被征服！剩下的能有多难？跟着来。我的架构计划告诉我要做的下一件事是将这些数据上传到 PostGIS 数据库。但是这到底意味着什么呢？我知道在某些时候有一头大象参与其中。

> PostGIS 是对象关系数据库的空间数据库扩展器。它增加了对地理对象的支持，允许在 SQL 中运行位置查询。

所以 PostgreSQL 是一种连接 SQL 数据库的方法，它使用关系模型——即行和列。PostGIS 允许我们有一个额外的列，其中纬度和经度不仅仅是数字，而是被视为存在于给定坐标系中某处的实际几何图形。从更实际的角度来说，这意味着我们必须找到一种方法，将我们从 API 接收到的`json`文件——该文件由“标签”构成，如`'field': 'id', 'value': '123'`——转换成一种关系格式，其中的字段是已知的。

为了做到这一点，我使用一个本地托管的 SQL 数据库进行测试，为了与它通信，我将使用一个名为`psycopg2`的 python 库。所以我要做的第一件事就是建立一个到本地数据库的连接。这并不太难，只需要说出数据库、用户和端口的名称，瞧，我就连接上了。

接下来，我需要在数据库中创建一个新表，以便存储我提取的数据。我不得不选择我真正想要的字段，并记下它们的类型——整型、实型、文本型…——每一个字段都应该真正为我提供一些新的对数据库管理人员工作的欣赏。这无疑是整件事最乏味的部分。

我实际上创建了多个函数，每个函数都有适合每种类型寄存器的模式。例如，只有团队安装的相机陷阱有一个名为“相机 ID”的字段，所以我需要一个表模式来专门存储相机陷阱寄存器，等等。为了简单起见，我在这里只包括其中一个函数。

您会注意到我正在做的第一件事是在我的数据库中创建 PostGIS 扩展。这是为了确保当我需要开始做空间功能时，它会明白我在问什么。我接下来要做的是使用我之前创建的光标，它建立了到我的本地数据库的连接，首先删除数据库中与我在这里创建的名称相同的任何现有表(它是项目 ID 和类别 ID 变量的组合)，然后创建一个具有该名称的新表，其中包含该特定资产感兴趣的字段。在 SQL 中实现这一点的另一种方法是使用`UPDATE`方法，这样我们就不需要事先对表进行`DROP`。

现在我需要用 API 提供的 json 中的数据填充这个新表。这样做的问题是必须使用动态生成的值运行 SQL 命令。在`psycopg2`中，我们必须非常小心如何处理这些价值。对于我们实际插入的数据，我们可以使用占位符，比如字符串数据的`$s`。但是对于表名，我们希望字符串存储在`tablename`变量中，我们必须使用`.format()`方法。之后，就像在公园里散步一样，只需循环`registros`列表中的每一项，并运行一个`INSERT`函数将它存储在我之前创建的表中。

我可以从我的 pgAdmin 控制台看到它工作了，现在表中有一些记录了！

![](img/618da8aa8886cea32a6eb2bf735c35b0.png)

如果您对此不熟悉，pgAdmin 是一个用于 PostgreSQL 数据库的数据库管理系统。

在接下来的步骤中，我还需要确保这些记录不仅是表格形式的，还是空间数据。为此，我们需要使用 PostGIS 扩展。

# 步骤 3:使用 PostGIS 转换数据

人们可能会认为我已经开始转换我的数据，但这是它变得空间化的时候。在我们的最终目的地，用于可视化数据的 Infoambiente WebGIS 系统，所有资产和登记册都以特定的方式存储:每条道路都是一个特定的特许区(对于处理收费管理、维修工程，当然还有道路死亡清除的公司)，因此我们的数据必须分成与道路特许区一样多的部分。我们只需使用 PostGIS 就可以做到这一点！

首先，我们的注册表需要被空间化。为此，我们将简单地告诉我们的 SQL 数据库更新我们的表，并在 4326 坐标系中创建新的`geom`字段，以存储点几何数据，并从我们先前填充的`latitude`和`longitude`字段创建这些点。

一旦我运行了代码 snipet，我继续检查 pgAdmin 上的同一个表，令我惊讶的是，它竟然工作了！我现在可以用 pgAdmin 的几何图形查看器查看数据了。

![](img/331d3255b590103b03fc3ae2bd03f9b1.png)

从版本 4.0 开始，pgAdmin 引入了一个几何查看器选项卡，可以轻松检查几何是否在正确的位置。

接下来，我获取了一个 shapefile，其中包含了哪条道路属于哪个特许区的信息，并通过使用 QGIS 简单地将 50 米的缓冲区应用到每一边。我接下来要做的是告诉我的 Postgres 数据库类似这样的事情:"*取所有与这些缓冲道路相交的点，并用您找到的点*为每个让步创建新的表"。这是缓冲道路的样子:

长话短说，我必须(1)为缓冲道路创建一个新表，(2)在我的 python 脚本中获取我从 QGIS 导出的 geojson，(3)用来自 Github 的 *geojson* 填充特许权的新表，最后(4)找到注册和特许权之间的交叉点，并为每个特许权创建注册表的子集。

# 第四步:发送到地理服务器

也许有必要先解释一下“我们为什么要使用地理服务器？”。基本上，如果我们想用任何常见的 javascript 库，如 **OpenLayers** 或 **Leaflet** 构建一个 webmap，我们完全可以直接访问我们的 PostGIS 数据库，并将数据绘制到地图上。这种方法的问题是，最终我们获取的数据可能会变得足够大，从而降低浏览器的速度。因此，大多数 WebGIS 页面依赖于 OGC(开放地理空间联盟)格式，这种格式将数据作为服务提供，使其更轻便、更快捷。

因此，要访问为 InfoAmbiente OpenLayers 地图提供信息的 Geoserver 实例，我有两个选择:使用名为`gsconfig`的包，这意味着 API 可以调用任何 Geoserver 实例；或者再次使用`requests`。我最终不得不使用混合方法，因为有些功能被`gsconfig`团队很好地记录了，而有些没有。

为了使用`gsconfig`，我必须建立一个*数据存储*连接。Geoserver 的工作方式是:每个图层服务都必须属于一个工作空间和一个数据存储。*数据存储库*基本上是 Geoserver 了解数据来源的方式，因此在我们的例子中，*数据存储库*应该拥有连接到我的 PostGIS 数据库所需的所有信息。

所以我所要做的就是创建一个小循环，将我刚刚创建的所有表格上传到同名的*服务层*。除了那些可能已经存在于服务器中的内容，在这种情况下，我需要刷新数据存储，以便将对 PostGIS 数据库所做的更改考虑在内。最后一部分说明了必须使用`requests`进行的调用，因为在`gsconfig`文档中没有很好地记录刷新功能。因此，我的循环基本上是尝试创建一个新的图层服务，如果它发现一个异常(比如已经存在的图层)，它会简单地刷新数据存储。

# 步骤 5:将图层上传到 OpenLayers WebGIS 应用程序

我们快完了！对于这最后一部分，我需要让这些层出现在 [InfoAmbiente](http://www.infoambiente.stesa.com.br/egr) 应用程序的层列表中。由 [Codex Remote](http://codexremote.com.br) 开发的这个 webapp 是一个非常好的产品，而且，我相信你已经注意到了，它是基于 PostGIS+Geoserver 数据存储的。整个事情被很好地包装在一个 Laravel(一个 PHP 框架)服务器中，其中驻留了一个 OpenLayers webmap 和一个文件树结构。

![](img/45bee3933a7d23ff9fbe05198cd77cbd.png)

这是您登录时 Infoambiente 界面的外观。

这最后一点需要我挖掘一下，看看这个应用程序在做什么。该界面基本上要求用户使用文件树结构进行导航，选择或创建一个文件夹，并创建一个到 geoserver 服务层的新连接，以便在您下次登录时它会嵌套在该文件夹下。相当整洁。

使用 Chrome 的开发工具，我可以看到当一个新的层被添加到一个文件夹中时，一个调用被调用到 PHP 服务器，就像我到目前为止一直在做的`POST`调用一样！

![](img/2bdbfc97e4dc7184425cc985e3d0b716.png)

Chrome developer 的工具没有得到足够的好评，它救了我很多次。

这意味着我所要做的就是适应 InfoAmbiente 服务器所需的*报头*和*有效载荷*，这样我就可以自动从 Geoserver 上传新的服务层。*嗯*，是的。只不过事情没有那么简单。首先，我必须登录到应用程序，并获得一个令牌。但是这里我们并没有像之前的 Inventsys 系统那样处理一个记录良好的 REST API。在这里，我必须猜测服务器在期待什么，以及它把我需要的数据放在哪里。

StackOverflow 的人告诉我，发送我的凭证应该会给我提供一个 X-CSRF 令牌，这在使用**Laravel**框架开发的应用程序中很常见。问题是，这还不是全部。Laravel 应用程序实际上存储了两个令牌，一个是在头中传递的 CSRF 令牌，这很好，另一个是作为 cookie 传递的 XSRF 令牌！这不是那么容易访问的，所以我不得不使用`requests`中的`.session()`方法，它为我们处理 cookies！

其工作方式是:首先，我必须发送一个请求来启动一个有效的会话，并接收 CSRF 令牌，这样，我就可以在一个新的调用中发送我的凭证，这产生了新的 cookiess，我替换了以前的 cookie。

有了这两个令牌，我可以 ***最终*** 向`tree`端点发送一个`GET`请求，现在我可以开始在树结构中寻找自己的路了。

对最后一个请求的响应是树状文件夹结构中存在的所有文件夹、文件和层。问题是:为了上传新图层，我需要执行的`POST`请求实际上使用了包含文件夹的“node”属性，所以我不能使用道路或程序的名称来进行正确的调用。

![](img/667c08f7b2b61642703ef0fc9ef4bd05.png)

我想出的动态查找节点的代码可能不是很优雅，而且比它需要的还要长。但是，它确实有效。我使用了大量的`if`进行循环，这使得它相当慢。**因此，如果你有任何更好的方法来实现这一点的建议，给我写信吧！**

一旦我成功地识别出每个道路特许权文件夹的节点，只需循环遍历所有特许权，然后将所有图层上传到 webapp，或者在出现异常的情况下，只需刷新即可。

而且还管用！

![](img/7a9dcb2d4c0b07bbbc37bc22c05af289.png)

我通过 python 发布的新图层现在显示在树结构中的右文件夹下。耶！

# 那我学到了什么？

我只想说这对我来说是一段不寻常的旅程。我一周只有一天时间做这个项目，所以我花的时间比预期的要长。但这让每一步都更值得去完成。这是我的一条建议:

1.  无论你要构建什么，都要有一个简单的架构草图和伪代码。我应该知道，严格来说我还是个建筑师。这帮助我从一周到下一周跟踪我的工作。
2.  Jupyter 笔记本是一个非常棒的工具，它让我更容易进入 python。但是要小心，因为正如您从我的代码片段中注意到的，它不鼓励您编写我们应该经常使用的函数。
3.  这整件事让我爱上了 python，更讨厌 javascript。正确地猜测事情要容易得多，我也不必太担心符号。
4.  我觉得这段代码有些可重用，因为 REST-PostGIS-Geoserver 例程是相当常见的数据工程管道。不过，我确实觉得我应该在未来更多地关注像 FME 或 ArcGIS 数据互操作性这样的工具。

# 下一步是什么？

这非常酷，但让我们面对现实:我的最终用户厌倦了为了将图层上传到在线地图而执行繁琐的任务，他们可能不喜欢每天运行 python 脚本和处理环境。因此，所有这些代码都必须制作成一个 web 应用程序，具有更好的可用性和友好的界面。应该很容易吧？不对。

在寻找将一个简单的 python 脚本转换成 python web 应用程序的方法时，我意识到这是困扰许多开发人员的事情。基本上，有两种选择:

*   如果你的脚本足够简单——比如，你只是在一个笔记本电脑单元中运行一个简单的数据科学模型，你想向非技术人员展示——你可以使用像 [Voilà](https://blog.jupyter.org/and-voil%C3%A0-f6a2c08a4a93) (它可以当场将你的 Jupyter 笔记本转换成一个应用程序)、 [App Mode](https://github.com/oschuett/appmode) 或 [Streamlit](https://docs.streamlit.io/en/stable/index.html) 这样的工具。
*   我们的用例实际上是一个非常普通(和自然)的用例，其中用户有一些输入小部件，然后在用户点击确认按钮之后对它们执行一些计算，然后提供更多的小部件用于进一步的计算。为了在 web 应用程序中实现这一点，我们需要处理会话，因为我不希望两个并发用户创建的变量混淆在一起。因此，对于该用例，我们基本上有 [web.py](https://webpy.org/) 、Dj [ango](https://www.djangoproject.com/) 和 [Flask](https://flask.palletsprojects.com/en/1.1.x/) 。

我已经决定使用 Flask，因为它似乎比 Django 简单，但比 web.py 更好记录。当我有时间的时候，我可能会写一篇关于它的新帖子！与此同时，当系统里出现新的车祸时，我会在这里努力不让自己哭出来。