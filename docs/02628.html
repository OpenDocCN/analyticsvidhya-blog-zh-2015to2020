<html>
<head>
<title>Fast Inference: TFLite GPU Delegate!!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">快速推断:TFLite GPU Delegate！！</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/fast-inference-tflite-gpu-delegate-3e83f83d5b92?source=collection_archive---------5-----------------------#2019-12-26">https://medium.com/analytics-vidhya/fast-inference-tflite-gpu-delegate-3e83f83d5b92?source=collection_archive---------5-----------------------#2019-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ab4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在边缘设备上运行推理，尤其是在移动设备上，要求非常高。当你有一个非常大的机器学习模型时，用有限的资源进行推理是一项非常关键的任务。</p><p id="b39c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很多移动设备尤其是移动设备都有GPU之类的硬件加速器。Tensorflow Lite Delegate有助于优化我们的训练模型，并充分利用硬件加速的优势。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/a5967e7730a855bcfdd1c763ba34dbae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/0*6YFmgWhXuNfJ-AnE"/></div></figure><h2 id="f830" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">什么是Tensorflow Lite Delegate？</h2><p id="314f" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">委托人的工作，一般来说，是将你的工作委托或转移给某人。TensorFlow Lite支持多种硬件加速器。</p><blockquote class="kl"><p id="d0af" class="km kn hi bd ko kp kq kr ks kt ku jc dx translated">TensorFlow Lite委托是一种将部分或全部图形执行委托给另一个执行器的方式。</p></blockquote><h1 id="1361" class="kv jm hi bd jn kw kx ky jr kz la lb jv lc ld le jy lf lg lh kb li lj lk ke ll bi translated">为什么应该使用委托？</h1><p id="85e9" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">由于移动设备的处理、内存和电源有限，在边缘设备上运行计算密集型深度学习模型的推理需要大量资源。一些设备不依赖于设备CPU，而是具有硬件加速器，如GPU或DSP(数字信号处理)，从而实现更好的性能和更高的能效。</p><h2 id="d4c5" class="jl jm hi bd jn jo jp jq jr js jt ju jv iq jw jx jy iu jz ka kb iy kc kd ke kf bi translated">【TFLite委托如何工作？</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lm"><img src="../Images/21fa9b253955a5c053b6d1362293bdac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/0*KLATFGckb4zGyTxW.png"/></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">TFLite委托如何工作。tensorflow.org</figcaption></figure><p id="55da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们考虑一下上面的图表。它有一个输入节点，我们将在那里获得用于推理的输入。我们将让输入节点通过卷积运算，然后均值运算，它使用这两个运算的输出来计算平方差。</p><p id="74f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们有一个硬件加速器，可以非常快速高效地执行Conv2d和均值运算，上图如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lr"><img src="../Images/7d60ccd22af914056a98cc2394193334.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/0*QXmZhfZS_5kW3oay.png"/></div></figure><p id="6bdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我们将使用TFLite delegator将conv2d和mean这两个操作委托给专门的硬件加速器。</p><blockquote class="ls lt lu"><p id="c9e4" class="if ig lv ih b ii ij ik il im in io ip lw ir is it lx iv iw ix ly iz ja jb jc hb bi translated">TFLite GPU delegator会将操作委托给GPU delegator(如果可用)。</p></blockquote><p id="04ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TFLite允许我们为特定的操作提供委托，在这种情况下，图将被分割成多个子图，每个子图由一个委托处理。由委托处理的每个子图都将被替换为一个节点，该节点在其被调用的调用中评估该子图。根据模型的不同，最终的图可能以一个节点或多个节点结束，这意味着所有的图都被委托或者多个节点处理子图。通常，您不希望由代理处理多个子图，因为每次从代理切换到主图时，将结果从子图传递到主图都会有开销。</p><blockquote class="kl"><p id="dc83" class="km kn hi bd ko kp kq kr ks kt ku jc dx translated">共享内存不总是安全的。</p></blockquote><h1 id="a32e" class="kv jm hi bd jn kw kx ky jr kz la lb jv lc ld le jy lf lg lh kb li lj lk ke ll bi translated">如何添加代理人？</h1><ol class=""><li id="ce89" class="lz ma hi ih b ii kg im kh iq mb iu mc iy md jc me mf mg mh bi translated">定义一个负责评估代理子图的内核节点。</li><li id="920d" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">创建TfLiteDelegate的实例，该实例将注册内核并声明委托可以执行的节点。</li></ol><h1 id="9855" class="kv jm hi bd jn kw kx ky jr kz la lb jv lc mn le jy lf mo lh kb li mp lk ke ll bi translated">安卓系统:</h1><p id="4733" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated"><a class="ae mq" href="https://www.tensorflow.org/lite/performance/gpu" rel="noopener ugc nofollow" target="_blank"> Tensorflow已经为android提供了一个演示应用</a>:</p><p id="dd6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的应用程序中，如上添加AAR，导入<code class="du mr ms mt mu b"><strong class="ih hj">org.tensorflow.lite.gpu.GpuDelegate</strong></code>模块，并使用<code class="du mr ms mt mu b"><strong class="ih hj">addDelegate</strong></code>函数向解释器注册GPU委托</p><pre class="je jf jg jh fd mv mu mw mx aw my bi"><span id="30db" class="jl jm hi mu b fi mz na l nb nc">import org.tensorflow.lite.Interpreter;<br/>import org.tensorflow.lite.gpu.GpuDelegate;<br/><br/>// Initialize interpreter with GPU delegate<br/>GpuDelegate delegate = new GpuDelegate();<br/>Interpreter.Options options = (new Interpreter.Options()).addDelegate(delegate);<br/>Interpreter interpreter = new Interpreter(model, options);<br/><br/>// Run inference<br/>while (true) {<br/>  writeToInput(input);<br/>  interpreter.run(input, output);<br/>  readFromOutput(output);<br/>}<br/><br/>// Clean up<br/>delegate.close();</span></pre><h1 id="62d8" class="kv jm hi bd jn kw kx ky jr kz la lb jv lc mn le jy lf mo lh kb li mp lk ke ll bi translated">iOS:</h1><p id="4d0c" class="pw-post-body-paragraph if ig hi ih b ii kg ik il im kh io ip iq ki is it iu kj iw ix iy kk ja jb jc hb bi translated">包含GPU delegate头，并调用<code class="du mr ms mt mu b"><strong class="ih hj">Interpreter::ModifyGraphWithDelegate</strong></code>函数向解释器注册GPU delegate:</p><pre class="je jf jg jh fd mv mu mw mx aw my bi"><span id="7806" class="jl jm hi mu b fi mz na l nb nc">#import "tensorflow/lite/delegates/gpu/metal_delegate.h"<br/><br/>// Initialize interpreter with GPU delegate<br/>std::unique_ptr&lt;Interpreter&gt; interpreter;<br/>InterpreterBuilder(*model, resolver)(&amp;interpreter);<br/>auto* delegate = NewGpuDelegate(nullptr);  // default config<br/>if (interpreter-&gt;ModifyGraphWithDelegate(delegate) != kTfLiteOk) return false;<br/><br/>// Run inference<br/>while (true) {<br/>  WriteToInputTensor(interpreter-&gt;typed_input_tensor&lt;float&gt;(0));<br/>  if (interpreter-&gt;Invoke() != kTfLiteOk) return false;<br/>  ReadFromOutputTensor(interpreter-&gt;typed_output_tensor&lt;float&gt;(0));<br/>}<br/><br/>// Clean up<br/>interpreter = nullptr;<br/>DeleteGpuDelegate(delegate);</span></pre><p id="b227" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注:- </strong></p><blockquote class="kl"><p id="785f" class="km kn hi bd ko kp kq kr ks kt ku jc dx translated">一些在CPU上微不足道的操作对GPU来说可能成本很高。</p></blockquote><p id="8dfd" class="pw-post-body-paragraph if ig hi ih b ii nd ik il im ne io ip iq nf is it iu ng iw ix iy nh ja jb jc hb bi translated"><strong class="ih hj">参考链接:</strong></p><p id="9aaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae mq" href="https://www.tensorflow.org/lite/performance/gpu" rel="noopener ugc nofollow" target="_blank">https://www.tensorflow.org/lite/performance/gpu</a></p><p id="9474" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae mq" href="https://maheshwar-ligade.medium.com/" rel="noopener"> <strong class="ih hj">更多此类故事</strong> </a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ni"><img src="../Images/c3483e8de3850dc66f25cf74a9ea53b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*53oQo6UVNJHRBrT-.png"/></div></figure><p id="8659" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">下面我们连线上</strong><a class="ae mq" href="http://stackoverflow.com/users/3187349/maheshwar-ligade" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">stack overflow</strong></a><strong class="ih hj">，</strong><a class="ae mq" href="https://in.linkedin.com/in/maheshwar-ligade-14447841" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">LinkedIn</strong></a><strong class="ih hj">，</strong> <a class="ae mq" href="https://www.facebook.com/maheshwar.ligade" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">脸书</strong></a><strong class="ih hj">&amp;</strong><a class="ae mq" href="https://twitter.com/MaheshwarLigade" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Twitter</strong></a><strong class="ih hj">。</strong></p></div></div>    
</body>
</html>