<html>
<head>
<title>JWT(JSON Web Token) With DRF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JWT(JSON网络令牌)与DRF</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/jwt-json-web-tokens-for-drf-e091931c2193?source=collection_archive---------2-----------------------#2019-11-09">https://medium.com/analytics-vidhya/jwt-json-web-tokens-for-drf-e091931c2193?source=collection_archive---------2-----------------------#2019-11-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/41a2207a8527c6eb4a0bfcb3a369a4fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzVd5KDGwtqATl0FUsxT3w.jpeg"/></div></div></figure><h1 id="a8a9" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">部分概述</h1><ul class=""><li id="59ed" class="jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated">构建django项目。</li><li id="d9bb" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">定义新闻内容模型和管理。</li><li id="35be" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">配置新闻内容api。</li><li id="3e02" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">身份验证和权限。</li><li id="1d13" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">添加JWT(JSON Web令牌)。</li><li id="63e7" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">招摇博士。</li></ul><p id="a012" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated"><a class="ae lc" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌</a>是客户端/服务器应用程序使用的基于令牌的认证，其中客户端是使用。JWT是基于令牌的认证的流行实现。</p><p id="63a3" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">在本文中，我们将使用它来验证JWT与Django REST框架一起使用的用户。创建新闻内容时，只有当前登录的用户才能对自己的新闻内容进行读写操作。</p><h1 id="6854" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">第一节。构建Django项目</h1><p id="49b2" class="pw-post-body-paragraph kl km hi jq b jr js ko kp jt ju kr ks jv ld ku kv jx le kx ky jz lf la lb kb hb bi translated">首先安装<code class="du lg lh li lj b">Django</code>、<code class="du lg lh li lj b">Django REST Framework(DRF)</code>和<code class="du lg lh li lj b">django-cors-headers (CORS)</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="9b5c" class="ls ir hi lj b fi lt lu l lv lw">$ pip install django django-rest-framework django-cors-headers</span></pre><p id="07ec" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">然后，创建一个新的项目文件夹(<code class="du lg lh li lj b">news_contents/</code>)。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="a4fe" class="ls ir hi lj b fi lt lu l lv lw">$ mkdir news_contents<br/>$ cd news_contents</span></pre><p id="9b05" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">创建venv( <code class="du lg lh li lj b">virtual environment</code>)并激活它。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="035e" class="ls ir hi lj b fi lt lu l lv lw">$ python -m venv venv<br/>$ source venv/bin/activate</span></pre><p id="4b39" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">现在，构建一个django项目(<code class="du lg lh li lj b">core</code>)。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="1b24" class="ls ir hi lj b fi lt lu l lv lw">$ django-admin startproject core<br/>$ cd core</span></pre><p id="160e" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">创建一个<code class="du lg lh li lj b">newscontents</code> app。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="3f6f" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py startapp newscontents<br/>$ python manage.py migrate</span></pre><p id="188f" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">我们现在将配置django项目，在<code class="du lg lh li lj b">core/settings.py</code>中使用<code class="du lg lh li lj b">CORS</code>和<code class="du lg lh li lj b">DRF</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="5b68" class="ls ir hi lj b fi lt lu l lv lw"># Application definition</span><span id="bbd9" class="ls ir hi lj b fi lx lu l lv lw">INSTALLED_APPS = [<br/>    ....<br/>    'rest_framework',<br/>    'corsheaders',<br/>    'newscontents',<br/>]</span><span id="6010" class="ls ir hi lj b fi lx lu l lv lw">MIDDLEWARE = [<br/>    ....<br/>    'corsheaders.middleware.CorsMiddleware',<br/>]</span><span id="293c" class="ls ir hi lj b fi lx lu l lv lw">CORS_ORIGIN_ALLOW_ALL = True</span><span id="c713" class="ls ir hi lj b fi lx lu l lv lw">REST_FRAMEWORK = {<br/>    'DEFAULT_PERMISSION_CLASSES':['rest_framework.permissions.AllowAny'],<br/>    'DEFAULT_PARSER_CLASSES': ['rest_framework.parsers.JSONParser'],<br/>}</span></pre><p id="6a50" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">让我们运行服务器。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="b183" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py runserver<br/>Watching for file changes with StatReloader<br/>Performing system checks...</span><span id="75cc" class="ls ir hi lj b fi lx lu l lv lw">System check identified no issues (0 silenced).<br/>November 08, 2019 - 07:24:30<br/>Django version 2.2.7, using settings 'core.settings'<br/>Starting development server at http://127.0.0.1:8000/<br/>Quit the server with CONTROL-C.</span></pre><h1 id="f48d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">第二节。定义<code class="du lg lh li lj b">NewsContent</code>模型和管理员</h1><p id="0503" class="pw-post-body-paragraph kl km hi jq b jr js ko kp jt ju kr ks jv ld ku kv jx le kx ky jz lf la lb kb hb bi translated">在<code class="du lg lh li lj b">core/newscontents/models.py</code>中创建<code class="du lg lh li lj b">NewsContent</code>模型。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="7f7d" class="ls ir hi lj b fi lt lu l lv lw">from django.conf import settings<br/>from django.contrib.auth import get_user_model<br/>from django.db import models</span><span id="99a5" class="ls ir hi lj b fi lx lu l lv lw">USER_MODEL = get_user_model()</span><span id="29c1" class="ls ir hi lj b fi lx lu l lv lw">class NewsContent(models.Model):<br/>    reporter = models.ForeignKey(<br/>        to=USER_MODEL,<br/>        on_delete=models.CASCADE,<br/>        related_name='news_contents',<br/>    )<br/>    headline = models.CharField(max_length=255)<br/>    body = models.TextField()</span><span id="7a2b" class="ls ir hi lj b fi lx lu l lv lw">    def __str__(self):<br/>        return self.headline</span></pre><p id="ad4b" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">运行迁移。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="2233" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py makemigrations<br/>$ python manage.py migrate</span></pre><p id="2432" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated"><code class="du lg lh li lj b">core/newscontents/admin.py</code>中<code class="du lg lh li lj b">NewsContent</code>模型的管理站点。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="49d4" class="ls ir hi lj b fi lt lu l lv lw">from django.contrib import admin<br/>from .models import NewsContent</span><span id="6234" class="ls ir hi lj b fi lx lu l lv lw">admin.site.register(NewsContent)</span></pre><p id="7688" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">创建一个超级用户。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="234d" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py createsuperuser<br/>Username: reporter<br/>Email address: reporter@example.com<br/>Password: <br/>Password (again):<br/>Superuser created successfully.</span></pre><p id="f9cb" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">让我们再次启动服务器。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="3566" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py runserver<br/>Watching for file changes with StatReloader<br/>Performing system checks...</span><span id="38b3" class="ls ir hi lj b fi lx lu l lv lw">System check identified no issues (0 silenced).<br/>November 08, 2019 - 07:35:23<br/>Django version 2.2.7, using settings 'core.settings'<br/>Starting development server at http://127.0.0.1:8000/<br/>Quit the server with CONTROL-C.</span></pre><h1 id="894f" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">第三节。配置<code class="du lg lh li lj b">News Content</code> API</h1><p id="bcbe" class="pw-post-body-paragraph kl km hi jq b jr js ko kp jt ju kr ks jv ld ku kv jx le kx ky jz lf la lb kb hb bi translated">添加一些URL，以便我们可以访问<code class="du lg lh li lj b">core/urls.py</code>中的新闻内容API。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="1082" class="ls ir hi lj b fi lt lu l lv lw">....<br/>from django.urls import include, path</span><span id="54e4" class="ls ir hi lj b fi lx lu l lv lw">urlpatterns = [<br/>    ....<br/>    path('api/', include('newscontents.urls')),<br/>]</span></pre><p id="2c3a" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">然后，在<code class="du lg lh li lj b">newscontents/serializers.py</code>中为<code class="du lg lh li lj b">NewsContent</code>模型创建一个序列化器。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="38ea" class="ls ir hi lj b fi lt lu l lv lw">from rest_framework import serializers<br/>from .models import NewsContent<br/></span><span id="b00f" class="ls ir hi lj b fi lx lu l lv lw">class NewsContentSerializer(serializers.ModelSerializer):<br/>    class Meta:<br/>        fields = ('id', 'reporter', 'headline', 'body')<br/>        model = NewsContent</span></pre><p id="6c23" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">接下来，我们将在<code class="du lg lh li lj b">newscontents/views.py</code>中创建视图。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="3c69" class="ls ir hi lj b fi lt lu l lv lw">from rest_framework import viewsets<br/>from .models import NewsContent<br/>from .serializers import NewsContentSerializer</span><span id="b0b9" class="ls ir hi lj b fi lx lu l lv lw">class NewsContentViewSet(viewsets.ModelViewSet):<br/>    queryset = NewsContent.objects.all()<br/>    serializer_class = NewsContentSerializer</span></pre><p id="f17d" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">在<code class="du lg lh li lj b">newscontents/urls.py</code>中创建URL。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="5065" class="ls ir hi lj b fi lt lu l lv lw">from django.urls import path<br/>from rest_framework.routers import SimpleRouter<br/>from .views import NewsContentViewSet</span><span id="3453" class="ls ir hi lj b fi lx lu l lv lw">router = SimpleRouter()<br/>router.register('news-content', NewsContentViewSet, base_name="news_content")<br/>urlpatterns = router.urls</span></pre><h1 id="406b" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">第四节。身份验证和权限</h1><p id="a793" class="pw-post-body-paragraph kl km hi jq b jr js ko kp jt ju kr ks jv ld ku kv jx le kx ky jz lf la lb kb hb bi translated">首先，在管理面板中创建一个新用户。然后，在<code class="du lg lh li lj b">core/urls.py</code>中添加下面一行。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="fae5" class="ls ir hi lj b fi lt lu l lv lw">urlpatterns = [<br/>    ....<br/>    path('auth/', include('rest_framework.urls')),<br/>]</span></pre><p id="0f77" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">然后，运行到服务器，我们将创建一个新用户，并从管理面板输入新闻内容。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="6349" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py runserver<br/>Watching for file changes with StatReloader<br/>Performing system checks...</span><span id="fd77" class="ls ir hi lj b fi lx lu l lv lw">System check identified no issues (0 silenced).<br/>November 08, 2019 - 11:08:55<br/>Django version 2.2.7, using settings 'core.settings'<br/>Starting development server at http://127.0.0.1:8000/<br/>Quit the server with CONTROL-C.</span></pre><p id="1d4e" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">您可以通过登录然后转到<code class="du lg lh li lj b"><a class="ae lc" href="http://localhost:8000/api/news-content/." rel="noopener ugc nofollow" target="_blank">http://localhost:8000/api/news-content/</a></code> <a class="ae lc" href="http://localhost:8000/api/news-content/." rel="noopener ugc nofollow" target="_blank">来验证这一点。</a></p><p id="3c85" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">我们已经用<code class="du lg lh li lj b">AllowAny</code>配置了rest_framework。因此，每个用户都可以访问新闻内容。现在，我们需要换成你的<code class="du lg lh li lj b">core/settings.py</code>文件:</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="542b" class="ls ir hi lj b fi lt lu l lv lw">REST_FRAMEWORK = {<br/>    'DEFAULT_PERMISSION_CLASSES': ["rest_framework.permissions.IsAuthenticated",],<br/>    'DEFAULT_PARSER_CLASSES': ['rest_framework.parsers.JSONParser'],<br/>}</span></pre><p id="5797" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">我们需要在<code class="du lg lh li lj b">newscontents/views.py</code>中进行更改，以确保用户只能看到自己的<code class="du lg lh li lj b">News Contents</code>对象，并将用户设置为<code class="du lg lh li lj b">News Contents</code>对象的报告者。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="c8a7" class="ls ir hi lj b fi lt lu l lv lw">from rest_framework import permissions, viewsets<br/>from rest_framework.exceptions import PermissionDenied</span><span id="fd09" class="ls ir hi lj b fi lx lu l lv lw">from .models import NewsContent<br/>from .serializers import NewsContentSerializer</span><span id="bc97" class="ls ir hi lj b fi lx lu l lv lw">class IsReporter(permissions.BasePermission):<br/>    def has_object_permission(self, request, view, obj):<br/>        return obj.reporter == request.user</span><span id="8096" class="ls ir hi lj b fi lx lu l lv lw">class NewsContentViewSet(viewsets.ModelViewSet):<br/>    serializer_class = NewsContentSerializer<br/>    permission_classes = (IsReporter,)</span><span id="e0e5" class="ls ir hi lj b fi lx lu l lv lw">    # Ensure a user sees only own News Content objects.<br/>    def get_queryset(self):<br/>        user = self.request.user<br/>        if user.is_authenticated:<br/>            return NewsContent.objects.filter(reporter=user)<br/>        raise PermissionDenied()</span><span id="a4da" class="ls ir hi lj b fi lx lu l lv lw">    # Set user as owner of a NewsContents object.<br/>    def perform_create(self, serializer):<br/>        serializer.save(owner=self.request.user)</span></pre><p id="2d4c" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">如果你访问<code class="du lg lh li lj b">http://localhost:8000/api/news-content/</code>，你应该只能看到属于当前登录用户的新闻内容。因此，我们可以从<code class="du lg lh li lj b">newscontents/serializers.py</code>中的序列化程序中删除报告字段:</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="55c3" class="ls ir hi lj b fi lt lu l lv lw">from rest_framework import serializers<br/>from .models import NewsContent</span><span id="0e40" class="ls ir hi lj b fi lx lu l lv lw">class NewsContentSerializer(serializers.ModelSerializer):<br/>    class Meta:<br/>        fields = ('id', 'headline', 'body')<br/>        model = NewsContent</span></pre><p id="7964" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">我们已经配置了身份验证和权限。但是DRF仍然使用会话认证。现在我们将使用Json令牌认证(JWT)。</p><h1 id="87f0" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">第五节。添加JWT(JSON Web令牌)</h1><p id="b27e" class="pw-post-body-paragraph kl km hi jq b jr js ko kp jt ju kr ks jv ld ku kv jx le kx ky jz lf la lb kb hb bi translated">我们将使用一个库(<code class="du lg lh li lj b">djangorestframework_simplejwt</code>)。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="4d15" class="ls ir hi lj b fi lt lu l lv lw">$ pip install djangorestframework_simplejwt</span></pre><p id="37b9" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">我们将其添加到<code class="du lg lh li lj b">core/settings.py</code>中的<code class="du lg lh li lj b">DEFAULT_AUTHENTICATION_CLASSES</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="2119" class="ls ir hi lj b fi lt lu l lv lw">REST_FRAMEWORK = {<br/> 'DEFAULT_PERMISSION_CLASSES':["rest_framework.permissions.IsAuthenticated"],<br/>    'DEFAULT_PARSER_CLASSES': ['rest_framework.parsers.JSONParser'],<br/>    'DEFAULT_AUTHENTICATION_CLASSES': [<br/>        'rest_framework.authentication.SessionAuthentication',<br/>        'rest_framework_simplejwt.authentication.JWTAuthentication',<br/>       ],<br/>}</span></pre><p id="a7e0" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">在<code class="du lg lh li lj b">core/urls.py</code>中增加api的<code class="du lg lh li lj b">token</code>和令牌的<code class="du lg lh li lj b">refresh</code>的新端点。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="7e92" class="ls ir hi lj b fi lt lu l lv lw">from rest_framework_simplejwt.views import TokenObtainView, TokenRefreshView</span><span id="0d2b" class="ls ir hi lj b fi lx lu l lv lw">urlpatterns = [<br/>    ....<br/>    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain'),<br/>    # get a new token before the old expires.<br/>    path('api/token/refresh/', TokenRefreshView.as_view, name='token_refresh'),<br/>]</span></pre><h1 id="01c4" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">用户注册</h1><p id="71bd" class="pw-post-body-paragraph kl km hi jq b jr js ko kp jt ju kr ks jv ld ku kv jx le kx ky jz lf la lb kb hb bi translated">我们需要新的终端用户可以注册。现在为<code class="du lg lh li lj b">jwtauth</code>创建一个新的应用。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="6533" class="ls ir hi lj b fi lt lu l lv lw">$ python manage.py startapp jwtauth</span></pre><p id="0037" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">在<code class="du lg lh li lj b">core/settings.py</code>中添加app。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="b889" class="ls ir hi lj b fi lt lu l lv lw">INSTALLED_APPS = [<br/>    ....<br/>    'jwtauth',<br/>]</span></pre><p id="8935" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">然后，我们将为<code class="du lg lh li lj b">User</code>模型创建一个新的序列化程序。添加<code class="du lg lh li lj b">jwtauth/serializers.py</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="5ed5" class="ls ir hi lj b fi lt lu l lv lw">from django.contrib.auth import get_user_model</span><span id="40f6" class="ls ir hi lj b fi lx lu l lv lw">from rest_framework import serializers</span><span id="0cdc" class="ls ir hi lj b fi lx lu l lv lw">User = get_user_model()<br/></span><span id="faec" class="ls ir hi lj b fi lx lu l lv lw">class UserCreateSerializer(serializers.ModelSerializer):<br/>    password = serializers.CharField(<br/>        write_only=True, required=True, style={'input_type': 'password'}<br/>    )<br/>    password2 = serializers.CharField(<br/>        style={'input_type': 'password'}, write_only=True, label='Confirm password'<br/>    )</span><span id="efef" class="ls ir hi lj b fi lx lu l lv lw">    class Meta:<br/>        model = User<br/>        fields = ['username', 'email', 'password', 'password2']<br/>        extra_kwargs = {'password': {'write_only': True}}</span><span id="7b4c" class="ls ir hi lj b fi lx lu l lv lw">    def create(self, validated_data):<br/>        username = validated_data['username']<br/>        email = validated_data['email']<br/>        password = validated_data['password']<br/>        password2 = validated_data['password2']<br/>        if (email and User.objects.filter(email=email).exclude(username=username).exists()<br/>        ):<br/>            raise serializers.ValidationError(<br/>                {'email': 'Email addresses must be unique.'}<br/>            )<br/>        if password != password2:<br/>            raise serializers.ValidationError({'password': 'The two passwords differ.'})<br/>        user = User(username=username, email=email)<br/>        user.set_password(password)<br/>        user.save()<br/>        return user</span></pre><p id="a5fe" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">然后我们将在<code class="du lg lh li lj b">jwtauth/views.py</code>中创建一个新视图。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="9873" class="ls ir hi lj b fi lt lu l lv lw">from django.contrib.auth import get_user_model<br/>from rest_framework import permissions<br/>from rest_framework import response, decorators, permissions, status<br/>from rest_framework_simplejwt.tokens import RefreshToken<br/>from .serializers import UserCreateSerializer</span><span id="a3c3" class="ls ir hi lj b fi lx lu l lv lw">User = get_user_model()</span><span id="5465" class="ls ir hi lj b fi lx lu l lv lw">@decorators.api_view(['POST'])<br/>@decorators.permission_classes([permissions.AllowAny])<br/>def registration(request):<br/>    serializer = UserCreateSerializer(data=request.data)<br/>    if not serializer.is_valid():<br/>        return response.Response(serializer.errors, status.HTTP_400_BAD_REQUEST)        <br/>    user = serializer.save()<br/>    refresh = RefreshToken.for_user(user)<br/>    res = {<br/>        'refresh': str(refresh),<br/>        'access': str(refresh.access_token),<br/>    }<br/>    return response.Response(res, status.HTTP_201_CREATED)</span></pre><p id="862f" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">我们将视图添加到<code class="du lg lh li lj b">jwtauth/urls.py</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="1133" class="ls ir hi lj b fi lt lu l lv lw">from django.urls import path<br/>from .views import registration</span><span id="45a1" class="ls ir hi lj b fi lx lu l lv lw">urlpatterns = [<br/>    path('register/', registration, name='register')<br/>]</span></pre><p id="b878" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">接下来，在<code class="du lg lh li lj b">core/urls.py</code>中包含<code class="du lg lh li lj b">jwtauth</code>URL。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="1ec2" class="ls ir hi lj b fi lt lu l lv lw">urlpatterns = [<br/>    ....<br/>    path('api/jwtauth/', include('jwtauth.urls'), name='jwtauth'),<br/>]</span></pre><h1 id="a274" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">第六节。招摇文件</h1><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="aae2" class="ls ir hi lj b fi lt lu l lv lw">$ pip install django-rest-swagger</span></pre><p id="0153" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">在<code class="du lg lh li lj b">core/settings.py</code>中将它添加到您的<code class="du lg lh li lj b">INSTALLED_APPS</code>列表中。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="9c36" class="ls ir hi lj b fi lt lu l lv lw">INSTALLED_APPS = [<br/>    'rest_framework_swagger',<br/>    ....<br/>]</span><span id="d9e4" class="ls ir hi lj b fi lx lu l lv lw">REST_FRAMEWORK = {<br/>    ....<br/> 'DEFAULT_SCHEMA_CLASS':'rest_framework.schemas.coreapi.AutoSchema',<br/>}</span></pre><p id="bad4" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">添加以下代码<code class="du lg lh li lj b">core/urls.py</code>。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="1abf" class="ls ir hi lj b fi lt lu l lv lw">from django.contrib import admin<br/>from django.urls import path, include<br/>from rest_framework_swagger.views import get_swagger_view</span><span id="99cc" class="ls ir hi lj b fi lx lu l lv lw">schema_view = get_swagger_view(title="News Contents API")</span><span id="2641" class="ls ir hi lj b fi lx lu l lv lw">urlpatterns = [<br/>    path('admin/', admin.site.urls),<br/>    path('api/', include('newscontents.urls')),<br/>    path('auth/', include('rest_framework.urls')),<br/>    path('api/jwtauth/', include('jwtauth.urls'), name='jwtauth'),<br/>    path('api/docs/', schema_view),<br/>]</span></pre><p id="2762" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">然后在<code class="du lg lh li lj b">jwtauth/urls.py</code>中放入令牌并刷新enpoints。</p><pre class="lk ll lm ln fd lo lj lp lq aw lr bi"><span id="ac26" class="ls ir hi lj b fi lt lu l lv lw">from django.urls import path<br/>from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView<br/>from .views import registration</span><span id="1f72" class="ls ir hi lj b fi lx lu l lv lw">urlpatterns = [<br/>    path("register/", registration, name="register"),<br/>    path("token/", TokenObtainPairView.as_view(), name="token_obtain_pair"),<br/>    path("refresh/", TokenRefreshView.as_view(), name="token_refresh"),<br/>]</span></pre><p id="1ca1" class="pw-post-body-paragraph kl km hi jq b jr kn ko kp jt kq kr ks jv kt ku kv jx kw kx ky jz kz la lb kb hb bi translated">您可以访问<code class="du lg lh li lj b">http://localhost:8000/api/docs/</code>获得API的完整列表，令牌端点现在属于<code class="du lg lh li lj b">/jwtauth</code>分组。</p><h1 id="678d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">参考</h1><ul class=""><li id="87a2" class="jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf bi translated"><a class="ae lc" href="https://www.django-rest-framework.org" rel="noopener ugc nofollow" target="_blank">https://www.django-rest-framework.org</a></li><li id="dc2f" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">https://jwt.io/introduction/<a class="ae lc" href="https://jwt.io/introduction/" rel="noopener ugc nofollow" target="_blank"/></li><li id="4af9" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated">【https://github.com/adamchainz/django-cors-headers T4】</li><li id="3d81" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated"><a class="ae lc" href="https://github.com/davesque/django-rest-framework-simplejwt" rel="noopener ugc nofollow" target="_blank">https://github.com/davesque/django-rest-framework-simplejwt</a></li><li id="9a5c" class="jo jp hi jq b jr kg jt kh jv ki jx kj jz kk kb kc kd ke kf bi translated"><a class="ae lc" href="https://django-rest-swagger.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">https://django-rest-swagger.readthedocs.io/en/latest/</a></li></ul></div></div>    
</body>
</html>