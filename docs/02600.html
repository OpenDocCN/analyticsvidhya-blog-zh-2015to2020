<html>
<head>
<title>Visualize data with Azure Databricks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure数据块可视化数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/visualize-data-in-azure-databricks-d9f087be093d?source=collection_archive---------22-----------------------#2019-12-24">https://medium.com/analytics-vidhya/visualize-data-in-azure-databricks-d9f087be093d?source=collection_archive---------22-----------------------#2019-12-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2f4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure Databricks通过提供一个两个学科的用户都可以轻松使用的公共平台，将数据工程师和数据科学家聚集在一起，从而统一了数据分析流程。数据工程师为数据科学家收集和移动数据以执行分析。来自SQL背景的我喜欢使用数据块，因为我可以在数据块笔记本中使用熟悉的SQL编码，或者我可以很容易地切换到Python。</p><p id="fc18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设，需要了解英国房地产市场过去的表现，以及哪些地区对房地产投资有吸引力。为了执行探索性的数据分析，使用Azure Data Lake Gen 2和Azure Databricks提出了一个解决方案。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/879cf77dbb56e919a9574ac64450d93e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7cSvlTjAyLsoJrCN.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图片来源；<a class="ae jt" href="https://www.talavant.com/databricks-azure-data-lake-store/" rel="noopener ugc nofollow" target="_blank">https://www.talavant.com/databricks-azure-data-lake-store/</a></figcaption></figure><h2 id="d429" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">1.创建Azure Data Lake Gen 2帐户</h2><p id="a15e" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这是活动中最简单的一步，但是Azure上没有Azure Data Lake Gen 2。Azure Data lake Gen 2只不过是启用了<em class="ku">分层名称空间</em>的Azure存储帐户。</p><p id="9e95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Azure Data Lake(ADL)中，创建了一个文件夹结构，不仅用于组织内容，还用于管理安全性。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kv"><img src="../Images/76999039fe00af46d2d7cc8cf8173cb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*dUbaINL4Edz-ZJSGgEre5Q.png"/></div></figure><p id="0ef4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了便于分析，每年从英国政府网站下载csv源文件，并存储在带有年份标签的文件夹中。</p><h2 id="44f6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">2.创建服务主体</h2><p id="37cf" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">为了使数据块安全地访问ADL，必须通过应用程序注册来创建服务主体。虽然数据块可以通过<em class="ku">访问密钥</em>访问ADL，但是通过服务主体访问是安全和干净的。</p><ol class=""><li id="13ad" class="kw kx hi ih b ii ij im in iq ky iu kz iy la jc lb lc ld le bi translated">通过应用程序注册创建服务主体</li></ol><p id="cb76" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Azure Active Directory中，选择<em class="ku">应用注册</em>，点击<em class="ku">新注册</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lf"><img src="../Images/55741ccc07b0a98cb625d2d953e6a447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2VlgJGLQjftRkGoFYnWCeA.png"/></div></div></figure><p id="7253" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.为服务主体生成密钥。输入名称并保留默认设置</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/3579d279409f8ae4a034fc4eac1c1343.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*Mb1MRilyrJEIH2H0kocpxg.png"/></div></figure><p id="8ae8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建新的应用程序注册后，保存应用程序ID和目录ID，以便稍后在步骤4中使用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lh"><img src="../Images/7efcf56a07a521e5b534800c2bf97bc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UCBZ4tBYQRJ5D3Mh80jk7A.png"/></div></div></figure><p id="9ece" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，要创建机密，请单击<em class="ku">证书和机密</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/9c4d6f2961f4c29ac8f65b519fbc16fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*8VNbhCvPnzVE_QCbgCipbA.png"/></div></figure><p id="bb6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后选择<em class="ku">客户端机密</em>和<em class="ku">新客户端机密</em>。键入密码的名称，然后单击<em class="ku">添加</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es li"><img src="../Images/ef08e24f60814223bb9b57fb0a7824a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*9dxLoWs1BXfNPbKbzc-vWw.png"/></div></figure><p id="dd65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请确保复制并保存该值，因为无法再次检索该值。该值称为身份验证密钥，将在步骤4中使用。</p><h2 id="bda0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">3.授予ADL对服务主体的访问权限</h2><p id="27fd" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">通过添加新的<em class="ku">存储Blob数据贡献者</em>角色分配，授予ADL对服务主体的访问权限。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/fff69996a859690df1d62f1f6449868a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*LbtaN4OrcPGHD1k0kGIgSA.png"/></div></figure><h2 id="85cb" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">4.创建Azure密钥库</h2><p id="330b" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">创建密钥库是为了安全地存储机密。</p><p id="7f6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">存储在密钥库中的内容；</p><p id="1271" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应用程序或客户端ID。(步骤2-应用程序ID)</p><p id="3d71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">认证密钥。(步骤2-认证密钥)</p><p id="9fb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">存储帐户名是ADL帐户名。</p><p id="4189" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">租户ID是目录ID。(步骤2-目录ID)</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lg"><img src="../Images/f4f240a4f8f5fbf09339faaff30d0fc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*zjIS_Ix0HP_A_7_eMxhNSg.png"/></div></div></figure><p id="d5c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">给一个名称，并复制粘贴值文本框中的秘密值。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lj"><img src="../Images/5577b14cc30e4be2f1805496f4aeb35f.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*JAOWz0kgeQtkKfioD-zyMA.png"/></div></figure><p id="b2a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦所有的秘密都被加入。注意DNS名称和资源ID，这些将在步骤5中使用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/555a795448afd28fb1dd54ce72d865bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*seqEW8NP5CFCyc3fGQMMNw.png"/></div></div></figure><h2 id="3ac9" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">5.从Azure数据块访问ADL</h2><p id="9918" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要读取和分析数据，需要Databricks workspace。启动Databricks workspace后，下一步是创建集群。由于工作负载较小，因此通过禁用<em class="ku">自动扩展、</em>更改<em class="ku">工作线程数量和到期时间的默认值，集群被配置为使用更少的资源。</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/43b52467854a08885a8c9bbd741327a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*6UNunu2Jx1zpd53okUPdxw.png"/></div></figure><p id="8744" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">必须创建Azure Databricks secret作用域才能与Azure Key Vault连接。使用链接创建一个秘密范围；</p><p id="6d3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">https://【.azuredatabricks.net/ T4】？o =#秘密/创造范围</p><p id="1e8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从Azure Databrics链接中获取<em class="ku">位置</em>和<em class="ku"> orgID </em>，如下所示</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/63c8f194a5ba0adb96475d683dfd7465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*iUgg_TS0B7i7QUR2QjLuGg.png"/></div></div></figure><p id="a88d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">给定作用域名称并提供从Azure Key Vault复制的DNS名称和资源ID。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lm"><img src="../Images/2563c58455cc456b7bc249d73354aacc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*FQoUmylbi2ZqVflA6wuzWg.png"/></div></figure><p id="b4c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要执行探索性数据分析，需要添加一个连接了集群的笔记本。</p><p id="13cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，初始化变量并通过secret scope从Azure Key vault读取机密</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ln"><img src="../Images/3505da213e50cc17f779cb08e71b1cfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m0CUjmaVaz_PWuBRtHEsJQ.png"/></div></div></figure><p id="aea0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">笔记本会话配置使用从密钥库中读取的值进行更新。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/d58f1f8dea3de68093cf51b011a6721d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_w8Qtstbd10HxT3OE1eA9Q.png"/></div></div></figure><p id="bdb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将数据读入pySpark数据帧并打印数据帧模式以显示数据类型</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lp"><img src="../Images/c9c093db942c1dae7876cba9841f5d32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*euULMX996pJtIS_-WyN9Nw.png"/></div></div></figure><p id="9663" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日期字段是字符串，因此需要更改为日期类型以便分析。此外，数据框架被过滤以仅包括英国的地区。与pandas中的数据帧不同，pySpark数据帧是不可变的，因此对于模式的每次更改，都必须创建一个新的数据帧。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lq"><img src="../Images/b05c3cc345f6666730acd43c6ca79bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDYwSCDkhd2pmofBLWBI5g.png"/></div></div></figure><p id="5b81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使用更熟悉的SQL，pySpark DataFrame被转换为Azure Databricks中的temp对象</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lr"><img src="../Images/e09148ab78affa0fbdd142ec40ccc97f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ySEbd7GACJOYBa8OW2ar4w.png"/></div></div></figure><p id="bdf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用%sql将语言从python改为sql，并使用SQL查询来分析数据。第一个SQL查询显示了各个地区过去的平均价格波动情况，第二个查询显示了各个地区的销售额。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lq"><img src="../Images/5f39d627e0dab5334dca9978b037f775.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ms0uHJj3wq7TihAsqlcVZw.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lp"><img src="../Images/0da0ac66cdcf61add28ac1c83e0464e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bCA8uwkO3wi0zK0zyQQbEQ.png"/></div></div></figure><p id="8c02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以将输出列在表格上，或者使用笔记本中的可视化选项将数据可视化</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ls"><img src="../Images/0e16183c64929b25bd0b4c037e4a8189.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*q4L-02F1GDwUdPZIRSaEmQ.png"/></div></figure><p id="cb64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建图表后，创建一个仪表板将所有内容放在一起</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lt"><img src="../Images/0f93cdcfade1210176adb0fd240dd0b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*VQ7u1u7B-N0UZ1zYmgCygQ.png"/></div></figure><p id="0f26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过单击单元格中的条形图图标并选择仪表板，可将图表添加到仪表板中。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lu"><img src="../Images/07a699202ee8962b7485721fdd8fe1fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*8hmKKDGa0y9FRBdknkQuNQ.png"/></div></figure><p id="6bee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按地区显示过去趋势的最终Dashbord。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lv"><img src="../Images/381f241ef035a80795b441f4dea9e552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_jWuiT13XsnVwWEuJe6cg.png"/></div></div></figure><p id="ebbe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:</p><p id="38e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://docs.databricks.com/data/data-sources/azure/azure-datalake-gen2.html" rel="noopener ugc nofollow" target="_blank">https://docs . data bricks . com/data/data-sources/azure/azure-data lake-gen 2 . html</a></p></div></div>    
</body>
</html>