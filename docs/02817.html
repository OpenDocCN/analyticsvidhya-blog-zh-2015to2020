<html>
<head>
<title>Spark Memory Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火花存储器管理</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-memory-management-583a16c1253f?source=collection_archive---------2-----------------------#2020-01-03">https://medium.com/analytics-vidhya/spark-memory-management-583a16c1253f?source=collection_archive---------2-----------------------#2020-01-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f9ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们试着理解内存是如何在spark执行器内部分配的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/aa6f956aaa7c11a0bfa98104c3b98164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AwwF6VFNLDu51avY.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">火花执行器内存分解</figcaption></figure><p id="a0a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在每个执行器中，Spark为内存开销分配最少384 MB，其余的分配给实际工作负载。</p><p id="427b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">计算内存开销的公式— max(执行器内存* 0.1，384 MB)。</p><ul class=""><li id="de96" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc jy jz ka kb bi translated">第一个场景，如果您的executor内存是5 GB，那么内存开销= max( 5 (GB) * 1024 (MB) * 0.1，384 MB)，这将导致max( 512 MB，384 MB)，最后是512 MB。这将在每个执行器中为spark处理留下4.5 GB的空间。</li><li id="39dd" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">第二种情况，如果您的executor内存是1 GB，那么内存开销= max( 1(GB) * 1024 (MB) * 0.1，384 MB)，这将导致max( 102 MB，384 MB)，最后是384 MB。<br/>这将在每个执行器中为spark处理留下640 MB。</li></ul><p id="6c73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在堆内存上</strong></p><p id="3a18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，Spark只使用内存堆。执行器中的堆上内存区域可以大致分为以下四个块:</p><ul class=""><li id="649a" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc jy jz ka kb bi translated">存储内存:主要用于存储Spark缓存数据，如RDD缓存、展开数据等。</li><li id="9e3e" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">执行内存:主要用于存储Shuffle、Join、Sort、Aggregation等计算过程中的临时数据。</li><li id="c20b" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">用户内存:主要用于存储RDD转换操作所需的数据，如RDD依赖关系的信息。</li><li id="3767" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">保留内存:内存是为系统保留的，用于存储Spark的内部对象</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kh"><img src="../Images/f579d663d0a703cb883e9969337e5a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yG6vSZViNCfQhS0T.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">内存分配</figcaption></figure><p id="4ea8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要理解这一点，你必须考虑Spark的两个默认参数。</p><ul class=""><li id="b940" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc jy jz ka kb bi translated">spark.memory.fraction —标识统一内存区域和用户内存之间共享的内存。<br/>在这种情况下，是60%。比方说，如果我们有1 GB的spark executor内存，600MB将分配给统一内存区域，400MB分配给用户内存。</li><li id="a37d" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">spark.memory.storageFraction —标识执行内存和存储内存之间共享的内存。Spark提供的默认值是50%。但是根据执行存储器上的负载，存储存储器将被减少以完成任务。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ki"><img src="../Images/dd066c75e6cb1c887c53de1dd0cde894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XLJebpOWmgtxWjNWHzB9RA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">火花网络速度</figcaption></figure><p id="1db0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spark大量利用内存的原因之一是因为CPU可以以10 GB/s的速度从内存中读取数据。而如果Spark从内存磁盘中读取数据，速度将降至约100 MB/s，SSD读取速度将在600 MB/s范围内。</p><p id="071d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果CPU必须通过网络读取数据，速度将下降到大约125 MB/s。</p><p id="5831" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">常见问题清单</strong></p><ul class=""><li id="5c80" class="jt ju hi ih b ii ij im in iq jv iu jw iy jx jc jy jz ka kb bi translated">足够的并发分区。如果你有20个内核，确保你至少有20个分区或者更多。</li><li id="4b2d" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">通过过滤您需要的数据来最小化内存消耗。</li><li id="00b4" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">最小化混洗的数据量。洗牌很贵。</li><li id="2015" class="jt ju hi ih b ii kc im kd iq ke iu kf iy kg jc jy jz ka kb bi translated">了解标准库，在正确的地方使用正确的函数。</li></ul></div></div>    
</body>
</html>