<html>
<head>
<title>SQL for Data Scientists</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向数据科学家的 SQL</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/sql-for-data-scientists-a66559869447?source=collection_archive---------30-----------------------#2020-09-01">https://medium.com/analytics-vidhya/sql-for-data-scientists-a66559869447?source=collection_archive---------30-----------------------#2020-09-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4b47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将通过解决问题来介绍几个重要的 SQL 函数——希望本文能够帮助初学者，或者作为准备 SQL 筛选的指南。这里解决的问题是基本的，这里描述的每个问题都将包含模拟数据，供您创建表和运行/处理查询。我使用 DB Fiddle MySQL v8.0 进行除 pivot 之外的所有查询，pivot 需要 MS SQL，您可以使用 SQLLite online 和 MSSQL editor 来处理 pivot 问题，或者使用类似的在线平台来创建表格和运行查询，这样您将有机会了解查询的确切情况，并准备替代解决方案，还可以编辑数据来测试不同的用例。</p><p id="bcb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里提出的每一个问题都可以用几种不同的方法来解决，我鼓励你用不同的方法来解决它，并且寻求最优化。这里的目标是让读者在提供模拟数据的同时了解问题。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="da43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题:</strong>给定销售表，其中有多行客户的购买明细。编写一个查询，返回一周中每一天每位客户的购物总额。<strong class="ih hj">用过:</strong>枢</p><p id="0cb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="1044" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查询:</strong></p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="7762" class="jw jx hi js b fi jy jz l ka kb">select Customer, Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday from<br/>(<br/> select Customer,Units, PurchaseDay from PivotsTable<br/> ) as src<br/> pivot<br/> (<br/> Count(Units) for PurchaseDay in ([Monday],[Tuesday],[Wednesday],[Thursday],[Friday],[Saturday],[Sunday])<br/> ) as p</span></pre><p id="9c3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，只包括您需要出现在最终结果中的列:</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="1993" class="jw jx hi js b fi jy jz l ka kb">Select pivoted data from<br/>( select column you need to be pivoted + columns you need in the output) as source<br/>pivot<br/>(units to be displayed in the pivoted c) as p</span></pre><p id="3796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你运行下面的查询，会有什么结果呢？</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="1806" class="jw jx hi js b fi jy jz l ka kb">select Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday from<br/>(<br/> select Units, PurchaseDay from PivotsTable<br/> ) as src<br/> pivot<br/> (<br/> Sum(Units) for PurchaseDay in ([Monday],[Tuesday],[Wednesday],[Thursday],[Friday],[Saturday],[Sunday])<br/> ) as p</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="c084" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:给定数据对，找出唯一的数据对？下表中的每一行都可以被认为是社交媒体连接(follower，following)，问题是显示连接存在的唯一对。同样的问题可以被框架化为寻找唯一的飞行路线-具有 3 行 MSP - &gt; ATL 和 ATL - &gt; MSP，MSP - &gt; EWR 应该导致 MSP - &gt; ATL，MSP - &gt; EWR。<strong class="ih hj">已用</strong>:存在于何处</p><p id="1522" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="8113" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查询</strong>:</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="42ed" class="jw jx hi js b fi jy jz l ka kb">select Follower, Following from Symmetric S1 WHERE EXISTS <br/>(SELECT * FROM Symmetric S2 where S1.Follower = S2.Following and S2.Follower = S1.Following and S1.Follower &gt; S1.Following)<br/>UNION<br/>select Follower, Following from Symmetric S1 WHERE NOT EXISTS <br/>(SELECT * FROM Symmetric S2 where S1.Follower = S2.Following and S2.Follower = S1.Following)</span></pre><p id="6984" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一部分将返回存在双向关系的唯一对，而第二部分将给出只有单向关系的对，然后使用 UNION 将它们连接起来。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="39e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:求各系学生的最高分。每一行对应于每个系的几个学生的分数。<strong class="ih hj">使用:</strong>视窗</p><p id="c0ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="8fd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查询:</strong></p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="2cda" class="jw jx hi js b fi jy jz l ka kb">WITH CTE as(<br/>select Department, Student, Score, dense_rank() over(Partition by Department Order by Score desc) as RankNum from College)<br/>select Department, Student, Score from CTE where RankNum = 1</span></pre><p id="9d96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何找到每个系排名第二的学生，以及从上面的查询中删除按系划分的结果是什么？还有，探究一下 RANK，DENSE_RANK，ROW_NUMBER 的区别。</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="db84" class="jw jx hi js b fi jy jz l ka kb">WITH CTE as(<br/>select Department, Student, Score, dense_rank() over(Order by Score desc) as RankNum from College)</span><span id="769e" class="jw jx hi js b fi kc jz l ka kb">select Department, Student, Score from CTE where RankNum = 1</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="9373" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:交换行。每行都有一个 Id 和名称。<strong class="ih hj">使用:</strong>格当，内联接</p><p id="550c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="0102" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查询:</strong></p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="773e" class="jw jx hi js b fi jy jz l ka kb">select S1.* from School S1 inner join(<br/>SELECT <br/>    CASE <br/>        WHEN((SELECT MAX(Id) FROM School)%2 = 1) AND id = (SELECT MAX(Id) FROM School) THEN Id<br/>        WHEN id%2 = 1 THEN id + 1<br/>        ELSE id - 1<br/>    END AS Ordered_Id, row_number() over() as rn<br/>FROM School) S2<br/>on S1.Id = S2.Ordered_Id <br/>order by S2.rn</span></pre><p id="0b13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您删除 row_number()并运行下面的查询，您认为结果为什么会发生变化？</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="dc35" class="jw jx hi js b fi jy jz l ka kb">select S1.* from School S1 inner join(<br/>SELECT <br/> CASE <br/> WHEN((SELECT MAX(Id) FROM School)%2 = 1) AND id = (SELECT MAX(Id) FROM School) THEN Id<br/> WHEN id%2 = 1 THEN id + 1<br/> ELSE id — 1<br/> END AS Ordered_Id<br/>FROM School) S2<br/>on S1.Id = S2.Ordered_Id</span></pre><p id="583a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:查找在特定日期/日子登录的用户。每一行都有 Id、登录日期，并且表可以有重复的行。<strong class="ih hj">用过:</strong>在</p><p id="cf2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="4cc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查询:</strong></p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="d65a" class="jw jx hi js b fi jy jz l ka kb">select id from logins where LoginDate = '2020-07-09' and id in (Select id from logins where LoginDate = '2020-07-08')</span></pre><p id="5a79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">找到今天登录而不是昨天登录的 id 列表怎么样——您可以探索不同的日期函数来解决与日期相关的问题。</p><p id="9258" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:查找连续三天登录的用户<strong class="ih hj">使用:</strong> CTE，Windows</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="abf4" class="jw jx hi js b fi jy jz l ka kb">with NoDups as (select distinct * from Logins)</span><span id="c9a5" class="jw jx hi js b fi kc jz l ka kb">select id from <br/>(select id, row_number() over(partition by Id) as rn from NoDups) A<br/>where A.rn = 3</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="5254" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:给定两个表，一个是用户订单，另一个是类别信息。编写一个查询来返回每个类别中的订单，包括类别，即使没有订单。<strong class="ih hj">已用:</strong>连接</p><p id="3348" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><p id="a78b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">查询:</strong></p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="eb55" class="jw jx hi js b fi jy jz l ka kb">select c.Name as Category, coalesce(sum(o.Units),0) as TotalUnits from Categories c left join Orders o<br/>on o.CategoryId = c.Id<br/>group by c.name</span></pre><p id="e4bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您使用内部连接运行相同的查询时，请检查不同之处:</p><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="4ef4" class="jw jx hi js b fi jy jz l ka kb">select c.Name as Category, sum(o.Units) as TotalUnits from Orders o inner join Categories c<br/>on o.CategoryId = c.Id<br/>group by c.name</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="ed55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题</strong>:求每月登录次数的百分比变化。同样的问题可以归结为保留率。<strong class="ih hj">常用:</strong>滞后，超前</p><p id="b175" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">数据:</strong></p><figure class="jk jl jm jn fd jo"><div class="bz dy l di"><div class="jp jq l"/></div></figure><h2 id="5d36" class="jw jx hi bd kd ke kf kg kh ki kj kk kl iq km kn ko iu kp kq kr iy ks kt ku kv bi translated">查询:</h2><pre class="jk jl jm jn fd jr js jt ju aw jv bi"><span id="a035" class="jw jx hi js b fi jy jz l ka kb">with CTE AS (select *, lag(LoginCounts, 1) over() as PrevMonthCount from Logins)<br/>SELECT MonthName, (LoginCounts — PrevMonthCount) * 100/ PrevMonthCount as RetentionPercent FROM CTE</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="89d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的阅读。请报告任何错误/建议。</p></div></div>    
</body>
</html>