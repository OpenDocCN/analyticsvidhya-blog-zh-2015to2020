<html>
<head>
<title>Scheduling Compute Engine with startup scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用启动脚本调度计算引擎</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/scheduling-compute-engine-with-startup-scripts-1b17c40b311c?source=collection_archive---------11-----------------------#2020-01-09">https://medium.com/analytics-vidhya/scheduling-compute-engine-with-startup-scripts-1b17c40b311c?source=collection_archive---------11-----------------------#2020-01-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d70a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大家好。今天，我们将创建一个计算引擎实例，它使用自定义脚本在特定时间启动和关闭。让我再解释一下。</p><p id="cf89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谷歌计算引擎(GCE)是一个基础设施即服务(IaaS ),允许开发人员在物理硬件上运行他们的工作。他们提供如此多类型的虚拟机。你可以修改内存，中央处理器，辅助存储器，甚至操作系统。</p><p id="e0f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的，但是我们怎么安排呢？我的意思是，我们肯定不会每次都雇人按按钮。对吗？还是我们？</p><p id="c9ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是谷歌云调度器、云功能和云发布/订阅的用武之地。看起来很多，但相信我，不是的。在Cloud Scheduler的帮助下，我们可以设置特定的时间和有效载荷(我将在后面解释)。云调度程序触发发布/订阅。发布/订阅获取有效负载并触发云功能。最后，云函数使用启动脚本启动或关闭我们的实例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/8471f3106719c7f1310664b9d118142a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ijldGswAldNUm18r2nXnXw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">完整的环境(图片来自<a class="ae jt" href="https://cloud.google.com/compute/docs/startupscript" rel="noopener ugc nofollow" target="_blank">cloud.google.com</a></figcaption></figure><p id="707b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以让我们开始吧。我们将使用网站来设置这个。如果你愿意，可以使用<a class="ae jt" href="https://cloud.google.com/compute/docs/gcloud-compute" rel="noopener ugc nofollow" target="_blank"> gcloud命令行工具</a>。首先，您应该启用计费来访问计算引擎。然而，谷歌给你一年300美元的信用！</p><p id="44a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的，让我们转到<a class="ae jt" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank">计算引擎实例</a>并创建一个新项目。然后点击顶部的<strong class="ih hj">创建实例</strong>。设置名称<strong class="ih hj">开发实例</strong>。选择区域<strong class="ih hj"> us-west1 </strong>，选择区域<strong class="ih hj"> us-west1-b </strong>。转到管理、安全性、磁盘、网络、单独租赁。在管理下点击<strong class="ih hj">添加标签</strong>，设置<strong class="ih hj"> env </strong>为key，<strong class="ih hj"> dev </strong>为value。然后点击<strong class="ih hj">创建</strong>。恭喜，您已经启动并运行了虚拟机。但是我们还没有完成。我们将使用发布/订阅设置云功能。</p><p id="ddd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们前往<a class="ae jt" href="https://console.cloud.google.com/functions/" rel="noopener ugc nofollow" target="_blank">云函数</a>。点击<strong class="ih hj">创建功能</strong>。设置你的函数名<strong class="ih hj">startinstancebub</strong>。对于触发器，选择<strong class="ih hj">云发布/订阅</strong>。对于主题，选择<strong class="ih hj">创建新主题… </strong>。将出现一个新对话框。在此框中，设置名称<strong class="ih hj">开始-实例-事件</strong>。点击<strong class="ih hj">创建</strong>。对话框将会消失。运行时，选择<strong class="ih hj"> Node.js 8 </strong>。选择<strong class="ih hj"> index.js </strong>并用这个替换代码。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="8fc6" class="jz ka hi jv b fi kb kc l kd ke">const Compute = require('@google-cloud/compute');<br/>const compute = new Compute();<br/><br/>exports.startInstancePubSub = async (event, context, callback) =&gt; {<br/>  try {<br/>    const payload = _validatePayload(<br/>      JSON.parse(Buffer.from(event.data, 'base64').toString())<br/>    );<br/>    const options = {filter: `labels.${payload.label}`};<br/>    const [vms] = await compute.getVMs(options);<br/>    await Promise.all(<br/>      vms.map(async instance =&gt; {<br/>        if (payload.zone === instance.zone.id) {<br/>          const [operation] = await compute<br/>            .zone(payload.zone)<br/>            .vm(instance.name)<br/>            .start();<br/><br/>          // Operation pending<br/>          return operation.promise();<br/>        }<br/>      })<br/>    );<br/>    const message = `Successfully started instance(s)`;<br/>    console.log(message);<br/>    callback(null, message);<br/>  } catch (err) {<br/>    console.log(err);<br/>    callback(err);<br/>  }<br/>};</span><span id="f2a3" class="jz ka hi jv b fi kf kc l kd ke">const _validatePayload = payload =&gt; {<br/>  if (!payload.zone) {<br/>    throw new Error(`Attribute 'zone' missing from payload`);<br/>  } else if (!payload.label) {<br/>    throw new Error(`Attribute 'label' missing from payload`);<br/>  }<br/>  return payload;<br/>};</span></pre><p id="24d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后选择<strong class="ih hj"> package.json </strong>。用这个替换代码。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="5c7c" class="jz ka hi jv b fi kb kc l kd ke">{<br/>  "name": "cloud-functions-schedule-instance",<br/>  "version": "0.1.0",<br/>  "private": true,<br/>  "license": "Apache-2.0",<br/>  "author": "Google Inc.",<br/>  "repository": {<br/>    "type": "git",<br/>    "url": "https://github.com/GoogleCloudPlatform/nodejs-docs-samples.git"<br/>  },<br/>  "engines": {<br/>    "node": "&gt;=8.0.0"<br/>  },<br/>  "scripts": {<br/>    "test": "mocha test/*.test.js --timeout=20000"<br/>  },<br/>  "devDependencies": {<br/>    "@google-cloud/nodejs-repo-tools": "^3.3.0",<br/>    "mocha": "^6.0.0",<br/>    "proxyquire": "^2.0.0",<br/>    "sinon": "^7.0.0"<br/>  },<br/>  "dependencies": {<br/>    "@google-cloud/compute": "^1.0.0"<br/>  }<br/>}</span></pre><p id="4db7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于要执行的功能，设置<strong class="ih hj">startinstancebusub</strong>。然后点击<strong class="ih hj">创建</strong>。这是我们的开胃菜。让我们设置停止功能。</p><p id="1759" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次点击<strong class="ih hj">创建功能</strong>。将其命名为<strong class="ih hj"> stopInstancePubSub </strong>。对于触发，选择<strong class="ih hj">云发布/订阅</strong>。对于主题，选择<strong class="ih hj">创建新主题… </strong>。在对话框中，设置名称<strong class="ih hj">停止实例事件</strong>点击创建。运行时，选择<strong class="ih hj"> node.js 8 </strong>。选择index.js选项卡，并将代码替换为。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="2688" class="jz ka hi jv b fi kb kc l kd ke">const Compute = require('@google-cloud/compute');<br/>const compute = new Compute();<br/><br/>exports.stopInstancePubSub = async (event, context, callback) =&gt; {<br/>  try {<br/>    const payload = _validatePayload(<br/>      JSON.parse(Buffer.from(event.data, 'base64').toString())<br/>    );<br/>    const options = {filter: `labels.${payload.label}`};<br/>    const [vms] = await compute.getVMs(options);<br/>    await Promise.all(<br/>      vms.map(async instance =&gt; {<br/>        if (payload.zone === instance.zone.id) {<br/>          const [operation] = await compute<br/>            .zone(payload.zone)<br/>            .vm(instance.name)<br/>            .stop();<br/><br/>          // Operation pending<br/>          return operation.promise();<br/>        } else {<br/>          return Promise.resolve();<br/>        }<br/>      })<br/>    );</span><span id="9c05" class="jz ka hi jv b fi kf kc l kd ke">    const message = `Successfully stopped instance(s)`;<br/>    console.log(message);<br/>    callback(null, message);<br/>  } catch (err) {<br/>    console.log(err);<br/>    callback(err);<br/>  }<br/>};<br/><br/>const _validatePayload = payload =&gt; {<br/>  if (!payload.zone) {<br/>    throw new Error(`Attribute 'zone' missing from payload`);<br/>  } else if (!payload.label) {<br/>    throw new Error(`Attribute 'label' missing from payload`);<br/>  }<br/>  return payload;<br/>};</span></pre><p id="2c75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后选择package.json并用以下代码替换代码。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="5976" class="jz ka hi jv b fi kb kc l kd ke">{<br/>  "name": "cloud-functions-schedule-instance",<br/>  "version": "0.1.0",<br/>  "private": true,<br/>  "license": "Apache-2.0",<br/>  "author": "Google Inc.",<br/>  "repository": {<br/>    "type": "git",<br/>    "url": "https://github.com/GoogleCloudPlatform/nodejs-docs-samples.git"<br/>  },<br/>  "engines": {<br/>    "node": "&gt;=8.0.0"<br/>  },<br/>  "scripts": {<br/>    "test": "mocha test/*.test.js --timeout=20000"<br/>  },<br/>  "devDependencies": {<br/>    "@google-cloud/nodejs-repo-tools": "^3.3.0",<br/>    "mocha": "^6.0.0",<br/>    "proxyquire": "^2.0.0",<br/>    "sinon": "^7.0.0"<br/>  },<br/>  "dependencies": {<br/>    "@google-cloud/compute": "^1.0.0"<br/>  }<br/>}</span></pre><p id="901f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，我们设置了我们的功能和发布/订阅。接下来，我们将设置调度程序。转到<a class="ae jt" href="https://console.cloud.google.com/cloudscheduler" rel="noopener ugc nofollow" target="_blank">云调度器</a>。点击<strong class="ih hj">创建工作</strong>。将其命名为<strong class="ih hj">启动-开发-实例</strong>。对于频率，您可以输入任何您想要的cron时间。例如，<strong class="ih hj">* * * * * *</strong>表示每一分钟。或0 9 * * 1–5表示周一至周五每天的09:00。对于时区，选择<strong class="ih hj">美国/洛杉矶</strong>。对于目标，选择<strong class="ih hj">发布/订阅</strong>。对于主题，输入<strong class="ih hj">开始-实例-事件</strong>。对于有效载荷(正如我前面提到的)，输入以下内容:</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="e5c2" class="jz ka hi jv b fi kb kc l kd ke">{"zone":"us-west1-b","label":"env=dev"}</span></pre><p id="5a54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后点击<strong class="ih hj">创建</strong>。我们设置了启动调度程序，让我们设置停止一。</p><p id="45c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">创建作业</strong>。将其命名为<strong class="ih hj">关机开发实例</strong>。对于频率，输入您的频率。对于时区，选择<strong class="ih hj">美国/洛杉矶</strong>。对于目标，选择<strong class="ih hj">发布/订阅</strong>。对于主题，输入<strong class="ih hj">停止实例事件</strong>。对于有效载荷(正如我前面提到的)，输入以下内容:</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="6d5f" class="jz ka hi jv b fi kb kc l kd ke">{"zone":"us-west1-b","label":"env=dev"}</span></pre><p id="c3ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后点击<strong class="ih hj">创建</strong>。恭喜你！您安排了实例。但是我们还没有分配任何启动脚本。就这么办吧。</p><p id="2888" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到<a class="ae jt" href="https://console.cloud.google.com/compute/instances" rel="noopener ugc nofollow" target="_blank">计算引擎</a>。点击<strong class="ih hj">开发实例</strong>。点击页面顶部的<strong class="ih hj">编辑</strong>。查找自定义元数据。单击添加项目。对于键，输入<strong class="ih hj">启动脚本</strong>。对于value，您可以输入您的脚本。一旦分配了启动脚本，每次虚拟机启动时，它都会执行启动脚本。让我们做一个python脚本的例子。</p><p id="5777" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">#!/bin/bash<br/>python-&lt;&lt;EOF # python脚本开始<br/> print('Hello World！')<br/>python脚本的EOF #结尾</p><p id="6bab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个脚本将被执行并打印“Hello World！”每次虚拟机启动时。让我们检查一下。转到计算引擎。选择<strong class="ih hj">开发实例</strong>。点击<strong class="ih hj">开始</strong>。当它启动时，点击<strong class="ih hj"> SSH </strong>。它会打开一扇窗。这是您的bash命令行。键入以下代码查看日志:</p><p id="3b93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">tail -n 100 /var/log/syslog</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kg"><img src="../Images/e09e2f3c97db9439a11e8b351c10ac29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*Gf3Kq1Pgn2MBn_jsg4jLLg.jpeg"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">已执行的启动脚本</figcaption></figure><p id="5447" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们结束了。您可以执行自己的脚本。如果你还有任何问题，请随时问我。祝您愉快:)</p></div></div>    
</body>
</html>