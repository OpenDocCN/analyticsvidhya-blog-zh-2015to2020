<html>
<head>
<title>Manage ML Deployments Like A Boss: Deploy Your First AB Test With Sklearn, Kubernetes and Seldon-core using Only Your Web Browser &amp; Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像老板一样管理ML部署:使用Sklearn、Kubernetes和Seldon-core部署您的第一个AB测试，只使用您的Web浏览器和Google Cloud</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/manage-ml-deployments-like-a-boss-deploy-your-first-ab-test-with-sklearn-kubernetes-and-b10ae0819dfe?source=collection_archive---------0-----------------------#2018-10-17">https://medium.com/analytics-vidhya/manage-ml-deployments-like-a-boss-deploy-your-first-ab-test-with-sklearn-kubernetes-and-b10ae0819dfe?source=collection_archive---------0-----------------------#2018-10-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/395d7208a496660487b1eef383bfab8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQvktDmu0L0FZxM4rUBrwA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">#模特老板:<a class="ae iu" href="https://github.com/SeldonIO/seldon-core" rel="noopener ugc nofollow" target="_blank">https://github.com/SeldonIO/seldon-core</a></figcaption></figure><h1 id="d854" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">先看这个——总结</h1><p id="2d28" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如果您对将机器学习模型部署为REST APIs感兴趣，但是仅仅提供端点已经不够好了，那么您可能已经准备好进行模型管理了。</p><p id="2f52" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">就像洛基拥有米克一样，你，我的朋友，拥有<a class="ae iu" href="https://github.com/SeldonIO/seldon-core/blob/master/readme.md" rel="noopener ugc nofollow" target="_blank">谢顿核心</a>。</p><p id="61b3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果您想要一种简单的方法来部署流量，然后使用AB测试之类的东西将流量路由到模型，那么模型管理就是您的选择。当然，没有人能比米克自己更好地解释管理的必要性:</p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">谢顿核心比米克好得多，你不用喝生鸡蛋</figcaption></figure><p id="13b6" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">本文是一个端到端的教程，涵盖了如何:</strong></p><ul class=""><li id="0872" class="lc ld hi jv b jw kr ka ks ke le ki lf km lg kq lh li lj lk bi translated">用scikit-learn训练一个(非常)基本的机器学习模型</li><li id="fb6b" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">使用seldon-core作为AB测试服务和路由该模型</li><li id="96a7" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">在kubernetes上部署整个工具包和一堆东西</li></ul><p id="4381" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">换句话说，我们将花大部分时间穿越谢顿核心。但是作为您的数据科学业余爱好者，我将包括让它运行的每个步骤。只是不要让我解释它为什么有效。</p><p id="24a6" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">等等！！！我以前从未将模型部署为REST API。我还应该读这个吗？</strong></p><p id="ef68" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果您以前从未将ML模型作为REST API部署过，这完全没问题。先前的经验是<strong class="jv hj">而不是</strong>所要求的。谢顿核心为我们处理。万岁。</p><p id="8bf5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">也就是说，如果你想要一个简单地在kubernetes上部署一个ML模型作为REST API的超级基础的例子，读一读除了我的关于这个主题的博客文章之外的任何东西，你就会很快熟悉了。</p><p id="10b2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">等等！！！我不想要一个基本的例子。我想要一个真实的生产实例</strong></p><p id="da19" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">然后阅读丹尼尔·罗德里格斯的这个<a class="ae iu" rel="noopener" href="/@danielfrg/polyaxon-argo-and-seldon-for-model-training-package-and-deployment-in-kubernetes-fa089ba7d60b">合法的例子</a>。专业人士就是这么做的。</p><p id="86a4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">继续前进。</p><p id="b641" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">你只需要跟着做:</strong></p><ul class=""><li id="883a" class="lc ld hi jv b jw kr ka ks ke le ki lf km lg kq lh li lj lk bi translated">现代网络浏览器</li><li id="0134" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">态度好</li></ul><p id="9fdb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">就像我的上一篇文章一样，我将在谷歌云上运行一切，因为它超级简单，而且我仍然有一堆免费积分。此外，我们可以使用Google Cloud shell，这意味着我们甚至不必在本地运行终端会话。这可能看起来像一个愚蠢的约束，但我知道对我来说计算<em class="lq">有多难(这是一个技术术语，伙计们)，所以我想尽可能地减少认知开销。请随意评价我，看看我是否在乎…</em></p><h1 id="aff1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">我们主题的快速介绍</h1><p id="868a" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">借用比我聪明的人的话:</p><blockquote class="lr"><p id="2e72" class="ls lt hi bd lu lv lw lx ly lz ma kq dx translated">如果机器学习模型是在Jupyter笔记本上训练的，但从未部署过，它真的存在过吗？</p></blockquote><p id="9b3a" class="pw-post-body-paragraph jt ju hi jv b jw mb jy jz ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq hb bi translated">当我明白的时候，让我再给你扔一个炸弹:</p><blockquote class="lr"><p id="89d6" class="ls lt hi bd lu lv lw lx ly lz ma kq dx translated">如果你不管理你的模型，你的模型会管理你…</p></blockquote><p id="5e76" class="pw-post-body-paragraph jt ju hi jv b jw mb jy jz ka mc kc kd ke md kg kh ki me kk kl km mf ko kp kq hb bi translated">我知道这听起来有多愚蠢，我(基本上)是在开玩笑。但是在我的胡言乱语中有一些真理。部署机器学习模型不仅困难，而且严重不足。尽管管理已部署的模型更加困难，但这是绝对必要的。那么一个女孩该怎么办呢？</p><p id="e5a1" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">嗯，这里没有“自由范围建模”——我们必须在野外控制和指导我们的模型，以免它们为我们的业务部门带来很少甚至没有ROI。幸运的是，如果我们大胆行动，有一些可爱的开源项目随时准备为我们提供帮助。</p><p id="71d4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果您愿意在终端中键入一些命令，本教程将教您如何像老板(或至少像一个酷的中层经理)一样部署和管理ML模型。所以让我们开始吧。</p><p id="0b14" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">以下是我们将涉及的内容(按顺序):</p><ul class=""><li id="390c" class="lc ld hi jv b jw kr ka ks ke le ki lf km lg kq lh li lj lk bi translated">使用GKE在谷歌云上构建kubernetes集群</li><li id="674b" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">使用舵安装seldon-core</li><li id="4633" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">使用s2i构建一个基本ML模型的Docker映像</li><li id="536a" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">使用seldon-core将我们的AB测试定义和部署为模型图</li></ul><h1 id="fbd6" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">1.启动并连接到GKE的Kubernetes集群</h1><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/a2b859667a2957df85b3ddf578c4d157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5BUo9SV9idWAKP85w8L3Eg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">我们用来移动码头集装箱的东西:【https://kubernetes.io/ T2】</figcaption></figure><p id="c699" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">让我们使用<a class="ae iu" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云</a>来创建我们的kubernetes集群。有了所有的免费积分，它没有花费我任何东西，并且让我免去了在笔记本电脑上运行本地kubernetes实例的烦恼。此外，通过使用一个公共的基础设施，其他人可以更容易地跟进。当然，我们可以完全在他们基于网络的云外壳上工作，所以你不必在你的笔记本电脑上运行任何东西。</p><ol class=""><li id="d380" class="lc ld hi jv b jw kr ka ks ke le ki lf km lg kq mh li lj lk bi translated">使用左侧的汉堡菜单，选择Kubernetes引擎并单击“创建集群”</li></ol><figure class="kw kx ky kz fd ij er es paragraph-image"><div class="er es mi"><img src="../Images/a2c30c88db2d58b0a8511fcf093612cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*bHiOjRlCLPoKxQuXW2_asg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">准备好来一次狂野之旅吧</figcaption></figure><p id="7ecc" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">2.保持默认设置不变，点击<strong class="jv hj">创建</strong>。谷歌云现在需要几分钟来启动我们的kubernetes集群。这是给自己拿一杯美味饮料的好时机。</p><p id="6e5f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">3.现在点击<strong class="jv hj">连接</strong>按钮打开我们的云壳，选择<strong class="jv hj">在云壳中运行。</strong></p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/5983d9e7d4af0e73191b77396d4c205b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9zwCnyR5_WbGP-ybB35cwg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">我们可以从本地机器ssh，但是我太懒了</figcaption></figure><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/ac370af960245eea92e783fa591eb637.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGzSsCrKChYJbQbd4bMuzA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">感谢谷歌</figcaption></figure><p id="3902" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">就这样，我们连接到正在运行的kubernetes实例-# suh-weet。</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/4f61b48ce86fdc08c93e44f66be0dc78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BN983zxHkBu-S3CYc57UwQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">现在让我们开始行动吧</figcaption></figure><h1 id="b9a2" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">2.在GKE上安装舵和谢顿核心</h1><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/7141646a6327af14ee7e060d921c2f74.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/format:webp/1*rT1GZGSg0ysiqCw5mgr4WA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">我们如何在kubernetes上安装东西:<a class="ae iu" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">https://helm.sh/</a></figcaption></figure><p id="d645" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们用helm在kubernetes上安装东西。我认为helm是各种各样的kubernetes包管理器(相当于Python中的pip或conda)。我想说更多关于赫尔姆的事，但我只知道这些。</p><p id="d95c" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">如何安装Helm —输入Jonathan Campos </strong></p><p id="ebce" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">幸运的是，Jonathan Campos写了一篇关于<a class="ae iu" rel="noopener" href="/google-cloud/installing-helm-in-google-kubernetes-engine-7f07f43c536e">如何在GKE </a>上安装helm的精彩教程。我知道这是我的教程，当我读到这个宝石:</p><blockquote class="mn mo mp"><p id="11ab" class="jt ju lq jv b jw kr jy jz ka ks kc kd mq kt kg kh mr ku kk kl ms kv ko kp kq hb bi translated">现在您已经看到了必要的代码，您可以偷懒，只需运行一个脚本来为您完成安装</p></blockquote><p id="033d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我相信我会的，乔纳森。我相信我会的。</p><p id="e1f5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这是我们需要的乔纳森教程的<a class="ae iu" href="https://github.com/jonbcampos/kubernetes-series/blob/master/helm/scripts/add_helm.sh" rel="noopener ugc nofollow" target="_blank">相关片段</a>。</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="aa2b" class="my iw hi mu b fi mz na l nb nc">#!/usr/bin/env bash<br/><br/>echo "install helm"<br/># installs helm with bash commands for easier command line integration<br/><strong class="mu hj">curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash</strong><br/># add a service account within a namespace to segregate tiller<br/><strong class="mu hj">kubectl --namespace kube-system create sa tiller</strong><br/># create a cluster role binding for tiller<br/><strong class="mu hj">kubectl create clusterrolebinding tiller \<br/>    --clusterrole cluster-admin \<br/>    --serviceaccount=kube-system:tiller<br/></strong><br/>echo "initialize helm"<br/># initialized helm within the tiller service account<br/><strong class="mu hj">helm init --service-account tiller</strong><br/># updates the repos for Helm repo integration<br/><strong class="mu hj">helm repo update</strong><br/><br/>echo "verify helm"<br/># verify that helm is installed in the cluster<br/><strong class="mu hj">kubectl get deploy,svc tiller-deploy -n kube-system</strong></span></pre><p id="d1fe" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这是怎么回事？谁在乎呢。打开一个文本编辑器，把这段代码粘贴进去，然后运行它。</p><p id="9c00" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我是这样做的。我创建了一个名为<em class="lq"> install-helm </em>的目录，然后创建了一个名为<em class="lq"> install-helm.sh </em>的文件。我的shell命令是:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="2fa8" class="my iw hi mu b fi mz na l nb nc">mkdir install-helm<br/>cd install-helm<br/>vim install-helm.sh<br/>#Enter insert mode in vim with "i"<br/>#Paste your code<br/>#Exit vim with ":x"<br/>bash install-helm.sh</span></pre><p id="6f35" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果您看到类似下图的内容，那么您的安装运行成功</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nd"><img src="../Images/0fb89cfc4a24f3cd9eae2390f1e49dec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wOMB98bF0N3IdXhyD30Tfw.png"/></div></div></figure><p id="4c62" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">太好了，现在我们已经安装了头盔，让我们用它来安装谢顿核心</p><p id="5866" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">用舵安装谢顿芯</strong></p><p id="82fa" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">遵循<a class="ae iu" href="https://github.com/SeldonIO/seldon-core/blob/master/docs/install.md" rel="noopener ugc nofollow" target="_blank"> seldon-core安装材料</a>，我们需要安装<em class="lq"> seldon-core-crd </em>和<em class="lq"> seldon-core组件</em>。</p><p id="3edf" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">要从终端安装seldon-core-crd，请运行:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="c3c3" class="my iw hi mu b fi mz na l nb nc">helm install seldon-core-crd --name seldon-core-crd --repo https://storage.googleapis.com/seldon-charts \<br/>     --set usage_metrics.enabled=true</span></pre><p id="da7a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">要安装seldon-core组件，请运行:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="d68c" class="my iw hi mu b fi mz na l nb nc">helm install seldon-core --name seldon-core --repo https://storage.googleapis.com/seldon-charts</span></pre><p id="9eb7" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">注意，如果你阅读了<a class="ae iu" href="https://github.com/SeldonIO/seldon-core/blob/master/docs/install.md" rel="noopener ugc nofollow" target="_blank">安装文档</a>，它们会指导你为RBAC和反向代理设置一些选项。我发现这令人困惑，所以我只是忽略了它，用默认值。幸运的是，一切正常。</p><p id="79ff" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果你看到这样的信息，那么seldon-core安装成功。</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ne"><img src="../Images/e13a5e5b2ccb22c8c7168bd6248a1e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OrXUUR3NHie8SEkL6lpORA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">非常欢迎你，谢顿核心</figcaption></figure><h1 id="f25d" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">3.使用s2i构建一个基本ML模型的Docker映像</h1><p id="db45" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">现在我们已经安装了seldon-core，是时候将我们的模型构建为Docker映像，并将其传递给seldon-core进行部署和路由了。</p><p id="387f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">安装s2i </strong></p><p id="da70" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">s2i是一个方便的工具，可以将Git repo(或者任何地方，我认为)中的代码转换成Docker映像。这为什么有用？记住:我们需要所有东西都存在Docker容器中，这样Kubernetes就可以处理所有繁重的部署和监控工作。</p><p id="599a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们可以完成编写Docker文件和构建Docker映像的步骤，但是使用s2i我们不必这样做。三声欢呼！</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="7426" class="my iw hi mu b fi mz na l nb nc"># Download the installer<br/>wget <a class="ae iu" href="https://github.com/openshift/source-to-image/releases/download/v1.1.12/source-to-image-v1.1.12-2a783420-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/openshift/source-to-image/releases/download/v1.1.12/source-to-image-v1.1.12-2a783420-linux-amd64.tar.gz</a></span><span id="2ca6" class="my iw hi mu b fi nf na l nb nc"># Unpack the installer<br/>tar -xvf source-to-image-v1.1.12-2a783420-linux-amd64.tar.gz</span><span id="3c4b" class="my iw hi mu b fi nf na l nb nc"># Add the executable - s2i - to your path<br/>  cp s2i ../.local/bin/</span></pre><p id="53b8" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">太棒了。我们快到Python部分了。接下来，我们需要安装一些依赖项。</p><p id="a4e9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">安装Scikit-learn，GRPC工具</strong></p><p id="d882" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们需要scikit-learn，用于机器学习的规范python包。我们还将安装grpc工具，以防您稍后想要发出rpc请求(我将展示如何调用REST上的模型)</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="2807" class="my iw hi mu b fi mz na l nb nc">sudo pip install sklearn grpcio-tools</span></pre><p id="d75d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">简单。现在让我们找到一个非常基本的sklearn示例，我们可以用它来进行我们的第一次seldon部署。</p><p id="6466" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">克隆谢顿-核心示例</strong></p><p id="0e1e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">幸运的是，谢顿的好人创造了一些我们可以利用的例子。让我们使用git克隆他们的示例repo并运行其中一个</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="8f3a" class="my iw hi mu b fi mz na l nb nc"># Clone the repo<br/>git clone https://github.com/SeldonIO/seldon-core-launcher.git </span><span id="5bdc" class="my iw hi mu b fi nf na l nb nc"># cd into the example directory we want to run<br/>cd seldon-core-launcher/seldon-core/getting_started/wrap-model</span></pre><p id="0bd0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在这些例子都是用Jupyter笔记本提供的。通常来说，这是个好消息。然而，我承诺我们将在谷歌云外壳中运行一切(这是我的整个“唯一的要求是一个网络浏览器和一个良好的态度”的事情)。</p><p id="bd62" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">遗憾的是，我无法访问在我的谷歌云外壳中运行的Jupyter笔记本实例。如果您在其他地方运行这个示例，就不会有这个问题。</p><p id="3c1c" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">也就是说，这是我们简单的解决方法，这样我们就可以继续实现只有浏览器的梦想。我们将相关的代码片段写成python脚本，而不是笔记本！嘣！</p><p id="fc4d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">创建一个名为<code class="du ng nh ni mu b">train_model.py</code>的基本脚本来训练我们的模型</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="9d4f" class="my iw hi mu b fi mz na l nb nc">#train_model.py<br/><strong class="mu hj">import</strong> <strong class="mu hj">numpy</strong> <strong class="mu hj">as</strong> <strong class="mu hj">np</strong><br/><strong class="mu hj">import</strong> <strong class="mu hj">os</strong><br/><strong class="mu hj">from</strong> <strong class="mu hj">sklearn.linear_model</strong> <strong class="mu hj">import</strong> LogisticRegression<br/><strong class="mu hj">from</strong> <strong class="mu hj">sklearn.pipeline</strong> <strong class="mu hj">import</strong> Pipeline<br/><strong class="mu hj">from</strong> <strong class="mu hj">sklearn.externals</strong> <strong class="mu hj">import</strong> joblib<br/><strong class="mu hj">from</strong> <strong class="mu hj">sklearn</strong> <strong class="mu hj">import</strong> datasets<br/><br/><strong class="mu hj">def</strong> main():<br/>    clf = LogisticRegression()<br/>    p = Pipeline([('clf', clf)])<br/>    print('Training model...')<br/>    p.fit(X, y)<br/>    print('Model trained!')<br/><br/>    filename_p = 'IrisClassifier.sav'<br/>    print('Saving model in <strong class="mu hj">%s</strong>' % filename_p)<br/>    joblib.dump(p, filename_p)<br/>    print('Model saved!')<br/>    <br/><strong class="mu hj">if</strong> __name__ == "__main__":<br/>    print('Loading iris data set...')<br/>    iris = datasets.load_iris()<br/>    X, y = iris.data, iris.target<br/>    print('Dataset loaded!')<br/>    main()</span></pre><p id="edbc" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我现在能听到抱怨了。Gus —没有训练/测试分割？没有标准化也没有超参数调优？这是什么机器学习的野蛮？你真没礼貌，先生！？</p><p id="c1be" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">冷静点。这不是一个ML教程(即使是，我也不知道那些答案)。我们在这里学习如何使用有趣的图形部署模型，如AB测试、多臂bandit和所有好东西。让我们不要被基本的ML所困扰。现在已经够好了。</p><p id="0f90" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">保存文件，然后通过以下方式运行它:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="cd91" class="my iw hi mu b fi mz na l nb nc">python train_model.py</span></pre><p id="5212" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">您应该会在本地目录中看到一个名为IrisClassifier.sav的新文件。干得好！</p><p id="87ac" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">用s2i包装运行时代码</strong></p><p id="1b8a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在我们有了一个训练好的模型，是时候定义一个函数来返回我们模型的预测了。这是事情开始变得有趣的地方。我们可以让s2i为我们构建模型服务框架，而不是使用Flask或Tornado这样的web框架来服务我们的代码。</p><p id="5f99" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们所要做的就是将模型定义为一个类(如下例所示)。创建一个名为<code class="du ng nh ni mu b">IrisClassifier.py</code>的文件</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="c705" class="my iw hi mu b fi mz na l nb nc">#IrisClassifier.py<br/>from sklearn.externals import joblib<br/><br/>class IrisClassifier(object):<br/><br/>    def __init__(self):<br/>        self.model = joblib.load('IrisClassifier.sav')<br/>        self.class_names = ["iris-setosa","iris-vericolor","iris-virginica"];<br/>    # feature_names aren't needed <br/>    def predict(self,X,features_names):<br/>        return self.model.predict_proba(X)</span></pre><p id="f1f9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">事情是这样的。当类被初始化时，我们的代码从磁盘加载我们之前训练的模型<code class="du ng nh ni mu b">IrisClassifer.sav</code>。然后，我们定义一个<code class="du ng nh ni mu b">predict</code>函数，它接受各种花的输入(这就是虹膜分类器的作用，尽管这对于理解本教程来说不是必需的),并返回花的分类概率。</p><p id="9652" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果这看起来很基本，那是因为它确实如此。我们没有定义路线或创建应用程序，我们只是编写了一个带有预测功能的简单类。不算太寒酸。</p><p id="dc0e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">用s2i构建Docker图像</strong></p><p id="bc96" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">除了上面的类，s2i还需要一个配置文件。这是我们告诉s2i如何为我们的模型服务的地方。如果你按照本教程前面的说明克隆了seldon-core repo，这一切对你都是可用的。让我们通过运行<code class="du ng nh ni mu b">cat .s2i/environment</code>来看看s2i配置文件。您应该会看到下面的输出。这就是我们如何告诉s2i将我们的模型作为Docker容器中的REST API。</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="24c1" class="my iw hi mu b fi mz na l nb nc">$ #cat.s2i/environment</span><span id="f360" class="my iw hi mu b fi nf na l nb nc">MODEL_NAME=IrisClassifier<br/>API_TYPE=REST<br/>SERVICE_TYPE=MODEL<br/>PERSISTENCE=0</span></pre><p id="c766" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">requirements.txt文件也是必需的(幸好包括在内)。这是我们告诉Docker我们的模型需要运行哪些依赖项的地方。在这个例子中，你可以看到它非常小</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="4737" class="my iw hi mu b fi mz na l nb nc">$ cat requirements.txt</span><span id="a8ed" class="my iw hi mu b fi nf na l nb nc">scikit-learn==0.19.0<br/>scipy==0.18.1</span></pre><p id="6308" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在有了我们的环境和需求文件，我们可以运行s2i builder工具来构建服务于我们模型的Docker映像。以下是如何做到这一点。</p><p id="787b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">首先，您需要一个docker映像存储库(docker映像构建完成后，我们将在这里存储它)。Docker Hub是一个很好的(免费的)方法。如果你还没有这样做，去<a class="ae iu" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>创建一个免费账户。记住你的用户名，因为我们马上就要用到它。</p><p id="224e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">第二，我们需要登录docker。我们通过在命令行运行<code class="du ng nh ni mu b">docker login</code>来实现这一点。输入您的用户名和密码(与登录Docker Hub相同)，您就可以开始了。</p><p id="afa9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在让我们将环境变量<code class="du ng nh ni mu b">DOCKER_REPO</code>设置为Docker Hub用户名，然后像这样运行s2i build命令:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="d082" class="my iw hi mu b fi mz na l nb nc">env DOCKER_REPO=gcav66 #Replace "gcav66" with your Docker Hub uname</span><span id="513e" class="my iw hi mu b fi nf na l nb nc">s2i build . seldonio/seldon-core-s2i-python3 ${DOCKER_REPO}/sklearn-iris:0.1</span></pre><p id="02c3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们在这里做的是使用一个预定义的谢顿核心python3 docker图像，然后添加我们的模型和依赖关系。细节没有你的手指敲击键盘重要。这是我们样板代码的结尾。</p><p id="8902" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">热辣迪吉！我们一直在前进</p><p id="ae24" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">将Docker图像推送到Docker Repo </strong></p><p id="12c0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在，这一部分的最后一步是将我们新建的Docker映像推送到我们的Docker Hub帐户。下面是如何做到这一点:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="f120" class="my iw hi mu b fi mz na l nb nc">docker push gcav66/sklearn-iris:0.1 #replace "gcav66" with the DOCKER_REPO environment variable or just hard code your Docker Hub username</span></pre><p id="0f00" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">嘣！现在，我们已经成功地将模型映像推送到Docker Hub repo。我们终于准备好用谢顿核心部署它了。现在才是真正有趣的时候</p><h1 id="9b80" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">4.使用Seldon-core将我们的AB测试定义为模型图</h1><p id="4366" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">这是橡胶与路面相遇的地方。</p><p id="91da" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们需要做的第一件事是启用端口转发。点击“+”按钮，在Google Cloud shell中打开一个新的Shell，如下所示</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nj"><img src="../Images/3a0eeb36c0658ca3f348bbb52b4dd9f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*ju_85ZqneKnydqfROblejQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">单击+按钮打开一个新的外壳</figcaption></figure><p id="8903" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在这个新终端中，粘贴以下命令</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="204b" class="my iw hi mu b fi mz na l nb nc">kubectl port-forward $(kubectl get pods -l app=seldon-apiserver-container-app -o jsonpath='{.items[0].metadata.name}') 8002:8080</span></pre><p id="c380" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果您看到如下所示的输出，那么它运行成功:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="9b23" class="my iw hi mu b fi mz na l nb nc">Forwarding from 127.0.0.1:8002 -&gt; 8080<br/>Forwarding from [::1]:8002 -&gt; 8080</span></pre><p id="7f3d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在让我们创建一个新的python脚本<code class="du ng nh ni mu b">deploy.py</code></p><p id="84b9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">粘贴以下代码:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="de83" class="my iw hi mu b fi mz na l nb nc"><strong class="mu hj">import</strong> <strong class="mu hj">requests</strong><br/><strong class="mu hj">from</strong> <strong class="mu hj">requests.auth</strong> <strong class="mu hj">import</strong> HTTPBasicAuth<br/><strong class="mu hj">from</strong> <strong class="mu hj">proto</strong> <strong class="mu hj">import</strong> prediction_pb2<br/><strong class="mu hj">from</strong> <strong class="mu hj">proto</strong> <strong class="mu hj">import</strong> prediction_pb2_grpc<br/><strong class="mu hj">import</strong> <strong class="mu hj">grpc</strong><br/><strong class="mu hj">try</strong>:<br/>    <strong class="mu hj">from</strong> <strong class="mu hj">commands</strong> <strong class="mu hj">import</strong> getoutput <em class="lq"># python 2</em><br/><strong class="mu hj">except</strong> <strong class="mu hj">ImportError</strong>:<br/>    <strong class="mu hj">from</strong> <strong class="mu hj">subprocess</strong> <strong class="mu hj">import</strong> getoutput <em class="lq"># python 3</em><br/><br/>API_HTTP="localhost:8002"<br/>API_GRPC="localhost:8003"<br/><br/><strong class="mu hj">def</strong> get_token():<br/>    payload = {'grant_type': 'client_credentials'}<br/>    response = requests.post(<br/>                "http://"+API_HTTP+"/oauth/token",<br/>                auth=HTTPBasicAuth('oauth-key', 'oauth-secret'),<br/>                data=payload)<br/>    print(response.text)<br/>    token =  response.json()["access_token"]<br/>    <strong class="mu hj">return</strong> token<br/><br/><strong class="mu hj">def</strong> rest_request():<br/>    token = get_token()<br/>    headers = {'Authorization': 'Bearer '+token}<br/>    payload = {"data":{"names":["sepallengthcm","sepalwidthcm","petallengthcm","petalwidthcm"],"tensor":{"shape":[1,4],"values":[5.1,3.5,1.4,0.2]}}}<br/>    response = requests.post(<br/>                "http://"+API_HTTP+"/api/v0.1/predictions",<br/>                headers=headers,<br/>                json=payload)<br/>    print(response.text)</span></pre><p id="88aa" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在这里有很多，我承认它看起来很可怕，但只有一个关键部分你需要注意——<code class="du ng nh ni mu b">payload</code></p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="fbd9" class="my iw hi mu b fi mz na l nb nc">payload = {"data":{"names":["sepallengthcm","sepalwidthcm","petallengthcm","petalwidthcm"],"tensor":{"shape":[1,4],"values":[5.1,3.5,1.4,0.2]}}}</span></pre><p id="977f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们所要做的就是告诉谢顿-核心:</p><ul class=""><li id="c7b7" class="lc ld hi jv b jw kr ka ks ke le ki lf km lg kq lh li lj lk bi translated">我们功能的名称，例如“分离长度…”</li><li id="4c73" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">我们特征的形状，例如[1，4](一行4列)</li><li id="5299" class="lc ld hi jv b jw ll ka lm ke ln ki lo km lp kq lh li lj lk bi translated">实际值，例如[5.1，3.5，1.4]</li></ul><p id="22d5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">因此，当你用谢顿核心提供其他例子时，你很可能会发现自己正在编辑这个片段。如果您发送一个带有“名称”、“形状”和“值”的<code class="du ng nh ni mu b">payload</code>(后两个属于“张量”父项)，您就可以开始了。</p><p id="2191" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">再编辑一个讨厌的文件，我们就都准备好了。下一个任务是为谢顿核心定义我们的图表看起来像什么。</p><p id="e70e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">让我们从简单开始，将我们的模型部署为一个普通的REST API。在我们掌握了seldon-core的部署技巧后，我们将加大赌注，建立我们的AB测试。我知道这是你来这里的目的，我不会让你失望的。</p><p id="5270" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在您当前的目录中，您会发现一个名为<code class="du ng nh ni mu b">TMPL_deployment.json.</code>的文件</p><p id="5ae2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">(如果您在云外壳中迷路，也不用担心，您需要进入的目录是* sel don-core-launcher/sel don-core/getting _ started/wrap-model *)</p><p id="d6c4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">打开<code class="du ng nh ni mu b">TMPL_deployment.json</code>，让我们编辑一个值:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="8d98" class="my iw hi mu b fi mz na l nb nc">{<br/>    "apiVersion": "machinelearning.seldon.io/v1alpha2",<br/>    "kind": "SeldonDeployment",<br/>    "metadata": {<br/>        "labels": {<br/>            "app": "seldon"<br/>        },<br/>        "name": "sklearn-iris-example"<br/>    },<br/>    "spec": {<br/>        "name": "sklearn-iris-deployment",<br/>        "oauth_key": "oauth-key",<br/>        "oauth_secret": "oauth-secret",<br/>        "predictors": [<br/>            {<br/>                "componentSpecs": [{<br/>                    "spec": {<br/>                        "containers": [<br/>                            {<br/>                                "image": "gcav66/sklearn-iris:0.1",<br/>                                "imagePullPolicy": "IfNotPresent",<br/>                                "name": "sklearn-iris-classifier",<br/>                                "resources": {<br/>                                    "requests": {<br/>                                        "memory": "1Mi"<br/>                                    }<br/>                                }<br/>                            }<br/>                        ],<br/>                        "terminationGracePeriodSeconds": 20<br/>                    }<br/>                }],<br/>                "graph": {<br/>                    "children": [],<br/>                    "name": "sklearn-iris-classifier",<br/>                    "endpoint": {<br/>                        "type" : "REST"<br/>                    },<br/>                    "type": "MODEL"<br/>                },<br/>                "name": "classifier",<br/>                "replicas": 1,<br/>                "annotations": {<br/>                "predictor_version" : "0.1"<br/>                }<br/>            }<br/>        ]<br/>    }<br/>}</span></pre><p id="d7f0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">您必须更改的一个值是要从Docker Hub用户名中提取的图像的名称。</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="4192" class="my iw hi mu b fi mz na l nb nc">#Swap "gcav66" with your username<br/>"image": "gcav66/sklearn-iris:0.1",</span></pre><p id="3a0d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这就是改变。值得看一下<code class="du ng nh ni mu b">graph</code>键里面的数据。我们将很快在这里进行一些编辑，将我们的部署从基本端点更改为AB测试。但首先，让我们把这个东西运行起来。</p><p id="f418" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们通过运行以下命令来创建我们的谢顿部署:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="3a9a" class="my iw hi mu b fi mz na l nb nc">kubectl apply -f TMPL_deployment.json</span></pre><p id="9e2a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">然后休息30秒，通过将这个粘贴到shell中来验证你的seldon应用程序是否正在运行</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="ef75" class="my iw hi mu b fi mz na l nb nc">kubectl get seldondeployments sklearn-iris-example -o jsonpath='{.status}'</span></pre><p id="ae65" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在输出中，如果您看到*replicas:1*您就可以开始了。这可能需要一两分钟，但应该不会超过这个时间。我们的模型终于部署好了。到达终点的时间到了。</p><p id="f15b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在，如果您还记得，我们正在Google Cloud Shell中运行这个完整的示例(所以我们可以只使用我们的web浏览器来运行一切)。这款出色工具的一个限制是它不容易支持运行jupyter笔记本(我知道我之前提到过这一点，但值得重复一遍)。因此，我们不再运行塞尔顿团队提供的笔记本单元，而是调用我们之前创建的<code class="du ng nh ni mu b">deploy_model.py </code>脚本。</p><p id="3993" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">以下是如何做到这一点。通过键入:<code class="du ng nh ni mu b">ipython</code>打开ipython shell</p><p id="24b4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">然后在新的ipython shell中，键入:</p><p id="b088" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><code class="du ng nh ni mu b">from deploy_model import rest_request</code></p><p id="7560" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">“deploy_model”对应于本地目录中的<code class="du ng nh ni mu b">deploy_model.py </code>文件，而<code class="du ng nh ni mu b">rest_request</code>是我们定义的调用API的函数的名称。</p><p id="c6e2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">然后键入<code class="du ng nh ni mu b">rest_request()</code>进行API调用:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="c199" class="my iw hi mu b fi mz na l nb nc">In [<strong class="mu hj">3</strong>]: rest_request()<br/>{"access_token":"b01d867a-ebf1-4d7f-8764-c8b11ae43461",<br/>"token_type":"bearer",<br/>"expires_in":43199,<br/>"scope":"read write"}<br/>{  "meta": <br/>{    "puid": "j64h9tqf404rv2j3ikc8r98sdf",    <br/>"tags": {    },    <br/>"routing": {    }  },  <br/>"data": <br/>{    "names": ["iris-setosa", "iris-vericolor", "iris-virginica"],    "tensor": {      "shape": [1, 3],      "values": [0.9974160323001712, 0.002583770255316237, 1.9744451239167056E-7]    }  }}</span></pre><p id="d04b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">给定我们的输入数据，模型返回预测第一个值(iris-setosa)是正确的分类结果(99%)</p><p id="b1f2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">太棒了。您刚刚使用seldon-core部署并测试了您的第一个模型！但是您大老远跑来并不是为了停止一个基本的模型部署。让我们更新一下AB测试的模型图。</p><p id="694e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">退出ipython shell，通过运行以下命令来删除我们现有的部署:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="18c9" class="my iw hi mu b fi mz na l nb nc">kubectl delete -f TMPL_deployment.json</span></pre><p id="fa1b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在让我们创建一个新的模型图json文件<code class="du ng nh ni mu b">ab_test.json</code></p><p id="13fb" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">粘贴以下代码:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="aee4" class="my iw hi mu b fi mz na l nb nc">{<br/>    "apiVersion": "machinelearning.seldon.io/v1alpha2",<br/>    "kind": "SeldonDeployment",<br/>    "metadata": {<br/>        "labels": {<br/>            "app": "seldon"<br/>        },<br/>        "name": "sklearn-iris-example"<br/>    },<br/>    "spec": {<br/>        "name": "sklearn-iris-deployment",<br/>        "oauth_key": "oauth-key",<br/>        "oauth_secret": "oauth-secret",<br/>        "predictors": [<br/>            {<br/>                "componentSpecs": [{<br/>                    "spec": {<br/>                        "containers": [<br/>                            {<br/>                                "image": "gcav66/sklearn-iris:0.1",<br/>                                "imagePullPolicy": "IfNotPresent",<br/>                                "name": "classifier-1",<br/>                                "resources": {<br/>                                    "requests": {<br/>                                        "memory": "1Mi"<br/>                                    }<br/>                                }<br/>                            }],<br/>                        "terminationGracePeriodSeconds": 20<br/>                    }},<br/>                {<br/>                    "metadata":{<br/>                        "labels":{<br/>                            "version":"v2"<br/>                        }<br/>                    },<br/>                        "spec":{<br/>                            "containers":[<br/>                            {<br/>                                "image": "gcav66/sklearn-iris:0.1",<br/>                                "imagePullPolicy": "IfNotPresent",<br/>                                "name": "classifier-2",<br/>                                "resources": {<br/>"requests": {<br/>                                        "memory": "1Mi"<br/>                                    }<br/>                                }<br/>                            }<br/>                        ],<br/>                        "terminationGracePeriodSeconds": 20<br/>                                   }<br/>                                   }],<br/>                "name": "classifier",<br/>                "replicas": 1,<br/>                "annotations": {<br/>                    "predictor_version": "v1"<br/>                },<br/>                "graph": {<br/>                    "name": "random-ab-test",<br/>                    "endpoint":{},<br/>                    "implementation":"RANDOM_ABTEST",<br/>                    "parameters": [<br/>                        {<br/>                            "name":"ratioA",<br/>                            "value":"0.5",<br/>                            "type":"FLOAT"<br/>                        }<br/>                    ],<br/>                    "children": [<br/>                        {<br/>                            "name": "classifier-1",<br/>                            "endpoint":{<br/>                                "type":"REST"<br/>                            },<br/>                            "type":"MODEL",<br/>                            "children":[]<br/>                        },<br/>                        {<br/>                            "name": "classifier-2",<br/>                            "endpoint":{<br/>                                "type":"REST"<br/>                            },<br/>                            "type":"MODEL",<br/>                            "children":[]<br/>                        }<br/>                    ]<br/>                }<br/>            }<br/>        ]<br/>    }<br/>}</span></pre><p id="fa54" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">重要的是。我们告诉seldon我们想要运行哪个模型(两次都是我们无聊的iris分类器)，我们想要运行的图(abtest)，以及我们想要如何在每个部署的模型之间路由流量(随机)。</p><p id="1e94" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">正如您所想象的，我们可以很容易地将它扩展到使用不同模型的其他模型路由场景。</p><p id="670e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在让我们部署新的模型图:</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="48aa" class="my iw hi mu b fi mz na l nb nc">kubectl apply -f ab_test.json</span></pre><p id="b561" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在稍长时间的等待之后(毕竟，seldon必须部署*两个*模型，而不是一个)，我们通过运行来验证我们的模型已经部署</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="5529" class="my iw hi mu b fi mz na l nb nc">kubectl get seldondeployments sklearn-iris-example -o jsonpath='{.status}'</span></pre><p id="9ef0" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">如果我们看到*replicas:1*我们都准备好发送一些针对AB测试的请求。</p><p id="eb08" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在我们再次启动<code class="du ng nh ni mu b">ipython</code> shell并重复我们之前的命令。请注意，如果您不想再次键入<code class="du ng nh ni mu b">from deploy_model import rest_request</code>和<code class="du ng nh ni mu b">rest_request()</code>，您可以使用键盘上的向上箭头。</p><p id="5335" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在您应该看到您的模型结果，这次被注释为被路由到我们两个部署模型中的一个</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nk"><img src="../Images/4b4e9a79ef8bd8f79fa60bc5c6a06c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AAmXVX733lcv96j7qjWgGA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">那不是很美吗！？</figcaption></figure><p id="a431" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">我们可以看到，在“routing”部分，seldon将模型编号标注为“1”或“0”，表明我们的结果是从哪个模型返回的。</p><p id="93ae" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">拍拍自己的背。使用Kubernetes、Scikit-learn和Seldon-core，您只需使用Google Cloud和您的web浏览器就可以部署您的第一个ML模型图(AB测试)。</p><p id="cf03" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">最后一步。让我们拆除已部署的模型。几乎伤透了我的心(但我们不想从谷歌云招致额外的费用)</p><pre class="kw kx ky kz fd mt mu mv mw aw mx bi"><span id="51b9" class="my iw hi mu b fi mz na l nb nc">kubectl delete -f ab_test.json <br/>#To same goodbye for now</span></pre><h1 id="1548" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">后续步骤</h1><p id="742b" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">诚然，这是一个非常基本的例子。但是如果你已经走了这么远，也许你会愿意走得更远一点。我知道我计划为自己尝试一些不同的模型图。我计划尝试构建各种不同的模型，并使用AB测试和multi-armed bandit将流量路由到这些模型。我希望你能加入我——模特界现在是你的天下了！</p><p id="a90d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这方面还有更多的内容。一如既往，</p><p id="ba89" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">保持美丽</p></div></div>    
</body>
</html>