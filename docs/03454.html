<html>
<head>
<title>Google Cloud Platform User Manual for Big Data Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云平台大数据项目用户手册</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/google-cloud-platform-user-manual-for-big-data-projects-15a86fa08fa8?source=collection_archive---------9-----------------------#2020-02-02">https://medium.com/analytics-vidhya/google-cloud-platform-user-manual-for-big-data-projects-15a86fa08fa8?source=collection_archive---------9-----------------------#2020-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/272bc815ff704759d9c46e75cece53d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UOPaMJLwN2o6eP_-"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">凯利·西克玛在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><blockquote class="iv iw ix"><p id="6cd0" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">这个博客也可以在<a class="ae iu" href="https://www.linkedin.com/pulse/google-cloud-platform-user-manual-big-data-projects-boning-zhang" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>找到。这个博客最初是供我们团队内部使用的，介绍了我们的谷歌云平台(GCP)项目的架构，我们使用GCP的最佳实践，以及获得访问和设置GCP项目的指导。现在公司的相关资料被删除了，但我保留了主要内容。</p></blockquote><p id="feea" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">通过这篇博客，您将了解如何访问和创建GCP项目，如何管理GCP的生产和开发环境，如何创建dataproc集群，向dataproc集群提交作业，运行大查询作业，将数据从云存储加载到大查询，如何使用GPU为深度学习模型创建计算机引擎，以及将数据从本地Hadoop集群复制到google云存储。</p><h2 id="3525" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">1、访问GCP</h2><p id="64d2" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">首先要<a class="ae iu" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">创建一个GCP项目</a>。</p><h2 id="8411" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">2、我们的GCP建筑</h2><ol class=""><li id="e661" class="la lb hi jb b jc kv jg kw jx lc jy ld jz le jw lf lg lh li bi translated">GCP项目</li></ol><p id="aa52" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">根据GCP <a class="ae iu" href="https://cloud.google.com/storage/docs/projects" rel="noopener ugc nofollow" target="_blank">文件</a>。<br/>“一个项目组织你所有的谷歌云平台资源。一个项目由一组用户组成；一组APIs以及这些API的计费、身份验证和监控设置。因此，例如，您的所有云存储桶和对象，以及访问它们的用户权限，都驻留在一个项目中。你可以有一个项目，也可以创建多个项目，用它们把你的谷歌云平台资源，包括你的云存储数据，组织成逻辑组。”</p><p id="8cfa" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在我们的GCP客户中，我们有三个云项目，每个团队成员都应该至少可以访问dev和stg项目。</p><p id="ec8f" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">gcpExploration，项目ID: xxxx-stg。这个项目是用来探索GCP的新特色。</p><p id="ab31" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">GCP开发，项目ID: xxxx-dev。这是我们的开发项目，用于数据管道和机器学习模型的开发和测试，也用于运行临时作业。</p><p id="00af" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">GCP生产，项目ID: xxxx-prd。这是我们的生产项目，所有的生产管道和模型都应该在这个项目中运行。</p><p id="eed9" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">2.访问控制</p><p id="1726" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我们的团队中有两个gcp组:gcp-user和gcp-admin。gcp项目的访问控制是基于gcp组来操作的:gcp -admin中的团队成员拥有对三个项目的所有访问权限，而gcp-user中的团队成员没有对生产项目的访问权限。生产管道和机器学习模型被设置为通过服务帐户而不是每个单独的团队成员的帐户来访问生产项目。</p><p id="8596" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在这里，拥有对项目的访问权意味着您拥有对项目中所有已启用组件的完全访问权，比如您可以创建和删除dataproc集群/计算机引擎，创建和删除大型查询数据集和表，以及对与该项目相关联的云存储执行写/读操作。</p><p id="6c98" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">3.数据存储</p><p id="d3f5" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我们在GCP有4个数据库，它们的云存储路径应该在例程中，如GS://GCP _ project _ id-warehouse/database . db/。<br/> a. project1:用于project1相关表，其在生产项目中的云存储路径为:GS://xxxx-prd-warehouse/project 1 . db/</p><p id="95bb" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.project2:用于project2相关表，其在生产项目中的云存储路径为:GS://xxxx-prd-warehouse/project 2 . db/</p><p id="11c8" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.cmn:用于常用表，如所有project1和project2项目都使用的uber表，其在生产项目中的云存储路径为:GS://xxxx-prd-warehouse/cmn . db/</p><p id="b904" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在gcp中，建议将所有数据和hdfs文件存储在相应项目的云存储中，即生产数据应驻留在生产项目的云存储中:gs://xxxx-prd-warehouse/。和测试/特别数据应该驻留在开发项目的云存储中。我们项目中的所有dataproc Hadoop集群共享同一个元存储，这意味着在不同项目的不同Hadoop集群中定义的表是跨项目共享的。dev和stg项目可以对prod项目中的云存储进行读访问。因此，dev/stg项目中的测试/特别作业可以使用prod项目中定义/驻留的表和数据。但是，不允许dev/stag项目中的test/adhoc作业写入prod项目中的云存储，这些测试表的数据应该驻留在stag/dev的云存储中。</p><p id="736b" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">使用云存储中存储的数据创建表的示例:</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="47e7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">4.访问其他团队的项目</p><p id="4207" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在我们协作团队的gcp项目中，我们的开发和生产项目都具有对云存储桶的读取权限。这意味着我们可以在我们的项目中的大查询/hadoop集群中操作他们云存储中的数据。他们项目中的dataproc集群也使用与我们相同的元存储，因此我们可以像在本地集群中一样直接读取他们项目中的表。</p><p id="5d76" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">5.从内部访问GCP</p><p id="03c0" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">本地集群需要使用服务帐户连接到GCP，然后我们可以在本地集群中运行作业并将结果转储到云中，或者我们可以创建和处理数据实际驻留在本地集群的云存储中的表。</p><h2 id="d51e" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">3、安装GCP SDK并设置gcloud config</h2><p id="bb6c" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">为了在终端中使用命令行连接到gcp项目，我们需要安装GCP SDK并设置配置。实际上，使用GCP控制台对用户来说更方便，所以这一步是不必要的。在开始下面的步骤<a class="ae iu" href="https://cloud.google.com/sdk/docs/quickstart-macos" rel="noopener ugc nofollow" target="_blank">安装GCP SDK </a>之前，我们需要确保python2.7已经安装在我们的笔记本电脑上。</p><p id="c5ff" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">1.下载并安装Google SDK</p><p id="f25b" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.点击下载mac os 64位的SDK<a class="ae iu" href="https://cloud.google.com/sdk/docs/quickstart-macos" rel="noopener ugc nofollow" target="_blank">b .解压tar.gz文件并运行。/谷歌-云-sdk/install.sh</a></p><p id="690d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">2.设置第一个GCP项目配置</p><p id="a6f3" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.运行命令:gcloud init <br/> b .在如下提示选择云项目时，选择[1]然后进入gcpStaging</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="d156" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.选择默认地区/区域:region=us-central1和zone=us-central1-a</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="7986" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">3.设置多个项目配置</p><p id="9ee6" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">运行“gcloud config配置列表”,您将看到只有stg项目已配置，我们需要<a class="ae iu" href="https://cloud.google.com/sdk/gcloud/reference/topic/configurations" rel="noopener ugc nofollow" target="_blank">为其他两个项目设置配置</a>。<br/>a .“g cloud config configuration create dev-config”创建一个新的空配置并将其激活<br/>b .“g cloud init”通过选择“[1]使用新设置重新初始化此配置[dev-config]”来设置配置<br/> c .新配置设置完成后，我们可以使用“g cloud config configuration activate stag-config”在不同项目之间切换<br/> d .我们还可以使用“g cloud config configuration delete[config name]”来删除项目配置</p><h2 id="54d3" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">4、云存储</h2><p id="4547" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">云存储独立于任何计算机引擎，这意味着删除计算机引擎不会删除云存储中的数据。云存储也是Hadoop兼容的文件系统，可以作为Hadoop集群的存储。</p><p id="c83c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">至少有三种方法可以访问云存储:</p><p id="dc6d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">1.GCP控制台</p><p id="c211" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我们可以创建/删除存储桶，上传/删除文件</p><p id="47e5" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">2.gsutil命令行</p><p id="8c3c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">参见:<a class="ae iu" href="https://cloud.google.com/storage/docs/quickstart-gsutil" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/storage/docs/quickstart-gsutil</a><br/>a . gsutil MB，创建存储桶<br/> b. gsutil cp，将本地文件复制到存储<br/> c. gsutil ls，列出存储桶中的文件<br/> d. gsutil cat，显示存储文件</p><h2 id="7133" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">5、使用计算机引擎的最佳实践</h2><p id="7f16" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">因为计算机引擎是根据我们请求的资源计费的，即使我们不使用虚拟机，我们也会不断地被收费。要停止被收费，我们需要删除计算机引擎。所以建议<strong class="jb hj">我们把重要的输入输出数据和代码保存在云存储</strong>里。建议直接从云存储桶读取输入，在代码中直接写到云存储。如果不可能，我们至少应该每天备份云存储/笔记本电脑中的数据和代码，尤其是在删除虚拟机之前。</p><p id="0d72" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">1.使用GPU设置深度学习计算机引擎的步骤</p><p id="7331" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.首先使用“g cloud config configuration activate[config _ name]”切换到托管计算机引擎的项目</p><p id="e5fe" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.使用gcloud命令行创建计算机引擎，您可能需要为您公司的项目指定子网</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="3641" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.转到GCP控制台-&gt;计算机引擎获取虚拟机的内部IP，并将您的ssh密钥添加到虚拟机。</p><p id="6b05" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">d.设置jupyter笔记本:</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><h2 id="62d7" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">6、GCP Dataproc上的Hadoop集群</h2><p id="9caf" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">GCP的Hadoop集群使用计算机引擎作为主节点和工作节点，因此Hadoop集群在请求的资源上收费，即CPU、内存和磁盘。所以建议使用按需Hadoop集群。对于一些临时作业，生产项目现在托管一个小型永久Hadoop集群，如果需要，可以进行扩展(如果需要，还可以在开发项目中创建永久Hadoop集群)。对于生产管道/模型，实践是在airflow dags中使用gcloud api创建Hadoop集群，然后在这个Hadoop集群中运行作业。当这些作业完成后，应该会删除airflow dags中的Hadoop集群。在airflow dag中使用按需hadoop集群的示例可以在<a class="ae iu" href="https://github.com/BoningZhang/Learning_Airflow/blob/master/DAGS/example_on_demand_dataproc/dag.py" rel="noopener ugc nofollow" target="_blank">这里</a>找到。使用这种实践，我们观察到由GCP dataproc引起的花费的快速减少。</p><p id="3590" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">1.向Hadoop集群提交作业</p><p id="de5c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">向Hadoop集群提交临时作业至少有三种方式。</p><p id="3722" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.在GCP控制台，选择Dataproc →选择作业→点击提交作业<br/>地区:us-central1 <br/>集群:选择我们的集群名称，即hadoop-cluster <br/>作业类型:可以是hadoop、pyspark、spark-sql、hive等等</p><p id="2625" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.使用gcloud SDK，确保激活正确的GCP项目，即Hadoop集群应该在激活的项目配置中</p><p id="6ab6" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">示例:gcloud dataproc作业提交配置单元—集群hadoop集群—执行“显示数据库”—美国中部地区1</p><p id="1360" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.登录到Hadoop集群中的虚拟机实例，然后在那里提交作业。不建议这样做。</p><p id="c390" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">2.在气流中运行Hadoop集群</p><p id="503a" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">Airflow使用gcloud python包和服务帐户与GCP的Dataproc Hadoop集群进行交互，API调用封装在operators中。我们经常使用的Dataproc操作符主要有三种:DataprocClusterCreateOperator、DataProcHiveOperator、DataprocClusterDeleteOperator。这些操作符经过修改后用于我们的GCP项目，我们的GCP项目和我们的气流平台之间的连接需要使用GCP服务帐户进行设置。</p><p id="37e0" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.DataprocClusterCreateOperator</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="08cb" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.DataProcHiveOperator</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="3d99" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.DataprocClusterDeleteOperator</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="d1ec" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">您可能会注意到，我使用“Hadoop-cluster-KPI-pacing-ratio-{{ ds }}”作为cluster_name，这是因为我们需要确保cluster_name在不同dag之间以及同一dag的不同dag运行之间是唯一的，示例Dag是每日计划的，因此{ { ds } }是可以的。否则，airflow任务实例可能会删除正在其他dag运行中运行作业的群集。我们也可以使用uuid来生成唯一的dataproc名称，但是在dataproc名称中包含dag信息将有助于监控作业。</p><p id="3b3e" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">3.在Hadoop集群中调试作业</p><p id="8765" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在Dataproc中，选择Jobs，您将会看到这个项目中完整的作业列表。通过单击作业，我们可以看到它的日志和输出。</p><h2 id="3f6f" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">7、大查询</h2><p id="7861" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">对于临时作业，建议使用Big Query运行查询，它非常快。大查询中有两种类型的表，一种是原生表，另一种是外部表。本地表的数据驻留在Big Query的存储中，这与云存储不同。外部表的数据驻留在其他外部源中，比如云存储。本机表的处理性能比外部表快。但是外部表的优点是它不需要额外的存储资源，更重要的是查询结果总是基于外部源数据的最新结果。但是，如果我们将HDFS文件作为原生表加载到Big Query的云存储中，那么一旦云存储中的数据更新，我们就需要重新加载它。</p><p id="0b32" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">实际上，我们使用parquet格式将数据存储在云存储中，这样可以节省大量的存储空间。而目前大查询不支持parquet格式作为外部数据源，因此我们必须在大查询中创建原生表，并将云存储中的数据加载到原生表中。我们应该记住，一旦数据更新，我们需要从云存储中重新加载数据。</p><p id="6725" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">大查询中的分区概念与Hive中的不同。此外，由于Big Query针对处理大型数据进行了优化，因此我们可以在一个大型查询表中加载多个分区的数据。例如，dctr表现在是基于每日分区的，但是在大型查询中，我们可以在单个大型查询表中加载一个月甚至更多天的数据。请注意，在加载到大查询表之后，分区字段将不在大查询的表模式中，因为在hive表的HDFS路径中没有分区列。</p><p id="8970" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">大查询至少有三种操作方式，其中使用GCP控制台更方便。目前，我们在开发和生产项目中有四个数据集。请在相应的数据集中创建大的查询表。大查询中的数据集类似于Hive中的数据库。</p><p id="ee3e" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">1.通过GCP控制台操作大型查询</p><p id="7e06" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.将一个月的dctr数据从云存储加载到大查询，可能需要大约2分钟</p><p id="36a7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">创建表来自:Google云存储<br/>从GCS桶中选择文件:gs_path <br/>文件格式:Parquet <br/>项目名称:wmt-customer-tech-case-sci-dev<br/>数据集名称:casesci_sem <br/>表类型:原生表</p><p id="fe85" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.在大查询中处理数据，大查询的SQL与Hive中的非常相似</p><p id="6f71" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">请注意“CAST(date_string AS STRING)”，因为在parquet格式中字符串类型存储为二进制以节省空间。在执行细节中，我们可以看到大查询处理150MB数据只需要1.2秒。</p><p id="2d83" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.写入新表，在query_settings中，选择“为查询结果设置目标表”</p><p id="9d6d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">2.通过bq命令行操作大型查询</p><p id="90cb" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.bq命令。例如，bq ls project_id，bq show project _ id:data _ set . table _ name，bq rm -t mydataset.mytable</p><p id="216d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.将一个月的dctr数据从云存储加载到大查询，确保在运行命令之前使用正确的项目配置</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="44a9" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">c.处理大型查询表</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="844e" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">d.写入新表</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="8070" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">3.通过Google Cloud API操作大查询</p><h2 id="0cca" class="ka kb hi bd kc kd ke kf kg kh ki kj kk jx kl km kn jy ko kp kq jz kr ks kt ku bi translated">8、将数据从本地Hadoop集群中的BFD集群迁移到GCP</h2><p id="2c05" class="pw-post-body-paragraph iy iz hi jb b jc kv je jf jg kw ji jj jx kx jm jn jy ky jq jr jz kz ju jv jw hb bi translated">目前，我们不打算将大量历史数据从本地Hadoop集群迁移到Google云存储，这可以通过在BFD集群中运行分布式拷贝作业来完成。但是从本地集群到GCP的连接需要使用GCP的服务帐户来设置，并且我们每天都将一些最终生产表从本地集群迁移到GCP。</p><p id="9949" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">1.将每日分区导出到GCP</p><p id="487f" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">a.通过将查询结果转储到指向Google云存储的外部表中，导出本地集群中的数据</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="66ac" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">b.在GCP创建指向Google云存储数据的表</p><figure class="lj lk ll lm fd ij"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="5795" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">2.将大量历史数据迁移到GCP</p><p id="7f9a" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">目前，我们不打算将大量历史数据从CDC迁移到Google云存储，这可以通过在BFD集群中运行分布式复制作业(distcp)来完成。我将构建一个仪表板，允许用户将大量历史数据从本地Hadoop集群复制到Google云存储中。</p></div></div>    
</body>
</html>