<html>
<head>
<title>Industrial IOT — Kepware data collection to Azure Data Explorer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">工业IOT-从Kepware数据收集到Azure Data Explorer</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/industrial-iot-kepware-data-collection-to-azure-data-explorer-454d7ce720c1?source=collection_archive---------28-----------------------#2020-05-02">https://medium.com/analytics-vidhya/industrial-iot-kepware-data-collection-to-azure-data-explorer-454d7ce720c1?source=collection_archive---------28-----------------------#2020-05-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1e66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为工业传感器、plc、控制系统和其他基于过程的系统(如MES和其他车间系统)提供数据存储。该系统还应具有查询从车间各种传感器收集的时间序列数据的能力。该系统可以是他们的仪表板、OEE和根本原因分析以及其他基于质量的用例的数据源。</p><p id="e530" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提供一个单一的商店，在这里我们可以集中所有的大批量生产操作，包括过程和工业传感器数据(时间序列)。很容易获得数据并存储在基于云的存储中，但这不允许我们使用查询数据进行实时和批量使用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/4b337b770a41c09b9c129694441d4777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*NuF64JInxdIbSJXt.jpg"/></div></figure><p id="5d8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用的组件</p><ul class=""><li id="a08e" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">机器人</li><li id="b158" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">生产线——制造产品的生产线</li><li id="549d" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">KepWare —物联网网关</li><li id="b8f3" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">Azure物联网中心—提供从kepware到云的安全数据通信</li><li id="d23a" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">Azure数据浏览器—云历史存储</li><li id="ef19" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">仪表板—可视化工具</li></ul><p id="4ed4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们可以从数据收集器或网关(行业术语)收集数据。我选择的网关是PTC Kepware。还有其他方法，如基于OPC UA的工具来收集数据。</p><p id="4f4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像Kepware这样的工具能够从运行在车间的旧系统中收集数据，这是改造用例所急需的。</p><p id="246d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在新工厂中，OPC UA可用作工业4.0的工业标准来收集数据。</p><p id="f81a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先让我们安装并配置Kepware。</p><p id="11a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还要配置要连接的设备，并订阅需要发送到云的标签。</p><p id="ee0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是Kepware如何向物联网中心发送数据的示例。</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="3e8f" class="ke kf hi ka b fi kg kh l ki kj">[ <br/>{ "timestamp": 1586780606000, <br/>"values": [ <br/>{ "id": "Channel1.Device1.Tag1", "v": 250, "q": true, "t": 1586780606000 }, <br/>{ "id": "Channel1.Device1.Tag2", "v": 220, "q": true, "t": 1586780606001 }, <br/>{ "id": "Channel1.Device1.Tag3", "v": 150, "q": true, "t": 1586780606002 } <br/>] <br/>}, <br/>{ "timestamp": 1586780606030, <br/>"values": [ <br/>{ "id": "Channel1.Device1.Tag1", "v": 255, "q": true, "t": 1586780606031 }, <br/>{ "id": "Channel1.Device1.Tag2", "v": 223, "q": true, "t": 1586780606032 }, <br/>{ "id": "Channel1.Device1.Tag3", "v": 156, "q": true, "t": 1586780606033 } <br/>] <br/>}, <br/>{ "timestamp": 1586780606040, <br/>"values": [ <br/>{ "id": "Channel1.Device1.Tag1", "v": 251, "q": true, "t": 1586780606041 }, <br/>{ "id": "Channel1.Device1.Tag2", "v": 229, "q": true, "t": 1586780606041 }, <br/>{ "id": "Channel1.Device1.Tag3", "v": 153, "q": true, "t": 1586780606042 } <br/>] <br/>}, <br/>{ "timestamp": 1586780606060, <br/>"values": [ <br/>{ "id": "Channel1.Device1.Tag1", "v": 252, "q": true, "t": 1586780606061 }, <br/>{ "id": "Channel1.Device1.Tag2", "v": 224, "q": true, "t": 1586780606062 }, <br/>{ "id": "Channel1.Device1.Tag3", "v": 158, "q": true, "t": 1586780606063 } <br/>] <br/>} <br/>]</span></pre><p id="6f12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，通过物联网中心获得流量，然后创建一个消费者群体来支持Azure Data Explorer。</p><p id="1cb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦进入数据浏览器，就应该创建数据模型来推送数据。</p><p id="051c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure Data explorer允许我们通过编写Kusto查询来绘制图表和趋势。没有点击即走的环境。</p><p id="2d9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是Azure data explorer允许我们从其他业务系统获取数据，然后将这些数据与时间序列数据无缝地结合起来，以实现查询功能。因此，我们可以从资产管理系统或ERP中获取订单数据、资产管理数据，并将它们连接起来并构建查询。</p><p id="0237" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure data explorer还允许我们使用第三方工具或自定义网站来扩展和创建自己的仪表板。</p><p id="4e8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure Data explorer还内置了许多时间序列功能，用于时间序列分析，如预测、异常检测，甚至机器学习，如自动聚类和购物篮分析。</p><p id="76f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要启动Azure data explorer，首先创建存储数据的架构</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="23fd" class="ke kf hi ka b fi kg kh l ki kj">// Create table command //////////////////////////////////////////////////////////// <br/>.create table ['kepwaresample_stage'] (['values']:dynamic, ['timestamp']:datetime) </span><span id="43f9" class="ke kf hi ka b fi kk kh l ki kj">// Set 0d retention on stage table so that the data is deleted after its transformed <br/>.alter-merge table kepwaresample_stage policy retention softdelete = 0d </span><span id="005c" class="ke kf hi ka b fi kk kh l ki kj">// Create mapping command //////////////////////////////////////////////////////////// .create-or-alter table ['kepwaresample_stage'] ingestion json mapping 'kepwaresample_stage_mapping' '[{"column":"values","path":"$.values","datatype":"dynamic"},{"column":"timestamp","path":"$.timestamp","transform":"DateTimeFromUnixMilliseconds"}]' </span><span id="50e1" class="ke kf hi ka b fi kk kh l ki kj">//create function to extract the data from JSON </span><span id="448d" class="ke kf hi ka b fi kk kh l ki kj">.create-or-alter function TransformKepWareLogs() { kepwaresample_stage | mv-expand values | project msg_timestamp=timestamp, metric_timestamp=unixtime_milliseconds_todatetime(tolong(values.t)), metric_id=tostring(values.id), <br/>metric_value=tostring(values.v), <br/>metric_quality=tobool(values.q) <br/>} </span><span id="9495" class="ke kf hi ka b fi kk kh l ki kj">//create the final table that will hold the extracted data </span><span id="dc31" class="ke kf hi ka b fi kk kh l ki kj">.create table kepwaresample (msg_timestamp: datetime, metric_timestamp: datetime, metric_id: string, metric_value: string, metric_quality: bool) </span><span id="4a3a" class="ke kf hi ka b fi kk kh l ki kj">//Create update policy to bind the stabing table, function, and the destination table </span><span id="4734" class="ke kf hi ka b fi kk kh l ki kj">.alter table kepwaresample policy update @'[{"IsEnabled": true, "Source": "kepwaresample_stage", "Query": "TransformKepWareLogs()", "IsTransactional": true, "PropagateIngestionProperties": true}]' </span><span id="e5c9" class="ke kf hi ka b fi kk kh l ki kj">// Ingest data into table command /////////////////////////////////////////////////////////// </span><span id="70a1" class="ke kf hi ka b fi kk kh l ki kj">.ingest async into table ['kepwaresample_stage'] ('https://kkgkstrldkustodemo00.blob.core.windows.net/pbp-20200413-temp-e5c334ee145d4b43a3a2d3a96fbac1df/1586805347662_kepwaresample.json?sv=2018-03-28&amp;sr=c&amp;sig=uvob%2BuNmKN1FeDFo983Ldft0Z%2BNputQhYQYad9nZWbE%3D&amp;st=2020-04-13T18%3A15%3A47Z&amp;se=2020-04-17T19%3A15%3A47Z&amp;sp=rwdl') with (format='multijson',ingestionMappingReference='kepwaresample_stage_mapping',ingestionMappingType='Json',tags="['229fee5c-508d-4f26-99ae-3f2d007c813f']") </span><span id="304a" class="ke kf hi ka b fi kk kh l ki kj">//from the above run get the id and substitute below here </span><span id="50cc" class="ke kf hi ka b fi kk kh l ki kj">.show operations 2d8b2cbc-2bf1-496b-99f0-75ed6fb1ee8f </span><span id="0f76" class="ke kf hi ka b fi kk kh l ki kj">kepwaresample | limit 100</span></pre><p id="48e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然数据已经准备好用于实时和其他批处理用例。</p><p id="668f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">等待几分钟，看看数据是否在流动。如果数据是流动的，那么我们都是。</p><p id="4de8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了存储长期数据，我们可以连续导出到blob或ADLS gen2存储，以便长期访问。</p><ul class=""><li id="ebc5" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">创建存储帐户ADLS Gen2</li><li id="ac95" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">创建一个名为opcoutput的容器</li><li id="c424" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">获取Azure data explorer配置的存储帐户名、密钥以及容器名</li><li id="0a7e" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">配置Azure数据浏览器</li></ul><p id="b3d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经创建了表，这里是drop table命令</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="5dc0" class="ke kf hi ka b fi kg kh l ki kj">.drop external table opcExternalLongTerm</span></pre><p id="d6ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在创建外部表来长期存储</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="dde1" class="ke kf hi ka b fi kg kh l ki kj">.create external table opcExternalLongTerm (msg_timestamp: datetime, metric_timestamp: datetime, metric_id: string, metric_value: string, metric_quality: bool) kind=blob partition by "metric_id="metric_id, bin(TimeStamp, 1d) dataformat=csv ( h@'https://xxxxxx.blob.core.windows.net/opcoutput;xxxxxxxxxxxxxxxxxxxxxxxxx' )</span></pre><p id="17c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在在Azure Data Explorer中配置连续导出数据</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="406c" class="ke kf hi ka b fi kg kh l ki kj">.create-or-alter continuous-export opccontinousexport over (kepwaresample) to table opcExternalLongTerm with (intervalBetweenRuns=1h, forcedLatency=10m, sizeLimit=104857600) &lt;| kepwaresample</span></pre><p id="4977" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">去看出口</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="0d8c" class="ke kf hi ka b fi kg kh l ki kj">.show continuous-export opccontinousexport exported-artifacts | where Timestamp &gt; ago(1h)</span></pre><p id="9db1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要查找故障，请使用以下命令</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="8436" class="ke kf hi ka b fi kg kh l ki kj">.show continuous-export opccontinousexport failures</span></pre><p id="6fc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要启用和禁用，请使用下面的</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="d7f4" class="ke kf hi ka b fi kg kh l ki kj">.enable continuous-export opccontinousexport .disable continuous-export opccontinousexport</span></pre><p id="e5bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要查询数据，请使用:</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="dba6" class="ke kf hi ka b fi kg kh l ki kj">external_table("opcExternalLongTerm") | take 100</span></pre></div><div class="ab cl kl km gp kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="hb hc hd he hf"><p id="73c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ks">最初发表于</em><a class="ae kt" href="https://github.com/balakreshnan/IIoT-AI/blob/master/IIoT/kepwaretoadx.md" rel="noopener ugc nofollow" target="_blank"><em class="ks">【https://github.com】</em></a><em class="ks">。</em></p></div></div>    
</body>
</html>