<html>
<head>
<title>Pytest mocking cheatsheet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pytest嘲讽小抄</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/pytest-mocking-cheatsheet-dcebd84876e3?source=collection_archive---------0-----------------------#2020-06-12">https://medium.com/analytics-vidhya/pytest-mocking-cheatsheet-dcebd84876e3?source=collection_archive---------0-----------------------#2020-06-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/a8129d5093f3cd5aa80a81c673a8418b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IG64TCWJBcIlv9pQA5GiIA.png"/></div></div></figure><div class=""/><p id="ef23" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你好，你好，你好，我的工程师伙伴们！</p><p id="85c7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编辑:(05/01/2023):如果您觉得这份备忘单有用，请关注！我真的很感激！</p><p id="7056" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我已经有一段时间没有写这些了，但我最近开始了一个分享知识的探索，也许是为了避免有人像我解决问题一样用头撞墙。</p><p id="d641" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，我收集了一些我最常用的pytest夹具模拟。</p><p id="8b79" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所有这些模拟我都存储在conftest.py中，然后在需要时将它们放入我创建的测试中。</p><p id="2632" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="jo">依赖:</em> </strong></p><ul class=""><li id="a79d" class="jp jq ht is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">pytest</li><li id="e636" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">pytest_mock</li><li id="3c4c" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">瓶</li><li id="0256" class="jp jq ht is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">烧瓶_sqlalchemy</li></ul><h1 id="2086" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">如何模仿一个物体:</strong></h1><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="2546" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="8017" class="lk ke ht lg b fi lp lm l ln lo">import pytest</span><span id="8ead" class="lk ke ht lg b fi lp lm l ln lo">@pytest.fixture<br/>def mock_object():<br/>   class MockObject(object):<br/>      object_id = "id"<br/>      some_property = "some_property_value"<br/><br/>      def to_json(self):<br/>         return {<br/>            "objectId": self.object_id,<br/>            "someProperty": self.some_property,<br/>            <br/>         }<br/>   return MockObject()</span></pre><p id="665d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以这样在测试中使用它:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="d8c2" class="lk ke ht lg b fi ll lm l ln lo">"""test_functions.py"""</span><span id="8a7f" class="lk ke ht lg b fi lp lm l ln lo">def test_mocked_object(mock_object):<br/>    mock_object.object_id = "new_id"<br/><br/>    assert mock_object.to_json()["objectId"] == "new_id"</span></pre><p id="0cff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">显然，你可以根据自己的需要把它们变得复杂，但是为了节省时间，我会保持简单。</p><h1 id="df1b" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">如何模拟对象属性:</strong></h1><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="5ae7" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="29d0" class="lk ke ht lg b fi lp lm l ln lo">import pytest</span><span id="da78" class="lk ke ht lg b fi lp lm l ln lo">@pytest.fixture<br/>def mock_object_property(mocker):<br/>    mock = mocker.patch(<br/>        "test_functions.MyObject.property",<br/>        new_callable=mocker.PropertyMock,<br/>        return_value="new_property_value"<br/>    )<br/>    return mock</span></pre><p id="5e0a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你以下面的方式使用它，你会注意到“some_property”神奇地变成了“new_property_mock”:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="2305" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""test_functions.py"""<br/><br/></em>class MyObject(object):<br/>    property = "some_property"<br/><br/>def test_mocked_property(mock_object_property):<br/>    test_object = MyObject()<br/>    assert test_object.property == "new_property_value"</span></pre><p id="6ea6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在最常用的模拟…</p><h1 id="3a1f" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">如何模拟函数返回:</strong></h1><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="a25f" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="2b35" class="lk ke ht lg b fi lp lm l ln lo">import pytest</span><span id="ae6d" class="lk ke ht lg b fi lp lm l ln lo">@pytest.fixture<br/>def mock_function(mocker):<br/>    return mocker.patch("test_functions.my_function")</span></pre><p id="748f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在conftest中设置返回值，但是为了更加灵活，我倾向于在测试中设置:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="f997" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""test_functions.py"""<br/><br/></em>def my_function():<br/>    return "my_function_value"<br/><br/>def test_mock_function(mock_function):<br/>    mock_function.return_value = "new_value"<br/>    response = my_function()<br/><br/>    assert response == "new_value"</span></pre><h1 id="8812" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">如何模拟SQLAlchemy数据库模型:</h1><p id="1bcf" class="pw-post-body-paragraph iq ir ht is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">假设您的function.py文件中有以下模型</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="27b2" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""functions.py"""</em></span><span id="dbac" class="lk ke ht lg b fi lp lm l ln lo">from flask_sqlalchemy import SQLAlchemy<br/>from sqlalchemy.dialects.postgresql import VARCHAR</span><span id="712a" class="lk ke ht lg b fi lp lm l ln lo">db = SQLAlchemy()</span><span id="ed9d" class="lk ke ht lg b fi lp lm l ln lo">class MyModel(db.Model):<br/>    id = db.Column(<br/>        "id",<br/>        VARCHAR,<br/>        primary_key=True,<br/>        unique=True,<br/>        nullable=False,<br/>    )</span></pre><p id="733c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以这样嘲笑它:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="cf29" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="23b2" class="lk ke ht lg b fi lp lm l ln lo">import pytest<br/>from functions_to_mock.functions import MyModel<br/><br/>@pytest.fixture<br/>def mock_my_model():<br/>    my_model = MyModel(<br/>        id="my_mock_id",<br/>    )<br/>    return my_model</span></pre><p id="46cc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并在您的测试案例中使用:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="555d" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""test_functions.py"""</em></span><span id="7d1b" class="lk ke ht lg b fi lp lm l ln lo">def test_sqlalchemy_model_mock(mock_my_model):<br/><br/>    my_model = mock_my_model<br/><br/>    assert my_model.id == "my_mock_id"</span></pre><p id="1886" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我利用上述模型模仿的最常见方式是模仿SQLAlchemy查询属性get函数(我查询数据库的主要方式)。</p><h1 id="6e8a" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">模拟SQLAlchemy查询属性获取函数:</strong></h1><p id="918e" class="pw-post-body-paragraph iq ir ht is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">下面是如何模拟查询属性的get函数:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="8cf5" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="6feb" class="lk ke ht lg b fi lp lm l ln lo">import pytest</span><span id="20a9" class="lk ke ht lg b fi lp lm l ln lo">@pytest.fixture<br/>def mock_get_sqlalchemy(mocker):<br/>    mock = mocker.patch("flask_sqlalchemy._QueryProperty.__get__").return_value = mocker.Mock()<br/>    return mock</span></pre><p id="db07" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">重复使用前面的“我的模型”和“模拟我的模型”,我们可以在这样的测试中使用它:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="992d" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""test_functions.py"""</em></span><span id="1dd1" class="lk ke ht lg b fi lp lm l ln lo">from functions_to_mock.functions import MyModel<br/><br/>def test_sqlalchemy_query_property_get_mock(<br/>        mock_my_model,<br/>        mock_get_sqlalchemy,<br/>):<br/>    # SQLAlchemy returns a list for an "all" query<br/>    mock_get_sqlalchemy.all.return_value = [mock_my_model]  <br/>    response = MyModel.query.all()<br/><br/>    assert response == [mock_my_model]</span></pre><p id="63b8" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可爱的朱布里！</p><h1 id="6722" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">如何模拟烧瓶应用程序:</h1><p id="2ff8" class="pw-post-body-paragraph iq ir ht is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">最后，对于我们这些开发应用程序的人来说，这是一个非常常用的模拟。</p><p id="e006" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设您有以下应用程序:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="e89f" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""functions.py"""</em></span><span id="0bf8" class="lk ke ht lg b fi lp lm l ln lo">from flask import Flask, jsonify<br/><br/>app = Flask(__name__)<br/><br/>@app.route("/", methods=['GET'])<br/>def get_value():<br/>    return jsonify("some_value"), 200</span></pre><p id="3885" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是一个非常简单的应用程序示例，但在现实世界中，这将读入用户、数据库等的配置。所以在大多数情况下，你会想要模仿，所以你不用为单元测试设置整个应用程序。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="2a41" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="2a31" class="lk ke ht lg b fi lp lm l ln lo">import pytest<br/>from flask import Flask</span><span id="57ca" class="lk ke ht lg b fi lp lm l ln lo">@pytest.fixture<br/>def flask_app_mock():<br/>    <em class="jo">"""Flask application set up."""<br/>    </em>app_mock = Flask(__name__)<br/>    return app_mock</span></pre><p id="fdd5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">按以下方式使用:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="6be8" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""test_functions.py"""</em></span><span id="395e" class="lk ke ht lg b fi lp lm l ln lo">from functions_to_mock.functions import get_value<br/><br/>def test_flask_app_light_mock(<br/>        flask_app_mock,<br/>):<br/>    with flask_app_mock.app_context():<br/>        response = get_value()<br/><br/>    assert response[0].json == "some_value"</span></pre><p id="93e6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">是时候使用我们之前创建的模拟来模拟一些“真实世界”的复杂应用程序级别了…</p><h1 id="4d70" class="kd ke ht bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated"><strong class="ak">奖励:模拟全系统(掌握你的模拟)</strong></h1><p id="5924" class="pw-post-body-paragraph iq ir ht is b it lq iv iw ix lr iz ja jb ls jd je jf lt jh ji jj lu jl jm jn hb bi translated">这是事情真正升温的地方！假设您在functions.py文件中有以下小flask应用程序。这包含一个应用程序，该应用程序将SQLAlchemy绑定到一个模型(MyModel)。对于本地路由，它返回数据库中id的值。</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="98f3" class="lk ke ht lg b fi ll lm l ln lo">"""functions.py"""</span><span id="3e36" class="lk ke ht lg b fi lp lm l ln lo">from flask import Flask, jsonify<br/>from flask_sqlalchemy import SQLAlchemy<br/>from sqlalchemy.dialects.postgresql import VARCHAR</span><span id="85ef" class="lk ke ht lg b fi lp lm l ln lo">db = SQLAlchemy()</span><span id="04f3" class="lk ke ht lg b fi lp lm l ln lo">app = Flask(__name__)<br/>app.config["SQLALCHEMY_DATABASE_URI"] = "postgresql+pg8000://alex@localhost:5432/test_alex"<br/>app.config["SQLALCHEMY_BINDS"] = {<br/>"test_alex": app.config["SQLALCHEMY_DATABASE_URI"]<br/>}<br/>app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False</span><span id="693f" class="lk ke ht lg b fi lp lm l ln lo">db.init_app(app)<br/></span><span id="3901" class="lk ke ht lg b fi lp lm l ln lo">class MyModel(db.Model):<br/>    id = db.Column(<br/>        "id",<br/>        VARCHAR,<br/>        primary_key=True,<br/>        unique=True,<br/>        nullable=False,<br/>    )<br/></span><span id="08dc" class="lk ke ht lg b fi lp lm l ln lo">@app.route("/", methods=['GET'])<br/>def get_value():<br/>    mod = MyModel.query.first()<br/>    return jsonify(mod.id), 200</span></pre><p id="b29f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以利用之前所学的知识，将以下设备添加到conftest.py文件中，以帮助模拟上述系统:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="58db" class="lk ke ht lg b fi ll lm l ln lo">"""<em class="jo">conftest.py"""</em></span><span id="950b" class="lk ke ht lg b fi lp lm l ln lo">import pytest<br/><br/>from flask import Flask<br/>from flask_sqlalchemy import SQLAlchemy<br/><br/>from functions_to_mock.functions import MyModel<br/></span><span id="6871" class="lk ke ht lg b fi lp lm l ln lo"># This fixture will mock your DB table model<br/>@pytest.fixture<br/>def mock_my_model(): <br/>    my_model = MyModel(<br/>        id="my_mock_id",<br/>    )<br/>    return my_model<br/></span><span id="1d32" class="lk ke ht lg b fi lp lm l ln lo"># This fixture will mock the SQLAlchemy query response from the DB<br/>@pytest.fixture<br/>def mock_get_sqlalchemy(mocker):<br/>    mock = mocker.patch("flask_sqlalchemy._QueryProperty.__get__").return_value = mocker.Mock()<br/>    return mock<br/></span><span id="e279" class="lk ke ht lg b fi lp lm l ln lo">#This fixture will mock your flask application<br/>@pytest.fixture<br/>def flask_app_mock():<br/>    <em class="jo">"""Flask application mock set up."""<br/>    </em>app_mock = Flask(__name__)<br/>    db = SQLAlchemy(app_mock)<br/>    db.init_app(app_mock)<br/>    return app_mock</span></pre><p id="9e93" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您的快乐之路单元测试如下所示:</p><pre class="lb lc ld le fd lf lg lh li aw lj bi"><span id="34ef" class="lk ke ht lg b fi ll lm l ln lo"><em class="jo">"""test_functions.py"""<br/></em>from functions_to_mock.functions import get_value<br/><br/><br/>def test_flask_app_mock(<br/>        flask_app_mock,<br/>        mock_my_model,<br/>        mock_get_sqlalchemy,<br/>):<br/>    mock_get_sqlalchemy.first.return_value = mock_my_model<br/>    with flask_app_mock.app_context():<br/>        response = get_value()<br/><br/>    assert response[0].json == "my_mock_id"</span></pre><p id="c331" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望你已经发现这是有用的。如果你这样做，我会看看创造更多的cheatsheet类型的职位。</p><p id="a96e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你是一个更注重听觉的学习者，我还在YouTube上开设了一个知识分享频道:<a class="ae lv" href="https://www.youtube.com/channel/UCEQ8k6Ybr3P-XqScPBMoikA" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/channel/UCEQ8k6Ybr3P-XqScPBMoikA</a></p><p id="021c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开心嘲讽！</p></div></div>    
</body>
</html>