<html>
<head>
<title>Training custom-data using tensorflow for object-detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用tensorflow训练用于对象检测的自定义数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/training-custom-data-using-tensorflow-for-object-detection-8dc2fcb08aca?source=collection_archive---------9-----------------------#2020-04-29">https://medium.com/analytics-vidhya/training-custom-data-using-tensorflow-for-object-detection-8dc2fcb08aca?source=collection_archive---------9-----------------------#2020-04-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7771" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用自定义数据进行对象检测总是很有趣。今天，让我们来检测5种不同的运动球，包括板球、网球、橄榄球、排球和高尔夫球。</p><h1 id="df20" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">获取知识库:</strong></h1><p id="6b1c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">https://github.com/tensorflow/models的饭桶克隆<a class="ae kg" href="https://github.com/tensorflow/models" rel="noopener ugc nofollow" target="_blank"/></p><h1 id="eb0a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">安装依赖项:</strong></h1><p id="be19" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">pip安装—用户Cython <br/> pip安装—用户contextlib2 <br/> pip安装—用户pillow <br/> pip安装—用户lxml <br/> pip安装—用户jupyter <br/> pip安装—用户matplotlib</p><h1 id="ef92" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">环境设置:</strong></h1><p id="9853" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">从<a class="ae kg" href="https://github.com/protocolbuffers/protobuf/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/protocolbuffers/protobuf/releases</a>下载协议zip文件，解压后你会得到包含protoc.exe文件的bin文件夹。</p><p id="b02f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，从终端运行以下命令</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="0cd1" class="kq je hi km b fi kr ks l kt ku">cd &lt;path_to_tensorflow_cloned_repo&gt;/models/research/<br/>python setup.py build<br/>python setup.py install</span><span id="9fa8" class="kq je hi km b fi kv ks l kt ku">protoc object_detection/protos/*.proto --python_out=.<br/>export PYTHONPATH=$PYTHONPATH:`pwd`:`pwd`/slim</span></pre><h1 id="8dd4" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">创建带标签的数据集:</strong></h1><p id="2710" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">收集所有这5组球的图像，每组500张图像会给出很好的结果。收集后，将所有图像保存到/research/object _ detection/images</p><p id="ea88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，有各种各样的方法来标记你的图像。最广泛使用的应用之一是<a class="ae kg" href="https://github.com/tzutalin/labelImg" rel="noopener ugc nofollow" target="_blank"> labelImg </a>。它有一个用户友好的图形用户界面，你不会花太多时间去习惯它。现在，你必须注释你所有的图像，它们将被存储为Pascal VOC格式的xml文件。</p><p id="18a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注释所有的图像，继续提供具有相似名称的所有相似图像集。这是带注释的图像的样子。这只是一个使用labelImg的例子，你将不得不注释运动球。</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/89a4ae6a4d9236867bf0d3db28e7197e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RJSAo4Tl6D576t-ze4sIuA.png"/></div></div></figure><p id="af0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，使用下面给出的代码将所有xml文件转换为csv文件:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="d83a" class="kq je hi km b fi kr ks l kt ku">import os<br/>import glob<br/>import pandas as pd<br/>import xml.etree.ElementTree as ET</span><span id="0ee1" class="kq je hi km b fi kv ks l kt ku">def xml_to_csv(path):<br/> xml_list = []<br/> for xml_file in glob.glob(path + ‘/*.xml’):<br/> tree = ET.parse(xml_file)<br/> root = tree.getroot()<br/> for member in root.findall(‘object’):<br/> value = (root.find(‘filename’).text,<br/> int(root.find(‘size’)[0].text),<br/> int(root.find(‘size’)[1].text),<br/> member[0].text,<br/> int(member[4][0].text),<br/> int(member[4][1].text),<br/> int(member[4][2].text),<br/> int(member[4][3].text)<br/> )<br/> xml_list.append(value)<br/> column_name = [‘filename’, ‘width’, ‘height’, ‘class’, ‘xmin’, ‘ymin’, ‘xmax’, ‘ymax’]<br/> xml_df = pd.DataFrame(xml_list, columns=column_name)<br/> return xml_df</span><span id="d5b3" class="kq je hi km b fi kv ks l kt ku">def main():<br/> image_path = os.path.join(os.getcwd(), ‘annotations’)<br/> xml_df = xml_to_csv(image_path)<br/> xml_df.to_csv(‘sports_balls.csv’, index=None)<br/> print(‘Successfully converted xml to csv.’)</span><span id="d508" class="kq je hi km b fi kv ks l kt ku">main()</span></pre><p id="c246" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，应该通过运行以下代码将csv文件转换为tf.record文件:</p><p id="df34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">python generate _ TF record . py—CSV _ input =<path to="" csv="" file="">—output _ path = images/train . record—image _ dir =<path to="" images=""/></path></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="c76e" class="kq je hi km b fi kr ks l kt ku">from __future__ import division<br/>from __future__ import print_function<br/>from __future__ import absolute_import</span><span id="32a4" class="kq je hi km b fi kv ks l kt ku">import os<br/>import io<br/>import pandas as pd<br/>import tensorflow as tf</span><span id="2905" class="kq je hi km b fi kv ks l kt ku">from PIL import Image<br/>from object_detection.utils import dataset_util<br/>from collections import namedtuple, OrderedDict</span><span id="b4e8" class="kq je hi km b fi kv ks l kt ku">flags = tf.app.flags<br/>flags.DEFINE_string(‘csv_input’, ‘’, ‘Path to the CSV input’)<br/>flags.DEFINE_string(‘output_path’, ‘’, ‘Path to output TFRecord’)<br/>flags.DEFINE_string(‘image_dir’, ‘’, ‘Path to images’)<br/>FLAGS = flags.FLAGS</span><span id="2bb5" class="kq je hi km b fi kv ks l kt ku"># TO-DO replace this with label map<br/>def class_text_to_int(row_label):<br/> if row_label == ‘Rugbyball’:<br/> return 1<br/> elif row_label == ‘Cricketball’:<br/> return 2<br/> elif row_label == ‘Golfball’:<br/> return 3<br/> elif row_label == ‘Volleyball’:<br/> return 4<br/> elif row_label == ‘Tennisball’:<br/> return 5<br/> else:<br/> return 0</span><span id="5ccb" class="kq je hi km b fi kv ks l kt ku">def split(df, group):<br/> data = namedtuple(‘data’, [‘filename’, ‘object’])<br/> gb = df.groupby(group)<br/> return [data(filename, gb.get_group(x)) for filename, x in zip(gb.groups.keys(), gb.groups)]</span><span id="7ed9" class="kq je hi km b fi kv ks l kt ku">def create_tf_example(group, path):<br/> with tf.gfile.GFile(os.path.join(path, ‘{}’.format(group.filename)), ‘rb’) as fid:<br/> encoded_jpg = fid.read()<br/> encoded_jpg_io = io.BytesIO(encoded_jpg)<br/> image = Image.open(encoded_jpg_io)<br/> width, height = image.size</span><span id="75ab" class="kq je hi km b fi kv ks l kt ku">filename = group.filename.encode(‘utf8’)<br/> image_format = b’jpg’<br/> xmins = []<br/> xmaxs = []<br/> ymins = []<br/> ymaxs = []<br/> classes_text = []<br/> classes = []</span><span id="d681" class="kq je hi km b fi kv ks l kt ku">for index, row in group.object.iterrows():<br/> xmins.append(row[‘xmin’] / width)<br/> xmaxs.append(row[‘xmax’] / width)<br/> ymins.append(row[‘ymin’] / height)<br/> ymaxs.append(row[‘ymax’] / height)<br/> classes_text.append(row[‘class’].encode(‘utf8’))<br/> classes.append(class_text_to_int(row[‘class’]))</span><span id="60b5" class="kq je hi km b fi kv ks l kt ku">tf_example = tf.train.Example(features=tf.train.Features(feature={<br/> ‘image/height’: dataset_util.int64_feature(height),<br/> ‘image/width’: dataset_util.int64_feature(width),<br/> ‘image/filename’: dataset_util.bytes_feature(filename),<br/> ‘image/source_id’: dataset_util.bytes_feature(filename),<br/> ‘image/encoded’: dataset_util.bytes_feature(encoded_jpg),<br/> ‘image/format’: dataset_util.bytes_feature(image_format),<br/> ‘image/object/bbox/xmin’: dataset_util.float_list_feature(xmins),<br/> ‘image/object/bbox/xmax’: dataset_util.float_list_feature(xmaxs),<br/> ‘image/object/bbox/ymin’: dataset_util.float_list_feature(ymins),<br/> ‘image/object/bbox/ymax’: dataset_util.float_list_feature(ymaxs),<br/> ‘image/object/class/text’: dataset_util.bytes_list_feature(classes_text),<br/> ‘image/object/class/label’: dataset_util.int64_list_feature(classes),<br/> }))<br/> return tf_example</span><span id="8489" class="kq je hi km b fi kv ks l kt ku">def main(_):<br/> writer = tf.python_io.TFRecordWriter(FLAGS.output_path)<br/> path = os.path.join(FLAGS.image_dir)<br/> examples = pd.read_csv(FLAGS.csv_input)<br/> grouped = split(examples, ‘filename’)<br/> for group in grouped:<br/> tf_example = create_tf_example(group, path)<br/> writer.write(tf_example.SerializeToString())</span><span id="7f30" class="kq je hi km b fi kv ks l kt ku">writer.close()<br/> output_path = os.path.join(os.getcwd(), FLAGS.output_path)<br/> print(‘Successfully created the TFRecords: {}’.format(output_path))</span><span id="d186" class="kq je hi km b fi kv ks l kt ku">if __name__ == ‘__main__’:<br/> tf.app.run()</span></pre><h1 id="0a95" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">正在创建labelmap.pbtxt文件</h1><p id="b933" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">在内部创建一个名为labelmap.pbtxt的文件，内容如下:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="e534" class="kq je hi km b fi kr ks l kt ku">item {<br/> id: 1<br/> name: 'Rugbyball'<br/>}</span><span id="d41f" class="kq je hi km b fi kv ks l kt ku">item {<br/> id: 2<br/> name: 'Cricketball'<br/>}</span><span id="6866" class="kq je hi km b fi kv ks l kt ku">item {<br/> id: 3<br/> name: 'Golfball'<br/>}</span><span id="5124" class="kq je hi km b fi kv ks l kt ku">item {<br/> id: 4<br/> name: 'Volleyball'<br/>}</span><span id="18c3" class="kq je hi km b fi kv ks l kt ku">item {<br/> id: 5<br/> name: 'Tennisball'<br/>}</span></pre><p id="6da4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将此文件保存在/research/object _ detection/training文件夹中</p><h1 id="f312" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用预先训练的模型:</h1><p id="055e" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">从<a class="ae kg" href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/detection_model_zoo.md" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/models/blob/master/research/object_detection/g3doc/detection _ model _ zoo . MD</a><br/>下载模型，解压到/research/object _ detection</p><p id="afad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将tf.record文件(训练和测试)保存在/research/object _ detection/images文件夹中。将labelmap.pbtxt保存在/research/object _ detection/training文件夹中。</p><h1 id="9d07" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">配置文件的变化:</strong></h1><p id="bd3f" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">从/research/object _ detection/samples/configs→将配置文件复制到/research/object _ detection/training文件夹。</p><p id="d8e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此配置文件中进行如下更改:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="79d8" class="kq je hi km b fi kr ks l kt ku">num_classes: 5</span><span id="1fb6" class="kq je hi km b fi kv ks l kt ku">fine_tune_checkpoint: "../faster_rcnn_inception_resnet_v2_atrous_coco_2018_01_28/model.ckpt"</span><span id="d218" class="kq je hi km b fi kv ks l kt ku">train_input_reader: {<br/> tf_record_input_reader {<br/> input_path: “../images/train.record”<br/> }<br/> label_map_path: “../training/labelmap.pbtxt”<br/>}</span><span id="bcde" class="kq je hi km b fi kv ks l kt ku">eval_config: {<br/> num_examples: 8000<br/> # Note: The below line limits the evaluation process to 10 evaluations.<br/> # Remove the below line to evaluate indefinitely.<br/> max_evals: &lt;no. of test images&gt;<br/>}</span><span id="c3b7" class="kq je hi km b fi kv ks l kt ku">eval_input_reader: {<br/> tf_record_input_reader {<br/> input_path: “../images/test.record”<br/> }<br/> label_map_path: “../training/labelmap.pbtxt”<br/> shuffle: false<br/> num_readers: 1<br/>}</span></pre><h1 id="97ec" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">训练:</strong></h1><p id="9c7a" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">Inside /legacy/train.py在下面运行命令:</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="a866" class="kq je hi km b fi kr ks l kt ku">python3 train.py --logtostderr --train_dir=../training --pipeline_config_path=../training/faster_rcnn_inception_resnet_v2_atrous_coco.config</span></pre><p id="2df3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用过精度高但是速度比较慢的模型，<a class="ae kg" href="http://download.tensorflow.org/models/object_detection/faster_rcnn_inception_resnet_v2_atrous_coco_2018_01_28.tar.gz" rel="noopener ugc nofollow" target="_blank">faster _ rcnn _ inception _ resnet _ v2 _ atrous _ coco _ 2018 _ 01 _ 28</a>，你要写你下载的模型的名字。</p><h1 id="9d06" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">冲浪板:</strong></h1><p id="2b78" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">现在想象你的结果。要检查tensorboard，请运行下面的命令from/object _ detection<br/>tensor board—logdir = training</p><h1 id="8c54" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">创建推理图:</strong></h1><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="b750" class="kq je hi km b fi kr ks l kt ku">python export_inference_graph.py \<br/> — input_type image_tensor \<br/> — pipeline_config_path training/faster_rcnn_inception_resnet_v2_atrous_coco.config \<br/> — trained_checkpoint_prefix training/model.ckpt-280 \<br/> — output_directory inference-graph</span></pre><h1 id="546f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">结果:</strong></h1><p id="dc5f" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">现在，我们都完成了。该推理图可以用于检测各个图像的对象。让我们来看看最终的检测结果:</p><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/1fc0f35258f0fafa0a9c1b1e9daded53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xnEbvUzFuZ6GWq_D-y83Cg.png"/></div></div></figure><figure class="kh ki kj kk fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kw"><img src="../Images/ffc70377e23a4f00690e0271d544dbb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dd9sDJGlRH-BHipyPOp2pQ.png"/></div></div></figure><p id="010f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个物体检测的整个工作可以在<a class="ae kg" href="https://github.com/AshishGusain17/via_google_colab/blob/master/sports_balls_detection_using_tf.ipynb" rel="noopener ugc nofollow" target="_blank">https://github . com/ashishgusain 17/via _ Google _ colab/blob/master/sports _ balls _ detection _ using _ TF . ipynb</a>上看到</p><p id="720e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何疑问，您可以通过以下方式联系我:</p><p id="193d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">电子邮件:ashishgusain12345@gmail.com</p><p id="c37f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">github:<a class="ae kg" href="https://github.com/AshishGusain17" rel="noopener ugc nofollow" target="_blank">https://github.com/AshishGusain17</a></p><p id="bb4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">领英:<a class="ae kg" href="https://www.linkedin.com/in/ashish-gusain-257b841a2/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/ashish-gusain-257b841a2/</a></p></div></div>    
</body>
</html>