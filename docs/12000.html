<html>
<head>
<title>Restarting HTTPD Service is not idempotent in nature and also consume more resources suggest a way to rectify this challenge in Ansible Playbook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">重启 HTTPD 服务本质上不是幂等的，并且还消耗更多的资源，建议在 Ansible Playbook 中纠正这个挑战的方法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/restarting-httpd-service-is-not-idempotence-in-nature-and-also-consume-more-resources-suggest-a-eb78339d71f4?source=collection_archive---------17-----------------------#2020-12-27">https://medium.com/analytics-vidhya/restarting-httpd-service-is-not-idempotence-in-nature-and-also-consume-more-resources-suggest-a-eb78339d71f4?source=collection_archive---------17-----------------------#2020-12-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/8213b50f36025874cb8e154b96adc70f.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*OpfgCcopZYRdtZPIxeemLg.png"/></div></figure><p id="a83d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">问题陈述:</strong></p><p id="e8fe" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">可互换性质遵循幂等性，但是一些模块和关键字不遵循幂等性。在这篇博客中，我们将解决一个问题，其中一个模块关键字没有遵循幂等，即<strong class="in hi">重启</strong> HTTPD 服务。</p><p id="dc9f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">对于上面的问题陈述，我有两个解决方案。我将借助条件给出第一个解。</strong></p><p id="216f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi"> 1 &gt;第一法</strong></p><pre class="jj jk jl jm fd jn jo jp jq aw jr bi"><span id="82c6" class="js jt hh jo b fi ju jv l jw jx">- hosts: all<br/>  tasks:</span><span id="9e83" class="js jt hh jo b fi jy jv l jw jx">- file:<br/>     state: directory<br/>     path: "/mount"</span><span id="88f4" class="js jt hh jo b fi jy jv l jw jx">- mount:<br/>     src: "/dev/cdrom"<br/>     path: "/mount"<br/>     state: mounted<br/>     fstype: "iso9660"</span><span id="d51a" class="js jt hh jo b fi jy jv l jw jx">- yum_repository:<br/>     baseurl: "/mount/AppStream"<br/>     name: "RepO1"<br/>     description: "This is the configuration for the Yum !"<br/>     gpgcheck: no</span><span id="8834" class="js jt hh jo b fi jy jv l jw jx">- yum_repository:<br/>     baseurl: "/mount/BaseOS"<br/>     name: "RepO2"<br/>     description: "This is the configuration for the Yum !"<br/>     gpgcheck: no<br/>  <br/>  - package:<br/>     name: "httpd"<br/>     state: present<br/>  <br/>  - file:<br/>     state: directory<br/>     path: "/var/www/NewDir"</span><span id="982a" class="js jt hh jo b fi jy jv l jw jx">- copy:<br/>     dest: "/etc/httpd/conf.d/new.conf"<br/>     src: "new.conf"<br/>    register: info    <br/>  <br/>  - copy:<br/>     dest: "/var/www/NewDir/index.html"<br/>     content: "Welcome TO Coding Pathshala \n"</span><span id="3d76" class="js jt hh jo b fi jy jv l jw jx">- name: "Normally Starting the Service of httpd"<br/>    service:<br/>     name: "httpd"<br/>     state: started<br/>     enabled: yes</span><span id="cd45" class="js jt hh jo b fi jy jv l jw jx">when: info.changed == false</span><span id="b59e" class="js jt hh jo b fi jy jv l jw jx">- firewalld:<br/>     port: 8080/tcp<br/>     state: enabled<br/>     immediate: yes</span><span id="02e0" class="js jt hh jo b fi jy jv l jw jx">- name: "httpd_service_restart"<br/>    service:<br/>       name: "httpd"<br/>       state: "restarted"<br/>    when: info.changed == true</span></pre><p id="c327" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">因此，在<strong class="in hi">寄存器模块</strong>的帮助下，我将该模块的元数据值存储在一个<strong class="in hi">变量</strong>中。我使用的条件是值以映射的形式存储。它由一个名为 changed 的<strong class="in hi">键组成。如果<strong class="in hi">键的值为 false </strong>，则<strong class="in hi">意味着模块没有进行任何更改</strong>，如果 key 的<strong class="in hi">值为 true，则模块已经进行了更改</strong>。</strong></p><p id="ed9f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我们将使用 r <strong class="in hi">注册模块</strong>和<strong class="in hi">复制模块</strong>，在这里我们可以更改文件<em class="jz">的<strong class="in hi">配置(当我们在配置文件中进行一些更改时，我们只需要重新启动服务)</strong></em> 。</p><p id="df83" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">注册模块将帮助我们在变量中存储复制模块的元数据。该值以映射(键值对)的形式存储。我们将使用<em class="jz">这个变量两次。</em></p><p id="b04f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">首先，当我们在关键字<strong class="in hi"> started </strong>的帮助下<strong class="in hi">启动 web 服务器</strong>以及在关键字<strong class="in hi">restart</strong>的帮助下启动服务时，我们使用这个变量。</p><p id="ab0f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">started 关键字只有在条件存在时才会运行</p><blockquote class="ka kb kc"><p id="41a0" class="il im jz in b io ip iq ir is it iu iv kd ix iy iz ke jb jc jd kf jf jg jh ji ha bi translated">变量名称.已更改==false</p></blockquote><p id="974b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">重启的模块将在条件存在时运行，即</p><blockquote class="ka kb kc"><p id="7326" class="il im jz in b io ip iq ir is it iu iv kd ix iy iz ke jb jc jd kf jf jg jh ji ha bi translated">变量名称.已更改= =真</p></blockquote><p id="951f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi"> 2 &gt;第二种方法</strong></p><p id="fe68" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">第二个完美的解决方案是，当配置文件发生变化时，只在重启时运行服务，也就是说，如果配置文件没有变化，就不要重启(始终遵循幂等概念)。</p><p id="6d9d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">这就是所谓的 Notifies ( <strong class="in hi"> notify </strong>也是 Ansible 中存在的模块)。因此，我们需要将这个模块放在 Handler 下的重启服务任务中..</p><p id="17ce" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">因此，如果这个模块通知在配置中有一些变化，那么由处理程序调用的重新启动的服务..</p><pre class="jj jk jl jm fd jn jo jp jq aw jr bi"><span id="8a98" class="js jt hh jo b fi ju jv l jw jx">- hosts: all<br/>  tasks:</span><span id="f00d" class="js jt hh jo b fi jy jv l jw jx">- file:<br/>     state: directory<br/>     path: "/appdvd"</span><span id="bc0c" class="js jt hh jo b fi jy jv l jw jx">- mount:<br/>     src: "/dev/cdrom"<br/>     path: "/mount"<br/>     state: mounted<br/>     fstype: "iso9660"</span><span id="9b48" class="js jt hh jo b fi jy jv l jw jx">- yum_repository:<br/>     baseurl: "/mount/AppStream"<br/>     name: "RepO1"<br/>     description: "This is the configuration for the Yum !"<br/>     gpgcheck: no</span><span id="52df" class="js jt hh jo b fi jy jv l jw jx">- yum_repository:<br/>     baseurl: "/mount/BaseOS"<br/>     name: "RepO2"<br/>     description: "This is the configuration for the Yum !"<br/>     gpgcheck: no<br/>  <br/>  - package:<br/>     name: "httpd"<br/>     state: present<br/>  <br/>  - file:<br/>     state: directory<br/>     path: "/var/www/NewDir"</span><span id="5a6c" class="js jt hh jo b fi jy jv l jw jx">- copy:<br/>     dest: "/etc/httpd/conf.d/new.conf"<br/>     src: "new.conf"<br/>    notify: httpd_service_restart    <br/>  <br/>  - copy:<br/>     dest: "/var/www/NewDir/index.html"<br/>     content: "Welcome TO Coding Pathshala \n"</span><span id="99ca" class="js jt hh jo b fi jy jv l jw jx">- service:<br/>     name: "httpd"<br/>     state: started<br/>     enabled: yes<br/>  <br/>  - firewalld:<br/>     port: 8080/tcp<br/>     state: enabled<br/>     immediate: yes</span><span id="c860" class="js jt hh jo b fi jy jv l jw jx">handlers:<br/>  - name: httpd_service_restart<br/>    service:<br/>       name: "httpd"<br/>       state: "restarted"</span></pre><p id="fcbd" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">感谢阅读这篇博客！！</p><p id="7c65" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">想要下载行动手册，然后前往 github →</p><p id="dcbf" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae kg" href="https://github.com/Shashwatsingh22/Ansible" rel="noopener ugc nofollow" target="_blank">https://github.com/Shashwatsingh22/Ansible</a></p></div></div>    
</body>
</html>