<html>
<head>
<title>Sequence Model Time Series Prediction Using Tensorflow 2.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Tensorflow 2.0的序列模型时间序列预测</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/sequence-model-time-series-prediction-using-tensorflow-2-0-665257beb25f?source=collection_archive---------3-----------------------#2020-02-09">https://medium.com/analytics-vidhya/sequence-model-time-series-prediction-using-tensorflow-2-0-665257beb25f?source=collection_archive---------3-----------------------#2020-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4a9f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用历史时间序列数据预测美元对印度卢比</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/1552ee4b6299960c5a11f71af1e659c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fNSvMywnYceVf8KiisQNNg.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">萨蒂什·库马尔·安迪</figcaption></figure><p id="fc8f" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在本文中，我们将讨论如何创建一个简单的TensorFlow模型来预测时间序列数据，在我们的例子中是美元到印度卢比的转换数据。</p><p id="3be4" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我使用了google colab来训练模型和预测输出。<br/>首先，在木星笔记本中安装TensorFlow。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="5f09" class="ko kp hi kk b fi kq kr l ks kt">!pip install tensorflow==2.0.0</span><span id="d1dd" class="ko kp hi kk b fi ku kr l ks kt">import tensorflow as tf<br/>print(tf.__version__)</span></pre><p id="5603" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，从Github下载预处理的时间序列USD到INR数据。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="06fb" class="ko kp hi kk b fi kq kr l ks kt">!wget — no-check-certificate <a class="ae kv" href="https://raw.githubusercontent.com/satishnaidu/mldata/master/timeseries/USD_INR.csv" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/satishnaidu/mldata/master/timeseries/USD_INR.csv</a> -O /tmp/USD_INR.csv</span></pre><p id="add1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果你想训练自己的数据，你可以从下面的网站下载<a class="ae kv" href="https://www.investing.com/currencies/usd-inr-historical-data" rel="noopener ugc nofollow" target="_blank">https://www . investing . com/currences/USD-INR-historical-data</a><br/>这个数据需要一点预处理，比如添加一个带有序号的新列，并按日期对列进行排序。</p><p id="c22e" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">使用matplotlib库查看转换时序图。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="91e1" class="ko kp hi kk b fi kq kr l ks kt">import numpy as np<br/>import matplotlib.pyplot as plt</span><span id="a213" class="ko kp hi kk b fi ku kr l ks kt">def plot_series(time, series, format="-", start=0, end=None):<br/>  plt.plot(time[start:end], series[start:end], format)<br/>  plt.xlabel("Time")<br/>  plt.ylabel("Value")<br/>  plt.grid(True)</span><span id="0e85" class="ko kp hi kk b fi ku kr l ks kt">import csv<br/>time_step = []<br/>inr_conversion = []</span><span id="08b8" class="ko kp hi kk b fi ku kr l ks kt">with open('/tmp/USD_INR.csv') as csvfile:<br/>  reader = csv.reader(csvfile, delimiter=',')<br/>  next(reader)<br/>  for row in reader:<br/>    inr_conversion.append(float(row[2]))<br/>    time_step.append(int(row[0]))</span><span id="ebdc" class="ko kp hi kk b fi ku kr l ks kt">print(len(time_step))<br/>print(inr_conversion[len(time_step)-1])<br/>series = np.array(inr_conversion)<br/>time = np.array(time_step)<br/>plt.figure(figsize=(10, 6))<br/>plot_series(time, series)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kw"><img src="../Images/54d2bf23ab6a83fad913928ee6d39c13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*32D3sP82RXjZtbSNtw6d5g.jpeg"/></div></div></figure><p id="2456" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">从这个图表中，你可以注意到它有一个上升的趋势，但没有任何特定的季节性和大量的噪音。<br/>在处理时间序列数据时，您必须熟悉以下术语。</p><p id="95d1" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj"> <em class="kx">趋势</em> </strong>:时间序列值的增减<br/>例如:上升趋势或下降趋势。<br/><strong class="jp hj"><em class="kx"/></strong>:系列中反复出现的一致模式<br/>例如:夏天的气温早上升高，晚上下降。<br/> <strong class="jp hj"> <em class="kx">噪声:</em> </strong>序列中的随机值，这使得模型难以识别趋势性和季节性。</p><p id="f544" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，将时序数据拆分为训练数据并验证数据集</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="13a5" class="ko kp hi kk b fi kq kr l ks kt">split_time = 2000<br/>time_train = time[:split_time]<br/>x_train = series[:split_time]<br/>time_valid = time[split_time:]<br/>x_valid = series[split_time:]</span><span id="a26e" class="ko kp hi kk b fi ku kr l ks kt">window_size = 60<br/>batch_size = 100<br/>shuffle_buffer_size = 1000</span></pre><p id="097c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，使用辅助函数(如窗口数据集和模型预测函数)创建张量流模型。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="14f6" class="ko kp hi kk b fi kq kr l ks kt">def windowed_dataset(series, window_size, batch_size, shuffle_buffer):<br/>  series = tf.expand_dims(series, axis=-1)<br/>  ds = tf.data.Dataset.from_tensor_slices(series)<br/>  ds = ds.window(window_size + 1, shift=1, drop_remainder=True)<br/>  ds = ds.flat_map(lambda w: w.batch(window_size + 1))<br/>  ds = ds.shuffle(shuffle_buffer)<br/>  ds = ds.map(lambda w: (w[:-1], w[1:]))<br/>return ds.batch(batch_size).prefetch(1)</span><span id="9dad" class="ko kp hi kk b fi ku kr l ks kt">def model_forecast(model, series, window_size):<br/>  ds = tf.data.Dataset.from_tensor_slices(series)<br/>  ds = ds.window(window_size, shift=1, drop_remainder=True)<br/>  ds = ds.flat_map(lambda w: w.batch(window_size))<br/>  ds = ds.batch(32).prefetch(1)<br/>  forecast = model.predict(ds)<br/>return forecast</span><span id="d22e" class="ko kp hi kk b fi ku kr l ks kt">tf.random.set_seed(51)<br/>np.random.seed(51)<br/>train_set = windowed_dataset(x_train, window_size=120,<br/>                             batch_size=100,<br/>                             shuffle_buffer=shuffle_buffer_size)</span><span id="c37e" class="ko kp hi kk b fi ku kr l ks kt">model = tf.keras.models.Sequential([<br/>  tf.keras.layers.Conv1D(filters=60, kernel_size=5,<br/>                         strides=1,padding="causal",<br/>                         activation="relu",input_shape=[None, 1]),<br/>  tf.keras.layers.LSTM(60, return_sequences=True),<br/>  tf.keras.layers.LSTM(60, return_sequences=True),<br/>  tf.keras.layers.Dense(30, activation="relu"),<br/>  tf.keras.layers.Dense(10, activation="relu"),<br/>  tf.keras.layers.Dense(1),<br/>  tf.keras.layers.Lambda(lambda x: x * 400)<br/>])</span><span id="f83c" class="ko kp hi kk b fi ku kr l ks kt">optimizer = tf.keras.optimizers.SGD(lr=51e-7, momentum=0.9)<br/>model.compile(loss=tf.keras.losses.Huber(),<br/>              optimizer=optimizer,<br/>              metrics=["mae"])<br/>history = model.fit(train_set,epochs=100)</span></pre><p id="1d9d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">接下来，预测每个时间序列窗口的预测，此处我们采用的窗口大小为120，步距=1，因此它将尝试使用之前的119个值预测第120个值，并使用步距值移动到下一个级别。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="1aae" class="ko kp hi kk b fi kq kr l ks kt">rnn_forecast = model_forecast(model, series[..., np.newaxis],<br/>                              window_size)<br/>rnn_forecast = rnn_forecast[split_time - window_size:-1, -1, 0]</span></pre><p id="a107" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">最后，根据验证集的原始数据绘制预测结果。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="ea1e" class="ko kp hi kk b fi kq kr l ks kt">plt.figure(figsize=(10, 6))<br/>plot_series(time_valid, x_valid)<br/>plot_series(time_valid, rnn_forecast)<br/>print(time_valid[-1:])<br/>print(rnn_forecast[-1:])<br/>References:</span></pre><p id="1ea6" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了预测未来的数据，请使用输入序列中最近的120个值来预测下一个值。</p><pre class="iy iz ja jb fd kj kk kl km aw kn bi"><span id="4764" class="ko kp hi kk b fi kq kr l ks kt">split_time = 2515<br/>window_size = 120</span><span id="0733" class="ko kp hi kk b fi ku kr l ks kt">rnn_forecast = model_forecast(model, series[split_time:,np.newaxis],     window_size)<br/>rnn_forecast = rnn_forecast[0:-1, -1, 0]<br/>print(rnn_forecast)</span></pre><p id="92ba" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">coursera:<a class="ae kv" href="https://colab.research.google.com/github/lmoroney/dlaicourse/blob/master/TensorFlow%20In%20Practice/Course%204%20-%20S%2BP/S%2BP%20Week%204%20Lesson%203.ipynb#scrollTo=tP7oqUdkk0gY" rel="noopener ugc nofollow" target="_blank">https://colab . research . Google . com/github/lmor oney/dlai Course/blob/master/tensor flow % 20In % 20实践/课程% 204% 20-% 20S % 2BP/S % 2BP % 20 week % 204% 20 lesson % 203 . ipynb # scroll to = TP 7 oqudkk 0 gy</a></p><p id="0afb" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">tensor flow:<br/><a class="ae kv" href="https://www.tensorflow.org/tutorials/structured_data/time_series" rel="noopener ugc nofollow" target="_blank">https://www . tensor flow . org/tutorials/structured _ data/time _ series</a></p></div></div>    
</body>
</html>