<html>
<head>
<title>Journey of Apache Kafka &amp; Zookeeper Administrator ( Part 4 )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇卡夫卡与动物园管理员之旅(四)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-4-faf08309ef8a?source=collection_archive---------28-----------------------#2020-08-23">https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-4-faf08309ef8a?source=collection_archive---------28-----------------------#2020-08-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7a868ee7d74ab16f600ca112ffef7ac9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zj0GIbbyP3vhtGIINQmcgQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">随机照片:)</figcaption></figure><p id="5ac5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">【2019年6月(续)</p><p id="334a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" rel="noopener" href="/@116davinder/journey-of-apache-kafka-zookeeper-administrator-part-3-e31c2f330895">在上一篇文章</a>中，我已经解释了<strong class="iw hj"> Apache Kafka </strong>的不同方面，而在这篇文章中，我将涵盖<strong class="iw hj"> Apache Kafka </strong>方面的优化。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="e9a6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在安装了Apache Kafka和Monitoring Setup之后，我很有信心它会工作，我将能够用它处理好流量。</p><p id="de1a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">那一次，我读了LinkedIn的一篇博客:<a class="ae js" href="https://engineering.linkedin.com/kafka/benchmarking-apache-kafka-2-million-writes-second-three-cheap-machines" rel="noopener ugc nofollow" target="_blank">Apache-Kafka-200万-writes-Second-three-priest-machines</a>所以我决定用我的设置打破这个数字，老实说，我确实打破了这个数字，我能够在3个廉价的Kafka节点上达到230万/秒的吞吐量。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="7f67" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是一个关于阿帕奇卡夫卡1-2周痛苦而严格的测试/优化的故事。</p><p id="8921" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我知道，我应该在这里分享Kafka的测试结果，但现在不可能，因为我已经离开了公司，所以我将在这里分享我的经验。</p><p id="13d6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">测试需要的基本东西</strong> <br/> 1。廉价的卡夫卡节点有<strong class="iw hj">卡夫卡2 . 1 . 1</strong>2<br/>2。Kafka节点上的详细监控<br/> 3。独立测试机器</p><p id="03a5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">便宜的卡夫卡节点<br/> </strong>我有3个卡夫卡节点(用我的ansible-playbook安装/配置)。配置为<br/> * 6 Vcore <br/> * 10 Gbps网络<br/>* 12–24 GB RAM<br/>* 100 GB磁盘(由<strong class="iw hj"> SAN </strong>支持，超过10 Gbps网络)</p><p id="4208" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> JVM设置(OpenJDK 1.8 ) <br/> 6 GB堆大小</strong></p><p id="46f8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">不同的话题配置</strong></p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="66eb" class="kj kk hi kf b fi kl km l kn ko"><strong class="kf hj">kafkaperf1R1:</strong> Partition 1 with Replica 1<br/><strong class="kf hj">kafkaperf1R3:</strong> Partition 1 with Replica 3<br/><strong class="kf hj">kafkaperf3R1:</strong> Partition 3 with Replica 1<br/><strong class="kf hj">kafkaperf3R3:</strong> Partition 3 with Replica 3<br/><strong class="kf hj">kafkaperf6R1:</strong> Partition 6 with Replica 1<br/><strong class="kf hj">kafkaperf6R3:</strong> Partition 6 with Replica 3<br/><strong class="kf hj">kafkaperf9R1:</strong> Partition 9 with Replica 1<strong class="kf hj"><br/>kafkaperf9R3:</strong> Partition 9 with Replica 3<strong class="kf hj"><br/>kafkaperf12R1:</strong> Partition 12 with Replica 1<br/><strong class="kf hj">kafkaperf12R3:</strong> Partition 12 with Replica 3<br/><strong class="kf hj">kafkaperf15R1:</strong> Partition 15 with Replica 3<br/><strong class="kf hj">kafkaperf15R3:</strong> Partition 15 with Replica 3<br/><strong class="kf hj">kafkaperf18R1:</strong> Partition 18 with Replica 3<br/><strong class="kf hj">kafkaperf18R3:</strong> Partition 18 with Replica 3</span></pre><p id="5685" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">如何执行测试<br/> </strong>创建主题<br/> <code class="du kp kq kr kf b">bin/kafka-topics.sh --create --topic kafkaperf1R1 --bootstrap-server localhost:9092<br/></code> <strong class="iw hj">现在进行第一轮测试，</strong></p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="0d3a" class="kj kk hi kf b fi kl km l kn ko">bin/kafka-producer-perf-test.sh --topic <!-- -->kafkaperf1R1<!-- --> --num-records 100000 --record-size 100 --throughput 100000 --producer-props acks=1</span></pre><p id="7b8a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">查结果查卡夫卡监控系统，卡夫卡是不是在什么地方窒息了？监控图表中有任何峰值或异常情况。</p><p id="942b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">非常重要:</strong>在<strong class="iw hj"> Microsoft One Note </strong>或类似工具中记录所有测试，以便您可以在以后需要时进行比较或显示/导出为PDF。</p><p id="36e6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/roles/common/tasks/systemTuning.yml" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> OS &amp;网络优化</strong> </a></p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="9e32" class="kj kk hi kf b fi kl km l kn ko">- name: OS Tuning<br/>  sysctl:<br/>    name: "{{ item.key }}"<br/>    value: "{{ item.value }}"<br/>    state: present<br/>  loop:<br/>    - { "key":"vm.max_map_count", "value": "{{ kafkaVmMaxMapCount }}" }</span><span id="2d5f" class="kj kk hi kf b fi ks km l kn ko">- name: Networking Tuning<br/>  sysctl:<br/>    name: "{{ item.key }}"<br/>    value: "{{ item.value }}"<br/>    sysctl_set: yes<br/>    state: present<br/>    reload: true<br/>  loop:<br/>    - { "key": "net.ipv4.tcp_max_syn_backlog", "value": "40000" }<br/>    - { "key": "net.core.somaxconn", "value": "40000" }<br/>    - { "key": "net.ipv4.tcp_sack", "value": "1" }<br/>    - { "key": "net.ipv4.tcp_window_scaling", "value": "1" }<br/>    - { "key": "net.ipv4.tcp_fin_timeout", "value": "15" }<br/>    - { "key": "net.ipv4.tcp_keepalive_intvl", "value": "60" }<br/>    - { "key": "net.ipv4.tcp_keepalive_probes", "value": "5" }<br/>    - { "key": "net.ipv4.tcp_keepalive_time", "value": "180" }<br/>    - { "key": "net.ipv4.tcp_tw_reuse", "value": "1" }<br/>    - { "key": "net.ipv4.tcp_moderate_rcvbuf", "value": "1" }<br/>    - { "key": "net.core.rmem_default", "value": "8388608" }<br/>    - { "key": "net.core.wmem_default", "value": "8388608" }<br/>    - { "key": "net.core.rmem_max", "value": "134217728" }<br/>    - { "key": "net.core.wmem_max", "value": "134217728" }<br/>    - { "key": "net.ipv4.tcp_mem", "value": "134217728 134217728 134217728" }<br/>    - { "key": "net.ipv4.tcp_rmem", "value": "4096 277750 134217728" }<br/>    - { "key": "net.ipv4.tcp_wmem", "value": "4096 277750 134217728" }<br/>    - { "key": "net.core.netdev_max_backlog", "value": "300000" }</span></pre><p id="ab92" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/inventory/development/group_vars/all.yml#L42-L66" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj">卡夫卡参数调谐</strong> </a></p><pre class="ka kb kc kd fd ke kf kg kh aw ki bi"><span id="aa79" class="kj kk hi kf b fi kl km l kn ko">### Production Optimization Parameters<br/>### if nothing is set then it will use default values.<br/>kafkaDefaultReplicationFactor: 3<br/>kafkaMinInsyncReplicas: 2<br/>kafkaBackgroundThread: 10<br/>kafkaMessagesMaxBytes: 1000012 # 1MB approx<br/>kafkaReplicaFetchMaxBytes: 2000000 # this should be higher than kafkaMessagesMaxBytes<br/>kafkaQuededMaxRequests: 500<br/>kafkaNumReplicaFetchers: 1<br/>kafkaNumNetworkThreads: 6<br/>kafkaNumIoThreads: 8<br/>kafkaSocketSendBufferBytes: 102400<br/>kafkaSocetReceiveBufferBytes: 102400<br/>kafkaSocetRequestMaxBytes: 104857600<br/>kafkaNumPartitions: 1<br/>kafkaNumRecoveryThreadsPerDataDir: 1<br/>kafkaOffsetsTopicReplicationFactor: 3<br/>kafkaTransactionStateLogReplicationFactor: 3<br/>kafkaTransactionStateLogMinIsr: 3<br/>kafkaLogFlushIntervalMessages: 10000<br/>kafkaLogFlushIntervalMs: 1000<br/>kafkaLogRetentionHours: 168<br/>kafkaLogSegmentBytes: 2073741824 # need to ask expert kafka, should we use default 1GB here or 2GB or more<br/>kafkalogRetentionCheckIntervalMs: 300000<br/>kafkaGroupInitRebalanceDelayMs: 3</span></pre><p id="7e87" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">现在是第二轮测试，</strong>我知道重新进行所有测试是一个痛苦的过程，但必须有人去做，否则，没有人会知道当有人对卡夫卡施加压力时会发生什么，卡夫卡在同样的环境下会有什么表现。再次将所有测试记录到一个笔记或类似的工具中。</p><p id="598b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">现在是第三轮测试，</strong> <br/>首先，检查之前运行的测试，您将会知道，一旦副本3达到分区6和更高，您将获得非常好的延迟和100万吞吐量，让我们将吞吐量进一步提高到200万，现在只在分区6和更高的配置上运行测试。<strong class="iw hj">再次将所有测试记录到一个笔记或类似的工具中。</strong></p><p id="7e0b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">现在是第四/第五/第六轮测试，<br/> </strong>首先检查第三轮测试中的最佳案例，并根据需要减少表现不佳的主题数量。让我们将吞吐量增加到2.1 / 2.2 / 2.3，并在系统阻塞+任何异常峰值的情况下密切关注监控系统。再次将所有测试记录到一个笔记或类似的工具中。</p><p id="2084" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里是最后一个场景，<br/>尝试将记录大小增加到512 KB / 1 MB，而不是增加吞吐量。看看网络会发生什么，你能达到你的网络极限吗？这将是我们<strong class="iw hj">第7&amp;第8轮测试</strong>，<strong class="iw hj">再次将所有测试记录到一个笔记或类似的工具中。</strong></p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="af7a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">有趣的是</strong>，CPU，内存&amp; JVM像GC时间+使用的堆之类的东西，即使在我达到230万的目标时也从未改变过。230万之后，我在看那个Avg。99%的延迟是以秒为单位的，这对于我的要求来说有点过了。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="10ca" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">旅程将在下一个话题继续(<strong class="iw hj">雅虎卡夫卡经理</strong>又名<strong class="iw hj"> CMAK </strong>)！</p></div></div>    
</body>
</html>