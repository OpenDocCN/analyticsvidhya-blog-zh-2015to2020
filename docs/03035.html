<html>
<head>
<title>Productionlize your Machine Learning (Python) Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的机器学习(Python)应用程序生产化</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/productionlize-your-machine-learning-python-application-e1989dd82f24?source=collection_archive---------12-----------------------#2020-01-13">https://medium.com/analytics-vidhya/productionlize-your-machine-learning-python-application-e1989dd82f24?source=collection_archive---------12-----------------------#2020-01-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="1952" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Flask、Heroku和多线程</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/7518abc84ddbdb9286ea09c16639bb01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hdyhy0xiSFJVhbCO"/></div></div></figure><p id="af3e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当我们创建我们的机器学习应用程序时，我们大多数人都在试图学习算法，理解它们如何工作，与sklearn pandas和各种其他库一起玩。但是，将我们的知识付诸使用才是这些算法的真正价值，这就是你必须将机器学习应用程序与可能提供见解、建议、预测统计数据等的产品集成并公开的时候。</p><p id="416a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当第一次尝试机器学习时，人们通常不关心或不考虑的事情是CPU大小、RAM、用户体验和响应时间、对外部API的依赖等。但如果我们的机器学习应用程序必须提供任何真正的好处，这些就变得非常关键。</p><p id="6cdd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">本文中的内容是我在部署我最近的应用程序时学到的——shared watch，这是一个基于文本分析和在线聚类的电影推荐系统。本文不是关于核心应用程序中使用的算法或方法，而是部署应用程序时面临的问题。</p><p id="9037" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我将一个接一个地讲述所面临的每一个障碍，以及它们是如何被补救的。</p><ol class=""><li id="7662" class="kg kh hi jl b jm jn jp jq js ki jw kj ka kk ke kl km kn ko bi translated"><strong class="jl hj">公羊</strong></li></ol><p id="1816" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">该应用程序将被托管在Heroku提供的免费层上。考虑到它是免费的，它有固有的局限性。对应用程序大小、内核数量和RAM容量的限制</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kp"><img src="../Images/01f2895a8842e33adf6aa9332410a55a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kCl8KvZDdeNS5aLo38f_mw.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated"><a class="ae kf" href="https://www.heroku.com/pricing" rel="noopener ugc nofollow" target="_blank"> H </a> eroku定价</figcaption></figure><p id="2f8f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">正如你在上面看到的，heroku free tier只提供了512 MB RAM，这对于机器学习应用来说太有限了。</p><p id="2cd5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当我第一次部署这个应用程序时，我马上就遇到了这个问题，这个应用程序被Heroku强制崩溃了，因为它超过了内存使用量的200%!！</p><p id="a1ae" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">发生这种情况是因为在幕后我使用了<a class="ae kf" href="https://spacy.io/" rel="noopener ugc nofollow" target="_blank"> Spacy </a>，他们非常基本的可用模型在磁盘上的大小是90MB，当加载到内存中时，会爆炸到大约200MB。仅仅通过加载模型，大部分内存就被消耗掉了。</p><p id="7f70" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在这似乎是一个很难解决的问题。你要么寻找更小的可用型号，要么就付钱给Heroku升级你的机器。一如既往地缺乏资金，我选择了第一个选项。但是我花了一段时间才偶然发现——py Magnitude——现在这些家伙已经做了一项巨大的工作，他们采用了从Spacy到NLTK到处使用的相同基础模型，并将它们转换成一种叫做“Magnitude”的格式，这种格式只占用大约10 MB的RAM！！！显着减少，显然成本是处理时间，但至少这个看似不可能解决的问题有了一个前进的方向。所以我用PyMagnitude代替Spacy。</p><p id="a731" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">第三课</strong>——在你决定投入更多硬件之前，试着优化你的代码，寻找有效的依赖。</p><p id="f7cb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">2 <strong class="jl hj">。CPU和响应时间</strong></p><p id="7880" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">对应用程序非常关键的第二个问题是响应时间。由于我们在幕后使用在线处理和集群，所以我们必须非常高效，这样应用程序的最终用户就不会经历很长的等待时间。</p><p id="4bfd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">批评的另一个原因是Heroku对web请求的硬性限制。响应时间必须低于30秒(对于web应用程序来说，这是一个合理的上限，但对于机器学习应用程序来说呢？).一旦达到极限，Heroku就会杀死工人，请求就会终止。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ku"><img src="../Images/63d75d2c71b61a08fc5fac564cd42e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nu1Q3WFaIRaaFQ9m-FJwwg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">如果超过30秒，请求返回503</figcaption></figure><p id="3693" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">从UX的角度来看</p><p id="9e0d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们决定做的第一件事是改善用户体验。该应用程序做两件事——允许用户探索电影中的主题并找到相似的电影。<em class="kv">“主题”</em>功能会在3秒钟内返回响应，而<em class="kv">“电影”</em>功能则需要很长时间。所以我们决定让用户登陆主题选项卡，这将允许他们立即开始探索主题和这些主题的电影。但是我们禁用了电影标签，并显示了一个加载符号，不管将来它会变得多快，我们都希望它会比主题慢，所以它有点意义。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kw"><img src="../Images/77bfaec0d05f59488ef020b1a87035d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/1*9rnnCBnE_qQ1SDp0hmdOzg.gif"/></div></figure><p id="870d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj"> B .让事情变得更快——线程</strong></p><p id="a09c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们被压扁的另一个原因是网络电话。我们进行了大量的API调用(通过缓存),平均需要1-2秒，由于我们进行了大量的调用，应用程序就爆炸了。</p><p id="5a68" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">处理这种情况的自然方法是使用并行处理。</p><p id="aa0c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，并行处理可以通过多重处理或多线程来完成。两者都有不同的用例。</p><p id="ef49" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl hj">一般的经验法则是</strong></p><p id="ac3e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你的代码有大量的I/O或网络使用:</p><ul class=""><li id="5c8a" class="kg kh hi jl b jm jn jp jq js ki jw kj ka kk ke kx km kn ko bi translated"><strong class="jl hj">多线程</strong>是你的最佳选择，因为它的开销很低</li></ul><p id="3c47" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你有图形用户界面</p><ul class=""><li id="00c5" class="kg kh hi jl b jm jn jp jq js ki jw kj ka kk ke kx km kn ko bi translated">多线程，这样你的UI线程就不会被锁定</li></ul><p id="b3fe" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">如果你的代码被<strong class="jl hj"> CPU绑定</strong>:</p><ul class=""><li id="73cf" class="kg kh hi jl b jm jn jp jq js ki jw kj ka kk ke kx km kn ko bi translated">你应该使用<strong class="jl hj">多重处理</strong>(如果你的机器有多个内核)</li></ul><p id="9bcb" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">因此，我们自然决定使用线程。Python提供了一个非常简单的线程库接口。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ky"><img src="../Images/8dfd82521f9252f19bca6d27ccc53caf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*UYBhrR0q-_Sbiznc1iTlSQ.png"/></div></figure><p id="87e7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">引用官方文档“<code class="du kz la lb lc b"><a class="ae kf" href="https://docs.python.org/2/library/multiprocessing.html#module-multiprocessing.dummy" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">multiprocessing.dummy</strong></a></code>复制了<code class="du kz la lb lc b"><a class="ae kf" href="https://docs.python.org/2/library/multiprocessing.html#module-multiprocessing" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">multiprocessing</strong></a></code>的API，但只不过是<code class="du kz la lb lc b"><a class="ae kf" href="https://docs.python.org/2/library/threading.html#module-threading" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">threading</strong></a></code>模块的包装器。”</p><p id="704b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，您可以并行运行，而不是使用串行循环！</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ld"><img src="../Images/2500d18b7899066c2b4b007070e4eaf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGTifUbcde-COSWysytVVg.png"/></div></div></figure><p id="1112" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在上面的代码片段中</p><p id="63ae" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">[118行]我们首先进行外部api调用，以获取与特定关键字相关的电影，如“浪漫”、“戏剧”或“德里”，然后[120行]，并行地，获取每部电影的所有关键字。</p><p id="e8dc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这导致整体时间的显著下降，因为程序现在并行运行每个外部请求，并且在等待它们返回的同时可以做其他有用的事情！</p><p id="c21f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这就是这篇文章的全部内容，如果有不清楚的地方或任何建议，请随时发表评论。</p><p id="9f70" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这篇文章的后续或者更像是一个先驱— <strong class="jl hj"> <em class="kv">将应用程序部署到Heroku </em> </strong>将在另一篇文章中讨论。</p></div></div>    
</body>
</html>