<html>
<head>
<title>Optimization techniques - TensorFlowLite!!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优化技术- TensorFlowLite！！</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/optimization-techniques-tflite-5f6d9ae676d5?source=collection_archive---------5-----------------------#2019-12-22">https://medium.com/analytics-vidhya/optimization-techniques-tflite-5f6d9ae676d5?source=collection_archive---------5-----------------------#2019-12-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d6eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最流行的优化技术之一叫做量化。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/550b9a1509c095f1cb1f48b1570bb938.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/0*KvvRkxZfnZiROVqj"/></div></figure><p id="42be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> TF Lite入门文章</strong></p><p id="47c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" rel="noopener" href="/techwasti/tensorflow-lite-machine-learning-at-the-edge-26e8421ae661">https://medium . com/techwasti/tensor flow-lite-machine-learning-at-the-edge-26e 8421 AE 661</a></p><p id="c16a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" rel="noopener" href="/techwasti/tensorflow-lite-deployment-523eec79c017">https://medium . com/techwasti/tensor flow-lite-deployment-523 EEC 79 c 017</a></p><p id="2493" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" rel="noopener" href="/techwasti/tensorflow-lite-converter-dl-example-febe804b8673">https://medium . com/techwasti/tensor flow-lite-converter-dl-example-febe 804 b 8673</a></p><p id="a09a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在移动设备或嵌入式设备上运行机器学习模型并进行推理会带来一定的挑战，如内存、电源和数据存储等资源量有限，因此在边缘设备上部署ML模型至关重要。</p><p id="4ae2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在移动和嵌入式设备上部署优化的机器学习模型至关重要，这样它们才能高效运行。存在优化技术，其中一种优化技术是<em class="jm">量化。</em>在上一篇文章中，我们看到了如何使用TFLite转换器来优化边缘设备的模型，而无需修改权重和激活类型。</p></div><div class="ab cl jn jo gp jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="hb hc hd he hf"><h2 id="d7c9" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated"><strong class="ak">什么是量化<em class="kp">？</em>T13】</strong></h2><p id="31a8" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">量化通常用于数学和数字信号处理。下面是维基的定义。</p><blockquote class="kv kw kx"><p id="1dc0" class="if ig jm ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated"><strong class="ih hj">量化</strong>，在数学和数字信号处理中，是将一个大集合(通常是一个连续集合)中的输入值映射到一个(可数的)较小集合中的输出值的过程，通常有有限个元素。舍入和截断是<strong class="ih hj">量化</strong>过程的典型例子。</p></blockquote><p id="6821" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">量化是指减少代表一个数的位数的过程。在深度学习的背景下，迄今为止，用于研究和部署的主要数字格式是32位浮点或FP32。将FP32权重和输出激活转换为最接近的8位整数，有时在量化中也是4/2/1位。</p><p id="66df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">量化通过量化权重和激活类型来优化模型。TFLite使用量化技术来加速对边缘设备的推断。TFLite converter是<em class="jm">是否</em> <strong class="ih hj"> <em class="jm">我们可以管理一个精度更低的深度学习模型</em> </strong> <em class="jm">。</em>现在你确切地知道了量子化，让我们深潜:</p><blockquote class="lb"><p id="a6df" class="lc ld hi bd le lf lg lh li lj lk jc dx translated">量化大大降低了使用神经网络的内存需求和计算成本。</p></blockquote><p id="6829" class="pw-post-body-paragraph if ig hi ih b ii ll ik il im lm io ip iq ln is it iu lo iw ix iy lp ja jb jc hb bi translated">量化深度学习模型使用的技术允许降低权重的精度表示，并可选地激活存储和计算。</p><p id="f810" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TFLite为量化提供了几个级别的支持。</p><ol class=""><li id="6fc5" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc lv lw lx ly bi translated">训练后量化</li><li id="9a22" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc lv lw lx ly bi translated">量化感知训练。</li></ol><p id="8269" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下表显示了一些CNN模型的模型量化的好处。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es me"><img src="../Images/0595ac9ba470ed567410ab82bdb26ffc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b44eX883H2HYxQETBK3_bA.png"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">选择CNN模型的模型量化的好处。tensorflow.org</figcaption></figure><h2 id="5a8d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated"><strong class="ak">培训后量化:</strong></h2><p id="f906" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">顾名思义，这是在你的模型被训练之后。训练后量化是一种用于量化权重和激活类型的技术。这种技术可以减少模型大小，还可以改善CPU和硬件加速延迟。根据我们的要求，我们可以选择不同的优化选项，如权重、全整数等。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es mn"><img src="../Images/489cddbcf25b61ed7d773a165d6b4c0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuUvG79rpk9x_CLT9iQckA.png"/></div></div></figure><p id="a049" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TensorFlow org提供了一个决策树，可以帮助我们做决策</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es mo"><img src="../Images/b09938cfee58059cec9c286b8476b39b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7J-VbsnUqFWpythH.jpg"/></div></div><figcaption class="mj mk et er es ml mm bd b be z dx translated">tensorflow.org</figcaption></figure><p id="dcf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">权重量化:</strong></p><p id="f1f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">非常简单的训练后量化是仅量化从FP到8位精度的权重。TFLite转换器提供此选项。在推理时，权重从8位精度转换为浮点精度，并使用浮点内核进行计算。这种转换只需进行一次，并进行缓存以减少延迟。如果您想进一步改善延迟，请使用混合运算符。</p><pre class="je jf jg jh fd mp mq mr ms aw mt bi"><span id="a79d" class="ju jv hi mq b fi mu mv l mw mx">import tensorflow as tf<br/>converter = tf.lite.TFLiteConverter.from_saved_model(saved_model_dir)<br/>converter.optimizations = [tf.lite.Optimize.OPTIMIZE_FOR_SIZE]<br/>tflite_quant_model = converter.convert()</span></pre><p id="ee18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转换时，设置<code class="du my mz na mq b">optimizations</code>标志以优化模型尺寸。</p><p id="f069" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种优化提供了接近完全定点推断的延迟。但是，<strong class="ih hj"> <em class="jm">输出仍然使用浮点</em> </strong>存储。</p><p id="19b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">全整数量化:</strong></p><p id="0f1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以进一步改善延迟，减少峰值内存使用，并通过确保所有模型数学量化来访问纯整数硬件加速器。在全整数量化中，您需要通过提供数据集来测量激活和输入的动态范围，使用输入数据生成器创建数据集。</p><pre class="je jf jg jh fd mp mq mr ms aw mt bi"><span id="afec" class="ju jv hi mq b fi mu mv l mw mx">import tensorflow as tf<br/><br/>def representative_dataset_gen():<br/>  for _ in range(num_calibration_steps):<br/>    yield [input]</span><span id="8c0c" class="ju jv hi mq b fi nb mv l mw mx">converter = tf.lite.TFLiteConverter.from_saved_model(saved_model_dir)<br/>converter.optimizations = [tf.lite.Optimize.DEFAULT]<br/>converter.representative_dataset = representative_dataset_gen<br/>tflite_quant_model = converter.convert()</span></pre><p id="920b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">全整数量化的结果应该是全量化的，任何运算在FP中都没有量化实现。全整数执行可获得延迟更快、尺寸更小、与整数加速器兼容的模型。</p><p id="be57" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在转换前添加以下行，可以对所有运算强制执行全整数量化，并使用整数输入和输出。</p><blockquote class="kv kw kx"><p id="2fa3" class="if ig jm ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated">如果遇到当前无法量化的操作，转换器将抛出错误。</p></blockquote><pre class="je jf jg jh fd mp mq mr ms aw mt bi"><span id="138f" class="ju jv hi mq b fi mu mv l mw mx">converter.target_spec.supported_ops = <br/>[tf.lite.OpsSet.TFLITE_BUILTINS_INT8]</span><span id="e227" class="ju jv hi mq b fi nb mv l mw mx">converter.inference_input_type = tf.uint8<br/>converter.inference_output_type = tf.uint8</span></pre><p id="904a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">浮点16量化示例:</strong></p><p id="7f27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">16位浮点数的IEEE标准。我们可以通过将权重量化为float16来减小浮点模型的大小。与其他技术相比，这种技术将模型大小减少了一半，精度损失最小。这种技术模型在CPU上运行时会将权重值“反量化”为float32。</p><pre class="je jf jg jh fd mp mq mr ms aw mt bi"><span id="8d21" class="ju jv hi mq b fi mu mv l mw mx">import tensorflow as tf<br/>converter = tf.lite.TFLiteConverter.from_saved_model(saved_model_dir)<br/>converter.optimizations = [tf.lite.Optimize.DEFAULT]<br/>converter.target_spec.supported_types = [tf.lite.constants.FLOAT16]<br/>tflite_quant_model = converter.convert()</span></pre><p id="8756" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经在训练后量化中看到了一种不同的技术:如果您需要最高的性能，浮点16量化可能不是一个好的选择。在这种情况下，定点数学的全整数量化会更好。权重量化是非常基本的量化。由于权重是训练后量化的，<strong class="ih hj">可能会有精度损失，特别是对于较小的网络</strong>。</p><p id="a7de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/tools/accuracy/ilsvrc/README.md" rel="noopener ugc nofollow" target="_blank"> Tensorflow Lite模型精度</a></p><h2 id="14b3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">量化感知培训:</h2><p id="26f7" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">训练后的模型量化可能会有精度损失，为了避免这种情况，如果您不想损害模型精度，请进行量化感知训练。如我们所知，训练后量化技术是在模型被训练之后。为了克服训练后量化技术的缺点，我们有量化感知模型训练。这种技术确保了前向传球在训练和推断两方面都符合<strong class="ih hj">精度</strong>。在这项技术中，Tensorflow创建了flow，在构建图形的过程中，您可以在每一层中插入假节点，以模拟向前和向后传递中的量化效果，并在训练过程中学习范围，分别针对每一层。</p><p id="44d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这项技术有两个方面</p><ul class=""><li id="8f4d" class="lq lr hi ih b ii ij im in iq ls iu lt iy lu jc nc lw lx ly bi translated">推理时的算子融合在训练时被精确建模。</li><li id="f066" class="lq lr hi ih b ii lz im ma iq mb iu mc iy md jc nc lw lx ly bi translated">推理时的量化效应在训练时建模。</li></ul><pre class="je jf jg jh fd mp mq mr ms aw mt bi"><span id="0410" class="ju jv hi mq b fi mu mv l mw mx">tf.quantization.quantize(<br/>    input,<br/>    min_range,<br/>    max_range,<br/>    T,<br/>    mode='MIN_COMBINED',<br/>    round_mode='HALF_AWAY_FROM_ZERO',<br/>    name=None<br/>)</span><span id="c5e0" class="ju jv hi mq b fi nb mv l mw mx"><br/>out[i] = (in[i] - min_range) * range(T) / (max_range - min_range)<br/>if T == qint8: out[i] -= (range(T) + 1) / 2.0<br/></span><span id="6edf" class="ju jv hi mq b fi nb mv l mw mx">num_discrete_values = 1 &lt;&lt; (# of bits in T)<br/>range_adjust = num_discrete_values / (num_discrete_values - 1)<br/>range = (range_max - range_min) * range_adjust<br/>range_scale = num_discrete_values / range<br/>quantized = round(input * range_scale) - round(range_min * range_scale) +<br/>  numeric_limits&lt;T&gt;::min()<br/>quantized = max(quantized, numeric_limits&lt;T&gt;::min())<br/>quantized = min(quantized, numeric_limits&lt;T&gt;::max())</span></pre><p id="d0bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://www.tensorflow.org/api_docs/python/tf/quantization/quantize" rel="noopener ugc nofollow" target="_blank">点击此处查看完整示例:</a></p><p id="61de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:-</p><p id="7609" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://www.tensorflow.org/lite/convert/quantization" rel="noopener ugc nofollow" target="_blank">https://www.tensorflow.org/lite/convert/quantization</a></p><p id="2416" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jl" href="https://github.com/tensorflow/tensorflow/tree/r1.13/tensorflow/contrib/quantize" rel="noopener ugc nofollow" target="_blank">https://github . com/tensor flow/tensor flow/tree/r 1.13/tensor flow/contrib/quantize</a></p><h1 id="1c24" class="nd jv hi bd jw ne nf ng ka nh ni nj ke nk nl nm kh nn no np kk nq nr ns kn nt bi translated"><a class="ae jl" href="https://maheshwar-ligade.medium.com/" rel="noopener">更多这样的故事</a></h1><div class="nu nv ez fb nw nx"><a href="https://medium.com/techwasti" rel="noopener follow" target="_blank"><div class="ny ab dw"><div class="nz ab oa cl cj ob"><h2 class="bd hj fi z dy oc ea eb od ed ef hh bi translated">泰克瓦斯蒂</h2><div class="oe l"><h3 class="bd b fi z dy oc ea eb od ed ef dx translated">Techwasti是我们分享思想、概念、想法和代码的社区。</h3></div><div class="of l"><p class="bd b fp z dy oc ea eb od ed ef dx translated">medium.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol jj nx"/></div></div></a></div><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es om"><img src="../Images/5a6ffa689f5251446a71f32f949836c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d-tus_Y6z9nVOCMC.png"/></div></figure><p id="f308" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">我们连线上</strong><a class="ae jl" href="http://stackoverflow.com/users/3187349/maheshwar-ligade" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">stack overflow</strong></a><strong class="ih hj"/><a class="ae jl" href="https://in.linkedin.com/in/maheshwar-ligade-14447841" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">LinkedIn</strong></a><strong class="ih hj"/><a class="ae jl" href="https://www.facebook.com/maheshwar.ligade" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">脸书</strong></a><strong class="ih hj">&amp;</strong><a class="ae jl" href="https://twitter.com/MaheshwarLigade" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Twitter</strong></a><strong class="ih hj">。</strong></p></div></div>    
</body>
</html>