# å¦‚ä½•åœ¨ 1 ç§’å†…å°† 50 ä¸ª OpenCV å¸§ä¸Šä¼ åˆ°äº‘å­˜å‚¨

> åŸæ–‡ï¼š<https://medium.com/analytics-vidhya/how-to-upload-50-opencv-frames-into-cloud-storage-within-1-second-653ee73d7711?source=collection_archive---------4----------------------->

## å¦‚ä½•è¯»å– RTSP/è§†é¢‘å¸§å¹¶ä»¥å¼‚æ­¥æ–¹å¼ä¸Šä¼ åˆ°äº‘å­˜å‚¨

![](img/98b661e9acf461b549b5984dbe9ceff3.png)

paweczerwi ski åœ¨ [Unsplash](https://unsplash.com/s/photos/surveillance?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) ä¸Šçš„ç…§ç‰‡

# ç”¨ä¾‹

åœ¨è¿™ä¸ªç°ä»£ä¸–ç•Œï¼Œæˆ‘æƒ³æˆ‘ä»¬å¤§å¤šæ•°äººéƒ½ç†Ÿæ‚‰ä½¿ç”¨è®¡ç®—æœºè§†è§‰åº”ç”¨çš„æ–°è¡Œä¸šã€‚ç‰¹åˆ«æ˜¯é—­è·¯ç”µè§†ç›‘è§†æ‘„åƒæœºå’Œè§†é¢‘åˆ†æï¼Œè¿™äº›éƒ½æœ‰åŠ©äºåœ¨è®¡ç®—æœºè§†è§‰æŠ€æœ¯ä¸­å‘æŒ¥é‡è¦ä½œç”¨ã€‚

ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬åˆ†æé—­è·¯ç”µè§†æ‘„åƒæœºæ—¶ï¼Œä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ OpenCV è¯»å– RTSP URLï¼Œç„¶åæˆ‘ä»¬åº”è¯¥å°†å®ƒå­˜å‚¨åœ¨äº‘ä¸­çš„æŸä¸ªä½ç½®ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥åˆ†æã€‚

ä½†é—®é¢˜æ˜¯ï¼Œå½“æˆ‘ä»¬æŠŠå¸§ä¸€ä¸ªæ¥ä¸€ä¸ªä¸Šä¼ åˆ°äº‘ç«¯çš„æ—¶å€™ï¼Œä¸Šä¼ æ˜¯éœ€è¦ä¸€äº›æ—¶é—´çš„ï¼Œä¸æ˜¯å—ï¼Ÿ

ä¸ºäº†è·å¾—å¯¹æ­¤çš„æ¸…æ™°ç†è§£ï¼Œæˆ‘ç”¨ Google bucket åšäº†ä¸€ä¸ªå®éªŒï¼Œå®ƒè®¡ç®—å‡ºä¸€å¸§éœ€è¦ 1.05 ç§’æ¥ä¸Šä¼  Google bucketã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸ç­‰å¾… 1 ç§’é’Ÿä»¥è·å¾—å“åº”ï¼Œç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä¸Šä¼ è¯¥è¡Œä¸­çš„ä¸‹ä¸€å¸§ã€‚

åœ¨ä½ çš„æœŸå¾…ä¸‹ï¼Œæˆ‘æ­£åœ¨å¯»æ‰¾è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ï¼Œç»™ä½ ï¼ï¼ï¼

> è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [**èŠ¹èœ**](https://docs.celeryproject.org/en/master/index.html) ä»¥å¼‚æ­¥æ–¹å¼ä¸Šä¼ å¸§ã€‚

å½“æˆ‘ä»¬ä»¥å¼‚æ­¥æ–¹å¼ä¸Šä¼ å¸§æ—¶ï¼Œæˆ‘ä»¬æ— æ³•è·å¾—åºåˆ—å¸§ï¼Œä½œä¸ºä¸€ç§æ‰‹æ®µï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨èŠ¹èœä¸­çš„ç»„å’Œé“¾æ¦‚å¿µã€‚

è®¸å¤šäºº(éä¸“ä¸šäººå£«)ä¼šæœ‰å…´è¶£çŸ¥é“ï¼›**èŠ¹èœæ˜¯ä»€ä¹ˆï¼Ÿ**

[**èŠ¹èœ**](http://www.celeryproject.org/) æ˜¯ Python ä¸–ç•Œä¸­æœ€å—ä½œä¸šç®¡ç†è€…æ¬¢è¿çš„èƒŒæ™¯ä¹‹ä¸€ã€‚

â€œèŠ¹èœâ€ä¸ RabbitMQ æˆ– Redis ç­‰å‡ ä¸ªæ¶ˆæ¯ä»£ç†å…¼å®¹ã€‚è¿™äº›æ—¢å¯ä»¥ä½œä¸ºç”Ÿäº§è€…ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæ¶ˆè´¹è€…ã€‚æ­¤å¤–ï¼Œâ€œCeleryâ€æ˜¯åŸºäºåˆ†å¸ƒå¼æ¶ˆæ¯ä¼ é€’çš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—/ä½œä¸šé˜Ÿåˆ—ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜ä¸“æ³¨äºå®æ—¶æ“ä½œï¼Œå¹¶æ”¯æŒè°ƒåº¦ã€‚

æ¾„æ¸…äº†å®šä¹‰ä¹‹åï¼Œä¸‹é¢è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç”¨ python ä»£ç é…ç½® celeryã€‚

**ç¬¬ä¸€æ­¥:-** å¯¼å…¥æ‰€æœ‰å¿…éœ€çš„èŠ¹èœåŒ…

```
from celery import Celery
from celery.result import AsyncResult
from celery.result import allow_join_result
from celery.decorators import periodic_task
```

**æ­¥éª¤ 2:-** æˆ‘ä»¬åº”è¯¥åœ¨èŠ¹èœä¸­é…ç½®ä»£ç†å’Œåç«¯ã€‚æˆ‘å·²ç»ä½¿ç”¨ Redis ä½œä¸ºåç«¯ï¼Œæ‰€ä»¥[åœ¨ä½ çš„ç³»ç»Ÿä¸­å®‰è£… Redis](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04) ï¼Œè¯·ç¡®ä¿å®ƒè¿è¡ŒæˆåŠŸï¼›

```
app = Celery(â€˜tasksâ€™, backend=â€™redis://guest@127.0.0.1:6379', broker=â€™redis://guest@127.0.0.1:6379')
```

**ç¬¬ä¸‰æ­¥:-** ä¸ºäº†å¼‚æ­¥è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬è¦åœ¨å‡½æ•°ä¸Šæ”¾ **"@app.taks annotation"** ã€‚

ä¸‹é¢æ˜¯å°†å¸§ä¸Šä¼ åˆ° Google bucket çš„æ ·æœ¬ celery ä»£ç ã€‚

```
[@app](http://twitter.com/app).task(bind=True, max_retries=30)
def upload_frames_gcs(self, file_name):
    try:
        url = upload_file_to_gcs(file_name)
        return url
    except Exception as e:
        raise self.retry(exc=e)
```

ç¬¬å››æ­¥:- ä»¥ä¸‹æ˜¯æœ€é‡è¦çš„æ­¥éª¤:

æˆ‘ä»¬å°†æ— æ³•ç›´æ¥è°ƒç”¨å‡½æ•°å¹¶ä»¥å¼‚æ­¥æ–¹å¼ä¸Šä¼ å¸§ï¼Œå› ä¸ºä¸Šä¼ åæ— æ³•è·å¾—åºåˆ—å¸§ï¼Œæ‰€ä»¥è¦ä½¿ç”¨èŠ¹èœä¸­çš„[é“¾](https://docs.celeryproject.org/en/stable/userguide/canvas.html#chains)å’Œ[ç»„](https://docs.celeryproject.org/en/stable/userguide/canvas.html#groups)æ¦‚å¿µå°†å¸§ä¸Šä¼ åˆ°ä¸€ä¸ªæ¡¶ä¸­ã€‚ä½¿ç”¨è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¹¶è¡Œä¸Šä¼ å¤šè¾¾ 5 æˆ– 10 å¸§ï¼Œä¹Ÿå¯ä»¥å¾—åˆ°å¸§çš„åºåˆ—é¡ºåºã€‚ç„¶è€Œï¼Œåœ¨è¿›å…¥ç¼–ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹**â€œèŠ¹èœä¸­çš„é“¾å’Œç»„æ˜¯ä»€ä¹ˆâ€**

## èŠ¹èœé“¾

> é“¾æ˜¯ä¸€ç§åŸè¯­ï¼Œå®ƒè®©æˆ‘ä»¬å°†æ›´å¤šçš„ä»»åŠ¡é“¾æ¥åˆ°ä¸€ä¸ªå•ä¸€çš„ç­¾åä¸­ï¼Œå› æ­¤å®ƒè¢«ç§°ä¸º**â€œä¸€ä¸ªæ¥ä¸€ä¸ªï¼Œæœ¬è´¨ä¸Šå½¢æˆäº†å›è°ƒçš„*é“¾***ã€‚

ä¹Ÿè®¸ï¼Œå¦‚æœä½ ä»ç„¶ä¸ç¡®å®šï¼Œç„¶è€Œï¼Œä¸‹é¢çš„å›¾è¡¨ä¼šç»™ä½ ä¸€ä¸ªæ¸…æ™°çš„æƒ³æ³•ï¼Œå¦‚ä½•åœ¨èŠ¹èœé“¾å·¥ç¨‹ã€‚è¿™äº›æ˜¯èŠ¹èœé‡Œçš„ä»»åŠ¡ idã€‚

## èŠ¹èœä¸­çš„ç¾¤ä½“

> ç»„åŸè¯­æ˜¯ä¸€ä¸ªç­¾åï¼Œå®ƒæ¥å—åº”è¯¥å¹¶è¡Œåº”ç”¨çš„ä»»åŠ¡åˆ—è¡¨ã€‚

è¿™æ˜¯ç¤ºä¾‹ä»£ç æ¥è§£é‡Šï¼Œ**æˆ‘å¦‚ä½•ä¸Šä¼ å¸§åˆ°è°·æ­Œæ¡¶ä½¿ç”¨ç»„å’Œé“¾æŠ€æœ¯åœ¨èŠ¹èœ**ã€‚

```
jobs = group(upload_frames_gcs.s(file_name, ts) for ts, file_name in file_name_dic.items())result = jobs.apply_async()
```

å¯ä»¥ç†è§£çš„æ˜¯ï¼Œæˆ‘åœ¨ä¸€ä¸ªç»„æ–¹æ³•ä¸­è°ƒç”¨ **upload_frames_gcs** å‡½æ•°ï¼Œç„¶åä½ å¯ä»¥çœ‹åˆ°â€œsâ€ä¼ é€’ä¸€ä¸ªåä¸º**â€œChains conceptâ€**çš„å‚æ•°ï¼Œè¿™å…è®¸ä½ é“¾æ¥ç­¾åï¼Œåœ¨ç»“æœ**ä¸­ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°è¢«è°ƒç”¨ï¼Œå®è´¨ä¸Šå½¢æˆäº†ä¸€ä¸ªå›è°ƒ**çš„*é“¾*ã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­å¾—åˆ°ä¸€ç»„ç»“æœã€‚

**ç¬¬äº”æ­¥:-** éš¾æ€ªï¼Œå¦‚æœä½ å¯èƒ½è®¤ä¸ºå¦‚ä½•åœ¨èŠ¹èœä¸Šä¼ åè·å¾—æ¡†æ¶ç½‘å€ã€‚å¾ˆç®€å•ï¼Œåœ¨ç»“æœå˜é‡ä¸­ä½ å¯ä»¥å¾—åˆ°è¿™ä¸ªç»„å‡½æ•°çš„ä»»åŠ¡ idï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªä»»åŠ¡ id æ¥å¾—åˆ°ç»“æœã€‚

ä½†æ˜¯ï¼Œè¦å°å¿ƒæ£€æŸ¥ä»»åŠ¡çš„çŠ¶æ€ï¼Œä¸€æ—¦ä»»åŠ¡å®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—æ¡†æ¶çš„ URLã€‚

```
def taskid_status(task_id_array):
        for task in task_id_array:
            if task.successful():
                task_id_array.remove(task)
                with allow_join_result(): frames_array = []
                    for results in task.join(): 
                        frame_dic = {}
                        frame_dic['frame_url'] = results[0]
                        frames_array.append(frame_dic) return task_id_array, frames_array
```

åœ¨ frames_array å˜é‡ä¸­ï¼Œæ‚¨å¯ä»¥è·å¾—å¸¦æœ‰æ—¶é—´æˆ³çš„æ‰€æœ‰å¸§ã€‚

# æˆ‘å·²ç»ç”¨å¤šä¸ªä¸åŒçš„æµ‹è¯•ç”¨ä¾‹æµ‹è¯•äº†æ€§èƒ½ã€‚

1.  **5 å¸§ä¸Šä¼ è°·æ­Œå­˜å‚¨éœ€è¦ 0.85 ç§’ã€‚**
2.  **10 å¸§ä¸Šä¼ è°·æ­Œå­˜å‚¨éœ€è¦ 0.77 åˆ° 0.82 ç§’ã€‚**
3.  **15 å¸§ä¸Šä¼ è°·æ­Œå­˜å‚¨éœ€è¦ 0.9 åˆ° 1.0 ç§’ã€‚**
4.  **30 å¸§ä¸Šä¼ è°·æ­Œå­˜å‚¨éœ€è¦ 0.7 åˆ° 0.8 ç§’ã€‚**

å¾ˆæ˜æ˜¾ï¼Œå¢åŠ ä¸Šä¼ åˆ° bucket çš„å¸§æ•°å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œå› ä¸ºåœ¨ celery ä¸­ä½¿ç”¨äº†å¤šå¤„ç†æ¥æ‰§è¡Œä»»åŠ¡çš„å¹¶å‘æ‰§è¡Œã€‚

> å¦‚æœä½ éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ã€‚è¯·éšæ—¶è”ç³»æˆ‘[balavenkatesh.com](http://balavenkatesh.com/)ğŸ“¬æˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ã€‚ğŸ–¥ï¸