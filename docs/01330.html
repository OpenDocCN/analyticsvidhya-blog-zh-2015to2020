<html>
<head>
<title>Predicting Customer Churn Rates with Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Spark预测客户流失率</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/predicting-customer-churn-rates-with-spark-61b0e0747b65?source=collection_archive---------7-----------------------#2019-10-15">https://medium.com/analytics-vidhya/predicting-customer-churn-rates-with-spark-61b0e0747b65?source=collection_archive---------7-----------------------#2019-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/607c6150d7a16a189d6bb954c2b7dcc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yUZ3cSKkYo1i4EHMcdBGyA.jpeg"/></div></div></figure><div class=""/><p id="f0ae" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">客户流失率是大多数电子商务公司的一大头痛问题。客户为什么会流失？搅动的主要因素是什么？有什么模式可以让我们预测流失率吗？</p><p id="dd91" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不断上升的流失率对电子商务公司的收入产生了重大影响。因此，预测他们以及影响流失的因素对这些公司来说非常重要。</p><p id="db7c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文解决了这些问题，并展示了如何预测一家名为Sparkify的虚构公司的流失率。</p><p id="01e6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这个项目，我使用Apache Spark和Python (PySpark)。</p><h1 id="0022" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Sparkify项目概述</h1><p id="acbe" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Sparkify是一个虚构的音乐流媒体服务，有数千首歌曲和作者模仿流行的流媒体服务Spotify。Sparkify用户可以播放音乐，并与应用程序互动。该应用程序有两个订阅级别:免费和付费。</p><p id="11db" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Sparkify中包含的数据量很大。为了处理它，我使用Apache Spark框架。</p><p id="68c3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一般的方法是在一个较小的数据子集(大约230MB)上测试该算法，然后将其部署在Spark集群上，并在整个数据集上进行测试。</p><p id="efaa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，我清理数据并可视化变量之间的一些相关性。</p><p id="f0fc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第二步，我将一些特征转换成数字特征，并在现有特征的基础上创建一些新特征。</p><p id="6a60" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我在这个数据子集上测试三个基本算法。基于他们的表现，我选择一个进行最终分析。</p><h1 id="e6c8" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">数据描述和特征工程</h1><p id="e7ad" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Sparkify数据子集以json格式提供，包含环岛226用户。</p><p id="fef1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Spakrify数据具有以下结构:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="bb60" class="la jp ht kw b fi lb lc l ld le">root<br/> |-- artist: string (nullable = true)<br/> |-- auth: string (nullable = true)<br/> |-- firstName: string (nullable = true)<br/> |-- gender: string (nullable = true)<br/> |-- itemInSession: long (nullable = true)<br/> |-- lastName: string (nullable = true)<br/> |-- length: double (nullable = true)<br/> |-- level: string (nullable = true)<br/> |-- location: string (nullable = true)<br/> |-- method: string (nullable = true)<br/> |-- page: string (nullable = true)<br/> |-- registration: long (nullable = true)<br/> |-- sessionId: long (nullable = true)<br/> |-- song: string (nullable = true)<br/> |-- status: long (nullable = true)<br/> |-- ts: long (nullable = true)<br/> |-- userAgent: string (nullable = true)<br/> |-- userId: string (nullable = true)</span></pre><p id="d408" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尽管相对较小，但这些数据包含了用户与应用程序交互的许多信息。为了提取一些相关信息，我首先清理和重组数据。</p><p id="96c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为第一步，我删除重复，空值和一些不太相关的信息。第二步，我在已有特征的基础上计算一些新的特征。</p><p id="9f7f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我还根据数据集中包含的“取消确认”特性从数据集中创建了一个客户流失特性。</p><p id="9d68" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">处理后的数据集如下所示:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="aac0" class="la jp ht kw b fi lb lc l ld le">+-------------+----------+---------+-----------+-----------------+---------+-----+<br/>|song_per_user|gender_num|thumbs_up|thumbs_down|   listening_time|level_num|label|<br/>+-------------+----------+---------+-----------+-----------------+---------+-----+<br/>|          381|         1|       17|          5|66940.89735000003|        0|    0|<br/>|          381|         1|       17|          5|66940.89735000003|        0|    0|<br/>|          381|         1|       17|          5|66940.89735000003|        0|    0|<br/>|          381|         1|       17|          5|66940.89735000003|        0|    0|<br/>|          381|         1|       17|          5|66940.89735000003|        0|    0|<br/>+-------------+----------+---------+-----------+-----------------+---------+-----+</span></pre><p id="863d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">*标签是流失特征。</p><h1 id="451a" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">流失的潜在因素——可视化</h1><p id="14db" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在实现更高级的分析工具之前，我首先通过一些可视化来查看数据。这种方法允许我验证在用户交互中是否有一些直观的直接关系。</p><p id="6275" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">客户流失是否与特定的时间变量有关，比如一天中的某个小时？</p><figure class="kr ks kt ku fd hk er es paragraph-image"><div class="er es lf"><img src="../Images/7075183b5c3c1b8a91db64654bcc31eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*pokNdNE5mZzO8u7h-zfeVA.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx translated">流失计数与一天中的小时数</figcaption></figure><p id="95e9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">付费用户比免费订阅用户流失更多吗？</strong></p><figure class="kr ks kt ku fd hk er es paragraph-image"><div class="er es lk"><img src="../Images/70fe420cbd2759e7b4b0a6d375617c37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*jr_PY14i8O_I0vwuFrfoTg.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx translated">客户流失与订阅水平</figcaption></figure><p id="50b0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">客户流失取决于地理位置吗？</strong></p><figure class="kr ks kt ku fd hk er es paragraph-image"><div class="er es ll"><img src="../Images/cd2b2c23148b704cdc5229342f431279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*rvrR4wvZKpkRrWIox7e8fw.png"/></div><figcaption class="lg lh et er es li lj bd b be z dx translated">客户流失与地理位置</figcaption></figure><p id="1e56" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从这三种视觉效果来看，只有地理位置与客户流失有一定关系。一些州似乎比其他州的流失率更高。然而，我们无法核实每个地理位置是否有其他因素影响流失率。</p><h1 id="b111" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">系统模型化</h1><p id="5423" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在Apache Spark框架中，并不是所有的机器学习算法都受支持。我的建模策略必须考虑这个事实。</p><p id="8414" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为第一步，我实现了三个基本算法，没有任何具体的参数调整:</p><ol class=""><li id="c8ee" class="lm ln ht is b it iu ix iy jb lo jf lp jj lq jn lr ls lt lu bi translated">逻辑回归</li><li id="85f9" class="lm ln ht is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">随机福里斯特</li><li id="aa8b" class="lm ln ht is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">梯度推进</li></ol><p id="2e40" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于数据集在流失用户和未流失用户之间严重失衡，我将F1分数作为成功预测的指标。</p><h2 id="3a86" class="la jp ht bd jq ma mb mc ju md me mf jy jb mg mh kc jf mi mj kg jj mk ml kk mm bi translated">基本方法:逻辑回归、随机森林和梯度推进</h2><p id="a754" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在基本方法中，测试了三种算法:逻辑回归、随机森林和梯度增强，以便检查它们在F1分数上的性能。</p><p id="ff3a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">梯度增强算法表现最佳，F1值为99%。然而，这个分数也指出了主要的过度拟合，这很可能是由在测试样本中搅动的小样本客户引起的。</p><p id="07b9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，作为下一步，我还试图通过更均匀地分割训练/测试样本来解决这个问题。</p><p id="ff78" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一步中，我使用如下调整的参数实现梯度增强:</p><ul class=""><li id="2091" class="lm ln ht is b it iu ix iy jb lo jf lp jj lq jn mn ls lt lu bi translated">三重交叉验证</li><li id="4068" class="lm ln ht is b it lv ix lw jb lx jf ly jj lz jn mn ls lt lu bi translated">最大迭代次数:5，10</li><li id="a494" class="lm ln ht is b it lv ix lw jb lx jf ly jj lz jn mn ls lt lu bi translated">最大深度:4，12</li></ul><p id="e349" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实施这一策略后，F1得分保持在99%。</p><h1 id="ed1e" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结果和结论</h1><p id="43f9" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">基于这种策略，虽然参数调整并不能提高算法的性能，但是性能最好的算法是梯度提升。F1分高很可能是测试组样本量小造成的。</p><figure class="kr ks kt ku fd hk er es paragraph-image"><div class="er es mo"><img src="../Images/f1a3a2f5d71fb9843be603bf25b07011.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*a6MPS9TR9ObBGi3DyWjTAg.png"/></div></figure><p id="d394" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于上述可视化，影响流失率最大的因素是:每个用户播放的歌曲数量、通过给定拇指(向下或向上)的数量显示的用户参与度以及总收听时间。</p><p id="ba8f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个分析的代码可以在我的<a class="ae mp" href="https://github.com/aleksandraklofat/Sparkify-predicting-customer-churn" rel="noopener ugc nofollow" target="_blank"> Github </a>个人资料中找到。</p><p id="7fe5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">作者</strong>:亚历山大·克洛法特数据科学家@ <a class="ae mp" href="https://datenverstehen.de/" rel="noopener ugc nofollow" target="_blank"> datenvertstehen.de </a></p></div></div>    
</body>
</html>