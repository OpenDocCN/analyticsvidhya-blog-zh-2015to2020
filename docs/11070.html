<html>
<head>
<title>Deploying Classification Model using Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flask部署分类模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-classification-model-using-flask-5b92fbe1def5?source=collection_archive---------16-----------------------#2020-11-16">https://medium.com/analytics-vidhya/deploying-classification-model-using-flask-5b92fbe1def5?source=collection_archive---------16-----------------------#2020-11-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/9fa03da1ee1057f95b9f519b43e079a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*xxTrdV6uAOfRwL_TdTsgsw.png"/></div></figure><p id="8ba7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我的<a class="ae jk" rel="noopener" href="/analytics-vidhya/image-classification-using-fast-ai-a67078f6954e">上一篇文章</a>中，我已经描述了使用Fast.ai构建图像分类模型的过程，在这篇文章中，让我们看看如何将它部署在由Flask制成的web应用程序上。</p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jl"><img src="../Images/502428fc692e05db13a4201a3d5fcf6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4MpCWwQJp5l3gWxQIJlshg.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated"><a class="ae jk" href="https://www.google.com/search?q=flask+logo+hd&amp;tbm=isch&amp;ved=2ahUKEwjpmIuDvobtAhVQoUsFHQ8zBj8Q2-cCegQIABAA&amp;oq=flask+logo+hd&amp;gs_lcp=CgNpbWcQAzIECCMQJ1CSFFiSFGDOF2gAcAB4AIABmwGIAZsBkgEDMC4xmAEAoAEBqgELZ3dzLXdpei1pbWfAAQE&amp;sclient=img&amp;ei=mCKyX-nsG9DCrtoPj-aY-AM&amp;bih=694&amp;biw=1517&amp;rlz=1C1CHBD_enIN891IN892#imgrc=oNEF6tJFZ2ARHM" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="afa9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们建立的模型的小背景——将车辆分为紧急和非紧急两类。现在模型建立了，下一步呢？你想如何使用你训练好的模型？一个简单的答案是构建一个web应用程序，您可以在其中传递图像并请求预测。web开发有两个基于python的选项:Flask和Django。我选择Flask是因为与Django相比它是轻量级的，还因为我的部署将只基于文本形式的请求/响应。Django有很多我的webapp可能不需要的东西，也可以在Flask中做任何在Django中可以做的事情。</p><p id="0eb5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以这篇文章从上一篇文章结束的地方开始，也就是在得到。pkl "文件的模型。我们构建了webapp，它在后端运行训练好的模型来获得预测。所以让我们开始吧…</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="ee27" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">web应用中的两个关键文件是</strong></p><ol class=""><li id="f282" class="kf kg hi io b ip iq it iu ix kh jb ki jf kj jj kk kl km kn bi translated"><strong class="io hj"> predict_app.py </strong> —包含后端flask服务器代码和使用训练好的模型预测结果的逻辑</li><li id="4c4d" class="kf kg hi io b ip ko it kp ix kq jb kr jf ks jj kk kl km kn bi translated"><strong class="io hj">predict.html</strong>—包含在网页上查看结果的前端html代码</li></ol><p id="dc01" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">**如果您的环境中没有安装Flask，您可以使用“pip install flask”进行安装</p><p id="372b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">以下代码来自predict_app.py </strong></p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="4f97" class="ky kz hi ku b fi la lb l lc ld"># -*- coding: utf-8 -*-<br/>"""<br/>Created on Sun Nov  1 05:03:08 2020</span><span id="39a3" class="ky kz hi ku b fi le lb l lc ld"><a class="ae jk" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a>: manohar<br/>"""</span><span id="07f5" class="ky kz hi ku b fi le lb l lc ld">import base64<br/>import numpy as np<br/>import io<br/>from PIL import Image<br/>from flask import request<br/>from flask import jsonify<br/>from flask import Flask<br/>import json<br/>from pathlib import Path<br/>from skimage import transform</span><span id="e875" class="ky kz hi ku b fi le lb l lc ld">import fastai<br/>from fastai import *<br/>from fastai.utils import *<br/>from fastai.vision import *<br/>from fastai.callbacks import *</span><span id="e323" class="ky kz hi ku b fi le lb l lc ld">app = Flask(__name__)</span><span id="e05c" class="ky kz hi ku b fi le lb l lc ld">def get_model():<br/>    learn = load_learner('.', file = 'av_cv.pkl')<br/>    print(" * Model loaded!")<br/>    <br/>print(" * Loading keras model...")<br/>get_model()</span><span id="0d73" class="ky kz hi ku b fi le lb l lc ld"><a class="ae jk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route("/predict", methods=["POST"])<br/>def predict():<br/>    message = request.get_json(force=True)<br/>    encoded = message['image']<br/>    decoded = base64.b64decode(encoded)<br/>    img = Image.open(io.BytesIO(decoded))<br/>        <br/>    #     img = np.array(img).astype('float')/255<br/>    #     img = transform.resize(img,(512,512,3))<br/>    #     img = img.resize((512,512))<br/>    #     img = img_to_array(img)<br/>    #     print(img.shape)<br/>    #     img = np.expand_dims(img, axis=0)<br/>    #     print(img.shape)<br/>        <br/>    #     tf.keras.backend.set_session(sess)<br/>    #     prediction = model.predict(img)<br/>        <br/>    <br/>    prediction = learn.predict(img)<br/>    print(prediction)<br/>        <br/>    response = {<br/>            'prediction': {<br/>                'Emergency': str(1-prediction[0][0]),<br/>                'Non_Emergency': str(prediction[0][0])<br/>            }<br/>        }<br/>    return jsonify(response)</span><span id="d92f" class="ky kz hi ku b fi le lb l lc ld"><a class="ae jk" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route("/predict", methods=["POST"])<br/>def predict():<br/>    message = request.get_json(force=True)<br/>    encoded = message['image']<br/>    decoded = base64.b64decode(encoded)<br/>    img = Image.open(io.BytesIO(decoded))<br/>        <br/>    #     img = np.array(img).astype('float')/255<br/>    #     img = transform.resize(img,(512,512,3))<br/>    ##     img = img.resize((512,512))<br/>    ##     img = img_to_array(img)<br/>    #     print(img.shape)<br/>    #     img = np.expand_dims(img, axis=0)<br/>    #     print(img.shape)<br/>        <br/>    #     tf.keras.backend.set_session(sess)<br/>    #     prediction = model.predict(img)<br/>        <br/>    <br/>    prediction = np.array(learn.predict(img)[-1])<br/>    print(prediction)<br/>        <br/>    response = {<br/>            'prediction': {<br/>                'Emergency': str(prediction[0]),<br/>                'Non_Emergency': str(prediction[1])<br/>            }<br/>        }<br/>    return jsonify(response)</span></pre><p id="0eb9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上面的代码适用于构建在Fast.ai上的模型，尽管同样的代码也可以用于构建在keras上的模型。您只需要导入所需的库，并使用注释代码进行推理，给出正确的图像大小。你可能也需要开始一个疗程-</p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="3785" class="ky kz hi ku b fi la lb l lc ld">sess = tf.Session()<br/>tf.keras.backend.set_session(sess)<br/>graph = tf.get_default_graph()</span></pre><p id="81e4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后将预测函数的全部代码放入图表中，如下所示</p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="2a36" class="ky kz hi ku b fi la lb l lc ld">def predict():<br/>    global sess<br/>    global graph<br/>    with graph.as_default():<br/>        message = request.get_json(force=True)</span></pre><p id="348a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">以下代码来自predict.html</strong></p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="0fe8" class="ky kz hi ku b fi la lb l lc ld">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>    &lt;title&gt;deeplizard predict image app&lt;/title&gt;<br/>    &lt;style&gt;<br/>        * {<br/>            font-size:30px;<br/>        }<br/>    &lt;/style&gt;<br/>&lt;/head&gt;</span><span id="af9f" class="ky kz hi ku b fi le lb l lc ld">&lt;body&gt;    <br/>    &lt;input id="image-selector" type="file"&gt;    <br/>    &lt;button id="predict-button"&gt;Predict&lt;/button&gt;<br/>    &lt;p style="font-weight:bold"&gt;Predictions&lt;/p&gt;    <br/>    &lt;p&gt;Emergency: &lt;span id="emergency-prediction"&gt;&lt;/span&gt;&lt;/p&gt;<br/>    &lt;p&gt;Non Emergency: &lt;span id="non_emergency-prediction"&gt;&lt;/span&gt;&lt;/p&gt;<br/>    &lt;img id="selected-image" src=""/&gt;<br/> <br/> &lt;script src="<a class="ae jk" href="https://code.jquery.com/jquery-3.3.1.min.js" rel="noopener ugc nofollow" target="_blank">https://code.jquery.com/jquery-3.3.1.min.js</a>"&gt;&lt;/script&gt;<br/> <br/> &lt;script&gt;<br/>  let base64Image;<br/>  $("#image-selector").change(function() {<br/>   let reader = new FileReader();<br/>   reader.onload = function(e) {<br/>    let dataURL = reader.result;<br/>    $('#selected-image').attr("src", dataURL);<br/>    base64Image = dataURL.replace(/^data:image\/[a-z]+;base64,/, "");<br/>    console.log(base64Image);<br/>   }<br/>   reader.readAsDataURL($("#image-selector")[0].files[0]);<br/>   $("#emergency-prediction").text("");<br/>   $("#non_emergency-prediction").text("");<br/>  });</span><span id="e2a8" class="ky kz hi ku b fi le lb l lc ld">$("#predict-button").click(function(event){<br/>   let message = {<br/>    image: base64Image<br/>   }<br/>   console.log(message);<br/>   $.post("<a class="ae jk" href="http://localhost:5000/predict" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/predict</a>", JSON.stringify(message), function(response){<br/>    $("#emergency-prediction").text(response.prediction.Emergency);<br/>    $("#non_emergency-prediction").text(response.prediction.Non_Emergency);<br/>    console.log(response);<br/>   });<br/>  });       <br/> &lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="5fc6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">让应用程序运行起来</strong></p><p id="10db" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦这两个文件准备好了，把它们放在一个文件夹里。我通常将html文件放在主文件夹中名为“static”的文件夹中。通过您的终端，将cd放入文件夹并输入以下命令来导出flask应用程序</p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="f0cf" class="ky kz hi ku b fi la lb l lc ld">export FLASK_APP=predict_app.py</span></pre><p id="6306" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">**对于windows，请使用set而不是export</p><p id="beab" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后输入以下代码来运行该应用程序</p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="8196" class="ky kz hi ku b fi la lb l lc ld">flask run --host=0.0.0.0</span></pre><p id="848a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在web浏览器中输入以下url来访问该应用程序</p><pre class="jm jn jo jp fd kt ku kv kw aw kx bi"><span id="1d58" class="ky kz hi ku b fi la lb l lc ld"><a class="ae jk" href="http://localhost:5000/static/predict.html" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/static/predict.html</a></span></pre><p id="22b6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">** localhost —如果它在您的本地计算机上，ip_address —如果它在服务器上</p><p id="2953" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">最终的应用程序看起来像这样</strong></p><figure class="jm jn jo jp fd ij er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es lf"><img src="../Images/6435186b9e95ef1efc6b2694a5e814e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kwn9ft6Jitd2Xj-IZjg_qg.png"/></div></div></figure><p id="bf81" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你只需要浏览你想要预测的图像，点击“预测”。</p><p id="e6c2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">嘣！！显示车辆紧急或非紧急的概率分数。</p><p id="bfe6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是如何使用Flask执行模型部署！</p></div></div>    
</body>
</html>