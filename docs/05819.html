<html>
<head>
<title>Extending Keras’s ImageDataGenerator for TimeDistributed layer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为时间分布层扩展Keras的ImageDataGenerator</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/extending-kerass-imagedatagenerator-for-timedistributed-layer-3d5008fe10df?source=collection_archive---------12-----------------------#2020-05-03">https://medium.com/analytics-vidhya/extending-kerass-imagedatagenerator-for-timedistributed-layer-3d5008fe10df?source=collection_archive---------12-----------------------#2020-05-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8dba4049e6f5393f6cfb598aa1e54fc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8FCo2sC1wzfztG3ZrHSvjQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">向CNN传送图像序列</figcaption></figure><p id="0810" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">目标:</strong></p><p id="cdd6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您遇到以下类型的错误</p><blockquote class="js jt ju"><p id="cb29" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr hb bi translated">检查输入时出错:time_distributed_1_input应为5维，但得到的数组形状为(48，256，256，3)</p></blockquote><p id="666e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">你在正确的地方找到了答案。本文将通过扩展Keras优秀的<a class="ae jz" href="https://keras.io/preprocessing/image/" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj">imagedata generator</strong></a><strong class="iw hj"/>类在<a class="ae jz" href="https://keras.io/layers/wrappers/" rel="noopener ugc nofollow" target="_blank"><strong class="iw hj">time distributed</strong></a><strong class="iw hj"/>层的使用，帮助你使用它。</p><p id="06a5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">前提:</strong></p><p id="1025" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我不想解释来自深度学习框架<strong class="iw hj"> Keras </strong>的<strong class="iw hj"> TimeDistributed </strong>层的用法。简而言之，假设您有一系列图像(视频),您希望在这些图像上构建深度网络来预测“行动”,您通常会使用这一层让CNN处理图像序列，然后其o/p将被顺序馈送到LSTM层。对于普通的CNN，在图像数据的上下文中，<strong class="iw hj"> ImageDataGenerator </strong>类是为训练网络提供数据的极好方法。该生成器通常以下列格式提供数据:(BatchSize，ImageDimension)例如。(32,256,256,3).但是如果你使用<strong class="iw hj">时间分布</strong>层作为输入，数据需要以如下格式输入:(Batch，TimeSteps，ImageDimension)例如。(32,5,256,256,3).在接下来的文章中，你将会发现如何扩展ImageDataGenerator 类来达到这个目的。</p><h1 id="77a4" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><strong class="ak">“我就是想用一下”:</strong></h1><p id="d242" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated"><strong class="iw hj"> <em class="jv">步骤一:</em> </strong></p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="22a2" class="lm kb hi li b fi ln lo l lp lq">pip install TimeDistributedImageDataGenerator</span></pre><p id="013e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="jv">第二步:</em> </strong></p><p id="ceab" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">不使用<strong class="iw hj"> ImageDataGenerator </strong>类，而是使用<strong class="iw hj">TimeDistributedImageDataGenerator</strong></p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="c7be" class="lm kb hi li b fi ln lo l lp lq">datagen = TimeDistributedImageDataGenerator.TimeDistributedImageDataGenerator(validation_split=0.2, time_steps = 5)</span></pre><p id="bf5d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="jv">第三步:</em> </strong></p><p id="fcdb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下面是上面创建的datagen对象的用法示例</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="33aa" class="lm kb hi li b fi ln lo l lp lq">train_generator = datagen.flow_from_directory('/content/images',batch_size=48,subset='training')</span><span id="23ba" class="lm kb hi li b fi lr lo l lp lq">val_generator = datagen.flow_from_directory('/content/images',batch_size=48,subset='validation')</span><span id="c941" class="lm kb hi li b fi lr lo l lp lq">np.shape(train_generator.next()[0])</span><span id="2b81" class="lm kb hi li b fi lr lo l lp lq">O/P : (48, 5, 256, 256, 3) -&gt; (BatchSize,TimeSteps,ImageSize)</span></pre><p id="d2d6" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，fit方法可以使用该数据，例如将图像序列馈送到时间分布层。</p><blockquote class="js jt ju"><p id="1641" class="iu iv jv iw b ix iy iz ja jb jc jd je jw jg jh ji jx jk jl jm jy jo jp jq jr hb bi translated">声明:这个pip包目前只支持flow_from_directory()方法。</p></blockquote><h1 id="35d3" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><strong class="ak">“我自己怎么做”:</strong></h1><p id="2641" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">理解如何轻松扩展Keras类是值得的。</p><p id="0987" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> ImageDataGenerator的</strong> flow_from_directory()函数基本上是返回类<strong class="iw hj"> DirectoryIterator </strong>的对象。这个类有method _ get _ batches _ of _ transformed _ samples()，它读取并返回一批图像。此方法需要进行调整，以返回指定图像序列的批次(time_steps)。这是通过创建<strong class="iw hj"> ImageDataGenerator </strong>的新子类来实现的，该子类不返回<strong class="iw hj">目录操作符</strong>，而是返回<strong class="iw hj">目录操作符</strong>的新子类，其中_ get _ batches _ of _ transformed _ samples()方法被覆盖。在下一节中，将对此进行描述。</p><p id="3558" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="jv">第一步:</em> </strong></p><p id="04e7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">子类化原始的<strong class="iw hj"> ImageDataGenerator </strong>，并添加<em class="jv"> time_steps </em>作为新的参数来创建名为<strong class="iw hj">timedistributedimagedata generator</strong>()的新类</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/0184ad2380d1a183a77a6af9b1ed5ab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u64urqPM7D_DAbLwavqTFQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">ImageDataGenerator的子类</figcaption></figure><p id="a357" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="jv">第二步:</em> </strong></p><p id="c278" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">原始的<strong class="iw hj"> ImageDataGenerator </strong>类有我们想要重用的方法<strong class="iw hj"> flow_from_directory </strong>。该方法返回类<strong class="iw hj">director iterator</strong>的对象，我们将在下一步中将其子类化为<strong class="iw hj">time distributed director iterator</strong>。新的<strong class="iw hj">TimeDistributedImageDataGenerator</strong>类将包含方法flow_from_directory，该方法采用与之前完全相同的参数，但返回类<strong class="iw hj">TimeDistributedDirectoryIterator的对象。</strong></p><figure class="ld le lf lg fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/190013df15d735ba1a273d1c8bc5688e.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*DJ87Yez7oUkwYmgvkc-yww.jpeg"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">增强的流自目录</figcaption></figure><p id="57fa" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj"> <em class="jv">第三步:</em> </strong></p><p id="be65" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">创建名为T<strong class="iw hj">imeDistributedDirectoryIterator</strong>的新子类，继承自原始的<strong class="iw hj">目录运算符</strong>。在这个新类中，original _ get _ batches _ of _ transformed _ samples函数得到了增强，以支持time_steps。查看以下链接中的<strong class="iw hj">时间分布指示符</strong></p><p id="6a13" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae jz" href="https://github.com/kivijoshi/TimeDistributedImageDataGenerator/blob/master/TimeDistributedImageDataGenerator/TimeDistributedImageDataGenerator.py" rel="noopener ugc nofollow" target="_blank">https://github . com/kivijoshi/TimeDistributedImageDataGenerator/blob/master/TimeDistributedImageDataGenerator/TimeDistributedImageDataGenerator . py</a></p><h1 id="0e1c" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结束了</h1><p id="5a08" class="pw-post-body-paragraph iu iv hi iw b ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm jn lc jp jq jr hb bi translated">这就是你如何覆盖原始keras的<strong class="iw hj"> ImageDataGenerator </strong>来为time_distributed层重新使用它。</p><p id="49f5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">完整的代码请看这里</p><div class="lu lv ez fb lw lx"><a href="https://github.com/kivijoshi/TimeDistributedImageDataGenerator/tree/master/TimeDistributedImageDataGenerator" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hj fi z dy mc ea eb md ed ef hh bi translated">kivijoshi/TimeDistributedImageDataGenerator</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">github.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml io lx"/></div></div></a></div><p id="d56c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢阅读！！</p></div></div>    
</body>
</html>