<html>
<head>
<title>Spark Group By And Filter Deep Dive</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火花分组和过滤深潜</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-group-by-and-filter-deep-dive-5326088dec80?source=collection_archive---------3-----------------------#2019-12-01">https://medium.com/analytics-vidhya/spark-group-by-and-filter-deep-dive-5326088dec80?source=collection_archive---------3-----------------------#2019-12-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/14272f3724c98fe94bad60248ae942e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KewKjs1VonJLb_RC"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Jez Timms 在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c3eb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大家好，这是我的火花深度潜水系列的第四篇文章</p><p id="4ab0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是我以前的博客链接，这样你可以从头开始</p><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/@somanathsankaran/spark-select-and-select-expr-deep-dive-d63ef5e04c87"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">火花选择和选择表达式深潜</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">这是我在深度阅读csv之后的第三篇spark深度阅读系列文章</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk io jw"/></div></div></a></div><p id="c2c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">分组和筛选是数据分析师的重要组成部分之一</p><p id="0fa5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">过滤器对于减少spark扫描的数据非常有用，尤其是当我们有分区列时</p><p id="fc03" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们要处理的这个帖子</p><ol class=""><li id="7bb0" class="kl km hi ix b iy iz jc jd jg kn jk ko jo kp js kq kr ks kt bi translated">单列分组依据</li><li id="282d" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">多列分组依据</li><li id="c827" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">按聚集组合分组的高级算术函数</li><li id="b3b9" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">带有日期字段的分组依据</li><li id="9352" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">收集列表和收集集</li><li id="e700" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">基于单个列的过滤器</li><li id="7c1e" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">基于多列的过滤器</li><li id="51b0" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">使用类似Sql的表达式过滤</li><li id="7f22" class="kl km hi ix b iy ku jc kv jg kw jk kx jo ky js kq kr ks kt bi translated">给熊猫用户的提示</li></ol><p id="3188" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第一步:创建输入数据</strong></p><p id="4615" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将使用spark.read.csv来读取输入数据(关于从csv源加载数据的详细信息，请参考我以前的帖子)</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/7dfb698da64def6ab82ac85ef10d6e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SbKc8xLn-56mOImO53hjRw.png"/></div></div></figure><p id="96ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第二步:基于单列的分组依据</strong></p><p id="b9bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Group by可以很容易地与单个列一起使用，我们可以使用pandas样式将列名分组为string或spark列，并调用count()，如下所示</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es le"><img src="../Images/ef3d45c83d7d8fc8d703fd9f2b998d50.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*hT4f-rgscoK7dgpLHPi46Q.png"/></div></figure><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/04ca09b447d0059fa913851281f0b1d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*VbE3oZv_Xh9Ggssv1BS98w.png"/></div></figure><p id="52af" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它还可以与min、max等聚合函数一起使用，如下所示</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/8cce3bff3906ecd86a012070cb12c5c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K7K4PkmJcezP9Xtd514qXA.png"/></div></div></figure><p id="7f5b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是问题是因为我们没有定义模式，所有的列都作为字符串加载，所以spark抱怨它不是一个数字列，尽管实际上它是，所以我们应该在指定或定义模式时使用cast</p><p id="40dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用模式加载Df</p><p id="ffd4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我正在加载提供数据库风格的模式，如下所示</p><p id="b393" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里的新东西是我们可以使用<strong class="ix hj">反勾(`)来转义列名</strong>中的空格，就像“兄弟姐妹/配偶在船上”一样</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/8f153e2fd0563826fa921be8bceb2cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QEey-emkd_4M2acpv9UuMA.png"/></div></div></figure><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/87157829488fd105a756e89516fb0e6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JzGCu-d2b8-mBwp-54FWMw.png"/></div></div></figure><p id="4daf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们可以在幸存者中找到最大年龄</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lj"><img src="../Images/51a305d9f5a19e9aea9f5dd5f4a1e7a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*zXZTynHgvapysl4pr76YYg.png"/></div></figure><p id="8ac1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第三步:多列分组依据</strong></p><p id="5696" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以传递string或f.col sysntax的列列表</p><p id="b9b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设我们想找出男性和女性死亡和幸存的最小年龄，这可以按如下方式实现</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lk"><img src="../Images/b3a51a7ac742411c757bc1187115bde4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*edxqatkc9OTtIaiBOPuLEg.png"/></div></figure><p id="4a2a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">步骤3:按聚集组合分组的高级算术函数</strong></p><p id="81da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个常见的用例是按特定的列分组，并使用diff聚合函数，比如按年龄分组，然后在单个查询中查找最大年龄最小费用等</p><p id="17ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">带字典的聚集</strong></p><p id="e17c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这可以通过使用agg函数，然后传递列和要应用的函数来实现(例如，Min，Max作为python字典，如下所示)</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/1d0cfe48973e17a2e51bf0e630738ab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eCvggT9af_yGJUoI9F9YQ.png"/></div></div></figure><p id="8ea5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">多列聚集</strong></p><p id="c006" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们也可以对多列使用相同的方法，例如按2列分组并有一个计数(*)</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lm"><img src="../Images/4f669cc103b1138a75958c91819e7359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*00WvOIjVmdeXJ_u13AMDyg.png"/></div></figure><p id="8824" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Agg附名单:</strong></p><p id="571b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因为Agg接受列表达式，所以我们可以定义列表中所有列，我们可以使用*list语法来解包并作为每个元素发送</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/fe6713985d6608b9694908797521e04b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MUWBOpCeI3t8nGlTe9SrBA.png"/></div></div></figure><p id="4995" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第四步:带日期字段的分组依据</strong></p><p id="3e96" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个常见的用例是通过使用pyspark.sql.functions模块中的month，year函数将日期字段按月、年分组</p><p id="6256" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将当前日期添加到现有字段，创建新的DF并检查日期类型</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/622077cc0cb8e9ee259a5cc2b6c6ac22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*lDJUZIxwFvgtZxNyJcAX4Q.png"/></div></figure><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/b8bb887c2372c054550eeee2be124af3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*C0U5Vx3xyKQA7pJZLzfx7A.png"/></div></figure><p id="785d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果date_string是YYYY-MM-dd格式，它也可以处理字符串日期字段</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/4445f4bae01c69df16fadfed25f47805.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X7Heol3n2gG2E0R6kKmdUQ.png"/></div></div></figure><p id="fd84" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第五步:收藏列表和收藏集</strong></p><p id="5928" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们想在分组后查看数据而不是聚合(count(*)或count_distinct ),这些函数会非常有用</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lr"><img src="../Images/8aeb7a9ad0b73ff0ad8f99e51dea28d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*_hA6H2qscBDCUFOH8mwOww.png"/></div></figure><p id="fe93" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">收集列表包含所有元素，而收集集没有重复项，如下所示</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es ls"><img src="../Images/2149b6764b83aea6b0e1879dfdce8636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*fOU-MdW_WKmcz3iI_7Y6DQ.png"/></div></figure><p id="e83a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第六步:基于单列的过滤</strong></p><p id="6119" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可以通过使用string和f.col来完成过滤</p><p id="d920" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用字符串过滤</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/8377bda6def71351f6ec02e7cb25e063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w7p01UvU_WyTM05zkAEhyw.png"/></div></div></figure><p id="0c73" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">带列过滤器</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/4ca15daee2a2f641a909e21c9972b3c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6om_H8VZh5aCPdJ24V1Cw.png"/></div></div></figure><p id="f06c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第七步:基于多列的过滤</strong></p><p id="d76a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用字符串形式的and或&amp; symbol "| "符号来基于多个列进行过滤</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/8c3e01e86d6b46cfdc126dec1148449f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O2GQo7YWHNwMECXGK-9hkQ.png"/></div></div></figure><p id="5508" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第八步:过滤Sql Like表达式</strong></p><p id="1cbb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一个常见的用例是使用like进行过滤以匹配模式，</p><p id="69c8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">比方说，我们想要查找名字像John男性，</p><p id="b21d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它可以按如下所示进行组合</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/3eaabe539d46a5c249e1e3719616d174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XORi13AfJ25gZKaNbbDQxw.png"/></div></div></figure><p id="6e21" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第九步:给熊猫用户的提示</strong></p><p id="3fbe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您是熊猫用户，您可以使用链接语法来过滤列，如下所示</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/49f1131fad7283cc14f6ef8a25129ab5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TNlKEOAUGsfwL9K10zGilg.png"/></div></div></figure><p id="2331" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">今天就到这里吧！！:)</p><p id="db6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Github链接:<a class="ae iu" href="https://github.com/SomanathSankaran/spark_medium/tree/master/spark_csv" rel="noopener ugc nofollow" target="_blank">https://github . com/SomanathSankaran/spark _ medium/tree/master/spark _ CSV</a></p><p id="528c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"/></p><p id="d48a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">学习并让别人学习！！</strong></p></div></div>    
</body>
</html>