<html>
<head>
<title>Big Data in Google Cloud — Cost Monitoring (part III)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云中的大数据——成本监控(第三部分)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/big-data-in-google-cloud-cost-monitoring-part-iii-13dd5e9f36ac?source=collection_archive---------22-----------------------#2020-08-15">https://medium.com/analytics-vidhya/big-data-in-google-cloud-cost-monitoring-part-iii-13dd5e9f36ac?source=collection_archive---------22-----------------------#2020-08-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c224" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是三部曲中的第三部曲</p><p id="27fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们最近的两篇帖子<a class="ae jd" rel="noopener" href="/analytics-vidhya/big-data-in-google-cloud-cost-monitoring-da22282f6744">第一部分</a>和<a class="ae jd" rel="noopener" href="/analytics-vidhya/big-data-in-google-cloud-cost-monitoring-part-ii-a78615627af9">第二部分</a>中，我们已经看到了我们如何处理将大数据服务迁移到谷歌云平台(GCP)的成本问题。这是关于我们如何指导我们的内部用户在处理BigQuery (BQ)时在成本方面的良好做法，我们如何使用预算来建立一个基本的警报系统，以及我们如何从计费和云审计日志(CAL)向BQ导入数据。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/e3bf773b84751f09b7f7e230f48314b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ilM1xS9uET5X-tsX3XFmcQ.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jd" href="https://pixabay.com/illustrations/marketing-megaphone-advertisement-3740526/" rel="noopener ugc nofollow" target="_blank">https://pix abay . com/插图/营销-扩音器-广告-3740526/ </a></figcaption></figure><p id="e812" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本帖中，我们将讨论我们当前的状况:</p><p id="f997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个全功能的成本监控系统，它可以指示一些事情，如单个查询超过了某个阈值，或者某一天的成本增加超过了可配置的百分比。</p><h1 id="17db" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">云监控</h1><p id="ac34" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">通过前面提到的帖子中显示的步骤，我们已经奠定了基础，现在我们可以拥有一个成熟的警报系统。虽然听起来很复杂，但主要思想非常非常简单。都是把数据点发送到<a class="ae jd" href="https://cloud.google.com/monitoring" rel="noopener ugc nofollow" target="_blank">云监控</a> (CM)。</p><p id="f623" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以出现的问题是:</p><ul class=""><li id="7a30" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">什么是“数据点”？</li><li id="92e2" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">怎么发给CM？</li><li id="63fb" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">如何设置预警？</li></ul><h2 id="3f49" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">什么是“数据点”？</h2><p id="dd4f" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">根据<a class="ae jd" href="https://www.digitalocean.com/community/tutorials/an-introduction-to-metrics-monitoring-and-alerting" rel="noopener ugc nofollow" target="_blank">数字海洋</a>，</p><blockquote class="lz"><p id="09f2" class="ma mb hi bd mc md me mf mg mh mi jc dx translated">数据点是单个指标的单个测量值。</p></blockquote><p id="21da" class="pw-post-body-paragraph if ig hi ih b ii mj ik il im mk io ip iq ml is it iu mm iw ix iy mn ja jb jc hb bi translated">好吧，这些“数据点”到底是什么意思？</p><p id="19b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们以我们的“<em class="mo">当天最昂贵的查询</em>”策略为例:</p><p id="695b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每天，我们会在BQ中自动运行一次查询，返回开销较大的查询的值，如下所示:</p><blockquote class="lz"><p id="496d" class="ma mb hi bd mc md me mf mg mh mi jc dx translated">SELECT ROUND(MAX(TotalCost)，2) FROM billing.bigquery_usage其中DATE(DATE)= DATE _ SUB(CURRENT _ DATE()，间隔1天)；</p></blockquote><p id="2662" class="pw-post-body-paragraph if ig hi ih b ii mj ik il im mk io ip iq ml is it iu mm iw ix iy mn ja jb jc hb bi translated">这个查询的单一结果将是我们将要发送给CM的“数据点”的值。除了值之外，我们还需要一个时间戳来附加到数据点(在我们的例子中是我们运行查询的时间)。</p><h2 id="6c6f" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">怎么发给CM？</h2><p id="53bc" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">仅举一个例子，我实现了一个简单的Java实用程序类及其客户端，以展示如何将这些数据点发送到云监控。这些可以在我的<a class="ae jd" href="https://github.com/leocampos/blog/tree/master/src/main/java/de/campos/bigdata/monitoring" rel="noopener ugc nofollow" target="_blank"> GitHub账号</a>里找到:</p><div class="mp mq ez fb mr ms"><a href="https://github.com/leocampos/blog/blob/master/src/main/java/de/campos/bigdata/monitoring/MetricSender.java" rel="noopener  ugc nofollow" target="_blank"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">Leo Campos/博客</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">我的中型博客的代码片段。在GitHub上创建一个帐户，为Leo Campos/博客的发展做出贡献。</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">github.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng jo ms"/></div></div></a></div><p id="0759" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，检查MetricSender.java: <br/>我们需要创建一个TimeSeries对象，第50–60行。这个对象将包装我们已经创建的另外两个重要的对象，指标和数据点(在这个例子中，每次运行只有一个数据点)。</p><p id="84cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再根据<a class="ae jd" href="https://www.digitalocean.com/community/tutorials/an-introduction-to-metrics-monitoring-and-alerting" rel="noopener ugc nofollow" target="_blank">数字海洋</a>，</p><blockquote class="lz"><p id="b139" class="ma mb hi bd mc md me mf mg mh mi jc dx translated">时间序列数据是一系列代表时间变化的数据点。大多数指标最好用时间序列来表示，因为单个数据点通常表示特定时间的值，产生的一系列点用于显示一段时间内的变化。</p></blockquote><p id="7445" class="pw-post-body-paragraph if ig hi ih b ii mj ik il im mk io ip iq ml is it iu mm iw ix iy mn ja jb jc hb bi translated">创建了时间序列后，我们可以创建一个请求(CreateTimeSeriesRequest ),最后使用客户机(MetricServiceClient)将它发送给CM。</p><p id="7dc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的代码可以发送“数据点”之前，您的服务帐户应该具有“监控指标写入者”角色。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nh"><img src="../Images/a70a8b561cc23be624c902f3a6fb954f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/0*zX3nMHqeC3EV5oz2"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">将数据点发送到云监控所需的角色</figcaption></figure><h2 id="021d" class="ll jv hi bd jw lm ln lo ka lp lq lr ke iq ls lt ki iu lu lv km iy lw lx kq ly bi translated">如何设置预警？</h2><p id="a87c" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">1.转到监控&gt;概述</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ni"><img src="../Images/2fe7009c0064bc39fa8ea15f24ead46f.png" data-original-src="https://miro.medium.com/v2/resize:fit:756/format:webp/1*ite26Va7j5gPMhGo_tMaKA.png"/></div></figure><p id="76fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这是您第一次使用CM，您可能需要等待一段时间来创建工作空间，如下图所示。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nj"><img src="../Images/be31298f3cb6015e241dd6beaab7605e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*jXhDiNoo6XxZdGvR1DXTdg.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">工作区的创建</figcaption></figure><p id="4f4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.检查您的指标</p><p id="8262" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦工作空间准备就绪，最好的第一步就是查看您的数据。</p><p id="5dbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到度量浏览器。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nk"><img src="../Images/676b49f852cd6d1190647e9db0d85000.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/0*CZhPqWXxTalFhFHH"/></div></figure><p id="1f37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于<em class="mo">度量</em>，键入您选择的度量的名称，在我们的示例中，它是“custom . Google APIs . com/big query/my-Metric-name”，对于<em class="mo">资源类型</em>，键入“Generic Node”。</p><p id="9c9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我用不同的“数据点”值和不同的标签测试得到的结果。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nl"><img src="../Images/2b3f9f20a570a923e76a6c5777915a84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c3_lN6vUd1z0jaoK"/></div></div></figure><p id="3ce7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦数据点在CM中，并且您已经掌握了它们，就只需要使用工具本身来创建警报，在我们的例子中，它会写入一个slack通道。</p><p id="acc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.创建通知渠道</p><p id="ba94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您还没有配置任何“通知通道”，那么这应该是您的第一个任务:</p><p id="b2fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到“报警”</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nm"><img src="../Images/c95cb0373fb23b755c3bcc68b62d72b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:502/format:webp/1*afqnTLrTTFhgcxH-vzI_cw.png"/></div></figure><p id="0984" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在最上方，点击“编辑通知渠道”</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nn"><img src="../Images/f2600669674e96f9dee943a547a0ffb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/0*VIU07oaPl975osWW"/></div></figure><p id="15db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到一个包含几种不同类型频道的页面。因为我们使用电子邮件和Slack，所以我们把重点放在它们上面。</p><p id="a43e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">配置邮件为通知渠道:</strong></p><p id="c0a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要添加电子邮件，点击“添加新的”，弹出一个与被显示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es no"><img src="../Images/ff5fa6ce1ab498053e85b2c5e561935e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xGDddLTGN57iYVbKnyYzMQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">电子邮件列表</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es np"><img src="../Images/aa52b4c60d4f59d205d7179c5b1349a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*0mvq_I87bUKQ35Fglm7bjA.png"/></div></figure><p id="8086" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">填写所需的“电子邮件地址”和“显示名称”，然后单击“保存”。</p><p id="0680" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用于将Slack配置为通知渠道:</strong></p><p id="562a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在松弛部分，点击“新增”</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nq"><img src="../Images/ceae3ea2369de35664d1efebf200c7a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aZN2bBNjL1UNayBUFhfBZA.png"/></div></div></figure><p id="7ab9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将重定向到您自己的备用帐户，并要求许可</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nr"><img src="../Images/d9520a2010210748046a1e3464e271cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/0*NjPavpoC5HcH3hZY"/></div></figure><p id="1625" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击“允许”，填写显示的几个字段，然后就可以了。</p><p id="36c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.创建策略<br/>现在是创建策略的时候了，转到“Alerting ”,单击“Create Policy”按钮。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ns"><img src="../Images/de83c7ede2c0adda4c23bd50632f56bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/0*EapXdllEHLaUhvn6"/></div></figure><p id="9104" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击“添加条件”</p><p id="af13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就像度量浏览器一样</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nt"><img src="../Images/b667295f01cdea69134ff050b1b873d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WRo4uTCZI4ffPEgG"/></div></div></figure><p id="e216" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后配置条件本身</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es nu"><img src="../Images/391ba29a1876e6367f274fb4e0e107c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/0*67PeZRt55945sLhC"/></div></figure><p id="001e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看看可能的配置，它们的含义很容易理解。在本例中，如果该值在至少30分钟内高于200，则将向之前配置的通知通道发送通知。</p><p id="21e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们更昂贵的查询策略的一个例子</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nv"><img src="../Images/576e426442bbd01bcc783cfaf41d44df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*k8SzOm5TjeUp2PRJ"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在空闲时间收到的消息</figcaption></figure></div><div class="ab cl nw nx gp ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="hb hc hd he hf"><p id="cff0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在这篇文章中，我们试图向你展示我们用来创建一个成本监控系统的主要思想。当然，这是一个非常灵活的解决方案，您可以考虑对我们在上一篇文章中收集到的任何数据发出警报。</p><p id="0412" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还跳过了如何从BigQuery中检索数据的部分，因为这不是这一系列帖子的核心，但是如果您在克服这一部分方面有问题，请留下评论，我很乐意帮助您。</p><p id="87d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是关于谷歌云成本监控系列的第三篇也是最后一篇文章。前两个可以找到:</p><p id="cc81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/analytics-vidhya/big-data-in-google-cloud-cost-monitoring-da22282f6744">谷歌云中的大数据—成本监控</a> <br/> <a class="ae jd" rel="noopener" href="/analytics-vidhya/big-data-in-google-cloud-cost-monitoring-part-ii-a78615627af9">谷歌云中的大数据—成本监控(下)</a></p><p id="9a3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有任何问题，意见或建设性的反馈，请在评论中留下。</p></div></div>    
</body>
</html>