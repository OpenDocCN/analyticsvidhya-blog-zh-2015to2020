<html>
<head>
<title>Creating CI/CD Pipeline for AWS ECS — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为 AWS ECS 创建 CI/CD 管道—第二部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/creating-ci-cd-pipeline-for-aws-ecs-part-ii-b43e4089cb52?source=collection_archive---------3-----------------------#2020-09-19">https://medium.com/analytics-vidhya/creating-ci-cd-pipeline-for-aws-ecs-part-ii-b43e4089cb52?source=collection_archive---------3-----------------------#2020-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5440" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程的第 1 部分中，我解释了如何在 AWS ECS 中运行样本节点 js 应用程序。在本教程中，我将解释如何使用 AWS 代码管道创建 CI/CD 管道。</p><p id="b3df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以从我的 GitHub 账号下载<a class="ae jd" href="https://github.com/harshvijaythakkar/node-app" rel="noopener ugc nofollow" target="_blank">源代码</a>。</p><h1 id="ccbf" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">先决条件</h1><ol class=""><li id="b384" class="kc kd hi ih b ii ke im kf iq kg iu kh iy ki jc kj kk kl km bi translated">代码提交存储库</li><li id="024a" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">您应该在您的帐户中创建了<strong class="ih hj"><em class="ks">【VPC】</em></strong>，并带有<strong class="ih hj"> <em class="ks">公共和私有子网</em> </strong>，私有子网应该有一个到<strong class="ih hj"> <em class="ks"> NAT 网关</em> </strong>的路由。</li><li id="e94a" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">AWS ECS 集群与服务运行任务定义(参考:第一部分)</li><li id="b8ee" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">AWS ECR 存储库</li><li id="18ff" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">创建 IAM 角色、策略的权限</li></ol><h1 id="6fc5" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">架构图</h1><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es kt"><img src="../Images/9e610e76373a190c306c48e9a95343c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IdNE6aOEMAw0Bdrz"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS ECS CI/CD</figcaption></figure><h1 id="b63d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">我们开始吧</h1><p id="39c8" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">将您的代码推送到您现有的代码提交存储库中。我们将使用 AWS 代码提交作为代码管道的源阶段。如果你没有，你可以使用我的<a class="ae jd" href="https://github.com/harshvijaythakkar/node-app" rel="noopener ugc nofollow" target="_blank">示例代码</a>。</p><p id="9f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们开始创建我们的管道之前，我们需要在我们代码的根目录下有一个<strong class="ih hj"><em class="ks">build spec . YAML</em></strong>文件。该文件将被<strong class="ih hj"> <em class="ks"> AWS 代码构建</em> </strong>用来构建 docker 映像并将该映像推送到 ECR。将以下命令添加到<strong class="ih hj"><em class="ks">build spec . YAML</em></strong>中，并将其推送到您的代码提交库。</p><p id="5b98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保用您的 AWS ECR 仓库 URL <strong class="ih hj"> <em class="ks"> </em> </strong>和<strong class="ih hj"> <em class="ks">容器名称</em> </strong>值(AWS 任务定义容器名称)替换<strong class="ih hj"> <em class="ks">仓库 _URI </em> </strong>。</p><pre class="ku kv kw kx fd lm ln lo lp aw lq bi"><span id="d2dd" class="lr jf hi ln b fi ls lt l lu lv"># Don't change this version, this version is buildspec.yml file's version</span><span id="8fe8" class="lr jf hi ln b fi lw lt l lu lv">version: 0.2</span><span id="523d" class="lr jf hi ln b fi lw lt l lu lv">phases:<br/>  pre_build:<br/>    commands:<br/>      - echo Logging in to Amazon ECR...<br/>      - aws --version<br/>      - $(aws ecr get-login --region $AWS_DEFAULT_REGION --no-include-email)<br/>      - REPOSITORY_URI=<strong class="ln hj"><em class="ks">&lt;your_ecr_repo_url&gt;</em></strong><br/>      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)<br/>      - IMAGE_TAG=build-$(echo $CODEBUILD_BUILD_ID | awk -F":" '{print $2}')</span><span id="58ce" class="lr jf hi ln b fi lw lt l lu lv">build:<br/>    commands:<br/>      - echo Build started on `date`<br/>      - echo Building the Docker image...<br/>      - docker build -t $REPOSITORY_URI:latest .<br/>      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG</span><span id="8edc" class="lr jf hi ln b fi lw lt l lu lv">post_build:<br/>    commands:<br/>      - echo Build completed on `date`<br/>      - echo Pushing the Docker images...<br/>      - docker push $REPOSITORY_URI:latest<br/>      - docker push $REPOSITORY_URI:$IMAGE_TAG<br/>      - echo Writing image definitions file...<br/>      - printf '[{"name":"<strong class="ln hj"><em class="ks">&lt;Your Container Name&gt;</em></strong>","imageUri":"%s"}]'    $REPOSITORY_URI:$IMAGE_TAG &gt; imagedefinitions.json<br/>      - cat imagedefinitions.json</span><span id="47e4" class="lr jf hi ln b fi lw lt l lu lv">artifacts:<br/>  files: imagedefinitions.json</span></pre><h1 id="d561" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">创建代码管道</h1><p id="a9d9" class="pw-post-body-paragraph if ig hi ih b ii ke ik il im kf io ip iq lj is it iu lk iw ix iy ll ja jb jc hb bi translated">我们的代码管道将有 3 个阶段，即<strong class="ih hj"> <em class="ks">源代码，构建</em> </strong> <em class="ks">和</em> <strong class="ih hj"> <em class="ks">部署。</em>T51】</strong></p><p id="a1e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到 AWS 代码管道页面，并单击创建管道。</p><ol class=""><li id="aca1" class="kc kd hi ih b ii ij im in iq lx iu ly iy lz jc kj kk kl km bi translated">输入管道名称并保留服务角色的默认值，然后单击下一步</li></ol><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ma"><img src="../Images/fb2db09db3e8f4213fc8c7fdcd5082ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BLkmaxMz2HMCzUx6"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码管道</figcaption></figure><p id="effb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.选择 AWS 代码提交作为源提供者。选择您的代码提交库和分支名称。转到添加构建阶段。</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mb"><img src="../Images/9f91aa8da0b5ca9440641c6e0aad0b2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m8pv7u-ZksX9IrZq"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码管道源</figcaption></figure><p id="2f5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.在构建提供者中选择<strong class="ih hj"> <em class="ks"> AWS CodeBuild </em> </strong>。我们需要有一个 CodePipeline 的 CodeBuild 项目，它将创建 Docker 图像并将其推送到我们的 ECR 存储库。单击项目名称下的创建项目，将弹出一个新窗口。写下项目名称并输入如下所示的配置。</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mc"><img src="../Images/e51ebbb334e3f15056911f12c5b47bfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JkFrXKpvIfyVmog5"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码构建环境配置</figcaption></figure><blockquote class="md me mf"><p id="8820" class="if ig ks ih b ii ij ik il im in io ip mg ir is it mh iv iw ix mi iz ja jb jc hb bi translated">确保选中<strong class="ih hj">特权</strong>复选框。这将允许代码构建器构建 Docker 映像。</p></blockquote><p id="b9f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">保留<strong class="ih hj"> <em class="ks">服务角色</em> </strong>的默认设置，点击<strong class="ih hj"> <em class="ks">附加配置</em> </strong>。向下滚动并选择在其中创建 AWS ECS 群集的 VPC，选择专用子网，选择默认安全组。通过单击验证 VPC 设置来验证您的 VPC 设置。</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mj"><img src="../Images/aad8f451aa1bfd12b5727c05e232c9e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s1rqucHle7aR5qwx"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码构建 VPC 配置</figcaption></figure><p id="6931" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">向下滚动到构建等级库并添加构建等级库文件名。我的文件名是<strong class="ih hj"><em class="ks">“build spec . YAML”</em></strong></p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mk"><img src="../Images/6bdf2580563348b30f4f7a09a354b6c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j1Fdh8eaKJ2dfXbp"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码构建构建规范文件配置</figcaption></figure><p id="9596" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让一切保持默认，并点击继续编码管道。您的代码生成项目名称出现在项目名称部分。转到添加部署阶段。</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ml"><img src="../Images/4ec76ed55f254bd6c1b63c5423b23f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hEjpjOTNOBbjQsx1"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码管道构建阶段</figcaption></figure><p id="699a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.选择<strong class="ih hj"> <em class="ks"> Amazon ECS </em> </strong>作为部署提供者。选择您的 ECS 群集名称和服务名称。在图像定义文件字段中输入<strong class="ih hj"><em class="ks">" Image definitions . JSON "</em></strong>。这个文件是来自我们代码构建的工件(输出),它包括关于我们的 ECR 图像位置和我们的任务定义中的容器名称的信息。</p><blockquote class="md me mf"><p id="6c36" class="if ig ks ih b ii ij ik il im in io ip mg ir is it mh iv iw ix mi iz ja jb jc hb bi translated">确保在图像定义文件字段中写入的文件名与在工件块中的 buildspec.yaml 文件中写入的文件名相同。</p></blockquote><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mm"><img src="../Images/543bbcc02ada279cb2ae4d0fafc122d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S569dEz42SE75S8G"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx translated">AWS 代码管道部署阶段</figcaption></figure><p id="7139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查您的代码管道，然后单击创建管道。</p><blockquote class="md me mf"><p id="3f92" class="if ig ks ih b ii ij ik il im in io ip mg ir is it mh iv iw ix mi iz ja jb jc hb bi translated">单击“创建管道”按钮后，它将开始执行，并将在构建阶段失败。这背后的原因是因为我们默认的 CodeBuild 项目角色没有将图像推送到 ECR 的权限。</p></blockquote><h1 id="3823" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">更新代码生成项目 IAM 角色:</h1><ol class=""><li id="c007" class="kc kd hi ih b ii ke im kf iq kg iu kh iy ki jc kj kk kl km bi translated">转到 IAM 控制台，找到由您的 codebuild 项目创建的 IAM 角色</li><li id="6d14" class="kc kd hi ih b ii kn im ko iq kp iu kq iy kr jc kj kk kl km bi translated">向 ECR 完全访问添加权限(amazone C2 containerregistrytryfull access 策略)</li></ol><p id="75c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成 IAM 角色更新后，请在代码管道的构建阶段单击“重试”。</p><p id="d5e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">恭喜！</strong>您已经成功创建了 CI/CD 管道，该管道会将您的应用程序自动部署到 AWS ECS 集群。</p><p id="6d41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢大家！</p></div></div>    
</body>
</html>