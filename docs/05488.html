<html>
<head>
<title>Why use Avro data format with Apache Kafka?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么Apache Kafka要用Avro数据格式？</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/why-use-avro-data-format-with-apache-kafka-85ff15044ca5?source=collection_archive---------33-----------------------#2020-04-22">https://medium.com/analytics-vidhya/why-use-avro-data-format-with-apache-kafka-85ff15044ca5?source=collection_archive---------33-----------------------#2020-04-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/0e792ad2674b8b4f826aa648e5f6c2bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/0*deZgrJJmRVQqO_mh"/></div><figcaption class="im in et er es io ip bd b be z dx translated"><em class="iq">图片来源:</em> <a class="ae ir" href="https://unsplash.com/@markusspiske" rel="noopener ugc nofollow" target="_blank"> <em class="iq">马库斯·斯皮斯克</em> </a></figcaption></figure><p id="28c9" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">Avro是一种开源的二进制序列化格式。但是为什么要和卡夫卡一起用呢？为什么不发送JSON或XML消息？它给了我们什么好处？这就是我们今天要探索的。</p><h1 id="9116" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">序列化</h1><p id="dcba" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">理解主题中的记录只是字节数组是很重要的。Kafka broker不关心我们发送的数据类型。为了使这些字节数组在我们的应用程序中有用，生产者和消费者必须知道如何解释它们。我们发送的是CSV数据还是JSON或XML？生产者和消费者使用序列化(反序列化)将数据转换为字节数组，然后再转换回来。然而，这仅仅是开始。</p><h1 id="3064" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">(计划或理论的)纲要</h1><p id="8682" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">每当我们使用数据作为集成机制时，数据的模式就变得非常重要，因为它成为生产者和消费者之间的契约。生产者和消费者背后的团队需要在以下方面达成一致:</p><ul class=""><li id="7d05" class="kt ku hi iu b iv iw iz ja jd kv jh kw jl kx jp ky kz la lb bi translated">记录中有哪些字段</li><li id="0899" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">哪些字段是可选的，哪些是必填的</li><li id="0e3b" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">这应该在哪里以及如何记录</li><li id="1c86" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">消费者应该为记录中缺少的字段使用哪些默认值</li><li id="7480" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">应该如何处理对模式的更改</li></ul><h1 id="945d" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">数据格式</h1><p id="d031" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">现在，您可以通过JSON模式使用JSON，或者通过XSD模式使用XML来描述消息格式。但是这样做有一个缺点:由于JSON和XML的性质，这些格式的消息通常使用更多的空间来传递相同的信息。</p><h1 id="7144" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">那么有没有更好的办法呢？</h1><p id="4805" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">是的。你可以用阿帕奇Avro。Avro是在Apache框架下开发的一种数据序列化格式，建议由Apache Kafka的创建者自己用于Kafka消息。为什么？</p><p id="87cf" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">通过以Avro格式序列化数据，您可以获得以下好处:</p><ul class=""><li id="2c83" class="kt ku hi iu b iv iw iz ja jd kv jh kw jl kx jp ky kz la lb bi translated">Avro依赖于一个模式。这意味着每个字段都被适当地描述和记录</li><li id="195e" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">Avro数据格式是一种紧凑的二进制格式，因此它在线路和磁盘上都占用较少的空间</li><li id="f72b" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">它支持多种编程语言</li><li id="2f9e" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">在Avro中，每个消息都包含用于序列化它的模式。这意味着当您读取消息时，您总是知道如何反序列化它们，即使模式已经改变</li></ul><p id="90a0" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">然而，有一件事使Avro不适合在Kafka中使用，至少不是开箱即用的，因为…</p><p id="64bb" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated"><strong class="iu hj">每个Avro消息包含用于序列化消息的模式</strong></p><p id="e649" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">请想一想:如果您计划每天向Kafka发送数百万条消息，那么一遍又一遍地发送相同的模式信息是对带宽和存储空间的极大浪费。</p><p id="74ba" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">所以，克服这一点的方法是…</p><h1 id="f289" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">将模式与消息分开</h1><p id="0935" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">这就是模式注册中心发挥作用的地方。Schema Registry是由Apache Kafka背后的公司Confluent开发的，它提供了一个RESTful接口来存储和接收Avro模式。</p><p id="3b0c" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">生产者不是在Kafka记录中发送模式，而是先检查模式是否已经存在于模式注册中心。如果没有，它将在那里写入模式(下面的步骤1)。然后，生产者将获得模式的id(步骤2)，并将该id发送到记录中(步骤3)，这样可以节省大量空间。消费者将读取消息(步骤4)，然后使用记录中的模式id联系模式注册中心，以获取完整的模式(步骤5)并在本地缓存它。</p><figure class="li lj lk ll fd ij er es paragraph-image"><div class="er es lh"><img src="../Images/a1b3c49c1adfd8cf5b61c18143e704df.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/0*4myt_KeX2vfhfZAl"/></div></figure><p id="2aaa" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">好的，看起来不错。但是这并不是Schema Registry发挥作用的唯一地方。让我们看看当你想…</p><h1 id="9bb1" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">发展模式</h1><p id="cd3a" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">想象一下，在发布producer应用程序两年后，您决定更改消息的格式，在您看来，这样做不会破坏兼容性，因此不会影响消费者。现在你有两个选择:</p><ul class=""><li id="f1c3" class="kt ku hi iu b iv iw iz ja jd kv jh kw jl kx jp ky kz la lb bi translated">你可以做一个好人，找到所有的消费者，检查建议的改变是否会影响他们，如果会，请他们改变</li><li id="aa70" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">或者你可以做出改变，等着拿着火把、铲子和耙子的暴徒来找你</li></ul><p id="ff1d" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">假设你选择了避免把你的照片放在每个火车站的下面并有金钱奖励的选项，那么第一个选项的可能结果是什么？</p><p id="209f" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">那些在公司环境中工作过的人知道答案:大量的计划、预算、谈判，有时甚至因为有更紧迫的问题而推迟。让10个或100个消费者来执行升级，然后才能继续对生产者进行更改，这肯定会导致庇护。</p><p id="b3cc" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">Apache Avro和Schema Registry再次伸出援手。Schema Registry允许我们在修改模式时执行验证模式兼容性的规则。如果新消息破坏了模式兼容性，生产者将拒绝编写该消息。</p><p id="67d1" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">通过这种方式，您的用户可以避免有人突然将字段的数据类型从long更改为string，或者删除强制字段。</p><p id="4aff" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">同时，它为您提供了关于允许对模式进行哪些更改的清晰指导。因此，不再需要花费数周或数月的时间来协调更改，只是为了删除邮件中的可选字段。</p><h1 id="062f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">你想更多地了解卡夫卡吗？</h1><p id="f89e" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">我创建了一个卡夫卡迷你课程，你可以完全免费获得。<a class="ae ir" href="https://codingharbour.com/" rel="noopener ugc nofollow" target="_blank">在编码港</a>报名。</p></div><div class="ab cl lm ln gp lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="hb hc hd he hf"><p id="247f" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">【https://codingharbour.com】最初发表于<a class="ae ir" href="https://codingharbour.com/apache-kafka/why-use-avro-data-format-with-apache-kafka/" rel="noopener ugc nofollow" target="_blank"><em class="lt"/></a><em class="lt">。</em></p></div></div>    
</body>
</html>