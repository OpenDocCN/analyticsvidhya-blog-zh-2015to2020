<html>
<head>
<title>Replacing a dead node in Cassandra and surprises</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">替换卡珊德拉和惊喜中的死节点</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/replacing-a-dead-node-in-cassandra-and-surprises-4681287eeddf?source=collection_archive---------4-----------------------#2020-02-27">https://medium.com/analytics-vidhya/replacing-a-dead-node-in-cassandra-and-surprises-4681287eeddf?source=collection_archive---------4-----------------------#2020-02-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="914e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在替换Cassandra集群中的死节点时会出现一些意外。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/6dbe9dfc1dd88da0390d2934a52e9fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H8aCQuMANVp9LuMF.jpg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">抄送:pixabay</figcaption></figure><p id="320a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些意外的各种原因描述如下:</p><p id="b9e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题1: </strong>由于节点故障，如果集群的其余部分重新启动，则无法替换。</p><p id="55f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设集群中有3个节点:节点1、节点2和节点3。你的node3崩溃了，你想按照<a class="ae jt" href="https://docs.datastax.com/en/archived/cassandra/3.0/cassandra/operations/opsReplaceNode.html" rel="noopener ugc nofollow" target="_blank">文档</a>中描述的标准流程用全新的节点node3_replace替换node3。</p><p id="0764" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，您仔细遵循了每个步骤，并更新了node3_replace的cassandra-env.sh</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="e186" class="jz ka hi jv b fi kb kc l kd ke">JVM\_OPTS="$JVM\_OPTS -Dcassandra.replace_address=&lt;address of dead node node3&gt;</span></pre><p id="a159" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">启动ndoe3_replace节点。</p><p id="3ce8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在这一点上，你会得到你的第一个惊喜，在节点1和节点2在节点3失败后以某种方式重新启动的情况下，出现了下面的异常。</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="e5a2" class="jz ka hi jv b fi kb kc l kd ke">ERROR \[main\] 2017-11-15 13:57:59,043 CassandraDaemon.java:583 - Exception encountered during startup<br/>java.lang.RuntimeException: Cannot replace_address /&lt;node3 ip&gt; because it doesn't exist in gossip</span></pre><p id="5650" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题2 : </strong>无法替换as在解决上述问题1时，您忽略了提供的解决方案中的一个词。</p><p id="2eab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的node3_replace节点无法启动，您感到困惑。所以你谷歌了一下，在Stackoverflow <a class="ae jt" href="https://stackoverflow.com/questions/23982191/cant-replace-dead-cassandra-node-because-it-doesnt-exist-in-gossip" rel="noopener ugc nofollow" target="_blank"> link </a>上找到了一个很好的解决方案。此链接解释了集群丢失死节点3的八卦信息的原因，并建议了一个3步解决方案:</p><ol class=""><li id="7344" class="kf kg hi ih b ii ij im in iq kh iu ki iy kj jc kk kl km kn bi translated">发现故障节点的节点ID(从集群中的另一个节点)节点工具状态| grep DN</li><li id="ddaa" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">并将其从集群中删除:nodetool removenode(节点ID)</li><li id="3e62" class="kf kg hi ih b ii ko im kp iq kq iu kr iy ks jc kk kl km kn bi translated">现在，您可以清除故障节点的数据目录，并将其作为一个全新的节点进行引导。</li></ol><p id="733f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以你很快就按照上面的步骤做了，因为你想尽快解决这个问题，如果你在解决步骤的第3步中忽略了“全新”这个词，你会有另一个惊喜:)</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="fe6e" class="jz ka hi jv b fi kb kc l kd ke">java.lang.RuntimeException: cassandra does not use new-style tokens!</span></pre><p id="21c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你现在越来越困惑，但这次即使花了一些时间，你也找不到任何谈论这个问题的网站，现在你的困惑变成了沮丧。</p><p id="4aa4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">实际上，这里出错的地方是您忘记在node3_replace节点的cassnadra-env.sh中注释掉replace_address。</p><p id="2952" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题3: </strong>问题2 +您所在节点群集中的另一个节点出现故障</p><p id="514e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是问题2的第二个版本，但是这次node1也关闭了，所以您忽略了node1，您对启动node3_replace更感兴趣。</p><p id="06eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是在这里，您会惊讶于在node启动期间遇到的另一个Cassandra异常</p><pre class="je jf jg jh fd ju jv jw jx aw jy bi"><span id="9217" class="jz ka hi jv b fi kb kc l kd ke">java.lang.RuntimeException: A node required to move the data consistently is down (/&lt;node1 ip&gt;). If you wish to move the data from a potentially inconsistent replica, restart the node with -Dcassandra.consistent.rangemovement=false</span></pre><p id="f027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，您没有使用google，因为异常消息很能说明问题。因此，您检查了节点1是否关闭，并启动了节点1，以为这样可以解决问题，但现在您又回到了原因2</p><p id="564f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经验教训:在执行管理步骤时不要忽略一个单词:)</p><p id="e333" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">总结:</strong>替换一个死节点和添加一个全新的节点是有概念上的区别的。在替换中，令牌将被分配给新节点，同时还将进行令牌洗牌。</p><p id="573e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加新节点的管理步骤与replace_address无关(这纯粹是为了替换死节点),不幸的是，如果在添加新节点的过程中添加，cassandra不会忽略这个参数。</p><p id="729d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最后一点:</strong>添加新节点后，不要忘记运行nodetool clean。</p></div></div>    
</body>
</html>