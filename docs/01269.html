<html>
<head>
<title>Train and Serve a ML model using Kubeflow in IBM Cloud Private</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在IBM Cloud Private中使用Kubeflow训练和服务一个ML模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/train-and-serve-a-ml-model-using-kubeflow-in-ibm-cloud-private-ec5b502bd893?source=collection_archive---------14-----------------------#2019-10-11">https://medium.com/analytics-vidhya/train-and-serve-a-ml-model-using-kubeflow-in-ibm-cloud-private-ec5b502bd893?source=collection_archive---------14-----------------------#2019-10-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="863f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kubeflow被称为“Kubernetes的机器学习工具包”。这是一个开源项目，致力于使Kubernetes上的机器学习(ML)工作流的部署简单、可移植和可扩展。</p><p id="dde9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IBM Cloud Private是一个开发和管理本地容器化应用程序的平台。</p><p id="1afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MNIST数据库(改进的国家标准和技术研究所数据库)是大型手写数字数据库之一。它通常用于机器学习培训和测试目的。</p><p id="f88c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我将说明如何使用IBM Cloud Private中的Kubeflow，基于GitHub示例为MNIST数据库训练和提供ML模型。</p><p id="f958" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将涵盖以下主题:</p><ul class=""><li id="885b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">先决条件</li><li id="5996" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在IBM Cloud Private上启用负载平衡器服务</li><li id="4105" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">为示例应用程序创建PV和PVC</li><li id="97aa" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">源的编译</li><li id="4860" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">上传到Kubeflow中央仪表板并测试</li></ul><h1 id="38d2" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">先决条件</h1><p id="b459" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Kubeflow安装在Ubuntu机器的IBM Cloud Private中。如果你还没有这样做，请阅读我的另一篇文章。</p><p id="9888" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我在单节点Ubuntu机器上使用IBM Cloud Private Community Edition</p><h1 id="88aa" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在IBM Cloud Private上启用负载平衡器服务</h1><p id="0bd5" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">如果您已经在IBM Cloud Private上启用了LoadBalancer服务，则不需要这样做。</p><p id="db08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，IBM Cloud Private不提供对负载平衡器服务的内置支持。为了在IBM Cloud Private上启用LoadBalancer服务，我将LoadBalancer服务与MetalLB一起使用(第2层模式)。关于其他选项，请参见<a class="ae ku" rel="noopener" href="/ibm-cloud/working-with-loadbalancer-services-on-ibm-cloud-private-26b7f0d22b44">本文</a>。</p><h2 id="254a" class="kv js hi bd jt kw kx ky jx kz la lb kb iq lc ld kf iu le lf kj iy lg lh kn li bi translated">步骤1:安装金属1b</h2><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="581d" class="kv js hi lo b fi ls lt l lu lv">kubectl create clusterrolebinding privileged-metallb-clusterrolebinding \<br/> --clusterrole=ibm-privileged-clusterrole \<br/> --group=system:serviceaccounts:metallb-system</span><span id="061b" class="kv js hi lo b fi lw lt l lu lv">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/metallb.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/metallb.yaml</a></span></pre><p id="9a44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果遇到图像权限问题，请创建一个名为image-policy.yaml的文件，其内容如下:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="24bf" class="kv js hi lo b fi ls lt l lu lv">apiVersion: securityenforcement.admission.cloud.ibm.com/v1beta1<br/>kind: ImagePolicy<br/>metadata:<br/>  name: image-policy<br/>spec:<br/>  repositories:<br/>    - name: docker.io/*<br/>      policy: null<br/>    - name: k8s.gcr.io/*<br/>      policy: null<br/>    - name: gcr.io/*<br/>      policy: null<br/>    - name: ibmcom/*<br/>      policy: null<br/>    - name: quay.io/*<br/>      policy: null</span></pre><p id="af69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后运行以下命令在metallb-system命名空间上创建映像策略，并再次安装metallb。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="2c7a" class="kv js hi lo b fi ls lt l lu lv">kubectl create -n metallb-system -f image-policy.yaml</span><span id="81b3" class="kv js hi lo b fi lw lt l lu lv">kubectl apply -f <a class="ae ku" href="https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/metallb.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/metallb.yaml</a></span></pre><h2 id="7e9a" class="kv js hi bd jt kw kx ky jx kz la lb kb iq lc ld kf iu le lf kj iy lg lh kn li bi translated">步骤2:使用第2层配置MetalLB</h2><p id="49fb" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">继续之前，请验证MetalLB的pod正在运行。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="4a7d" class="kv js hi lo b fi ls lt l lu lv">kubectl -n metallb-system get pod<br/>NAME                        READY     STATUS    RESTARTS   AGE controller-9c57dbd4-sh2ms   1/1       Running   0          1d</span></pre><p id="f9ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后运行以下命令来配置MetalLB(请记住使用实际的IP地址范围):</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="4ac7" class="kv js hi lo b fi ls lt l lu lv">kubectl create -f - &lt;&lt; EOF<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  namespace: metallb-system<br/>  name: config<br/>data:<br/>  config: |<br/>    address-pools:<br/>    - name: default<br/>      protocol: layer2<br/>      addresses:<br/>      -  {IP address range}<br/>EOF</span></pre><h1 id="0922" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">为示例应用程序创建PV和PVC</h1><p id="aa14" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">GitHub中的<a class="ae ku" href="https://github.com/kubeflow/examples/blob/master/pipelines/mnist-pipelines/mnist_pipeline.py" rel="noopener ugc nofollow" target="_blank">示例应用程序</a>最初被编写为在Google云平台中运行。然后，它被修改为在本地运行。为了在我们的单节点集群中运行应用程序，我们需要创建一个持久卷(PV)和一个持久卷声明(PVC)。</p><h2 id="ee99" class="kv js hi bd jt kw kx ky jx kz la lb kb iq lc ld kf iu le lf kj iy lg lh kn li bi translated">步骤1:创建一个PV</h2><p id="b1a3" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">创建一个名为jane-pv.yaml(或者您喜欢的任何名称)的YAML文件，包含以下内容:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="977c" class="kv js hi lo b fi ls lt l lu lv">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: jane-pv-volume<br/>  labels:<br/>    type: local<br/>spec:<br/>  storageClassName: manual<br/>  capacity:<br/>    storage: 10Gi<br/>accessModes:<br/>  - ReadWriteMany<br/>hostPath:<br/>  path: "/mnt/data"</span></pre><p id="c777" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行以下命令来创建PV:</p><p id="d9b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lx ly lz lo b">kubectl apply -f jane-pv.yaml -n kubeflow</code></p><h2 id="c0bf" class="kv js hi bd jt kw kx ky jx kz la lb kb iq lc ld kf iu le lf kj iy lg lh kn li bi translated">步骤2:创建PVC</h2><p id="7bcc" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">创建一个名为jane-pv-claim.yaml(或您喜欢的任何名称)的YAML文件，包含以下内容:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="1aa1" class="kv js hi lo b fi ls lt l lu lv">apiVersion: v1<br/>kind: PersistentVolumeClaim<br/>metadata:<br/>  name: jane-pv-claim<br/>spec:<br/>  storageClassName: manual<br/>  accessModes:<br/>    - ReadWriteMany<br/>  resources:<br/>    requests:<br/>      storage: 3Gi</span></pre><p id="d55c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后运行以下命令创建PVC:</p><p id="5703" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lx ly lz lo b">kubectl apply -f jane-pv-claim.yaml -n kubeflow</code></p><p id="b01a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，运行以下命令来检查我们创建的PV的状态:</p><p id="3df0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lx ly lz lo b">kubectl get pv jane-pv-volume -n kubeflow</code></p><p id="8a66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你应该看到一个“<code class="du lx ly lz lo b">Bound</code>状态是这样的:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="25c9" class="kv js hi lo b fi ls lt l lu lv">NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                    STORAGECLASS   REASON    AGE</span><span id="4b05" class="kv js hi lo b fi lw lt l lu lv">jane-pv-volume   10Gi       RWX            Retain           Bound     kubeflow/jane-pv-claim   manual                   3d</span></pre><h1 id="fba4" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">源的编译</h1><p id="6871" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我创建了一个名为/root/src的目录来克隆GitHub中的示例。你可以使用任何你喜欢的目录。在编译该示例之前，请确保您已经按照这里或Kubeflow官方网站中的<a class="ae ku" rel="noopener" href="/@janeman98/ibm-cloud-private-community-edition-for-kubeflow-for-beginners-697a044522a">设置了编译环境。</a></p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="9923" class="kv js hi lo b fi ls lt l lu lv">git clone https://github.com/kubeflow/examples.git</span><span id="9d33" class="kv js hi lo b fi lw lt l lu lv">cd /root/src/examples/pipelines/mnist-pipelines</span><span id="6883" class="kv js hi lo b fi lw lt l lu lv">conda activate mlpipeline</span><span id="78c1" class="kv js hi lo b fi lw lt l lu lv">pip install -r requirements.txt –upgrade</span><span id="2f87" class="kv js hi lo b fi lw lt l lu lv">sed -i.sedbak s"/platform = 'GCP'/platform = 'onprem'/"  mnist_pipeline.py</span><span id="a7c9" class="kv js hi lo b fi lw lt l lu lv">python3 mnist_pipeline.py</span></pre><p id="24de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编译完成后，在<code class="du lx ly lz lo b">/root/src/examples/pipelines/mnist-pipelines</code>目录下会创建一个名为<code class="du lx ly lz lo b">mnist_pipeline.py.tar.gz</code>的文件。</p><h1 id="f7f5" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">上传到Kubeflow中央仪表板并测试</h1><p id="3ce3" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">您可以按照此处<a class="ae ku" rel="noopener" href="/@janeman98/ibm-cloud-private-community-edition-for-kubeflow-for-beginners-697a044522a">的说明</a>上传您的应用程序，创建一个实验并运行。请输入以下运行参数(其他参数使用默认值)。</p><ul class=""><li id="eb12" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">在“模型-导出-目录”下:<code class="du lx ly lz lo b">/mnt/export</code></li><li id="f48f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在“pvc名称”下:<code class="du lx ly lz lo b">jane-pv-claim</code></li></ul><figure class="lj lk ll lm fd mb er es paragraph-image"><div class="er es ma"><img src="../Images/efd3bf825101b2d406faca6528f61f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*mRxZwwtiOgv4cd26wJ5zAQ.png"/></div></figure><p id="3e51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于一次成功的运行，您应该看到如下内容:</p><figure class="lj lk ll lm fd mb er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es me"><img src="../Images/98173a9e4187233651b188a6464a5f03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mWi9dUte4SisdtAZC8VWGw.png"/></div></div></figure><p id="d98a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae ku" href="https://github.com/kubeflow/examples/blob/master/pipelines/mnist-pipelines/mnist_pipeline.py" rel="noopener ugc nofollow" target="_blank">源文件</a>中，示例应用程序启动3个容器来训练模型、服务模型和测试模型。示例应用的完整描述可在<a class="ae ku" href="https://github.com/kubeflow/examples/tree/master/pipelines/mnist-pipelines." rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="7c13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管道成功运行后，您可以通过运行以下命令找到web-ui的url:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="ffdc" class="kv js hi lo b fi ls lt l lu lv">kubectl get svc web-ui -n kubeflow</span><span id="6950" class="kv js hi lo b fi lw lt l lu lv">NAME      TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><span id="575b" class="kv js hi lo b fi lw lt l lu lv">web-ui    LoadBalancer   10.0.0.50    x.xx.xxx.xx   80:30096/TCP   23h</span></pre><p id="b827" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">web-ui在<a class="ae ku" href="http://x.xx.xxx.xx:30096/" rel="noopener ugc nofollow" target="_blank">http://x.xx.xxx.xx:30096/</a></p><figure class="lj lk ll lm fd mb er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es mj"><img src="../Images/c6225894a29427d08c284273867233d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vox7C4tGEix-DCbrJUth0g.png"/></div></div></figure><p id="5708" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你可以用不同的输入(手写数字)来玩/测试你的模型。</p><h1 id="ed44" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">摘要</h1><p id="aa9e" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在本教程中，我展示了如何使用IBM Cloud Private中的Kubeflow，基于GitHub示例为MNIST数据库训练和服务ML模型。如您所见，Kubeflow管道确实使这一过程变得简单易行。我希望你喜欢阅读本教程，并开始尝试。</p><h1 id="884d" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">确认</h1><p id="d25c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">非常感谢何对ICP中负载均衡器的帮助。</p></div></div>    
</body>
</html>