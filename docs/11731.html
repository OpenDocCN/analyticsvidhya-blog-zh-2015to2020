<html>
<head>
<title>Connect Node.js with H2 database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Node.js与H2数据库连接</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/use-node-js-with-h2-database-4154887e121f?source=collection_archive---------8-----------------------#2020-12-16">https://medium.com/analytics-vidhya/use-node-js-with-h2-database-4154887e121f?source=collection_archive---------8-----------------------#2020-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/93121ee726271d309aff6403a9d7c587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5cR55yscdnXfce6X.jpg"/></div></div></figure><p id="aafa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo">tldr:</em>下面的“解决方案”部分</p><h1 id="510f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">动机</h1><p id="6b6c" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">与我合作的Java编程团队正在使用H2数据库，因为它非常适合Java(嵌入式，Java速度快，整个数据库可以作为一个简单的文件轻松迁移)。他们必须使用存储在H2数据库中的数据来完成一项任务，但是他们还有其他几项同样重要的任务，所以他们需要一些额外的人手。</p><p id="3439" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我专攻Javascript技术(React，Node.js)，很久以前就接触过Java，但并不广泛。因此，我们决定另一项任务将在Node.js中完成，他们将H2数据库文件和任务的详细描述交给了我。</p><p id="03e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当时我意识到，这甚至都不能保证是可能的。所以我决定我的第一步应该是用这个H2数据库文件连接Node.js应用程序。如果这是不可能的，我们需要去寻找一些替代方案。</p><p id="89e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">幸运的是，随着更流行的<em class="jo">嵌入式模式</em>的运行，H2也提供了<em class="jo">客户机-服务器模式</em>。因此，我可以使用一个单独的数据库客户机，通过TCP/IP使用JDBC与H2数据库服务器通信。比嵌入式解决方案稍慢，但它是可行的。现在，如果Node.js没有一个用于JDBC通信的库，我就完了。幸运的是，Node.js正好有一个JDBC包装器库，你只需要安装Java，从官方页面下载H2驱动源代码，把它构建到。jar文件，并按照JDBC包装库主页上的描述设置代码。并设置Java驱动的H2数据库服务器。</p><p id="9721" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">总的来说，一天后我确实设法完成了整个流程。Yaaay:)。</p><p id="4da8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Node.js JDBC包装器库的开发体验很差(没有Promise支持，没有Typescript支持，缺少文档，社区很小)。此外，我不想用Java、数据库客户机驱动程序和H2数据库服务器来膨胀我的PC。一定有更好的，更模块化的方法。</p><p id="f50c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">又过了一天，我找到了理想的装置。H2数据库服务器肯定需要Java，所以我决定把它放在Docker容器中。我发现这个不错的码头图片<a class="ae ks" href="https://hub.docker.com/r/oscarfonts/h2" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/oscarfonts/h2</a>，但我将不得不修改它一点。H2数据库服务器，除了JDBC协议还支持Postgresql协议。它是默认启用的，或者带有以下标志:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="1808" class="lc jq hi ky b fi ld le l lf lg">-pg -pgAllowOthers -pgPort &lt;PORT&gt;</span></pre><p id="7caf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不幸的是，链接的docker映像被配置为不启动这个Postgres接口。所以我修改了它，创建了我自己的映像，我还将H2数据库服务器更新到了最新版本。下面是更新后的图片:<a class="ae ks" href="https://hub.docker.com/repository/docker/croraf/h2-postgresql-server" rel="noopener ugc nofollow" target="_blank">https://hub . docker . com/repository/docker/croraf/H2-PostgreSQL-server</a></p><h1 id="07c3" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">解决方案</h1><p id="078a" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">提取图像，创建Docker容器并启动它:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="fb5c" class="lc jq hi ky b fi ld le l lf lg">$ docker pull <!-- -->croraf/h2-postgresql-server:1.0</span><span id="6f78" class="lc jq hi ky b fi lh le l lf lg">$ <!-- -->docker create -p 1521:1521 -p 81:81 -v /path/to/local/data_dir:/opt/h2-data --name=<!-- -->H2dbWithPostgres<!-- --> croraf/h2-postgresql-server:1.0</span><span id="f6de" class="lc jq hi ky b fi lh le l lf lg">$ docker start H2dbWithPostgres</span></pre><p id="b2d4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这也将主机中的文件夹<code class="du li lj lk ky b">/path/to/local/data_dir</code>绑定到容器中的文件夹<code class="du li lj lk ky b">/opt/h2-data</code>。在图像中，<code class="du li lj lk ky b">/opt/h2-data</code>被配置为H2数据库服务器保存数据库的文件夹。所以，要使用<code class="du li lj lk ky b">mydatabase.mv.db</code>数据库文件只需将它放入<code class="du li lj lk ky b">/path/to/local/data_dir</code>主机上即可。</p><p id="32e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们可以在Node.js应用程序中使用流行、简单且实用的Postgres客户端库<a class="ae ks" href="https://www.npmjs.com/package/pg" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/pg</a>。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="589f" class="lc jq hi ky b fi ld le l lf lg">import { Client } from 'pg';</span><span id="eaa5" class="lc jq hi ky b fi lh le l lf lg">const client = new Client({<br/>  user: 'sa',<br/>  host: 'localhost',<br/>  database: 'mydatabase',<br/>  password: '',<br/>  port: 1521,<br/>});</span><span id="b159" class="lc jq hi ky b fi lh le l lf lg">const run = async () =&gt; {<br/>  try {<br/>    await client.connect();<br/>    console.log('connected');</span><span id="c3f2" class="lc jq hi ky b fi lh le l lf lg">    const res = await client.query('SELECT * FROM my_table');<br/>    console.log(res);<br/>  } catch (err) {<br/>    console.log(err);<br/>  } finally {<br/>    await client.end();<br/>  }<br/>};</span><span id="e32b" class="lc jq hi ky b fi lh le l lf lg">run();</span></pre></div></div>    
</body>
</html>