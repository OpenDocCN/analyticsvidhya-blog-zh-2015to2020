<html>
<head>
<title>Compiling CAFFE with Python3.8 and OpenCV4.2.0 on ArchLinux</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在ArchLinux上用Python3.8和OpenCV4.2.0编译CAFFE</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/compiling-caffe-with-python3-8-and-opencv4-2-0-on-archlinux-db2c90370554?source=collection_archive---------3-----------------------#2020-02-07">https://medium.com/analytics-vidhya/compiling-caffe-with-python3-8-and-opencv4-2-0-on-archlinux-db2c90370554?source=collection_archive---------3-----------------------#2020-02-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b5d394d53084b75bd95245c20f5748b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Wz5kVnjNaEZdVqlR"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com/@cbarbalis?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯·巴巴利斯</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</figcaption></figure><p id="765a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这篇博客是关于在ArchLinux上安装CAFFE v1.0的。<a class="ae iu" href="https://github.com/BVLC/caffe" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上的默认CAFFE发行版无法与OpenCV 4 . 2 . 0版和Python 3.8编译。OpenCV特别成问题。我找不到任何一个帖子或类似的东西，可以带我一步一步地经历这些变化，而这正是这篇帖子所做的。</p><p id="3f3a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你当然可以安装旧版本的OpenCV，但是有新版本有什么意义呢？此外，这些变化应该独立于Linux发行版，因此可以在Ubuntu或任何其他发行版中尝试。但是我只在ArchLinux上测试过。</p><p id="04be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">免责声明:这只是基于我在我的机器上的经验，并不保证在任何其他系统中都能工作。这只是一个指南，并且是在ArchLinux上测试的，但是可能适用于其他Linux发行版。</em> </strong></p><h2 id="cbc0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">Python文件的更改</h2><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/2ecc87ba665616aa350058d86aa6f5a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U-tuP0RuhNgQsygB"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@hishahadat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">沙哈达特·拉赫曼</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</figcaption></figure><p id="6462" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是用新版本编译它并不困难，在编译它之前需要对不同的文件做一些修改。蟒蛇的很简单。在Python 2.7中，打印语句如下所示:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="7ecc" class="ju jv hi kv b fi kz la l lb lc">print "My name"</span></pre><p id="e013" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，在Python 3的任何版本中，如3.6、3.7或3.8，上面的打印命令看起来像这样:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="f11e" class="ju jv hi kv b fi kz la l lb lc">print("My name")</span></pre><p id="f780" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，关于print语句的任何错误都需要以同样的方式进行更正。Python提供了一个名为2to3的脚本，它安装在系统路径上，可以进行打印校正。与<code class="du ld le lf kv b">-w </code>开关一起使用。</p><h2 id="5ad6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">对Makefile.config的更改</h2><figure class="kq kr ks kt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/e4d02c24f45ad188f4f70003efd5335a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cb1HvpKrq8YaSdmLxGJ5lA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">互联网上提供标准OpenCV图像。</figcaption></figure><p id="13d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于OpenCV的问题，我从下面GitHub上的补丁引了一个:<a class="ae iu" href="https://github.com/AlexandrParkhomenko/aur/blob/master/caffe/readmeFix!!!.patch" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/AlexandrParkhomenko/aur/blob/master/caffe/readme fix！！！。补丁</a>)。第一个更改是在Makefile.config文件中。可以在Makefile.config或Makefile.config.example上进行更改，然后执行以下命令。</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="a2af" class="ju jv hi kv b fi kz la l lb lc">cp Makefile.config.example Makefile.config</span></pre><p id="dff6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面提到的行号指的是主GitHub存储库中的原始文件，在您编辑文件后可能会有所改变。最好在进行更改之前备份原始文件。这些变化是:</p><ol class=""><li id="9e7e" class="lh li hi ix b iy iz jc jd jg lj jk lk jo ll js lm ln lo lp bi translated">第23行，修改OpenCV的版本</li></ol><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="129f" class="ju jv hi kv b fi kz la l lb lc">23: OPENCV_VERSION := 4</span></pre><p id="32c0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.如果您在ArchLinux上构建CUDA版本，那么CUDA安装在一个不同于默认目录的目录中，通常是/opt/cuda，所以在第30行做如下修改。</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="93e5" class="ju jv hi kv b fi kz la l lb lc">30: CUDA_DIR := /opt/cuda</span></pre><p id="22ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于其他Linux发行版，请检查cuda的安装位置。如果您的处理器支持<a class="ae iu" href="http://CPU throttling or dynamic frequency scaling" rel="noopener ugc nofollow" target="_blank"> CPU节流或动态频率调节</a>，请安装OpenBlas库，而不是安装Atlas库。Makefile.config提供了一个使用Python 3的选项，只要确保它是Python3.8就行了，因为目标机器上可以安装多个版本的Python。此外，对于ArchLinux，Python的Numpy核心安装在/usr/lib/python3.8/ <strong class="ix hj">站点</strong> -packages/numpy…而不是/usr/lib/Python 3.8/<strong class="ix hj">dist</strong>-packages/Numpy…</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="a25c" class="ju jv hi kv b fi kz la l lb lc">80: # Uncomment to use Python 3 (default is Python 2)<br/>81: PYTHON_LIBRARIES := boost_python3 python3.8<br/>82: PYTHON_INCLUDE := /usr/include/python3.8 \<br/>                 /usr/lib/python3.8/site-packages/numpy/core/include</span></pre><p id="a288" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要在包含目录中显式包含OpenCV 4路径，以便构建过程找到OpenCV。需要进行以下更改:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="f269" class="ju jv hi kv b fi kz la l lb lc">96: # Whatever else you find you need goes here.<br/>97: INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/opencv4 #explicity included the opencv path</span></pre><h2 id="e2d3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">对Makefile的更改</h2><p id="c922" class="pw-post-body-paragraph iv iw hi ix b iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo lu jq jr js hb bi translated">Makefile本身不需要太多的修改。在第203行，需要提到OpenCV的版本。从同一行开始，用以下代码替换原始代码:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="24ac" class="ju jv hi kv b fi kz la l lb lc">203: ifeq ($(OPENCV_VERSION), $(filter $(OPENCV_VERSION), 3 4))<br/>  LIBRARIES += opencv_imgcodecs<br/>204: endif<br/>205: ifeq ($(OPENCV_VERSION), 4)<br/>206:  ifeq ($(USE_PKG_CONFIG), 1)<br/>   INCLUDE_DIRS += $(shell pkg-config opencv4 --cflags-only-I | sed 's/-I//g')<br/>207:  else<br/>208:   INCLUDE_DIRS += /usr/include/opencv4 /usr/local/include/opencv4<br/>209:   INCLUDE_DIRS += /usr/include/opencv4/opencv2 /usr/local/include/opencv4/opencv<br/>210:  endif <br/>211: endif</span></pre><p id="7751" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要在第208行更改Python库的名称，如下所示:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="e16d" class="ju jv hi kv b fi kz la l lb lc">208: PYTHON_LIBRARIES ?= boost_python3 python3.8 #changed from boost_python python2.7</span></pre><p id="327e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您使用OpenBlas库而不是Atlas进行高级线性代数运算，请在第388行进行以下更改:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="35d7" class="ju jv hi kv b fi kz la l lb lc">388: LIBRARIES += blas #instead of openblas</span></pre><p id="ce63" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">替换第420行，其中给出了一些用于C++编译的标志，如下所示:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="fd23" class="ju jv hi kv b fi kz la l lb lc">419: # Automatic dependency generation (nvcc is handled separately)<br/>420: COMMON_FLAGS += -D_GLIBCXX_USE_CXX11_ABI=1<br/>421: CXXFLAGS += -MMD -MP -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=1</span></pre><p id="527e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Makefile文件中还需要做一点修改，以便在第432行反映OpenCV 4的用法:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="8af0" class="ju jv hi kv b fi kz la l lb lc">430: USE_PKG_CONFIG ?= 0<br/>431: ifeq ($(USE_PKG_CONFIG), 1)<br/>432:  #PKG_CONFIG := $(shell pkg-config opencv --libs)<br/>433:  ifeq ($(OPENCV_VERSION), 4)<br/>434:   PKG_CONFIG := $(shell pkg-config opencv4 --libs)<br/>435:  else<br/>436:   PKG_CONFIG := $(shell pkg-config opencv --libs)<br/>436:  endif<br/>437: else<br/>438:  PKG_CONFIG :=<br/>439: endif</span></pre><h2 id="602d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">C++文件中的更改</h2><p id="f372" class="pw-post-body-paragraph iv iw hi ix b iy lq ja jb jc lr je jf jg ls ji jj jk lt jm jn jo lu jq jr js hb bi translated">在一些<code class="du ld le lf kv b">C++</code>文件中需要更多的修改。在OpenCV4中，为了读取图像，一些枚举的名称已经改变。下面的文件使用旧的<code class="du ld le lf kv b">CV_LOAD_IMAGE_COLOR</code>和<code class="du ld le lf kv b">CV_LOAD_IMAGE_GRAYSCALE</code>的枚举。必须在以下文件中更改这些枚举</p><ul class=""><li id="735c" class="lh li hi ix b iy iz jc jd jg lj jk lk jo ll js lv ln lo lp bi translated"><code class="du ld le lf kv b">caffe/src/caffe/util/io.cpp</code></li><li id="8914" class="lh li hi ix b iy lw jc lx jg ly jk lz jo ma js lv ln lo lp bi translated"><code class="du ld le lf kv b">caffe/src/caffe/layers/window_data_layer.cpp</code></li><li id="2d42" class="lh li hi ix b iy lw jc lx jg ly jk lz jo ma js lv ln lo lp bi translated"><code class="du ld le lf kv b">caffe/src/caffe/test/test_io.cpp</code></li></ul><p id="01d7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，在第77行的第一个文件中，进行以下更改</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="c425" class="ju jv hi kv b fi kz la l lb lc">77: int cv_read_flag = (is_color ? cv::IMREAD_COLOR://CV_LOAD_IMAGE_COLOR :<br/>        cv::IMREAD_GRAYSCALE);//CV_LOAD_IMAGE_GRAYSCALE);</span></pre><p id="26ec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">同样，其他三个文件也需要修改。</p><h2 id="9d6a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">GitHub知识库</h2><figure class="kq kr ks kt fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/67bfecb7bfba876e08664ddcafadabb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:636/format:webp/1*fSP26Ruvd2hDkRw-RltsEg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">GitHub的标准logo。</figcaption></figure><p id="c2a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面提到的所有改变都可以在我自己的Caffe框架中找到，这个框架可以在<a class="ae iu" href="https://github.com/asadalam/caffe" rel="noopener ugc nofollow" target="_blank">www.github.com/asadalam/caffe</a>上找到。按照<a class="ae iu" href="http://caffe.berkeleyvision.org/installation.html" rel="noopener ugc nofollow" target="_blank">咖啡馆主页上的说明进行安装。</a>我对上面列出的更改进行了两次验证，它可以在我的系统上工作，但它是在没有任何担保的情况下发布的，并且是“按原样”提供的，我不对任何问题负责。本质上，GitHub存储库上的许可文件说了什么。</p></div></div>    
</body>
</html>