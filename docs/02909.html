<html>
<head>
<title>Stored Procedure In Depth</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深度存储过程</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/stored-procedure-in-depth-by-sagar-jaybhay-2020-sagar-jaybhay-e8319ca81a81?source=collection_archive---------14-----------------------#2020-01-07">https://medium.com/analytics-vidhya/stored-procedure-in-depth-by-sagar-jaybhay-2020-sagar-jaybhay-e8319ca81a81?source=collection_archive---------14-----------------------#2020-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="b63c" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">什么是存储过程？</h1><p id="ba98" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">存储过程是一组SQL语句。我们将每次都要使用的SQL语句分组，并为其指定一个名称。这样做的结果是，你准备了一个SQL代码并保存它。当你再次需要这个的时候，你只需要叫出你给的名字。</p><p id="4fe1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">假设您有一个查询<strong class="jf hj">select * from employee；</strong>这个查询你要反复保存它为一个过程。</p><p id="e304" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">不能在select子句和where子句中使用存储过程。</p><h2 id="f7d0" class="kg ig hi bd ih kh ki kj il kk kl km ip jo kn ko it js kp kq ix jw kr ks jb kt bi translated">过程的一般语法:</h2><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="8d71" class="kg ig hi kz b fi ld le l lf lg">CREATE PROCEDURE procedure_name<br/>AS<br/>begin<br/>sql_statement<br/>end<br/>GO;</span></pre><p id="e131" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">举例</strong></p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="5e04" class="kg ig hi kz b fi ld le l lf lg">create procedure GetAllEmployee    --Create stored procedure syntax<br/>as <br/>begin<br/>select * from Employee;<br/>end</span></pre><ol class=""><li id="1e98" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lm ln lo lp bi translated">在上面的查询中，GetAllEmployee是我们给定的<a class="ae lq" href="https://docs.microsoft.com/en-us/sql/relational-databases/stored-procedures/create-a-stored-procedure" rel="noopener ugc nofollow" target="_blank">过程</a>的名称。请避免在过程名称中使用sp前缀，这是Microsoft建议的，因为Microsoft给出的内置过程是以字母sp开头的。</li><li id="cc7f" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">As关键字用于分隔存储过程的标题和主体。</li><li id="4d24" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">之后，我们有begin和end语句，如果只有一个SQL语句，那么begin和end关键字是可选的。但是，即使只有一条SQL语句，也应该有开头和结尾。</li><li id="52f9" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">create Procedure是创建过程的语法。</li></ol><h1 id="6ecf" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何执行存储过程？</h1><p id="6958" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">调用过程有不同的方法，我们有下面的方法。</p><ol class=""><li id="e49b" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lm ln lo lp bi translated">存储过程名称，然后按F5在SQL server management studio上运行</li><li id="72b1" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">Exec存储过程名称</li><li id="beca" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">执行存储过程名称</li></ol><h1 id="c85d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何删除存储过程？</h1><p id="8882" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您可以在存储过程名称中使用drop procedure关键字。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="0e71" class="kg ig hi kz b fi ld le l lf lg">drop procedure GetAllEmployee; -- drop the store procedure</span></pre><h1 id="20be" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何在SQL server中获取存储过程文本？</h1><p id="05ea" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">使用<strong class="jf hj"> sp_helptext </strong>内置过程并传递过程名，然后您将获得所有存储过程语法。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="7a34" class="kg ig hi kz b fi ld le l lf lg">sp_helptext GetAllEmployee  -- get the text of stored procedure</span></pre><h1 id="ed94" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何改变SQL server中的存储过程？</h1><p id="9eeb" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">您可以将alter关键字与过程名一起使用，并更改您想要更改的SQL语句，然后运行该语句，您的过程将被更改。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="65c7" class="kg ig hi kz b fi ld le l lf lg">alter procedure GetAllEmployee  -- alter a stored procedure<br/>as <br/>begin<br/>select top 10 * from Employee;<br/>end</span></pre><h1 id="8256" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何在SQL server中创建参数化存储过程？</h1><p id="e1f4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">要创建参数化过程，请使用以下通用语法。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="1e72" class="kg ig hi kz b fi ld le l lf lg">Create procedure Proc_name @param1 data_type,@para2 data_type<br/>As<br/>Begin<br/>SQL statement<br/>End;</span></pre><p id="671d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">例子</strong></p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="57b1" class="kg ig hi kz b fi ld le l lf lg">create proc GetEmpBasedOnParameter -- create parametrize stored procedure<br/>@departmentid int,<br/>@gender varchar(10)<br/>as<br/>begin<br/>select * from Employee where DepartmentID=@departmentid and Gender=@gender;<br/>end</span></pre><ol class=""><li id="c9e8" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lm ln lo lp bi translated">在上面的代码语法中，我们有@departmentid是整数参数，而@geneder是第二个具有varchar数据类型的参数。</li><li id="a7d9" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">其余的过程语法是相同的，但是如果您看到一个select语句，我们在where子句中使用@departmentid和@geneder参数，并且当我们调用这个过程时传递这个参数。</li><li id="370b" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">如果不为参数化过程传递参数，将会出现错误。</li><li id="b2c7" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">我们可以改变参数的顺序，但是我们需要在过程调用中显式地定义它们。</li></ol><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4570" class="kg ig hi kz b fi ld le l lf lg">exec GetEmpBasedOnParameter @gender='female',@departmentid=10      --run stored procedure syntax with parameters position not required</span></pre><h1 id="dbfa" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">带输出参数的存储过程</h1><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="fa22" class="kg ig hi kz b fi ld le l lf lg">create procedure GetGenderwisecount  -- procedure with an output parameter<br/>@gender varchar(10),<br/>@empCount int out<br/>as<br/>begin<br/>select @empCount = count(empid) from Employee where Gender=@gender<br/>end;</span></pre><p id="8715" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在上面的过程中，我们创建了一个带有输出参数的参数化过程。这个过程将性别作为输入，并产生该性别的总计数作为输出，因此声明为<strong class="jf hj"> @empcount </strong> int out这是我们的输出参数，我们可以声明为<strong class="jf hj"> @empcount </strong> int output，就像两者都将产生相同的结果。</p><h1 id="c0b1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何调用返回输出参数的存储过程？</h1><p id="d9af" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果我们的存储过程返回输出参数，那么我们需要在一个变量中捕获输出。所以当我们调用这个过程时，我们需要声明一个标量变量，并获取输出参数。</p><p id="137d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在使用声明的语法声明输出参数之后，在此之后，当您调用execute语句时，您需要指定不带or output的变量，否则它将不会在我们声明的输出参数中获得结果。如果不声明不带参数的变量，值将为null。</p><p id="3f2f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">声明输出参数的一般语法是</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="fdc5" class="kg ig hi kz b fi ld le l lf lg">@product_count INT OUTPUT<br/><br/>declare @empcount int<br/>exec GetGenderwisecount 'feMale',@empcount out<br/>print(@empcount)</span></pre><blockquote class="lw lx ly"><p id="dbeb" class="jd je lz jf b jg kb ji jj jk kc jm jn ma kd jq jr mb ke ju jv mc kf jy jz ka hb bi translated"><em class="hi">我们可以在存储过程中有多个输出参数。</em></p></blockquote><h1 id="56e7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">存储过程:输出参数与返回值</h1><h1 id="7e84" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">返回值</h1><p id="e212" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">创建一个将返回值的存储过程。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="81bf" class="kg ig hi kz b fi ld le l lf lg">create procedure GetGenderwisecount2  -- procedure with a return value<br/>@gender varchar(10)<br/>as<br/>begin<br/>return (select count(empid) from Employee where Gender=@gender)<br/>end;</span></pre><p id="1280" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在上面的过程中，我们使用了return语句，在括号中，我们编写了一个基于性别计算emp的查询，在这个过程中，我们使用了这些括号，因为它将首先执行，然后将结果传递给return语句。</p><p id="b0bc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">为了运行上面的过程，我们使用下面的代码</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4474" class="kg ig hi kz b fi ld le l lf lg">declare @count int<br/>exec @count= GetGenderwisecount2 'male'<br/>print(@count)</span></pre><p id="2996" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在这里，我们在@count变量中收集返回值，并且在create procedure语法中没有使用output参数。上面的调用过程工作得非常好，因为它返回数字值。</p><p id="2d17" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">永远记住，当你运行你的存储过程时，它将返回一个整数值，这是过程的状态。</p><p id="697d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">现在我们尝试使用return语句返回字符串值。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="29bd" class="kg ig hi kz b fi ld le l lf lg">Create procedure GetEmployeeNamebyID<br/>@id int <br/>as<br/>begin<br/>return (select Employee.full_name from Employee where EmpID=@id);<br/>end;</span></pre><p id="734a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在上面的create stored procedure语法中，我们将if作为输入参数传递，并尝试返回name值，但是当您尝试执行此过程时，它会抛出一个错误</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="4d31" class="kg ig hi kz b fi ld le l lf lg">exec GetEmployeeNamebyID 1</span></pre><p id="7c2a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">消息245，级别16，状态1，过程GetEmployeeNamebyID，第5行[批处理开始行91]</p><p id="5762" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">将varchar值“Harcourt Loalday”转换为数据类型int时，转换失败</p><blockquote class="lw lx ly"><p id="f4ff" class="jd je lz jf b jg kb ji jj jk kc jm jn ma kd jq jr mb ke ju jv mc kf jy jz ka hb bi translated"><em class="hi">所以要记住存储过程的返回值始终是一个整数。</em></p></blockquote><h1 id="c524" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">存储过程的优点</h1><ol class=""><li id="6cf3" class="lh li hi jf b jg jh jk jl jo md js me jw mf ka lm ln lo lp bi translated">存储过程的最大好处是它们能够重用执行计划。执行计划意味着当您启动一个查询时，SQL server首先检查查询的语法，然后编译该查询，最后生成一个执行计划。简而言之，执行计划是为了从数据库中获取数据，这是检索数据的最佳方式。您使用的是存储过程，因此SQL server会缓存该执行计划并将其存储在内存中，当您再次调用该存储过程时，它不会执行语法检查、编译查询和生成执行计划等所有过程，而是会使用缓存的执行计划，因此最终会提高性能。相比之下，如果使用来查询，它也会生成缓存计划查询，但查询中的小变化会导致所有步骤重新执行。</li><li id="a1da" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">它驻留在服务器上，因此任何想要使用该过程的应用程序都可以使用它。从而实现可维护性和可重用性。</li><li id="83a0" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">它提供了良好的安全性。</li><li id="b794" class="lh li hi jf b jg lr jk ls jo lt js lu jw lv ka lm ln lo lp bi translated">它<strong class="jf hj"> </strong>避开了SQL注入的攻击。</li></ol><p id="3cbc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="lz">原载于2020年1月7日</em><a class="ae lq" href="https://sagarjaybhay.com/stored-procedure-in-depth-by-sagar-jaybhay-2020/" rel="noopener ugc nofollow" target="_blank"><em class="lz">【https://sagarjaybhay.com】</em></a><em class="lz">。</em></p></div></div>    
</body>
</html>