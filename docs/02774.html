<html>
<head>
<title>Predicting an Oil and Gas company’s stocks using AI (Recurrent Neural Networks): a Keras implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AI(递归神经网络)预测石油和天然气公司的股票:Keras实现</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/predicting-an-oil-and-gas-companys-stocks-using-ai-recurrent-neural-networks-a-keras-f54d1c5a1020?source=collection_archive---------14-----------------------#2020-01-01">https://medium.com/analytics-vidhya/predicting-an-oil-and-gas-companys-stocks-using-ai-recurrent-neural-networks-a-keras-f54d1c5a1020?source=collection_archive---------14-----------------------#2020-01-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/65b44051d89908d263971d91678e2b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*0dw2_d_SBURuo_7o4CPGwQ.jpeg"/></div></figure><p id="6b79" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">股票市场是一个国家的经济和这个国家的公民之间的桥梁。股票市场的状况关系到一个国家经济的健康发展，但同时也允许普通人参与这个市场。股票市场包含位于特定国家的大公司和小公司的股票，公民可以通过低价买入股票并在股价上涨时卖出获利来做生意。然而，这里有一个问题:当股价暴跌时，就会产生巨大的损失。因此，投资股市的人在花一分钱之前会进行几十次计算，这并不奇怪。然而，令人欣慰的是，人工智能的兴起导致了这个问题的解决方案，因为人工智能在更少的人力投入下表现得非常好。不仅如此，像递归神经网络(RNN)这样的人工智能技术可以通过获取数十年的数据来进行预测。为了说明这一点，本文使用RNNs对Schlumberger(一家石油和天然气服务公司)2010年至2019年的股票进行了预测。</p><p id="4814" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">免责声明:这是一篇中级到高级水平的人工智能文章。关于神经网络，RNNs和Python语言的知识是必须的。</p><p id="d13a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">什么是rnn？</strong></p><p id="ab79" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">RNNs是一种神经网络，它又是机器学习技术的子集。与简单的神经网络不同，RNNs考虑了特定神经元的过去状态和当前状态。简单来说，RNN不仅从当前数据中学习，还从过去的数据中学习。如果RNN是双向的，网络从现在、过去以及未来的数据中学习。为了简单起见，这里不严格地使用这些术语。建议读者通过其他来源，如吴恩达的深度学习专业化，了解更多关于RNNs的信息。</p><p id="ea57" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">rnn有几种类型。最著名的是GRU和LSTM。虽然还没有定论哪一个更好，但两者都在今天被广泛使用。对于我们的应用程序，我们将使用LSTM。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div class="er es jk"><img src="../Images/65bd9909729c07c68ce3177f61eb4a40.png" data-original-src="https://miro.medium.com/v2/resize:fit:546/format:webp/1*QjK3cYcCcLVsSaqiLoHyTg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">LSTM单位</figcaption></figure><p id="d76d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">实现</strong></p><p id="769d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第一步是收集数据。我从纳斯达克官方网站收集了10年的股市数据。数据为csv格式，可视化代码如下所示:</p><pre class="jl jm jn jo fd jt ju jv jw aw jx bi"><span id="7f34" class="jy jz hi ju b fi ka kb l kc kd">import tensorflow as tf<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import csv<br/>time_step = []<br/>temps = []</span><span id="50fd" class="jy jz hi ju b fi ke kb l kc kd">with open('HistoricalQuotes(1).csv') as csvfile:<br/>  reader = csv.reader(csvfile, delimiter=',')<br/>  next(reader)<br/>  step=0<br/>  for row in reader:<br/>    val=row[1]<br/>    temps.append(float(val[2:]))<br/>    time_step.append(step)<br/>    step = step + 1</span><span id="685c" class="jy jz hi ju b fi ke kb l kc kd">series = np.array(temps)<br/>time = np.array(time_step)<br/>plt.figure(figsize=(10, 6))<br/>plot_series(time, series)</span></pre><p id="dc41" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">历史语录(1)。csv包含股票市场数据。只要有逗号，读取器就会分隔每一行。第二个值(即第一个指数)是股票的收盘价。使用val[2:]省略了第一个美元符号字符。plot_series函数如下所示:</p><pre class="jl jm jn jo fd jt ju jv jw aw jx bi"><span id="cede" class="jy jz hi ju b fi ka kb l kc kd">def plot_series(time, series, format="-", start=0, end=None):<br/>    plt.plot(time[start:end], series[start:end], format)<br/>    plt.xlabel("Time")<br/>    plt.ylabel("Value")<br/>    plt.grid(True)<br/>    plt.show()</span></pre><p id="24d8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">数据如下所示:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kf"><img src="../Images/b5229b4b8dbc986831cea45e8e8f9093.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVsWzrYsycWdIrUXxI-qEw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Schlumberger过去10年的股票</figcaption></figure><p id="1a5b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">数据被分成训练集和验证集。数据在第1800个时间步长标记处被分割。</p><pre class="jl jm jn jo fd jt ju jv jw aw jx bi"><span id="7df1" class="jy jz hi ju b fi ka kb l kc kd">split_time = 1800<br/>time_train = time[:split_time]<br/>x_train = series[:split_time]<br/>time_valid = time[split_time:]<br/>x_valid = series[split_time:]</span></pre><p id="023c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">RNN的输入是窗口序列的形式。这是必要的，这样网络就能看到一大块数据，而不仅仅是一个数据点。</p><pre class="jl jm jn jo fd jt ju jv jw aw jx bi"><span id="3060" class="jy jz hi ju b fi ka kb l kc kd">def windowed_dataset(series, window_size, batch_size, shuffle_buffer):<br/>    series = tf.expand_dims(series, axis=-1)<br/>    ds = tf.data.Dataset.from_tensor_slices(series)<br/>    ds = ds.window(window_size + 1, shift=1, drop_remainder=True)<br/>    ds = ds.flat_map(lambda w: w.batch(window_size + 1))<br/>    ds = ds.shuffle(shuffle_buffer)<br/>    ds = ds.map(lambda w: (w[:-1], w[1:]))<br/>    return ds.batch(batch_size).prefetch(1)<br/>def model_forecast(model, series, window_size):<br/>    ds = tf.data.Dataset.from_tensor_slices(series)<br/>    ds = ds.window(window_size, shift=1, drop_remainder=True)<br/>    ds = ds.flat_map(lambda w: w.batch(window_size))<br/>    ds = ds.batch(32).prefetch(1)<br/>    forecast = model.predict(ds)<br/>    return forecast<br/>tf.keras.backend.clear_session()</span><span id="2f7e" class="jy jz hi ju b fi ke kb l kc kd">np.random.seed(51)<br/>window_size = 64<br/>batch_size = 256<br/>shuffle_buffer_size=1000</span><span id="5643" class="jy jz hi ju b fi ke kb l kc kd">train_set = windowed_dataset(x_train, window_size, batch_size, shuffle_buffer_size)</span></pre><p id="5bc1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">到目前为止，我们已经准备好了数据。下一步是准备模型。我们使用的模型具有以下序列:</p><p id="42d3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">Conv2d-&gt;LSTM-&gt;LSTM-&gt;稠密- &gt;稠密- &gt;稠密-&gt;λ</strong></p><pre class="jl jm jn jo fd jt ju jv jw aw jx bi"><span id="08b2" class="jy jz hi ju b fi ka kb l kc kd">model = tf.keras.models.Sequential([<br/>  tf.keras.layers.Conv1D(filters=60, kernel_size=5,<br/>                      strides=1, padding="causal",<br/>                      activation="relu",<br/>                      input_shape=[None, 1]),<br/>  tf.keras.layers.LSTM(60, return_sequences=True),<br/>  tf.keras.layers.LSTM(60, return_sequences=True),<br/>  tf.keras.layers.Dense(30, activation="relu"),<br/>  tf.keras.layers.Dense(10, activation="relu"),<br/>  tf.keras.layers.Dense(1),<br/>  tf.keras.layers.Lambda(lambda x: x * 400)<br/>])</span></pre><p id="4d50" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将使用具有动量的随机梯度下降(SGD)作为我们的优化器，使用Huber作为我们在100个时期训练的损失函数。度量是平均绝对误差(MAE)。</p><pre class="jl jm jn jo fd jt ju jv jw aw jx bi"><span id="3a70" class="jy jz hi ju b fi ka kb l kc kd">optimizer = tf.keras.optimizers.SGD(lr=1e-6, momentum=0.9)<br/>model.compile(loss=tf.keras.losses.Huber(),<br/>              optimizer=optimizer,<br/>              metrics=["mae"])<br/>history = model.fit(train_set,epochs=100)</span></pre><p id="3f90" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该模型被训练100个时期，然后在验证集上进行预测。真实值(蓝线)和预测值(橙线)显示在同一个图表上，以供比较。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es kf"><img src="../Images/5994e46d1d1bc374add057889aad4a7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xc5LUwceQCbxVlub_A5dVQ.png"/></div></div></figure><p id="4df0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">MAE小至1.49，考虑到石油和天然气行业的不确定性和易变性质，这是一个很好的结果。</p><p id="c3c4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">这段代码的灵感来自Deeplearning.ai的Tensorflow专门化</strong></p></div></div>    
</body>
</html>