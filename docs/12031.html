<html>
<head>
<title>Python FastAPI and AWS Lambda Container</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python FastAPI和AWS Lambda容器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/python-fastapi-and-aws-lambda-container-3e524c586f01?source=collection_archive---------2-----------------------#2020-12-29">https://medium.com/analytics-vidhya/python-fastapi-and-aws-lambda-container-3e524c586f01?source=collection_archive---------2-----------------------#2020-12-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/dd1cdf61686bcf0685b9f3ef0808af6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*tO0kfHSYSatPlhn84E8HSg.jpeg"/></div></figure><p id="1caa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2020年12月，AWS已经发布了对AWS Lambda 的<a class="ae jk" href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/" rel="noopener ugc nofollow" target="_blank">容器支持。本文展示了如何在AWS Lambda上构建、测试和部署一个容器，该容器嵌入了一个基于</a><a class="ae jk" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>和<a class="ae jk" href="https://mangum.io/" rel="noopener ugc nofollow" target="_blank"> Mangum </a>的简单Python REST API。</p><p id="e863" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">容器支持对于部署无法通过Lambda限制或使用不支持的运行时的应用程序非常有用。这对嵌入深度学习或机器学习模型的Python应用程序尤其有用，因为库和模型通常太重，无法部署在AWS Lambda上，即使使用Lambda层也是如此。</p><p id="0fe2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">测试应用程序的源代码、Dockerfile和指令可以在<a class="ae jk" href="https://github.com/gbdevw/python-fastapi-aws-lambda-container" rel="noopener ugc nofollow" target="_blank">这里</a>找到。尽情享受吧！</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="18af" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">项目布局</h2><figure class="ko kp kq kr fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/277c43d33c38647023716dd53bb275f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*5V6vr-WHPtxqcuFzZaFe6A.jpeg"/></div></figure><p id="fbef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">根目录包含一个描述Python依赖关系的requirements.txt文件和一个“app”文件夹，该文件夹是FastAPI应用程序的根模块。</p><p id="a41c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它还包含两个Docker文件:一个用于构建在Uvicorn上运行FastAPI应用程序的“常规”容器，另一个使用AWS提供的图像来构建可以在AWS Lambda上部署的容器。</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="5e8c" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">FastAPI应用程序</h2><p id="6657" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">app.py文件包含配置FastAPI应用程序、其中间件、路由器、错误处理程序等的Python脚本</p><figure class="ko kp kq kr fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="8b52" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最重要的部分是第24行，这里我们使用<a class="ae jk" href="https://pypi.org/project/mangum/" rel="noopener ugc nofollow" target="_blank"> Mangum </a>来创建AWS Lambda处理程序，它将翻译并“转发”请求到FastAPI应用程序。</p></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="9f8c" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">构建AWS Lambda容器的Dockerfile文件</h2><figure class="ko kp kq kr fd ij"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="46c8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Dockerfile文件非常简单:</p><ul class=""><li id="fe8c" class="kz la hi io b ip iq it iu ix lb jb lc jf ld jj le lf lg lh bi translated">它使用来自AWS的基础映像</li><li id="b657" class="kz la hi io b ip li it lj ix lk jb ll jf lm jj le lf lg lh bi translated">它复制本地“app”文件夹的内容，并将其粘贴到工作目录下的“app”文件夹中</li><li id="04d9" class="kz la hi io b ip li it lj ix lk jb ll jf lm jj le lf lg lh bi translated">它复制工作目录中的requirements.txt文件</li><li id="d78c" class="kz la hi io b ip li it lj ix lk jb ll jf lm jj le lf lg lh bi translated">它使用pip和requirements.txt安装Python依赖项</li><li id="e0bc" class="kz la hi io b ip li it lj ix lk jb ll jf lm jj le lf lg lh bi translated">CMD定义了在哪里可以找到Lambda处理程序，并将被基本映像入口点使用。</li></ul></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="c22c" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">构建容器并将其推到AWS ECR上</h2><p id="78e3" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">该命令使用专用Dockerfile构建容器，并对其进行标记，以便能够将其推送到ECR私有存储库:</p><pre class="ko kp kq kr fd ln lo lp lq aw lr bi"><span id="842f" class="js jt hi lo b fi ls lt l lu lv">docker build -t &lt;account_id&gt;.dkr.ecr.eu-west-1.amazonaws.com/fastapi-aws-lambda:latest . -f Dockerfile.aws.lambda</span></pre><p id="f782" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以下是如何登录ECR并将映像推送到私有ECR存储库的方法:</p><pre class="ko kp kq kr fd ln lo lp lq aw lr bi"><span id="d517" class="js jt hi lo b fi ls lt l lu lv">export AWS_ACCESS_KEY_ID=secret<br/>export AWS_SECRET_ACCESS_KEY=secret<br/>export AWS_DEFAULT_REGION=&lt;region&gt;</span><span id="3669" class="js jt hi lo b fi lw lt l lu lv">aws ecr get-login-password --region &lt;region&gt; | docker login --username AWS --password-stdin &lt;account_id&gt;.dkr.ecr.eu-west-1.amazonaws.com</span><span id="e7c4" class="js jt hi lo b fi lw lt l lu lv">docker push &lt;account_id&gt;.dkr.ecr.eu-west-1.amazonaws.com/fastapi-aws-lambda:latest</span></pre><p id="8c98" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">结果是:</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es lx"><img src="../Images/6235977bb6140ec8f8edff654fff0e67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OYUSd69jzt-iEXRG3ijOVg.jpeg"/></div></div></figure></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="08db" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">本地测试AWS Lambda容器</h2><p id="fd46" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">AWS提供的容器映像已经包含了<a class="ae jk" href="https://docs.aws.amazon.com/lambda/latest/dg/images-test.html" rel="noopener ugc nofollow" target="_blank"> Lambda运行时接口仿真器</a>，可以在本地测试。</p><p id="5fef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，必须启动容器:</p><pre class="ko kp kq kr fd ln lo lp lq aw lr bi"><span id="a5a6" class="js jt hi lo b fi ls lt l lu lv">docker run -p 9000:8080 &lt;account_id&gt;.dkr.ecr.eu-west-1.amazonaws.com/fastapi-aws-lambda:latest</span></pre><p id="fe62" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">API不能直接针对AWS Lambda容器进行测试(但是您可以简单地运行FastAPI应用程序来测试API)。要测试Lambda，您必须向RIE发送一个Lambda事件。该事件将被转发给Lambda处理程序，后者将翻译该事件并将其“转发”给FastAPI应用程序。</p><p id="28e7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">该命令向RIE发送一个事件，该事件模拟来自AWS API网关的事件:</p><pre class="ko kp kq kr fd ln lo lp lq aw lr bi"><span id="b419" class="js jt hi lo b fi ls lt l lu lv">curl -XPOST "<a class="ae jk" href="http://localhost:9000/2015-03-31/functions/function/invocations" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/2015-03-31/functions/function/invocations</a>" -d '{<br/>    "resource": "/hello",<br/>    "path": "/hello/",<br/>    "httpMethod": "GET",<br/>    "headers": {<br/>      "Accept": "*/*",<br/>      "Accept-Encoding": "gzip, deflate",<br/>      "cache-control": "no-cache",<br/>      "CloudFront-Forwarded-Proto": "https",<br/>      "CloudFront-Is-Desktop-Viewer": "true",<br/>      "CloudFront-Is-Mobile-Viewer": "false",<br/>      "CloudFront-Is-SmartTV-Viewer": "false",<br/>      "CloudFront-Is-Tablet-Viewer": "false",<br/>      "CloudFront-Viewer-Country": "US",<br/>      "Content-Type": "application/json",<br/>      "headerName": "headerValue",<br/>      "Host": "gy415nuibc.execute-api.us-east-1.amazonaws.com",<br/>      "Postman-Token": "9f583ef0-ed83-4a38-aef3-eb9ce3f7a57f",<br/>      "User-Agent": "PostmanRuntime/2.4.5",<br/>      "Via": "1.1 d98420743a69852491bbdea73f7680bd.cloudfront.net (CloudFront)",<br/>      "X-Amz-Cf-Id": "pn-PWIJc6thYnZm5P0NMgOUglL1DYtl0gdeJky8tqsg8iS_sgsKD1A==",<br/>      "X-Forwarded-For": "54.240.196.186, 54.182.214.83",<br/>      "X-Forwarded-Port": "443",<br/>      "X-Forwarded-Proto": "https"<br/>    },<br/>    "multiValueHeaders":{<br/>      "Accept":[<br/>        "*/*"<br/>      ],<br/>      "Accept-Encoding":[<br/>        "gzip, deflate"<br/>      ],<br/>      "cache-control":[<br/>        "no-cache"<br/>      ],<br/>      "CloudFront-Forwarded-Proto":[<br/>        "https"<br/>      ],<br/>      "CloudFront-Is-Desktop-Viewer":[<br/>        "true"<br/>      ],<br/>      "CloudFront-Is-Mobile-Viewer":[<br/>        "false"<br/>      ],<br/>      "CloudFront-Is-SmartTV-Viewer":[<br/>        "false"<br/>      ],<br/>      "CloudFront-Is-Tablet-Viewer":[<br/>        "false"<br/>      ],<br/>      "CloudFront-Viewer-Country":[<br/>        "US"<br/>      ],<br/>      "":[<br/>        ""<br/>      ],<br/>      "Content-Type":[<br/>        "application/json"<br/>      ],<br/>      "headerName":[<br/>        "headerValue"<br/>      ],<br/>      "Host":[<br/>        "gy415nuibc.execute-api.us-east-1.amazonaws.com"<br/>      ],<br/>      "Postman-Token":[<br/>        "9f583ef0-ed83-4a38-aef3-eb9ce3f7a57f"<br/>      ],<br/>      "User-Agent":[<br/>        "PostmanRuntime/2.4.5"<br/>      ],<br/>      "Via":[<br/>        "1.1 d98420743a69852491bbdea73f7680bd.cloudfront.net (CloudFront)"<br/>      ],<br/>      "X-Amz-Cf-Id":[<br/>        "pn-PWIJc6thYnZm5P0NMgOUglL1DYtl0gdeJky8tqsg8iS_sgsKD1A=="<br/>      ],<br/>      "X-Forwarded-For":[<br/>        "54.240.196.186, 54.182.214.83"<br/>      ],<br/>      "X-Forwarded-Port":[<br/>        "443"<br/>      ],<br/>      "X-Forwarded-Proto":[<br/>        "https"<br/>      ]<br/>    },<br/>    "queryStringParameters": {<br/>    },<br/>    "multiValueQueryStringParameters":{<br/>    },<br/>    "pathParameters": {<br/>    },<br/>    "stageVariables": {<br/>      "stageVariableName": "stageVariableValue"<br/>    },<br/>    "requestContext": {<br/>      "accountId": "12345678912",<br/>      "resourceId": "roq9wj",<br/>      "stage": "testStage",<br/>      "requestId": "deef4878-7910-11e6-8f14-25afc3e9ae33",<br/>      "identity": {<br/>        "cognitoIdentityPoolId": null,<br/>        "accountId": null,<br/>        "cognitoIdentityId": null,<br/>        "caller": null,<br/>        "apiKey": null,<br/>        "sourceIp": "192.168.196.186",<br/>        "cognitoAuthenticationType": null,<br/>        "cognitoAuthenticationProvider": null,<br/>        "userArn": null,<br/>        "userAgent": "PostmanRuntime/2.4.5",<br/>        "user": null<br/>      },<br/>      "resourcePath": "/hello/",<br/>      "httpMethod": "GET",<br/>      "apiId": "gy415nuibc"<br/>    },<br/>    "body": "{}",<br/>    "isBase64Encoded": false<br/>}'</span></pre><p id="14de" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">以下是本地Lambda容器的输出:</p><pre class="ko kp kq kr fd ln lo lp lq aw lr bi"><span id="fe40" class="js jt hi lo b fi ls lt l lu lv">{"isBase64Encoded": false, "statusCode": 200, "headers": {"content-length": "25", "content-type": "application/json", "x-correlation-id": "e6ccda71-c841-40de-8208-aff40a2b155b"}, "body": "{\"message\":\"Hello World\"}"}</span></pre></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="218d" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">部署AWS Lambda并配置AWS API网关</h2><p id="fbd2" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">首先，AWS Lambda创建如下:</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es mc"><img src="../Images/b2e757a4988b8c04a020334c29ead61d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gLvLNBsLNTWXwxESh5lnNw.jpeg"/></div></div></figure><p id="d8bb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">其次，配置API网关。这里，对/hello资源及其所有子资源的所有请求都被转发到刚刚创建的AWS Lambda。API部署在名为“Default”的阶段上。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es md"><img src="../Images/92d74ac7f419bf72382fe10e4f54c3fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M6N3vFmoA7rZLtMuqKzpSA.jpeg"/></div></div></figure></div><div class="ab cl jl jm gp jn" role="separator"><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq jr"/><span class="jo bw bk jp jq"/></div><div class="hb hc hd he hf"><h2 id="0f47" class="js jt hi bd ju jv jw jx jy jz ka kb kc ix kd ke kf jb kg kh ki jf kj kk kl km bi translated">测试REST API</h2><p id="1ea7" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">AWS Lambda已经创建并使用了容器。AWS API网关被配置并将请求转发给Lambda。</p><p id="255a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在是测试API的时候了。Postman用于向“/hello/”端点发送GET请求。</p><figure class="ko kp kq kr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es me"><img src="../Images/a66acb0d484560d487afad09653adbee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JzqfSxM7gw3rEs2eRJB-vg.jpeg"/></div></div></figure><p id="c98e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一切都很好，Lambda成功地处理了请求。我们可以注意到第一次冷启动是由于容器拉力。查看Cloudwatch日志:</p><pre class="ko kp kq kr fd ln lo lp lq aw lr bi"><span id="6fac" class="js jt hi lo b fi ls lt l lu lv">REPORT RequestId: 55ed629c-0e61-426a-96d0-fc8d0106356b Duration: 48.08 ms Billed Duration: 5128 ms Memory Size: 128 MB Max Memory Used: 74 MB Init Duration: 5079.39 ms</span><span id="1943" class="js jt hi lo b fi lw lt l lu lv">REPORT RequestId: 4518ba46-4bc9-4fac-a74c-1e7e3730bfe4 Duration: 3.47 ms Billed Duration: 4 ms Memory Size: 128 MB Max Memory Used: 74 MB</span></pre><p id="4597" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">另外，请注意计费持续时间现在不限于最低100毫秒。使用AWS Lambda的另一个重要原因；)</p></div></div>    
</body>
</html>