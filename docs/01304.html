<html>
<head>
<title>Integrating Django Signals and Celery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">整合Django信号和芹菜</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/integrating-django-signals-and-celery-cb2876ebd494?source=collection_archive---------0-----------------------#2019-10-14">https://medium.com/analytics-vidhya/integrating-django-signals-and-celery-cb2876ebd494?source=collection_archive---------0-----------------------#2019-10-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/488dc2969bc258ede42716fd8a197667.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*8uUFgpkkxcFpCTUDuzeBOw.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">姜戈+芹菜(鸣谢:谷歌图片)</figcaption></figure><p id="d06a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi jo translated">这是我在Medium上的第一篇文章，希望对你正在进行的项目有所帮助。</p><p id="b245" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章给出了一个用celery进行多处理和异步执行，并通过结合django信号触发异步任务的很好的例子。</p><h1 id="eff7" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">要求:</strong></h1><ol class=""><li id="501a" class="kv kw hi is b it kx ix ky jb kz jf la jj lb jn lc ld le lf bi translated">姜戈</li><li id="5608" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">计算机编程语言</li><li id="93e5" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">芹菜</li></ol><h1 id="5086" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">入门:</strong></h1><p id="caba" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">让我们举一个使用芹菜和Django信号的基本例子。假设如果我想触发一个任务，比较保存在具有两个图像字段的模型中的两个图像，那么我们可以使用django信号和celery的组合来完成这个任务。所以，让我们把这个任务分成两部分:</p><ol class=""><li id="3d64" class="kv kw hi is b it iu ix iy jb lo jf lp jj lq jn lc ld le lf bi translated">把芹菜放在姜戈项目上。</li><li id="d056" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated">定义触发所需任务的django信号。</li></ol></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="75ea" class="jx jy hi bd jz ka ly kc kd ke lz kg kh ki ma kk kl km mb ko kp kq mc ks kt ku bi translated"><strong class="ak">设置芹菜:</strong></h1><p id="94d9" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">Celery网站将其描述为“一个简单、灵活、可靠的分布式系统，用于处理大量消息，同时为运营提供维护这样一个系统所需的工具”。</p><p id="fdca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了使定义更简单，根据我们对本文的理解，celery是一个漂亮的python包，用于<strong class="is hj">异步处理</strong>。异步处理有助于我们减少用户等待时间并提高响应速度。</p><p id="a24d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是芹菜的基本介绍，足以让我们继续学习。如需了解关于芹菜的更多信息，请点击此<a class="ae md" href="http://docs.celeryproject.org/en/latest/getting-started/introduction.html" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="02a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，现在让我们进入实现部分吧！！！</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="a3c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用以下命令创建一个django项目并安装celery包:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="5cd5" class="mn jy hi mj b fi mo mp l mq mr">pip install celery == 4.3.0 <br/>pip install django-celery   #For celery integration for django</span></pre><p id="7d77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Celery使用<a class="ae md" href="http://docs.celeryproject.org/en/latest/getting-started/brokers/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">代理</strong> </a> <strong class="is hj"> </strong>在客户机和工人之间传输消息，因为celery通过消息进行通信。最常用的经纪人有:</p><ol class=""><li id="ea34" class="kv kw hi is b it iu ix iy jb lo jf lp jj lq jn lc ld le lf bi translated"><a class="ae md" href="http://docs.celeryproject.org/en/latest/getting-started/brokers/rabbitmq.html" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="ms"/></strong></a></li><li id="c0f9" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><a class="ae md" href="http://docs.celeryproject.org/en/latest/getting-started/brokers/redis.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> Redis </strong> </a></li></ol><p id="2d2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我同意Redis broker的观点。使用以下命令安装Redis:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="ab8b" class="mn jy hi mj b fi mo mp l mq mr">pip install redis == 3.3.8</span></pre><p id="95e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并且在这里下载windows <a class="ae md" href="https://dingyuliang.me/redis-3-2-install-redis-windows/" rel="noopener ugc nofollow" target="_blank">的redis zip文件(Redis 3.2.0.zip)并解压。使用以下命令运行redis服务器:</a></p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="9db1" class="mn jy hi mj b fi mo mp l mq mr">cd &lt;directory path of redis folder&gt;<br/>redis-server</span></pre><figure class="me mf mg mh fd ij er es paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="er es mt"><img src="../Images/691d037658b51fe170e51e9df666dec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5TKc5tyjrLmJXDF1prwVvQ.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">运行redis服务器</figcaption></figure><p id="647a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>仅安装高于3.2.0的版本。</p><p id="2e9b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，现在我们完成了芹菜的摆放。让我们继续配置django项目中的芹菜。</p><h2 id="4b2e" class="mn jy hi bd jz my mz na kd nb nc nd kh jb ne nf kl jf ng nh kp jj ni nj kt nk bi translated"><strong class="ak">配置芹菜至Django项目:</strong></h2><p id="4a6f" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">创建一个django项目，并打开在应用程序中创建的__init.py__文件。对我来说，它是<strong class="is hj">【核心】</strong>(应用名称)</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="46c6" class="mn jy hi mj b fi mo mp l mq mr">signals_celery example<br/>|core<br/>  |---&gt; __init__.py<br/>  |---&gt; settings.py<br/>  |---&gt; urls.py<br/>  |---&gt; wsgi.py</span></pre><p id="eaf8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<strong class="is hj"> core/__init.py__ </strong>中，复制这段代码:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="cd3e" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">from </strong>__future__ <strong class="mj hj">import </strong>absolute_import<br/><br/># This will make sure the app is always imported when<br/># Django starts so that shared_task will use this app.<br/><strong class="mj hj">from </strong>.celery <strong class="mj hj">import </strong>app <strong class="mj hj">as </strong>celery_app<br/><br/>__all__ = ('celery_app',)</span></pre><p id="d260" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在您的应用程序文件夹中创建一个名为<strong class="is hj"> core/celery.py </strong>的文件(在我的例子中是<strong class="is hj"> core </strong>文件夹),并添加以下几行:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="2387" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">from </strong>__future__ <strong class="mj hj">import </strong>absolute_import<br/><strong class="mj hj">import </strong>os<br/><strong class="mj hj">from </strong>celery <strong class="mj hj">import </strong>Celery<br/><strong class="mj hj">from </strong>django.conf <strong class="mj hj">import </strong>settings<br/><br/># set the default Django settings module for the 'celery' program.<br/><br/>os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')<br/>app = Celery('core', broker='redis://localhost')<br/><br/># Using a string here means the worker will not have to<br/># pickle the object when using Windows.<br/><br/>app.config_from_object('django.conf:settings', namespace='CELERY')<br/>app.autodiscover_tasks(<strong class="mj hj">lambda</strong>: settings.INSTALLED_APPS)<br/><br/><br/>@app.task(bind=True)<br/><strong class="mj hj">def debug_task</strong>(self):<br/>    <strong class="mj hj">print</strong>('Request: {0!r}'.format(self.request))</span></pre><p id="e4cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">而在<strong class="is hj"> core/settings.py </strong>中，</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="f728" class="mn jy hi mj b fi mo mp l mq mr"># CELERY related settings<br/>BROKER_URL = 'redis://localhost:6379'<br/>CELERY_RESULT_BACKEND = 'redis://localhost:6379'<br/>CELERY_ACCEPT_CONTENT = ['application/json']<br/>CELERY_TASK_SERIALIZER = 'json'<br/>CELERY_RESULT_SERIALIZER = 'json'<br/>CELERY_TIMEZONE = 'Asia/Kolkata'</span></pre><p id="6c7c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就是这样！！！配置完成。不，我们可以用芹菜来运行django项目中的任务。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="4d3a" class="jx jy hi bd jz ka ly kc kd ke lz kg kh ki ma kk kl km mb ko kp kq mc ks kt ku bi translated"><strong class="ak">使用Django信号:</strong></h1><p id="861c" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">在我们进入Djnago signals之前，让我们在django项目中创建另一个应用程序(在我的例子中是<strong class="is hj">‘main app’</strong>)。</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="cb64" class="mn jy hi mj b fi mo mp l mq mr">signals_celery example<br/>|-- core<br/>|   |---&gt; __init__.py<br/>|   |---&gt; settings.py<br/>|   |---&gt; urls.py<br/>|   |---&gt; wsgi.py<br/>|-- mainapp<br/>    |---&gt; migrations<br/>    |---&gt; __init__.py<br/>    |---&gt; models.py<br/>    |---&gt; admin.py<br/>    |---&gt; apps.py<br/>    |---&gt; views.py<br/>    |---&gt; tests.py<br/>    |---&gt; urls.py</span></pre><p id="b668" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在<strong class="is hj"> models.py </strong>中创建一个示例模型:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="8144" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">class InputImages</strong>(models.Model):<br/>    comparison_set_name = models.CharField(max_length=100)<br/>    input_image = models.ImageField(<br/>        upload_to='/path/InputImages',<br/>        max_length=254,<br/>        blank=<strong class="mj hj">True</strong>,<br/>        null=<strong class="mj hj">True</strong>)<br/>    standard_image = models.ImageField(<br/>        upload_to='/path/StandardImages',<br/>        max_length=254,<br/>        blank=<strong class="mj hj">True</strong>,<br/>        null=<strong class="mj hj">True</strong>)<br/><br/>    <strong class="mj hj">def </strong>__str__(self):<br/>        <strong class="mj hj">return </strong>self.comparison_set_name</span><span id="cbd7" class="mn jy hi mj b fi nl mp l mq mr"><strong class="mj hj">class OutputImage</strong>(models.Model):<br/>    input_key = models.ForeignKey(InputImages, on_delete=models.CASCADE)<br/>    output_image = models.ImageField(<br/>        upload_to='/path/OutputImages',<br/>        max_length=254,<br/>        blank=<strong class="mj hj">True</strong>,<br/>        null=<strong class="mj hj">True</strong>)<br/><br/>    <strong class="mj hj">def </strong>__str__(self):<br/>        <strong class="mj hj">return </strong>self.input_key.comparison_set_name</span></pre><p id="ae34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，<strong class="is hj"> InputImages </strong>模型有两个imagefields，它们接受两个输入图像，并使用某种openCV算法进行比较，然后存储在<strong class="is hj"> OutputImage </strong>模型中。</p><p id="3187" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那么，信号和芹菜在这里是怎么回事呢？？？</p><p id="afc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，只要保存了InputImages的模型实例，就会触发一个信号(<strong class="is hj"> post_save信号</strong>)来调用celery任务，该任务运行openCV算法来比较两个输入图像并将其保存到OutputImage模型。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="f0d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，现在让我们继续信号部分…</p><p id="ef4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Django包括一个“信号调度器”,当框架中的其他地方发生动作时，它可以帮助解耦的应用程序得到通知。</p><p id="a5b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一些常见的内置信号包括:<strong class="is hj"> pre_save，post_save，pre_delete，post_delete，pre_init，post_int </strong>等。</p><p id="b4c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要阅读更多关于Django信号的信息，请点击<a class="ae md" href="https://docs.djangoproject.com/en/2.2/topics/signals/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="a549" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们使用<strong class="is hj"> post_save信号</strong>来完成我们的工作。</p><p id="8aae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要在django项目中使用信号，我们可以通过两种方式来实现。现在，我在我们的应用程序配置文件中注册信号。</p><p id="df8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们设置信号部分…</p><p id="c19f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们将这段代码添加到<strong class="is hj"> mainapp/apps.py </strong>中:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="a1b2" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">from </strong>django.apps <strong class="mj hj">import </strong>AppConfig<br/><br/><br/><strong class="mj hj">class MainappConfig</strong>(AppConfig):<br/>    name = 'mainapp'  <strong class="mj hj">## write your app name here</strong><br/><br/>    <strong class="mj hj">def ready</strong>(self):<br/>        <strong class="mj hj">import </strong>mainapp.signals</span></pre><p id="31f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以及到<strong class="is hj"> mainapp/__init__。py </strong>，</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="6d25" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">## write according to your app name here<br/></strong>default_app_config = 'mainapp.apps.MainappConfig'</span></pre><p id="d506" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注</strong>:main app/_ _ init _ _<strong class="is hj">。如果您已经在<code class="du nm nn no mj b">INSTALLED_APPS</code>设置中引用AppConfig，则不需要py </strong>位。</p><p id="72dd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">稍后，在我们创建的应用程序中创建一个名为<strong class="is hj">‘signals . py’</strong>的文件(在我的例子中，它是<strong class="is hj"> mainapp </strong>)并复制以下代码:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="83c6" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">from </strong>django.db.models.signals <strong class="mj hj">import </strong>post_save<br/><strong class="mj hj">from </strong>django.dispatch <strong class="mj hj">import </strong>receiver<br/><strong class="mj hj">from mainapp</strong>.models <strong class="mj hj">import </strong>*<br/><strong class="mj hj">from </strong>mainapp.tasks <strong class="mj hj">import </strong>save_image_to_models<br/><br/><br/>@receiver(post_save, sender=InputImages)<br/><strong class="mj hj">def save_image_to_model</strong>(sender, **kwargs):<br/>    save_image_to_models.delay()</span></pre><p id="466b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，创建一个文件<strong class="is hj">‘main app/tasks . py’</strong>，通过触发信号可以用celery执行该文件。</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="c7c7" class="mn jy hi mj b fi mo mp l mq mr"><strong class="mj hj">from </strong>celery <strong class="mj hj">import </strong>shared_task<br/><strong class="mj hj">import </strong>glob<br/><strong class="mj hj">import </strong>os<br/><strong class="mj hj">import </strong>io<br/><strong class="mj hj">from mainpp</strong>.models <strong class="mj hj">import </strong>*<br/><br/>@shared_task<br/><strong class="mj hj">def save_image_to_models</strong>():<br/><br/>    results = InputImages.objects.all()<br/>    <strong class="mj hj">for </strong>result <strong class="mj hj">in </strong>results:<br/>        inp_image = result.input_image<br/>        std_image = result.standard_image<br/><br/>        """<br/>        Call your image_compare function here by passing the two images of the InputImages model<br/><br/>        Something like this: output_image = image_compare(std_image, inp_image)<br/><br/>        """<br/>        output = OutputImage.objects.create(output_image="""returned output_image by image_compare function""",input_key=result)</span></pre><p id="da13" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好吧！！！让我解释一下在<strong class="is hj"> save_image_to_models </strong>函数中发生了什么。</p><p id="02be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> image_compare </strong>函数获取输入图像(image_a &amp; image_b)，应用一些图像比较算法并返回比较后的差异图像，该差异图像最终可以保存到我们<strong class="is hj"> OutputImage的</strong> <strong class="is hj"> output_image </strong>字段中。</p><p id="d3eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> save_image_to_models </strong>函数是我们项目中的主要任务。它上面的装饰器'<strong class="is hj"> @shared_task </strong>'会将函数注册为芹菜任务，并将其添加到队列中，如下所示:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="a371" class="mn jy hi mj b fi mo mp l mq mr">save_image_to_models.delay()</span></pre><p id="f339" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，django信号的设置已经完成，我们的芹菜任务也已定义。现在让我们运行项目。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="43ee" class="jx jy hi bd jz ka ly kc kd ke lz kg kh ki ma kk kl km mb ko kp kq mc ks kt ku bi translated"><strong class="ak">跑吧！！！</strong></h1><p id="cf12" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">现在一切都准备好起飞了。在终端中使用以下命令启动django项目:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="f477" class="mn jy hi mj b fi mo mp l mq mr"># migrations commands<br/>python manage.py makemigrations<br/>python manage.py migrate</span><span id="99bc" class="mn jy hi mj b fi nl mp l mq mr"># runserver command<br/>python manage.py runserver</span></pre><p id="786d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开另一个终端并运行redis服务器:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="35b0" class="mn jy hi mj b fi mo mp l mq mr">cd &lt;directory path of redis folder&gt;<br/>redis-server</span></pre><p id="5139" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，使用以下命令在另一个终端中运行celery:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="dd76" class="mn jy hi mj b fi mo mp l mq mr">celery worker -A &lt;your default app name (core in my case)&gt; --pool=solo -l info</span></pre><figure class="me mf mg mh fd ij er es paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="er es np"><img src="../Images/a90fd41ecfada37c330b829b186dbe92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LIy9kc7X8pZSbKhJ0jzufg.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">芹菜成功运转</figcaption></figure><p id="cf65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">干杯！！！该项目正在成功运行。我们现在需要做的只是在InputImages模型中上传两张图像，并<strong class="is hj">保存</strong>它们以<strong class="is hj">触发</strong><strong class="is hj">post _ save信号</strong>到<strong class="is hj">调用芹菜任务。</strong>任务将被添加到队列中，并且<strong class="is hj">保存_图像_到_模型</strong>功能将被执行。</p><p id="2ebf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，输出图像存储在<strong class="is hj">输出图像</strong>模型中。</p><h1 id="6cac" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">工艺流程:</strong></h1><p id="1247" class="pw-post-body-paragraph iq ir hi is b it kx iv iw ix ky iz ja jb ll jd je jf lm jh ji jj ln jl jm jn hb bi translated">所以，我们现在到了本文的最后一部分。先来了解一下这个项目的工艺流程。</p><p id="9f67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当图像与输入图像模型中的图像字段一起上传并保存时，save方法被调用，并最终触发<strong class="is hj"> post_save </strong>信号。“@receiver”装饰器接收来自发送方的信号，即<strong class="is hj"> InputImages </strong>模型，并执行该行</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="fcd0" class="mn jy hi mj b fi mo mp l mq mr">save_image_to_models.delay()</span></pre><p id="c210" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它调用芹菜任务'<strong class="is hj"> save_image_to_models </strong>'函数并添加到队列中，异步执行开始。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="d3fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我希望这篇文章能帮助你在django项目中使用django信号触发芹菜异步任务。正如我提到的，这是我的第一篇关于Medium的文章，我欢迎对我的文章提出任何建议和修改，并非常乐意知道任何改进和建议，以提高我在Medium上写更多文章的技能。</p><p id="64f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">期待在这次学习之旅中写更多的帖子，传播知识。特别感谢我的导师<a class="nq nr ge" href="https://medium.com/u/49832c901195?source=post_page-----cb2876ebd494--------------------------------" rel="noopener" target="_blank">vibash Chandra</a>建议我写文章，分享知识。</p><p id="38a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读…玩得开心，传播知识！！！</p><p id="d1a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">奖金！！！</strong>你可以从<a class="ae md" href="https://github.com/srinivas175/celery_signal_example" rel="noopener ugc nofollow" target="_blank">这个</a> github repo中克隆完整的代码。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="ee67" class="jx jy hi bd jz ka ly kc kd ke lz kg kh ki ma kk kl km mb ko kp kq mc ks kt ku bi translated"><strong class="ak">参考文献:</strong></h1><ol class=""><li id="e2dc" class="kv kw hi is b it kx ix ky jb kz jf la jj lb jn lc ld le lf bi translated"><a class="ae md" href="https://docs.djangoproject.com/en/2.2/topics/signals/" rel="noopener ugc nofollow" target="_blank">https://docs.djangoproject.com/en/2.2/topics/signals/</a></li><li id="2eec" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><a class="ae md" href="https://simpleisbetterthancomplex.com/tutorial/2016/07/28/how-to-create-django-signals.html" rel="noopener ugc nofollow" target="_blank">https://simpleisbetterthancomplex . com/tutorial/2016/07/28/how-to-create-django-signals . html</a></li><li id="0511" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><a class="ae md" href="http://docs.celeryproject.org/en/master/django/first-steps-with-django.html" rel="noopener ugc nofollow" target="_blank">http://docs . celery project . org/en/master/django/first-steps-with-django . html</a></li><li id="093a" class="kv kw hi is b it lg ix lh jb li jf lj jj lk jn lc ld le lf bi translated"><a class="ae md" href="http://docs.celeryproject.org/en/latest/getting-started/index.html" rel="noopener ugc nofollow" target="_blank">http://docs . celery project . org/en/latest/getting-started/index . html</a></li></ol></div></div>    
</body>
</html>