<html>
<head>
<title>Object Detection using Azure ML Service — AutoML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure ML服务的对象检测— AutoML</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/object-detection-using-azure-ml-service-automl-b061035aa7d3?source=collection_archive---------19-----------------------#2020-08-22">https://medium.com/analytics-vidhya/object-detection-using-azure-ml-service-automl-b061035aa7d3?source=collection_archive---------19-----------------------#2020-08-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/a9a56287bdeed708e80d7130b2a57038.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/0*kojP27qnu8575LED"/></div></figure><h1 id="5c1d" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">使用Azure ML Assist数据标签工具的输出并构建模型</h1><p id="4a08" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">了解如何轻松构建端到端对象检测，包括标记和建模。也正在部署。</p><h1 id="e6e7" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">先决条件</h1><ul class=""><li id="07b0" class="ki kj hi jm b jn jo jr js jv kk jz kl kd km kh kn ko kp kq bi translated">创建blob容器</li><li id="879c" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">创建列车文件夹</li><li id="37ec" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">基于目录从<a class="ae kw" href="https://github.com/balakreshnan/mlops/blob/master/MLAssitDataLabelling/AMLtoJson.md" rel="noopener ugc nofollow" target="_blank">https://github . com/balakreshnan/mlops/blob/master/MLAssitDataLabelling/AML tojson . MD</a>移动所有图像</li><li id="6742" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">目录结构应遵循“AML datastore://storimagesjson/train/no stock/imagname . jpg”</li><li id="fd59" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">对于上面的例子，storeimagesjson是容器名</li><li id="7b75" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">火车是主文件夹，我创建的类是另一个名为nostock的文件夹</li><li id="cb39" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">然后把图像放在那里</li><li id="141f" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">对于注释文件，将其放置在train文件夹下</li><li id="2d0d" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">Azure ML服务仅支持以下地区:eastus，eastus2</li><li id="354e" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">我只测试eastus2</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="3def" class="lg in hi lc b fi lh li l lj lk">blobContainer <br/> /train /nostock <br/> /test /nostock <br/> /annotation.jsonl</span></pre><h1 id="3113" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">更新azure ml sdk</h1><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="b329" class="lg in hi lc b fi lh li l lj lk">pip install --upgrade azureml-sdk <br/>pip install --upgrade azureml-contrib-automl-dnn-vision <br/>print("SDK version:", azureml.core.VERSION)</span></pre><h1 id="285c" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">构建新的模型训练代码。</h1><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="ed8c" class="lg in hi lc b fi lh li l lj lk">import logging<br/>import os<br/>import csv<br/><br/>import numpy as np<br/>import pandas as pd<br/>from sklearn import datasets<br/><br/>import azureml.core<br/>from azureml.core import Run, Workspace<br/>from azureml.core.experiment import Experiment<br/>from azureml.core.workspace import Workspace<br/>from azureml.train.automl import AutoMLConfig<br/>import azureml.dataprep as dprep<br/>from azureml.core.dataset import Dataset</span><span id="530a" class="lg in hi lc b fi ll li l lj lk">ws = Workspace.from_config()</span><span id="7ef2" class="lg in hi lc b fi ll li l lj lk">experiment_name = 'labeling_Training_xxxxxxx'<br/>project_folder = './project'<br/><br/>experiment = Experiment(ws, experiment_name)<br/><br/>output = {}<br/>output['SDK version'] = azureml.core.VERSION<br/>output['Subscription ID'] = ws.subscription_id<br/>output['Workspace Name'] = ws.name<br/>output['Resource Group'] = ws.resource_group<br/>output['Location'] = ws.location<br/>output['Project Directory'] = project_folder<br/>output['Experiment Name'] = experiment.name<br/>pd.set_option('display.max_colwidth', -1)<br/>outputDf = pd.DataFrame(data = output, index = [''])<br/>outputDf.T</span></pre><ul class=""><li id="8bf3" class="ki kj hi jm b jn lm jr ln jv lo jz lp kd lq kh kn ko kp kq bi translated">实验名称是我从数据标签项目中提取的，在项目主页中，您应该可以看到列车运行实验名称。复制并粘贴到这里</li><li id="3ef3" class="ki kj hi jm b jn kr jr ks jv kt jz ku kd kv kh kn ko kp kq bi translated">设置计算</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="20a4" class="lg in hi lc b fi lh li l lj lk">from azureml.core.compute import AmlCompute<br/>from azureml.core.compute import ComputeTarget<br/><br/># Choose a name for your cluster.<br/>amlcompute_cluster_name = "gpucluster"<br/><br/>found = False<br/># Check if this compute target already exists in the workspace.<br/>cts = ws.compute_targets<br/>if amlcompute_cluster_name in cts and cts[amlcompute_cluster_name].type == 'AmlCompute':<br/>    found = True<br/>    print('Found existing compute target.')<br/>    compute_target = cts[amlcompute_cluster_name]<br/><br/>if not found:<br/>    print('Creating a new compute target...')<br/>    provisioning_config = AmlCompute.provisioning_configuration(vm_size = "STANDARD_NC6",<br/>                                                                max_nodes = 4)<br/><br/>    # Create the cluster.\n",<br/>    compute_target = ComputeTarget.create(ws, amlcompute_cluster_name, provisioning_config)<br/><br/>    # Can poll for a minimum number of nodes and for a specific timeout.<br/>    # If no min_node_count is provided, it will use the scale settings for the cluster.<br/>    compute_target.wait_for_completion(show_output = True, min_node_count = None, timeout_in_minutes = 20)<br/><br/>     # For a more detailed view of current AmlCompute status, use get_status().</span><span id="2125" class="lg in hi lc b fi ll li l lj lk">from azureml.core.datastore import Datastore<br/><br/>account_key = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"<br/>ds = Datastore.register_azure_blob_container(ws, datastore_name='containername', container_name='containername', <br/>                                             account_name='storageaccountname', account_key=account_key,<br/>                                             resource_group='resourcegroupname')</span><span id="e5b7" class="lg in hi lc b fi ll li l lj lk">from azureml.core.runconfig import RunConfiguration<br/>from azureml.core.conda_dependencies import CondaDependencies<br/>import pkg_resources<br/><br/># create a new RunConfig object<br/>conda_run_config = RunConfiguration(framework="python")<br/><br/># Set compute target to AmlCompute<br/>conda_run_config.target = compute_target<br/>conda_run_config.environment.docker.enabled = True<br/>conda_run_config.environment.docker.base_image = azureml.core.runconfig.DEFAULT_GPU_IMAGE<br/><br/>cd = CondaDependencies()<br/><br/>conda_run_config.environment.python.conda_dependencies = cd</span><span id="98f9" class="lg in hi lc b fi ll li l lj lk">from azureml.contrib.dataset.labeled_dataset import _LabeledDatasetFactory<br/>from azureml.core import Dataset<br/><br/># create training dataset<br/>training_dataset_name = experiment_name + "_training_dataset"<br/>if training_dataset_name in ws.datasets:<br/>    training_dataset = ws.datasets.get(training_dataset_name)<br/>    print('Found the dataset', training_dataset_name)<br/>else:<br/>    training_dataset = _LabeledDatasetFactory.from_json_lines(<br/>        task="ImageClassification", path=ds.path('train/annotation.jsonl'))<br/>    training_dataset = training_dataset.register(workspace=ws, name=training_dataset_name)</span><span id="3ff2" class="lg in hi lc b fi ll li l lj lk">automl_settings = {<br/>    "iteration_timeout_minutes": 1000,<br/>    "iterations": 1,<br/>    "primary_metric": 'mean_average_precision',<br/>    "featurization": 'off',<br/>    "enable_dnn": True,<br/>    "dataset_id": training_dataset.id<br/>}<br/>automl_config = AutoMLConfig(task = 'image-object-detection',<br/>                             debug_log = 'automl_errors_1.log',<br/>                             path = project_folder,<br/>                             run_configuration=conda_run_config,<br/>                             training_data = training_dataset,<br/>                             label_column_name = "label",<br/>                             **automl_settings<br/>                            )</span><span id="f741" class="lg in hi lc b fi ll li l lj lk">remote_run = experiment.submit(automl_config, show_output = False)</span><span id="cdde" class="lg in hi lc b fi ll li l lj lk">remote_run<br/>remote_run.wait_for_completion()</span><span id="5652" class="lg in hi lc b fi ll li l lj lk">Part 3: Deploying the above model to REST API</span><span id="e8a5" class="lg in hi lc b fi ll li l lj lk"><a class="ae kw" href="https://github.com/balakreshnan/mlops/blob/master/MLAssitDataLabelling/MLAssitObjScoring.md" rel="noopener ugc nofollow" target="_blank">https://github.com/balakreshnan/mlops/blob/master/MLAssitDataLabelling/MLAssitObjScoring.md</a></span><span id="246f" class="lg in hi lc b fi ll li l lj lk">Share your thoughts and comments.</span></pre></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="8efd" class="pw-post-body-paragraph jk jl hi jm b jn lm jp jq jr ln jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh hb bi translated"><em class="mb">最初发表于</em><a class="ae kw" href="https://github.com/balakreshnan/mlops/blob/master/MLAssitDataLabelling/MLAssitObjDetectionTraining.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="mb">。</em></p></div></div>    
</body>
</html>