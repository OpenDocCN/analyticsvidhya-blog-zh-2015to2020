<html>
<head>
<title>Fast.ai / PyTorch: Transfer Learning using Resnet34 on a self-made small dataset (262 images)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Fast.ai / PyTorch:在自制的小数据集(262张图片)上使用Resnet34进行迁移学习</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/fast-ai-pytorch-transfer-learning-using-resnet34-on-a-self-made-small-dataset-262-images-17003c9af3ce?source=collection_archive---------4-----------------------#2019-12-28">https://medium.com/analytics-vidhya/fast-ai-pytorch-transfer-learning-using-resnet34-on-a-self-made-small-dataset-262-images-17003c9af3ce?source=collection_archive---------4-----------------------#2019-12-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="6ac1" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="b9bc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我目前正在上fast.ai的深度学习课程。为了应用我在第一课中学到的概念，我使用了在ENSEEIHT的机器学习实验室中创建的一个非常小的数据集来进行图像分类。</p><p id="a79f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">该数据集由264张手做“纸”、“石头”和“剪刀”手势的照片组成，如下所示:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kg"><img src="../Images/c15f86d80b8c087418fe3efd3c4f53e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*FaP3bH2XNXbfSnPaJjR8Rg.png"/></div></figure><p id="c397" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这些照片是用智能手机拍摄的。它涉及一个由9名学生组成的小组(我是数据集创建过程的一部分),在数据科学领域攻读ENSEEIHT(图卢兹)硕士学位。我们试图改变背景和我们手的位置/方向，以在数据集中获得尽可能多的可变性。</p><p id="1606" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这些图片被组织在三个文件夹中:<strong class="jf hj">石头、剪刀、布。</strong>每个对应一个类。</p><p id="f1c5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我保留了20%的数据集用于验证。我使用Fastai库(在PyTorch之上)来加载Resnet34，并重新训练它最后的密集层来识别“纸”、“石头”和“剪刀”手势。</p><h1 id="3a48" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">库和主要依赖项</h1><ol class=""><li id="9638" class="ko kp hi jf b jg jh jk jl jo kq js kr jw ks ka kt ku kv kw bi translated">用于GPU的Google Colab</li><li id="160c" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka kt ku kv kw bi translated">Fastai v 1.0.52</li><li id="f47f" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka kt ku kv kw bi translated">PyTorch v1</li></ol><p id="541a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Fastai是一个建立在PyTorch之上的令人惊叹的库，它使深度学习更加直观，并使它需要更少的代码行。想了解更多信息，你应该去他们的文档网站:<a class="ae lc" href="https://docs.fast.ai/" rel="noopener ugc nofollow" target="_blank">https://docs.fast.ai/</a></p><h1 id="e0ff" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">入门指南</h1><ul class=""><li id="b637" class="ko kp hi jf b jg jh jk jl jo kq js kr jw ks ka ld ku kv kw bi translated">在google colab上运行任何东西之前，我需要告诉colab我对使用GPU感兴趣。我点击了“运行时”选项卡，并选择了“更改运行时类型”。一个弹出窗口打开了一个下拉菜单。我从菜单中选择了“GPU”，然后点击“保存”。</li><li id="7468" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka ld ku kv kw bi translated">在我开始使用我的笔记本之前，我需要安装必要的软件包。为此，我创建了一个代码单元，并运行:</li></ul><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="1380" class="lj ig hi lf b fi lk ll l lm ln"><strong class="lf hj">!</strong>curl -s https://course.fast.ai/setup/colab | bash</span></pre><p id="0ff8" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">接下来的几行代码将执行以下操作:</p><ul class=""><li id="f0c1" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">在Colab上挂载Google Drive来访问数据集，并设置我的数据集路径</li></ul><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="3840" class="lj ig hi lf b fi lk ll l lm ln">from google.colab import drive<br/>drive.mount('/content/gdrive', force_remount=True)<br/>root_dir = "/content/gdrive/My Drive/"<br/>base_dir = root_dir + 'VALDOM/PHOTO_MAIN_VALDOM'</span></pre><ul class=""><li id="848c" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">创建一个文件夹，我可以在需要时保存输出，并使用<code class="du lr ls lt lf b">%autoreload</code>自动重新加载任何更新的模块</li></ul><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="f3a8" class="lj ig hi lf b fi lk ll l lm ln">from fastai.imports import *<br/>path = Path(base_dir)<br/>dest = path/"folder"<br/>dest.mkdir(parents=True, exist_ok=True)</span><span id="3ee8" class="lj ig hi lf b fi lu ll l lm ln">%reload_ext autoreload<br/>%autoreload 2<br/>%matplotlib inline</span></pre><ul class=""><li id="d31c" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">从fastai进口</li></ul><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="4613" class="lj ig hi lf b fi lk ll l lm ln">from fastai.vision import *<br/>from fastai.metrics import error_rate</span></pre><h1 id="cd0d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">加载数据</h1><p id="be00" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">由于图像是按文件夹分类的，使用<code class="du lr ls lt lf b">from_folder</code>方法使用<code class="du lr ls lt lf b">ImageDataBunch</code>很方便。</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="d8e5" class="lj ig hi lf b fi lk ll l lm ln">data = ImageDataBunch.from_folder(path, ds_tfms=get_transforms(), size=224, valid_pct = 0.2)<br/>data.classes</span></pre><p id="60a3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="lv"> Out : ['布'，'石头'，'剪刀'] </em></p><p id="8e78" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">基本上，<code class="du lr ls lt lf b">from_folder</code>方法采用以下参数:</p><ul class=""><li id="2159" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">路径:图像数据集的路径</li><li id="8bca" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka ld ku kv kw bi translated">ds_tfms:应用于图像以扩充数据集的转换</li><li id="0535" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka ld ku kv kw bi translated">尺寸:图像尺寸/选择值:224 x224像素</li><li id="a7c0" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka ld ku kv kw bi translated">valid_pct : 0.2(即数据集的20%将用于验证，因为定型集和验证集没有特定的文件夹。</li></ul><p id="1424" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">数据的类型为<code class="du lr ls lt lf b">ImageDataBunch</code>并具有classes属性。从上面的代码中我们可以看到，我们的DataBunch成功地识别了三个标签:“布”、“剪刀”和“石头”。</p><p id="6958" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">data有一个叫做<code class="du lr ls lt lf b">show_batch</code>的简便方法，如果需要，它可以查看数据集的样本:</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="c95a" class="lj ig hi lf b fi lk ll l lm ln">data.show_batch(rows=3, figsize=(7,6))</span></pre><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lw"><img src="../Images/be26fb0d75c8747777fe4636bd457433.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*Exoui7HGCPDHuDgXLnGNNg.png"/></div></figure><h1 id="8097" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">训练模型</h1><p id="5c6a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">既然我们已经掌握了数据集，我们将训练模型。我们将使用<code class="du lr ls lt lf b">cnn_learner</code>函数，这是一个内置的fastai函数，加载著名的CNN(卷积神经网络)架构。</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="8303" class="lj ig hi lf b fi lk ll l lm ln">learn = cnn_learner(data, models.resnet34, metrics=accuracy)</span></pre><p id="8ede" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">基本上，函数需要以下三个参数:</p><ul class=""><li id="dd12" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">数据中心</li><li id="bee4" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka ld ku kv kw bi translated">要下载和训练的模型的规范(这里我们将使用一个resnet34)</li><li id="286b" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka ld ku kv kw bi translated">以及度量标准(我们在这里选择了准确性)</li></ul><p id="758a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们将在10个时期内进行培训</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="597f" class="lj ig hi lf b fi lk ll l lm ln">learn.fit_one_cycle(10)</span></pre><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lx"><img src="../Images/3a4e00f3112183dbe2eb6581e16d3210.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*pxJOyA2PEVVFvC-Ota1Phw.png"/></div></figure><p id="0e71" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">基本上，我们设法在一个非常小的数据集上获得了88.46%的准确率，这是一个很好的结果。</p><p id="7342" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">然后保存该模型并命名为(<code class="du lr ls lt lf b">stage-1</code>)</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="5bb2" class="lj ig hi lf b fi lk ll l lm ln">learn.save('stage-1')</span></pre><p id="d5cb" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">注意，我们只做了微调(即我们只训练了最后的密集层)</p><h1 id="6213" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">解释模型</h1><p id="ba1e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">不管怎么说，深度学习在一定程度上是可以解释的，Fastai库为此做好了准备。这里，我将使用一个叫做<code class="du lr ls lt lf b">ClassificationInterpretation</code>的便利工具，它可以帮助我们更好地理解我们的分类器。</p><p id="3933" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">例如，解释器可用于执行以下操作:</p><ul class=""><li id="4359" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">我们绘制具有最高损失值的验证数据样本(即，模型预测图像属于其实际类别的概率非常低的样本)</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es ly"><img src="../Images/56d790de2bfef6c55248a54a00e62b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DDJR3sbZLEbKOrONrDXkJA.png"/></div></div></figure><p id="02d6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在每个图片的顶部提供了预测类别、实际类别、损失和由属于其实际类别的图片的模型计算的概率。</p><ul class=""><li id="8ac7" class="ko kp hi jf b jg kb jk kc jo lo js lp jw lq ka ld ku kv kw bi translated">我们绘制了一个混淆矩阵</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es md"><img src="../Images/1ca16f77ea9ddf41944c022feef297c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tz2QlMbyyBD3JCxbDeP3GQ.png"/></div></div></figure><h1 id="1771" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">根据互联网上的随机手绘图片进行预测</h1><p id="a41b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们从互联网上下载了4张未标记的手相图片，并让我们的模型预测它们的类别。</p><p id="2668" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这些图像被保存在一个名为<code class="du lr ls lt lf b">random_hand_images</code>的文件夹中</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="0a99" class="lj ig hi lf b fi lk ll l lm ln">pred_path = Path(base_dir + '/random_hand_images')</span></pre><p id="1342" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们创建了一个Fastai <code class="du lr ls lt lf b">ImageList</code>,并对其进行迭代，以做出预测并显示结果</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="0ff1" class="lj ig hi lf b fi lk ll l lm ln">il = ImageList.from_folder(pred_path); il</span></pre><p id="cb67" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这给出了以下内容:</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="2230" class="lj ig hi lf b fi lk ll l lm ln">for img in il:<br/>   prediction = learn.predict(img)<br/>   img.show(figsize=(7,5), title = str(prediction[0]))</span></pre><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es me"><img src="../Images/c30af283b83621788f81c07e7f5f111b.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*CH1DzQoIYaON8jEEMr8iuQ.png"/></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es mf"><img src="../Images/f96ee097c247b91ff4c1942933b5529e.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*sDVbs4Vh_ga-tckvUpwNhg.png"/></div></figure><p id="9109" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这个模特把一把剪刀误认为是一只“石头”手。</p><h1 id="48b4" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="6fbb" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在这篇博客中，我们看到了迁移学习如何让我们在极小的数据集上取得相对较好的性能(&gt; 88%的准确率)。</p><p id="9738" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们也看到了Fastai的力量，以及它如何让深度学习变得简单明了。实际上，对于我们的问题，我们只需要4行代码来构建和保存我们的模型</p><pre class="kh ki kj kk fd le lf lg lh aw li bi"><span id="0133" class="lj ig hi lf b fi lk ll l lm ln"><em class="lv">#Load the dataset<br/></em>data = ImageDataBunch.from_folder(path, ds_tfms=get_transforms(), size=224, valid_pct = 0.2)</span><span id="9ca4" class="lj ig hi lf b fi lu ll l lm ln"><em class="lv">#Load learner object<br/></em>learn = cnn_learner(data, models.resnet34, metrics=accuracy)</span><span id="acd8" class="lj ig hi lf b fi lu ll l lm ln"><em class="lv">#Fit the model<br/></em>learn.fit_one_cycle(10)</span><span id="324c" class="lj ig hi lf b fi lu ll l lm ln"><em class="lv">#Save the model<br/></em>learn.save('stage-1')</span></pre><p id="3e12" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这是我笔记本的GitHub链接(可能有点乱，请原谅)</p><div class="mg mh ez fb mi mj"><a href="https://github.com/chou404/Rock_Scissor_Paper_FastAi_ResNet/blob/master/Rock_Scissors_Paper.ipynb" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">Chou 404/Rock _剪刀_纸张_FastAi_ResNet</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">github.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx km mj"/></div></div></a></div><p id="a9f6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果你喜欢我的文章，我恳请你分享并为之鼓掌:)</p><h1 id="68d3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">参考</h1><ol class=""><li id="08e7" class="ko kp hi jf b jg jh jk jl jo kq js kr jw ks ka kt ku kv kw bi translated">Fastai深度学习MOOC /第一课:<a class="ae lc" href="https://course.fast.ai/videos/?lesson=1" rel="noopener ugc nofollow" target="_blank">https://course.fast.ai/videos/?lesson=1</a></li><li id="e601" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka kt ku kv kw bi translated">Fastai深度学习MOOC /第一课讲义:【https://forums.fast.ai/t/deep-learning-lesson-1-notes/27748<a class="ae lc" href="https://forums.fast.ai/t/deep-learning-lesson-1-notes/27748" rel="noopener ugc nofollow" target="_blank"/></li><li id="5617" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka kt ku kv kw bi translated">PyTorch文档:【https://pytorch.org/docs/stable/index.html T4】</li><li id="0b68" class="ko kp hi jf b jg kx jk ky jo kz js la jw lb ka kt ku kv kw bi translated">Resnet论文:<a class="ae lc" href="https://arxiv.org/abs/1512.03385" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/abs/1512.03385</a></li></ol></div></div>    
</body>
</html>