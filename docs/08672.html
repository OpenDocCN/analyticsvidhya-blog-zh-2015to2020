<html>
<head>
<title>Building a face detector with OpenCV in C++</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç”¨C++ä¸­çš„OpenCVæ„å»ºäººè„¸æ£€æµ‹å™¨</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/analytics-vidhya/building-a-face-detector-with-opencv-in-c-8814cd374ea1?source=collection_archive---------8-----------------------#2020-08-08">https://medium.com/analytics-vidhya/building-a-face-detector-with-opencv-in-c-8814cd374ea1?source=collection_archive---------8-----------------------#2020-08-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c74877fab2baf31175de3586e48baba9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e82tkWya3Glo0mZ6"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">å¥¥ç±³å¾·Â·é˜¿æ˜åœ¨<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>ä¸Šæ‹æ‘„çš„ç…§ç‰‡</figcaption></figure><p id="f3cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘å°†è§£é‡Šå¦‚ä½•ç”¨<a class="ae iu" href="https://opencv.org/" rel="noopener ugc nofollow" target="_blank"> OpenCV </a>ä¸­çš„æœºå™¨å­¦ä¹ ç»„ä»¶æ„å»ºäººè„¸æ£€æµ‹ç®—æ³•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨OpenCVä»ç›¸æœºä¸­è¯»å–å›¾åƒå¹¶æ£€æµ‹å…¶ä¸­çš„äººè„¸ã€‚ç»“æœä¼šæ˜¯è¿™æ ·çš„ã€‚</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/50d637b2df3b0855170e08da3dd256b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*TmCkXXK1zADjM_2J.gif"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">è´å¤šèŠ¬è„¸è‰²é˜´æ²‰</figcaption></figure><p id="62be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä½ å¯ä»¥åœ¨æˆ‘çš„github ä¸Šæ‰¾åˆ°è¿™ç¯‡åšæ–‡<a class="ae iu" href="https://github.com/bewagner/visuals/tree/blog-post-1" rel="noopener ugc nofollow" target="_blank">çš„æ‰€æœ‰ä»£ç ã€‚</a></p><h1 id="9ef7" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">å®‰è£…OpenCV</h1><p id="85c9" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">æˆ‘ä»¬å°†ä½¿ç”¨OpenCVåŠå…¶OpenCV_contribæ¨¡å—çš„ä¸€äº›ç›¸å½“æ–°çš„éƒ¨åˆ†ã€‚ç¡®ä¿æ‚¨å¯ä»¥è®¿é—®è¿™äº›æ¨¡å—çš„æœ€æ–¹ä¾¿çš„æ–¹æ³•æ˜¯ä»æºä»£ç æ„å»ºOpenCVã€‚æˆ‘åœ¨Ubuntu 16.04ä¸Šç”¨çš„æ˜¯OpenCV 4 . 2 . 0ç‰ˆã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘åŒ…å«äº†ä¸€ä¸ªbashè„šæœ¬ï¼Œå®ƒè´Ÿè´£å®‰è£…æ­£ç¡®çš„OpenCVç‰ˆæœ¬ã€‚å®ƒè¿˜å°†å®‰è£…æ‰€æœ‰å¿…è¦çš„ä¾èµ–é¡¹ã€‚è„šæœ¬å­˜åœ¨äºGitHub repo é™„å¸¦çš„<a class="ae iu" href="https://github.com/bewagner/visuals/tree/blog-post-1" rel="noopener ugc nofollow" target="_blank">ä¸­ã€‚</a></p><p id="ec50" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬å°†ä½¿ç”¨çš„<code class="du lb lc ld le b">cv::dnn::Net</code>ç±»æ˜¯åœ¨3.4.10ç‰ˆæœ¬ä¸­æ·»åŠ åˆ°OpenCVä¸­çš„ï¼Œæ‰€ä»¥æ—©æœŸç‰ˆæœ¬å¯èƒ½ä¹Ÿé€‚ç”¨ã€‚ä½†æ˜¯ï¼Œæˆ‘æ²¡æœ‰æµ‹è¯•è¿™ä¸ªã€‚</p><h1 id="f74a" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">CMakeè®¾ç½®</h1><p id="06af" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">æˆ‘ä»¬å°†ä½¿ç”¨CMakeæ„å»ºæˆ‘ä»¬çš„ä»£ç ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¸¦æœ‰å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„CMakeé¡¹ç›®ï¼Œå¹¶å°†C++æ ‡å‡†è®¾ç½®ä¸º14ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="3501" class="lj jz hi le b fi lk ll l lm ln">cmake_minimum_required(VERSION 3.0) <br/>project(OpenCVFaceDetector LANGUAGES CXX)  </span><span id="b80b" class="lj jz hi le b fi lo ll l lm ln">add_executable(${PROJECT_NAME} main.cpp) target_compile_features(${PROJECT_NAME} PUBLIC cxx_std_14) target_include_directories(${PROJECT_NAME} PRIVATE include)</span></pre><p id="e282" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ç„¶åæˆ‘ä»¬å¤„ç†OpenCVä¾èµ–æ€§ã€‚æˆ‘ä»¬æ‰¾åˆ°<code class="du lb lc ld le b">OpenCV</code>åŒ…ï¼Œå¹¶æ ¹æ®å®ƒé“¾æ¥æˆ‘ä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="c3fc" class="lj jz hi le b fi lk ll l lm ln"># OpenCV setup <br/>find_package(OpenCV REQUIRED) <br/>target_link_libraries(${PROJECT_NAME} ${OpenCV_LIBS})</span></pre><p id="d98b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ•´ä¸ª<code class="du lb lc ld le b">CMakeLists.txt</code>æ–‡ä»¶åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="7292" class="lj jz hi le b fi lk ll l lm ln">cmake_minimum_required(VERSION 3.0) <br/>project(OpenCVFaceDetector LANGUAGES CXX)  <br/>add_executable(${PROJECT_NAME} main.cpp) target_compile_features(${PROJECT_NAME} PUBLIC cxx_std_14) target_include_directories(${PROJECT_NAME} PRIVATE include)  </span><span id="de67" class="lj jz hi le b fi lo ll l lm ln"># OpenCV setup find_package(OpenCV REQUIRED) target_link_libraries(${PROJECT_NAME} ${OpenCV_LIBS})</span></pre><h1 id="fe03" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">ä»ç›¸æœºä¸­è·å–å›¾åƒ</h1><p id="1d58" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è·å–ä¸€ä¸ªç›¸æœºå›¾åƒã€‚å¹¸è¿çš„æ˜¯ï¼Œ<code class="du lb lc ld le b">cv::videocapture</code>ç±»ä½¿è¿™å˜å¾—å®¹æ˜“ã€‚</p><p id="25da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬åŒ…å«äº†OpenCVå¤´æ¥è®¿é—®OpenCVçš„åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code class="du lb lc ld le b">cv::videocapture</code>å¯¹è±¡ï¼Œå¹¶å°è¯•æ‰“å¼€æˆ‘ä»¬èƒ½æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªç›¸æœºã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="b050" class="lj jz hi le b fi lk ll l lm ln">#include &lt;opencv4/opencv2/opencv.hpp&gt;  <br/>int main(int argc, char **argv) {<br/>      cv::VideoCapture video_capture;<br/>     if (!video_capture.open(0)) {<br/>         return 0;<br/>     }</span></pre><p id="6011" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code class="du lb lc ld le b">cv::Mat</code>æ¥ä¿å­˜è¯¥å¸§ï¼Œå¹¶åœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­æ˜¾ç¤ºå®ƒã€‚å¦‚æœç”¨æˆ·æŒ‰ä¸‹â€œEsc â€,æˆ‘ä»¬ä¸­æ–­å¾ªç¯ï¼Œç ´åæ˜¾ç¤ºçª—å£å¹¶é‡Šæ”¾è§†é¢‘æ•è·ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="1943" class="lj jz hi le b fi lk ll l lm ln">cv::Mat frame;<br/>    while (true) {<br/>        video_capture &gt;&gt; frame;<br/><br/>        imshow("Image", frame);<br/>        const int esc_key = 27;<br/>        if (cv::waitKey(10) == esc_key) { <br/>            break;<br/>        }<br/>    }<br/><br/>    cv::destroyAllWindows();<br/>    video_capture.release();<br/><br/>    return 0;<br/>}</span></pre><p id="b66d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åˆ°ç›®å‰ä¸ºæ­¢,<code class="du lb lc ld le b">main.cpp</code>æ–‡ä»¶å°†å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="b269" class="lj jz hi le b fi lk ll l lm ln">#include &lt;opencv4/opencv2/opencv.hpp&gt;  <br/>int main(int argc, char **argv) {<br/>      cv::VideoCapture video_capture;<br/>     if (!video_capture.open(0)) {<br/>         return 0;<br/>     }</span><span id="ba6e" class="lj jz hi le b fi lo ll l lm ln">     cv::Mat frame;<br/>     while (true) {<br/>         video_capture &gt;&gt; frame;<br/>         imshow("Image", frame);<br/>         const int esc_key = 27;<br/>         if (cv::waitKey(10) == esc_key) {<br/>              break;<br/>         }<br/>     }<br/>     cv::destroyAllWindows();<br/>     video_capture.release();<br/>     return 0;<br/> }</span></pre><p id="39eb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬ç°åœ¨å¯ä»¥æ˜¾ç¤ºä»æ‘„åƒæœºæ•æ‰åˆ°çš„å›¾åƒã€‚ğŸ˜€</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/c5589e5eca8523bc286a32e0c86179b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*CaPznQYmWPVbHFl-.gif"/></div></figure><h1 id="4ca2" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">ä½¿ç”¨<code class="du lb lc ld le b">cv:dnn::Net</code>ç±»åŠ è½½é¢„è®­ç»ƒçš„SSDäººè„¸æ£€æµ‹ç½‘ç»œ</h1><p id="cd12" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">ç°åœ¨æˆ‘ä»¬å°†å¼€å§‹å»ºç«‹ä¸€ä¸ªé¢éƒ¨æ£€æµ‹å™¨ã€‚æˆ‘ä»¬ä½¿ç”¨<code class="du lb lc ld le b">cv::dnn::Net</code>ç±»å¹¶ä»é¢„è®­ç»ƒçš„caffeæ¨¡å‹ä¸­åŠ è½½æƒé‡ã€‚</p><p id="efc6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å› ä¸ºå°†æ‰€æœ‰åŠŸèƒ½æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹å¾ˆå¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ºæ¨¡å‹åˆ›å»ºäº†ä¸€ä¸ªç±»<code class="du lb lc ld le b">FaceDetector</code>ã€‚æ‰€ä»¥é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæ–°æ–‡ä»¶<code class="du lb lc ld le b">src/FaceDetector.cpp</code>å’Œ<code class="du lb lc ld le b">include/FaceDetector.h</code>ã€‚ä¸ºäº†ç¡®ä¿æˆ‘ä»¬çš„ä»£ç ä»ç„¶å¯ä»¥æ„å»ºï¼Œæˆ‘ä»¬å°†å®ç°æ–‡ä»¶æ·»åŠ åˆ°CMakeç›®æ ‡ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè½¬åˆ°æ‚¨çš„<code class="du lb lc ld le b">CMakeLists.txt</code>ï¼Œå°†åŒ…å«<code class="du lb lc ld le b">add_executable(...)</code>çš„è¡Œæ›´æ”¹ä¸ºå¦‚ä¸‹æ‰€ç¤º</p><p id="4092" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lb lc ld le b">add_executable(${PROJECT_NAME} src/main.cpp src/FaceDetector.cpp)</code></p><p id="40f0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨<code class="du lb lc ld le b">include/FaceDetector.h</code>ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†è¿™ä¸ªç±»ã€‚è¯¥æ¨¡å‹æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­åŠ è½½æ¨¡å‹æƒé‡ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªæ–¹æ³•</p><p id="5cab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lb lc ld le b">std::vector&lt;cv::Rect&gt; detect_face_rectangles(const cv::Mat &amp;frame)</code></p><p id="fd1a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å®ƒæ¥æ”¶ä¸€ä¸ªè¾“å…¥å›¾åƒï¼Œç»™æˆ‘ä»¬ä¸€ä¸ªæ£€æµ‹åˆ°çš„äººè„¸å‘é‡ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="72de" class="lj jz hi le b fi lk ll l lm ln">#ifndef VISUALS_FACEDETECTOR_H <br/>#define VISUALS_FACEDETECTOR_H <br/>#include &lt;opencv4/opencv2/dnn.hpp&gt;  <br/>class FaceDetector { <br/>public:     <br/>explicit FaceDetector();<br/>/// Detect faces in an image frame <br/>/// \param frame Image to detect faces in <br/>/// \return Vector of detected faces     <br/>std::vector&lt;cv::Rect&gt; detect_face_rectangles(const cv::Mat &amp;frame);</span></pre><p id="a652" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬å°†å®é™…çš„ç½‘ç»œä¿å­˜åœ¨ç§æœ‰æˆå‘˜å˜é‡ä¸­ã€‚é™¤äº†æ¨¡å‹ï¼Œæˆ‘ä»¬è¿˜å°†ä¿å­˜</p><ul class=""><li id="62eb" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><code class="du lb lc ld le b">input_image_width/height_</code>è¾“å…¥å›¾åƒçš„å°ºå¯¸</li><li id="b337" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><code class="du lb lc ld le b">scale_factor_</code>å°†å›¾åƒè½¬æ¢ä¸ºæ•°æ®å—æ—¶çš„ç¼©æ”¾å› å­</li><li id="3cf3" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><code class="du lb lc ld le b">mean_values_</code>è®­ç»ƒç½‘ç»œçš„æ¯ä¸ªé€šé“çš„å¹³å‡å€¼ã€‚å°†å›¾åƒè½¬æ¢ä¸ºæ•°æ®blobæ—¶ï¼Œå°†ä»å›¾åƒä¸­å‡å»è¿™äº›å€¼ã€‚</li><li id="be21" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><code class="du lb lc ld le b">confidence_threshold_</code>æ£€æµ‹äººè„¸æ—¶ä½¿ç”¨çš„ç½®ä¿¡åº¦é˜ˆå€¼ã€‚è¯¥æ¨¡å‹å°†ä¸ºæ¯ä¸ªæ£€æµ‹åˆ°çš„é¢éƒ¨æä¾›ç½®ä¿¡åº¦å€¼ã€‚ç½®ä¿¡åº¦å€¼ä¸º&gt; = <code class="du lb lc ld le b">confidence_threshold_</code>çš„äººè„¸å°†è¢«ä¿ç•™ã€‚æ‰€æœ‰å…¶ä»–é¢éƒ½å°†è¢«ä¸¢å¼ƒã€‚</li></ul><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="cf6e" class="lj jz hi le b fi lk ll l lm ln">private:     <br/>/// Face detection network     <br/>cv::dnn::Net network_;     <br/>/// Input image width     <br/>const int input_image_width_;     <br/>/// Input image height     <br/>const int input_image_height_;     <br/>/// Scale factor when creating image blob     <br/>const double scale_factor_;     <br/>/// Mean normalization values network was trained with     <br/>const cv::Scalar mean_values_;     <br/>/// Face detection confidence threshold     <br/>const float confidence_threshold_;  <br/>};  <br/> <br/>#endif //VISUALS_FACEDETECTOR_H</span></pre><p id="a46d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å®Œæ•´çš„å¤´æ–‡ä»¶åœ¨è¿™é‡Œæ˜¯<a class="ae iu" href="https://github.com/bewagner/visuals/blob/blog-post-1/include/FaceDetector.h" rel="noopener ugc nofollow" target="_blank"/>ã€‚</p><p id="b627" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¼€å§‹å®ç°ä¸Šé¢å®šä¹‰çš„å‡½æ•°ã€‚æˆ‘ä»¬ä»æ„é€ å‡½æ•°å¼€å§‹ã€‚å¯¹äºå¤§å¤šæ•°æˆå‘˜å˜é‡ï¼Œæˆ‘ä»¬è¾“å…¥æ­£ç¡®çš„å€¼ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="1098" class="lj jz hi le b fi lk ll l lm ln">#include &lt;sstream&gt; <br/>#include &lt;vector&gt; <br/>#include &lt;string&gt; <br/>#include &lt;FaceDetector.h&gt; <br/>#include &lt;opencv4/opencv2/opencv.hpp&gt;  </span><span id="4d36" class="lj jz hi le b fi lo ll l lm ln">FaceDetector::FaceDetector() :<br/>     confidence_threshold_(0.5),<br/>     input_image_height_(300),<br/>     input_image_width_(300),<br/>     scale_factor_(1.0), <br/>     mean_values_({104., 177.0, 123.0}) {</span></pre><p id="1b1d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">åœ¨æ„é€ å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code class="du lb lc ld le b">cv::dnn::readNetFromCaffe</code>å°†æ¨¡å‹åŠ è½½åˆ°æˆ‘ä»¬çš„<code class="du lb lc ld le b">network_</code>å˜é‡ä¸­ã€‚<code class="du lb lc ld le b">cv::dnn::readNetFromCaffe</code>éœ€è¦ä¸¤ä¸ªæ–‡ä»¶æ¥æ„å»ºæ¨¡å‹:ç¬¬ä¸€ä¸ª<a class="ae iu" href="https://github.com/bewagner/visuals/blob/blog-post-1/assets/deploy.prototxt" rel="noopener ugc nofollow" target="_blank"> (deploy.prototxt) </a>æ˜¯æè¿°æ¨¡å‹æ¶æ„çš„æ¨¡å‹é…ç½®ã€‚ç¬¬äºŒä¸ª<a class="ae iu" href="https://github.com/bewagner/visuals/blob/blog-post-1/assets/res10_300x300_ssd_iter_140000_fp16.caffemodel" rel="noopener ugc nofollow" target="_blank">(res10 _ 300 x300 _ SSD _ ITER _ 140000 _ fp16 . caffemodel)</a>æ˜¯æ¨¡å‹æƒé‡çš„äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p id="0f49" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬å¯ä»¥åœ¨æ„å»ºåå°†è¿™äº›æ–‡ä»¶ç§»åŠ¨åˆ°åŒ…å«æˆ‘ä»¬çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„ç›®å½•ä¸­ã€‚ä½†æ˜¯è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ç›¸å½“è„†å¼±çš„ï¼Œå› ä¸ºå½“äºŒè¿›åˆ¶ç§»åŠ¨çš„æ—¶å€™å®ƒå°±å´©æºƒäº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡CMakeä¼ å…¥æ–‡ä»¶ä½ç½®ã€‚</p><h1 id="13d3" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">å¿«é€Ÿè·³å›æˆ‘ä»¬çš„CMakeé…ç½®</h1><p id="2dec" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">åœ¨è¿™ç¯‡StackOverflowæ–‡ç« ä¸­ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªä¼ é€’æ–‡ä»¶è·¯å¾„ç»™C++çš„å¥½æ–¹æ³•ã€‚ä»–ä»¬å»ºè®®å°†è·¯å¾„ä½œä¸º<code class="du lb lc ld le b">compile_definition</code>ä¼ é€’ç»™ç›®æ ‡ã€‚è¿™æ ·ï¼ŒCMakeå¯ä»¥è®¡ç®—å‡ºæ–‡ä»¶çš„æ­£ç¡®è·¯å¾„ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ä¸€ä¸ªå˜é‡ã€‚è¿™ä¸ªå˜é‡åœ¨C++ä¸­æ˜¯å¯ç”¨çš„ã€‚</p><p id="5e83" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å°†ä¸‹é¢å‡ è¡Œæ·»åŠ åˆ°CMakeLists.txtä¸­ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="b502" class="lj jz hi le b fi lk ll l lm ln"># Introduce preprocessor variables to keep paths of asset files set(FACE_DETECTION_CONFIGURATION<br/> "${PROJECT_SOURCE_DIR}/assets/deploy.prototxt")</span><span id="a1ce" class="lj jz hi le b fi lo ll l lm ln">set(FACE_DETECTION_WEIGHTS<br/> "${PROJECT_SOURCE_DIR}/assets/res10_300x300_ssd_iter_140000_fp16.caffemodel")  </span><span id="0f82" class="lj jz hi le b fi lo ll l lm ln">target_compile_definitions(${PROJECT_NAME} PRIVATE  FACE_DETECTION_CONFIGURATION="${FACE_DETECTION_CONFIGURATION}")  </span><span id="edef" class="lj jz hi le b fi lo ll l lm ln">target_compile_definitions(${PROJECT_NAME} PRIVATE  FACE_DETECTION_WEIGHTS="${FACE_DETECTION_WEIGHTS}")</span></pre><h1 id="fdb7" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">æ•´ç†<code class="du lb lc ld le b">FaceDetector.cpp</code>ä¸­çš„æ–¹æ³•</h1><p id="b808" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">æ—¢ç„¶æˆ‘ä»¬æ‰¾åˆ°äº†è®¿é—®å¿…è¦æ–‡ä»¶çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºæ¨¡å‹äº†ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="873f" class="lj jz hi le b fi lk ll l lm ln">FaceDetector::FaceDetector() :<br/>     confidence_threshold_(0.5),<br/>      input_image_height_(300),<br/>      input_image_width_(300),<br/>     scale_factor_(1.0),<br/>     mean_values_({104., 177.0, 123.0}) {<br/>         // Note: The variables MODEL_CONFIGURATION_FILE<br/>         // and MODEL_WEIGHTS_FILE are passed in via cmake<br/>         network_ = cv::dnn::readNetFromCaffe(FACE_DETECTION_CONFIGURATION,<br/>                 FACE_DETECTION_WEIGHTS);<br/>      if (network_.empty()) {<br/>         std::ostringstream ss;<br/>         ss &lt;&lt; "Failed to load network with the following settings:\n"<br/>            &lt;&lt; "Configuration: " + std::string(FACE_DETECTION_CONFIGURATION) + "\n"            <br/>            &lt;&lt; "Binary: " + std::string(FACE_DETECTION_WEIGHTS) + "\n";<br/>         throw std::invalid_argument(ss.str());<br/>     }</span></pre><p id="8862" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ¥ä¸‹æ¥å°±æ˜¯å®æ–½<code class="du lb lc ld le b">detect_face_rectangles</code>ã€‚æˆ‘ä»¬é¦–å…ˆå°†è¾“å…¥å›¾åƒè½¬æ¢æˆæ•°æ®å—ã€‚å‡½æ•°<code class="du lb lc ld le b"><a class="ae iu" href="https://www.pyimagesearch.com/2017/11/06/deep-learning-opencvs-blobfromimage-works/" rel="noopener ugc nofollow" target="_blank">cv::dnn::blobFromImage</a></code>è´Ÿè´£å°†å›¾åƒé‡æ–°ç¼©æ”¾åˆ°ç½‘ç»œçš„æ­£ç¡®è¾“å…¥å°ºå¯¸ã€‚å®ƒè¿˜ä¼šå‡å»æ¯ä¸ªé¢œè‰²é€šé“ä¸­çš„å¹³å‡å€¼ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="5c36" class="lj jz hi le b fi lk ll l lm ln">std::vector&lt;cv::Rect&gt; FaceDetector::detect_face_rectangles(const cv::Mat &amp;frame) {<br/>     cv::Mat input_blob = cv::dnn::blobFromImage(frame,<br/>             scale_factor_,<br/>             cv::Size(input_image_width_, input_image_height_),<br/>             mean_values_,<br/>             false,<br/>             false);</span></pre><p id="fbc4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç½‘ç»œè½¬å‘æˆ‘ä»¬çš„æ•°æ®ã€‚æˆ‘ä»¬å°†ç»“æœä¿å­˜åœ¨å˜é‡<code class="du lb lc ld le b">detection_matrix</code>ä¸­ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="e2b3" class="lj jz hi le b fi lk ll l lm ln">     network_.setInput(input_blob, "data");<br/>     cv::Mat detection = network_.forward("detection_out");<br/>     cv::Mat detection_matrix(detection.size[2],<br/>             detection.size[3],<br/>             CV_32F,<br/>             detection.ptr&lt;float&gt;());</span></pre><p id="1614" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">æˆ‘ä»¬éå†çŸ©é˜µçš„è¡Œã€‚æ¯è¡ŒåŒ…å«ä¸€ä¸ªæ£€æµ‹ã€‚å½“è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬æ£€æŸ¥ç½®ä¿¡åº¦å€¼æ˜¯å¦è¶…è¿‡æˆ‘ä»¬çš„é˜ˆå€¼ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬æ„é€ ä¸€ä¸ª<code class="du lb lc ld le b">cv::Rect</code>å¹¶ä¿å­˜åœ¨ç»“æœå‘é‡<code class="du lb lc ld le b">faces</code>ä¸­ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="57eb" class="lj jz hi le b fi lk ll l lm ln">std::vector&lt;cv::Rect&gt; faces;<br/><br/>    for (int i = 0; i &lt; detection_matrix.rows; i++) {<br/>        float confidence = detection_matrix.at&lt;float&gt;(i, 2);<br/><br/>        if (confidence &lt; confidence_threshold_) {<br/>            continue;<br/>        }<br/>        int x_left_bottom = static_cast&lt;int&gt;(<br/>                detection_matrix.at&lt;float&gt;(i, 3) * frame.cols);<br/><br/>        int y_left_bottom = static_cast&lt;int&gt;(<br/>                detection_matrix.at&lt;float&gt;(i, 4) * frame.rows);<br/><br/>        int x_right_top = static_cast&lt;int&gt;(<br/>                detection_matrix.at&lt;float&gt;(i, 5) * frame.cols);<br/><br/>        int y_right_top = static_cast&lt;int&gt;(<br/>                detection_matrix.at&lt;float&gt;(i, 6) * frame.rows);<br/><br/>        faces.emplace_back(x_left_bottom,<br/>                y_left_bottom,<br/>                (x_right_top - x_left_bottom),<br/>                (y_right_top - y_left_bottom));<br/>    }<br/><br/>    return faces;<br/>}</span></pre><p id="ef9d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">è¿™å°±ç»“æŸäº†æˆ‘ä»¬å¯¹<code class="du lb lc ld le b">FaceDetector</code>çš„å®ç°ã€‚ç‚¹å‡»<a class="ae iu" href="https://github.com/bewagner/visuals/blob/blog-post-1/src/FaceDetector.cpp" rel="noopener ugc nofollow" target="_blank">æ­¤</a>é“¾æ¥æŸ¥çœ‹å…¨æ–‡ã€‚cppæ–‡ä»¶ã€‚</p><h1 id="d688" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">å¯è§†åŒ–æ£€æµ‹åˆ°çš„äººè„¸</h1><p id="f87f" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">å› ä¸ºæˆ‘ä»¬å°†äººè„¸æ£€æµ‹å™¨å®ç°ä¸ºä¸€ä¸ªç±»ï¼Œæ‰€ä»¥å¯è§†åŒ–çŸ©å½¢å¾ˆå®¹æ˜“ã€‚é¦–å…ˆï¼ŒåŒ…å«<code class="du lb lc ld le b">FaceDetector.h</code>å¤´æ–‡ä»¶ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code class="du lb lc ld le b">FaceDetector</code>å¯¹è±¡å¹¶è°ƒç”¨<code class="du lb lc ld le b">detect_face_rectangles</code>æ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨OpenCVçš„<code class="du lb lc ld le b">rectangle</code>æ–¹æ³•åœ¨æ£€æµ‹åˆ°çš„äººè„¸ä¸Šç»˜åˆ¶ä¸€ä¸ªçŸ©å½¢ã€‚</p><pre class="ju jv jw jx fd lf le lg lh aw li bi"><span id="2c25" class="lj jz hi le b fi lk ll l lm ln">#include &lt;opencv4/opencv2/opencv.hpp&gt; <br/>#include "FaceDetector.h"<br/>int main(int argc, char **argv) {<br/>      cv::VideoCapture video_capture;<br/>     if (!video_capture.open(0)) {<br/>         return 0;<br/>     }</span><span id="c0c4" class="lj jz hi le b fi lo ll l lm ln">      FaceDetector face_detector;</span><span id="9e1b" class="lj jz hi le b fi lo ll l lm ln">      cv::Mat frame;<br/>     while (true) {<br/>         video_capture &gt;&gt; frame;</span><span id="d086" class="lj jz hi le b fi lo ll l lm ln">         auto rectangles = face_detector.detect_face_rectangles(frame);<br/>         cv::Scalar color(0, 105, 205);<br/>         int frame_thickness = 4;<br/>         for(const auto &amp; r : rectangles){<br/>             cv::rectangle(frame, r, color, frame_thickness);<br/>         }<br/>         imshow("Image", frame);<br/>         const int esc_key = 27;<br/>         if (cv::waitKey(10) == esc_key) {<br/>             break;<br/>         }<br/>     }<br/>     cv::destroyAllWindows();<br/>     video_capture.release();</span><span id="5283" class="lj jz hi le b fi lo ll l lm ln">     return 0;<br/> }</span></pre><p id="0f86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å¦‚æœæˆ‘ä»¬è¿è¡Œè¿™ä¸ªï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è´å¤šèŠ¬çš„è„¸å‘¨å›´æœ‰ä¸€ä¸ªçŸ©å½¢ï¼</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/6c51fcc3a9b22f7d3ca8a2a101e86274.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*uLhL5bWFvCW7EpfS.gif"/></div></figure><h1 id="6e49" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">æ€»ç»“</h1><p id="ad8a" class="pw-post-body-paragraph iv iw hi ix b iy kw ja jb jc kx je jf jg ky ji jj jk kz jm jn jo la jq jr js hb bi translated">æˆ‘ä»¬å…³äºOpenCVä¸­äººè„¸æ£€æµ‹çš„å¸–å­åˆ°æ­¤ç»“æŸã€‚æˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•åœ¨OpenCVä¸­ä½¿ç”¨é¢„è®­ç»ƒçš„SSDç½‘ç»œæ¥æŠ“å–ç›¸æœºå›¾åƒå¹¶åœ¨å…¶ä¸­æ‰¾åˆ°äººè„¸ã€‚</p><p id="3c33" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">å¦‚æœä½ å–œæ¬¢æˆ‘çš„å†™ä½œï¼Œè€ƒè™‘æ”¯æŒæˆ‘ï¼Œè¿™æ ·æˆ‘å¯ä»¥ç»§ç»­ä¸ºä½ åˆ›é€ å†…å®¹ï¼</p><div class="ju jv jw jx fd ab cb"><figure class="md ij me mf mg mh mi paragraph-image"><a href="https://ko-fi.com/bewagner"><img src="../Images/442e2379dd4c422211e3762adb3e50e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*upxn1lEIsQB36yY-a-RHVw.png"/></a></figure><figure class="md ij mj mf mg mh mi paragraph-image"><a href="https://www.patreon.com/bewagner?fan_landing=true"><img src="../Images/8f52df8c73b6eb1b2ef850f39042e120.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*rDcCY5d9_DyCDt9s_1RlQg.png"/></a></figure></div><p id="5730" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">åœ¨Twitterä¸Šå…³æ³¨æˆ‘</strong><a class="ae iu" href="https://twitter.com/bewagner_" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">@ be Wagner _</strong></a><strong class="ix hj">äº†è§£æ›´å¤šå…³äºç¼–ç¨‹ã€æœºå™¨å­¦ä¹ å’ŒC++ï¼</strong></p><p id="1fd8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="mk">æœ€åˆå‘å¸ƒäº</em><a class="ae iu" href="https://bewagner.github.io/programming/2020/04/12/building-a-face-detector-with-opencv-in-cpp/" rel="noopener ugc nofollow" target="_blank"><em class="mk">https://be Wagner . github . io</em></a><em class="mk">ã€‚</em></p></div></div>    
</body>
</html>