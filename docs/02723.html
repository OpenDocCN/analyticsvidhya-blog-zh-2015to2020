<html>
<head>
<title>Develop Infrastructure as Code with CloudFormation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CloudFormation将基础设施开发为代码</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/develop-infrastructure-as-code-with-cloudformation-and-sam-5fda322784f5?source=collection_archive---------12-----------------------#2019-12-30">https://medium.com/analytics-vidhya/develop-infrastructure-as-code-with-cloudformation-and-sam-5fda322784f5?source=collection_archive---------12-----------------------#2019-12-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3dce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">软件开发行业变化非常快。DevOps这个术语变得非常流行之后，仅仅写代码已经不够了。你应该尽可能地自动化软件开发过程。在这篇文章中，我将描述如何通过编写代码来定义我们的基础设施。</p><p id="aeff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">“基础设施即代码，是通过机器可读的定义文件来管理和配置计算机数据中心的过程，而不是物理硬件配置或交互式配置工具”。[1] </em></p><p id="b731" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为什么我们需要基础设施作为代码？</p><ul class=""><li id="ef10" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">在移动一个集装箱化的世界后，基础设施可以更频繁地被改变或删除/创建。</li><li id="8923" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">此外，由于大量不同的设置，跟踪基础设施设置变得非常困难。因此，将这些设置保留在代码中，有助于解决巨大的复杂性。</li></ul><p id="34cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将使用CloudFormation来定义基础设施。</p><p id="7617" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“AWS CloudFormation为您在云环境中建模和配置AWS和第三方应用程序资源提供了一种通用语言。AWS CloudFormation允许您使用编程语言或一个简单的文本文件，以自动化和安全的方式为所有地区和客户的应用程序建模和提供所需的所有资源。这为您的AWS和第三方资源提供了单一的真实来源。”[2]</p><p id="4af6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在下面画了一个架构图，来演示最终结果。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/699155356b1de507ace46055e8928fb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mz4ofbJb7DbVUoJGigTZdw.png"/></div></div></figure><p id="ab9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们定义图中存在的组件。</p><p id="4256" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">区域:是AWS用来存放其基础设施的独立地理区域。它们分布在世界各地，因此客户可以选择离他们最近的地区来托管他们的云基础架构。[3]</p><p id="08d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可用性区域:是构成AWS区域的逻辑构建块。目前有69个az，它们是一个区域内孤立的位置—数据中心。[3]</p><p id="47fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">VPC:使您能够将AWS资源启动到您定义的虚拟网络中。这个虚拟网络非常类似于您在自己的数据中心运行的传统网络，具有使用AWS的可扩展基础架构的优势。[4]</p><p id="04ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">子网:是“网络的一部分”，换句话说，是整个可用性区域的一部分。每个子网必须完全位于一个可用性区域内，并且不能跨区域。[5]</p><p id="1622" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为简单起见，我将创建1个VPC、2个公共子网和2个私有子网。子网代表不同的可用性区域。</p><p id="b78e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PS:部署代码命令</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="0ab2" class="kj kk hi kf b fi kl km l kn ko">$sam package --template-file template.yaml --s3-bucket BUCKETNAME --output-template-file packaged.yaml<br/>$sam deploy --template-file FILEPATH/packaged.yaml --stack-name test --capabilities CAPABILITY_IAM</span></pre><p id="34e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们像下面这样定义参数，以备后用。</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="60c4" class="kj kk hi kf b fi kl km l kn ko">Parameters:<br/>  EnvironmentName:<br/>    Description: An environment name that is prefixed to resource names<br/>    Type: String<br/>    Default: Test<br/><br/>  VpcCIDR:<br/>    Description: Please enter the IP range (CIDR notation) for this VPC<br/>    Type: String<br/>    Default: 10.0.0.0/16<br/><br/>  PublicSubnet1CIDR:<br/>    Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone<br/>    Type: String<br/>    Default: 10.0.1.0/24<br/><br/>  PublicSubnet2CIDR:<br/>    Description: Please enter the IP range (CIDR notation) for the public subnet in the second Availability Zone<br/>    Type: String<br/>    Default: 10.0.2.0/24<br/><br/>  PrivateSubnet1CIDR:<br/>    Description: Please enter the IP range (CIDR notation) for the private subnet in the first Availability Zone<br/>    Type: String<br/>    Default: 10.0.3.0/24<br/><br/>  PrivateSubnet2CIDR:<br/>    Description: Please enter the IP range (CIDR notation) for the private subnet in the second Availability Zone<br/>    Type: String<br/>    Default: 10.0.4.0/24</span></pre><p id="a553" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PS: 10.0.0.0/16:每个数字代表8位数，前16位(前两位数)保持不变。其余数字可以更改。所以可以分配256*256个Ip。</p><p id="4375" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创造VPC </strong></p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="ea65" class="kj kk hi kf b fi kl km l kn ko">VPC:<br/>  Type: AWS::EC2::VPC<br/>  Properties:<br/>    CidrBlock: !Ref VpcCIDR<br/>    EnableDnsSupport: true<br/>    EnableDnsHostnames: true<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Ref EnvironmentName</span></pre><p id="7b60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们把这个VPC和互联网连接起来。互联网网关用于从VPC访问互联网。</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="942b" class="kj kk hi kf b fi kl km l kn ko">InternetGateway:<br/>  Type: AWS::EC2::InternetGateway<br/>  Properties:<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Ref EnvironmentName<br/><br/>InternetGatewayAttachment:<br/>  Type: AWS::EC2::VPCGatewayAttachment<br/>  Properties:<br/>    InternetGatewayId: !Ref InternetGateway<br/>    VpcId: !Ref VPC</span></pre><p id="66e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建子网</strong></p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="6378" class="kj kk hi kf b fi kl km l kn ko">PublicSubnet1:<br/>  Type: AWS::EC2::Subnet<br/>  Properties:<br/>    VpcId: !Ref VPC<br/>    AvailabilityZone: !Select [ 0, !GetAZs '' ]<br/>    CidrBlock: !Ref PublicSubnet1CIDR<br/>    MapPublicIpOnLaunch: true<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Sub ${EnvironmentName} Public Subnet (AZ1)<br/><br/>PublicSubnet2:<br/>  Type: AWS::EC2::Subnet<br/>  Properties:<br/>    VpcId: !Ref VPC<br/>    AvailabilityZone: !Select [ 1, !GetAZs  '' ]<br/>    CidrBlock: !Ref PublicSubnet2CIDR<br/>    MapPublicIpOnLaunch: true<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Sub ${EnvironmentName} Public Subnet (AZ2)<br/><br/>PrivateSubnet1:<br/>  Type: AWS::EC2::Subnet<br/>  Properties:<br/>    VpcId: !Ref VPC<br/>    AvailabilityZone: !Select [ 0, !GetAZs  '' ]<br/>    CidrBlock: !Ref PrivateSubnet1CIDR<br/>    MapPublicIpOnLaunch: false<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Sub ${EnvironmentName} Private Subnet (AZ1)<br/><br/>PrivateSubnet2:<br/>  Type: AWS::EC2::Subnet<br/>  Properties:<br/>    VpcId: !Ref VPC<br/>    AvailabilityZone: !Select [ 1, !GetAZs  '' ]<br/>    CidrBlock: !Ref PrivateSubnet2CIDR<br/>    MapPublicIpOnLaunch: false<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Sub ${EnvironmentName} Private Subnet (AZ2)</span></pre><p id="8b9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PublicSubnet1位于第一个可用区域。</p><p id="5444" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PublicSubnet2站在第二。</p><p id="f59c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PrivateSubnet1位于第一个可用区域。</p><p id="3514" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PrivateSubnet2站在第二。</p><p id="2d94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">公共子网应该连接到互联网。为了处理这个问题，我们需要一个路由表。</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="b9ab" class="kj kk hi kf b fi kl km l kn ko">PublicRouteTable:<br/>  Type: AWS::EC2::RouteTable<br/>  Properties:<br/>    VpcId: !Ref VPC<br/>    Tags:<br/>      - Key: Name<br/>        Value: !Sub ${EnvironmentName} Public Routes<br/><br/>DefaultPublicRoute:<br/>  Type: AWS::EC2::Route<br/>  DependsOn: InternetGatewayAttachment<br/>  Properties:<br/>    RouteTableId: !Ref PublicRouteTable<br/>    DestinationCidrBlock: 0.0.0.0/0<br/>    GatewayId: !Ref InternetGateway<br/><br/>PublicSubnet1RouteTableAssociation:<br/>  Type: AWS::EC2::SubnetRouteTableAssociation<br/>  Properties:<br/>    RouteTableId: !Ref PublicRouteTable<br/>    SubnetId: !Ref PublicSubnet1<br/><br/>PublicSubnet2RouteTableAssociation:<br/>  Type: AWS::EC2::SubnetRouteTableAssociation<br/>  Properties:<br/>    RouteTableId: !Ref PublicRouteTable<br/>    SubnetId: !Ref PublicSubnet2</span></pre><p id="2375" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">任何带有相关公共子网的请求被路由到互联网网关。</p><p id="4fa9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">PS:如果你想对私有子网做同样的事情，你应该NAT网关。</p><p id="05f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建代码为</strong>的ELASTICACHE实例</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="ea43" class="kj kk hi kf b fi kl km l kn ko">ServerlessSecurityGroup:<br/>  DependsOn: VPC<br/>  Type: AWS::EC2::SecurityGroup<br/>  Properties:<br/>    GroupDescription: SecurityGroup for Serverless Functions<br/>    VpcId:<br/>      Ref: VPC<br/><br/>ServerlessStorageSecurityGroup:<br/>  DependsOn: VPC<br/>  Type: AWS::EC2::SecurityGroup<br/>  Properties:<br/>    GroupDescription: Ingress for Redis Cluster<br/>    VpcId:<br/>      Ref: VPC<br/>    SecurityGroupIngress:<br/>      - IpProtocol: tcp<br/>        FromPort: '6379'<br/>        ToPort: '6379'<br/>        SourceSecurityGroupId:<br/>          Ref: ServerlessSecurityGroup<br/><br/>ServerlessCacheSubnetGroup:<br/>  Type: AWS::ElastiCache::SubnetGroup<br/>  Properties:<br/>    Description: "Cache Subnet Group"<br/>    SubnetIds:<br/>      - Ref: PrivateSubnet1<br/><br/>ElasticCacheCluster:<br/>  DependsOn: ServerlessStorageSecurityGroup<br/>  Type: AWS::ElastiCache::CacheCluster<br/>  Properties:<br/>    AutoMinorVersionUpgrade: true<br/>    Engine: redis<br/>    CacheNodeType: cache.t2.micro<br/>    NumCacheNodes: 1<br/>    VpcSecurityGroupIds:<br/>      - "Fn::GetAtt": ServerlessStorageSecurityGroup.GroupId<br/>    CacheSubnetGroupName:<br/>      Ref: ServerlessCacheSubnetGroup</span></pre><p id="7eec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于安全原因，我将Elasticache实例放在私有子网内。所以我们需要创建一个安全组来允许6379端口连接Redis。</p><p id="f3a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从LAMBDA函数连接REDIS】</strong></p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="7238" class="kj kk hi kf b fi kl km l kn ko">CacheClientFunction:<br/>  Type: AWS::Serverless::Function<br/>  Properties:<br/>    Tracing: Active<br/>    CodeUri: bin/cacheClient<br/>    Handler: cacheClient<br/>    Runtime: go1.x<br/>    Role: !GetAtt RootRole.Arn<br/>    VpcConfig:<br/>      SecurityGroupIds:<br/>        - Ref: ServerlessSecurityGroup<br/>      SubnetIds:<br/>        - Ref: PublicSubnet1<br/>    Environment:<br/>      Variables:<br/>        redis_url: !GetAtt ElasticCacheCluster.RedisEndpoint.Address<br/>        redis_port: !GetAtt ElasticCacheCluster.RedisEndpoint.Port</span></pre><p id="d4d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Lambda函数位于公共子网中。我们可以根据自己定义创建的ElasticCache来定义redis_url和redis_port。在编写代码时，我们可以使用这些环境变量来连接Redis。</p><p id="c218" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">！！！重要！！！</strong></p><p id="1bbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Lambda函数需要一些角色和策略人员。否则创建堆栈将会出错。让我们用代码创建一个角色和策略。</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="3a1c" class="kj kk hi kf b fi kl km l kn ko">SampleManagedPolicy:<br/>  Type: AWS::IAM::ManagedPolicy<br/>  Properties:<br/>    PolicyDocument:<br/>      Version: '2012-10-17'<br/>      Statement:<br/>        - Sid: AllowAllUsersToListAccounts<br/>          Effect: Allow<br/>          Action:<br/>            - ec2:CreateNetworkInterface<br/>            - ec2:DescribeNetworkInterfaces<br/>            - ec2:DeleteNetworkInterface<br/>            - xray:PutTraceSegments<br/>          Resource: "*"<br/><br/>RootRole:<br/>  Type: 'AWS::IAM::Role'<br/>  Properties:<br/>    AssumeRolePolicyDocument:<br/>      Version: '2012-10-17'<br/>      Statement:<br/>        - Effect: Allow<br/>          Principal:<br/>            Service:<br/>              - lambda.amazonaws.com<br/>          Action:<br/>            - 'sts:AssumeRole'<br/>    Path: /<br/>    ManagedPolicyArns:<br/>      - !Ref SampleManagedPolicy</span></pre><p id="2cd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将以最低访问权限创建上述策略。</p><p id="8716" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">缓存客户端代码:</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="70da" class="kj kk hi kf b fi kl km l kn ko">package main<br/><br/>import (<br/>   "context"<br/>   "fmt"<br/>   "github.com/aws/aws-lambda-go/lambda"<br/>   "github.com/go-redis/redis"<br/>   "os"<br/>)<br/><br/>func HandleRequest(ctx context.Context) (string, error) {<br/><br/>   redisUrl := os.Getenv("redis_url")<br/>   redisPort := os.Getenv("redis_port")<br/>   client := redis.NewClient(&amp;redis.Options{<br/>      Addr:     fmt.Sprintf("%s:%s", redisUrl, redisPort),<br/>      Password: "", <em class="jd">// no password set<br/>      </em>DB:       0,  <em class="jd">// use default DB<br/>   </em>})<br/><br/>   client.Set("1", "1", 0)<br/><br/>   return client.Get("1").String(), nil<br/>}<br/><br/>func main() {<br/>   lambda.Start(HandleRequest)<br/>}</span></pre><p id="b8dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建代码为</strong>的数据库实例</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="bfb4" class="kj kk hi kf b fi kl km l kn ko">ServerlessDBSecurityGroup:<br/>  DependsOn: VPC<br/>  Type: AWS::EC2::SecurityGroup<br/>  Properties:<br/>    GroupDescription: Ingress for Redis Cluster<br/>    VpcId:<br/>      Ref: VPC<br/>    SecurityGroupIngress:<br/>      - IpProtocol: tcp<br/>        FromPort: '5432'<br/>        ToPort: '5432'<br/>        SourceSecurityGroupId:<br/>          Ref: ServerlessSecurityGroup<br/><br/>ServerlessDBSubnetGroup:<br/>  DependsOn: ServerlessDBSecurityGroup<br/>  Type: AWS::RDS::DBSubnetGroup<br/>  Properties:<br/>    DBSubnetGroupDescription: "DB Subnet Group"<br/>    SubnetIds:<br/>      - Ref: PrivateSubnet1<br/>      - Ref: PrivateSubnet2<br/><br/>PostgresqlInstance:<br/>  DependsOn: VPC<br/>  Type: AWS::RDS::DBInstance<br/>  Properties:<br/>    AllocatedStorage: 30<br/>    DBInstanceClass: db.t2.micro<br/>    DBName: postgres<br/>    Engine: postgres<br/>    MasterUsername: CacheClient<br/>    MasterUserPassword: ChangeIt2<br/>    DBSubnetGroupName: !Ref ServerlessDBSubnetGroup<br/>    VPCSecurityGroups:<br/>      - "Fn::GetAtt": ServerlessDBSecurityGroup.GroupId</span><span id="74d1" class="kj kk hi kf b fi kp km l kn ko">DbClientFunction:<br/>  Type: AWS::Serverless::Function<br/>  Properties:<br/>    Tracing: Active<br/>    CodeUri: bin/dbClient<br/>    Handler: dbClient<br/>    Runtime: go1.x<br/>    Role: !GetAtt RootRole.Arn<br/>    VpcConfig:<br/>      SecurityGroupIds:<br/>        - Ref: ServerlessSecurityGroup<br/>      SubnetIds:<br/>        - Ref: PublicSubnet1<br/>    Environment:<br/>      Variables:<br/>        db_url: !GetAtt PostgresqlInstance.Endpoint.Address<br/>        db_port: !GetAtt PostgresqlInstance.Endpoint.Port</span></pre><p id="d4f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建数据库与缓存非常相似。重要一点是，您的数据库实例应该位于至少两个可用性区域上。</p><p id="36ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据库客户端代码:</p><pre class="jt ju jv jw fd ke kf kg kh aw ki bi"><span id="448d" class="kj kk hi kf b fi kl km l kn ko">package main<br/><br/>import (<br/>   "context"<br/>   "fmt"<br/>   "github.com/aws/aws-lambda-go/lambda"<br/>   "github.com/jinzhu/gorm"<br/>   _ "github.com/jinzhu/gorm/dialects/postgres"<br/>   "os"<br/>)<br/><br/>type MyEvent struct {<br/>   Name string `json:"name"`<br/>}<br/><br/>func HandleRequest(ctx context.Context, name MyEvent) (string, error) {<br/><br/>   dbUrl := os.Getenv("db_url")<br/>   dbURI := fmt.Sprintf("host=%s user=CacheClient dbname=postgres sslmode=disable password=ChangeIt2", dbUrl)<br/>   fmt.Println(dbURI)<br/>   db, err := gorm.Open("postgres", dbURI)<br/>   if err != nil {<br/>      return "err", err<br/>   }<br/><br/>   db.AutoMigrate(&amp;Entity{})<br/>   var ent = &amp;Entity{}<br/>   ent.Text = name.Name<br/>   db.Save(&amp;ent)<br/><br/>   return fmt.Sprint(&amp;ent.ID), nil<br/>}<br/><br/>func main() {<br/>   lambda.Start(HandleRequest)<br/>}</span><span id="7aee" class="kj kk hi kf b fi kp km l kn ko">package main<br/><br/>import "github.com/jinzhu/gorm"<br/><br/>type Entity struct {<br/>   gorm.Model<br/>   Text string<br/>}</span></pre><p id="fbfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切都结束了。现在我们用代码创建了网络、缓存实例、数据库实例。我们将它们的输出与我们的无服务器函数绑定在一起。缓存和数据库客户端使用代码创建的架构。</p><p id="0492" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">template.yaml完整版:</p><p id="70dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kq" href="https://github.com/yunuskilicdev/infrastructureascode" rel="noopener ugc nofollow" target="_blank">https://github.com/yunuskilicdev/infrastructureascode</a></p><p id="f5e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">引用:</p><p id="3b38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-)<a class="ae kq" href="https://stackify.com/what-is-infrastructure-as-code-how-it-works-best-practices-tutorials/" rel="noopener ugc nofollow" target="_blank">https://stack ify . com/what-is-infra structure-as-code-how-it-works-best-practices-tutorials/</a></p><p id="9a2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2-)<a class="ae kq" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/cloudformation/</a></p><p id="4b00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3-)<a class="ae kq" href="https://cloudacademy.com/blog/aws-regions-and-availability-zones-the-simplest-explanation-you-will-ever-find-around/" rel="noopener ugc nofollow" target="_blank">https://cloud academy . com/blog/AWS-regions-and-avail ability-zones-the-simple-explain-you-ever-found-around/</a></p><p id="4989" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4-)<a class="ae kq" href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPC/latest/user guide/what-is-Amazon-VPC . html</a></p><p id="9230" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5-)<a class="ae kq" href="https://www.infoq.com/articles/aws-vpc-explained/" rel="noopener ugc nofollow" target="_blank">https://www.infoq.com/articles/aws-vpc-explained/</a></p></div></div>    
</body>
</html>