<html>
<head>
<title>Automated infrastructure using Lambda function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lambda函数的自动化基础设施</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automated-infrastructure-using-lambda-function-17bb0c373990?source=collection_archive---------17-----------------------#2020-05-17">https://medium.com/analytics-vidhya/automated-infrastructure-using-lambda-function-17bb0c373990?source=collection_archive---------17-----------------------#2020-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c0b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>是一种事件驱动的无服务器架构，允许开发人员在AWS (Amazon Web Services)控制台中创建和配置所需的功能，并执行代码，而无需配置物理或虚拟服务器，因此只需为执行期间使用的资源付费。代码自动管理运行它所需的计算资源。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/27709e26d1edef9a2a49fce087fedec3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZQqQFLWJLJtPX5YZLGooQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">AWS Lambda的符号</figcaption></figure><p id="2828" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，Lambda代码和依赖项可以包装在一个<a class="ae jd" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>部署包中，以完全自动化整个基础设施，从而构建一个云不可知的<a class="ae jd" href="https://infrastructure-as-code.com/" rel="noopener ugc nofollow" target="_blank"> IaC </a>。出于本教程的目的，我们将在AWS控制台中手动部署Lambda函数。</p><p id="efc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="ju">设置Lambda功能包括三个步骤-</em>-</strong></p><h1 id="0d96" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">提供IAM权限</h1><p id="e609" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">要运行一个Lambda函数，我们需要为该函数分配一个<a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-permissions.html#lambda-intro-execution-role" rel="noopener ugc nofollow" target="_blank">执行角色</a>和<a class="ae jd" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html#access_policies_create-json-editor" rel="noopener ugc nofollow" target="_blank"> IAM策略</a>，以便它有足够的权限访问目标AWS服务和资源并与之交互。</p><p id="6ae7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">以下是构建IAM策略的步骤:</strong></p><ol class=""><li id="361e" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">在AWS控制台左侧的导航窗格中，选择<em class="ju">策略</em>。</li><li id="9fe8" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">点击<em class="ju">创建策略</em>。</li><li id="33d2" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">选择<em class="ju"> JSON </em>选项卡。</li><li id="0f30" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">为Lambda函数键入您各自的策略。请看下面的例子。</li><li id="ab15" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">完成后，选择<em class="ju">查看策略</em>。<a class="ae jd" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_policy-validator.html" rel="noopener ugc nofollow" target="_blank">策略验证器</a>报告任何语法错误。</li></ol><pre class="jf jg jh ji fd lm ln lo lp aw lq bi"><span id="67f4" class="lr jw hi ln b fi ls lt l lu lv">{ “Version”: “2020–04–22”, <br/>“Statement”: [ <br/> { <br/>  “Effect”: “Allow”, <br/>  “Action”: [ <br/>  “logs:CreateLogGroup”, <br/>  “logs:CreateLogStream”, <br/>  “logs:PutLogEvents” <br/>  ], <br/>  “Resource”: “arn:aws:logs:*:*:*” <br/> }, <br/> { <br/>  “Effect”: “Allow”, <br/>  “Action”: [ <br/>  “ec2:Start*”, <br/>  “ec2:Stop*” <br/>   ], <br/>  “Resource”: “*” <br/> }</span></pre><p id="8e95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ju">IAM政策示例</em></p><p id="d77e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您有了IAM角色，下一步就是创建一个用户<em class="ju">用户</em>,他拥有这些权限，稍后将被分配给新创建的Lambda函数来执行所需的操作。</p><p id="c5f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">这是如何为AWS服务(控制台)创建角色的方法:</strong></p><ul class=""><li id="14da" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lw le lf lg bi translated">在IAM控制台的导航窗格中，选择<strong class="ih hj"> <em class="ju"> </em> </strong> <em class="ju">角色</em>，然后选择<em class="ju">创建角色。</em></li><li id="6d26" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">对于<em class="ju">选择可信实体的类型</em>，选择<em class="ju"> AWS服务。</em></li><li id="d7bc" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">在<em class="ju">策略</em>中，插入新创建的策略。</li><li id="d3ef" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">选择<em class="ju">下一步:复习。</em></li></ul><p id="a506" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于<em class="ju">角色名称</em>，给出一个定义Lambda功能目的的适当名称，例如EC2-reboot。在给定的AWS帐户中，角色名称应该是唯一的，不能区分大小写，即<em class="ju"> EC2 </em>与<em class="ju"> Ec2 </em>相同。</p><ul class=""><li id="db43" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lw le lf lg bi translated">查看角色，然后选择<em class="ju">创建角色</em>。</li></ul><h1 id="1fa8" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated"><strong class="ak">创建一个Lambda函数</strong></h1><p id="d9d4" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">建立Lambda函数最关键的一步是编写它的代码。</p><p id="ff16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了构建Lambda函数的代码，请遵循以下步骤:</p><ol class=""><li id="4b52" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">进入<strong class="ih hj"><em class="ju"/></strong><em class="ju">λ控制台</em> <strong class="ih hj"> <em class="ju"> </em> </strong>并选择<em class="ju">创建功能。</em></li><li id="d185" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">在<em class="ju">权限</em>下，展开<em class="ju">选择</em>或<em class="ju">创建一个执行角色</em>。</li><li id="c596" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">在<em class="ju">执行角色</em>下，选择<em class="ju">使用现有角色</em>。</li><li id="f39e" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">在<em class="ju">角色</em>中，选择新创建的角色。</li></ol><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/b2b5b926f5b824ae15053270b25cb4c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9BRLRUJzz3DLgvgAVIt8YA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">创建Lambda函数时的权限屏幕</figcaption></figure><p id="660a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是编写要执行的函数。有三种方法可以编写Lambda函数:</p><ul class=""><li id="e509" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lw le lf lg bi translated">使用AWS提供的样本代码的<strong class="ih hj">模板</strong>；或者</li><li id="acc7" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">从<strong class="ih hj">开始写；</strong>或者</li><li id="1512" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">从其他开发者和公司的<strong class="ih hj">库</strong>中搜索它。</li></ul><p id="e333" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。使用AWS </strong>提供的样本代码模板</p><p id="14f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你不熟悉AWS Lambda和编码，或者对自己编写代码不感兴趣，AWS提供了几个Lambda模板，用于与其服务相关的基本执行，如EC2和S3。这可能是理解和使用该服务的良好起点。</p><p id="f420" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用这种方法创建功能时，可以从<strong class="ih hj"> <em class="ju">蓝图</em> </strong>中选择。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ly"><img src="../Images/a70e5370363b223ab151ec077809657f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*YlNcSpVZmoAL-RevAexfPw.gif"/></div></div></figure><p id="2528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。作者从零开始</strong></p><p id="3c1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你已经处于编程的高级阶段，或者找不到你想要Lambda执行的功能，那么你可以修改<em class="ju">蓝图</em>中已经提供的功能，或者从头开始编写代码。</p><p id="8357" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了构建一个函数，选择您想要用于此目的的运行时语言<strong class="ih hj">。AWS提供了使用以下语言编写函数的可能性:</strong></p><ul class=""><li id="84c8" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc lw le lf lg bi translated">C#/ Powershell</li><li id="8745" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">计算机编程语言</li><li id="c8a0" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">Java 语言(一种计算机语言，尤用于创建网站)</li><li id="e1a8" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">节点. js</li><li id="1181" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc lw le lf lg bi translated">红宝石</li></ul><p id="d7b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在Python 2.7中编写该函数，因为它似乎在RAM和CPU时间方面都具有<a class="ae jd" href="https://github.com/berezovskyi/lambda-test" rel="noopener ugc nofollow" target="_blank">最佳启动</a>性能。</p><p id="9fe4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码的语法如下所示:</p><pre class="jf jg jh ji fd lm ln lo lp aw lq bi"><span id="5c8a" class="lr jw hi ln b fi ls lt l lu lv">import boto3<br/>region = ‘eu-central-1’<br/>instances = [&lt;instance&gt;]<br/>def lambda_handler(event, context):<br/>ec2 = boto3.client(‘ec2’, region_name=region)<br/>ec2.reboot_instances(InstanceIds=instances)<br/>print ‘started your instances: ‘ + str(instances)</span></pre><p id="3d96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="ju">区域</em>中，您必须用您的区域替换<em class="ju"> eu-central-1 </em>，并且在<em class="ju">实例</em>中，您必须填充您想要启动的<em class="ju"> EC2 </em>实例的ID。这个函数将启动您的EC2实例。这里，<a class="ae jd" href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/quickstart.html" rel="noopener ugc nofollow" target="_blank"> boto3 </a>是一个针对Python的AWS软件开发包(SDK)。</p><p id="9c9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，停止实例的代码也是一样的，但是我们需要用<code class="du lz ma mb ln b">stop.</code>替换<code class="du lz ma mb ln b">reboot</code></p><pre class="jf jg jh ji fd lm ln lo lp aw lq bi"><span id="680d" class="lr jw hi ln b fi ls lt l lu lv">import boto3<br/>region = ‘eu-central-1’<br/>instances = [&lt;instance&gt;]<br/>def lambda_handler(event, context):<br/>ec2 = boto3.client(‘ec2’, region_name=region)<br/>ec2.stop_instances(InstanceIds=instances)<br/>print ‘stoped your instances: ‘ + str(instances)</span></pre><p id="9c59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。使用AWS无服务器应用程序库</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mc"><img src="../Images/939a3c2be83a08b5460937f63839659e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fv70p153spUp6dYNBi43Zw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">来源:https://aws.amazon.com/serverless/serverlessrepo/</figcaption></figure><p id="5be4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS有一个由独立程序员、公司及其合作伙伴发布的已经构建好的无服务器应用程序的巨大资源库。</p><p id="3519" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它包含许多常见的用例，并且该平台对公众开放，以丰富知识库。这些代码是免费提供的，以鼓励重用和鼓励新用户选择AWS服务。</p><p id="baac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您建立或配置了您的代码，按底部的<strong class="ih hj"> <em class="ju">保存</em> </strong> <em class="ju"> </em>进入最后一步。</p><h1 id="c6ff" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">调用Lambda函数</h1><p id="4942" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">最后一步是构建一个<strong class="ih hj">触发器</strong>，由<strong class="ih hj"> </strong>启动该功能。</p><p id="913c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以配置触发器来响应事件，例如DynamoDB表中的更改、上传到S3的新文件或类似的AWS事件。你也可以配置Lambda函数来响应对AWS API Gateway的请求，或者基于AWS Cloudwatch触发的定时器，使用Alexa或者使用亚马逊的<a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-services.html#api-gateway-with-lambda" rel="noopener ugc nofollow" target="_blank">按需SDK。</a></p><p id="72df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于本教程，我们将使用AWS提供的示例事件数据:</p><ol class=""><li id="8667" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">在控制台右上角，选择<em class="ju">测试</em>。</li><li id="0b90" class="ky kz hi ih b ii lh im li iq lj iu lk iy ll jc ld le lf lg bi translated">在<em class="ju">配置测试事件</em>页面，选择<em class="ju">创建新的测试事件</em>，在<em class="ju">事件模板</em>中，保留默认的<em class="ju"> Hello World </em>选项。输入一个<em class="ju">事件名称</em>，并注意以下示例事件模板:</li></ol><p id="aea8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lz ma mb ln b">{ "key3": "value3", "key2": "value2", "key1": "value1" }</code></p><p id="a501" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.选择<em class="ju">创建</em>，然后选择<em class="ju">测试</em>。每个用户可以为每个功能创建多达10个测试事件。其他用户无法使用这些测试事件。</p><p id="6969" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.AWS Lambda代表您执行您的函数。Lambda函数中的<strong class="ih hj">处理程序</strong>接收并处理样本事件。</p><p id="9d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.运行几次Lambda函数来收集一些指标，您可以在下一步中查看这些指标。</p><p id="b36a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.成功执行后，在控制台中查看结果。选择<em class="ju">监控</em>。该页面显示了Lambda发送给CloudWatch的指标的图表。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es md"><img src="../Images/6d894b5ec2cbfc7a40a28b1e6e56cf97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ix2leHr2vnWP32h7EHao3w.png"/></div></div></figure></div></div>    
</body>
</html>