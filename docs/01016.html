<html>
<head>
<title>Facenet on Mobile — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">手机上的Facenet第三部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/facenet-on-modile-part-3-cc6f6d5752d6?source=collection_archive---------5-----------------------#2019-09-25">https://medium.com/analytics-vidhya/facenet-on-modile-part-3-cc6f6d5752d6?source=collection_archive---------5-----------------------#2019-09-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="3d74" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><em class="ix">了解一下，再多一点……</em></h2></div></div><div class="ab cl iy iz gp ja" role="separator"><span class="jb bw bk jc jd je"/><span class="jb bw bk jc jd je"/><span class="jb bw bk jc jd"/></div><div class="hb hc hd he hf"><blockquote class="jf jg jh"><p id="ef5c" class="ji jj jk jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">帮助弱者！打击网络犯罪<a class="ae kf" href="https://forms.gle/JWAPHzf2gd7jGq2YA" rel="noopener ugc nofollow" target="_blank">了解如何</a>。</p></blockquote></div><div class="ab cl iy iz gp ja" role="separator"><span class="jb bw bk jc jd je"/><span class="jb bw bk jc jd je"/><span class="jb bw bk jc jd"/></div><div class="hb hc hd he hf"><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/7dcda6e2280653cbd18b8217dcdab6bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DNOChML8i4r-C2Bgfxa85g.png"/></div></div></figure><p id="4bc0" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated"><em class="jk">如果你还没有读过我之前关于FaceNet架构和将</em> <code class="du kv kw kx ky b"><em class="jk">.pb</em></code> <em class="jk">转换为</em> <code class="du kv kw kx ky b"><em class="jk">.tflite</em></code> <em class="jk">的故事，我建议你浏览一下</em> <a class="ae kf" rel="noopener" href="/@tomdeore/facenet-architecture-part-1-a062d5d918a1"> <em class="jk">第一部分</em> </a> <em class="jk">和</em> <a class="ae kf" rel="noopener" href="/@tomdeore/facenet-on-mobile-cb6aebe38505"> <em class="jk">第二部分</em> </a> <em class="jk">。</em></p><p id="5347" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">让我们从<a class="ae kf" rel="noopener" href="/@tomdeore/facenet-on-mobile-cb6aebe38505">第二部分</a>中离开的地方继续。我们将Facenet检查点转换为Facenet冻结模型<code class="du kv kw kx ky b">.pb</code>，其中只有推理分支，并从模型中剥离出<em class="jk">阶段训练</em>。要验证这一事实，请使用Tensorflow <code class="du kv kw kx ky b">graph_transforms</code>工具，如下图所示:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kz"><img src="../Images/25b4ae5265ced765c63341c4e96b65e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_s3Raj2gqZz68Oi368u6Q.png"/></div></div></figure><p id="ef4f" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">同样，我们也有很棒的工具用于<code class="du kv kw kx ky b">.tflite</code>模型。我强烈建议使用Pete的<a class="ae kf" href="https://github.com/PeteBlackerThe3rd/tflite_analyser.git" rel="noopener ugc nofollow" target="_blank"> tflite_analyser </a>工具(感谢Pete！).请查看下面的输出片段:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es la"><img src="../Images/5c07b6f03d356e6dddb0b9e9293c9153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5id_JXM375WkLV2XDCkZPw.png"/></div></div></figure><p id="add1" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">现在，如果你比较这两个模型的“重量大小”的输出，它是完全相同的。</p><p id="5360" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated"><strong class="jl hj"> 23M </strong>权重<strong class="jl hj"> x 4 </strong> ( <em class="jk">浮点</em> <em class="jk">数据类型</em> ) = <strong class="jl hj"> 93M </strong>字节的权重。</p><p id="f983" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">您还会注意到<code class="du kv kw kx ky b">.pb</code>和<code class="du kv kw kx ky b">.tflite</code>的完整模型尺寸也在93M左右。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lb"><img src="../Images/3646a0ecbba98708889cc8d58fb1f87f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0BKf-fW0dl-83f34APfuZA.png"/></div></div></figure><blockquote class="jf jg jh"><p id="1edf" class="ji jj jk jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">是时候验证他们是否为给定的“图像”提供了相同的嵌入了？</p></blockquote><p id="bbd7" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated"><strong class="jl hj">请注意，本文中使用的模型尚未量化</strong>，因为量化后我们预计会有一些退化。但是在这一点上，我们想检查一下，从<code class="du kv kw kx ky b">.pb</code>到<code class="du kv kw kx ky b">.tflite</code>是否有任何变化？因为这种转换本质上只是格式的<strong class="jl hj">转换，即<strong class="jl hj">将协议缓冲区转换为平面缓冲区</strong>。</strong></p><p id="a06c" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">这可以使用以下命令进行归档:</p><pre class="kh ki kj kk fd lc ky ld le aw lf bi"><span id="f489" class="lg lh hi ky b fi li lj l lk ll">$ tflite_convert --output_file model_mobile/my_facenet.tflite --graph_def_file facenet_frozen.pb --input_arrays “input” --input_shapes “1,160,160,3” --output_arrays "embeddings" --output_format TFLITE</span></pre><p id="21b6" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated"><em class="jk">理论上，对于给定的图像，这两个模型应该会产生相同的嵌入，让我们来测试一下:</em></p><h2 id="ab3e" class="lg lh hi bd lm ln lo lp lq lr ls lt lu ks lv lw lx kt ly lz ma ku mb mc md me bi translated"><code class="du kv kw kx ky b">Protocol Buffer — Model</code></h2><p id="04d3" class="pw-post-body-paragraph ji jj hi jl b jm mf ij jo jp mg im jr ks mh ju jv kt mi jy jz ku mj kc kd ke hb bi translated">下面的脚本采用<code class="du kv kw kx ky b">.pb</code>模型和我的一个图像来输出128字节的嵌入。这里，我们使用<em class="jk">预白化</em>()对图像进行归一化处理。</p><pre class="kh ki kj kk fd lc ky ld le aw lf bi"><span id="b25f" class="lg lh hi ky b fi li lj l lk ll">from __future__ import absolute_import<br/>from __future__ import division<br/>from __future__ import print_function</span><span id="9a54" class="lg lh hi ky b fi mk lj l lk ll">import tensorflow as tf<br/>import numpy as np<br/>import facenet<br/>from skimage import io</span><span id="d517" class="lg lh hi ky b fi mk lj l lk ll">def prewhiten(x):<br/>  try:<br/>    x = io.imread(x)<br/>  except:<br/>    print('Image is corrupt!')<br/>    return 0<br/>  mean = np.mean(x)<br/>  std = np.std(x)<br/>  std_adj = np.maximum(std, 1.0/np.sqrt(x.size))<br/>  y = np.multiply(np.subtract(x, mean), 1/std_adj)<br/>  return y</span><span id="d64e" class="lg lh hi ky b fi mk lj l lk ll">def main():<br/>  with tf.Graph().as_default():<br/>    with tf.Session() as sess:<br/>      np.random.seed(seed=666)</span><span id="100e" class="lg lh hi ky b fi mk lj l lk ll"># Load the model<br/>      print('Loading feature extraction model')<br/>      facenet.load_model('facenet_frozen.pb')</span><span id="5ee8" class="lg lh hi ky b fi mk lj l lk ll"># Get input and output tensors<br/>      images_placeholder = tf.get_default_graph().get_tensor_by_name("input:0")<br/>      embeddings = tf.get_default_graph().get_tensor_by_name("embeddings:0")<br/>      embedding_size = embeddings.get_shape()[1]</span><span id="20c4" class="lg lh hi ky b fi mk lj l lk ll"># Run forward pass to calculate embeddings<br/>      input_img = 'Milind-Deore.jpeg'<br/>      image = prewhiten(input_img)</span><span id="4973" class="lg lh hi ky b fi mk lj l lk ll">input_data = np.zeros((1, 160, 160, 3))<br/>      input_data[0,:,:,:] = image<br/>      input_data = input_data.astype(np.float32)<br/>      feed_dict = { images_placeholder:input_data }<br/>      emb_array = np.zeros((1, 128))<br/>      emb_array = sess.run(embeddings, feed_dict=feed_dict)</span><span id="b670" class="lg lh hi ky b fi mk lj l lk ll">print('EMB/Label : \n', emb_array[0])</span><span id="59ee" class="lg lh hi ky b fi mk lj l lk ll">if __name__ == '__main__':<br/>     main()</span></pre><p id="2141" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">它输出如下所示的内容:(小片段)</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ml"><img src="../Images/607aabdbb2ad77ae0ec153f82f323a1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBkD6HhGY8xJLrRVcQD0lw.png"/></div></div></figure><h2 id="f291" class="lg lh hi bd lm ln lo lp lq lr ls lt lu ks lv lw lx kt ly lz ma ku mb mc md me bi translated">平板缓冲器—型号</h2><p id="0265" class="pw-post-body-paragraph ji jj hi jl b jm mf ij jo jp mg im jr ks mh ju jv kt mi jy jz ku mj kc kd ke hb bi translated">类似地，对于<code class="du kv kw kx ky b">.tflite</code>模型，下面的脚本获取我的一个相同的图像并输出128字节的嵌入。</p><pre class="kh ki kj kk fd lc ky ld le aw lf bi"><span id="94ae" class="lg lh hi ky b fi li lj l lk ll">import numpy as np<br/>import tensorflow as tf<br/>from skimage import io</span><span id="9b06" class="lg lh hi ky b fi mk lj l lk ll"># Normalize the image<br/>def prewhiten(x):<br/>     try:<br/>         x = io.imread(x)<br/>     except:<br/>         print('Image is corrupt!')<br/>         return 0<br/>     mean = np.mean(x)<br/>     std = np.std(x)<br/>     std_adj = np.maximum(std, 1.0/np.sqrt(x.size))<br/>     y = np.multiply(np.subtract(x, mean), 1/std_adj)<br/>     return y</span><span id="f10f" class="lg lh hi ky b fi mk lj l lk ll"># Load TFLite model and allocate tensors.<br/>interpreter = tf.lite.Interpreter(model_path='my_facenet.tflite')<br/>interpreter.allocate_tensors()</span><span id="7895" class="lg lh hi ky b fi mk lj l lk ll"># Get input and output tensors.<br/>input_details = interpreter.get_input_details()<br/>output_details = interpreter.get_output_details()</span><span id="4c93" class="lg lh hi ky b fi mk lj l lk ll"># Test model on random input data.<br/>input_img = 'Milind-Deore.jpeg'<br/>image = prewhiten(input_img)<br/>input_data = np.zeros((1, 160, 160, 3))<br/>input_data[0,:,:,:] = image<br/>input_data = input_data.astype(np.float32)<br/>interpreter.set_tensor(input_details[0]['index'], input_data)</span><span id="4629" class="lg lh hi ky b fi mk lj l lk ll">interpreter.invoke()<br/>output_data = interpreter.get_tensor(output_details[0]['index'])</span><span id="3ab0" class="lg lh hi ky b fi mk lj l lk ll">print('INPUTS: ')<br/>print(input_details)<br/>print('OUTPUTS: ')<br/>print(output_details)<br/><br/>print('--------- Output Data --------------')<br/>print(output_data)</span></pre><p id="dd93" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">输出片段如下所示:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mm"><img src="../Images/b316195e2f4654077ff0054fbfc3a134.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oh7DyiFZfvrRyJ3MeUsUKA.png"/></div></div></figure><p id="09ad" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">好消息！嵌入看起来很相似。</p><p id="8fc0" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated">你现在可以尝试应用量化<code class="du kv kw kx ky b">QUANTIZED_UINT8</code>并查看准确性的变化，因为比较嵌入没有任何意义，因为量化会将输出嵌入从<code class="du kv kw kx ky b">float32</code>转换为<code class="du kv kw kx ky b">int8</code>数据类型。</p><p id="d86e" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated"><em class="jk">引用:</em></p><ul class=""><li id="ff99" class="mn mo hi jl b jm jn jp jq ks mp kt mq ku mr ke ms mt mu mv bi translated"><em class="jk">感谢Pete Blacker提供了牛逼的TF lite</em><a class="ae kf" href="https://github.com/PeteBlackerThe3rd/tflite_analyser.git" rel="noopener ugc nofollow" target="_blank"><em class="jk">analyser</em></a><em class="jk">。</em></li></ul><p id="5502" class="pw-post-body-paragraph ji jj hi jl b jm jn ij jo jp jq im jr ks jt ju jv kt jx jy jz ku kb kc kd ke hb bi translated"><strong class="jl hj">你可以在|</strong><a class="ae kf" href="https://www.linkedin.com/in/mdeore/" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">LinkedIn</strong></a><strong class="jl hj">|</strong><a class="ae kf" href="https://tomdeore.wixsite.com/epoch" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">网站</strong></a><strong class="jl hj">|</strong><a class="ae kf" href="https://github.com/milinddeore" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">Github</strong></a><strong class="jl hj">|</strong></p></div></div>    
</body>
</html>