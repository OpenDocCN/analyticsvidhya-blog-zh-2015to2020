# Fast.ai ä¸ºç¼–ç äººå‘˜æä¾›çš„éšæœºæ£®æ—è§£é‡Šå’Œè¶…è¶Šâ€” ML(ç¬¬ 3 è¯¾)

> åŸæ–‡ï¼š<https://medium.com/analytics-vidhya/random-forest-deep-dive-beyond-ml-for-coders-by-fast-ai-lesson-3-a8caf01ac9d7?source=collection_archive---------27----------------------->

*è¿™ç¯‡æ–‡ç« æ·±å…¥è®¨è®ºäº† Fast.ai æä¾›çš„â€œç¨‹åºå‘˜ ML å…¥é—¨â€è¯¾ç¨‹ä¸­ç¬¬ä¸‰è¯¾çš„å­¦ä¹ ç»†èŠ‚*

*ä¸ä¼ ç»Ÿçš„è¯¾ç¨‹ç¬”è®°ä¸åŒï¼Œæˆ‘çš„é‡ç‚¹æ˜¯ç”¨å¤–éƒ¨æ¥æºçš„ä¿¡æ¯ä¸°å¯Œè®¨è®ºçš„ä¸»é¢˜ã€‚è¦è®¿é—®æˆ‘åœ¨æœ¬ç³»åˆ—ä¸­è®¨è®ºè¯¾ç¨‹èƒŒæ™¯çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œå¹¶æµè§ˆæ‰€æœ‰è¯¾ç¨‹ï¼Œè¯·å•å‡»æ­¤å¤„çš„*[](/@alexrobwong/ml-for-coders-beyond-572ae05448)**ã€‚**

# *æ‘˜è¦*

*åœ¨è¯¾ç¨‹çš„å‰åŠéƒ¨åˆ†ï¼ŒJeremey ä»åˆ†æä¸€ä¸ª[æ‚è´§é”€å”®é¢„æµ‹æ•°æ®é›†](https://www.kaggle.com/c/favorita-grocery-sales-forecasting)å¼€å§‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé¢„æµ‹å¤§å‹æ‚è´§è¿é”åº—é”€å”®é¢çš„ kaggle æŒ‘æˆ˜ã€‚ä¸æ­¤åŒæ—¶ï¼Œä»–æä¾›äº†è®¸å¤šå…³äºå¦‚ä½•æœ‰æ•ˆå¤„ç†å¤§å‹æ•°æ®é›†çš„å»ºè®®ã€‚*

*åœ¨è¯¾ç¨‹çš„ååŠéƒ¨åˆ†ï¼Œä»–åˆ‡æ¢å›ä»–åœ¨ä¸Šä¸€è¯¾ä¸­æœ€åˆåˆ†æçš„[æ¨åœŸæœºè“çš®ä¹¦](https://www.kaggle.com/c/bluebook-for-bulldozers)æ•°æ®é›†ï¼Œå¹¶é‡æ¸©äº†ä¸€ç§ç”¨äºè§£é‡Šéšæœºæ£®æ—ä¸­çš„å•ä¸ªæ ‘æœ¨é¢„æµ‹çš„æŠ€æœ¯ã€‚*

# *ç›®å½•*

1.  *ä½¿ç”¨å¤§å‹æ•°æ®é›†*
2.  *åˆ›å»ºè‰¯å¥½çš„éªŒè¯é›†*
3.  *è§£é‡Šé‡‡æ²¹æ ‘é¢„æµ‹'ç½®ä¿¡åº¦'*
4.  *ç‰¹å¾é‡è¦æ€§*
5.  *æ’åˆ—é‡è¦æ€§*

# *æ„Ÿè°¢*

*ç‰¹åˆ«æ„Ÿè°¢[æ°ç‘ç±³Â·éœåå¾·](https://github.com/fastai/fastai)å‘å¸ƒä»–çš„è¯¾ç¨‹å’Œæºä»£ç ã€‚è¿˜è¦ç‰¹åˆ«æ„Ÿè°¢[ä¸ŠåŸå¹¿ç¾Â·æœ«æ°¸](/@hiromi_suenaga)å‡ºç‰ˆäº†å¥¹è¯¦ç»†çš„è¯¾ç¨‹ç¬”è®°ã€‚*

*è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ç»¼åˆäº†è®¸å¤šæ¥æºçš„ä¿¡æ¯ã€‚æˆ‘å·²ç»å°½åŠ›æä¾›äº†åŸå§‹èµ„æ–™çš„é“¾æ¥ï¼Œå¹¶å¼ºè°ƒäº†æˆ‘å¼•ç”¨ä»–äººä½œå“çš„åœ°æ–¹ã€‚*

# ***å¤„ç†å¤§å‹æ•°æ®é›†***

*æ‚è´§é”€å”®é¢„æµ‹æ•°æ®é›†åŒ…å«å¤§çº¦ 1 . 25 äº¿è¡Œï¼Œæ˜¯ä¸€ä¸ªå…³ç³»æ•°æ®é›†ï¼Œå…¶ä¸­å‡ ä¸ªè¡¨å¯ä»¥è¿æ¥åœ¨ä¸€èµ·ã€‚å…·ä½“æ¥è¯´ï¼Œè¯¥æ•°æ®é›†ä»¥â€œæ˜Ÿå‹æ¨¡å¼â€ä¸ºç‰¹è‰²ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªé“¾æ¥æ‰€æœ‰æ•°æ®çš„ä¸­å¤®äº‹åŠ¡è¡¨ã€‚*

*è¯·æ³¨æ„ï¼Œæœ¬è¯¾çš„é‡ç‚¹ä¸æ˜¯å¦‚ä½•ä¸ºæ­¤æ•°æ®é›†æ„å»ºé«˜æ€§èƒ½ RF æ¨¡å‹ï¼Œè€Œæ˜¯å¦‚ä½•è·¨ä»¥ä¸‹ä¸»é¢˜å¤„ç†å¤§å‹æ•°æ®é›†:*

## ***è¯»å–æ•°æ®***

*å½“é€šè¿‡ pandas åŠ è½½ä¸€ä¸ªæ•°æ®å¸§æ—¶ï¼Œåªæœ‰å½“æ•´ä¸ªæ–‡ä»¶è¢«è¯»å–åï¼Œå®ƒæ‰ä¼šç¡®å®šä¸€ä¸ªåˆ—çš„æ•°æ®ç±»å‹ã€‚è™½ç„¶è¿™é€šå¸¸å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯å¦‚æœä»…ä»…ä¸ºäº†æ¨æ–­ä¸€ä¸ªæ•°æ®ç±»å‹å°±éœ€è¦è¯»å–æ•°ç™¾ä¸‡è¡Œï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•çš„æ•ˆç‡ä¼šå¾ˆä½ã€‚è¿™é‡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨è¯»å…¥æ•°æ®æ—¶å°†åˆ—ç±»å‹æŒ‡å®šä¸ºå‚æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤º:*

```
*types = {'id': 'int64',
         'item_nbr': 'int32',
         'store_nbr': 'int8',
         'unit_sales': 'float32',
         'onpromotion': 'object'}%%time
df_all = pd.read_csv(f'{PATH}train.csv', parse_dates=['date'], 
                     dtype=types, infer_datetime_format=True)*CPU times: user 1min 41s, sys: 5.08s, total: 1min 46s
Wall time: 1min 48s**
```

*è¯·æ³¨æ„ï¼Œå¯ä»¥æŒ‡å®šè®¸å¤šæ•°æ®ç±»å‹ã€‚è™½ç„¶ä¸€ä¸ªç‰¹å®šçš„åˆ—å¯ä»¥ä½¿ç”¨å¤šç§æ•°æ®ç±»å‹ï¼Œä½†æœ€å¥½ä½¿ç”¨å†…å­˜æ•ˆç‡æœ€é«˜çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œè¿™ç§æ•°æ®ç±»å‹æ­£å¥½æ»¡è¶³æ•°æ®çš„è¦æ±‚(ä¾‹å¦‚ï¼Œint8 å’Œ int32ï¼Œå…·ä½“å–å†³äºæ•´æ•°çš„å¤§å°)*

*é™¤äº†ç†ŠçŒ«ç‰¹æœ‰çš„æ•°æ®ç±»å‹`categorical`å’Œ `datetime64[ns, tz]`ä¹‹å¤–ï¼Œä»¥ä¸‹æ•°æ®ç±»å‹ä¹Ÿå¯é€šè¿‡ numpy*è·å¾—:*

```
*[numpy.generic,
 [[numpy.number,
   [[numpy.integer,
     [[numpy.signedinteger,
       [numpy.int8,
        numpy.int16,
        numpy.int32,
        numpy.int64,
        numpy.int64,
        numpy.timedelta64]],
      [numpy.unsignedinteger,
       [numpy.uint8,
        numpy.uint16,
        numpy.uint32,
        numpy.uint64,
        numpy.uint64]]]],
    [numpy.inexact,
     [[numpy.floating,
       [numpy.float16, numpy.float32, numpy.float64, numpy.float128]],
      [numpy.complexfloating,
       [numpy.complex64, numpy.complex128, numpy.complex256]]]]]],
  [numpy.flexible,
   [[numpy.character, [numpy.bytes_, numpy.str_]],
    [numpy.void, [numpy.record]]]],
  numpy.bool_,
  numpy.datetime64,
  numpy.object_]]*
```

**æ¥æº: [Stackoverflow](https://stackoverflow.com/questions/24251219/pandas-read-csv-low-memory-and-dtype-options)*

*è¯·æ³¨æ„ï¼Œ`object`çš„ dtype æ˜¯ä¸€ç§é€šç”¨çš„ python æ•°æ®ç±»å‹ï¼Œé€Ÿåº¦æ…¢ä¸”å ç”¨å¤§é‡å†…å­˜ã€‚é€šå¸¸ï¼Œé€šè¿‡å¯¹æ•°æ®è¿›è¡Œä¸€äº›æ¸…ç†ï¼Œå¯ä»¥å°†è¿™ç§æ•°æ®ç±»å‹æ›´æ–°ä¸ºå†…å­˜æ•ˆç‡æ›´é«˜çš„æ•°æ®ç±»å‹ã€‚*

## *å¦‚ä½•åœ¨ä¸åŠ è½½æ•°æ®å¸§çš„æƒ…å†µä¸‹çŸ¥é“æ•°æ®ç±»å‹*

*æ­£å¦‚ä¸Šä¸€èŠ‚æ‰€è®¨è®ºçš„ï¼Œåœ¨åŠ è½½ pandas æ•°æ®å¸§æ—¶æŒ‡å®šç±»å‹æ˜¯æœ€ä½³é€‰æ‹©â€¦â€¦ä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¦æŒ‡å®šä»€ä¹ˆå‘¢ï¼Ÿ*

*å¦‚æœè¿˜æ²¡æœ‰æŒ‡å¯¼æ¨¡å¼å­˜åœ¨ï¼Œä¸€ä¸ªä½æ•ˆçš„é€‰æ‹©æ˜¯é€šè¿‡åå¤è¯•éªŒï¼ŒåŠ è½½æ•°æ®å¹¶æŸ¥çœ‹ç»“æœã€‚ç„¶è€Œï¼Œè¿™è‡ªç„¶è¿èƒŒäº†æ•ˆç‡ä½ä¸‹çš„ç›®çš„ã€‚*

*Jeremy æåˆ°ï¼Œè¿™é‡Œä¸€ä¸ªæ½œåœ¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ UNIX å‘½ä»¤`shuf`æ¥è·å–æ•°æ®çš„éšæœºæ ·æœ¬ã€‚ç„¶è€Œï¼Œä½œä¸ºä¸€ä¸ªæ“ä½œç³»ç»Ÿç”¨æˆ·ï¼Œå¦‚æœæ²¡æœ‰ä¸€äº›é¢å¤–çš„è§£å†³æ–¹æ³•ï¼Œè¿™ä¸ªå‘½ä»¤å°±ä¸èƒ½ç›´æ¥å·¥ä½œï¼Œæ¯”å¦‚è¿™é‡Œåˆ—å‡ºçš„ã€‚*

*å¯¹äº mac ç”¨æˆ·æ¥è¯´ï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯åœ¨ç»ˆç«¯çª—å£ä¸­ä»¥ç¨å¾®ç»“æ„åŒ–çš„æ ¼å¼åˆ†æ csv æ–‡ä»¶ã€‚æ›´å¤šè¯¦æƒ…è¯·å‚è€ƒ[æ–¯ç‰¹æ³•å®‰Â·åˆ©å½­æ–¯](https://www.stefaanlippens.net/pretty-csv.html)çš„å¸–å­:*

```
*cat data.csv | column -t -s, | less -S*
```

*ç®€è€Œè¨€ä¹‹ï¼Œè™½ç„¶è¿™ä¸ä¼šè¿”å›éšæœºçš„è¡Œæ ·æœ¬ï¼Œä½†å®ƒå°†æä¾›å¯¹æ½œåœ¨æ•°æ®ç±»å‹çš„åˆæ­¥äº†è§£ã€‚*

## *æœ‰æ•ˆåœ°è®¾ç½®æœ€å¤§å€¼å’Œæœ€å°å€¼*

*åœ¨åº”è¯¥å­˜åœ¨æœ€å°å€¼å’Œæœ€å¤§å€¼çš„åœ°æ–¹ï¼Œé€šè¿‡ numpy å¤„ç†å¼‚å¸¸å€¼çš„ä¸€ä¸ªæœ‰æ•ˆæ–¹æ³•æ˜¯ä½¿ç”¨ clip æ–¹æ³•:*

*![](img/96a291275695df718026f5ad9935659c.png)*

*æ¥æº:[SciPy.org](https://docs.scipy.org/doc/numpy/reference/generated/numpy.clip.html)*

## *`Profiling`*

*æœ‰å‡ ä¸ª IPython ç¥å¥‡çš„å‘½ä»¤å¯ä»¥ç”¨æ¥ç†è§£ä»£ç æ‰§è¡Œæ—¶é—´ã€‚è™½ç„¶ Jeremy ä½¿ç”¨`%prun`æ·»åŠ äº†ä¸€ä¸ªåˆ†æå™¨ï¼Œå¹¶äº†è§£å“ªäº›ä»£ç è¡Œè¿è¡Œæ—¶é—´æœ€é•¿(ä¾‹å¦‚åœ¨ scikit-learns fit æ–¹æ³•ä¸­),ä½†è¿˜æœ‰å…¶ä»–å‡ ä¸ªå€¼å¾—ä¸€æï¼Œä¾‹å¦‚åœ¨ [Python æ•°æ®ç§‘å­¦æ‰‹å†Œ](https://jakevdp.github.io/PythonDataScienceHandbook/01.07-timing-and-profiling.html)ä¸­æ¦‚è¿°çš„:*

*   *`%time`:è®¡æ—¶å•ä¸ªè¯­å¥çš„æ‰§è¡Œæ—¶é—´*
*   *`%timeit`:å®šæ—¶é‡å¤æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œä»¥æé«˜å‡†ç¡®æ€§*
*   *`%prun`:ç”¨æ¦‚è¦åˆ†æå™¨è¿è¡Œä»£ç *
*   *`%lprun`:ç”¨é€è¡Œåˆ†æå™¨è¿è¡Œä»£ç *
*   *`%memit`:æµ‹é‡å•ä¸ªè¯­å¥çš„å†…å­˜ä½¿ç”¨æƒ…å†µ*
*   *`%mprun`:ç”¨é€è¡Œå†…å­˜åˆ†æå™¨è¿è¡Œä»£ç *

*è¯·æ³¨æ„ï¼Œåœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼ŒæŸ¥çœ‹å“ªäº›äº‹æƒ…å ç”¨äº†æ—¶é—´è¢«ç§°ä¸ºâ€œå‰–æâ€ã€‚*

# *åˆ›å»ºè‰¯å¥½çš„éªŒè¯é›†*

*ä½œä¸ºå¿«é€Ÿå¤ä¹ ï¼Œå½“æ„å»ºæœºå™¨å­¦ä¹ æ¨¡å‹æ—¶ï¼Œå¯ç”¨æ•°æ®è¢«åˆ†æˆè®­ç»ƒã€éªŒè¯å’Œæµ‹è¯•é›†ã€‚å¦‚æœ¬[å †æ ˆæº¢å‡ºå¸–å­](https://stackoverflow.com/questions/2976452/whats-is-the-difference-between-train-validation-and-test-set-in-neural-netwo)æ‰€è¿°:*

*   ****è®­ç»ƒé›†*** *:è¯¥æ•°æ®é›†ç”¨äºè°ƒæ•´æ¨¡å‹çš„æƒé‡**
*   ****éªŒè¯é›†*** *:è¯¥æ•°æ®é›†ç”¨äºæœ€å°åŒ–è¿‡æ‹Ÿåˆã€‚æ‚¨å¹¶æ²¡æœ‰ä½¿ç”¨è¯¥æ•°æ®é›†æ¥è°ƒæ•´ç½‘ç»œçš„æƒé‡ï¼Œæ‚¨åªæ˜¯éªŒè¯äº†åœ¨è®­ç»ƒæ•°æ®é›†ä¸Šçš„ä»»ä½•å‡†ç¡®åº¦çš„æé«˜å®é™…ä¸Šäº§ç”Ÿäº†åœ¨ä»¥å‰æ²¡æœ‰å‘ç½‘ç»œæ˜¾ç¤ºè¿‡çš„æ•°æ®é›†ä¸Šçš„å‡†ç¡®åº¦çš„æé«˜ï¼Œæˆ–è€…è‡³å°‘ç½‘ç»œæ²¡æœ‰å¯¹å…¶è¿›è¡Œè¿‡è®­ç»ƒ(å³éªŒè¯æ•°æ®é›†)ã€‚å¦‚æœè®­ç»ƒæ•°æ®é›†çš„ç²¾åº¦æé«˜äº†ï¼Œä½†éªŒè¯æ•°æ®é›†çš„ç²¾åº¦ä¿æŒä¸å˜æˆ–é™ä½äº†ï¼Œé‚£ä¹ˆæ‚¨çš„æ¨¡å‹ä¼šè¿‡åº¦æ‹Ÿåˆï¼Œæ‚¨åº”è¯¥åœæ­¢è®­ç»ƒã€‚**
*   ****æµ‹è¯•é›†*** *:è¯¥æ•°æ®é›†ä»…ç”¨äºæµ‹è¯•æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼Œä»¥ç¡®è®¤æ¨¡å‹çš„å®é™…é¢„æµ‹èƒ½åŠ›ã€‚**

*æ¢å¥è¯è¯´ï¼Œéœ€è¦ä¸€ä¸ªéªŒè¯é›†ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥çŸ¥é“æ‚¨çš„æ¨¡å‹æ˜¯å¦ä¼šå¯é åœ°å‘Šè¯‰æ‚¨å½“å®ƒæŠ•å…¥ç”Ÿäº§/ç”¨äºæµ‹è¯•æ•°æ®æ—¶å®ƒå°†å¦‚ä½•æ‰§è¡Œã€‚åœ¨ kaggle ç«èµ›çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæµ‹è¯•é›†æ˜¯ä¸Šä¼ é¢„æµ‹ç»“æœè¿”å›çš„åˆ†æ•°ã€‚*

*è™½ç„¶æµ‹è¯•é›†åº”è¯¥åœ¨é¡¹ç›®/æ¯”èµ›ç»“æŸæ—¶ä½¿ç”¨ï¼Œä½†å®ƒå¯ä»¥ç”¨æ¥**æ ¡å‡†æ‚¨çš„éªŒè¯é›†**ã€‚*

*è¿™é‡Œçš„æ–¹æ³•æ˜¯è®­ç»ƒå‡ ä¸ªåŠä½“é¢çš„æ¨¡å‹ï¼Œå¹¶åœ¨éªŒè¯å’Œæµ‹è¯•é›†ä¸Šè¯„ä¼°å®ƒä»¬çš„æ€§èƒ½â€”â€”åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµ‹è¯•é›†æ˜¯ kaggle ç»“æœã€‚é€šè¿‡ç»˜åˆ¶éªŒè¯ä¸æµ‹è¯•é›†åˆ†æ•°çš„å…³ç³»å›¾ï¼Œå®Œç¾çš„ 45 åº¦çº¿è¡¨ç¤ºéªŒè¯é›†å®Œç¾åœ°åæ˜ äº†æµ‹è¯•é›†ï¼Œå¦‚ä¸‹æ‰€ç¤º:*

*![](img/8d757948fa298460163bc245672e6c79.png)*

*éªŒè¯ä¸æµ‹è¯•(Kaggle)ç»“æœï¼Œç”¨äºäº†è§£éªŒè¯é›†æ˜¯å¦å·²â€œæ ¡å‡†â€ã€‚(æ¥æº:[ä¸ŠåŸå¹¿ç¾æœ«æ°¸](/@hiromi_suenaga/machine-learning-1-lesson-3-fa4065d8cb1e))*

*è¯·æ³¨æ„ï¼Œy=x çº¿ä¸æ˜¯å¿…éœ€çš„ã€‚æ›´é‡è¦çš„æ˜¯ï¼ŒéªŒè¯é›†å’Œæµ‹è¯•é›†ä¸€è‡´åœ°å‘ŠçŸ¥æ¨¡å‹ä¹‹é—´çš„ç›¸å¯¹æ€§èƒ½ã€‚*

*å½“é€‰æ‹©ä¸æµ‹è¯•é›†ä¸­åŒ…å«çš„è§‚æµ‹å€¼ç›¸ä¼¼çš„è§‚æµ‹å€¼æ—¶ï¼Œæ ¡å‡†æ•°æ®é›†éœ€è¦ä¸€ç‚¹æŠ€å·§ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæœ‰ç›¸å…³çš„æ—¶é—´å› ç´ å’Œå¯ä»¥åˆ©ç”¨çš„é¢†åŸŸä¸“ä¸šçŸ¥è¯†ã€‚*

# *è§£é‡Šæ ‘é¢„æµ‹'ç½®ä¿¡åº¦'*

*åœ¨æœ¬è¯¾çš„è¿™ä¸€ç‚¹ä¸Šï¼ŒJeremy åˆ‡æ¢ä¸»é¢˜å¹¶å¯¼èˆªå›æ¨åœŸæœºçš„[è“çš®ä¹¦](https://www.kaggle.com/c/bluebook-for-bulldozers)æ•°æ®é›†ã€‚åœ¨ä¸Šä¸€è¯¾ä¸­ï¼Œå¯¹éšæœºæ£®æ—è¿›è¡Œäº†è®­ç»ƒï¼Œå¹¶ä»‹ç»äº†åˆ†æå•æ£µæ ‘é¢„æµ‹çš„æ¦‚å¿µã€‚å›æƒ³ä»¥ä¸‹ä»£ç ï¼ŒæŸ¥çœ‹å„ä¸ªæ ‘é¢„æµ‹:*

```
*m = RandomForestRegressor(n_jobs=-1, verbose=3)
m.fit(X_train, y_train)preds = np.stack([t.predict(X_valid) **for** t **in** m.estimators_]) preds[:,0], np.mean(preds[:,0]), y_valid[0]*(array([ 9.21034,  8.9872 ,  8.9872 ,  8.9872 ,  8.9872 ,  9.21034,  8.92266,  9.21034,  9.21034,  8.9872 ]),  
9.0700003890739005,  
9.1049798563183568)*preds.shape
*(10, 12000)**
```

*ä¸ºäº†è·å¾— RF é¢„æµ‹ï¼Œå–æ‰€æœ‰æ ‘çš„å¹³å‡å“åº”ã€‚ç„¶è€Œï¼Œä¸ºäº†ç†è§£è¯¥é¢„æµ‹çš„â€œç›¸å¯¹ç½®ä¿¡åº¦â€,å¯ä»¥åˆ†æé¢„æµ‹çš„æ ‡å‡†åå·®ã€‚è¯·æ³¨æ„ï¼Œè¿™ç§æ„ä¹‰ä¸Šçš„â€œç½®ä¿¡åº¦â€å¹¶ä¸ä¸€å®šæ„å‘³ç€å‡†ç¡®æ€§ï¼Œç›¸åï¼Œå®ƒè¡¨æ˜ RF æ¨¡å‹ä¸­çš„å„ä¸ªæ ‘ç›´æ¥å‘æœ€ç»ˆå€¼æ”¶æ•›ï¼Œè€Œè¾“å…¥ä¼šå¯¼è‡´æ‰€æœ‰æ ‘å…·æœ‰éå¸¸ä¸åŒçš„å“åº”ã€‚*

*ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ˜¯è·å–å•ä¸ªè§‚å¯Ÿçš„æ ‘é¢„æµ‹çš„ç®€å•è¿‡ç¨‹ã€‚fast.ai åº“æœ‰ä¸€ä¸ªåä¸º`parallel_trees`çš„å‡½æ•°æ¥å¹¶è¡ŒåŒ–è®¡ç®—ã€‚ä¸‹é¢æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨è¯¥å‡½æ•°åŠå…¶æºä»£ç çš„ç¤ºä¾‹*

```
*def get_preds(t): return t.predict(X_valid)
%time preds = np.stack(**parallel_trees**(m, get_preds))
np.mean(preds[:,0]), np.std(preds[:,0])*CPU times: user 100 ms, sys: 180 ms, total: 280 ms
Wall time: 505 ms(9.1960278072006023, 0.21225113407342761)**
```

*æ¥è‡ª fast.ai çš„æºä»£ç *

## *ç¤ºä¾‹-æ ‘é¢„æµ‹çš„æ ‡å‡†åå·®*

*åœ¨ä¹‹å‰çš„è§†é¢‘è¯¾ç¨‹ä¸­ï¼Œæ¨åœŸæœºæœ€ç»ˆä»·æ ¼çš„ä¸€ä¸ªåˆ†ç±»é¢„æµ‹å€¼è¢«ç¡®å®šä¸º`ProductSize`ã€‚å¯ä»¥åˆ†æä¸åŒæœºæŸœç±»å‹çš„é¢„æµ‹æ ‡å‡†åå·®:*

```
*x.ProductSize.value_counts().plot.barh()*
```

*![](img/9908a273608abae53eadc1056e028a97.png)*

```
*x = raw_valid.copy()
x['pred_std'] = np.std(preds, axis=0)
x['pred'] = np.mean(preds, axis=0)flds = ['ProductSize', 'SalePrice', 'pred', 'pred_std']
summ = x[flds].groupby(flds[0]).mean()
summ*
```

*![](img/7cd21848d59d8c362938ec3b28ee6b49.png)*

*ç”±äºæ½œåœ¨çš„ç›®æ ‡å€¼è¾ƒå¤§ï¼Œå› æ­¤é¢„æœŸè¾ƒå¤§çš„äº§å“ä¼šæœ‰è¾ƒå¤§çš„æ ‡å‡†å·®ã€‚åˆ†æ`SalePrice`ä¸`pres_std`çš„æ¯”å€¼ï¼Œå¯ä»¥çœ‹å‡ºè¶Šå¤§è¶Šç´§å‡‘çš„äº§å“æ¯”å€¼æœ€å¤§ï¼Œç›¸å¯¹æ ‡å‡†å·®ä¹Ÿæœ€å¤§ã€‚*

```
*(summ.pred_std/summ.pred).sort_values(ascending=False)*
```

*![](img/a0a1f1b93d5a7dc9d6a9a8a61caf7b32.png)*

*æ­£å¦‚[ä¸ŠåŸå¹¿ç¾Â·è‹åŸƒçº³åŠ ](/@hiromi_suenaga/machine-learning-1-lesson-3-fa4065d8cb1e)æ‰€è¯´ï¼Œæ‚¨å¯ä»¥å°†è¿™ä¸ªç½®ä¿¡åŒºé—´ç”¨äºä¸¤ä¸ªä¸»è¦ç›®çš„:*

1.  **æ‚¨å¯ä»¥æŸ¥çœ‹å„ç»„çš„å¹³å‡ç½®ä¿¡åŒºé—´ï¼Œæ‰¾å‡ºæ‚¨ä¼¼ä¹å¯¹å“ªäº›ç»„æ²¡æœ‰ä¿¡å¿ƒã€‚**
2.  **ä¹Ÿè®¸æ›´é‡è¦çš„æ˜¯ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å®ƒä»¬çš„å…·ä½“è¡Œã€‚å½“æ‚¨å°†å®ƒæŠ•å…¥ç”Ÿäº§æ—¶ï¼Œæ‚¨å¯èƒ½æ€»æ˜¯å¸Œæœ›çœ‹åˆ°ç½®ä¿¡åŒºé—´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åšä¿¡ç”¨è¯„åˆ†æ¥å†³å®šæ˜¯å¦ç»™æŸäººè´·æ¬¾ï¼Œä½ å¯èƒ½ä¸ä»…æƒ³çŸ¥é“ä»–ä»¬çš„é£é™©ç¨‹åº¦ï¼Œè¿˜æƒ³çŸ¥é“æˆ‘ä»¬æœ‰å¤šæœ‰ä¿¡å¿ƒã€‚å¦‚æœä»–ä»¬æƒ³å€Ÿå¾ˆå¤šé’±ï¼Œè€Œæˆ‘ä»¬å¯¹é¢„æµ‹ä»–ä»¬æ˜¯å¦ä¼šè¿˜é’±çš„èƒ½åŠ›ä¸€ç‚¹ä¿¡å¿ƒéƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç»™ä»–ä»¬å°é¢è´·æ¬¾ã€‚**

# *ç‰¹å¾é‡è¦æ€§*

*RandomForestRegressor ç±»æ˜¯ä¸€ç§å†…ç½®çš„åŠŸèƒ½é‡è¦æ€§æ–¹æ³•ã€‚fast.ai åº“æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥ä¼˜é›…åœ°è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸ºç”¨æˆ·è¿”å›æ ¼å¼åŒ–çš„è¾“å‡º:*

*`fi = rf_feat_importance(m, df_trn); fi[:10]`*

*![](img/fd2780204e99173eb29e7eab9a2e5255.png)*

*æ¨åœŸæœºè“çš®ä¹¦æ•°æ®é›†çš„è¦ç´ é‡è¦æ€§ç¤ºä¾‹*

*rf_feat_importance å‡½æ•°çš„ Fast.ai æºä»£ç *

*å®é™…ä¸Šï¼Œå¯¹äºéšæœºæ£®æ—é¢„æµ‹æ¥è¯´ï¼Œé€šå¸¸åªæœ‰ä¸€éƒ¨åˆ†ç‰¹å¾æ˜¯é‡è¦çš„ã€‚æ­£æ˜¯åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œåº”è¯¥æ³¨å…¥é¢†åŸŸä¸“ä¸šçŸ¥è¯†ï¼Œä»¥è¿›ä¸€æ­¥ç†è§£åº•å±‚ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Œå› ä¸ºè¿™å¯ä»¥æ¨åŠ¨ç‰¹æ€§å·¥ç¨‹çš„å…¶ä»–æƒ³æ³•ã€‚*

## *ç‰¹å¾é‡è¦æ€§èƒŒåçš„æ•°å­¦åŸç†*

*scikit-learn ç‰¹å¾é‡è¦æ€§æ–¹æ³•åŸºäºé€šè¿‡åˆ†å‰²ç‰¹å¾å®ç°çš„æ‚è´¨å‡å°‘ã€‚å¦‚ç¬¬ 1 è¯¾æ‰€è¿°ï¼Œåˆ†ç±»æ ‘é€šå¸¸ä½¿ç”¨åŸºå°¼æŒ‡æ•°æˆ–ç†µï¼Œå›å½’æ ‘é€šå¸¸ä½¿ç”¨æ ‡å‡†å·®ã€‚ä»¥ä¸‹å¯¹ç‰¹å¾é‡è¦æ€§èƒŒåçš„æ•°å­¦è§£é‡Šæ¥è‡ª[å †æ ˆäº¤æ¢](https://datascience.stackexchange.com/questions/66280/how-is-the-feature-importance-value-calculated-in-sklearn-modules-for-each):*

**å¯¹äºå…·æœ‰å·¦å³å­èŠ‚ç‚¹çš„ç»™å®š(äºŒè¿›åˆ¶)èŠ‚ç‚¹ğ‘šï¼Œæ‚è´¨å‡å°‘ğºğ‘ğ‘–ğ‘›çš„è®¡ç®—å¦‚ä¸‹ï¼Œå…¶ä¸­æƒé‡è¢«å®šä¹‰ä¸ºå­èŠ‚ç‚¹ä¸­çˆ¶å®ä¾‹çš„ä»½é¢**

*![](img/2fc02cd6781645cd2ab822dc87640d7d.png)*

**ç°åœ¨ï¼Œä¸ºäº†å¯¼å‡ºæ ‘ tã€* *ä¸­ç»™å®šç‰¹å¾ f* ***çš„* ***æ€»æ‚è´¨å‡å°‘é‡ï¼Œæ‚¨éœ€è¦å¯¹åœ¨è¯¥ç‰¹å¾ f ä¸Šæ‰§è¡Œåˆ†å‰²çš„æ‰€æœ‰èŠ‚ç‚¹æ±‚å’Œï¼Œå¹¶é™¤ä»¥è¯¥æ ‘æ‰€æœ‰èŠ‚ç‚¹çš„æ€»æ‚è´¨å‡å°‘é‡:******

*![](img/40b63bccdda8e90cef80960310f04f87.png)*

*è¯·æ³¨æ„ï¼Œç”±äºè¿™ä¸€æ ‡å‡†åŒ–æ­¥éª¤ï¼Œæ‚¨çš„ç‰¹å¾é‡è¦æ€§æ€»è®¡ä¸º 1ã€‚æœ€ç»ˆï¼Œå°†è®¡ç®—ä»»æ„æ£®æ—ä¸­æ‰€æœ‰æ ‘æœ¨ t çš„è¦ç´ ğ‘“çš„æ€»é‡è¦æ€§ï¼Œæ ‘æœ¨æ€»æ•°ä¸º t:*

*ç°åœ¨ï¼Œè¦è·å¾—ğ‘¡æ ‘ä¸­ç»™å®šç‰¹å¾ğ‘“çš„æ€»æ‚è´¨å‡å°‘é‡ï¼Œéœ€è¦å¯¹æ‰€æœ‰èŠ‚ç‚¹ğ‘šâˆˆğ‘€(ğ‘¡)ğ‘“mâˆˆMf(t æ±‚å’Œï¼Œè¿™äº›èŠ‚ç‚¹å¯¹è¯¥ç‰¹å¾ğ‘“f æ‰§è¡Œåˆ†å‰²ï¼Œç„¶åé™¤ä»¥è¯¥æ ‘æ‰€æœ‰èŠ‚ç‚¹çš„æ€»æ‚è´¨å‡å°‘é‡:*

*![](img/fd57674a103562fb55643f5fd26c1fce.png)*

## *ç‰¹å¾é‡è¦æ€§çš„é™åˆ¶*

*æ­£å¦‚åœ¨ [scikit-learn æ–‡æ¡£](https://scikit-learn.org/stable/auto_examples/inspection/plot_permutation_importance.html)ä¸­ç›´æ¥æŒ‡å‡ºçš„ï¼Œè¯·æ³¨æ„éšæœºæ£®æ—ç‰¹å¾é‡è¦æ€§çš„ä»¥ä¸‹é™åˆ¶:*

*   **åŸºäºæ‚è´¨çš„é‡è¦æ€§åå‘é«˜åŸºæ•°ç‰¹æ€§**
*   **åŸºäºæ‚è´¨çš„é‡è¦åº¦æ˜¯æ ¹æ®è®­ç»ƒé›†ç»Ÿè®¡æ•°æ®è®¡ç®—çš„ï¼Œå› æ­¤ä¸èƒ½åæ˜ å‡ºç‰¹å¾å¯¹è¿›è¡Œå½’çº³åˆ°æµ‹è¯•é›†çš„é¢„æµ‹æœ‰ç”¨çš„èƒ½åŠ›**
*   **å½“ä¸¤ä¸ªç‰¹å¾ç›¸å…³ä¸”å…¶ä¸­ä¸€ä¸ªç‰¹å¾è¢«ç½®æ¢æ—¶ï¼Œæ¨¡å‹ä»å¯é€šè¿‡å…¶ç›¸å…³ç‰¹å¾è®¿é—®è¯¥ç‰¹å¾ã€‚è¿™å°†å¯¼è‡´è¿™ä¸¤ä¸ªç‰¹æ€§çš„é‡è¦æ€§é™ä½ï¼Œè€Œå®ƒä»¬å®é™…ä¸Šå¯èƒ½æ˜¯é‡è¦çš„ã€‚å¤„ç†è¿™ç§æƒ…å†µçš„ä¸€ç§æ–¹æ³•æ˜¯å¯¹ç›¸å…³çš„è¦ç´ è¿›è¡Œèšç±»ï¼Œå¹¶ä¸”åªä¿ç•™æ¯ä¸ªèšç±»ä¸­çš„ä¸€ä¸ªè¦ç´ ã€‚**

# *æ’åˆ—é‡è¦æ€§*

*æœ¬è¯¾çš„æœ€åä¸€ä¸ªä¸»é¢˜æ˜¯æ’åˆ—é‡è¦æ€§ï¼Œè¿™æ˜¯ä¸€ç§æ¨¡å‹ä¸å¯çŸ¥çš„æŠ€æœ¯ï¼Œç”¨äºæ ¹æ®éšæœºæ’åˆ—æ—¶ç‰¹å¾å¯¹å“åº”å˜é‡çš„å½±å“æ¥ç†è§£ç‰¹å¾çš„é‡è¦æ€§ã€‚*

> *è¯¥è¿‡ç¨‹æ‰“ç ´äº†ç‰¹å¾å’Œç›®æ ‡ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤æ¨¡å‹å¾—åˆ†çš„ä¸‹é™è¡¨æ˜äº†æ¨¡å‹å¯¹ç‰¹å¾çš„ä¾èµ–ç¨‹åº¦(æ¥æº: [scikit-learn](https://scikit-learn.org/stable/modules/permutation_importance.html) )*

*æ¢å¥è¯è¯´ï¼Œé€šè¿‡æ¯”è¾ƒå•ä¸ªé¢„æµ‹å™¨ç‰¹æ€§(ä¾‹å¦‚ä¸‹å›¾ä¸­çš„`YearMade`)è¢«éšæœºæ‰“ä¹±æ—¶çš„æ€§èƒ½ä¸‹é™ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å“ªäº›ç‰¹æ€§ç›¸å¯¹æ›´é‡è¦è¿›è¡Œæ’åºã€‚*

*![](img/ef7d5457b4a0b142c2e5d94239f08cd8.png)*

*æ¥æº:[ä¸ŠåŸå¹¿ç¾Â·è‹å¨œåŠ ](/@hiromi_suenaga/machine-learning-1-lesson-3-fa4065d8cb1e)*

*Scikit-learn æä¾›äº†ä¸€ä¸ª`permutation_importance_ method`ï¼Œå®ƒå¯ä»¥åœ¨ä¸‹é¢çš„[é“¾æ¥](https://scikit-learn.org/stable/modules/generated/sklearn.inspection.permutation_importance.html#sklearn.inspection.permutation_importance)ä¸­æ‰¾åˆ°ã€‚*

***è¯·æ³¨æ„ï¼Œåœ¨ fast.ai è¯¾ç¨‹ä¸­ï¼ŒJeremey ä½¿ç”¨ä¸Šé¢çš„æ’åˆ—é‡è¦æ€§å›¾è¡¨ä½œä¸º scikit-learn çš„ç‰¹å¾é‡è¦æ€§æ–¹æ³•çš„ç®€åŒ–è§£é‡Šã€‚**è™½ç„¶æœ‰åŠ©äºç›´è§‚ç†è§£ï¼Œå› ä¸ºä¸¤è€…éƒ½è¾“å‡ºè¾“å…¥ç‰¹å¾çš„ç›¸å¯¹é‡è¦æ€§ï¼Œä½†åº”ç†è§£å®ƒä»¬ä¸æ˜¯ä¸€å›äº‹:*

*   *fast.ai åº“ä¸­ä½¿ç”¨çš„ scikit-learn ç‰¹å¾é‡è¦æ€§æ–¹æ³•åŸºäºå¹³å‡å‡å°‘ä¸å®Œæ•´æ€§(MDI)*
*   *ç½®æ¢é‡è¦æ€§ï¼Œå¦‚ scikit-learn ä¸­å®ç°çš„ç‰ˆæœ¬ï¼Œæ˜¯åŸºäºæŒ‡å®šçš„è¯„åˆ†å‡½æ•°çš„ã€‚ç½®æ¢é‡è¦æ€§è¢«å®šä¹‰ä¸ºâ€œåŸºçº¿åº¦é‡å’Œç½®æ¢ç‰¹å¾åˆ—çš„åº¦é‡ä¹‹é—´çš„å·®å¼‚â€ã€‚*

*æœ‰å…³ä¸¤è€…ä¹‹é—´å·®å¼‚çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ sci-kit learn çš„è¿™ç¯‡[æ–‡ç« ã€‚](https://scikit-learn.org/stable/modules/permutation_importance.html)*

# *è¿™ä¸€è¯¾åˆ°æ­¤ç»“æŸï¼Œæ•¬è¯·æœŸå¾…ä¸‹ä¸€è¯¾ï¼*