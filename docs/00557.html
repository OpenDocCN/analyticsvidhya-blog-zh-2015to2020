<html>
<head>
<title>Exploring Spark UDFs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">探索Spark UDFs</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/dabbling-into-spark-udfs-de52416de6bb?source=collection_archive---------2-----------------------#2019-07-30">https://medium.com/analytics-vidhya/dabbling-into-spark-udfs-de52416de6bb?source=collection_archive---------2-----------------------#2019-07-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f415" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">探索Spark用户自定义函数并举例说明</h2></div><p id="d72c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">嘿伙计们，</p><p id="1cdf" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们中的许多人在spark数据帧和rdd中执行lambda函数时都会面临严重的问题。尽管lambda函数非常简单，同时也非常有用，但是使用lambda函数完成一些任务有时还是有点麻烦。</p><p id="5bc2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，如果你们在应用lambda函数时有点卡住了，让我向你们介绍一下Spark中UDF(用户定义函数)的概念，它的作用类似于…..</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es jt"><img src="../Images/3237fcf6b829bd99ca3bf52557c89291.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*mPpNrH_b3DEd0HiljDqMkw.png"/></div></figure><p id="d117" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正确，spark UDFs基本上是传递一个python函数用于spark数据帧或rdd(我认为有点正统)，很有趣，不是吗！</p><p id="8940" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我通过一个例子来帮助你探索这个概念。我有一个数据集，其中包含职业数据，如图所示。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es kb"><img src="../Images/7b47006871df7b7f0ed7b9fb5015cee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*grvDJpGeiKYlijZBDwmeuQ.png"/></div></figure><p id="c436" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，我想得到10岁范围内的特定年龄组的职业数，即10-20岁，20-30岁，…所以为了得到年龄组，我们将使用火花UDF函数。</p><p id="17c4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我从读取数据集开始…</p><pre class="ju jv jw jx fd kc kd ke kf aw kg bi"><span id="476c" class="kh ki hi kd b fi kj kk l kl km">userDF = spark.read.option(“header”, “true”) \<br/> .option(“delimiter”, “;”) \<br/> .option(“inferSchema”, “true”) \<br/> .csv(“user.csv”) \<br/> .select(‘userid’,’age’,’gender’,’occupation’)</span></pre><p id="c7c8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，现在我们有了数据集，让我们使用if-else条件链快速创建一个python函数来划分年龄。</p><pre class="ju jv jw jx fd kc kd ke kf aw kg bi"><span id="6d91" class="kh ki hi kd b fi kj kk l kl km">def age_group(age):<br/> if age &lt; 10:<br/> return ‘0–10’<br/> elif age &lt; 20:<br/> return ‘10–20’<br/> elif age &lt; 30:<br/> return ‘20–30’<br/> elif age &lt; 40:<br/> return ‘30–40’<br/> elif age &lt; 50:<br/> return ‘40–50’<br/> elif age &lt; 60:<br/> return ‘50–60’<br/> elif age &lt; 70:<br/> return ‘60–70’<br/> elif age &lt; 80:<br/> return ‘70–80’<br/> else:<br/> return ‘80+’</span></pre><p id="bf35" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们的python函数已经准备好了，我们将创建一个spark UDF函数，并在其中传递python函数。</p><pre class="ju jv jw jx fd kc kd ke kf aw kg bi"><span id="63fa" class="kh ki hi kd b fi kj kk l kl km">from pyspark.sql.functions import udf<br/>agegroup_udf = udf(lambda z: age_group(z))<br/>userDFAgeGroup = userDF.withColumn(‘AgeGroup’,agegroup_udf(F.col(‘age’)))</span></pre><p id="09ec" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，基本上我们将得到<em class="kn"> agegroup_udf </em>函数，现在可以在Dataframe中传递该函数以对其列执行操作。所以，我在年龄栏上应用了UDF函数来得到年龄组(太明显了！).</p><p id="f614" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们检查一下我们新出生的数据帧的健康状况</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es ko"><img src="../Images/2c137c13a9c0af0c2bfb025aa8ead580.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*_HhdrQTJ_-Z4F7uwBICWHw.png"/></div></figure><p id="233a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">哈利路亚，我们通过申请UDF获得了年龄组专栏，这不是很简单吗？现在，让我们根据新添加的列聚合数据，并获得最终结果。</p><pre class="ju jv jw jx fd kc kd ke kf aw kg bi"><span id="d154" class="kh ki hi kd b fi kj kk l kl km">userDF_count = userDFAgeGroup.groupBy(F.col(‘AgeGroup’),F.col(‘occupation’)) \<br/> .agg(F.count((F.col(‘occupation’))).alias(‘count’))</span></pre><p id="1f5b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我给你看看我得到的最终结果。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div class="er es kp"><img src="../Images/5d23b5f80656a59ce2ed589bf5f4315a.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*fOD44eOC3hKsclohW9JLIw.png"/></div></figure><p id="f8ce" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">唷，我们终于到达了我们的里程碑，并得到了每个年龄组和职业的计数。UDF的用途和好处是无穷无尽的，因为这个例子只是打开了UDF世界的一个小窗口。</p><p id="542c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望你喜欢我的文章，如果你想查看全部代码，请点击下面的github链接:</p><p id="5537" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">https://github.com/AbidMerchant/Pyspark_udf_partition<a class="ae kq" href="https://github.com/AbidMerchant/Pyspark_udf_partition" rel="noopener ugc nofollow" target="_blank"/></p><p id="a128" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那都是乡亲们！Ta Ta</p></div></div>    
</body>
</html>