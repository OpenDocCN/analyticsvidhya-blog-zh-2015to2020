<html>
<head>
<title>Deploying Starburst Trino on GCP with Hive, Storage and Postgres connectors.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP部署星爆Trino，带有蜂巢，存储器和Postgres连接器。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-starburst-enterprise-presto-on-googles-kubernetes-engine-with-storage-and-postgres-72483b10ab62?source=collection_archive---------15-----------------------#2020-11-12">https://medium.com/analytics-vidhya/deploying-starburst-enterprise-presto-on-googles-kubernetes-engine-with-storage-and-postgres-72483b10ab62?source=collection_archive---------15-----------------------#2020-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="988f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天，我们将享受一些运营/大数据乐趣，而不是通常的普通Python。这是为什么呢？<a class="ae jd" href="https://grski.pl/starburst-k8s.html" rel="noopener ugc nofollow" target="_blank">没有介质就链接。</a></p><p id="2562" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去的一年半时间里，我一直沉浸在与设计/实现API相关的工作中，同时还有一些产品所有权/管理/指导。我参与的项目/产品中的挑战主要是理解业务环境和面向客户的需求工作。从技术上讲，通常没什么先进的，或者我应该说:没什么有趣的。普通的老姜戈+ DRF，这两个都很棒，但是你知道。事情会变得无聊，尤其是在小范围内。因此，虽然我在经理/产品负责人知识方面有所进步，但我的技术技能却停滞不前。</p><p id="4906" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我注意到了这一点，并决定改变这一点，这样这些东西就不再那么无聊了。你正在阅读的这篇文章就是这样的结果——我尝试新的东西，学习完全超出我通常的专业/舒适区的东西。事不宜迟，让我们继续讨论技术问题，但首先让我在这里做一个小小的说明:本文中展示的解决方案可能并不完美，几乎可以肯定。我是这个题目的新手，今天刚坐下来，开始做事。这不应该成为任何与生产相关的东西的灵感。此外，我简化了一些内容，因为这篇文章的目标是像我一样的新手，甚至是非技术人员，所以请原谅我。</p><h1 id="e70d" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">数据是monnies</h1><p id="613e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">那么这个星爆企业Trino是什么东西？为什么重要？</p><p id="ac63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如今我们基本上喜欢在数据时代。数据=金钱往往。我们大多数人都想要更多的钱，对吗？全球所有不同的公司也是如此。公司通常有大量不知道如何使用的数据。好吧，数据==钱，但只是卖它，是傻瓜的方式。有时候，更好的方法是对这些数据进行一些数字处理，进行一些分析，收集见解，然后采取行动。这就是赚钱的潜力所在，这就是奇迹发生的地方。比如影响美国选举，投票淘汰某些人，预测疫情的爆发或它将如何传播。是什么把这些东西联系在一起？数据。</p><p id="ad7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的，现在我们知道数据非常重要，对吗？没错。太好了。现在想一想——所有这些数据都必须存储在某个地方，事实也的确如此。通常在某种数据库中。</p><h1 id="5881" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">崔诺在这方面有什么作用？</h1><p id="b698" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">业内事实上的处理数据、理解数据、运行一些查询的标准是SQL。这是一种你可以说的语言，一种数据库可以理解的语言，告诉他们如何处理我们拥有的数据。数据世界中的几乎每个人都知道它，它并没有那么难，它已经伴随我们很多年了，所以它是久经考验的。太壮观了。到目前为止，一切都很好，很简单。</p><p id="aea5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而繁荣来了。SQL和关系数据库不是唯一的，也不应该是唯一的。它们在某些用例中很好，在其他用例中就不那么好了。让我们称这些为我们的<code class="du kh ki kj kk b">other data sources</code>。在一些应用程序中，您会发现许多这样的数据源类型，其中一些根本不理解SQL，这使得将它们与传统的数据库数据一起处理、收集见解等变得更加困难。</p><p id="5191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不过，这个崔诺的东西来了。啊，顺便说一下——它最初是由脸书开发的。这是什么？Trinois是统一所有这些数据源的抽象层。它允许您在几乎任何类型的数据源上使用SQL/查询。这让开发人员少了很多麻烦，让事情变得更简单。它在设计时还考虑了可扩展性，这意味着处理大量数据不成问题。<code class="du kh ki kj kk b">loads</code>是多少，基本上是Pb或EB。这已经很多了。很多很多。现在，感谢Trino，您可以使用SQL查询所有这些不同的数据源，并扩展您的应用程序以满足您的需求，无论您需要查询千兆字节、兆兆兆字节还是千兆字节，所有这些都是轻而易举的事情。</p><h1 id="d766" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">还有星爆？</h1><p id="5802" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">关于Trinois的部分清楚了，<a class="ae jd" href="https://www.starburstdata.com/" rel="noopener ugc nofollow" target="_blank">星爆</a>呢？嗯，基本上是一家专门提供Trino engine解决方案的公司，力求做到最好。他们还提供了一个同名的产品，有点像Trino的酷<code class="du kh ki kj kk b">packages</code>的集合，新数据源的更多<code class="du kh ki kj kk b">connectors</code>，现有数据源的改进，更好的性能。简单来说，这个产品是类固醇，例如支持，如果你需要它。他们有这个软件的几个不同的“版本”，在这篇文章中，我们将通过<a class="ae jd" href="https://www.starburstdata.com/presto-enterprise/" rel="noopener ugc nofollow" target="_blank">星爆企业</a>版本设置。</p><h1 id="eb2e" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Kubernetes？</h1><p id="ca9e" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这个你可以自己去谷歌一下。</p><h1 id="a3a4" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们把手弄脏吧</h1><p id="26a0" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">那么，让我们开始吧。我们将从建立GCP项目开始。</p><p id="07ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">只是我们不会。我不会用如何下载cli、在GCP注册和初始化CLI的细节来烦你。谷歌有很多关于这方面的文档，所以请自便。我希望你能:</p><ol class=""><li id="47c9" class="kl km hi ih b ii ij im in iq kn iu ko iy kp jc kq kr ks kt bi translated">在您的google云平台控制台中创建的项目。</li><li id="afb4" class="kl km hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">已安装CLI</li><li id="f511" class="kl km hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">Kubectl添加到gcloud</li><li id="570c" class="kl km hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">在cli的配置中设置的项目id</li><li id="c21b" class="kl km hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">cli中设置的区域</li><li id="91bc" class="kl km hi ih b ii ku im kv iq kw iu kx iy ky jc kq kr ks kt bi translated">在谷歌云中启用适当的服务。</li></ol><p id="56e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一旦您完成了所有这些工作，我们就可以使用我们的集群了。为此，您需要:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/789b6aa586f86f5e16b966761aeb19bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tJ-cSsm0Vwe14UOnzKp1jA.png"/></div></div></figure><p id="832e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建群集可能需要几分钟时间。完成后，您可以看到部署了什么，例如使用</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es ll"><img src="../Images/e2ced1ec34e60d942eeeac47fb885beb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cxjH0rM2fXH5Ry3gCsL7OA.png"/></div></div></figure><p id="a7c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个命令将列出您所有的节点池，就像您将拥有的机器的一个<code class="du kh ki kj kk b">group</code>。这是一个非常简单的描述，但请耐心听我说，或者学习k8s。至于第二个，它列出了所有的<code class="du kh ki kj kk b">instances</code>，也就是您的集群将运行的<code class="du kh ki kj kk b">machines/computers</code>。</p><p id="5f72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的，我们的集群差不多在运行。现在该怎么办？前往<a class="ae jd" href="https://docs.starburstdata.com/latest/kubernetes/deployment.html" rel="noopener ugc nofollow" target="_blank">starbrust的文档</a>并下载链接页面开头列出的文件。之后，导航到您拥有这些文件的位置，并将这些配置应用到我们的k8s集群。怎么会？</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lm"><img src="../Images/94ef2c684fc83dde1c5f2f5d5f21f491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ujsaHosNo3FzxmMWQp5faQ.png"/></div></div></figure><p id="54c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成所有这些后，尝试:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es ln"><img src="../Images/89d84445b4440989cc4c0f6f868357eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VRhnjuD-TnB1hF6yJXtWw.png"/></div></div></figure><p id="de92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样你就能拿到所有的豆荚了。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lo"><img src="../Images/9ff45fa275af53725a88ea95b5d831ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KMsYCMb0RtIrinjhigXGlw.png"/></div></div></figure><p id="2fd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该看到几个pod正在运行，其中一些可能处于<code class="du kh ki kj kk b">PENDING</code>状态。目前来说，一切都很好。</p><h1 id="02bf" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">世界是你的了</h1><p id="db13" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">所以我们的Trino集群差不多在运行。不过，能接触到还是不错的，对吧？一个UI界面与Starburst Enterprise打包在一起，它在8080端口暴露自己，因此我们所要做的就是将其暴露给世界。怎么做呢？那么，k8s有一个解决方案——像负载平衡器和入口这样的东西？</p><p id="9eac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它们到底是什么？这是调用面向世界的服务并将请求路由到适当资源的聪明方法。或多或少。应该怎么做？<a class="ae jd" href="https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/" rel="noopener ugc nofollow" target="_blank"> K8s医生告诉我们如何</a>。考虑到我的k8s知识首先非常非常浅薄，其次生疏得要命，因为我上一次接触它是在1.5年前，我试着用简单的方法创建一个名为<code class="du kh ki kj kk b">lb.yml</code>的文件，放在我的其他部署文件所在的目录中，内容如下:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lp"><img src="../Images/58bcb3ee0337648eb367d577f25c5ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aEJv1XazZ4xq-hNkqXdOFg.png"/></div></div></figure><p id="33e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你稍微了解k8s，你就应该明白这种方法有什么问题。总之。我已经应用了这个部署，负载平衡器服务正常运行，到目前为止一切顺利。我用以下方法检查了它:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lq"><img src="../Images/6ee78c7437497cc1d86d529a21728fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OToZsFAGZYtMirnR4aLnCA.png"/></div></div></figure><p id="767b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要等待，直到您的LB被分配了<code class="du kh ki kj kk b">external ip</code>列。您在那里看到的IP是您应该尝试连接的IP。我已经试过了，试着在我的浏览器中连接到<code class="du kh ki kj kk b">&lt;external ip of my lb&gt;:8080</code>。那没用。我马上得到一个错误。奇怪。让我们尝试只连接ip而不连接端口。表现不一样。怎么会？连接已建立，但它只是挂起，直到超时。有意思。这让我觉得LB总体上工作正常，但是配置是错误的——服务试图将我们的请求映射到一个不存在的资源。有<code class="du kh ki kj kk b">selector.app: loadbalancer</code>的那部分是错的。我必须知道我需要指向的资源的名称。但是选哪个呢？我已经有几个豆荚了。嗯。让我们放聪明点，做:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lr"><img src="../Images/b804ba6658a2ad0c49c9358bc12e5486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ry_9ZvS7UdKfBZ1bf11jXw.png"/></div></div></figure><p id="26bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将列出我们所有的资源，在我的例子中:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es ls"><img src="../Images/577f2e8aba53d810698535b80e228bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aKl3Bik4qAZChne8Bduwww.png"/></div></div></figure><p id="4af4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯嗯。UI应该暴露端口8080，riiight？如果您仔细查看这个输出，您会得到:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lt"><img src="../Images/a78c6e6c8001c1b54049f1b5f960d969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bP2eDwDcbl20vnZAuznB7Q.png"/></div></div></figure><p id="7a0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">明白了。我现在知道了我需要引用的资源的正确名称，是时候解决这个问题了，同时也去掉了保存配置的文件——只需使用一个命令就可以部署lb。为什么？去尝试另一种方式，学习更多的基本知识！</p><p id="53c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是在我这样做之前，也许你想试着取消/删除我们以前的负载均衡服务？如果名称匹配，理论上不需要这样做，但还是要试一试。怎么会？这次谷歌一下。无论如何，要调出适当的LB，请这样做:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lu"><img src="../Images/dcac16b966f486a4c048aa05df33ea6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_iZPadCeie2CFQRWk8lp3Q.png"/></div></div></figure><p id="bff6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果你去<code class="du kh ki kj kk b">&lt;external ip of my lb&gt;:8080</code>魔法就会发生。</p><h1 id="804b" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们做一些查询</h1><p id="08fb" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">好了，我们的崔诺星团已经完全暴露了，一切都很好。让我们连接到集群，也许创建一些表或查询配置单元。我们走吧。怎么做呢？安装Trino CLI。怎么会？为Starburst Enterprise安装CLI</p><p id="787a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不会深入讨论这个问题，因为文件已经足够了。现在，让我们运行:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lv"><img src="../Images/524f7d5408faee32e99e5d4696a1b148.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WZkYipjvXRV60Y2qnCjvpA.png"/></div></div></figure><p id="6fc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们看到:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es ln"><img src="../Images/129fdf793f6852f335d9e0512ca51dbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXEKtegQxuu9ds0TRtlUlQ.png"/></div></div></figure><p id="87cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">成功！现在做什么？让我们来查一下蜂房吧。只是为了检查它是否正常工作。让我们从在Trino控制台中键入以下命令开始:</p><p id="6e68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kh ki kj kk b">USE hive.default;</code></p><p id="32a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的情况下，它导致了一个错误。如果您查看Trino的UI包装器，并过滤<code class="du kh ki kj kk b">failed</code>查询，您将能够获得关于失败原因的更多细节。在我的情况下，它是<code class="du kh ki kj kk b">connectivity</code>错误。好像连不上或者没什么可连接的。百米...还记得我们使用<code class="du kh ki kj kk b">kubectl get pods</code>后得到的<code class="du kh ki kj kk b">PENDING</code>状态吗？这就是问题所在。hive的<code class="du kh ki kj kk b">metastore</code>和它的内部<code class="du kh ki kj kk b">postgres</code>仍然处于待定状态。有点不对劲。</p><p id="e675" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用<code class="du kh ki kj kk b">kubectl get logs &lt;pod name&gt;</code>获取日志不会起作用，因为pod甚至还没有启动，所以它不会返回任何有见地的东西，但是描述pod应该会。这两者有何不同？<code class="du kh ki kj kk b">kubectl get logs</code>是专注于pod运行时输出的东西。<code class="du kh ki kj kk b">kubectl describe pod</code>另一方面会告诉我们更多关于吊舱的配置之类的东西。那我们就这么做吧。</p><figure class="la lb lc ld fd le er es paragraph-image"><div class="ab fe cl lw"><img src="../Images/06294e99cd0357cb5f3b37aaa931fa2e.png" data-original-src="https://miro.medium.com/v2/format:webp/1*4Q8KW1CcM0bIZCJLNfMhOw.png"/></div></figure><p id="1f30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它返回了什么？大致如下的东西:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lx"><img src="../Images/5515ac5e6bc1a42c6b69c49e95e87333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r3tryKM_UUQ9yypQ0IyTdQ.png"/></div></div></figure><p id="96c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切都清楚了。</p><h1 id="fe78" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">明智地规划你的资源</h1><p id="f8d7" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如你所见，我们的<code class="du kh ki kj kk b">hive</code>和<code class="du kh ki kj kk b">postgres</code>舱无法获得足够的资源，因此无法启动。怎么办？我最初的想法是添加更多的机器/扩展节点数量。怎么做呢？你可以在谷歌云文档中读到相关内容。我把节点数增加到了5个，以防万一。默认情况下，我有3个。</p><p id="49a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们现在看看。<code class="du kh ki kj kk b">kubectl get pods</code> - &gt;砰！配置单元metastore启动正常，但postgres...尽管理论上节点池仍有大量空闲资源，但仍处于待定状态。做什么？再用<code class="du kh ki kj kk b">kubectl describe pod &lt;name of the pod with postgres for hive&gt;</code>来挖吧。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es ly"><img src="../Images/cc717fd94d23026543c384db60624179.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ySPKkizZT3fLePeCOuKSg.png"/></div></div></figure><p id="c1c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这部分配置引起了我的注意。为什么？因为我检查了运行我们节点的机器。它们属于<code class="du kh ki kj kk b">n1-standard-1</code>类型，这意味着它们都有1个vCPU和1gb RAM。现在，在只有1个vcpu和1 GB RAM的机器上运行需要2个vcpu和2 GB RAM的pod可能会非常困难。我们该如何应对？我们需要调整实例的大小。我不知道是否有更复杂的方法来做到这一点，但我满足于删除旧的节点池，并用更大的机器创建一个新的节点池。</p><p id="11c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先—获取节点池的名称</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lp"><img src="../Images/7cce08b962603dac393e58d023ca4361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kfun8xhWw2MrS83y_PXKcA.png"/></div></div></figure><p id="e203" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后删除旧的，同时创建一个新的:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lz"><img src="../Images/348074db44307c00c1d07153c2be6b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o0G1kLZgapX-q9kGRenwAg.png"/></div></div></figure><p id="3ad1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建一个名为<code class="du kh ki kj kk b">starburst-pool</code>的节点池，运行在类型为<code class="du kh ki kj kk b">n1-standard-4</code>的机器上，有3个节点，因此大约有3台机器。对于示例部署，您也可以只部署2个节点以节省资金，但我更愿意部署3个节点。现在让我们看看我们的pod是否运行正常。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es ma"><img src="../Images/ba4b903d49d0772be8ec7f73a86ccab8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KYLN2H62YxibXHBdYt7tqA.png"/></div></div></figure><p id="31ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一切正常，耶！</p><p id="3b8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尝试我们不久前进行的初始查询。现在应该可以了。如果是的话，恭喜你。您的配置单元及其内部postgres运行正常。</p><h1 id="f11f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">外部数据来源</h1><p id="96e9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">好吧。我们终于建立了集群。一切都很完美。除了一件事。我们没有运行查询的数据。这很可悲。让我们装一些。为什么不呢？</p><p id="9ff3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们如何做到这一点？有很多方法，但是让我们用一种非常常见的方法:从对象存储服务中读取ORC文件。这是什么？ORC基本上是为大数据开发的这种格式。性能原因之类的——你没必要为此那么麻烦自己。对象存储服务类似于亚马逊的AWS S3或谷歌云平台的谷歌云存储，这基本上是一种奇特的说法，它是一种硬盘驱动器，但在云中。</p><p id="81b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定采用GCP的解决方案，把所有东西都放在一个地方，再加上我已经了解S3，所以让我们尝试一些新的东西。</p><p id="0314" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何创建一个桶？很简单，谷歌一下。然后对如何创建服务密钥的信息进行同样的操作。请注意不要创建公共存储桶，因为这样你所有的文件都可以在互联网上找到。也可以尝试限制您对服务密钥的访问。自己多研究一下这两个话题。</p><p id="22dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成服务密钥后，下载它的。json文件。你有吗？太好了。我们继续吧。</p><h1 id="162f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">对象存储服务— GCS</h1><p id="74e3" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">你记得我们之前下载的这个文件<code class="du kh ki kj kk b">example_presto_v1_cr.yaml</code>吗？在某种文本编辑器/IDE中打开它，找到<code class="du kh ki kj kk b">hive</code>部分。在我的例子中，它看起来是这样的:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mb"><img src="../Images/de83099aec5fa524b6c97994b01a14ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Pw50hOnqVxorzmpew23hw.png"/></div></div></figure><p id="8db2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们需要做的是允许hive以某种方式向GCP授权。怎么会？记住。我们下载的json服务文件？好，把它移到和<code class="du kh ki kj kk b">example_presto_v1_cr.yaml</code>同一个目录下，命名为<code class="du kh ki kj kk b">gcs-key.json</code>。然后编辑部署，如下所示:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mc"><img src="../Images/9d4612051bdcdde7f21085c0a50ff094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KObRCi-576oGeKV7KCAWVA.png"/></div></div></figure><p id="8986" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es md"><img src="../Images/011b8ce81ef5431931ba6605409c4a88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*at1yj9X_NMlDODhBMhPmJw.png"/></div></div></figure><p id="bc72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本，搞定。现在，如果您已经正确设置了服务访问，hive将能够正确地进行身份验证，我想您已经设置了。但是等一下。如果我们想读入一些数据，我们需要这些数据，但是我们没有。</p><p id="b0f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有两个解决方案:在互联网上找到一些示例ORC文件并使用它，或者准备您自己的随机测试数据集。我们要做什么？当然是后者！怎么会？用Python。让我们首先安装我们将需要的这个软件包:</p><pre class="la lb lc ld fd me kk mf mg aw mh bi"><span id="1911" class="mi jf hi kk b fi mj mk l ml mm">pip install pyorc</span></pre><p id="3816" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想用virtualenv就用吧，我没有。</p><p id="7ce7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一个简单的脚本就可以了:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mn"><img src="../Images/8dd20ba818ff65a0e6cc05e43cc5c49a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xWjxLSQm6fL5ExpmfiHdsA.png"/></div></div></figure><p id="f38a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将生成一个1000个用户的列表，包括名字、姓氏和id。这是一个非常简单的例子，但也可以。现在运行它:</p><pre class="la lb lc ld fd me kk mf mg aw mh bi"><span id="f201" class="mi jf hi kk b fi mj mk l ml mm">python generate_orc.py</span></pre><p id="23b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后砰。我们走吧。你应该在你的目录中看到一个名为<code class="du kh ki kj kk b">users.orc</code>的新文件。现在转到您的bucket，在那里创建一个名为<code class="du kh ki kj kk b">import</code>的目录，并将文件上传到那里。现在为了导入这个文件，我们需要再次输入Trino shell。如果你以前退出过，这里有一个小提示，告诉你如何到达那里:</p><pre class="la lb lc ld fd me kk mf mg aw mh bi"><span id="1ab7" class="mi jf hi kk b fi mj mk l ml mm">trino <!-- -->--server &lt;external ip of my lb&gt;:8080 --user test</span></pre><p id="d239" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你到了那里:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mo"><img src="../Images/0c488a0a792ada48161781fafd1bb740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HVX6w5TbIHcR1AuzxDPcww.png"/></div></div></figure><p id="f15e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将使Hive转到那个桶位置并处理那里的所有文件，导入它们并填充新创建的表<code class="du kh ki kj kk b">people</code>。</p><p id="1c2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成了。现在试试:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mp"><img src="../Images/93ad70ef1aa14877ce27c2c1aaa7c403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ldMwju4gLvjd5WmkMSDXww.png"/></div></div></figure><p id="e8b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打印出前10行。有用吗？如果是这样，恭喜你。</p><p id="e921" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很好。我们现在可以从存储在对象存储服务中的ORC文件中查询东西。从一个更流行的数据源获取数据怎么样，比如一个数据库，比如postgres？就这么办吧。</p><h1 id="b1dc" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Postgres</h1><p id="e6c6" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们如何从trino集群内部查询postgres？首先，我们需要有这样一个db。出于本文的目的，您可以在GCP上配置一个托管数据库。怎么做呢？再谷歌一下。只要记住授权您的集群的IP地址访问数据库或使用<code class="du kh ki kj kk b">0.0.0.0/0</code>允许任何IP访问它。下一步是什么？返回到用于添加配置单元gcs连接器的同一个文件。现在打开它，尝试找到带有<code class="du kh ki kj kk b">additionalCatalogs</code>的部分。大致像这样配置它:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mq"><img src="../Images/43627d2b72d0ff2825fd167fa73a10a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KVP5XTdpD2IYtCN9045cyg.png"/></div></div></figure><p id="12b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在—这里的第一个问题是:密码存储在明文OMG OMG中。通常，我会使用秘密来管理它，因为k8s有一个机制，但这不是没有生产设置指南。另外，如果有人可以访问带有您的部署代码的repo，通常对安全性来说已经太晚了，但是我理解您的担心。在实际应用中不应该这样做。</p><p id="98c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吧。你补充说，现在怎么办？用你在Hive中应用的同样的命令来应用这些改变，就像<code class="du kh ki kj kk b">kubectl apply</code>一样。</p><p id="a2f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开您的trino控制台，尝试做一些事情，例如列出可用的模式:</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mr"><img src="../Images/3083c9aeeede2fc0e21c49acef5d9e2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9z6b_g9UzOaCMvLLKBBMXg.png"/></div></div></figure><p id="cce3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果这对你有用，你就正式完成了。你现在可以查询所有你想要的。你的问题会很好地总结在用户界面上，你可以看到那里的细节。</p><h1 id="416a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">摘要</h1><p id="3ce9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">嗯，我们差不多完成了。对我来说，这是一次有趣的探索，因为我对崔诺、星爆和GCP都没有任何经验。总体来说过得很愉快，这很好，尤其是在这个令人生畏的时期。总之。</p><p id="c0fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经浅尝了trino能做的事情，但是还有更多要尝试的。</p><p id="5f86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是今天这一集的格斯基漫谈！</p></div></div>    
</body>
</html>