<html>
<head>
<title>A Shell Script to backup your database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于备份数据库的Shell脚本</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/a-shell-script-to-backup-your-database-737a565f3f2a?source=collection_archive---------10-----------------------#2020-07-04">https://medium.com/analytics-vidhya/a-shell-script-to-backup-your-database-737a565f3f2a?source=collection_archive---------10-----------------------#2020-07-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/16881fc14e2d83921c20dcaf167027f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*BBA4kLhFyvs0Xsy4HIgi_w.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">数据库后备</figcaption></figure><p id="9c03" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可能每天都有大量的数据被写入数据库，或者您的数据库被多年的数据淹没，变得非常大，维护成本非常高。保持数据库整洁高效的方法之一是备份日常事务中不再需要的旧记录，并将其从数据库中删除。你是怎么做到的？一种方法是编写一个<a class="ae jo" href="https://www.shellscript.sh/" rel="noopener ugc nofollow" target="_blank"> shell脚本</a>，它获取数据库的备份，将备份存档并存储在本地或远程系统上。</p><p id="de3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">准备好备份您的数据库了吗？然后，让我们编写我们的shell脚本。本教程解释了在Linux系统中备份PostgreSQL数据库中的表。您可以对其进行修改，以便用于其他系统和数据库。</p><p id="df2a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们脚本中的第一行将是:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="b04c" class="jy jz hi ju b fi ka kb l kc kd">#!/bin/sh</span></pre><p id="4802" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是所谓的<strong class="is hj">舍邦。</strong>指向系统中已配置的shell之一。因此，如果你在你的脚本中使用了<code class="du ke kf kg ju b">#!/bin/sh</code>，那么你的脚本的行为将会根据哪个shell <code class="du ke kf kg ju b">sh </code>指向你的系统而有所不同。如果你用的是<code class="du ke kf kg ju b">#!/bin/bash</code>，它总是指向<code class="du ke kf kg ju b">bash</code>。</p><p id="f9a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，我们将定义一个文件夹来保存备份的文件。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="4f7b" class="jy jz hi ju b fi ka kb l kc kd">BACKUP_HOME='/opt/backup'</span></pre><p id="5ff0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还必须定义要备份的数据。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ddc1" class="jy jz hi ju b fi ka kb l kc kd">if [ $# -ne 0 ]</span><span id="b918" class="jy jz hi ju b fi kh kb l kc kd">then</span><span id="755e" class="jy jz hi ju b fi kh kb l kc kd">  LOGS_END_DATE=$1</span><span id="cc10" class="jy jz hi ju b fi kh kb l kc kd">else</span><span id="2b5e" class="jy jz hi ju b fi kh kb l kc kd">  LOGS_END_DATE=`date --date="yesterday -90 days" "+%Y-%m-%d"`</span><span id="1109" class="jy jz hi ju b fi kh kb l kc kd">fi</span></pre><p id="ae7a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面我们定义了一个变量<strong class="is hj"> LOGS_END_DATE </strong>。我们将备份从昨天<strong class="is hj">起</strong>超过<strong class="is hj"> 90天</strong>的数据。你可能想知道什么是<code class="du ke kf kg ju b">[$# -ne 0 ]</code>。代表“<em class="ki">不等于零的参数数量</em>”。如果我们执行脚本文件为<code class="du ke kf kg ju b">filename.sh 04–07–2020</code>，那么<strong class="is hj"> LOGS_END_DATE </strong>将为<strong class="is hj"> </strong> <code class="du ke kf kg ju b">04–07–2020</code>。如果我们在没有日期参数的情况下执行，<strong class="is hj"> LOGS_END_DATE </strong>将是从昨天<strong class="is hj"/>起<strong class="is hj"> 90天</strong>之前的日期。</p><p id="9e13" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将把数据导出到CSV文件中。</p><p id="05ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ke kf kg ju b">_export_csv_file=$BACKUP_HOME/data/Audit_Logs_Until_$LOGS_END_DATE.csv</code></p><p id="025c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我们应该定义数据库连接和SQL查询。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ca9a" class="jy jz hi ju b fi ka kb l kc kd">echo ‘’</span><span id="0745" class="jy jz hi ju b fi kh kb l kc kd">echo `date`’ :: CHATBOT AUDIT logs back up to csv started…..’</span><span id="6329" class="jy jz hi ju b fi kh kb l kc kd">echo ‘#############################################################’</span><span id="8398" class="jy jz hi ju b fi kh kb l kc kd">echo ‘End Date is ‘$LOGS_END_DATE</span><span id="ed91" class="jy jz hi ju b fi kh kb l kc kd">CONN=”/usr/bin/psql -w -U postgres -h localhost -d your_database”</span><span id="6a32" class="jy jz hi ju b fi kh kb l kc kd">echo ‘’</span><span id="db66" class="jy jz hi ju b fi kh kb l kc kd">echo `date`” :: Export Query ….”</span><span id="4c2c" class="jy jz hi ju b fi kh kb l kc kd">QUERY_CSV=”SELECT * FROM cloud_schema.audit_log WHERE request_timestamp &lt; ‘$LOGS_END_DATE’”</span><span id="e809" class="jy jz hi ju b fi kh kb l kc kd">echo “$QUERY_CSV”</span></pre><p id="60a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的服务器中，PostgreSQL安装在<code class="du ke kf kg ju b">/usr/bin/psql</code>中。在基于linux的系统中，您可以通过<code class="du ke kf kg ju b">which psql</code>获得这个安装位置。用您的数据库用户名替换<strong class="is hj"> postgres </strong>，用您的数据库名称替换<strong class="is hj"> your_database </strong>。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="f356" class="jy jz hi ju b fi ka kb l kc kd">QUERY_CSV="SELECT * FROM cloud_schema.audit_log WHERE request_timestamp &lt; '$LOGS_END_DATE'"</span></pre><p id="d8a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我想备份来自<strong class="is hj"> audit_log </strong>表中比<strong class="is hj"> LOGS_END_DATE </strong>更老的记录。</p><p id="c6f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们已经查询了需要备份的数据，我们必须将这些数据写入csv文件。我们将在脚本中使用<code class="du ke kf kg ju b">copy</code>命令。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="6793" class="jy jz hi ju b fi ka kb l kc kd">echo ‘’</span><span id="0169" class="jy jz hi ju b fi kh kb l kc kd">echo `date`” :: File Export Started..”</span><span id="7320" class="jy jz hi ju b fi kh kb l kc kd">echo “File : ${_export_csv_file}”</span><span id="942e" class="jy jz hi ju b fi kh kb l kc kd">echo “copy ($QUERY_CSV) to ‘$_export_csv_file’ with (FORMAT CSV, HEADER)” | $CONN</span><span id="7ce7" class="jy jz hi ju b fi kh kb l kc kd">echo ‘’</span><span id="4846" class="jy jz hi ju b fi kh kb l kc kd">echo `date`” :: File Export completed.”</span><span id="d0be" class="jy jz hi ju b fi kh kb l kc kd">echo ‘#############################################################’</span></pre><p id="6dcc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将把您的数据写入一个csv文件。如果您需要从数据库中删除这些数据，您可以按如下方式删除它们。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="390e" class="jy jz hi ju b fi ka kb l kc kd">if [ $? -eq 0 ];then</span><span id="f84d" class="jy jz hi ju b fi kh kb l kc kd">  echo `date`” :: Deleting Older Data..”</span><span id="3b1d" class="jy jz hi ju b fi kh kb l kc kd">  $CONN -c “DELETE FROM cloud_schema.audit_log WHERE request_timestamp &lt; ‘$LOGS_END_DATE’”</span><span id="5a00" class="jy jz hi ju b fi kh kb l kc kd">  echo `date`” :: Export Completed”</span><span id="6580" class="jy jz hi ju b fi kh kb l kc kd">else</span><span id="de30" class="jy jz hi ju b fi kh kb l kc kd">  echo `date`” :: Export Failed”</span><span id="104d" class="jy jz hi ju b fi kh kb l kc kd">fi</span></pre><p id="e4eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是完整的脚本。</p><figure class="jp jq jr js fd ij"><div class="bz dy l di"><div class="kj kk l"/></div><figcaption class="im in et er es io ip bd b be z dx translated">用于备份数据库的Shell脚本</figcaption></figure><p id="ce47" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以以<code class="du ke kf kg ju b">./filename.sh</code>的身份运行这个脚本，或者以<code class="du ke kf kg ju b">./filename.sh 04–07–2020</code>的身份运行日期参数。</p><p id="ee17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设您必须在每周日凌晨1:00运行该脚本。周日晚上不睡觉？？绝对没有。您可以使用<a class="ae jo" href="https://en.wikipedia.org/wiki/Cron" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> cron </strong> </a>调度一个任务来运行脚本。</p><p id="7ad1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转到您的Linux终端，键入<code class="du ke kf kg ju b">crontab -e</code>。在一个新行上，插入以下内容，保存并退出。记得给你的正确路径。sh文件。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="3ade" class="jy jz hi ju b fi ka kb l kc kd">0 1 * * 0 path/to/your_sh_file/filename.sh</span></pre><p id="5f05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个作业会在你提到的时间内唤醒并运行你的脚本，同时你可以好好睡一觉。还要记住，您的服务器应该启动并运行，这样才能工作。</p></div></div>    
</body>
</html>