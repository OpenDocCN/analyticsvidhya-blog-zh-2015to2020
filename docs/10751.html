<html>
<head>
<title>PySpark Process base 64 message in Spark Streams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火花流中的 PySpark 进程 base 64 消息</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/pyspark-process-base-64-message-in-spark-streams-87975052d44d?source=collection_archive---------17-----------------------#2020-11-01">https://medium.com/analytics-vidhya/pyspark-process-base-64-message-in-spark-streams-87975052d44d?source=collection_archive---------17-----------------------#2020-11-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/666cacc0d54a72e862ac6d97f8747a62.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/0*Tp66LPAUoOdR5I-C"/></div></figure><h1 id="4623" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">带有 base 64 编码消息的事件中心消息。</h1><h1 id="5f57" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">用例</h1><ul class=""><li id="cb1e" class="jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">物联网中心和事件中心使用 Avro 格式，并使用 base 64 编码的消息存储消息</li><li id="dc19" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">使用结构化流解析数据</li><li id="eafc" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">解析 base 64 编码的 body 列</li></ul><h1 id="3d46" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">先决条件</h1><ul class=""><li id="7ccd" class="jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">Azure 订阅</li><li id="18db" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">创建活动中心名称空间</li><li id="8941" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">选择标准，因为模式注册表在 basic 中不可用</li><li id="5b4c" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">创建一个带有 1 个分区的活动中心</li><li id="ffeb" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">创建一个名为 sample1 的消费者组</li><li id="03ad" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">创建 Azure 数据砖块工作区</li><li id="4a5f" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">火花 3.0</li><li id="0e9a" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">创建活动中心集群</li><li id="bcbd" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">从 Maven: com.microsoft.azure 安装事件中心库 jar:azure-event hubs-spark _ 2.12:2 . 3 . 17</li></ul><h1 id="e273" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">模拟器创建数据并将其发送到事件中心</h1><ul class=""><li id="2042" class="jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><a class="ae kh" href="https://eventhubdatagenerator.azurewebsites.net/" rel="noopener ugc nofollow" target="_blank">https://eventhubdatagenerator.azurewebsites.net/</a></li><li id="add5" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">复制事件中心连接字符串</li><li id="ffd3" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">复制事件中心的名称并粘贴到此处</li><li id="23e8" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">让 JSON 消息保持原样</li><li id="7a89" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">将消息数量更改为 500</li><li id="704c" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">单击提交</li><li id="6f9c" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">等待几秒钟加载数据</li></ul><h1 id="0fa6" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">Azure 数据块代码</h1><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="a516" class="kr in hi kn b fi ks kt l ku kv">from azure.schemaregistry import SchemaRegistryClient <br/>from pyspark.sql.types import * <br/>from pyspark.sql.functions import * <br/>from pyspark.sql.functions import unbase64,base64 <br/>from pyspark.sql.functions import * <br/>from pyspark.sql.types import * <br/>import json</span></pre><ul class=""><li id="fbd4" class="jk jl hi jm b jn kw jp kx jr ky jt kz jv la jx jy jz ka kb bi translated">设置活动中心配置</li><li id="bc07" class="jk jl hi jm b jn kc jp kd jr ke jt kf jv kg jx jy jz ka kb bi translated">配置为从头开始读取流。</li></ul><pre class="ki kj kk kl fd km kn ko kp aw kq bi"><span id="b682" class="kr in hi kn b fi ks kt l ku kv"># Start from beginning of stream<br/>startOffset = "-1"<br/><br/># End at the current time. This datetime formatting creates the correct string format from a python datetime object<br/>#endTime = dt.now().strftime("%Y-%m-%dT%H:%M:%S.%fZ")<br/><br/><br/># Create the positions<br/>startingEventPosition = {<br/>  "offset": startOffset,  <br/>  "seqNo": -1,            #not in use<br/>  "enqueuedTime": None,   #not in use<br/>  "isInclusive": True<br/>}</span></pre><p id="ebbd" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">设置连接字符串</p><blockquote class="lq lr ls"><p id="f868" class="lb lc lt jm b jn kw ld le jp kx lf lg lu lh li lj lv lk ll lm lw ln lo lp jx hb bi translated">connectionString = " Endpoint = sb://XXXXXX . service bus . windows . net/；SharedAccessKeyName = adbaccessSharedAccessKey = xxxxxxxEntityPath=eventhubname "</p></blockquote><p id="f570" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">设置事件中心的配置以读取消息</p><blockquote class="lq lr ls"><p id="9ef2" class="lb lc lt jm b jn kw ld le jp kx lf lg lu lh li lj lv lk ll lm lw ln lo lp jx hb bi translated">conf = { }<br/>conf[' event hubs . connectionstring ']= sc。_ JVM . org . Apache . spark . event hubs . eventhubsutils . encrypt(connectionString)<br/>conf[" event hubs . consumer group "]= " sample 1 "<br/>conf[" event hubs . starting position "]= JSON . dumps(startingEventPosition)</p></blockquote><p id="7b4d" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">现在读这条小溪</p><blockquote class="lq lr ls"><p id="4be0" class="lb lc lt jm b jn kw ld le jp kx lf lg lu lh li lj lv lk ll lm lw ln lo lp jx hb bi translated">df = spark \ <br/>。readStream \ <br/>。格式(" eventhubs") \ <br/>。选项(**conf) \ <br/>。负载()</p></blockquote><p id="0841" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">创建一个列来转换 base 64 列</p><blockquote class="lq lr ls"><p id="8666" class="lb lc lt jm b jn kw ld le jp kx lf lg lu lh li lj lv lk ll lm lw ln lo lp jx hb bi translated">df = df.withColumn("body "，df["body"]。cast("string "))</p></blockquote><p id="c810" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">现在让我们解析主体内部的数据</p><blockquote class="lq lr ls"><p id="bb18" class="lb lc lt jm b jn kw ld le jp kx lf lg lu lh li lj lv lk ll lm lw ln lo lp jx hb bi translated">df1 = df . select(get _ JSON _ object(df[' body ']，" $。传感器 id”)。别名(' sensor_id ')，<br/> get_json_object(df['body']，" $。传感器 _ 温度”)。别名(' sensor_temp ')，<br/> get_json_object(df['body']，" $。传感器状态”)。别名('传感器状态')<br/>)</p></blockquote><p id="b257" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">显示数据集</p><blockquote class="lq lr ls"><p id="36f9" class="lb lc lt jm b jn kw ld le jp kx lf lg lu lh li lj lv lk ll lm lw ln lo lp jx hb bi translated">显示器(df1)</p></blockquote><p id="9816" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated">上述逻辑可以应用于基数为 64 的 ant 源。</p><p id="dbf7" class="pw-post-body-paragraph lb lc hi jm b jn kw ld le jp kx lf lg jr lh li lj jt lk ll lm jv ln lo lp jx hb bi translated"><em class="lt">原载于</em><a class="ae kh" href="https://github.com/balakreshnan/Accenture/blob/master/Streams/PysparkStreams.md" rel="noopener ugc nofollow" target="_blank"><em class="lt">https://github.com</em></a><em class="lt">。</em></p></div></div>    
</body>
</html>