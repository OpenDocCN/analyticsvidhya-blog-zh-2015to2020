<html>
<head>
<title>Retrieving the best model using Python API for MLflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python API为MLflow检索最佳模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/retrieving-the-best-model-using-python-api-for-mlflow-7f76bf503692?source=collection_archive---------5-----------------------#2019-11-06">https://medium.com/analytics-vidhya/retrieving-the-best-model-using-python-api-for-mlflow-7f76bf503692?source=collection_archive---------5-----------------------#2019-11-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b3b4593ca9a7ec19626adced49c04532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xq385dWU0Nd305g6MOKwDQ.png"/></div></div></figure><p id="e293" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是我的MLflow教程系列的第五篇文章:</p><ol class=""><li id="b14f" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/setup-mlflow-in-production-d72aecde7fef">在生产中设置ml flow</a></li><li id="3c86" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-basic-logging-functions-e16cdea047b"> MLflow:基本测井功能</a></li><li id="7b18" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-logging-for-tensorflow-37b6a6a53e3c">张量流的MLflow测井</a></li><li id="a03a" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-projects-24c41b00854"> MLflow项目</a></li><li id="789a" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/retrieving-the-best-model-using-python-api-for-mlflow-7f76bf503692">使用Python API为MLflow检索最佳模型</a>(你来了！)</li><li id="3535" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/serving-a-model-using-mlflow-8ba5db0a26c0">使用MLflow服务模型</a></li></ol><p id="9bbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程展示了如何从MLflow运行中检索先前记录的模型。</p><p id="30d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设您使用不同的参数对以下示例进行了多次试验:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="3590" class="km kn hi ki b fi ko kp l kq kr">mlflow run git@github.com:databricks/mlflow-example.git -P alpha=0.5</span></pre><p id="4dce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您想要检索根据特定标准表现最佳的存储模型。你需要导入你的模型所属的MLflow库的深度学习模块。在我的例子中，我使用的是Sklearn工具包模型，所以我导入了<a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.sklearn.html" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">ml flow . sk learn</strong></a>。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="fece" class="km kn hi ki b fi ko kp l kq kr">import mlflow.sklearn<br/>import pandas as pd<br/>import os</span></pre><p id="593d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来我们需要使用MLflow的Python API来查询MLflow跟踪服务器。我们使用<a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.search_runs" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">ml flow . search _ runs()</strong></a>函数。这个函数使用<em class="ks"> filter_string，</em>作为查询的过滤器，并返回一个<em class="ks"> pandas。运行的DataFrame </em>,其中每个指标、参数和标记都被展开到它们自己的名为metrics的列中。*，参数。*、和标签。*分别为。对于没有特定度量、参数或标记的运行，它们的值将分别为(NumPy) Nan、None或None。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="087b" class="km kn hi ki b fi ko kp l kq kr">df = mlflow.search_runs(filter_string="metrics.rmse &lt; 1")</span></pre><p id="123b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦我们有了运行的熊猫数据框架，我们就可以通过使用熊猫的<a class="ae jx" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.idxmin.html" rel="noopener ugc nofollow" target="_blank"> idxmin() </a>或<a class="ae jx" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.idxmax.html" rel="noopener ugc nofollow" target="_blank"> idxmax() </a>函数根据一个度量找到最佳模型。DataFrame，这取决于我们是尝试最小化还是最大化指标。<a class="ae jx" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.idxmin.html" rel="noopener ugc nofollow" target="_blank"> idxmin() </a>返回具有最小度量值的行的索引。然后我们使用这个索引作为<a class="ae jx" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.loc.html" rel="noopener ugc nofollow" target="_blank"> loc() </a>函数的输入来获取整行。最后，<em class="ks"> ['run_id'] </em>将给出给出最佳模型的运行的run_id。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="7783" class="km kn hi ki b fi ko kp l kq kr">run_id = df.loc[df['metrics.rmse'].idxmin()]['run_id']</span></pre><p id="56c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们使用从上一步获得的<em class="ks"> run_id </em>在Python运行时加载模型。为此我们使用深度学习模块的<a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.sklearn.html#mlflow.sklearn.load_model" rel="noopener ugc nofollow" target="_blank"> load_model() </a>函数(在我们的例子中为<a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.sklearn.html" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">ml flow . sk learn</strong></a><strong class="is hj"/>)。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="126a" class="km kn hi ki b fi ko kp l kq kr">model = mlflow.sklearn.load_model("runs:/" + run_id + "/model")</span></pre><p id="4ccf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们从加载的模型中进行推断。这个步骤对于模型和深度学习框架来说是非常特定的，并且在不同的模型之间变化很大。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="54aa" class="km kn hi ki b fi ko kp l kq kr">wine_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "wine-quality.csv")<br/>data = pd.read_csv(wine_path)<br/>test = data.drop(["quality"], axis=1)</span><span id="11d7" class="km kn hi ki b fi kt kp l kq kr">print(model.predict(test))</span></pre><p id="2308" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完整代码:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="c8e3" class="km kn hi ki b fi ko kp l kq kr">import mlflow.sklearn<br/>import pandas as pd<br/>import os</span><span id="a954" class="km kn hi ki b fi kt kp l kq kr">#Reading Pandas Dataframe from mlflow<br/>df=mlflow.search_runs(filter_string="metrics.rmse &lt; 1")</span><span id="7506" class="km kn hi ki b fi kt kp l kq kr">#Fetching Run ID for<br/>run_id = df.loc[df['metrics.rmse'].idxmin()]['run_id']</span><span id="8b0d" class="km kn hi ki b fi kt kp l kq kr">#Load model<br/>model = mlflow.sklearn.load_model("runs:/" + run_id + "/model")<br/></span><span id="7b87" class="km kn hi ki b fi kt kp l kq kr">#Inference<br/>wine_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "wine-quality.csv")<br/>data = pd.read_csv(wine_path)<br/>test = data.drop(["quality"], axis=1)</span><span id="b7b7" class="km kn hi ki b fi kt kp l kq kr">print(model.predict(test))</span></pre><p id="b886" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一篇文章中，我们将探讨如何使用MLflow服务来服务一个模型。</p></div></div>    
</body>
</html>