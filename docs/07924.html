<html>
<head>
<title>Convert midi file to numpy array (Piano Roll)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将midi文件转换为numpy数组(钢琴卷帘窗)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/convert-midi-file-to-numpy-array-in-python-7d00531890c?source=collection_archive---------2-----------------------#2020-07-12">https://medium.com/analytics-vidhya/convert-midi-file-to-numpy-array-in-python-7d00531890c?source=collection_archive---------2-----------------------#2020-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3c65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近在探索一个有趣的话题，神经音乐生成。在试验不同的神经网络结构之前，有一些重要的工作要做:数据收集和数据准备。</p><h1 id="51cc" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">数据收集</h1><p id="94ee" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我已经从<a class="ae kh" href="http://kunstderfuge.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">kunsterfuge</strong></a>订阅了<em class="kg">好友等级</em> (20欧)，收集了足够多的优质古典钢琴midi文件。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/2516025a223b9e56a0dabc2d350daabc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4FYgyIRlWp2Qx5bQ0GEMhg.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">从<a class="ae kh" href="http://kunstderfuge.com/" rel="noopener ugc nofollow" target="_blank">http://kunstderfuge.com/</a>下载高质量的古典midi文件</figcaption></figure><h1 id="51b6" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Midi文件</h1><p id="b756" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">让我们以肖邦的D大调<strong class="ih hj"> <em class="kg">夜曲</em></strong><em class="kg">op .</em><strong class="ih hj"><em class="kg">27</em></strong><em class="kg"/><strong class="ih hj"><em class="kg">№2</em></strong>为例，研究一下midi文件是什么样子的，我们能从中提取出哪些重要的信息。下面是<strong class="ih hj"> <em class="kg"> GarageBand </em> </strong>中“<em class="kg">nocturne _ 27 _ 2 _(c)inoue . mid”</em>的截图。我们可以看到5个音轨，似乎只有第二、第三和第四个音轨可以发声。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ky"><img src="../Images/4acee9ed7fb0e6ac79b600588ed97f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mI753AK4rR_VINLaul0KvA.png"/></div></div></figure><p id="7f48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要查看更多细节，我们可以通过<strong class="ih hj"> <em class="kg"> Mido </em> </strong>在Python中打开(pip install mido)。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lb"><img src="../Images/ed7c249a3a1e25362db85ef620c7e3bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cJ1766TeDLGtJc1LXXgG-w.png"/></div></div></figure><p id="eef2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">midi文件包含一个或多个可以同时播放的轨道。</p><p id="51fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查一下‘夜曲_ 27 _ 2 _(c)inoue . mid’的曲目内容:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lc"><img src="../Images/1f3e693484fa94288db14f4ee640fdb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yI1UHzGmXaTJSWUPfpRF9A.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">轨道0中的前20条消息</figcaption></figure><p id="0476" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kg">第一轨道(轨道0) </em> </strong>包含存储诸如文件描述、拍号、调号、速度等信息的元消息。消息按顺序发送。请注意，在每条消息的末尾都有一个参数“time ”,它用于告知在发送最后一条消息之后和发送当前消息之前的等待时间。在这个音轨中，通过设置“速度”和“时间”，我们可以决定midi文件在每个时间段播放的速度。默认速度是500000。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ld"><img src="../Images/47a3a952430dea1f2b326d677dc516f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OqLqIuoWp-z_6ICm4ORI8Q.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">曲目2中的前20条消息</figcaption></figure><p id="667e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kg">第二轨道(轨道1) </em> </strong>和<strong class="ih hj"> <em class="kg">第三轨道(轨道2) </em> </strong>包含类似的信息:一些元消息，以及主要部分——在什么时间以什么方式演奏什么音符。让我们仔细看看<strong class="ih hj"> <em class="kg">第三轨(track 2) </em> </strong>。</p><ul class=""><li id="087e" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">“note_on”告知按键被按下(或释放，如果力度=0)。</li><li id="d910" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">“note_off”告知要释放按键(力度应始终设定为0)。</li><li id="d531" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">“通道”告知声音将被发送到哪个通道。标准midi同时支持16个通道。</li><li id="c541" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">“note”告诉它是哪个键。我们可以参考下面的地图，找到钢琴键盘上每个midi音符id的对应键。</li><li id="8f23" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">“力度”告诉击键的速度，速度越快，声音越大。</li><li id="74fd" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">“时间”告诉我们上一次操作和当前操作之间的等待时间。音符的时间长度是同一音符的两个最近的信息之间的每个信息的“时间”之和，其中第一个信息告诉您打开音符(当您看到“音符开”且“力度”&gt; 0时)，最后一个信息告诉您关闭音符(当您看到“音符关”或“音符开”且“力度”=0时)。</li></ul><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ls"><img src="../Images/8ab24c81cb6874ee25e16ada0f51a470.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/1*SPjkKvreiBauJA3Lzvy8FQ.gif"/></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">midi音符和88键键盘之间的映射</figcaption></figure><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lt"><img src="../Images/807809ff2ad4fc2dadc97607f492bae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ccGXt16n3LU9ZLJeMa_Fhg.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">曲目3中的前20条消息</figcaption></figure><p id="b9b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kg">第四轨道(轨道3) </em> </strong>主要是<strong class="ih hj"> <em class="kg"> </em> </strong>包含以“control_change”开头的消息，这与踏板的控制有关。因为我主要关心的是笔记，所以现在我将忽略这种类型的消息。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lu"><img src="../Images/428ab206e756d71189f2314bfcf2f413.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ueAxgL4SaO3iqCHneZjB4A.png"/></div></div></figure><p id="249d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kg">第五轨道(轨道4) </em> </strong>只有<strong class="ih hj"> <em class="kg"> </em> </strong>包含2个元消息，这对我们的问题并不重要。</p><p id="eb42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是消息类型和参数值范围的汇总:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lv"><img src="../Images/3b8ba3c520526090bd8060de89d489d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AVO2GbZIpHdj8jTolSgmUg.png"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lw"><img src="../Images/057d994cdf8fcdce56b31face8bc7400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*82yK2or3XRtJrZkM6GKWBA.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx translated">参数类型和范围(<a class="ae kh" href="https://mido.readthedocs.io/en/latest/message_types.html" rel="noopener ugc nofollow" target="_blank">https://mido . readthedocs . io</a></figcaption></figure><h1 id="4c05" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">密码</h1><p id="1b8a" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">有了对midi文件的基本了解，我们现在可以写一些代码把midi文件转换成<strong class="ih hj"> <em class="kg"> numpy数组</em> </strong>。</p><p id="48d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所需的数组格式:</p><ul class=""><li id="17ea" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">Dimension = n行* 88列，每行包含88个音符在特定时间步长的状态。超出钢琴键盘范围的音符将被忽略。</li><li id="713b" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">数组中的值表示力度(0表示音符关，而(0:127)表示音符开)。</li><li id="2a96" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">该阵列组合其消息数量不小于阈值的所有轨道的音符信息。阈值被计算为最长轨道的消息数量的10%。</li></ul><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="2196" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">函数<strong class="ih hj"> <em class="kg"> msg2dict </em> </strong>从每条信息中提取重要信息(音符、力度、时间、开或关)。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="ac85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">函数<strong class="ih hj"> <em class="kg"> switch_note </em> </strong>根据音符、力度、音符开或音符关的新值改变last_state(前一时间步88音符的状态)。每个时间步长的状态包含88个值。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="c05d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">函数<strong class="ih hj"> <em class="kg"> track2seq </em> </strong>将一个轨道中的每条消息转换为一个88值的列表，并将每个列表按顺序存储在结果列表中。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="f027" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">函数<strong class="ih hj"> <em class="kg"> track2seq </em> </strong>在过滤轨迹时考虑最小消息数的阈值，将所有轨迹组合成一个numpy数组。如果两个音轨同时放在同一个音符上，它取较大的力度。</p><p id="b469" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看结果:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lx"><img src="../Images/99c7efc10ad285fd3918e7552c39bfd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICesv8_KOS0tc517k36EAA.png"/></div></div></figure><p id="ea17" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们将转换后的模式与原始模式进行比较:</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ly"><img src="../Images/50fcf0a31035a21dbc9f1fed1d967583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGhrSpmYP-nMvKfoU707kw.png"/></div></div></figure><p id="6003" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以将结果numpy数组转换为midi文件，其中一个轨道只包含音符力度值的信息。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="bbba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">函数<strong class="ih hj"> <em class="kg"> arry2mid </em> </strong>计算相邻时间步长的速度值差值，并将差值转换为轨迹中的信息。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="4134" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在<strong class="ih hj"> <em class="kg"> GarageBand </em> </strong>中打开<strong class="ih hj"> mid_new.mid </strong>，播放一下，看看听起来是不是和原版差不多。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lz"><img src="../Images/350308795f9274687b53a54ee23f9fa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKcukhxWnAy7QrlbOP3uCQ.png"/></div></div></figure></div></div>    
</body>
</html>