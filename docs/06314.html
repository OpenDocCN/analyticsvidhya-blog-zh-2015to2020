<html>
<head>
<title>Twitter Streaming with Apache Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇卡夫卡的Twitter流</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/twitter-streaming-with-apache-kafka-ea0e2f44181e?source=collection_archive---------0-----------------------#2020-05-18">https://medium.com/analytics-vidhya/twitter-streaming-with-apache-kafka-ea0e2f44181e?source=collection_archive---------0-----------------------#2020-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4e01" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Kafka消息系统实时传输twitter数据</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/c3900bbedad5eba92872c961fd7e3a3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1kD6ocfkX4ZQ2elI"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">由<a class="ae jn" href="https://unsplash.com/@konkarampelas?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kon Karampelas </a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="4606" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你有没有想过Twitter、LinkedIn、网飞、优步和AirBnb 的共同点是什么，让它们以高吞吐量服务于如此广泛的受众？他们发展良好的数据工程管道使他们能够每天处理数十亿的数据或信息。</p><blockquote class="kk kl km"><p id="7d0e" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">Apache Kafka解决了从一个数据源到另一个数据源的大量数据移动问题。这是LinkedIn开发的<a class="ae jn" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank">“高吞吐量分布式消息系统</a>”。</p></blockquote><p id="bd68" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Kafka旨在为处理实时数据提供一个统一的、高吞吐量、低延迟的平台。<br/>本文假设您已经熟悉Java、消息传递系统、Apache Kafka及其架构，并且拥有一个Twitter开发人员帐户。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kr"><img src="../Images/f83a024300119dc0c59484244bbc0474.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2RurLWLKjVNsYg3D"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">大数据管道</figcaption></figure><p id="e148" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们将用Java开发一个Kafka producer应用程序，它将从Twitter API数据源获取数据，并将其发布到Kafka主题，供消费者应用程序订阅和消费消息。<br/>这可以通过从Kafka topic获取数据到MongoDB之类的noSql数据库来进一步扩展。</p><h1 id="3260" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated"><strong class="ak">先决条件</strong></h1><ol class=""><li id="e531" class="lk ll hi jq b jr lm ju ln jx lo kb lp kf lq kj lr ls lt lu bi translated">JDK 1.8 (Java 8)</li><li id="e0a8" class="lk ll hi jq b jr lv ju lw jx lx kb ly kf lz kj lr ls lt lu bi translated">卡夫卡</li><li id="2c50" class="lk ll hi jq b jr lv ju lw jx lx kb ly kf lz kj lr ls lt lu bi translated">带有API密钥和访问令牌的Twitter开发人员帐户</li></ol><h1 id="3e09" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated"><strong class="ak">启动Zookeeper和Kafka服务器</strong></h1><p id="07a9" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">转到kafka目录，启动zookeeper，然后从cmd启动kafka服务器。</p><p id="8cb3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du md me mf mg b">bin/zookeeper-server-start.sh config/zookeeper.properties<br/> bin/kafka-server-start.sh config/server.properties</code></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mh"><img src="../Images/8065302f422f7baf6ef1221e5950437c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94XigcGLIddE00VdpFebUQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">动物园管理员在跑步</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mi"><img src="../Images/a41683e472d59c048baf5741ec926c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RkKa4tDT9HbXfwSBR9Enfg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Kafka服务器正在运行</figcaption></figure><p id="c956" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们创建一个Kafka主题<strong class="jq hj"> Twitter-Kafka </strong>，它有3个分区，复制因子为1</p><pre class="iy iz ja jb fd mj mg mk ml aw mm bi"><span id="82d3" class="mn kt hi mg b fi mo mp l mq mr">bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic Twitter-Kafka — partitions 3 --replication-factor 1</span></pre><p id="9c88" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">验证创建的主题<br/> <code class="du md me mf mg b">bin/kafka-topics.sh --zookeeper localhost:2181 --list</code></p></div><div class="ab cl ms mt gp mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="hb hc hd he hf"><h1 id="4c53" class="ks kt hi bd ku kv mz kx ky kz na lb lc io nb ip le ir nc is lg iu nd iv li lj bi translated"><strong class="ak">写作卡夫卡的制片人..</strong></h1><p id="5cfe" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">在pom.xml文件中添加以下maven依赖项。<strong class="jq hj">Kafka-客户端</strong>库用于连接Kafka和<strong class="jq hj"> slf4j-simple </strong>用于记录消息。我们将使用twitter Hosebird客户端核心，它是一个Java HTTP客户端，用于使用twitter的标准<a class="ae jn" href="https://developer.twitter.com/en/docs/tweets/filter-realtime/overview" rel="noopener ugc nofollow" target="_blank">流API </a>。</p><pre class="iy iz ja jb fd mj mg mk ml aw mm bi"><span id="3c5d" class="mn kt hi mg b fi mo mp l mq mr">&lt;dependencies&gt;<br/>   &lt;dependency&gt;<br/>      &lt;groupId&gt;com.twitter&lt;/groupId&gt;<br/>      &lt;artifactId&gt;hbc-core&lt;/artifactId&gt;<br/>      &lt;version&gt;2.2.0&lt;/version&gt;<br/>   &lt;/dependency&gt;<br/>   &lt;dependency&gt;<br/>      &lt;groupId&gt;org.apache.kafka&lt;/group Id&gt;<br/>      &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;<br/>      &lt;version&gt;2.3.0&lt;/version&gt;<br/>   &lt;/dependency&gt;<br/>   &lt;dependency&gt;<br/>      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;<br/>      &lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;<br/>      &lt;version&gt;1.7.26&lt;/version&gt;<br/>   &lt;/dependency&gt;<br/>&lt;/dependencies&gt;</span></pre><p id="4110" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">创建<strong class="jq hj">KafkaConfig.java</strong>文件来存储凭证。将配置存储在配置文件中总是比直接公开或硬编码要好。</p><pre class="iy iz ja jb fd mj mg mk ml aw mm bi"><span id="885e" class="mn kt hi mg b fi mo mp l mq mr">public static final String BOOTSTRAPSERVERS  = "127.0.0.1:9092";<br/>public static final String TOPIC = "Twitter-Kafka";<br/>public static final String ACKS_CONFIG = "all";<br/>public static final String MAX_IN_FLIGHT_CONN = "5";</span><span id="778b" class="mn kt hi mg b fi ne mp l mq mr">public static final String COMPRESSION_TYPE = "snappy";<br/>public static final String RETRIES_CONFIG = Integer.toString(Integer.MAX_VALUE);<br/>public static final String LINGER_CONFIG = "20";<br/>public static final String BATCH_SIZE = Integer.toString(32*1024);</span></pre><p id="8625" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">类似地，创建TwitterConfig.java的T4来存储Twitter API密钥T7和访问令牌T9</p><pre class="iy iz ja jb fd mj mg mk ml aw mm bi"><span id="f31a" class="mn kt hi mg b fi mo mp l mq mr">public static final String CONSUMER_KEYS= "H8***42";<br/>public static final String CONSUMER_SECRETS= "xn***dI";<br/>public static final String SECRET = "SPz***Xg";<br/>public static final String TOKEN = "13***1";</span></pre><h1 id="81b5" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">Twitter生产者类</h1><p id="5a62" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">创建<strong class="jq hj">TwitterProducer.java</strong>，看起来像这样</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nf ng l"/></div></figure><p id="ac8e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们在这里搜索术语<strong class="jq hj"> <em class="kn">【冠状病毒】</em> </strong>来过滤掉推文。<br/>现在让我们编写<strong class="jq hj"> createTwitterClient() </strong>和<strong class="jq hj"> createKafkaProducer() </strong>分别连接Twitter和Kafka。记录器将用于记录消息。</p><h1 id="f640" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated"><strong class="ak">推特客户端</strong></h1><p id="445a" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">方法<strong class="jq hj"> createTwitterClient() </strong>将使用Hosebird客户端来sccs并返回客户端。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nf ng l"/></div></figure><h1 id="5cdc" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">Kafka制作人设置</h1><p id="c558" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated"><strong class="jq hj"> createKafkaProducer() </strong>方法使用<strong class="jq hj">KafkaConfig.java</strong>来获取属性设置，以连接到我们的Kafka服务器(bootstrap-server)，序列化要发送到Kafka代理的键和值。已经配置了一些其他设置，如<strong class="jq hj">ack _ CONFIG、BATCH_SIZE_CONFIG、ENABLE_IDEMPOTENCE_CONFIG、RETRIES_CONFIG </strong>等。来优化生产者。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nf ng l"/></div></figure><h1 id="c8f5" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">收尾工作..</h1><p id="0f84" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">现在我们创建<strong class="jq hj"> run() </strong>方法，它首先调用<strong class="jq hj"> createTwitterClient() </strong>方法连接到Twitter客户端，然后<strong class="jq hj"> createKafkaProducer()调用</strong>创建并获取KafkaProducer实例。</p><p id="7a9e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们使用<code class="du md me mf mg b">BlockingQueue&lt;String&gt; msgQueue</code>从客户端获取数据，使用<code class="du md me mf mg b">producer.send(new ProducerRecord&lt;String, String&gt;(KafkaConfig.TOPIC, null, msg)</code>向kafka主题发送数据。下面是while()循环，它一直运行到客户端结束。</p><pre class="iy iz ja jb fd mj mg mk ml aw mm bi"><span id="35d7" class="mn kt hi mg b fi mo mp l mq mr">while (!client.isDone()) {<br/>    String msg = null;<br/>    try {<br/>        <strong class="mg hj">msg = msgQueue.poll(5, TimeUnit.SECONDS);</strong><br/>    } catch (InterruptedException e) {<br/>        // Stop client<br/>        client.stop();<br/>    }<br/>    if (msg != null) {<br/>        <strong class="mg hj">producer.send(new ProducerRecord&lt;String, String&gt;(KafkaConfig.TOPIC, null, msg), new Callback()</strong> {<br/>           // Override onCompletion() method<br/>        });<br/>    }<br/>}</span></pre><p id="7d14" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是run()方法的代码片段。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nf ng l"/></div></figure><h1 id="5a08" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">让我们开始流式传输..</h1><p id="7899" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">最后，我们通过运行<strong class="jq hj">twiterproducer()来启动Kafka生成器。运行()</strong></p><pre class="iy iz ja jb fd mj mg mk ml aw mm bi"><span id="09bb" class="mn kt hi mg b fi mo mp l mq mr">public static void main(String[] args) {<br/>    new TwitterProducer().run();<br/>}</span></pre><h1 id="f841" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">输出</h1><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nh"><img src="../Images/32584ba0c1586e3cc52c6efd1948d83f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aYqGiagZyMVTH9MTBH13OA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">实时Twitter流</figcaption></figure><p id="aa74" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们验证数据是否发布到kafka主题。<br/> <code class="du md me mf mg b">bin/kafka-console-consumer.sh --bootstrap-server 127.0.0.1:9092 --topic Twitter-Kafka — group my-first-app --from-beginning</code></p><p id="dc69" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果消费者还没有确定的偏移量来消费，那么使用<code class="du md me mf mg b">--from-beginning</code>将从日志中最早的消息开始，而不是从最新的消息开始。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ni"><img src="../Images/19d6c5f97975f791eba386a6d833d163.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2yfJw-wUKBVg2GlIFqU-rw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Kafka消费者(控制台)</figcaption></figure><p id="89b2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在下一部分中，我们将看到如何用Java创建一个Kafka Producer类来订阅Kafka主题、读取tweets并将数据接收到MongoDB中。</p><p id="bcc8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了你的参考，完整的代码可以在<a class="ae jn" href="https://github.com/shefalibisht00/BigData-Engineering.git" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><h1 id="9996" class="ks kt hi bd ku kv kw kx ky kz la lb lc io ld ip le ir lf is lg iu lh iv li lj bi translated">结论</h1><p id="994a" class="pw-post-body-paragraph jo jp hi jq b jr lm ij jt ju ln im jw jx ma jz ka kb mb kd ke kf mc kh ki kj hb bi translated">我们看到了如何使用简单的Java HTTP kafka客户端库创建Java Kafka生成器。我们使用Twitter API实时传输用户推文，并将其发布到Kafka主题。</p></div></div>    
</body>
</html>