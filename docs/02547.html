<html>
<head>
<title>Web Scraping Tool to collect Water Quality Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">收集水质数据的网页抓取工具</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/web-scrapping-tool-to-collect-water-quality-data-3591fe8bc8bc?source=collection_archive---------10-----------------------#2019-12-22">https://medium.com/analytics-vidhya/web-scrapping-tool-to-collect-water-quality-data-3591fe8bc8bc?source=collection_archive---------10-----------------------#2019-12-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3294844dc230bcdc14233228182ceabf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WrT6MrnWBz7P4a-XEDgoMg.jpeg"/></div></div></figure><p id="1633" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据收集是数据分析过程中的第一步，也是最重要的一步。很多时候，人们会问收集的数据是第一手的还是第二手的。术语“原始数据”是指您自己收集的数据，而不是您在另一方最初记录后收集的数据。原始数据是直接从来源获得的信息。你将会是第一个使用这些数据的人。</p><p id="9966" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从根本上说，收集不同类型的数据有不同的技术。但总的来说，大多数时候，遵循以下五个步骤。</p><p id="4b6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1.确定你想收集什么信息<br/> 2。设定数据收集的时间表<br/> 3。确定你的数据收集方法<br/> 4。收集数据<br/> 5。分析数据并实施您的发现</p><p id="ace3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的工作中，我一直在寻找印度班加罗尔市某个地表水体的水质数据。对于原始数据收集，第一步是确定水质参数，然后建立IOT系统。这个故事不是为了收集原始数据。在我继续收集二次数据之前，请观看下面的视频，它解释了基于IOT的气象监测系统。同样，对于水质监测，可以使用arduino、ESP 8266和传感器(如PH值、温度、溶解氧、超声波传感器)构建IOT系统。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="js jt l"/></div></figure><p id="61ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于次要数据收集，我使用python脚本从主要来源获取数据。卡纳塔克邦污染控制委员会监测卡纳塔克邦的空气、水和环境。主要城市收集的数据公布在他们的网站上。历史数据也可以从电路板上收集。</p><ol class=""><li id="56fc" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn jz ka kb kc bi translated">导入必要的python库。</li></ol><pre class="jo jp jq jr fd kd ke kf kg aw kh bi"><span id="b5b2" class="ki kj hi ke b fi kk kl l km kn">import os.path<br/>from requests import get<br/>from requests.exceptions import RequestException<br/>from contextlib import closing<br/>import time<br/>import re</span></pre><p id="7081" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.为错误记录、评估URL的连接性以及重试连接定义函数。</p><pre class="jo jp jq jr fd kd ke kf kg aw kh bi"><span id="51ec" class="ki kj hi ke b fi kk kl l km kn">def log_error(e):<br/>    print(e)<br/>    <br/>def is_good_response(resp):<br/>    content_type = resp.headers['Content-Type'].lower()<br/>    return (resp.status_code == 200 and content_type is not None and content_type.find('html') &gt; -1)</span><span id="c25e" class="ki kj hi ke b fi ko kl l km kn">def retry(url) :<br/>    cont = None<br/>    for i in range(1,4) :<br/>        time.sleep(10)<br/>        try:<br/>            with closing(get(url, stream=True)) as resp:<br/>                if is_good_response(resp):<br/>                    print(i," Retrying - Connected - ",url)<br/>                    cont = resp.content<br/>                    break<br/>        except RequestException as e:<br/>            log_error('Error during requests to {0} : {1}'.format(url, str(e)))<br/>    return cont</span></pre><p id="7687" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.一旦与URL的连接正常，就可以访问网页的完整内容。这可以如下实现。</p><pre class="jo jp jq jr fd kd ke kf kg aw kh bi"><span id="d3c5" class="ki kj hi ke b fi kk kl l km kn">def get_url_content(url):<br/>    try:<br/>        with closing(get(url, stream=True)) as resp:<br/>            if is_good_response(resp):<br/>                print("Connected - ",url)<br/>                return resp.content<br/>            else:<br/>                cont = retry(url)<br/>                return cont<br/>    except RequestException as e:<br/>        log_error('Error during requests to {0} : {1}'.format(url, str(e)))<br/>        return retry(url)</span></pre><p id="f47e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.现在，我需要一个函数，以便在获取和处理数据后写入csv文件。下面的函数是一个通用的函数，可以用来在附加模式下向文件中写入文本。</p><pre class="jo jp jq jr fd kd ke kf kg aw kh bi"><span id="513f" class="ki kj hi ke b fi kk kl l km kn">def write_file(text):<br/>    try :<br/>        f = open(datafile,'a')<br/>        f.write(text)<br/>    except :<br/>        log_error('Error during writing to a file')<br/>        time.sleep(10)<br/>        try :<br/>            f = open(datafile,'a')<br/>            f.write(text)<br/>        except :<br/>            log_error('Second time - Error during writing to a file')<br/>    finally :<br/>        f.close</span></pre><p id="993b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.下面的代码通过调用上面定义的函数来完成剩下的工作，比如获取数据、处理内容和写入文件。从网站上获取的内容将是字节类型的，它需要解码为文本。内容包括各种水质参数和各种站点的数据。以下代码仅考虑17519站的数据。</p><pre class="jo jp jq jr fd kd ke kf kg aw kh bi"><span id="ebf5" class="ki kj hi ke b fi kk kl l km kn">datafile = "water_quality_data.csv"<br/>url = "<a class="ae kp" href="http://bwssb.aaxisnano.com/services/getBwssbStationData.aspx" rel="noopener ugc nofollow" target="_blank">http://bwssb.aaxisnano.com/services/getBwssbStationData.aspx</a>"    content = get_url_content(url)</span><span id="5867" class="ki kj hi ke b fi ko kl l km kn">data = content.decode()<br/>data_1 = extract_between('[',']',data)</span><span id="c689" class="ki kj hi ke b fi ko kl l km kn">lakes = data_1.split('{"dt_timestamp":')<br/>flag = 0<br/>for lake in lakes :<br/>    parameterText = lake.split(',')<br/>    waterqualitylake = ""<br/>    for i, paraText in enumerate(parameterText) :<br/>        if i == 0 and len(paraText) &gt; 0 :<br/>            datetext = re.findall('"([^"]*)"',paraText)<br/>        elif i == 1:<br/>            values = paraText.split(':')<br/>            stationid = values[1:]<br/>            if stationid != ['17519'] :<br/>                flag = 1<br/>                break<br/>            else:<br/>                waterqualitylake += str(datetext) + ","<br/>                flag = 0<br/>        elif i &gt; 1 and flag == 0 :<br/>            print(i,paraText)<br/>            values = paraText.split(':')<br/>            value = values[1:]<br/>            waterqualitylake += str(value) + ","<br/>    if flag == 0 and len(parameterText) &gt; 1:<br/>        waterqualitylake += "\n"<br/>        write_file(waterqualitylake)</span></pre><p id="9a9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述脚本必须计划定期运行。这可以通过各种方式实现，这里我提供两种方法</p><ol class=""><li id="afc8" class="ju jv hi is b it iu ix iy jb jw jf jx jj jy jn jz ka kb kc bi translated">在服务器上复制脚本，并计划cron作业或通过windows计划程序。详情请参考这篇文章。</li></ol><div class="kq kr ez fb ks kt"><a href="https://datatofish.com/python-script-windows-scheduler/" rel="noopener  ugc nofollow" target="_blank"><div class="ku ab dw"><div class="kv ab kw cl cj kx"><h2 class="bd hj fi z dy ky ea eb kz ed ef hh bi translated">如何使用Windows调度程序调度Python脚本</h2><div class="la l"><h3 class="bd b fi z dy ky ea eb kz ed ef dx translated">在本教程中，我将向您展示使用Windows调度程序调度Python脚本的步骤。这种类型的运动是…</h3></div><div class="lb l"><p class="bd b fp z dy ky ea eb kz ed ef dx translated">datatofish.com</p></div></div><div class="lc l"><div class="ld l le lf lg lc lh io kt"/></div></div></a></div><p id="add7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.在pythonanywhere上安排python脚本。使用免费的pythonanywhere帐户，无法从其环境访问外部网站。所以需要最低限度的付费订阅。</p><div class="kq kr ez fb ks kt"><a href="https://pythonhow.com/how-schedule-python-task-pythonanywhere/" rel="noopener  ugc nofollow" target="_blank"><div class="ku ab dw"><div class="kv ab kw cl cj kx"><h2 class="bd hj fi z dy ky ea eb kz ed ef hh bi translated">在PythonAnywhere - PythonHow上调度Python任务</h2><div class="la l"><h3 class="bd b fi z dy ky ea eb kz ed ef dx translated">你有没有想过如何让Python脚本在每天睡觉的特定时间运行？也许你…</h3></div><div class="lb l"><p class="bd b fp z dy ky ea eb kz ed ef dx translated">pythonhow.com</p></div></div><div class="lc l"><div class="li l le lf lg lc lh io kt"/></div></div></a></div><p id="2045" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>