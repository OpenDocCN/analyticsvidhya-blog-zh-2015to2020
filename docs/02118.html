<html>
<head>
<title>Automated ML with Azure Synapse Analytics.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Synapse Analytics的自动化ML。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automated-ml-with-azure-synapse-analytics-258bd1f51be8?source=collection_archive---------14-----------------------#2019-12-01">https://medium.com/analytics-vidhya/automated-ml-with-azure-synapse-analytics-258bd1f51be8?source=collection_archive---------14-----------------------#2019-12-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c81b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">统一的分析工具，可摄取、计算或处理数据、存储数据、高级分析或机器学习，并在一个工具中显示所有内容。端到端数据分析平台专为扩展和易用性而构建。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/00a8f1423e0bc94e41365dc3ac024ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9cdu8zoiIE5X3wttguHYrA.jpeg"/></div></div></figure><p id="2239" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Synapse能够运行基于spark的代码，从而实现数据工程或特征工程以及机器学习。本文描述了如何在synapse中使用spark训练机器学习模型。</p><ul class=""><li id="79dc" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">创建Azure机器学习服务。选择与synapse analytics相同的区域。</li><li id="4e90" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">创建pyspark笔记本。</li><li id="b543" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">在笔记本的单独单元格中运行每个批处理语句。</li></ul><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="27db" class="ki kj hi ke b fi kk kl l km kn">import azureml.core <br/>print(azureml.core.VERSION)</span><span id="34e9" class="ki kj hi ke b fi ko kl l km kn">import os <br/>subscription_id = "xxxxxxxxx-xxxxxxxxxxx-xxxxxxxxxx-xxxxxxx" resource_group = "eastus_xxxxx_rg" <br/>workspace_name = "eastus_xxxxx_ws" <br/>workspace_region = "East US 2"</span></pre><p id="a269" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作区不存在下面的代码也将创建工作区</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="44ef" class="ki kj hi ke b fi kk kl l km kn">from azureml.core import Workspace <br/>try:<br/>  ws = Workspace(subscription_id = subscription_id, resource_group = resource_group, workspace_name = workspace_name) </span><span id="a1a6" class="ki kj hi ke b fi ko kl l km kn"># write the details of the workspace to a configuration file to the notebook library <br/>  ws.write_config()<br/> <br/>  print("Workspace configuration succeeded. Skip the workspace creation steps below") <br/>except: <br/>  print("Workspace not accessible. Change your parameters or create a new workspace below")</span></pre><p id="9592" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从配置文件中加载工作区信息。通常配置文件是一个JSON文件。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="a6d4" class="ki kj hi ke b fi kk kl l km kn">import azureml.core from azureml.core <br/>import Workspace, Datastore <br/>ws = Workspace.from_config()</span></pre><p id="ce83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建CPU或GPU集群:根据所需的处理量创建CPU或GPU集群。下面的代码为教程创建了CPU集群。如果集群已经存在，那么也使用它。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="7895" class="ki kj hi ke b fi kk kl l km kn">from azureml.core.compute import ComputeTarget, AmlCompute <br/>from azureml.core.compute_target import ComputeTargetException </span><span id="6c0f" class="ki kj hi ke b fi ko kl l km kn"># Choose a name for your CPU cluster <br/>cpu_cluster_name = "cpucluster" <br/># Verify that cluster does not exist already <br/>try: <br/>  cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name) <br/>  print("Found existing cpucluster") <br/>except ComputeTargetException: <br/>  print("Creating new cpucluster") </span><span id="123b" class="ki kj hi ke b fi ko kl l km kn"># Specify the configuration for the new cluster <br/>compute_config = AmlCompute.provisioning_configuration(vm_size="STANDARD_D2_V2", min_nodes=0, max_nodes=4)<br/> <br/># Create the cluster with the specified name and configuration cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)<br/> <br/># Wait for the cluster to complete, show the output log cpu_cluster.wait_for_completion(show_output=True)</span></pre><p id="d850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python数据准备sdk。以下是详细信息的链接。<a class="ae kp" href="https://docs.microsoft.com/en-us/python/api/azureml-dataprep/?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/python/API/azure ml-data prep/？view=azure-ml-py </a></p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="0806" class="ki kj hi ke b fi kk kl l km kn">import azureml.dataprep as dprep</span></pre><p id="583b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用数据准备库加载特征工程的样本数据集。这个数据集用于我们的自动化机器学习。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="4930" class="ki kj hi ke b fi kk kl l km kn">dataset_root = "https://dprepdata.blob.core.windows.net/demo" </span><span id="fc41" class="ki kj hi ke b fi ko kl l km kn">green_path = "/".join([dataset_root, "green-small/*"]) <br/>yellow_path = "/".join([dataset_root, "yellow-small/*"]) </span><span id="1167" class="ki kj hi ke b fi ko kl l km kn">green_df = dprep.read_csv(path=green_path, header=dprep.PromoteHeadersMode.GROUPED) </span><span id="f635" class="ki kj hi ke b fi ko kl l km kn"># auto_read_file will automatically identify and parse the file type, and is useful if you don't know the file type <br/>yellow_df = dprep.auto_read_file(path=yellow_path) </span><span id="88da" class="ki kj hi ke b fi ko kl l km kn">green_df.head(5) <br/>yellow_df.head(5)</span></pre><p id="9b1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">删除为空值的列。获取可用于机器学习模型的列。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="8723" class="ki kj hi ke b fi kk kl l km kn">all_columns = dprep.ColumnSelector(term=".*", use_regex=True) </span><span id="d5f9" class="ki kj hi ke b fi ko kl l km kn">drop_if_all_null = [all_columns, dprep.ColumnRelationship(dprep.ColumnRelationship.ALL)] </span><span id="ca94" class="ki kj hi ke b fi ko kl l km kn">useful_columns = [ "cost", "distance", "dropoff_datetime", "dropoff_latitude", "dropoff_longitude", "passengers", "pickup_datetime", "pickup_latitude", "pickup_longitude", "store_forward", "vendor" <br/>]</span></pre><p id="7c4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">替换NA，删除空值，并将列名更改为数据集之间通用的名称。将两个数据集合并成一个完整的数据集。</p><p id="df34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新单元格:</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="0e41" class="ki kj hi ke b fi kk kl l km kn">tmp_df = (green_df     <br/>	.replace_na(columns=all_columns)     	.drop_nulls(*drop_if_all_null)     	.rename_columns(column_pairs={<br/>         "VendorID": "vendor",<br/>         "lpep_pickup_datetime": "pickup_datetime",<br/>         "Lpep_dropoff_datetime": "dropoff_datetime",<br/>         "lpep_dropoff_datetime": "dropoff_datetime",<br/>         "Store_and_fwd_flag": "store_forward",<br/>         "store_and_fwd_flag": "store_forward",<br/>         "Pickup_longitude": "pickup_longitude",<br/>         "Pickup_latitude": "pickup_latitude",<br/>         "Dropoff_longitude": "dropoff_longitude",<br/>         "Dropoff_latitude": "dropoff_latitude",<br/>         "Passenger_count": "passengers",<br/>         "Fare_amount": "cost",<br/>         "Trip_distance": "distance"<br/>      })<br/>     .keep_columns(columns=useful_columns)) </span><span id="af1b" class="ki kj hi ke b fi ko kl l km kn">tmp_df.head(5)</span></pre><p id="0915" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新单元格:</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="18b2" class="ki kj hi ke b fi kk kl l km kn">green_df = tmp_df</span></pre><p id="2715" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新单元格:</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="df88" class="ki kj hi ke b fi kk kl l km kn">tmp_df = (yellow_df <br/>	.replace_na(columns=all_columns)<br/> 	.drop_nulls(*drop_if_all_null)<br/>	.rename_columns(column_pairs={<br/>	 "vendor_name": "vendor",<br/>	 "VendorID": "vendor", <br/>	 "vendor_id": "vendor",<br/>	 "Trip_Pickup_DateTime": "pickup_datetime",<br/>	 "tpep_pickup_datetime": "pickup_datetime",<br/>	 "Trip_Dropoff_DateTime": "dropoff_datetime",<br/>	 "tpep_dropoff_datetime": "dropoff_datetime",<br/>	 "store_and_forward": "store_forward",<br/> 	 "store_and_fwd_flag": "store_forward",<br/>	 "Start_Lon": "pickup_longitude",<br/>	 "Start_Lat": "pickup_latitude",<br/>	 "End_Lon": "dropoff_longitude",<br/>	 "End_Lat": "dropoff_latitude",<br/>	 "Passenger_Count": "passengers",<br/>	 "passenger_count": "passengers",<br/>	 "Fare_Amt": "cost",<br/>	 "fare_amount": "cost",<br/>	 "Trip_Distance": "distance",<br/>	 "trip_distance": "distance" })<br/>	 .keep_columns(columns=useful_columns)) </span><span id="f640" class="ki kj hi ke b fi ko kl l km kn">tmp_df.head(5)</span></pre><p id="f4b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新单元格:</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="2da9" class="ki kj hi ke b fi kk kl l km kn">yellow_df = tmp_df </span><span id="1616" class="ki kj hi ke b fi ko kl l km kn">combined_df = green_df.append_rows([yellow_df])</span></pre><p id="c24b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请求数据配置文件，该文件收集数据流产生的全部数据的汇总统计信息。数据配置文件对于理解输入数据、识别异常和缺失值以及验证数据准备操作是否产生了预期结果非常有用。<a class="ae kp" href="https://docs.microsoft.com/en-us/python/api/azureml-dataprep/azureml.dataprep.dataflow?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/python/API/azure ml-data prep/azure ml . data prep . data flow？view=azure-ml-py </a></p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="d810" class="ki kj hi ke b fi kk kl l km kn">decimal_type = dprep.TypeConverter(data_type=dprep.FieldType.DECIMAL) </span><span id="4b83" class="ki kj hi ke b fi ko kl l km kn">combined_df = combined_df.set_column_types(type_conversions={ <br/>	"pickup_longitude": decimal_type, <br/>	"pickup_latitude": decimal_type, <br/>	"dropoff_longitude": decimal_type, <br/>	"dropoff_latitude": decimal_type <br/>}) </span><span id="33ff" class="ki kj hi ke b fi ko kl l km kn">combined_df.keep_columns(columns=[<br/>	 "pickup_longitude", "pickup_latitude", "dropoff_longitude", "dropoff_latitude" <br/>]).get_profile()<br/></span><span id="8e57" class="ki kj hi ke b fi ko kl l km kn">tmp_df = (combined_df<br/>	 .drop_nulls( columns=[<br/>		"pickup_longitude",<br/>		"pickup_latitude", <br/>		"dropoff_longitude", <br/>		"dropoff_latitude"],<br/>column_relationship=dprep.ColumnRelationship(dprep.ColumnRelationship.ANY) ) <br/>	.filter(dprep.f_and( <br/>		dprep.col("pickup_longitude") &lt;= -73.72,<br/>		dprep.col("pickup_longitude") &gt;= -74.09,<br/>		dprep.col("pickup_latitude") &lt;= 40.88,<br/>		dprep.col("pickup_latitude") &gt;= 40.53,<br/>		dprep.col("dropoff_longitude") &lt;= -73.72, 		<br/>		dprep.col("dropoff_longitude") &gt;= -74.09, <br/>		dprep.col("dropoff_latitude") &lt;= 40.88, <br/>		dprep.col("dropoff_latitude") &gt;= 40.53<br/> )))<br/> tmp_df.keep_columns(columns=[ <br/>"pickup_longitude", "pickup_latitude", <br/>"dropoff_longitude", "dropoff_latitude" <br/>]).get_profile()</span></pre><p id="fdaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将tmp_df重新分配给combined_df</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="2e3d" class="ki kj hi ke b fi kk kl l km kn">combined_df = tmp_df</span></pre><p id="3f16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对组合测向进行分析。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="9179" class="ki kj hi ke b fi kk kl l km kn">combined_df.keep_columns(columns='store_forward').get_profile()</span></pre><p id="f607" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Store_forward列，用N替换0。也将空值填充为n。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="1ae6" class="ki kj hi ke b fi kk kl l km kn">combined_df = combined_df.replace(columns="store_forward", find="0", replace_with="N").fill_nulls("store_forward", "N")</span></pre><p id="4f05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于距离列，将. 00替换为0。也将空值填充为0。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="5b6d" class="ki kj hi ke b fi kk kl l km kn">combined_df = combined_df.replace(columns="distance", find=".00", replace_with=0).fill_nulls("distance", 0) combined_df = combined_df.to_number(["distance"])</span></pre><p id="8dc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重命名列，合并和分析。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="aa6e" class="ki kj hi ke b fi kk kl l km kn">tmp_df_renamed = (tmp_df <br/>	.rename_columns(column_pairs={ <br/>		"pickup_datetime_1": "pickup_date",<br/>		"pickup_datetime_2": "pickup_time", 		"dropoff_datetime_1": "dropoff_date", 		"dropoff_datetime_2": "dropoff_time"<br/>})) </span><span id="ea76" class="ki kj hi ke b fi ko kl l km kn">tmp_df_renamed.head(5)</span><span id="b845" class="ki kj hi ke b fi ko kl l km kn">combined_df = tmp_df_renamed combined_df.get_profile()</span><span id="e4a2" class="ki kj hi ke b fi ko kl l km kn">tmp_df = tmp_df.drop_columns(columns=["pickup_datetime", "dropoff_datetime"])</span></pre><p id="4075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对数据执行“拉”操作，并用为每列自动推断的转换候选项填充conversion_candidates。<a class="ae kp" href="https://docs.microsoft.com/en-us/python/api/azureml-dataprep/azureml.dataprep.api.builders.columntypesbuilder?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/python/API/azure ml-data prep/azure ml . data prep . API . builders . columntypesbuilder？view=azure-ml-py </a></p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="120d" class="ki kj hi ke b fi kk kl l km kn">type_infer = tmp_df.builders.set_column_types() <br/>type_infer.learn() <br/>type_infer</span></pre><p id="7a85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用此对象的当前状态将“set_column_types”步骤添加到原始数据流<a class="ae kp" href="https://docs.microsoft.com/en-us/python/api/azureml-dataprep/azureml.dataprep.api.builders.columntypesbuilder?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/python/API/azure ml-data prep/azure ml . data prep . API . builders . columntypesbuilder？view=azure-ml-py </a></p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="6e4b" class="ki kj hi ke b fi kk kl l km kn">tmp_df = type_infer.to_dataflow() <br/>tmp_df.get_profile()</span></pre><p id="95ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅取大于0的值。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="f13e" class="ki kj hi ke b fi kk kl l km kn">tmp_df = tmp_df.filter(dprep.col("distance") &gt; 0) <br/>tmp_df = tmp_df.filter(dprep.col("cost") &gt; 0)</span><span id="e58d" class="ki kj hi ke b fi ko kl l km kn">import azureml.dataprep as dprep</span></pre><p id="1598" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，数据已经准备好了。现在，我们将使用规范或参数来配置自动机器学习。然后提交给自动机器学习来运行。</p><p id="5b8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为自动机器学习加载必要的导入。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="8dd8" class="ki kj hi ke b fi kk kl l km kn">import azureml.core import pandas as pd <br/>from azureml.core.workspace import Workspace <br/>import logging</span></pre><p id="a430" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">加载工作空间配置以提交建模。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="41a4" class="ki kj hi ke b fi kk kl l km kn">ws = Workspace.from_config() </span><span id="240f" class="ki kj hi ke b fi ko kl l km kn"># choose a name for the run history container in the workspace experiment_name = 'automated-ml-regression' </span><span id="e733" class="ki kj hi ke b fi ko kl l km kn"># project folder project_folder = './automated-ml-regression' <br/>import os </span><span id="2d6d" class="ki kj hi ke b fi ko kl l km kn">output = {} <br/>output['SDK version'] = azureml.core.VERSION <br/>output['Subscription ID'] = ws.subscription_id <br/>output['Workspace'] = ws.name <br/>output['Resource Group'] = ws.resource_group <br/>output['Location'] = ws.location <br/>output['Project Directory'] = project_folder pd.set_option('display.max_colwidth', -1) <br/>outputDf = pd.DataFrame(data = output, index = ['']) <br/>outputDf.T</span></pre><ul class=""><li id="1115" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">设置功能的列</li><li id="83b7" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">设置标签列</li></ul><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="3208" class="ki kj hi ke b fi kk kl l km kn">dflow_X = dflow_prepared.keep_columns(['pickup_weekday','pickup_hour', 'distance','passengers', 'vendor']) </span><span id="9ddc" class="ki kj hi ke b fi ko kl l km kn">dflow_y = dflow_prepared.keep_columns('cost')</span></pre><p id="d888" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">拆分数据集用于训练和测试。训练用于训练模型。测试用于验证。拆分就是80%训练，20%测试。值是随机选择的。展平数据框，使其可用于模型。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="db11" class="ki kj hi ke b fi kk kl l km kn">from sklearn.model_selection import train_test_split <br/>x_df = dflow_X.to_pandas_dataframe() <br/>y_df = dflow_y.to_pandas_dataframe() </span><span id="dcd5" class="ki kj hi ke b fi ko kl l km kn">x_train, x_test, y_train, y_test = train_test_split(x_df, y_df, test_size=0.2, random_state=223) </span><span id="6270" class="ki kj hi ke b fi ko kl l km kn"># flatten y_train to 1d array <br/>y_train.values.flatten()</span></pre><p id="226c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">配置自动机器学习参数或规范。设置迭代、超时、要计算的主要指标、日志记录信息和交叉验证值。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="24e0" class="ki kj hi ke b fi kk kl l km kn">automl_settings = {<br/> "iteration_timeout_minutes" : 10,<br/> "iterations" : 30,<br/> "primary_metric" : 'spearman_correlation',<br/> "preprocess" : True,<br/> "verbosity" : logging.INFO,<br/> "n_cross_validations": 5<br/>}</span></pre><p id="f78d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将上述配置设置为自动机器学习。选择回归模型，提供路径、特征和标签的训练值，以及要运行的上述自动机器学习参数/规格。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="faab" class="ki kj hi ke b fi kk kl l km kn">from azureml.train.automl import AutoMLConfig </span><span id="d510" class="ki kj hi ke b fi ko kl l km kn"># local compute <br/>automated_ml_config = AutoMLConfig(task = 'regression',<br/> debug_log = 'automated_ml_errors.log',<br/> path = project_folder,<br/> X = x_train.values,<br/> y = y_train.values.flatten(),<br/> **automl_settings)</span></pre><p id="9b6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提交要运行的模型。这一步将采取。我的花了将近12分钟。我使用最多4个节点的cpu集群。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="1f5f" class="ki kj hi ke b fi kk kl l km kn">from azureml.core.experiment import Experiment </span><span id="32a9" class="ki kj hi ke b fi ko kl l km kn">experiment=Experiment(ws, experiment_name) </span><span id="a695" class="ki kj hi ke b fi ko kl l km kn">local_run = experiment.submit(automated_ml_config, show_output=True)</span></pre><p id="2522" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从迭代中计算度量，并对它们进行平均。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="2500" class="ki kj hi ke b fi kk kl l km kn">children = list(local_run.get_children()) </span><span id="44cf" class="ki kj hi ke b fi ko kl l km kn">metricslist = {}<br/> <br/>for run in children: <br/>	properties = run.get_properties() <br/>	metrics = {k: v for k, v in run.get_metrics().items() <br/>	 if isinstance(v, float)<br/>	}<br/>	metricslist[int(properties['iteration'])] = metrics </span><span id="7a8a" class="ki kj hi ke b fi ko kl l km kn">rundata = pd.DataFrame(metricslist).sort_index(1) <br/>rundata</span></pre><p id="4a72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">展示最佳模型。获取模型的输出指标，以显示模型的准确性。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="c406" class="ki kj hi ke b fi kk kl l km kn">best_run, fitted_model = local_run.get_output() <br/>print(best_run) <br/>print(fitted_model)</span></pre><p id="9620" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注册模型，这样我们就可以使用id作为web服务部署到推理。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="855c" class="ki kj hi ke b fi kk kl l km kn">description = 'Automated Machine Learning Model' <br/>tags = None <br/>local_run.register_model(description=description, tags=tags) </span><span id="90a8" class="ki kj hi ke b fi ko kl l km kn">print(local_run.model_id) <br/># Use this id to deploy the model as a web service in Azure</span></pre><p id="2015" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">显示预测输出并验证输出，以确保模型运行良好。</p><pre class="je jf jg jh fd kd ke kf kg aw kh bi"><span id="0baa" class="ki kj hi ke b fi kk kl l km kn">y_predict = fitted_model.predict(x_test.values) <br/>print(y_predict[:10])</span></pre><p id="1bba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使模型更好地工作于特征工程，尝试重新运行模型，并查看哪个模型表现良好。</p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><p id="138c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kx">最初发表于</em><a class="ae kp" href="https://github.com/balakreshnan/synapseAnalytics/blob/master/AzureMLSDKtest.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="kx">。</em></p></div></div>    
</body>
</html>