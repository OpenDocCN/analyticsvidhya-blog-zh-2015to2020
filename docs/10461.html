<html>
<head>
<title>Let’s Talk about SQL — Part 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们谈谈 SQL——第 5 部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/lets-talk-about-sql-part-5-afd04a49adbf?source=collection_archive---------16-----------------------#2020-10-19">https://medium.com/analytics-vidhya/lets-talk-about-sql-part-5-afd04a49adbf?source=collection_archive---------16-----------------------#2020-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="06af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">连接并构建查询。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/6b8b5c604470e1f68c5c70bc9b7829f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jMhTI9vl43WQJWuNOlhPug.png"/></div></div></figure><p id="7f7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我关于 SQL 的第四篇文章是关于子查询的介绍。您可以在这里看到<a class="ae jp" rel="noopener" href="/analytics-vidhya/lets-talk-about-sql-part-4-3a5215de90c4">。</a></p><p id="04c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">概括地说，在上一篇文章中，我引导您构建了一个简单的子查询，作为我们数据的过滤器。</p><p id="13eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用 SQL 编写:</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="ce92" class="jv jw hi jr b fi jx jy l jz ka">SELECT state, county, cases, deaths, <br/>       cases/deaths as ‘case/death ratio’, ALWAYS<br/>FROM counties<br/>JOIN mask_use ON fips = countyfp<br/>WHERE fips IN<br/>      (SELECT fips<br/>       FROM election<br/>       ORDER BY clf_unemploy_pct DESC<br/>       LIMIT 25)<br/>AND date = ‘2020–09–07’</span></pre><p id="bd20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您还记得，在最后一篇文章中，运行了对就业表的查询，然后我们获取了该查询的结果，并在 WHERE 子句中使用它们作为过滤器。这样我们就可以看到子查询是如何工作的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kb"><img src="../Images/9da0b074967c0a401db7026ceb02dc53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cX5tgxi4Yu-szJAiR_z5Uw.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">SQL 将首先运行子查询，这些结果将成为您的 WHERE 子句</figcaption></figure><p id="5831" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还讨论了 SQL 中的操作顺序，注意子查询将首先运行，然后是 FROM 和 JOIN 子句。理解这一点很重要，它为您创建更复杂的查询提供了蓝图。那么，我们如何构建一个产生与上面相同结果但不使用子查询的查询呢？</p><p id="ed67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们把它分解一下——当我开始写任何查询时，这些都是相同的基本步骤。</p><p id="c738" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1 .定义问题</strong>，你被要求做什么？</p><p id="fcfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很少有人会告诉您，他们需要 3 个表中的 4 个特定列，如果您能通过组合这 2 个字段来创建一个额外的列。因为，说实话，如果他们知道那么多，他们可以自己编写查询。您更可能遇到以下情况:</p><p id="66ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“嘿，我们有没有任何数据可以告诉我，在高失业率的县中，新冠肺炎的死亡率是多少？”</p><p id="65cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你对此想了一会儿，然后回答说，“我想是的，但是当你说‘高失业率’时，你是在寻找一个特定的阈值(例如，高于 15%)还是在寻找失业率最高的 X 个县？”再思考一会儿，您就会意识到，您还需要定义死亡率的含义——有很多种方法可以测量死亡率(病例/死亡、死亡/总人口等)。).一旦这些问题得到澄清，您就可以开始构建您的查询了。</p><p id="df86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2 .</strong> <strong class="ih hj">确定表格需要</strong>来查找信息。</p><p id="d342" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个真的很直截了当。在问了几个澄清性问题后，我们知道我们被要求找到该县的名称、新冠肺炎病例数、新冠肺炎死亡数、病例/死亡比率，以及在失业率最高的 25 个县中回答说一直戴着口罩的人的百分比。我们还将把这个时间限制在一个特定的日期，因为我们知道死亡和病例数是累积的，并且因为我们知道每个州的县名都是唯一的，所以我们也将把该州包括在内。</p><p id="39cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们查看可用的表格，会发现郡县表包含日期、郡县、州、FIP、病例和死亡列。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kg"><img src="../Images/116bd881197be07ffb3786f6420aebb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TiQmYSZPhw6GxI614PbDiA.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">我们的郡县表示例</figcaption></figure><p id="2e40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们看一下 mask_use 表，它包含 countyfp、never、less、times、frequently 和 always 列。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kh"><img src="../Images/9e2bfbf280942509d9196fb9dfa354d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dbh8-E2huCmu8zRGb3U5Ig.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">我们的 mask_use 表示例</figcaption></figure><p id="efcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们看一下我们的选举表，它有 state、county、fips、total_population 和 clf_unemploy_pct。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ki"><img src="../Images/6a67bd83de93e8a93478d4f413dd4af9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DF4K8l1O4apj8x2kek4a8w.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">我们的选举表样本</figcaption></figure><p id="7014" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">太好了！现在我们知道了完成查询需要哪些表 counties、mask_use 和 election 表。请注意，这些表之间有一些重复的字段，并且有一些相同的数据元素，尽管列的标签不同。</p><p id="4d96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们要寻找的大部分数据将来自 counties 表——我们将从该表中提取州、县、病例和死亡。此外，我们需要 mask_use 表来查找报告说他们总是戴口罩的人的百分比。我们没有被要求报告失业人数，但我们将使用它来排序和限制我们的结果。</p><p id="bb6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。确定表之间的关系。</strong></p><p id="a3b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时候这真的很容易。您可能实际上有一个图表，显示哪些列应该用于连接表—但是，我们这里没有。那么，我如何知道如何连接这些表呢？这就是你需要理解你的数据，或者查阅数据字典的地方。</p><p id="03ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们查看表时，似乎没有一个列是三者共享的。counties 和 election 表都有 state、county 和 fips 列，但是 mask_use 表没有这些列。是吗？有一个标记为“countyfp”的列，当查阅数据字典时，我们看到在所有三个表中都有一个带有唯一标识一个县的代码的列，它只是在 mask_use 表中标记为 countyfp。这看起来像是连接桌子的最直接的方式。</p><p id="1880" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">恭喜你！您已经准备好编写 FROM 和 JOIN 子句(它们将在我们的查询中首先运行)！我喜欢先写数据最多的表，但是任何顺序都可以，因为我们使用的是内部连接。对于其他类型的连接，表的顺序很重要，我们将在后面讨论。</p><p id="6048" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">内部连接</strong> —这是一个连接，其中两个表在给定字段中必须具有相同的值，以便进一步评估。在大多数情况下，SQL 默认使用内部连接。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="dea8" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj">FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips</strong></span></pre><p id="2a5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一部分首先由 SQL 执行—我们现在将拥有所有三个表中的所有列，这些列在所有三个表中的 fips 代码上都有匹配项。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kj"><img src="../Images/67253464b1d8cad7df4d1a5b7123805d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6fRoqPhtdFHbY6LZ8AgF1g.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">要进一步评估的行的样本</figcaption></figure><p id="c836" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，SQL 已经拉入了 496，085 行和 17 列。这表示三个表中具有相同 fips 代码的所有行。</p><p id="4bed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。过滤器。</strong></p><p id="9a2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SQL 的下一步是评估 WHERE 子句所需的过滤器。在上周的例子中，我们使用子查询和日期来过滤结果。因为我们使用一个连接重写了那个查询，所以我们只需要添加日期。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="c125" class="jv jw hi jr b fi jx jy l jz ka">FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips<br/><strong class="jr hj">WHERE c.date == ‘2020–09–07’</strong></span></pre><p id="7f3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">日期只显示在 counties 表中。然而，为了保持一致，我将使用表别名。此时，SQL 将进行过滤以找到我们感兴趣的日期，并且只有满足该条件的行将被进一步评估。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kk"><img src="../Images/b7a2c76b5395fccdbdef7a6a209ecd21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aUa7Vl9g75gm86KgogFs6Q.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">要进一步评估的已筛选行的示例</figcaption></figure><p id="eb42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按日期筛选后，SQL 有 3，093 行和 17 列与所有三个表中的 fips 列匹配，但现在我们只筛选了 counties 表中日期为 2020 年 9 月 7 日的那些行。</p><p id="4847" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5。排序和限制您的结果</strong></p><p id="786f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们开始取得一些进展，并大大减少了我们的行，但请记住，我们正在寻找失业率最高的县，我们只想要前 25 名。请注意，我们没有被要求返回实际失业率，我们只是使用它来排序我们的结果。我们使用 ORDER BY 子句来做到这一点，我们可以按三个表中的任何列进行排序——它不一定是我们在结果中返回的列。</p><p id="23e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，排序将是我们的失业率从高到低。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="e79f" class="jv jw hi jr b fi jx jy l jz ka">FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips<br/>WHERE date == ‘2020–09–07’<br/><strong class="jr hj">ORDER BY e.clf_unemploy_pct DESC</strong></span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kl"><img src="../Images/bd23e5e984da371e3a79be6e6d89ce47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*haPmw0FtHQmLMvaRLKvLXw.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">同样的数据，只是按失业率排序</figcaption></figure><p id="34a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们仍然有 3，093 行和 17 列，但顺序现在不同了，失业率最高的在顶部(科尔森县，SD 为 29.93%)</p><p id="e625" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们只想要前 25 名，所以我们将添加一个限制条款。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="48f9" class="jv jw hi jr b fi jx jy l jz ka">FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips<br/>WHERE date == ‘2020–09–07’<br/>ORDER BY e.clf_unemploy_pct DESC<br/><strong class="jr hj">LIMIT 25</strong></span></pre><p id="fe1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">退货:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kl"><img src="../Images/e0684151b9ef212ec6fb0ab3b3f08788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vYOFEO6zU2QGHXR_56ioyQ.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">要进一步评估的最终行集</figcaption></figure><p id="3410" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们的成绩只有前 25！</p><p id="b9fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 6。选择要返回的列。</strong></p><p id="b250" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们准备编写 SELECT 子句。我们已经知道，我们需要州、县、病例、死亡，一个新的列向我们显示每个死亡病例的数量，以及报告他们总是戴口罩的人的百分比。所以，这很简单。从 counties 表中，我们需要州、县、病例和死亡。我们在 from 和 join 子句中使用了表别名“c ”,所以我们在这里也将使用它。请记住，别名是表名的简写，可以节省您的输入时间。这给了我们 c .州，c .县，c .病例，c .死亡，到目前为止。让我们把它们放进我们的精选里。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="7c55" class="jv jw hi jr b fi jx jy l jz ka"><strong class="jr hj">SELECT c.state, c.county, c.cases, c.deaths<br/></strong>FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips<br/>ORDER BY e.clf_unemploy_pct DESC<br/>LIMIT 25</span></pre><p id="1768" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们有一个计算字段，将病例数除以死亡数。SQL 使用普通的数学运算符，所以这个新列可以写成 c.cases/c.deaths 的‘病例/死亡比率’——我们在结果中使用‘as’给这个列命名。所以，我们现在有:</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="b048" class="jv jw hi jr b fi jx jy l jz ka">SELECT c.state, c.county, c.cases, c.deaths, <br/>       <strong class="jr hj">c.cases/c.deaths as ‘case/death ratio’<br/></strong>FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips<br/>ORDER BY e.clf_unemploy_pct DESC<br/>LIMIT 25</span></pre><p id="7fe0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们将添加来自 mask_use 表的 ALWAYS 列，从而得到一个最终完成的查询:</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="d5dc" class="jv jw hi jr b fi jx jy l jz ka">SELECT c.state, c.county, c.cases, c.deaths, <br/>       c.cases/c.deaths as ‘case/death ratio’, <br/>       <strong class="jr hj">m.ALWAYS<br/></strong>FROM counties as c<br/>JOIN mask_use as m on c.fips = m.countyfp<br/>JOIN election as e on c.fips = e.fips<br/>ORDER BY e.clf_unemploy_pct DESC<br/>LIMIT 25</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es km"><img src="../Images/7c5e0e70f8de2f20762f5d00911abe46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qpDF-y0N3MvYzBIjb_A57w.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">最终查询结果</figcaption></figure><p id="08ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在第 4 部分的查询将给出相同的结果，但是它们不会按失业率排序。这是因为我们在子查询中使用了 ORDER BY 和 LIMIT。此外，因为失业率在子查询中，而不是在连接表中，所以我们不能使用该列对结果进行排序。如果将 ORDER BY 语句添加到查询中，将会得到一个错误消息，指出不存在这样的列。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es km"><img src="../Images/be892c4e910bd9289cb8638e9bf49006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ed_D6fI_o3R7z2XYqFmKJA.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">第 4 部分的结果—相同的数据，不同的顺序。</figcaption></figure><p id="85b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我承诺了更多关于连接的内容，所以让我们继续当前的例子。我们假设选举表没有 fips 代码列。有没有一种方法可以将它加入到 counties 表中以获得我们想要的结果？</p><p id="fc8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要知道 fips 代码代表什么。它似乎是每个县的唯一标识符。</p><blockquote class="kn ko kp"><p id="6763" class="if ig kq ih b ii ij ik il im in io ip kr ir is it ks iv iw ix kt iz ja jb jc hb bi translated"><strong class="ih hj">联邦信息处理标准出版物 6–4(FIPS 6–4)是一个五位数的</strong> <a class="ae jp" href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standards" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">联邦信息处理标准</strong> </a> <strong class="ih hj">代码，它唯一地标识了</strong> <a class="ae jp" href="https://en.wikipedia.org/wiki/County_(United_States)" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">县</strong> </a> <strong class="ih hj">和美国</strong><a class="ae jp" href="https://en.wikipedia.org/wiki/United_States" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"/></a><strong class="ih hj">中的县对等物、某些美国属地和某些自由联合州</strong></p></blockquote><p id="efaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们的表没有 fips 代码，这对我们有什么帮助呢？两个表都有州和县。我们可以使用这些信息来连接这些表。实际上，我们通过识别两个必须匹配的列来为我们的表创建一个复合键。让我们试一试。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="ba07" class="jv jw hi jr b fi jx jy l jz ka">SELECT c.state, c.county, c.fips, e.state, <br/>       e.county,e.total_polulation, e.clf_unemploy_pct<br/>FROM counties as c<br/><strong class="jr hj">JOIN election as e ON c.state = e.state AND c.county = e.county<br/></strong>WHERE date == ‘2020–09–07’<br/>ORDER BY clf_unemploy_pct DESC<br/>LIMIT 25</span></pre><p id="e87b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，该连接现在有一个 AND 关键字。这就是我们如何创建一个复合键，我们指示 SQL 只返回两个表中州和县的组合匹配的行。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ku"><img src="../Images/1da3bebab14e1fc32b936f13135a6e59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SWReuS09ShniOx7jsVgUZA.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">使用州/县作为连接条件的结果</figcaption></figure><p id="3118" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，这看起来几乎是一样的，但你会注意到，弗吉尼亚州的恩波里亚市县从我们的结果中消失了，我们现在有了伊利诺伊州的哈丁县。发生了什么事？让我们分别看看这些表，看看是怎么回事。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="8efc" class="jv jw hi jr b fi jx jy l jz ka">SELECT state, county, fips<br/>FROM counties<br/>WHERE state = ‘Virginia’ and county = ‘Emporia city’<br/>AND date = ‘2020–09–07’</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kv"><img src="../Images/9c4bb570f70b00a880303f8daf04970c.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*GKA5MW564ezh4NLoTvq4Xw.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">在 counties 表中，我们使用 Emporia city 作为县名</figcaption></figure><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="8622" class="jv jw hi jr b fi jx jy l jz ka">SELECT state, county, fips<br/>FROM election<br/>WHERE fips = ‘51595.0’</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kv"><img src="../Images/3243af9a98f5296f9b67f6a413e3d036.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*M9TuMcN7e05wDaHFOvBuKw.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">选举表中的县名是 Emporia</figcaption></figure><p id="33ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在这就说得通了——我们的表来自不同的来源，counties 表来自 NYT covid 数据，而 election 表来自麻省理工学院选举数据，看起来这两个表中输入的 county 名称不同。如果这是一个真实的场景，我们实际上没有 fips 代码，我们不会知道数据是不同的。</p><p id="a722" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想这是提及主键和外键的最佳时机。</p><p id="f844" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">主键</strong> —表中记录的唯一标识符。一个表只有一个主键，并且不能重复。你可以把你的社会安全号码或驾照号码想象成主键——它们识别你，而且只能识别你。</p><p id="cb1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">外键</strong> —引用另一个表中主键的列。</p><p id="2293" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们用作示例的表中，mask_use 和 election 表使用 fips 代码作为主键，counties 表在 countyfp 列中引用该代码，在 county FP 列中它是外键。</p><p id="8abb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里需要注意的重要一点是，SQL 可以连接任何列上的表，您不必使用主键/外键关系。</p><p id="8591" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我想获取 counties 表中所有的州县组合，并查看 elections 表中的匹配项，会怎么样呢？这是我们使用左连接的地方。</p><p id="e4d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">左连接</strong> —左连接将获取左表中的每一行，并包括右表中的匹配记录，同时将不匹配的单元格留空。</p><p id="401f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里需要注意的一点是，左连接要求表以正确的顺序书写。必须首先写入您想要从中获取所有记录的表。在 SQL 的某些实例中也有右连接，但实际上您只需要左连接，因为您只需颠倒表的顺序就可以得到右连接。写出来不是很直观，所以这里有一个有趣的图表。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kw"><img src="../Images/f8967e3a70259d07f043c5dca7a79d04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o8PzkKubx3Iv2W3CI3L2XQ.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">左连接-包括表 A 中的所有行</figcaption></figure><p id="1103" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是时候看看左派的行动了！我们将再次使用州/县组合作为我们的连接条件。</p><pre class="je jf jg jh fd jq jr js jt aw ju bi"><span id="fa14" class="jv jw hi jr b fi jx jy l jz ka">SELECT c.state as ‘c.state’, c.county as ‘c.county’, <br/>       e.state as ‘e.state’, e.county as ‘e.county’<br/>FROM counties as c<br/><strong class="jr hj">LEFT JOIN election as e on c.state = e.state AND c.county = e.county<br/></strong>WHERE c.state = ‘Virginia’<br/>AND date = ‘2020–09–07’</span></pre><p id="92c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将我们的查询限制在弗吉尼亚州，这样我们就可以看到发生了什么。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kx"><img src="../Images/2f9733d671f76b627e81409453b7f449.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*-pmFE8DjQuQydnNFq0c-9w.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">“县”表中的县名与“选举”表中的有点不同</figcaption></figure><p id="b48f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由此可见，弗吉尼亚州有以 X 市命名的县。请注意,“None”出现在选举表的条目中，这是因为在我们的选举表中没有匹配的州/县组合。您在这里看到的结果呈现在一个 Jupyter 笔记本中，在 SQL server 中，它们会显示为 NULL。</p><p id="5d09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，如果您看到一个表中有许多空结果，这很好地表明查询使用了左连接或右连接。如果结果看起来具有来自错误表的 NULL，则可能是您以错误的顺序编写了与表的连接。</p><p id="36df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这让您对连接以及如何编写基本查询有了更好的理解。下一篇文章将深入窗口函数，我们将做一些跨日期的计算，以获得滚动平均值和其他有趣的东西。</p></div></div>    
</body>
</html>