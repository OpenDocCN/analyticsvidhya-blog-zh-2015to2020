<html>
<head>
<title>Troubleshoot slow RDS — PostgreSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">慢速RDS故障排除— PostgreSQL</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/troubleshoot-slow-rds-postgresql-c58edef30035?source=collection_archive---------4-----------------------#2020-05-16">https://medium.com/analytics-vidhya/troubleshoot-slow-rds-postgresql-c58edef30035?source=collection_archive---------4-----------------------#2020-05-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6d93cd941bbf9d27a157636ec7388897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*PFOkH6JzX03wPKHeu7TIUg.gif"/></div></div></figure><p id="e894" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有时应用程序可能会很慢，人们指责的两个最常见的因素是网络和数据库。数据库的一些可能原因可能是RDS CPU使用率达到100%，或者连接数不是最佳的，或者我们编写了错误的查询，因此您的许多查询变得较慢，并且您的应用程序整体上显示出较高的延迟。本指南旨在帮助调查和缓解一些潜在的问题。</p><p id="6b66" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当你阅读这篇文章时，记得问这样的问题，它能帮我实现什么？例如，如果您正在查看<strong class="is hj"> <em class="jo">查找具有最多活动/连接的数据库</em> </strong>查询，那么您应该问这样一个问题:我可以单独隔离这个数据库吗，或者我可以对此限制用户数量，以便减轻对系统的影响等等。最重要的是总是问正确的问题。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jp"><img src="../Images/f302eebd02d7fcfe703d9bf238429708.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*M4mRJOkAHv1I-1W4fMmXBg.jpeg"/></div></figure><p id="fe8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">有用组件:<br/> ___________________ </em> </strong></p><p id="b166" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">RDS控制台<br/> <a class="ae ju" href="https://aws.amazon.com/rds/performance-insights/" rel="noopener ugc nofollow" target="_blank"> RDS性能洞察</a>—<a class="ae ju" href="https://www.youtube.com/watch?v=RyX9tPxffmw" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=RyX9tPxffmw</a><br/><a class="ae ju" href="https://github.com/darold/pgbadger" rel="noopener ugc nofollow" target="_blank">pg badger GitHub</a>—用于分析Postgres日志文件。<a class="ae ju" href="http://pgbadger.darold.net/" rel="noopener ugc nofollow" target="_blank">http://pgbadger.darold.net/</a>T19】T20】pg analyze</p><p id="6162" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> RDS控制台<br/> ____________ </em> </strong></p><p id="8827" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">RDS控制台是您查看以下内容的唯一位置:</p><p id="92f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">系统规格— RAM、存储、IOPS(如果未配置，则为3倍存储)、vCPUs、参数组、安全组<br/>监控—用于云监控的仪表盘、增强监控、操作系统流程、性能洞察<br/>日志&amp;事件—扩展、重新启动、备份、故障转移等事件。一段时间内收集的数据库日志。(您可以下载这些错误日志并使用PGBadger来分析它们)</p><p id="aff2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> RDS性能洞察<br/>_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _</em></strong></p><p id="89a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Performance Insights仪表板大致分为3个部分:<br/> 1 .<em class="jo">计数器指标</em> —包含<em class="jo">操作系统指标</em>(vcpu、CPU利用率等)和<em class="jo">数据库指标</em>(缓存、检查点、IO等)<br/> 2。<em class="jo">AAS数据库负载</em> —这显示了一段时间内数据库上的负载，您可以按4个类别进行划分:<br/> <strong class="is hj"> <em class="jo">等待</em> </strong> <em class="jo">(有助于识别数据库正在等待的资源)、<br/></em><strong class="is hj"><em class="jo">SQL</em></strong><em class="jo">(有助于识别慢速查询以进行优化)、<br/> </em> <strong class="is hj"> <em class="jo">用户</em> </strong> <em class="jo">(有助于限制速率)</em></p><p id="0345" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以看到显示数据库峰值使用时间的趋势线，这有助于容量规划。</p><p id="7fe5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">延伸阅读:<a class="ae ju" href="https://www.slideshare.net/AmazonWebServices/using-performance-insights-to-optimize-database-performance-dat402-aws-reinvent-2018" rel="noopener ugc nofollow" target="_blank">https://www . slide share . net/Amazon web services/using-performance-insights-to-optimize-database-performance-dat 402-AWS-reinvent-2018</a></p><p id="8da0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae ju" href="https://pganalyze.com/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="jo">pg analyze</em></strong></a><strong class="is hj"><em class="jo"><br/></em></strong></p><p id="5609" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">PGAnalyze提供以下帮助:</p><ul class=""><li id="5b54" class="jv jw hi is b it iu ix iy jb jx jf jy jj jz jn ka kb kc kd bi translated">识别运行缓慢的查询</li><li id="fc7a" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn ka kb kc kd bi translated">显示一段时间内活动、空闲和空闲事务连接的计数<br/>模式信息</li><li id="6075" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn ka kb kc kd bi translated">来自解释语句的可视化查询计划</li><li id="5ed5" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn ka kb kc kd bi translated">关于查询的统计信息(平均运行时间、每分钟调用次数、索引、高速缓存、CPU与IO)[用于调整索引，识别给数据库带来大量负载的查询]</li></ul><p id="26aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">有用的PostgreSQL查询<br/>_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _</em></strong></p><p id="ea88" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面列出了一些有助于理解正在发生的事情的有用查询</p><p id="5dea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 1 —显示数据库上的所有活动</em> </strong></p><p id="80e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">select * from <code class="du kj kk kl km b">pg_stat_activity</code>其中datname = ' &lt; DB Name &gt;</p><p id="105f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 2 —查找具有最多活动/连接的数据库:</em> </strong></p><p id="4184" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select datname, count(*) as c from pg_stat_activity WHERE pid&lt;&gt;pg_backend_pid() group by datname order by c desc limit 10;<br/>Helps identify problematic DB easily</code></p><p id="2dc9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 3 —查找长时间运行的查询:</em> </strong></p><p id="672f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT datname, client_addr, state, <br/> floor(extract(epoch from clock_timestamp() - query_start)) as seconds, query <br/>FROM pg_stat_activity <br/>where pid&lt;&gt;pg_backend_pid() <br/>and floor(extract(epoch from clock_timestamp() - query_start)) &gt; 60 <br/>order by seconds desc;</code></p><p id="eff1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 4 —查找运行时间超过60秒且处于活动事务中的查询:</em> </strong></p><p id="5786" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT datname, client_addr, state, <br/>floor(extract(epoch from clock_timestamp() - query_start)) as seconds, query <br/>FROM pg_stat_activity <br/>where pid&lt;&gt;pg_backend_pid() <br/>and floor(extract(epoch from clock_timestamp() - query_start)) &gt; 60 <br/>and state = 'active' <br/>order by seconds desc;</code></p><p id="231c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 5 —查找运行超过60秒且处于空闲/空闲中的查询事务:</em> </strong></p><p id="c5f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT datname, client_addr, state, <br/> floor(extract(epoch from clock_timestamp() - query_start)) as seconds, query <br/>FROM pg_stat_activity <br/>where pid&lt;&gt;pg_backend_pid() <br/>and floor(extract(epoch from clock_timestamp() - query_start)) &gt; 60 <br/>and state like 'idle%' <br/>order by seconds desc;</code></p><p id="de6b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 6 —查找数据库，活动/连接最多的用户:</em> </strong></p><p id="e9c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select count(1) as cnt, datname, usename <br/>FROM pg_stat_activity <br/> WHERE pid&lt;&gt;pg_backend_pid() <br/> group by datname, usename <br/>order by cnt desc;</code></p><p id="3caa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 7 —按等待状态查找查询数:</em> </strong></p><p id="4133" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select count(1), state <br/>FROM pg_stat_activity WHERE pid&lt;&gt;pg_backend_pid() group by state;</code></p><p id="6a8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">按等待状态查找热门查询:</em> </strong></p><p id="418e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select datname, query, state, count(1) as c <br/>FROM pg_stat_activity <br/>WHERE pid&lt;&gt;pg_backend_pid() <br/>group by datname, query, state <br/> order by c desc, datname, query, state;</code></p><p id="c8d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="jo">8—usename和datname的关系:</em> </strong></p><p id="c97e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select distinct usename, datname FROM pg_stat_activity limit 10;</code></p><p id="34c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select usename, datname, count(1) as c FROM pg_stat_activity group by usename, datname order by c desc limit 10;</code></p><p id="255d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 9 —按特定查询的状态查找查询计数:</em> </strong></p><p id="e9fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select state, count(1) <br/>FROM pg_stat_activity <br/>where query like 'select * from %' group by state;<br/>Finds the no of times a query is currently being executed</code></p><p id="1905" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 10 —查找每个角色的连接限制:</em> </strong></p><p id="1232" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT rolname, rolconnlimit FROM pg_roles WHERE rolconnlimit &lt;&gt; -1;<br/>-1 Indicates the role is allowed any no of connections</code></p><p id="1799" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 11 —查找每个角色每个数据库的连接限制:</em> </strong></p><p id="7e8e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select rolconnlimit, usename, datname <br/>FROM ( <br/> select distinct usename, datname from pg_stat_activity <br/>) t1 inner join pg_roles on t1.usename = pg_roles.rolname;</code></p><pre class="jq jr js jt fd kn km ko kp aw kq bi"><span id="5832" class="kr ks hi km b fi kt ku l kv kw">SHOW max_connections;</span></pre><p id="e22b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 12 —锁</em> </strong> <br/>锁的数量多并不是问题。只有当有大量的块时，这才是一个问题。使用下面的查询来查看是否有块:</p><p id="510a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT blocked_locks.pid AS blocked_pid, blocked_activity.usename AS blocked_user, blocking_locks.pid AS blocking_pid, blocking_activity.usename AS blocking_user, blocked_activity.query AS blocked_statement, blocking_activity.query AS current_statement_in_blocking_process FROM pg_catalog.pg_locks blocked_locks JOIN get_pg_stats() blocked_activity ON blocked_activity.pid = blocked_locks.pid JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype AND blocking_locks.DATABASE IS NOT DISTINCT FROM blocked_locks.DATABASE AND blocking_locks.relation IS NOT DISTINCT FROM blocked_locks.relation AND blocking_locks.page IS NOT DISTINCT FROM blocked_locks.page AND blocking_locks.tuple IS NOT DISTINCT FROM blocked_locks.tuple AND blocking_locks.virtualxid IS NOT DISTINCT FROM blocked_locks.virtualxid AND blocking_locks.transactionid IS NOT DISTINCT FROM blocked_locks.transactionid AND blocking_locks.classid IS NOT DISTINCT FROM blocked_locks.classid AND blocking_locks.objid IS NOT DISTINCT FROM blocked_locks.objid AND blocking_locks.objsubid IS NOT DISTINCT FROM blocked_locks.objsubid AND blocking_locks.pid != blocked_locks.pid JOIN get_pg_stats() blocking_activity ON blocking_activity.pid = blocking_locks.pid WHERE NOT blocked_locks.GRANTED;</code></p><p id="cb77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">查看授予了哪些锁以及查询已经运行了多长时间</p><p id="1767" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT a.datname, l.relation::regclass, l.transactionid, l.mode, l.GRANTED, a.usename, a.query, a.query_start, age(now(), a.query_start) AS "age", a.pid <br/>FROM pg_stat_activity a <br/>JOIN pg_locks l ON l.pid = a.pid ORDER BY a.query_start;</code></p><p id="48b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 13 —描述表格</em> </strong></p><p id="0b6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">select column_name, data_type, character_maximum_length from INFORMATION_SCHEMA.COLUMNS where table_name = '&lt;name of table&gt;';</code></p><p id="8f42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你也可以从pg_analyze中得到这个</p><p id="e161" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 14 —查找所有约束，表上的键</em> </strong></p><p id="21fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">SELECT constraint_name, table_name, column_name, ordinal_position FROM information_schema.key_column_usage WHERE table_name = &lt;name of table&gt;;</code></p><p id="83d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 15 —解释查询计划</em> </strong></p><p id="2575" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du kj kk kl km b">BEGIN; <br/>EXPLAIN ANALYZE &lt;QUERY&gt;; <br/>ROLLBACK;</code></p><p id="75de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 16 —找出表格中的共同点</em> </strong> <br/> <code class="du kj kk kl km b">select * from pg_stats where tablename = ‘&lt;tablename&gt;’;</code></p><p id="d1f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">查询规划器使用它来决定索引</p><p id="90ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> 17 —查找死行与活行的比率<br/> </strong> <code class="du kj kk kl km b">SELECT schemaname, relname, n_live_tup, n_dead_tup, last_autovacuum, <br/>n_dead_tup<br/> / (n_live_tup<br/> * current_setting(‘autovacuum_vacuum_scale_factor’)::float8<br/> + current_setting(‘autovacuum_vacuum_threshold’)::float8) as ratio<br/>FROM pg_stat_user_tables<br/>ORDER BY ratio DESC<br/>LIMIT 10;</code></p><p id="a96b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 18 —查找是否在表上运行了任何序列扫描</em> </strong> <br/> <code class="du kj kk kl km b">select * from pg_stat_user_tables where relname = ‘&lt;tablename&gt;’;</code></p><p id="daf1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> 19 —打印表格、行和索引的详细信息</em> </strong> <br/> <code class="du kj kk kl km b">SELECT l.metric, l.nr AS “bytes/ct”<br/> , CASE WHEN is_size THEN pg_size_pretty(nr) END AS bytes_pretty<br/> , CASE WHEN is_size THEN nr / NULLIF(x.ct, 0) END AS bytes_per_row<br/>FROM (<br/> SELECT min(tableoid) AS tbl — = ‘public.tbl’::regclass::oid<br/> , count(*) AS ct<br/> , sum(length(t::text)) AS txt_len — length in characters<br/> FROM content t — provide table name *once*<br/> ) x<br/> , LATERAL (<br/> VALUES<br/> (true , ‘core_relation_size’ , pg_relation_size(tbl))<br/> , (true , ‘visibility_map’ , pg_relation_size(tbl, ‘vm’))<br/> , (true , ‘free_space_map’ , pg_relation_size(tbl, ‘fsm’))<br/> , (true , ‘table_size_incl_toast’ , pg_table_size(tbl))<br/> , (true , ‘indexes_size’ , pg_indexes_size(tbl))<br/> , (true , ‘total_size_incl_toast_and_indexes’, pg_total_relation_size(tbl))<br/> , (true , ‘live_rows_in_text_representation’ , txt_len)<br/> , (false, ‘ — — — — — — — — — — — — — — — ‘ , NULL)<br/> , (false, ‘row_count’ , ct)<br/> , (false, ‘live_tuples’ , pg_stat_get_live_tuples(tbl))<br/> , (false, ‘dead_tuples’ , pg_stat_get_dead_tuples(tbl))<br/> ) l(is_size, metric, nr);</code></p><p id="4270" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用<code class="du kj kk kl km b">pg_stat_statements</code>来查看实际的查询本身。</p><p id="eb17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这有助于您分析特定查询的瓶颈所在。观察它选择的指数以及它是如何选择的。您可以查询<code class="du kj kk kl km b">pg_stats</code>表来查看任何表中任何列的公共值。</p><p id="8919" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">阅读<a class="ae ju" href="https://www.datadoghq.com/blog/aws-rds-postgresql-monitoring/" rel="noopener ugc nofollow" target="_blank"> DataDogs guide </a>,了解监控哪些信号，以便在出现问题之前识别数据库中的瓶颈。它讨论了你正在做的顺序扫描的数量，缓存命中，索引等等。</p><p id="c49d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">阅读<a class="ae ju" href="https://aws.amazon.com/blogs/database/how-to-use-cloudwatch-metrics-to-decide-between-general-purpose-or-provisioned-iops-for-your-rds-database/" rel="noopener ugc nofollow" target="_blank"> AWS博客</a>了解GP存储和调配IOPS之间的差异以及突发限制。这将有助于回答您关于是否为工作负载提供了足够的IOPS的问题。</p><p id="9013" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">进一步Ref:<br/>_ _ _ _ _ _ _ _ _ _ _ _</em></strong></p><ol class=""><li id="9e6c" class="jv jw hi is b it iu ix iy jb jx jf jy jj jz jn kx kb kc kd bi translated"><a class="ae ju" href="https://www.youtube.com/watch?v=RyX9tPxffmw" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=RyX9tPxffmw</a></li><li id="9070" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://www.youtube.com/watch?v=OWL8jqrJKPQ" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=OWL8jqrJKPQ</a></li><li id="607f" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://www.compose.com/articles/common-misconceptions-about-locking-in-postgresql/" rel="noopener ugc nofollow" target="_blank">https://www . compose . com/articles/common-misconcepts-about-locking-in-PostgreSQL/</a></li><li id="760c" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://wiki.postgresql.org/wiki/Lock_Monitoring" rel="noopener ugc nofollow" target="_blank">https://wiki.postgresql.org/wiki/Lock_Monitoring</a></li><li id="2bf4" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://www.datadoghq.com/blog/aws-rds-postgresql-monitoring/" rel="noopener ugc nofollow" target="_blank">https://www . datadohq . com/blog/AWS-rds-PostgreSQL-monitoring/</a></li><li id="4b69" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://www.google.com/search?client=firefox-b-1-d&amp;q=useful+postgres+queries" rel="noopener ugc nofollow" target="_blank">https://www.google.com/search?q=useful+postgres+queries</a></li><li id="d5b7" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://www.holistics.io/blog/postgresql-queries-usage-monitoring/" rel="noopener ugc nofollow" target="_blank">https://www . holistics . io/blog/PostgreSQL-queries-usage-monitoring/</a></li><li id="b28f" class="jv jw hi is b it ke ix kf jb kg jf kh jj ki jn kx kb kc kd bi translated"><a class="ae ju" href="https://aws.amazon.com/blogs/database/how-to-use-cloudwatch-metrics-to-decide-between-general-purpose-or-provisioned-iops-for-your-rds-database/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/database/how-to-use-cloud watch-metrics-to-decision-general-purposed-or-provisioned-IOPs-for-your-rds-database/</a></li></ol></div></div>    
</body>
</html>