<html>
<head>
<title>Image Segmentation using fastai</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用fastai的图像分割</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/image-segmentation-using-fastai-ddded25f811e?source=collection_archive---------4-----------------------#2019-09-24">https://medium.com/analytics-vidhya/image-segmentation-using-fastai-ddded25f811e?source=collection_archive---------4-----------------------#2019-09-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9b8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博文中，我们将了解分段以及如何使用fastai实现分段。准备好，让我们开始吧。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="122d" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">意识形态自由</h1><p id="c1f7" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">❓什么是图像分割</p><p id="91d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图像分割是一个过程，其中图像中的一些像素具有相同的属性，并且它们不同于另一组相似的像素。一般来说，我们对相同的像素进行着色，也就是说，这是一个将数字图像分成许多不同片段的过程。一般来说，我们给相似类型的像素分配一个颜色代码，比如1代表树木，2代表道路，3代表建筑物，每个数字对应一种颜色。因此，片段以不同的颜色彼此分开。</p><p id="e559" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">❔图像分割的目标是什么</p><p id="2a1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最简单的目标是将图像的表示变成更有用或更有意义且易于分析的东西。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es ko"><img src="../Images/dc36f33e7dd3782a5d6ceb50981e9e98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*rtHnQ41xi3MgliJWEw8wrA.jpeg"/></div></figure><p id="11c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">❔如何实现细分</p><p id="d257" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在图像分割中，我们使用图像<a class="ae kw" rel="noopener" href="/analytics-vidhya/image-classification-using-fastai-5ff5b374d414">分类技术</a>将像素彼此分类。相似种类的像素被分组并从不同类型的像素组中分离出来。</p><h1 id="91e2" class="jl jm hi bd jn jo kx jq jr js ky ju jv jw kz jy jz ka la kc kd ke lb kg kh ki bi translated">语用掌握</h1><p id="ee28" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">为了实现图像分割，我们需要下载或创建一个数据集，其中有人已经标记了每个像素。那是许多艰苦的工作。<br/> Fastai为我们提供了一个基于图像分割的学术数据集，称为<a class="ae kw" href="https://course.fast.ai/datasets#image-localization" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> CamVid </em> </a>。有超过700张图片带有分段的蒙版。</p><p id="909c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们为分割导入fastai库。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="a1ea" class="lh jm hi ld b fi li lj l lk ll">from fastai.vision import *</span></pre><p id="e746" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Fastai在URLs变量下提供了大量的学术数据集。点击“网址”后的tab键你会发现很多数据集。我们将解开网址。坎维德</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es lm"><img src="../Images/0b0a9fa41782aa6a694e4f78fa07e7ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*bV8UsOUQ5z-uyXIsVC7MwA.png"/></div></figure><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="74eb" class="lh jm hi ld b fi li lj l lk ll">path = untar_data(URLs.CAMVID)<br/>path.ls()</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es ln"><img src="../Images/961071ba5d35b2a1d22a69b229022798.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*beOLTC95hfYx_Yeew5SlXw.png"/></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">我们需要图像和标签</figcaption></figure><p id="d114" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建标签和图像文件夹的路径。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="8582" class="lh jm hi ld b fi li lj l lk ll">path_lbl = path/'labels'<br/>path_img = path/'images'</span></pre><p id="694e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检查类型图像文件im图像文件夹。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="3a4b" class="lh jm hi ld b fi li lj l lk ll">imageFileNames = get_image_files(path_img)<br/>imageFileNames[:5]</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es ls"><img src="../Images/3af3bfa5172f3352a3d2a7ef95c0ff8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*zR73m3BzN0Gs1_MfCVdbAA.png"/></div></figure><p id="60e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们抓住与图像相关的标签。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="a569" class="lh jm hi ld b fi li lj l lk ll">label_names = get_image_files(path_lbl)<br/>label_names[:5]</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es lt"><img src="../Images/fb5688977830ea6ae6ebab5d7ae307b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*pFEgnb2kMzGs0GiDnl1qsQ.png"/></div></figure><p id="d32b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图像的标签名称中有更多的。这就是标签与图片的联系。不同的数据集在图像和它们的标签之间有不同的关系。</p><p id="3089" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，我们可以创建一个lambda函数来定义这种关系。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="1415" class="lh jm hi ld b fi li lj l lk ll">get_label_image = lambda x: path_lbl/f'{x.stem}_P{x.suffix}'</span></pre><h2 id="9d00" class="lh jm hi bd jn lu lv lw jr lx ly lz jv iq ma mb jz iu mc md kd iy me mf kh mg bi translated">—源图像</h2><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="c70b" class="lh jm hi ld b fi li lj l lk ll">img_f = fnames[5]<br/>img = open_image(img_f)<br/>img.show(figsize=(5,5))</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es mh"><img src="../Images/0b68c17b82cfe2417baf1a706302cc44.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*CJThoELeqokalxBWvvWQnA.png"/></div></figure><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="51ff" class="lh jm hi ld b fi li lj l lk ll">image.data</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es mi"><img src="../Images/29e6d6b270fb6f023c684b7a0b6a3c1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*V--wnc36KqizDyM3muhM-Q.png"/></div></figure><h2 id="1c7d" class="lh jm hi bd jn lu lv lw jr lx ly lz jv iq ma mb jz iu mc md kd iy me mf kh mg bi translated">—标签图像</h2><p id="2dd4" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">标准照片是代表每个点的像素值的浮动的集合。但是标签图像不是典型的图像。它们可能由数字组成，但不是像素数字。这些数字是代表图像中各种分类对象的代码。因此，为了查看图像标签，我们将使用open_mask() &amp; mask()。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="d3c7" class="lh jm hi ld b fi li lj l lk ll">label_img_path = get_label_image(img_f)<br/>img = open_mask(img_f)<br/>img.mask(figsize=(5,5))</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es mj"><img src="../Images/38ad1f0d0a345ac9ba571428a974c833.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*l51I5YbbP_W9MJUicoXR-w.png"/></div></figure><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="b56a" class="lh jm hi ld b fi li lj l lk ll">img.data</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es mk"><img src="../Images/06fa2df7dc7d6ecd34aa87588248c2e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*t-_sY49e0VmZY77jRSUUZA.png"/></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">代码数组</figcaption></figure><p id="550e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以通过加载codes.txt文件来检查图像分类中使用的代码。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="fbb5" class="lh jm hi ld b fi li lj l lk ll">codes = np.loadtxt(path/'codes.txt', dtype=str); codes</span></pre><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="er es ml"><img src="../Images/ee6521bd3dec1930da70041449c28f87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rZQeQFA4M0kJQGB5wMa2BA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">0代表动物，1代表拱门，4代表建筑物，依此类推。</figcaption></figure><h1 id="1ccc" class="jl jm hi bd jn jo kx jq jr js ky ju jv jw kz jy jz ka la kc kd ke lb kg kh ki bi translated">创建数据簇</h1><p id="a9de" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">我们正在使用fastai数据块API创建数据束。</p><p id="80a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—第一步</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="cd4d" class="lh jm hi ld b fi li lj l lk ll">src = (SegmentationItemList<br/>       .<strong class="ld hj">from_folder</strong>(path_img)<br/>       .<strong class="ld hj">split_by_fname_file</strong>("valid.txt")<br/>       .<strong class="ld hj">label_from_func</strong>(get_label_image,  classes=codes))</span></pre><ul class=""><li id="97e8" class="mq mr hi ih b ii ij im in iq ms iu mt iy mu jc mv mw mx my bi translated">我们使用SegmentationItemList是因为我们得到的输入类型。</li><li id="1650" class="mq mr hi ih b ii mz im na iq nb iu nc iy nd jc mv mw mx my bi translated">。from_folder() —我们的图像数据出现在指定的路径中。</li><li id="949c" class="mq mr hi ih b ii mz im na iq nb iu nc iy nd jc mv mw mx my bi translated">split_by_fname_file() —我们希望使用文件名来分隔验证数据集，因为valids.txt文件中提供了验证数据集。我们需要提供文件的有效路径。</li><li id="61d2" class="mq mr hi ih b ii mz im na iq nb iu nc iy nd jc mv mw mx my bi translated">label_from_func () —我们需要创建标签，我们可以使用刚刚创建的get_label_image (get Y文件名函数)来创建标签。我们有一份班级名单。通常对于像行星数据集或宠物数据集这样的东西，我们有一个字符串说这是一只哈巴狗，或者这是多云或其他什么。在这种情况下，你不需要用一个完整的字符串来标记每个像素。它们每个都标有一个数字，然后有一个单独的文件告诉你这些数字的含义。因此，在这里我们可以对数据块API说，这是数字含义的列表。</li></ul><p id="f797" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—第2步</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="8312" class="lh jm hi ld b fi li lj l lk ll">bs=8<br/>src_size = np.array(mask.size)<br/>size = src_size//2</span><span id="f054" class="lh jm hi ld b fi ne lj l lk ll">data = (src.transform(get_transforms(), size=size, tfm_y=True)<br/>        .databunch(bs=bs)<br/>        .normalize(imagenet_stats))</span></pre><ul class=""><li id="34a6" class="mq mr hi ih b ii ij im in iq ms iu mt iy mu jc mv mw mx my bi translated">这里的批量大小是指一次要处理的图像数量。该值可以像8、16，.., 64,..这取决于GPU配置。</li><li id="64d2" class="mq mr hi ih b ii mz im na iq nb iu nc iy nd jc mv mw mx my bi translated">tfm_y —该属性确保对输入变量应用什么转换，也对输出变量应用相同的转换。这在处理图像数据集时很有意义。</li><li id="d41c" class="mq mr hi ih b ii mz im na iq nb iu nc iy nd jc mv mw mx my bi translated">为了快速学习，我们将图像的尺寸缩小到原始图像的一半。//2整数是否除数，因为它表示行*列，所以我们不想使用浮点数。</li></ul><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="b25d" class="lh jm hi ld b fi li lj l lk ll">data.show_batch(2, figsize=(10,7))</span></pre><h1 id="ef3d" class="jl jm hi bd jn jo kx jq jr js ky ju jv jw kz jy jz ka la kc kd ke lb kg kh ki bi translated">培养</h1><p id="e973" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">在训练我们的模型时，我们将使用U-Net神经网络架构，而不是CNN。我们将很快了解它。我会直接用这些方程式来训练这个模型。如果你想了解下面写的方程式背后的动力学，我建议你阅读我的关于分类的<a class="ae kw" rel="noopener" href="/analytics-vidhya/image-classification-using-fastai-5ff5b374d414">另一篇文章</a>。</p><p id="c071" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—第一步</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="e586" class="lh jm hi ld b fi li lj l lk ll">learn = unet_learner(data, models.resnet34, metrics=accuracy)</span><span id="8248" class="lh jm hi ld b fi ne lj l lk ll">lr_find(learn)<br/>learn.recorder.plot()</span><span id="4ec3" class="lh jm hi ld b fi ne lj l lk ll">lr=1e-2<br/>learn.fit_one_cycle(10, slice(lr))</span><span id="b743" class="lh jm hi ld b fi ne lj l lk ll">learn.save('stage-1')</span></pre><p id="88ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">—第2步</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="b5fd" class="lh jm hi ld b fi li lj l lk ll">learn.unfreeze()</span><span id="bd78" class="lh jm hi ld b fi ne lj l lk ll">lr_find(learn)<br/>learn.recorder.plot()</span><span id="564d" class="lh jm hi ld b fi ne lj l lk ll">lrs = slice(1e-5,lr/5)<br/>learn.fit_one_cycle(12, lrs)</span></pre><p id="e1c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，你已经有了一个完整的训练好的模型，足以进行细分。去玩吧。您可以使用下面的命令来绘制结果。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="7c16" class="lh jm hi ld b fi li lj l lk ll">learn.show_results()</span></pre><p id="6c49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将在另一篇博文中了解U-Net。在此之前，探索细分背后的动力。</p><h1 id="2e3f" class="jl jm hi bd jn jo kx jq jr js ky ju jv jw kz jy jz ka la kc kd ke lb kg kh ki bi translated">变大</h1><p id="76a4" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">早期我们使用一半大小的图像，但这并没有完全解决我们的问题。根据问题，我们必须分割所有的像素。这里我们用迁移学习。我们已经教会我们的模型分割原始图像一半大小的图像。现在我们将指导模型学习全尺寸图像。这样，我们将避免过度拟合。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="212c" class="lh jm hi ld b fi li lj l lk ll">size = src_size<br/>bs=4</span><span id="28d6" class="lh jm hi ld b fi ne lj l lk ll">data = (src.transform(get_transforms(), size=size, tfm_y=True)<br/>        .databunch(bs=bs)<br/>        .normalize(imagenet_stats))</span></pre><p id="d4b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在有两种方法可以做到:</p><ul class=""><li id="ebf6" class="mq mr hi ih b ii ij im in iq ms iu mt iy mu jc mv mw mx my bi translated">—第一种方式</li></ul><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="88e2" class="lh jm hi ld b fi li lj l lk ll">learn.data = data</span><span id="7d9c" class="lh jm hi ld b fi ne lj l lk ll">— But it may crash your GPU. If it doesn't, then go ahead.</span></pre><ul class=""><li id="d85d" class="mq mr hi ih b ii ij im in iq ms iu mt iy mu jc mv mw mx my bi translated">—第二种方式</li></ul><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="2671" class="lh jm hi ld b fi li lj l lk ll">learn = Learner.create_unet(data, models.resnet34, metrics=metrics)<br/>learn.load('stage-2');</span></pre><p id="820b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们创建一个新的学习者，并加载我们之前存储的权重。</p><pre class="kp kq kr ks fd lc ld le lf aw lg bi"><span id="62af" class="lh jm hi ld b fi li lj l lk ll">lr_find(learn)<br/>learn.recorder.plot()<br/>lr=1e-3<br/>learn.fit_one_cycle(10, slice(lr))</span><span id="25c2" class="lh jm hi ld b fi ne lj l lk ll">learn.save('stage-1-big')</span></pre></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><pre class="lc ld le lf aw lg bi"><span id="ef9d" class="lh jm hi ld b fi nf ng nh ni nj lj l lk ll">learn.unfreeze()<br/>lrs = slice(1e-6,lr)<br/>learn.fit_one_cycle(10, lrs, wd=1e-3)<br/>learn.save('stage-2-big')<br/>learn.show_results()</span></pre><p id="e5bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用于查看你的预测与实际情况相比如何，它们看起来相当不错。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es nn"><img src="../Images/6df801fcba65ac4a12b9031bd5f4a851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*eSjuB88kycCmTabSYQ9qeQ.png"/></div></figure><p id="d317" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那是分段学习用的。您可能需要高GPU配置来实际执行上述代码。</p></div></div>    
</body>
</html>