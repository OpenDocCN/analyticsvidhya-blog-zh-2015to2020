<html>
<head>
<title>Setting up a Deep Learning system with Ubuntu, NVIDIA-GPU, Docker and TensorFlow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Ubuntu、NVIDIA-GPU、Docker和TensorFlow搭建深度学习系统</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/setting-up-a-deep-learning-system-with-ubuntu-nvidia-gpu-docker-and-tensorflow-c1be8844e49c?source=collection_archive---------1-----------------------#2020-06-23">https://medium.com/analytics-vidhya/setting-up-a-deep-learning-system-with-ubuntu-nvidia-gpu-docker-and-tensorflow-c1be8844e49c?source=collection_archive---------1-----------------------#2020-06-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/aaf4fbfb7201b9cf770a6b51cbfe57d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cBPU8PAuG9Z7OW7LbV4kKQ.png"/></div></div></figure><p id="042d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在我的Mac book Air上开始了我的机器学习之旅，尽管最初它出乎意料地顺利，但很快就发现Air喘着气，因为我开始更多地走向事物的深度学习端。所以我决定安装我自己的深度学习系统。在网上的一些帮助下，我很容易就弄清楚了硬件配置，这稍微受限于我的预算。</p><h1 id="2909" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">硬件配置</h1><p id="9b8c" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">处理器:英特尔酷睿i5–9400 f CPU @ 2.90 GHz×6</p><p id="7070" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">内存:16 GB</p><p id="8fbd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">图形:Ge Force GTX 1660</p><p id="2107" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦所有的硬件都启动并运行，我想我很快就会启动我的GPU。但是我会大吃一惊的！</p><h1 id="baa1" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">软件配置</h1><p id="63c4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我最初的计划是设置Ubuntu，直接在系统上安装NVIDIA驱动，CuDA，Python，TensorFlow，Keras。于是我装了Ubuntu 18.04，NVIDIA驱动集版本440.64，CUDA 10.2，Python 3.6，TensorFlow 2.2。所有的安装都按照各自的说明进行得很好，我能够毫无问题地运行我的模型训练。但很快我发现我的GPU没有启动，CPU承担了所有的处理负载。我在网上到处寻找解决办法，我尝试了很多东西，但都无济于事。当我在网上寻找解决方案时，很明显docker是一个不错的选择。</p><h2 id="c276" class="kr jp hi bd jq ks kt ku ju kv kw kx jy jb ky kz kc jf la lb kg jj lc ld kk le bi translated">码头工人的魔力</h2><p id="10de" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">Docker是一种容器化技术，可以让您在主机环境中独立运行应用程序。运行应用程序所需的所有软件包将驻留在docker容器中，同时它与主机系统共享硬件。这提供了许多优势，包括这样一个事实，即它为您省去运行应用程序所需的不同软件包之间的版本冲突和兼容性问题的所有相关麻烦。</p><p id="e6af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Dockers对于开发和分发复杂的应用程序特别有用，比如机器学习应用程序，对它们的依赖可能会变得非常复杂。Docker使得将软件组件的工作组合作为镜像分发成为可能，该镜像可以作为docker容器独立于系统运行。</p><p id="6e49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">欲知更多关于https://www.docker.com/why-docker的细节</p><h2 id="2abd" class="kr jp hi bd jq ks kt ku ju kv kw kx jy jb ky kz kc jf la lb kg jj lc ld kk le bi translated">黄金之路</h2><p id="a00d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">虽然这是适用于我的系统的配置，但这种配置应该可以在任何基于Ubuntu和NVIDIA-CUDA兼容GPU的系统上正常工作。</p><p id="211d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要安装在主机系统上的关键组件是NVIDIA驱动程序、Docker和NVIDIA docker支持。包括CUDA、cuDNN、Python、TensorFlow和jupyter notebook在内的所有其他软件都将在docker中运行。</p><p id="12c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">配置步骤</strong></p><ol class=""><li id="52ee" class="lg lh hi is b it iu ix iy jb li jf lj jj lk jn ll lm ln lo bi translated"><strong class="is hj">安装Ubuntu </strong></li></ol><p id="a88a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从Ubuntu官方网站下载Ubuntu 20.04，并遵循标准安装程序。</p><p id="2c2f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.<strong class="is hj">安装Nvidia驱动</strong></p><p id="9466" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下载网址:<a class="ae lf" href="https://www.nvidia.in/Download/index.aspx?lang=en-in" rel="noopener ugc nofollow" target="_blank">https://www.nvidia.in/Download/index.aspx?lang=en-in</a></p><p id="fe71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择适当的产品、操作系统和语言来搜索正确的驱动程序。下载并授予文件的执行权限，然后运行以安装。</p><p id="043a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.<strong class="is hj">安装对接器</strong></p><p id="a375" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参赛作品:<a class="ae lf" href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/install/ubuntu/</a></p><p id="6e0d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">更新</strong> <code class="du lp lq lr ls b"><strong class="is hj">apt</strong></code> <strong class="is hj">包索引:</strong></p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="2a6b" class="kr jp hi ls b fi mb mc l md me">$ sudo apt-get update</span><span id="e29e" class="kr jp hi ls b fi mf mc l md me">$ sudo apt-get install \<br/>    apt-transport-https \<br/>    ca-certificates \<br/>    curl \<br/>    gnupg-agent \<br/>    software-properties-common</span></pre><p id="5362" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">添加Docker官方GPG键:</strong></p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="5557" class="kr jp hi ls b fi mb mc l md me">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span></pre><p id="7a1a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过搜索指纹的最后8个字符，验证您现在拥有带有指纹<code class="du lp lq lr ls b">9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88</code>的钥匙。</p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="1cdc" class="kr jp hi ls b fi mb mc l md me">$ sudo apt-key fingerprint 0EBFCD88</span></pre><p id="9d3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">设置稳定库:</strong></p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="fb17" class="kr jp hi ls b fi mb mc l md me">$ sudo add-apt-repository \<br/>   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \<br/>   $(lsb_release -cs) \<br/>   stable"</span></pre><h2 id="06f1" class="kr jp hi bd jq ks kt ku ju kv kw kx jy jb ky kz kc jf la lb kg jj lc ld kk le bi translated">安装Docker引擎:</h2><p id="7118" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">更新<code class="du lp lq lr ls b">apt</code>包索引，安装<em class="mg">最新版本</em>的Docker引擎和containerd:</p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="2b41" class="kr jp hi ls b fi mb mc l md me">$ sudo apt-get update<br/>$ sudo apt-get install docker-ce docker-ce-cli containerd.io</span></pre><p id="64b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.<strong class="is hj">安装NVIDIA Docker支持</strong></p><p id="f081" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了让NVIDIA驱动程序在docker中工作，需要在主机上安装NVIDIA Docker支持。</p><p id="9ca1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">添加软件包仓库:</strong></p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="1b94" class="kr jp hi ls b fi mb mc l md me">distribution=$(. /etc/os-release;echo $ID$VERSION_ID)<br/>curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt key add -<br/>curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span></pre><p id="b689" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">更新apt并安装:</strong></p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="4272" class="kr jp hi ls b fi mb mc l md me">sudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkit</span></pre><p id="6969" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">重启Docker: </strong></p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="93f4" class="kr jp hi ls b fi mb mc l md me">sudo systemctl restart docker</span></pre><p id="1924" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.<strong class="is hj">下载并运行TensorFlow docker映像</strong></p><p id="df7a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从<a class="ae lf" href="https://hub.docker.com/r/tensorflow/tensorflow/" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/tensorflow/tensorflow/</a>找到合适的TensorFlow docker图片并下载。</p><p id="d0f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lp lq lr ls b">$ sudo docker pull tensorflow/tensorflow:2.2.0-gpu-jupyter</code></p><p id="bfa9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下载完成后，您可以使用适当的选项和参数运行映像。</p><p id="302f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lp lq lr ls b">$ sudo docker run -it --rm --gpus all -v $(realpath /notebooks):/tf/notebooks -p 8888:8888 tensorflow/tensorflow:2.2.0-gpu-jupyter</code></p><p id="6896" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述命令成功执行后，将启动一个docker容器，它可以访问主机系统的所有GPU、主机的/notebooks目录(充当容器的/tf/notebooks目录)以及主机和桥接容器的8888端口(Jupyter notebooks默认工作在8888端口)。现在只需在浏览器中打开主机ip即可启动笔记本。</p><p id="12a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.<strong class="is hj">运行Jupyter笔记本</strong></p><p id="5787" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">在浏览器中打开笔记本:</strong></p><p id="4636" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在浏览器中打开url 127.0.0.1:8888，将jupyter实例的令牌从终端复制粘贴到页面的“密码或令牌”输入框中，打开笔记本。</p><p id="4d1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">在GPU上启用内存增长:</strong></p><p id="7354" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还需要做最后一件事，以确保TensorFlow在模型训练期间不会耗尽GPU内存。这是为了在GPU上实现内存增长，这将阻止TensorFlow在初始化时分配整个GPU内存。</p><pre class="lt lu lv lw fd lx ls ly lz aw ma bi"><span id="3d59" class="kr jp hi ls b fi mb mc l md me">import tensorflow as tf<br/>physical_devices = tf.config.list_physical_devices('GPU')<br/>tf.config.experimental.set_memory_growth(physical_devices[0], True)</span></pre><h1 id="7448" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">关于性能的说明</h1><p id="1575" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">正如我前面所说，我的硬件配置是预算有限的，所以我从来没有期望它有任何令人惊讶的性能水平。我的机器花了大约24分钟在food-101数据集(<a class="ae lf" href="https://www.kaggle.com/dansbecker/food-101" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/dansbecker/food-101</a>)上运行ResNet50网络的一个训练纪元，该数据集包含101种不同食物类型的75750幅训练图像。客观地说，同样的事情在kaggle GPU笔记本上需要35分钟。相当令人印象深刻！！！</p></div></div>    
</body>
</html>