<html>
<head>
<title>Starting LibreOffice with Python — Macro Programming in OpenOffice/LibreOffice with using Python[EN]-2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python启动libre office—使用Python在OpenOffice/LibreOffice中进行宏编程[EN]-2</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/starting-libreoffice-with-python-macro-programming-in-openoffice-libreoffice-with-using-10310f9e69f1?source=collection_archive---------0-----------------------#2019-12-18">https://medium.com/analytics-vidhya/starting-libreoffice-with-python-macro-programming-in-openoffice-libreoffice-with-using-10310f9e69f1?source=collection_archive---------0-----------------------#2019-12-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2e6b2446c759aee6e86e9453481d8ba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KGbii_Rw4DisVPbd04iSyQ.png"/></div></div></figure><p id="ff00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大家好，我已经有一段时间没有写这个系列的第二篇文章了，因为我因为考试有点忙。现在该继续了:)</p><p id="3e50" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我将解释如何用Python打开LibreOffice并连接到我们打开的Office。我们将为此编写一个函数。</p><p id="9e30" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从现在开始，我将在我的文章中使用PyCharm作为集成开发环境(IDE)。我建议你使用它。要设置我们的IDE，首先，让我们在PyCharm中创建一个项目，我们将在其中编写宏。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jo"><img src="../Images/ba9f6fb854e52ee7047140d254702232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nBdA_lxmSVJc3_UH97X7tg.png"/></div></div></figure><p id="05e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建项目时，让我们创建一个新的虚拟环境，如屏幕截图所示。作为Python基础解释器，我们还是选择LibreOffice自带的Python解释器吧。我在以前的文章中解释了在哪里可以找到这个解释器。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="22f2" class="jy jz hi ju b fi ka kb l kc kd">Error: standard python 'venv' module not found</span></pre><p id="f178" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="ke">注意</em> </strong> <em class="ke">:如果创建项目后遇到这样的错误，请用默认的base解释器重新创建项目。然后在项目设置中编辑解释器，用LibreOffice的Python解释器替换默认解释器。</em></p><p id="0b27" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们用。py扩展名。如果您的操作系统是Windows，您应该将下面的代码块添加到函数的开头。如果您不使用Windows，则不能添加它。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="a5c5" class="jy jz hi ju b fi ka kb l kc kd">import sys<br/>import os<br/><br/>if sys.platform == 'win32':<br/>    #This is required in order to make pyuno usable with the default python interpreter under windows<br/>    #Some environment variables must be modified<br/><br/>    #get the install path from registry<br/>    import _winreg<br/>    # try with OpenOffice, LibreOffice on W7<br/>    for _key in [# OpenOffice 3.3<br/>                 "SOFTWARE\\OpenOffice.org\\UNO\\InstallPath",<br/>                 # LibreOffice 3.4.5 on W7<br/>                 "SOFTWARE\\Wow6432Node\\LibreOffice\\UNO\\InstallPath"]:<br/>        try:<br/>            value = _winreg.QueryValue(_winreg.HKEY_LOCAL_MACHINE, _key)<br/>        except Exception as detail:<br/>            _errMess = "%s" % detail<br/>        else:<br/>            break   # first existing key will do<br/>    install_folder = '\\'.join(value.split('\\')[:-1]) # 'C:\\Program Files\\OpenOffice.org 3'<br/><br/>    #modify the environment variables<br/>    os.environ['URE_BOOTSTRAP'] = 'vnd.sun.star.pathname:{0}\\program\\fundamental.ini'.format(install_folder)<br/>    os.environ['UNO_PATH'] = install_folder+'\\program\\'<br/><br/>    sys.path.append(install_folder+'\\Basis\\program')<br/>    sys.path.append(install_folder+'\\program')<br/><br/>    paths = ''<br/>    for path in ("\\URE\\bin;", "\\Basis\\program;", "'\\program;"):<br/>        paths += install_folder + path<br/>    os.environ['PATH'] =  paths+ os.environ['PATH']</span></pre><p id="0f2a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Windows上，Python在运行UNO时遇到了问题。这段代码解决了这个问题。</p><p id="3572" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们定义我们的主要功能。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ed55" class="jy jz hi ju b fi ka kb l kc kd"><strong class="ju hj">import </strong>os<br/><strong class="ju hj">import </strong>shutil<br/><strong class="ju hj">import </strong>subprocess<br/><strong class="ju hj">import </strong>tempfile<br/><strong class="ju hj">import </strong>time<br/><strong class="ju hj">import </strong>uno<br/><strong class="ju hj">import </strong>uuid<br/><strong class="ju hj">from </strong>com.sun.star.connection <strong class="ju hj">import </strong>NoConnectException</span><span id="0385" class="jy jz hi ju b fi kf kb l kc kd"><strong class="ju hj"><br/>def </strong>start_libreoffice():<br/>    <em class="ke"># This depends on your LibreOffice installation location.<br/>    </em>sofficePath = <strong class="ju hj">'/opt/libreoffice6.3/program/soffice'<br/>    </strong>tempDir = tempfile.mkdtemp()<br/><br/>    <em class="ke"># Restore cached profile if available<br/>    </em>userProfile = tempDir + <strong class="ju hj">'/profile'<br/>    </strong>cacheDir = os.getenv(<strong class="ju hj">'XDG_CACHE_DIR'</strong>, os.environ[<strong class="ju hj">'HOME'</strong>] + <strong class="ju hj">'/.cache'</strong>) + <strong class="ju hj">'/lo_profile_cache'</strong></span><span id="e676" class="jy jz hi ju b fi kf kb l kc kd"><strong class="ju hj">    if </strong>os.path.isdir(cacheDir):<br/>        shutil.copytree(cacheDir, userProfile)<br/>        profileCached = <strong class="ju hj">True<br/>    else</strong>:<br/>        os.mkdir(userProfile)<br/>        profileCached = <strong class="ju hj">False</strong></span><span id="7106" class="jy jz hi ju b fi kf kb l kc kd"><strong class="ju hj">    </strong><em class="ke"># Launch the LibreOffice server<br/>    </em>pipeName = uuid.uuid4().hex<br/>    args = [<br/>        sofficePath,<br/>        <strong class="ju hj">'-env:UserInstallation=file://' </strong>+ userProfile,<br/>        <strong class="ju hj">'--pidfile=' </strong>+ tempDir + <strong class="ju hj">'/soffice.pid'</strong>,<br/>        <strong class="ju hj">'--accept=pipe,name=' </strong>+ pipeName + <strong class="ju hj">';urp;'</strong>,<br/>        <strong class="ju hj">'--norestore'</strong>,<br/>        <strong class="ju hj">'--invisible'</strong>]<br/>    sofficeEnvironment = os.environ<br/>    sofficeEnvironment[<strong class="ju hj">'TMPDIR'</strong>] = tempDir<br/>    subprocess.Popen(args, env=sofficeEnvironment, preexec_fn=os.setsid)</span><span id="331c" class="jy jz hi ju b fi kf kb l kc kd">    <em class="ke"># Open connection to server<br/>    </em><strong class="ju hj">for </strong>i <strong class="ju hj">in </strong>range(100):<br/>        <strong class="ju hj">try</strong>:<br/>            localContext = uno.getComponentContext()<br/>            resolver = localContext.ServiceManager.createInstanceWithContext(<strong class="ju hj">"com.sun.star.bridge.UnoUrlResolver"</strong>,localContext)         <br/>            context = resolver.resolve(<strong class="ju hj">"uno:pipe,name=%s;urp;StarOffice.ComponentContext" </strong>% pipeName)<br/>            <strong class="ju hj">break<br/>        except </strong>NoConnectException:<br/>            time.sleep(0.1)<br/>            <strong class="ju hj">if </strong>i == 99:<br/>                <strong class="ju hj">raise<br/>    </strong><em class="ke"># Cache profile if required<br/>    </em><strong class="ju hj">if not </strong>profileCached:<br/>        shutil.copytree(userProfile, cacheDir)<br/>    return_list = [context.ServiceManager.createInstanceWithContext(<strong class="ju hj">"com.sun.star.frame.Desktop"</strong>,context), context]<br/>    <strong class="ju hj">return </strong>return_list</span></pre><p id="a83f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个函数中，您必须将sofficePath变量更改为LibreOffice的安装位置。我在第一篇文章中解释过。</p><p id="de4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们在这一点上没有问题，那么当我们调用这个函数时，应该在后台打开soffice。调用该函数后，您可以在任务管理器的运行进程中看到名为Soffice.bin的应用程序。</p><p id="b119" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们定义的函数返回一个列表作为结果。如果愿意，可以简单地返回名为context的变量，并用这个对象定义return_list的第一个变量。但我觉得如上定义更有用。</p><p id="6897" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要查看更高级的例子，您可以查看我为这个博客系列创建的知识库。</p><div class="kg kh ez fb ki kj"><a href="https://github.com/rebahozkoc/libreofficepythonmacros" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">GitHub-rebahozkoc/libre office Python macros:libre office Python宏示例</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">LibreOffice Python Macros是一个处理LibreOffice文档的项目。项目是用Python写的。它有…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">github.com</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx io kj"/></div></div></a></div><p id="a75b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的下一篇文章中，我将解释如何用我们返回的对象打开一个新文档或一个现有文档。再见:)</p><p id="2b14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建本系列文章时，我会参考以下重要资源:</p><div class="kg kh ez fb ki kj"><a href="https://muhammetkara.com/" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">穆罕默德·卡拉</h2><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">muhammetkara.com</p></div></div><div class="ks l"><div class="ky l ku kv kw ks kx io kj"/></div></div></a></div><div class="kg kh ez fb ki kj"><a href="https://oosheet.readthedocs.io/en/stable/" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">哦，床单！— oosheet 1.3文档</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">OOSheet是一个Python模块，用于操作LibreOffice电子表格文档和创建宏。使用Python，您可以…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">oosheet.readthedocs.io</p></div></div></div></a></div><div class="kg kh ez fb ki kj"><a href="http://www.pitonyak.org/oo.php" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">www.pitonyak.org/oo.php</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">Andrew Pitonyak我的OpenOffice.org宏文档(更新于美国东部时间2015年6月12日11:19:53 PM)包含许多示例。这个…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">www.pitonyak.org</p></div></div></div></a></div></div></div>    
</body>
</html>