<html>
<head>
<title>Use TOR to avoid getting blocked when scraping</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TOR以避免刮擦时堵塞</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/use-tor-to-avoid-getting-blocked-when-scraping-704c360cb7d1?source=collection_archive---------3-----------------------#2019-11-11">https://medium.com/analytics-vidhya/use-tor-to-avoid-getting-blocked-when-scraping-704c360cb7d1?source=collection_archive---------3-----------------------#2019-11-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="defb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有多少次你认为你已经写了一个完美的爬虫，你可以让它整夜运行，从网络上抓取成百上千、上百万的数据，但是当你醒来时，你发现你收到大量的错误，404没有找到，401未经授权，403禁止，或者429太多的请求？</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/fade21bdf9817ff9b517327c3cbfd7aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZtIT3-LCdR9WDLucCGF9wA.png"/></div></div></figure><p id="e6da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了避免被阻止，我发现如果是因为IP相关的原因，使用TOR可能会有帮助。</p><h1 id="ddc5" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为什么我的爬虫被堵住了？</h1><ol class=""><li id="08ea" class="kn ko hi ih b ii kp im kq iq kr iu ks iy kt jc ku kv kw kx bi translated">IP被屏蔽:刮的时候可以看到你的IP地址。来自同一个IP的异常大量的请求将被阻塞。</li><li id="8648" class="kn ko hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">没有用户代理或用户代理被阻止:用户代理告诉服务器正在使用哪个web浏览器，例如，<em class="ld">“Mozilla/5.0(X11；Linux x86 _ 64rv:70.0)壁虎/20100101火狐/70.0" </em>。如果未设置用户代理，服务器将不允许访问。如果来自同一个用户代理的请求异常多，它将被阻塞。</li><li id="e9bc" class="kn ko hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">蜜罐陷阱:蜜罐是普通用户看不到的链接，只有爬虫才能看到。当爬虫尝试访问链接时，服务器停止响应。</li><li id="9472" class="kn ko hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated">同一用户登录请求了太多次。</li></ol><p id="3ab5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然该列表并不详尽，但它涵盖了爬虫被阻止的主要原因。</p><h1 id="eb6e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">TOR是什么？</h1><p id="20aa" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">TOR是“洋葱计划”的简称。之所以与洋葱相关，是因为消息经过多层加密(就像洋葱一样),并被路由到不同的计算机，每台计算机只解密一层，然后转发到下一台计算机/服务器。所以，对于中间的每台计算机，他们只知道来源计算机和目的计算机，但不知道来源。</p><p id="1289" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你不明白我在说什么，看看这个YouTube视频。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="18f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">对Tor来说最好的事情是IP每10分钟改变一次(对于tor浏览器或者你可以通过TOR控制器设置)。这可以防止爬虫被IPs阻止。</strong></p><h1 id="4ad8" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">Python中如何使用TOR？</h1><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="6059" class="lo jq hi lk b fi lp lq l lr ls">import requests</span><span id="a105" class="lo jq hi lk b fi lt lq l lr ls">session = requests.session()<br/>session.proxies = {}<br/>session.proxies['http'] = 'socks5://localhost:9150' #9150 for browser; 9050 for TOR service<br/>session.proxies['https'] = 'socks5://localhost:9150'</span></pre><p id="5a7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！很简单。带有代理设置的标准请求包。或者您可以使用套件<a class="ae lu" href="https://stem.torproject.org/" rel="noopener ugc nofollow" target="_blank">杆</a>与tor控制器一起工作。</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="9f49" class="lo jq hi lk b fi lp lq l lr ls">from stem import Signal<br/>from stem.control import Controller</span><span id="7c2b" class="lo jq hi lk b fi lt lq l lr ls">def switchIP():<br/>    with Controller.from_port(port = 9051) as controller:<br/>        controller.authenticate()<br/>        controller.signal(Signal.NEWNYM)</span></pre><h1 id="4672" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">还要更改User_Agent</h1><p id="6c92" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">用户代理告诉服务器正在使用哪个web浏览器。服务器可能会阻止过于频繁查询服务器的web浏览器。</p><p id="4324" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，user_agent很容易伪造。与其多此一举，不如先在网上找包。并且我找到了<a class="ae lu" href="https://pypi.org/project/fake-useragent/" rel="noopener ugc nofollow" target="_blank"> fake-useragent，</a>一个包来随机生成user-agent字符串。</p><p id="e96c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简单地做:</p><pre class="je jf jg jh fd lj lk ll lm aw ln bi"><span id="6c1f" class="lo jq hi lk b fi lp lq l lr ls">from fake_useragent import UserAgent</span><span id="06a3" class="lo jq hi lk b fi lt lq l lr ls">headers = {"User_Agent":UserAgent().random}</span></pre><h1 id="1412" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">放弃</h1><p id="1b83" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">通过使用Tor网络和伪用户代理，你将拥有一个非常强大的工具集来从网络上抓取数据。但是，请在合理的速度和尊重其他用户。</p></div></div>    
</body>
</html>