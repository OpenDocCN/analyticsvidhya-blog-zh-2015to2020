<html>
<head>
<title>Build your own WeatherBot with Botframework + Openweathermap + Adaptive cards UI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用bot framework+Openweathermap+Adaptive cards UI构建自己的WeatherBot</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/build-your-own-weatherbot-with-botframework-openweathermap-adaptive-cards-ui-5d097b37ab8a?source=collection_archive---------5-----------------------#2019-09-30">https://medium.com/analytics-vidhya/build-your-own-weatherbot-with-botframework-openweathermap-adaptive-cards-ui-5d097b37ab8a?source=collection_archive---------5-----------------------#2019-09-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6e53611920df519f574378d63181e12a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v2Q75qOoStxxsK_JIy0f2w.png"/></div></div></figure><blockquote class="iq ir is"><p id="d375" class="it iu iv iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当今世界正全面展开人工智能的发展，聊天机器人在这一领域发挥着至关重要的作用。由于FB messenger、WhatsApp、Skype、Telegram、Slack等消息应用的用户数量迅速增加。仅FB messenger月活用户就超过12亿。</p></blockquote><p id="76e9" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">现在是时候开发一个聊天机器人应用程序来解决社会和商业需求了。根据gartner的预测，到2020年，超过85%的客户互动将在无人参与的情况下进行。然而，聊天机器人系统提供的机会远不止是对客户的询问做出回应。难怪聊天机器人市场的规模正呈指数级增长。</p><p id="33b0" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">在这篇文章中，我将使用微软bot框架、Openweathermap API和自适应卡来构建一个基于交互式UI的weatherbot。</p><p id="1b30" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">聊天机器人的第一次互动如下图所示，内容很少。</p><figure class="jw jx jy jz fd ij er es paragraph-image"><div class="er es jv"><img src="../Images/5cd8e748b458d3e3190d960ce9ed67bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*-k34tBIywSKlDtJbhQflSA.png"/></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">天气机器人的首次互动</figcaption></figure><p id="5f67" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">在这个机器人中，用户可以输入城市名称来获得当前的天气状况。bot必须调用Openweathermap API来获取当前的天气报告。然后将更新Json模板中的报告，以显示它的下一次交互。</p><p id="a1cb" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">在开始构建之前，我们需要为项目构建做一些预设置。</p><h1 id="456a" class="ke kf hi bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">先决条件</h1><ul class=""><li id="a85b" class="lc ld hi iw b ix le jb lf js lg jt lh ju li jr lj lk ll lm bi translated"><a class="ae ln" href="https://dotnet.microsoft.com/download" rel="noopener ugc nofollow" target="_blank">。NET Core SDK </a>版本2.1</li><li id="3fa3" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">Visual Studio 2017/ visual studio代码</li><li id="5438" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">Bot框架V4</li><li id="ebdd" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">OpenWeathermap API</li><li id="177b" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">Bot框架模拟器(测试)</li><li id="f6d7" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">用于用户界面的适配卡</li></ul><h2 id="ba49" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated"><strong class="ak">第一步:</strong> - <strong class="ak">下载。NET Core SDK并安装在您的系统中。</strong></h2><p id="2251" class="pw-post-body-paragraph it iu hi iw b ix le iz ja jb lf jd je js mh jh ji jt mi jl jm ju mj jp jq jr hb bi translated">安装后检查dotnet的版本</p><pre class="jw jx jy jz fd mk ml mm mn aw mo bi"><span id="b7d4" class="lt kf hi ml b fi mp mq l mr ms"># determine dotnet version<br/>dotnet --version</span></pre><h2 id="23df" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated"><strong class="ak">第二步:- </strong> <strong class="ak"> OpenWeatherMap账户设置</strong></h2><p id="57e5" class="pw-post-body-paragraph it iu hi iw b ix le iz ja jb lf jd je js mh jh ji jt mi jl jm ju mj jp jq jr hb bi translated">如果你想玩API，<a class="ae ln" href="https://openweathermap.org/api" rel="noopener ugc nofollow" target="_blank"> OpenWeatherMap </a>是一个不错的起点。他们实际上提供了11个不同的API，都与天气有关，你可以访问。</p><p id="1003" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">对于这个项目，我们使用免费的“当前天气”API。前往<a class="ae ln" href="https://openweathermap.org/appid" rel="noopener ugc nofollow" target="_blank">此链接</a>并注册一个账户。</p><p id="b625" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">登录后，选择<strong class="iw hj"> API密钥</strong>选项卡。在这里，您可以在页面的右侧创建一个键。输入一个名称，然后选择生成。您的API密钥将出现在左侧。复制这把钥匙以备后用。</p><figure class="jw jx jy jz fd ij er es paragraph-image"><div class="er es mt"><img src="../Images/0e9eb01649023cc9eb0c171c0a7e1bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:60/0*9cdYBiZhb3AYduZt"/></div></figure><figure class="jw jx jy jz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/1388c65ade7655daf394e30cf22023c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KTkJ55WI4AZJuuA0.png"/></div></div></figure><p id="9b4a" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">现在进入<a class="ae ln" href="https://openweathermap.org/api" rel="noopener ugc nofollow" target="_blank"> API页签</a>了解API的详细知识，选择<strong class="iw hj">当前天气数据</strong>的<strong class="iw hj"> API文档</strong>。并来到“<strong class="iw hj"> By地理坐标</strong>”部分，看一下API会如何显示数据。</p><h2 id="2494" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated"><strong class="ak">步骤3:-创建一个项目</strong></h2><p id="dc3a" class="pw-post-body-paragraph it iu hi iw b ix le iz ja jb lf jd je js mh jh ji jt mi jl jm ju mj jp jq jr hb bi translated">该项目的完整代码可在<a class="ae ln" href="https://github.com/zayedrais/WeatherBot" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> GitHub Repo </strong> </a>中获得</p><p id="f829" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated"><strong class="iw hj">尝试该样品</strong></p><ul class=""><li id="518d" class="lc ld hi iw b ix iy jb jc js mv jt mw ju mx jr lj lk ll lm bi translated">克隆存储库</li></ul><pre class="jw jx jy jz fd mk ml mm mn aw mo bi"><span id="984a" class="lt kf hi ml b fi mp mq l mr ms">git clone <a class="ae ln" href="https://github.com/zayedrais/WeatherBot.git" rel="noopener ugc nofollow" target="_blank">https://github.com/zayedrais/WeatherBot.git</a></span></pre><ul class=""><li id="5d07" class="lc ld hi iw b ix iy jb jc js mv jt mw ju mx jr lj lk ll lm bi translated">在终端中，导航至<code class="du my mz na ml b">WeatherBot/Bots/WeatherBot.cs</code></li><li id="6f54" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">bot首次欢迎交互将在名为<strong class="iw hj">onmembersaddasync的用户方法的新成员上启动。</strong></li><li id="0735" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">这里使用英雄卡作为欢迎内容，下面突出显示的代码是英雄卡的代码。</li></ul><pre class="jw jx jy jz fd mk ml mm mn aw mo bi"><span id="412c" class="lt kf hi ml b fi mp mq l mr ms">protected override async Task <strong class="ml hj">OnMembersAddedAsync</strong><br/>(IList&lt;ChannelAccount&gt; membersAdded, ITurnContext&lt;IConversationUpdateActivity&gt; <br/>turnContext, CancellationToken cancellationToken)<br/>{<br/>IConversationUpdateActivity iConversationUpdated = turnContext.Activity as IConversationUpdateActivity;</span><span id="d62b" class="lt kf hi ml b fi nb mq l mr ms">foreach (var member in membersAdded)<br/>{<br/>if (member.Id != turnContext.Activity.Recipient.Id)<br/>{<br/><strong class="ml hj"><em class="iv">var card = new HeroCard<br/>{<br/>Title = "Welcome to WeatherBot",<br/>Text = @"Type the city name for get the weather report",<br/>Images = new List&lt;CardImage&gt;() { new CardImage(ImageToBase64(_images[0])) },<br/>};</em></strong><br/>await turnContext.SendActivityAsync(MessageFactory.Attachment<br/>(card.ToAttachment()), cancellationToken);<br/>}<br/>}<br/>}</span></pre><p id="01c5" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">-在欢迎信息后，用户可以输入城市名称以获取当前天气报告。</p><p id="ae53" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">-然后调用方法作为<strong class="iw hj"> OnMessageActivityAsync。</strong>该方法包含当前城市名称，即天气的用户类型。</p><ul class=""><li id="f108" class="lc ld hi iw b ix iy jb jc js mv jt mw ju mx jr lj lk ll lm bi translated">只是将API键替换到了<strong class="iw hj"> OpenwetherMapAPI </strong>处。</li><li id="b9fa" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated"><strong class="iw hj">这个方法里面做了以下事情:- </strong></li><li id="d6d7" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">调用weathermap API</li><li id="7e5e" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">选择并更新模板的图像。</li><li id="3a37" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">选择并更新UI的Json模板的当前数据。</li><li id="cb0e" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">发送更新的Json模板来显示天气预报。</li></ul><pre class="jw jx jy jz fd mk ml mm mn aw mo bi"><span id="d45a" class="lt kf hi ml b fi mp mq l mr ms">protected override async Task <strong class="ml hj">OnMessageActivityAsync</strong>(ITurnContext<br/>&lt;IMessageActivity&gt; turnContext, CancellationToken<br/>cancellationToken)</span><span id="3ad0" class="lt kf hi ml b fi nb mq l mr ms">{<br/>var client = new OpenWeatherMapClient("<strong class="ml hj">OpenwetherMapAPI</strong>");<br/>var CloudImage = "http://messagecardplayground.azurewebsites.net/assets/Mostly%20Cloudy-Square.png";</span><span id="b19f" class="lt kf hi ml b fi nb mq l mr ms">var DizzleImage = "http://messagecardplayground.azurewebsites.net/assets/Drizzle-Square.png";</span><span id="d817" class="lt kf hi ml b fi nb mq l mr ms">var rainImage  = "https://raw.githubusercontent.com/zayedrais/WeatherBot/master/Resources/rain.png";</span><span id="13b6" class="lt kf hi ml b fi nb mq l mr ms">var stormImage = "https://raw.githubusercontent.com/zayedrais/WeatherBot/master/Resources/storm.png";</span><span id="0a6b" class="lt kf hi ml b fi nb mq l mr ms">var sunImage = "https://raw.githubusercontent.com/zayedrais/WeatherBot/master/Resources/sun.png";</span><span id="d931" class="lt kf hi ml b fi nb mq l mr ms">var currentWeather = await client.CurrentWeather.GetByName(turnContext.Activity.Text);</span><span id="318f" class="lt kf hi ml b fi nb mq l mr ms">var search =await client.Search.GetByName("Chennai");</span><span id="f635" class="lt kf hi ml b fi nb mq l mr ms">var forcast  = await client.Forecast.GetByName("Chennai");</span><span id="db94" class="lt kf hi ml b fi nb mq l mr ms">var curtTemp = currentWeather.Temperature.Value - 273.15;</span><span id="3239" class="lt kf hi ml b fi nb mq l mr ms">var MaxTemp  = currentWeather.Temperature.Max -273.15;</span><span id="55be" class="lt kf hi ml b fi nb mq l mr ms">var MinTemp  = currentWeather.Temperature.Min -273.15;</span><span id="c98d" class="lt kf hi ml b fi nb mq l mr ms">var updateCard = readFileforUpdate_jobj(_cards[0]);</span><span id="2648" class="lt kf hi ml b fi nb mq l mr ms">JToken cityName = updateCard.SelectToken("body[0].text");</span><span id="fa78" class="lt kf hi ml b fi nb mq l mr ms">JToken tdyDate = updateCard.SelectToken("body[1].text");</span><span id="7ded" class="lt kf hi ml b fi nb mq l mr ms">JToken curTemp = updateCard.SelectToken("body[2].columns[1].items[0].text");</span><span id="8c5e" class="lt kf hi ml b fi nb mq l mr ms">JToken maxTem = updateCard.SelectToken("body[2].columns[3].items[0].text");</span><span id="64b4" class="lt kf hi ml b fi nb mq l mr ms">JToken minTem = updateCard.SelectToken("body[2].columns[3].items[1].text");</span><span id="5535" class="lt kf hi ml b fi nb mq l mr ms">JToken weatherImageUrl = updateCard.SelectToken("body[2].columns[0].items[0].url");</span><span id="899d" class="lt kf hi ml b fi nb mq l mr ms">cityName.Replace(currentWeather.City.Name);</span><span id="da60" class="lt kf hi ml b fi nb mq l mr ms">curTemp.Replace(curtTemp.ToString("N0"));</span><span id="17e3" class="lt kf hi ml b fi nb mq l mr ms">tdyDate.Replace(DateTime.Now.ToString("dddd, dd MMMM yyyy"));</span><span id="e549" class="lt kf hi ml b fi nb mq l mr ms">maxTem.Replace("Max" +" "+MaxTemp.ToString("N0"));</span><span id="6f79" class="lt kf hi ml b fi nb mq l mr ms">minTem.Replace("Min" + " "+MinTemp.ToString("N0"));</span><span id="7a0b" class="lt kf hi ml b fi nb mq l mr ms">var n = currentWeather.Clouds.Name;</span><span id="d7ce" class="lt kf hi ml b fi nb mq l mr ms">if(n=="overcast clouds")<br/>{<br/>weatherImageUrl.Replace(rainImage);<br/>}<br/>else if (n.Contains("clouds"))<br/>{<br/>weatherImageUrl.Replace(CloudImage);<br/>}<br/>else if (n.Contains("sky"))<br/>{<br/>weatherImageUrl.Replace(sunImage);<br/>}<br/>else if (n.Contains("rain"))<br/>{<br/>weatherImageUrl.Replace(rainImage);<br/>}<br/>else if(n.Contains("storm") || n.Contains("thunder"))<br/>{<br/>weatherImageUrl.Replace(stormImage);<br/>}<br/>var updateWeatherTem = UpdateAdaptivecardAttachment(updateCard);</span><span id="96ee" class="lt kf hi ml b fi nb mq l mr ms">await turnContext.SendActivityAsync(MessageFactory.Attachment<br/>(updateWeatherTem), cancellationToken):<br/>}</span></pre><h2 id="2145" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated">运行项目:-</h2><ul class=""><li id="4577" class="lc ld hi iw b ix le jb lf js lg jt lh ju li jr lj lk ll lm bi translated">从终端或Visual Studio运行bot，选择选项A或b。</li><li id="cbbb" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">a)从终端</li></ul><pre class="jw jx jy jz fd mk ml mm mn aw mo bi"><span id="11af" class="lt kf hi ml b fi mp mq l mr ms"># run the bot <br/>dotnet run</span></pre><ul class=""><li id="8b3f" class="lc ld hi iw b ix iy jb jc js mv jt mw ju mx jr lj lk ll lm bi translated">b)或来自Visual Studio</li><li id="1bcd" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">启动Visual Studio</li><li id="8f92" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">文件-&gt;打开-&gt;项目/解决方案</li><li id="c762" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">导航到<code class="du my mz na ml b">WeatherBot/Bots</code>文件夹</li><li id="3f41" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">选择<code class="du my mz na ml b">WeatherBot.csproj</code>文件</li><li id="ec4b" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">按<code class="du my mz na ml b">F5</code>运行项目</li></ul><h2 id="f537" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated">步骤4:-使用bot框架仿真器测试Bot</h2><p id="bab8" class="pw-post-body-paragraph it iu hi iw b ix le iz ja jb lf jd je js mh jh ji jt mi jl jm ju mj jp jq jr hb bi translated"><a class="ae ln" href="https://github.com/microsoft/botframework-emulator" rel="noopener ugc nofollow" target="_blank"> bot Framework Emulator </a>是一个桌面应用程序，允许Bot开发者在本地主机上测试和调试他们的Bot，或者通过隧道远程运行。</p><ul class=""><li id="2a28" class="lc ld hi iw b ix iy jb jc js mv jt mw ju mx jr lj lk ll lm bi translated">从<a class="ae ln" href="https://github.com/Microsoft/BotFramework-Emulator/releases" rel="noopener ugc nofollow" target="_blank">这里</a>安装Bot框架模拟器版本4.3.0或更高版本</li></ul><h2 id="e1ba" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated">使用bot框架模拟器连接到Bot</h2><ul class=""><li id="b744" class="lc ld hi iw b ix le jb lf js lg jt lh ju li jr lj lk ll lm bi translated">启动Bot框架模拟器</li><li id="fc19" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">文件-&gt;打开Bot</li><li id="1e00" class="lc ld hi iw b ix lo jb lp js lq jt lr ju ls jr lj lk ll lm bi translated">输入一个<code class="du my mz na ml b"><a class="ae ln" href="http://localhost:3978/api/messages" rel="noopener ugc nofollow" target="_blank">http://localhost:3978/api/messages</a></code>的机器人网址</li></ul><h2 id="a9f4" class="lt kf hi bd kg lu lv lw kk lx ly lz ko js ma mb ks jt mc md kw ju me mf la mg bi translated">最终看起来像下图:-</h2><figure class="jw jx jy jz fd ij er es paragraph-image"><div class="er es nc"><img src="../Images/0222688a6efe17e99cbfef4f7706dc52.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*8zBBQ6yhkYC_DWapph9Wiw.png"/></div></figure><p id="0e16" class="pw-post-body-paragraph it iu hi iw b ix iy iz ja jb jc jd je js jg jh ji jt jk jl jm ju jo jp jq jr hb bi translated">该项目的完整代码可在<a class="ae ln" href="https://github.com/zayedrais/WeatherBot" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hj"> GitHub Repo </strong> </a>中找到</p></div></div>    
</body>
</html>