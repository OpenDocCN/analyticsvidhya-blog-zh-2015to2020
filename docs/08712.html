<html>
<head>
<title>Deploying BERT on Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Heroku部署BERT</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-bert-on-heroku-7df1d23f9c43?source=collection_archive---------2-----------------------#2020-08-10">https://medium.com/analytics-vidhya/deploying-bert-on-heroku-7df1d23f9c43?source=collection_archive---------2-----------------------#2020-08-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/d4b0ae3f60c41c614dca1e602c1bdd65.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*uVsUCTP0gTDvdGLQ86fKVQ.png"/></div></figure><p id="dbb2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我一直是自然语言处理的忠实粉丝。因为我喜欢机器，所以我也总是想办法和我的机器交流。</p><p id="ad10" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你问你的机器一些事情，它会回答你，这不是很酷吗？😍</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es jk"><img src="../Images/93c1cb91d6498eeb93bb04f6648b8a6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SDUJN1zqZi7mR9le.jpg"/></div></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">图片来源——钢铁侠</figcaption></figure><blockquote class="jx jy jz"><p id="5930" class="im in ka io b ip iq ir is it iu iv iw kb iy iz ja kc jc jd je kd jg jh ji jj hb bi translated">BERT(来自变压器的双向编码器表示)可以用于一个这样的应用，即问答。你给深度学习模型一段阅读，然后你问一个与此相关的问题。在许多这样的应用中，BERT在NLP(更准确地说是自然语言理解)方面已经被证明足够强大。BERT的概念是在2018年提出的。从那时起，伯特的变体就出现了，如艾伯特、罗伯塔、莫比尔伯特等。你可以在这里阅读原论文<a class="ae ke" href="https://arxiv.org/pdf/1810.04805.pdf" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote><p id="498d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将使用由<a class="ae ke" href="http://huggingface.co" rel="noopener ugc nofollow" target="_blank"> huggingface </a>在问答数据集上训练的BERT，即Stanford<strong class="io hj">Qu</strong>estion<strong class="io hj">A</strong>nswering<strong class="io hj">D</strong>ataset(SQuAD ),并将优化后的模型部署在Heroku上进行实时推理。你可以在我的<a class="ae ke" href="https://github.com/horizons-ml/heroku-bert-deployment" rel="noopener ugc nofollow" target="_blank"> github repo </a>上找到相同的所有材料。</p><p id="3b77" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，让我们开始编码..</p><h1 id="e2e5" class="kf kg hi bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">注意</h1><p id="9625" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">请确保遵循以下文件夹结构:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="4c5a" class="ln kg hi lj b fi lo lp l lq lr">/web-app<br/>|--templates<br/>|----index.html<br/>|--app.py<br/>|--requirements.txt<br/>|--Procfile</span></pre><h2 id="55d0" class="ln kg hi bd kh ls lt lu kl lv lw lx kp ix ly lz kt jb ma mb kx jf mc md lb me bi translated">第一步</h2><p id="da73" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">因为这必须部署在Heroku上，所以让我们确保Heroku安装了运行程序所需的所有库。</p><p id="ceaf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建一个名为“requirements.txt”的文件，并将以下库放入该文件中:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="46da" class="ln kg hi lj b fi lo lp l lq lr">https://download.pytorch.org/whl/cpu/torch-1.3.1%2Bcpu-cp36-cp36m-linux_x86_64.whl<br/>transformers==3.0.2<br/>numpy==1.19.1<br/>flask<br/>joblib==0.16.0<br/>sentencepiece==0.1.91<br/>urllib3==1.25.10</span></pre><h2 id="8782" class="ln kg hi bd kh ls lt lu kl lv lw lx kp ix ly lz kt jb ma mb kx jf mc md lb me bi translated">第二步</h2><p id="9d05" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">创建一个名为“app.py”的文件，并放入以下代码:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="c51e" class="ln kg hi lj b fi lo lp l lq lr">import os<br/>from flask import Flask, render_template<br/>from flask import request<br/><br/><br/>import torch<br/>from transformers import AutoTokenizer, AutoModelForQuestionAnswering<br/><br/>name = "mrm8488/bert-small-finetuned-squadv2"<br/><br/>tokenizer = AutoTokenizer.from_pretrained(name,)<br/><br/>model = AutoModelForQuestionAnswering.from_pretrained(name)<br/><br/>def answer_question(question, answer_text):<br/>    '''<br/>    Takes a `question` string and an `answer` string and tries to identify <br/>    the words within the `answer` that can answer the question. Prints them out.<br/>    '''<br/>    <br/>    # tokenize the input text and get the corresponding indices<br/>    token_indices = tokenizer.encode(question, answer_text)<br/><br/>    # Search the input_indices for the first instance of the `[SEP]` token.<br/>    sep_index = token_indices.index(tokenizer.sep_token_id)<br/><br/>    seg_one = sep_index + 1<br/><br/>    # The remainders lie in the second segment.<br/>    seg_two = len(token_indices) - seg_one<br/>    <br/>    # Construct the list of 0s and 1s.<br/>    segment_ids = [0]*seg_one + [1]*seg_two<br/><br/>    # get the answer for the question<br/>    start_scores, end_scores = model(torch.tensor([token_indices]), # The tokens representing our input combining question and answer.<br/>                                    token_type_ids=torch.tensor([segment_ids])) # The segment IDs to differentiate question from answer<br/><br/>    # Find the tokens with the highest `start` and `end` scores.<br/>    answer_begin = torch.argmax(start_scores)<br/>    answer_end = torch.argmax(end_scores)<br/><br/>    # Get the string versions of the input tokens.<br/>    indices_tokens = tokenizer.convert_ids_to_tokens(token_indices)<br/>    <br/>    answer = indices_tokens[answer_begin:answer_end+1]<br/>    #remove special tokens<br/>    answer = [word.replace("▁","") if word.startswith("▁") else word for word in answer] #use this when using model "twmkn9/albert-base-v2-squad2"<br/>    answer = " ".join(answer).replace("[CLS]","").replace("[SEP]","").replace(" ##","")<br/>    <br/>    return answer<br/><br/><br/>app = Flask(__name__)<br/><br/><br/>@app.route('/', methods=['GET', 'POST'])<br/>def index():<br/>  <br/>    if request.method == 'POST':<br/>      form = request.form<br/>      result = []<br/>      bert_abstract = form['paragraph']<br/>      question = form['question']<br/>      result.append(form['question'])<br/>      result.append(answer_question(question, bert_abstract))<br/>      result.append(form['paragraph'])<br/><br/>      return render_template("index.html",result = result)<br/><br/>    return render_template("index.html")<br/><br/>if __name__ == '__main__':<br/>    port = int(os.environ.get("PORT", 5000))<br/>    app.run(host='0.0.0.0', port=port)</span></pre><p id="5590" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将获得BERT模型和模型所需的标记器。我们使用huggingface的“MRM 8488/bert-small-fine tuned-squad v2 ”,因为它比其他BERT型号相对较小，并且我们在Heroku自由层帐户上有512 MBs的有限空间。接下来，我们创建一个flask服务器来接收段落和问题形式的输入。</p><p id="ad2f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，创建一个名为“templates”的文件夹，并在其中创建一个名为“index.html”的文件。将以下代码放入文件中:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="1f65" class="ln kg hi lj b fi lo lp l lq lr">&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>  &lt;head&gt;<br/>    &lt;title&gt;Bert Question Answering&lt;/title&gt;<br/>    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;<br/>    &lt;link href="//netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" media="screen"&gt;<br/>    &lt;style&gt;<br/>      .container {<br/>        max-width: 1000px;<br/>      }<br/>    &lt;/style&gt;<br/>  &lt;/head&gt;<br/>  &lt;body&gt;<br/>    &lt;div class="container"&gt;<br/>      &lt;div class="row-sm-5 row-sm-offset-1"&gt;<br/>          &lt;h4&gt;Enter a paragraph and a question to test BERT&lt;/h4&gt;<br/>            &lt;form role="form" method='POST' action='/'&gt;<br/>              &lt;div class="form-group"&gt;<br/>                &lt;textarea name="paragraph" class="form-control" id="url-box" placeholder="Enter a paragraph" style="max-width: 300px;" autofocus required&gt;<br/>			{% if result %}<br/>          			{{ result[2] }}<br/>		        {% endif %}<br/>		&lt;/textarea&gt;<br/>                 &lt;br&gt;<br/>                &lt;input type="text" name="question" class="form-control" id="url-box" placeholder="Enter a question" style="max-width: 300px;" autofocus required&gt;<br/>              &lt;/div&gt;<br/>              &lt;button type="submit" class="btn btn-default"&gt;Predict&lt;/button&gt;<br/>            &lt;/form&gt;<br/>          &lt;br&gt;<br/>      &lt;/div&gt;<br/>      <br/><br/>      &lt;div class="row-sm-5 row-sm-offset-1"&gt;<br/>          {% if result %}<br/>          &lt;h4&gt;Question = {{ result[0] }}&lt;/h4&gt;<br/>          &lt;h4&gt;Answer= {{ result[1] }}&lt;/h4&gt;<br/>          {% endif %}<br/>      &lt;/div&gt;<br/><br/>    &lt;/div&gt;<br/>    <br/>  &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="3f1b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用上面的代码，我们创建了一个接收输入的表单。</p><h2 id="d774" class="ln kg hi bd kh ls lt lu kl lv lw lx kp ix ly lz kt jb ma mb kx jf mc md lb me bi translated">第三步</h2><p id="5b97" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">创建一个文件，将其命名为“Procfile ”,不带任何扩展名。并放入以下代码:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="57c1" class="ln kg hi lj b fi lo lp l lq lr">web: python app.py</span></pre><p id="9d55" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将告诉Heroku一旦应用程序被部署后该做什么。</p><h2 id="f872" class="ln kg hi bd kh ls lt lu kl lv lw lx kp ix ly lz kt jb ma mb kx jf mc md lb me bi translated">第四步</h2><p id="5f93" class="pw-post-body-paragraph im in hi io b ip ld ir is it le iv iw ix lf iz ja jb lg jd je jf lh jh ji jj hb bi translated">我们已经准备好代码了。现在让我们和赫罗库谈谈。确保你已经安装了Heroku CLI和git。</p><p id="6e28" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完成后，在命令终端中键入以下命令:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="654d" class="ln kg hi lj b fi lo lp l lq lr">heroku login</span></pre><p id="9274" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将连接您与Heroku CLI</p><p id="7b2a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，键入以下内容创建heroku应用程序:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="1d59" class="ln kg hi lj b fi lo lp l lq lr">heroku create your_app_name</span></pre><p id="40d2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您的应用程序名称可以是任何唯一的名称。</p><p id="a041" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后键入以下命令将您的应用程序部署到Heroku:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="5841" class="ln kg hi lj b fi lo lp l lq lr">git init<br/>git add .<br/>git commit -m 'initial commit'<br/>git push heroku master</span></pre><p id="c1da" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">万岁！您的应用已部署！让我们看看它的表现如何。</p><p id="614c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">打开浏览器窗口，键入以下网址:</p><pre class="jl jm jn jo fd li lj lk ll aw lm bi"><span id="4b27" class="ln kg hi lj b fi lo lp l lq lr">https://your_app_name.herokuapp.com</span></pre><p id="af1f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您应该会看到这样一个网页:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div class="er es mf"><img src="../Images/27a5a33eb2a70efd0b568620e6bf3e33.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/0*1YwbgemSDKHq0WQ2"/></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">伯特问答页面</figcaption></figure><p id="71b2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">既然我是钢铁侠的超级粉丝，我就用下面这段来自<a class="ae ke" href="https://marvelcinematicuniverse.fandom.com/wiki/J.A.R.V.I.S." rel="noopener ugc nofollow" target="_blank">的话</a>:</p><blockquote class="jx jy jz"><p id="7976" class="im in ka io b ip iq ir is it iu iv iw kb iy iz ja kc jc jd je kd jg jh ji jj hb bi translated">只是一个非常智能的系统(J.A.R.V.I.S .)最初是托尼·斯塔克的自然语言用户界面计算机系统，以霍华德·史塔克的管家埃德温·贾维斯命名。随着时间的推移，他被升级为一个人工智能系统，负责管理斯塔克工业的业务以及托尼·斯塔克大厦和斯塔克大厦的安全。在创造了马克2号盔甲之后，Stark将J.A.R.V.I.S .上传到钢铁侠的所有盔甲中，并允许他与其他复仇者互动，在战斗中给他们提供有价值的信息。</p></blockquote><p id="a422" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们问伯特“谁创造了马克2号”</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div class="er es mg"><img src="../Images/a813fb0d064f3c49ad536f26e2b14299.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*MRyOUqL8QEbIbAPm-d_5IA.png"/></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">伯特推理结果</figcaption></figure><p id="4ca1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你想试试的话，我已经在这里部署了我的BERT应用<a class="ae ke" href="https://bertqna.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="cee9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是目前在Heroku部署BERT的原因。感谢您的阅读！😄</p></div></div>    
</body>
</html>