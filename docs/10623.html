<html>
<head>
<title>Terraform + Diagrams: Provisioning and visualizing a simple environment on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform + Diagrams:在 AWS 上提供和可视化一个简单的环境</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/terraform-diagrams-provisioning-and-visualizing-a-simple-environment-on-aws-471f5d88c95d?source=collection_archive---------0-----------------------#2020-10-27">https://medium.com/analytics-vidhya/terraform-diagrams-provisioning-and-visualizing-a-simple-environment-on-aws-471f5d88c95d?source=collection_archive---------0-----------------------#2020-10-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/68a3bf1634a4af67cf48864c61ab18ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OU8NmzRg_qkBoAa7"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">克里斯里德在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="a844" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们使用基础设施即代码(IaC)概念在云中或内部调配环境时，我们已经有了项目文档，作为自己代码上的声明形式，但是如果我们能够在调配后可视化环境的真实状态，事情会变得更容易，您同意吗？因此，考虑了一下，我写这篇文章只是为了展示如何使用<strong class="ix hj"> Terraform </strong>工具调配传统环境，并获取资源名称，以便生成使用<strong class="ix hj">Diagrams</strong>(Diagrams as Code)工具调配的环境的最终拓扑。</p><p id="7af9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在 GitHub 中创建了一个包含本文中使用的所有文件的<a class="ae iu" href="https://github.com/ebarros29/terraform-diagrams" rel="noopener ugc nofollow" target="_blank">库</a>。</p></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><h1 id="f12e" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">范围</h1><p id="e983" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">范围包括提供一个具有三个实例(平衡)的基础架构，以接收 VPC 中的应用程序，其中这些实例需要访问位于另一个 VPC 中的一个数据库。</p><p id="17a4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是简单的拓扑结构:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="9f03" class="lm kb hi li b fi ln lo l lp lq">           VPC1       VPC2<br/>         +-----+    +-----+<br/>  +------&gt; EC2 |    |     |<br/>LB|------&gt; EC2 +---&gt;+ RDS |<br/>  +------&gt; EC2 |    |     |<br/>         +-----+    +-----+</span></pre><h1 id="124e" class="ka kb hi bd kc kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx bi translated">AWS 用户和组</h1><p id="0953" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">首先，我们需要创建一个用户，并将其关联到一个具有足够管理权限的组，以便提供/创建所需的资源。因此，我创建了一个名为“terraform”的用户，并关联到“coder”组，正如我们使用下面的命令所看到的。</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="b035" class="lm kb hi li b fi ln lo l lp lq">aws iam list-groups-for-user --user-name &lt;user&gt;</span></pre><p id="6a8e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">示例:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="e2d2" class="lm kb hi li b fi ln lo l lp lq">[ebarros@eva ~]$ aws iam list-groups-for-user --user-name terraform <br/>{ <br/>    "Groups": [ <br/>        { <br/>            "Path": "/", <br/>            "GroupName": "coder", <br/>            "GroupId": "AGPA24FITNI6ERKVPJJ5B", <br/>            "Arn": "arn:aws:iam::747677903420:group/coder", <br/>            "CreateDate": "2019-11-28T01:09:25+00:00" <br/>        } <br/>    ] <br/>}</span></pre><p id="db98" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解关于 AWS 上的<strong class="ix hj">用户、组和角色</strong>的更多信息，请参考官方文档:</p><p id="0cfb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html</a></p><h1 id="fb5b" class="ka kb hi bd kc kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx bi translated">目录结构</h1><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="389f" class="lm kb hi li b fi ln lo l lp lq">diagrams-terrafom<br/>├── aws_terraform<br/>│   ├── ec2.tf<br/>│   ├── provider.tf<br/>│   ├── rds.tf<br/>│   └── vpc.tf<br/>├── diagrams_aws.py<br/>├── requirements.txt<br/>└── web_service.png</span></pre><p id="80ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“diagrams_aws.py”文件包含 diagrama as code (DaC)内容，负责生成“web_service.png”文件。“requirements.txt”文件包含运行 python 代码所需的所有依赖项。在“aws_terraform”目录中，我创建了。tf 文件根据每个 AWS 服务。我建立了这个目录结构，因为我觉得使用它更舒服。没有默认，你可以随意用自己的方式去创造。只要确保”。tf”文件在同一目录中，Terraform 引擎将知道如何关联它们。</p><h1 id="2560" class="ka kb hi bd kc kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx bi translated">将（行星）地球化（以适合人类居住）</h1><blockquote class="lw"><p id="d582" class="lx ly hi bd lz ma mb mc md me mf js dx translated">Terraform 是一个安全有效地构建、更改和版本控制基础设施的工具。Terraform 可以管理现有的和受欢迎的服务提供商以及定制的内部解决方案。</p></blockquote><h2 id="5ab5" class="lm kb hi bd kc mg mh mi kg mj mk ml kk jg mm mn ko jk mo mp ks jo mq mr kw ms bi translated">我如何安装和配置它？</h2><p id="e326" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">请参考<strong class="ix hj"> Terraform </strong>官方文档:</p><p id="13ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.terraform.io/docs/cli-index.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/docs/cli-index.html</a></p><h2 id="baa9" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">供应者</h2><p id="fcf7" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">我们需要创建一个“provider.tf”文件。该文件没有必需的参数，但插入区域和密钥(或它们的路径)是一个好的做法，这将允许云提供商内部的 Terraform 进行环境供应。</p><p id="6bd7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们有文件内容:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="3b2e" class="lm kb hi li b fi ln lo l lp lq">provider "aws" {<br/>  region     = "sa-east-1"<br/>  access_key = "&lt;Access_KEY&gt;"<br/>  secret_key = "&lt;Secret_KEY&gt;"<br/>}</span></pre><p id="7a8f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解更多关于使用<strong class="ix hj"> AWS 提供商及其在<strong class="ix hj"> Terraform </strong>上的全部资源</strong>，请参考官方文档:</p><p id="6fe4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/AWS/latest/docs</a></p><h2 id="4c04" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">VPC</h2><p id="d787" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">VPC 就像是云中所有基础设施的主要基地，因为它充当虚拟网络层。<br/>我用两个 VPC 和三个子网理想化了这个环境，一个 VPC 有一个子网用于 APP，另一个 VPC 有两个子网位于不同的 az 中用于 DB(必需)。除此之外，我们需要创建一个互联网网关，以便允许从应用程序到互联网的流量和 VPC 对等，以便在 VPC 之间进行通信。除了安全组和路由表之外。</p><p id="51c2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们有“vpc.tf”文件的内容:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="299f" class="lm kb hi li b fi ln lo l lp lq">### VPC SECTION</span><span id="ea69" class="lm kb hi li b fi my lo l lp lq">## VPC for APP</span><span id="321b" class="lm kb hi li b fi my lo l lp lq">resource "aws_vpc" "dac_app_vpc" {<br/>  cidr_block           = "10.128.0.0/16"<br/>  enable_dns_support   = "true"<br/>  enable_dns_hostnames = "true"</span><span id="a295" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_app_vpc"<br/>  }<br/>}</span><span id="3b23" class="lm kb hi li b fi my lo l lp lq">## VPC for DB</span><span id="80d1" class="lm kb hi li b fi my lo l lp lq">resource "aws_vpc" "dac_db_vpc" {<br/>  cidr_block           = "10.240.0.0/16"<br/>  enable_dns_support   = "true"<br/>  enable_dns_hostnames = "true"<br/>  <br/>  tags = {<br/>    Name = "dac_db_vpc"<br/>  }<br/>}</span><span id="7e64" class="lm kb hi li b fi my lo l lp lq">### SUBNET SECTION</span><span id="d623" class="lm kb hi li b fi my lo l lp lq">## Subnet for APP</span><span id="a568" class="lm kb hi li b fi my lo l lp lq">resource "aws_subnet" "dac_app_subnet" {<br/>  vpc_id            = aws_vpc.dac_app_vpc.id<br/>  cidr_block        = "10.128.0.0/24"<br/>  availability_zone = "sa-east-1a"</span><span id="190c" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_app_subnet"<br/>  }<br/>}</span><span id="5626" class="lm kb hi li b fi my lo l lp lq">## Subnet for DB</span><span id="150c" class="lm kb hi li b fi my lo l lp lq">resource "aws_subnet" "dac_db_subnet_1" {<br/>  vpc_id            = aws_vpc.dac_db_vpc.id<br/>  cidr_block        = "10.240.0.0/24"<br/>  availability_zone = "sa-east-1b"</span><span id="21a2" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_db_subnet_1"<br/>  }<br/>}</span><span id="3105" class="lm kb hi li b fi my lo l lp lq">resource "aws_subnet" "dac_db_subnet_2" {<br/>  vpc_id            = aws_vpc.dac_db_vpc.id<br/>  cidr_block        = "10.240.1.0/24"<br/>  availability_zone = "sa-east-1c"</span><span id="5c2d" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_db_subnet_2"<br/>  }<br/>}</span><span id="1be5" class="lm kb hi li b fi my lo l lp lq">### INTERNET GW SECTION</span><span id="05bd" class="lm kb hi li b fi my lo l lp lq">## Internet Gateway for APP</span><span id="61ae" class="lm kb hi li b fi my lo l lp lq">resource "aws_internet_gateway" "dac_app_igw" {<br/>  vpc_id = aws_vpc.dac_app_vpc.id</span><span id="5628" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_app_igw"<br/>  }<br/>}</span><span id="962d" class="lm kb hi li b fi my lo l lp lq">### VPC PEERING SECTION</span><span id="f8cc" class="lm kb hi li b fi my lo l lp lq">## Peering connection between dac_app_vpc and dac_db_vpc</span><span id="187d" class="lm kb hi li b fi my lo l lp lq">resource "aws_vpc_peering_connection" "dac_app_db_peering" {<br/>  peer_vpc_id   = aws_vpc.dac_db_vpc.id<br/>  vpc_id        = aws_vpc.dac_app_vpc.id<br/>  auto_accept   = true</span><span id="23dd" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_vpc_app_db_peering"<br/>  }<br/>}</span><span id="bbf1" class="lm kb hi li b fi my lo l lp lq">### ROUTE TABLE SECTION</span><span id="b15d" class="lm kb hi li b fi my lo l lp lq">## Route for APP</span><span id="55ef" class="lm kb hi li b fi my lo l lp lq">resource "aws_route_table" "dac_app_rt" {<br/>  vpc_id = aws_vpc.dac_app_vpc.id</span><span id="f36e" class="lm kb hi li b fi my lo l lp lq">route {<br/>    cidr_block                = "10.240.0.0/16"<br/>    vpc_peering_connection_id = aws_vpc_peering_connection.dac_app_db_peering.id<br/>  }</span><span id="86ce" class="lm kb hi li b fi my lo l lp lq">route {<br/>    cidr_block = "0.0.0.0/0"<br/>    gateway_id = aws_internet_gateway.dac_app_igw.id<br/>  }</span><span id="fa3e" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_app_rt"<br/>  }<br/>}</span><span id="d574" class="lm kb hi li b fi my lo l lp lq">## Route for DB</span><span id="86fa" class="lm kb hi li b fi my lo l lp lq">resource "aws_route_table" "dac_db_rt" {<br/>  vpc_id = aws_vpc.dac_db_vpc.id</span><span id="9ea2" class="lm kb hi li b fi my lo l lp lq">route {<br/>    cidr_block                = "10.128.0.0/16"<br/>    vpc_peering_connection_id = aws_vpc_peering_connection.dac_app_db_peering.id<br/>  }</span><span id="6bcb" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_db_rt"<br/>  }<br/>}</span><span id="07b5" class="lm kb hi li b fi my lo l lp lq">## Route Table - Subnet Associations</span><span id="c56f" class="lm kb hi li b fi my lo l lp lq">resource "aws_route_table_association" "dac_app_rta2" {<br/>  subnet_id      = aws_subnet.dac_app_subnet.id<br/>  route_table_id = aws_route_table.dac_app_rt.id<br/>}</span><span id="206e" class="lm kb hi li b fi my lo l lp lq">resource "aws_route_table_association" "dac_db_rta1" {<br/>  subnet_id      = aws_subnet.dac_db_subnet_1.id<br/>  route_table_id = aws_route_table.dac_db_rt.id<br/>}</span><span id="b1fb" class="lm kb hi li b fi my lo l lp lq">resource "aws_route_table_association" "dac_db_rta2" {<br/>  subnet_id      = aws_subnet.dac_db_subnet_2.id<br/>  route_table_id = aws_route_table.dac_db_rt.id<br/>}</span><span id="d9b5" class="lm kb hi li b fi my lo l lp lq">### SECURITY GROUPS SECTION</span><span id="a73b" class="lm kb hi li b fi my lo l lp lq">## SG for APP VPC</span><span id="7651" class="lm kb hi li b fi my lo l lp lq">resource "aws_security_group" "dac_app_sg" {<br/>  name = "dac_app_sg"<br/>  description = "EC2 instances security group"<br/>  vpc_id      = aws_vpc.dac_app_vpc.id</span><span id="997c" class="lm kb hi li b fi my lo l lp lq">ingress {<br/>    from_port   = 22<br/>    to_port     = 22<br/>    protocol    = "tcp"<br/>    description = "Allow SSH from my Public IP"<br/>    cidr_blocks = ["&lt;public_IP&gt;/32"]<br/>  }</span><span id="b398" class="lm kb hi li b fi my lo l lp lq">ingress {<br/>    from_port   = 80<br/>    to_port     = 80<br/>    protocol    = "tcp"<br/>    description = "Allow HTTP traffic"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="ed9e" class="lm kb hi li b fi my lo l lp lq">ingress {<br/>    from_port   = 443<br/>    to_port     = 443<br/>    protocol    = "tcp"<br/>    description = "Allow HTTPS traffic"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="24dd" class="lm kb hi li b fi my lo l lp lq">egress {<br/>    from_port   = 0<br/>    to_port     = 0<br/>    protocol    = "-1"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }<br/>  <br/>  tags = {<br/>    Name = "dac_app_sg"<br/>  }<br/>}</span><span id="e503" class="lm kb hi li b fi my lo l lp lq">## SG for DB VPC</span><span id="c3f2" class="lm kb hi li b fi my lo l lp lq">resource "aws_security_group" "dac_db_sg" {<br/>  name = "dac_db_sg"<br/>  description = "EC2 instances security group"<br/>  vpc_id      = aws_vpc.dac_db_vpc.id</span><span id="85c8" class="lm kb hi li b fi my lo l lp lq">ingress {<br/>    from_port   = 3306<br/>    to_port     = 3306<br/>    protocol    = "tcp"<br/>    description = "Allow traffic to MySQL"<br/>    cidr_blocks = ["10.128.0.0/24"]<br/>  }</span><span id="b8df" class="lm kb hi li b fi my lo l lp lq">egress {<br/>    from_port   = 0<br/>    to_port     = 0<br/>    protocol    = "-1"<br/>    cidr_blocks = ["0.0.0.0/0"]<br/>  }</span><span id="5117" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_db_sg"<br/>  }<br/>}</span></pre><p id="5106" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">总结以前创建的主要资源”。tf "文件:</p><ul class=""><li id="5ed0" class="mz na hi ix b iy iz jc jd jg nb jk nc jo nd js ne nf ng nh bi translated">应用程序的 VPC(CIDR:10 . 128 . 0 . 0/16)</li><li id="d2bc" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ DB _ VPC:</strong>DB 的 VPC(CIDR:10 . 240 . 0 . 0/16)</li><li id="2755" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ APP _ Subnet:</strong>APP 的子网(CIDR: 10.128.0.0/24)</li><li id="23c3" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ DB _ Subnet _ 1:</strong>DB 的子网 1(CIDR:10 . 240 . 0 . 0/24)</li><li id="f37c" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ DB _ Subnet _ 2:</strong>DB 的子网 2(CIDR:10 . 240 . 1 . 0/24)</li><li id="56de" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_app_igw: </strong>允许从应用到互联网的流量</li><li id="1224" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ vpc _ app _ db _ peering:</strong>允许 VPC 之间的通信</li><li id="5407" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ APP _ rt:</strong>APP 的路由表</li><li id="362f" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">DAC _ DB _ rt:</strong>DB 的路由表</li><li id="8d50" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_app_sg: </strong>应用 VPC 的安全组(入口:允许端口 22、80 和 443。出口:所有网络)</li><li id="2177" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_db_sg: </strong>数据库 VPC 的安全组(入口:仅允许来自应用子网的端口 3306。出口:所有网络)</li></ul><p id="9dd6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解更多关于<strong class="ix hj">亚马逊 VPC </strong>的信息，请参考官方文档:</p><p id="e804" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPC/latest/user guide/what-is-Amazon-VPC . html</a></p><h2 id="71d5" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">无线电数据系统</h2><p id="fe36" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">RDS 是 AWS 中的一个完全托管的资源数据库，它允许创建一个数据库实例，而无需关心操作系统修补和服务器供应等问题。该资源支持主要的数据库引擎，如 SQL Server、MariaDB、ProstgreSQL 等。在这种情况下，文件“rds.tf”将使用先前在“vpc.tf”文件中声明的 DB 子网创建一个 MySQL 实例和一个 DB 子网组。</p><p id="7216" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们有“rds.tf”文件内容:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="5638" class="lm kb hi li b fi ln lo l lp lq">## DB Subent Group</span><span id="50bb" class="lm kb hi li b fi my lo l lp lq">resource "aws_db_subnet_group" "dac_db_subnet_group" {<br/>  name       = "dac_db_subnet_group"<br/>  subnet_ids = [aws_subnet.dac_db_subnet_1.id, aws_subnet.dac_db_subnet_2.id]</span><span id="284e" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_db_subnet_group"<br/>  }<br/>}</span><span id="db0b" class="lm kb hi li b fi my lo l lp lq">## DB instance</span><span id="15ab" class="lm kb hi li b fi my lo l lp lq">resource "aws_db_instance" "dac_db" {<br/>  allocated_storage       = 20<br/>  storage_type            = "gp2"<br/>  engine                  = "mysql"<br/>  engine_version          = "8.0"<br/>  instance_class          = "db.t2.micro"<br/>  name                    = "mydb"<br/>  identifier              = "dacdb"<br/>  username                = "&lt;db_user&gt;"<br/>  password                = "&lt;db_password&gt;"<br/>  parameter_group_name    = "default.mysql8.0"<br/>  db_subnet_group_name    = aws_db_subnet_group.dac_db_subnet_group.name<br/>  vpc_security_group_ids  = [aws_security_group.dac_db_sg.id]<br/>  skip_final_snapshot     = "true"<br/>}</span></pre><p id="8422" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解更多关于<strong class="ix hj">亚马逊 RDS </strong>的信息，请参考官方文档:</p><p id="18f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Welcome.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Amazon rds/latest/user guide/welcome . html</a></p><h2 id="2d45" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">EC2</h2><p id="3bb7" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">AWS EC2 是一种计算层服务，它基本上允许创建/销毁基于 Linux 或 Windows 的实例(虚拟机)，根据需求向上或向外扩展。在这种情况下，文件“ec2.tf”将通过使用“Amazon Linux 2”映像创建三个 Linux 实例(t2.micro)。该文件还将创建一个 NLB(网络负载平衡器)及其所需的组件。</p><p id="0776" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们有“ec2.tf”文件的内容:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="a512" class="lm kb hi li b fi ln lo l lp lq">## EC2 INSTANCES</span><span id="90eb" class="lm kb hi li b fi my lo l lp lq">resource "aws_instance" "dac_app" {<br/>  count                         = 3<br/>  ami                           = "ami-02898a1921d38a50b"<br/>  instance_type                 = "t2.micro"<br/>  key_name                      = "&lt;KEY_name&gt;"<br/>  vpc_security_group_ids        = [aws_security_group.dac_app_sg.id]<br/>  subnet_id                     = aws_subnet.dac_app_subnet.id<br/>  associate_public_ip_address   = "true"</span><span id="4209" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Name = "dac_app_${count.index}"<br/>  }<br/>}</span><span id="e17e" class="lm kb hi li b fi my lo l lp lq">## NLB</span><span id="b412" class="lm kb hi li b fi my lo l lp lq">resource "aws_lb" "dac_app_lb" {<br/>  name               = "dac-app-lb"<br/>  internal           = false<br/>  load_balancer_type = "network"<br/>  subnets            = aws_subnet.dac_app_subnet.*.id</span><span id="1fd8" class="lm kb hi li b fi my lo l lp lq">tags = {<br/>    Environment = "dev"<br/>  }<br/>}</span><span id="808f" class="lm kb hi li b fi my lo l lp lq">## LB Target Group</span><span id="0a21" class="lm kb hi li b fi my lo l lp lq">resource "aws_lb_target_group" "dac_app_tgp" {<br/>  name     = "dac-app-tgp"<br/>  port     = 80<br/>  protocol = "TCP"<br/>  vpc_id   = aws_vpc.dac_app_vpc.id<br/>}</span><span id="0d82" class="lm kb hi li b fi my lo l lp lq">## LB Targets Registration</span><span id="3d13" class="lm kb hi li b fi my lo l lp lq">resource "aws_lb_target_group_attachment" "dac_app_tgpa" {<br/>  count            = length(aws_instance.dac_app)<br/>  target_group_arn = aws_lb_target_group.dac_app_tgp.arn<br/>  target_id        = aws_instance.dac_app[count.index].id<br/>  port             = 80<br/>}</span><span id="f3e6" class="lm kb hi li b fi my lo l lp lq">## LB Listener</span><span id="8196" class="lm kb hi li b fi my lo l lp lq">resource "aws_lb_listener" "dac_app_lb_listener" {<br/>  load_balancer_arn = aws_lb.dac_app_lb.arn<br/>  port              = "80"<br/>  protocol          = "TCP"</span><span id="dfd0" class="lm kb hi li b fi my lo l lp lq">default_action {<br/>    type             = "forward"<br/>    target_group_arn = aws_lb_target_group.dac_app_tgp.arn<br/>  }<br/>}</span></pre><p id="2df2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">总结以前创建的主要资源”。tf "文件:</p><ul class=""><li id="90bc" class="mz na hi ix b iy iz jc jd jg nb jk nc jo nd js ne nf ng nh bi translated"><strong class="ix hj"> dac_app: </strong>三个 EC2 实例(dac_app_0、dac_app_1 和 dac_app_2)</li><li id="c7db" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_app_lb: </strong>外部网络负载平衡器</li><li id="add9" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_app_tgp: </strong>接收来自 NLB 流量的目标群体</li><li id="76ce" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_app_tgpa: </strong>组实例附加在<strong class="ix hj"> dac_app_tgp </strong>上</li><li id="91dd" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> dac_app_lb_listener: </strong>端口 80 上的 lb 监听器(HTTP)</li></ul><p id="c0f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解更多关于<strong class="ix hj">亚马逊 EC2 </strong>的信息，请参考官方文档:</p><p id="960a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS C2/latest/user guide/concepts . html</a></p><h2 id="011d" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">规划和应用</h2><p id="0e78" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">Terraform 中有三个主要命令，它们是:</p><ul class=""><li id="1e64" class="mz na hi ix b iy iz jc jd jg nb jk nc jo nd js ne nf ng nh bi translated"><strong class="ix hj"> terraform plan: </strong>创建一个计划，基于已声明的”。tf "文件，这是将要配置的环境的一部分。</li><li id="0134" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj"> terraform apply: </strong>根据计划在云提供商上部署整个环境。</li><li id="d49a" class="mz na hi ix b iy ni jc nj jg nk jk nl jo nm js ne nf ng nh bi translated"><strong class="ix hj">地形摧毁:</strong>摧毁之前创造的整个环境。</li></ul><p id="323e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面我们可以看到“<strong class="ix hj"> terraform plan </strong>”和“<strong class="ix hj"> terraform apply </strong>”命令的例子:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nn"><img src="../Images/8891991b0c80f3186c82fb7cf85a8903.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*bfHO6bzHfI01EYj6YCBrJg.gif"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">环境供应流程</figcaption></figure><h2 id="be73" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">设置结果</h2><p id="ff7e" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">在下面的终端上，我们可以看到 AWS CLI 命令的过滤输出，显示了 Terraform 创建的资源。</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nn"><img src="../Images/f251ae0b1e1fdcfbf2402a0cda58d2ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*dvPPPhDFoYrTCF5y_Zx2Wg.gif"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">显示资源</figcaption></figure><p id="544a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想破坏整个环境，只需输入“<strong class="ix hj"> terraform destroy </strong>”，然后确认计划，所有资源将被删除。</p><blockquote class="no np nq"><p id="16a2" class="iv iw nr ix b iy iz ja jb jc jd je jf ns jh ji jj nt jl jm jn nu jp jq jr js hb bi translated"><strong class="ix hj">注意:</strong>将调配的环境保留到文章的最后，因为我们将在下一个主题中使用“terraform.tfstate”文件。</p></blockquote><h1 id="8e1d" class="ka kb hi bd kc kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx bi translated">图表</h1><blockquote class="lw"><p id="fcfd" class="lx ly hi bd lz ma mb mc md me mf js dx translated">Diagrams 允许您用 Python 代码绘制云系统架构。Diagrams 目前支持六大提供商:AWS、Azure、GCP、Kubernetes、阿里云和甲骨文云。它现在还支持本地节点以及编程语言和框架。</p></blockquote><h2 id="41d2" class="lm kb hi bd kc mg mh mi kg mj mk ml kk jg mm mn ko jk mo mp ks jo mq mr kw ms bi translated">我如何安装、配置和使用它？</h2><p id="a280" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">请参考 GitHub 上的<strong class="ix hj">图</strong>官网和项目资源库:</p><p id="75ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【https://diagrams.mingrammer.com】/<br/><a class="ae iu" href="https://github.com/mingrammer/diagrams" rel="noopener ugc nofollow" target="_blank">https://github.com/mingrammer/diagrams</a></p><h2 id="4af3" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">它是如何工作的？</h2><p id="7746" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">这个简单的工具在 Python 上工作，所以在一个最小的配置之后，基本上我们只需要写。py "文件并运行它。</p><h2 id="7f42" class="lm kb hi bd kc mg mt mi kg mj mu ml kk jg mv mn ko jk mw mp ks jo mx mr kw ms bi translated">生成图表</h2><p id="5ac3" class="pw-post-body-paragraph iv iw hi ix b iy ky ja jb jc kz je jf jg la ji jj jk lb jm jn jo lc jq jr js hb bi translated">首先，我们需要根据将在拓扑中显示的每个 AWS 资源，将所有必需的类导入到代码中。然后，我打开了“terraform.tfstate”文件，并将其解码为 JSON，以便获得在环境供应期间创建的所有资源名称。<br/>之后，我构建了一个包含每个资源名称的列表，并将每个元素位置作为我的节点和集群的名称。</p><blockquote class="no np nq"><p id="7147" class="iv iw nr ix b iy iz ja jb jc jd je jf ns jh ji jj nt jl jm jn nu jp jq jr js hb bi translated"><strong class="ix hj">注意:</strong>这个过程是在代码中手工完成的，但是我打算通过使用<strong class="ix hj"> Python CDK for Terraform </strong>来自动化这个过程，并在以后的文章中展示。</p></blockquote><p id="ed96" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">sintax 构建图表方案在官方文档中有更详细的解释，但是基本上我们需要使用每个 AWS 资源类来创建节点，“&lt;&lt; &gt;&gt;”或“-”来连接节点和集群类以创建“盒子”。</p><p id="6cb9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“diagrams_aws.py”文件显示了下面的代码:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="1267" class="lm kb hi li b fi ln lo l lp lq">from diagrams import Cluster, Diagram<br/>from diagrams.aws.compute import EC2<br/>from diagrams.aws.database import RDS<br/>from diagrams.aws.network import ELB, VPCPeering<br/>import json<br/>import os<br/>from pprint import pprint</span><span id="a616" class="lm kb hi li b fi my lo l lp lq">## Opening the .tfstate file</span><span id="27f6" class="lm kb hi li b fi my lo l lp lq">with open('aws_terraform/terraform.tfstate') as json_file:<br/>    tf_data = json.load(json_file)</span><span id="44f4" class="lm kb hi li b fi my lo l lp lq">#pprint(data)</span><span id="d007" class="lm kb hi li b fi my lo l lp lq">r_names = []</span><span id="b285" class="lm kb hi li b fi my lo l lp lq">## looping over the names</span><span id="39ec" class="lm kb hi li b fi my lo l lp lq">for x in tf_data['resources']:<br/>    r_names.append(x['name'])</span><span id="6134" class="lm kb hi li b fi my lo l lp lq">print("\nResources Name List: \n")</span><span id="00aa" class="lm kb hi li b fi my lo l lp lq">pprint(r_names)</span><span id="32e8" class="lm kb hi li b fi my lo l lp lq">app_vpc_name = r_names[len(r_names)-3]<br/>db_vpc_name = r_names[len(r_names)-2]</span><span id="3d49" class="lm kb hi li b fi my lo l lp lq">app_vpc_cidr = '10.128.0.0/16'<br/>db_vpc_cidr = '10.240.0.0/16'</span><span id="2f52" class="lm kb hi li b fi my lo l lp lq">app_subnet_name = r_names[len(r_names)-6]<br/>db_subnet1_name = r_names[len(r_names)-5]<br/>db_subnet2_name = r_names[len(r_names)-4]</span><span id="ef60" class="lm kb hi li b fi my lo l lp lq">app_subnet_cidr = '10.128.0.0/24'<br/>db_subnet1_cidr = '10.240.0.0/24'<br/>db_subnet2_cidr = '10.240.1.0/24'</span><span id="1d3f" class="lm kb hi li b fi my lo l lp lq">peering_name = r_names[len(r_names)-1]</span><span id="d270" class="lm kb hi li b fi my lo l lp lq">app_name = r_names[2]<br/>db_name = r_names[0]</span><span id="5c87" class="lm kb hi li b fi my lo l lp lq">tgp_name = r_names[6]<br/>lb_name = r_names[4]</span><span id="724a" class="lm kb hi li b fi my lo l lp lq">print("\nGenerating Diagram...")</span><span id="00a8" class="lm kb hi li b fi my lo l lp lq">with Diagram("Web Service", show=False):</span><span id="f361" class="lm kb hi li b fi my lo l lp lq">load_balancer = ELB(lb_name)</span><span id="35fc" class="lm kb hi li b fi my lo l lp lq">with Cluster("VPC: "+app_vpc_name+"\nCIDR: "+app_vpc_cidr):<br/>        with Cluster("Subnet: "+app_subnet_name+"\nCIDR: "+app_subnet_cidr):<br/>            with Cluster("Instance Group: "+tgp_name):<br/>                workers = [EC2(app_name+"_0"),<br/>                            EC2(app_name+"_1"),<br/>                            EC2(app_name+"_2")]<br/>    <br/>    vpc_peering = VPCPeering(peering_name)</span><span id="0a2c" class="lm kb hi li b fi my lo l lp lq">with Cluster("VPC: "+db_vpc_name+"\nCIDR: "+db_vpc_cidr):<br/>            with Cluster("Subnet 1: "+db_subnet1_name+"\nCIDR: "+db_subnet1_cidr+"\nSubnet 2: "+db_subnet2_name+"\nCIDR: "+db_subnet2_cidr):<br/>                database1 = RDS(db_name)</span><span id="dac3" class="lm kb hi li b fi my lo l lp lq">load_balancer &gt;&gt; workers &gt;&gt; vpc_peering &gt;&gt; database1</span><span id="0fb5" class="lm kb hi li b fi my lo l lp lq">print("Congratulations! The diagram has been succesfully generated in this path: "+os.getcwd()+"\n")</span></pre><p id="495d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，运行下面的命令:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="5a7b" class="lm kb hi li b fi ln lo l lp lq">python3 diagrams_aws.py</span></pre><p id="3768" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，我们有了完整而精彩的下图:</p><figure class="ld le lf lg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nv"><img src="../Images/cb32f4cf1e4bf79586fb6c58476346e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DEzz-wJ4yP_aXPeM17Pp-Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">调配的 AWS 资源的最终拓扑</figcaption></figure></div><div class="ab cl jt ju gp jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="hb hc hd he hf"><p id="3630" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">[1]: GitHub 库:terraform-diagrams。<br/><a class="ae iu" href="https://github.com/ebarros29/terraform-diagrams" rel="noopener ugc nofollow" target="_blank">https://github.com/ebarros29/terraform-diagrams</a></p><p id="7b07" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">[2]: Terraform 官网。地形简介<br/><a class="ae iu" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/intro/index.html</a></p><p id="9a6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">[3]:图:作为代码的图。关于图解<br/>T23】https://diagrams.mingrammer.com/</p></div></div>    
</body>
</html>