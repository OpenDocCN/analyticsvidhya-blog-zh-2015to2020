<html>
<head>
<title>Deploying an R Shiny app on Heroku free tier</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Heroku免费层部署一个闪亮的应用程序</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-an-r-shiny-app-on-heroku-free-tier-b31003858b68?source=collection_archive---------5-----------------------#2020-11-24">https://medium.com/analytics-vidhya/deploying-an-r-shiny-app-on-heroku-free-tier-b31003858b68?source=collection_archive---------5-----------------------#2020-11-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1bc4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GitHub Actions和Heroku使持续部署变得容易</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/1f5ca13046d31271ec5c2c91fa67d6b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*U6ARH-YNN-e6SqJI.png"/></div></figure><p id="29ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是在Heroku上部署闪亮应用的简短指南。假定熟悉Docker、Shiny和GitHub。关于Docker的介绍，请参见 <a class="ae jm" rel="noopener" href="/analytics-vidhya/deploying-a-shiny-flexdashboard-with-docker-cca338a10d12"> <em class="jl">用Docker </em> </a> <em class="jl">部署闪亮的Flexdashboard。</em></p><p id="bcda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl">这篇文章也发表在</em><a class="ae jm" href="https://www.r-bloggers.com/" rel="noopener ugc nofollow" target="_blank"><em class="jl">https://www.r-bloggers.com/</em></a><em class="jl">上。</em></p></div><div class="ab cl jn jo gp jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="hb hc hd he hf"><h2 id="326e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke iq kf kg kh iu ki kj kk iy kl km kn ko bi translated">这篇文章将向你展示</h2><ul class=""><li id="1156" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">什么是Heroku，你能免费得到什么</li><li id="3c72" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">如何用Docker封装一个闪亮的应用程序</li><li id="77b9" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">如何设置GitHub自动部署到Heroku</li><li id="f376" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">如何为您部署的应用程序设置自定义域名</li></ul><h1 id="7639" class="lf jv hi bd jw lg lh li ka lj lk ll ke lm ln lo kh lp lq lr kk ls lt lu kn lv bi translated">Heroku自由层</h1><p id="66ee" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi lz translated"><span class="l ma mb mc bm md me mf mg mh di"> H </span> <a class="ae jm" href="https://www.heroku.com/home" rel="noopener ugc nofollow" target="_blank"> eroku </a>(我不隶属于它)是一个云平台服务，它提供了一种直观的方式来部署和管理企业级web应用。它可以让你的应用程序轻松地自动缩放，但不是在免费(和爱好)层，我们将在这里使用。可以通过CLI或Heroku仪表板管理应用程序。</p><p id="ae14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Heroku有太多的<a class="ae jm" href="https://elements.heroku.com/addons" rel="noopener ugc nofollow" target="_blank">插件</a>，例如用于登录或发送信息。此外，只需在CLI或部署说明文件“heroku.yml”中点击几下鼠标或输入几行代码，它就可以提供与应用程序共同部署的服务，如数据库。</p><p id="9e04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用新的<a class="ae jm" href="https://devcenter.heroku.com/articles/build-docker-images-heroku-yml" rel="noopener ugc nofollow" target="_blank"> heroku.ym </a> l文件，可以部署多容器应用程序。但是这里我们不会使用heroku.yml，因为部署将由GitHub Actions管理。</p><p id="4fb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Heroku应用程序运行在“dynos”中，dynos是运行在AWS上的容器。使用免费层，您可以在每个512 MB内存的情况下运行最多5个dyno(100，如果您验证)的应用程序，并获得550 (1000，如果您验证)个dyno小时。在免费层，你的应用程序在30分钟后进入“睡眠模式”并需要被唤醒，这通常意味着你第一次请求的加载时间将会延长10-30秒。这种行为节省了你的空闲时间。如果你想避免这一点，给你的应用程序添加一个GET请求，这样应用程序就会以小于30分钟的间隔调用自己。我们将会看到这能持续多久。</p><p id="c967" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我喜欢Heroku定价模式的原因是它是基于应用的。这意味着您可以在免费层测试后升级单个应用程序。在付费层，您可以获得各种好处，如自动缩放，无限的动态时间和自定义域的SSL加密。</p></div><div class="ab cl jn jo gp jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="hb hc hd he hf"><h1 id="70d0" class="lf jv hi bd jw lg mi li ka lj mj ll ke lm mk lo kh lp ml lr kk ls mm lu kn lv bi translated">闪亮的应用程序Docker图像</h1><p id="bcb4" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi lz translated"><span class="l ma mb mc bm md me mf mg mh di"> H </span> eroku dynos支持一些开箱即用的语言，如Python和附带的<a class="ae jm" href="https://elements.heroku.com/buildpacks" rel="noopener ugc nofollow" target="_blank">构建包</a>。在<a class="ae jm" href="https://github.com/virtualstaticvoid/heroku-buildpack-r" rel="noopener ugc nofollow" target="_blank"> github </a>上有<a class="ae jm" href="https://davidquartey.medium.com/how-i-installed-r-on-heroku-ff8286233d2c" rel="noopener">非官方的</a>R的buildpacks。然而，这里我们将使用Docker容器在dyno中运行。此外，将闪亮的应用程序放在Docker容器中有各种优势，例如正确管理依赖性和跨系统的良好可移植性。</p><p id="2cfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个例子中，部署了一个R Shiny应用程序，它提供地址到经度和纬度的批量地理编码。在回购中你可以找到并克隆闪亮的应用，Dockerfile和GitHub Actions https://github.com/timosch29/geocoding_shiny:<a class="ae jm" href="https://github.com/timosch29/geocoding_shiny" rel="noopener ugc nofollow" target="_blank">YAML</a></p><p id="796d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署的应用程序可以在<a class="ae jm" href="https://geocoding.timschendzielorz.com" rel="noopener ugc nofollow" target="_blank">geocoding.timschendzielorz.com</a>找到。</p><p id="2a8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Heroku上的部署，您必须稍微修改Dockerfile指令。</p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="6c40" class="ju jv hi mo b fi ms mt l mu mv"># Base image https://hub.docker.com/u/rocker/                       FROM rocker/shiny-verse:4.0.3</span><span id="6451" class="ju jv hi mo b fi mw mt l mu mv">LABEL author="Tim M.Schendzielorz docker@timschendzielorz.com"</span><span id="94a5" class="ju jv hi mo b fi mw mt l mu mv"># system libraries of general use                       <br/># install debian packages                       <br/>RUN apt-get update -qq &amp;&amp; apt-get -y --no-install-recommends install \ <br/>    libxml2-dev \<br/>    libcairo2-dev \<br/>    libpq-dev \ <br/>    libssh2-1-dev \<br/>    libcurl4-openssl-dev \<br/>    libssl-dev</span><span id="ae43" class="ju jv hi mo b fi mw mt l mu mv"># update system libraries<br/>RUN apt-get update &amp;&amp; \ <br/>    apt-get upgrade -y &amp;&amp; \  <br/>    apt-get clean</span><span id="e057" class="ju jv hi mo b fi mw mt l mu mv"># copy necessary files from app folder<br/># Shiny app <br/>COPY /shiny_geocode ./app                       <br/># renv.lock file<br/>COPY /renv.lock ./renv.lock</span><span id="f30a" class="ju jv hi mo b fi mw mt l mu mv"># install renv &amp; restore packages                       <br/>RUN Rscript -e 'install.packages("renv")'<br/>RUN Rscript -e 'renv::restore()'</span><span id="0399" class="ju jv hi mo b fi mw mt l mu mv"># remove install files                       <br/>RUN rm -rf /var/lib/apt/lists/*</span><span id="c3f0" class="ju jv hi mo b fi mw mt l mu mv"># make all app files readable, gives rwe permisssion (solves issue when dev in Windows, but building in Ubuntu)                       RUN chmod -R 755 /app</span><span id="cc13" class="ju jv hi mo b fi mw mt l mu mv"># expose port (for local deployment only)                       EXPOSE 3838</span><span id="cd7f" class="ju jv hi mo b fi mw mt l mu mv"># set non-root                       <br/>RUN useradd shiny_user<br/>USER shiny_user</span><span id="0a89" class="ju jv hi mo b fi mw mt l mu mv"># run app on container start (use heroku port variable for deployment)<br/>CMD ["R", "-e", "shiny::runApp('/app', host = '0.0.0.0', port = as.numeric(Sys.getenv('PORT')))"]</span></pre><p id="6577" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个docker文件中，renv用于通过“RUN Rscript -e 'renv::restore()'”从renv.lock文件安装必要的R库，以使容器中的库版本与本地开发环境中的库版本相同。</p><p id="7ff2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要在Heroku上运行容器化的应用程序，有两件事是必需的。首先，出于安全原因，容器必须以非root身份运行。通过<code class="du mx my mz mo b">RUN useradd shiny_user</code>创建新用户，并通过<code class="du mx my mz mo b">USER shiny_user</code>进行设置。</p><p id="bc6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其次，Heroku通过<code class="du mx my mz mo b">PORT</code>主机变量为每个dyno提供一个随机端口。要在这个端口运行闪亮的应用程序，在runApp命令中使用<code class="du mx my mz mo b">port = as.numeric(Sys.getenv('PORT'))</code>。</p></div><div class="ab cl jn jo gp jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="hb hc hd he hf"><h1 id="98f0" class="lf jv hi bd jw lg mi li ka lj mj ll ke lm mk lo kh lp ml lr kk ls mm lu kn lv bi translated">使用GitHub动作的持续部署</h1><p id="dd44" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi lz translated">G<span class="l ma mb mc bm md me mf mg mh di">itHub Actions提供了一个简单的模板和<a class="ae jm" href="https://github.com/marketplace/actions/deploy-to-heroku" rel="noopener ugc nofollow" target="_blank">指令</a>从<a class="ae jm" href="https://github.com/AkhileshNS/heroku-deploy" rel="noopener ugc nofollow" target="_blank">https://github.com/AkhileshNS/heroku-deploy</a>部署到Heroku。在顶层包括一个目录。GitHub repo中包含以下main.yml文件的github/workflows:</span></p><pre class="je jf jg jh fd mn mo mp mq aw mr bi"><span id="23d6" class="ju jv hi mo b fi ms mt l mu mv">name: heroku_deploy<br/>    on:                         <br/>        push:                           <br/>            branches:<br/>                - master</span><span id="7c52" class="ju jv hi mo b fi mw mt l mu mv">jobs:                        <br/>    build:                          <br/>    runs-on: ubuntu-latest                        <br/>       steps:<br/>           - uses: actions/checkout@v2        <br/>           - uses: akhileshns/heroku-deploy@v3.6.8<br/>           with: <br/>               heroku_api_key: ${{secrets.HEROKU_API_KEY}}  <br/>               heroku_app_name: "geocode-shiny"                                 <br/>               heroku_email: ${{secrets.HEROKU_EMAIL}}                                   <br/>               healthcheck: "https://geocode-shiny.herokuapp.com/"                                     <br/>               usedocker: true                                  <br/>               delay: 60                                 <br/>               rollbackonhealthcheckfailed: true</span><span id="9a6b" class="ju jv hi mo b fi mw mt l mu mv">           env: <br/>              HD_API_KEY: ${{secrets.MAPS_API_KEY}} # Docker env var</span></pre><p id="7781" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，我们指定在推送到主分支时发生动作“heroku_deploy”。在这些步骤中，触发动作的提交被检出以供工作流访问，在下一步中，它被推送到Heroku，构建并部署。</p><p id="3652" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要参数<em class="jl"> heroku_api_key、heroku_app_name </em>和<em class="jl"> heroku_email </em>。去得到它们</p><ol class=""><li id="fcd0" class="kp kq hi ih b ii ij im in iq na iu nb iy nc jc nd kx ky kz bi translated">在网站上创建一个Heroku帐户。</li><li id="7b9b" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">转到Heroku仪表盘或<a class="ae jm" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank">下载CLI工具</a>。</li><li id="e6a8" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">在仪表盘中或通过<code class="du mx my mz mo b">heroku create your_app_name</code>创建一个具有唯一名称的新应用。</li><li id="aeae" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">从您的Heroku帐户设置或通过<code class="du mx my mz mo b">heroku auth:token</code>获取API密钥。</li><li id="653c" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">将Heroku帐户的两个变量存储在GitHub repo Settings-&gt;Secrets中，命名为HEROKU_API_KEY和HEROKU_EMAIL。</li></ol><p id="2ef0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署docker容器需要参数<em class="jl"> usedocker: true </em>。此外，我们使用url(在第一次成功部署后您就会知道)和<em class="jl"> healthcheck: true </em>。通过<em class="jl">rollbackonhealthcheckfailed:true</em>，当应用程序的运行状况检查失败时，运行状况检查延迟60秒，延迟:60秒，部署回滚到上一次提交。</p><p id="5055" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个闪亮的应用程序需要一个秘密的API密钥，外部API才能工作。它也保存为GitHub secret，并作为Docker环境变量提供。要为您的应用程序设置env变量，请在它们前面加上HD_。这在部署中被剥离，并且是区分构建和部署变量所必需的。不要把你的任何秘密直接放在GitHub repos的文件里！</p><p id="57d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！推送至主分支(或任何其他分支，您也可以使用标记来指定main.yml中的部署提交),并检查GitHub Actions选项卡是否部署成功。然后在仪表盘中或通过<code class="du mx my mz mo b">heroku apps:info -a your_app_name</code>获取你的应用的网址。将此url添加到main.yml中的healthcheck，以用于将来的部署版本。</p></div><div class="ab cl jn jo gp jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="hb hc hd he hf"><h1 id="fb24" class="lf jv hi bd jw lg mi li ka lj mj ll ke lm mk lo kh lp ml lr kk ls mm lu kn lv bi translated">为应用程序设置自定义URL</h1><p id="3043" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi lz translated"><span class="l ma mb mc bm md me mf mg mh di">要为您拥有/有权访问的Heroku app 设置一个<a class="ae jm" href="https://devcenter.heroku.com/articles/custom-domains" rel="noopener ugc nofollow" target="_blank">自定义域，您需要:</a></span></p><ol class=""><li id="bdae" class="kp kq hi ih b ii ij im in iq na iu nb iy nc jc nd kx ky kz bi translated">用信用卡验证您的Heroku帐户。你不会发生任何费用的应用程序免费层，此外，需要选择付费服务。如果你验证，你会得到更多的动力和免费动力小时。</li><li id="f283" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">使用<code class="du mx my mz mo b">heroku domains:add <a class="ae jm" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">www.example.com</a> -a your_app_name</code>通过dashboard或CLI工具将您的域添加到应用程序。</li><li id="33fb" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">转到您的域名提供商，为www.example.com的<a class="ae jm" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">添加一个新的CNAME记录，指向您通过仪表板或<code class="du mx my mz mo b">heroku domains -a your_app_name</code>获得的Heroku DNS目标。</a></li><li id="e37c" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc nd kx ky kz bi translated">通过<code class="du mx my mz mo b">host <a class="ae jm" href="http://www.example.com" rel="noopener ugc nofollow" target="_blank">www.example.com</a></code>检查DNS配置是否正确。</li></ol></div></div>    
</body>
</html>