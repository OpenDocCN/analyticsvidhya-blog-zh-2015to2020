<html>
<head>
<title>Fascinating active records query methods in rails 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">rails 6中有趣的活动记录查询方法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/fascinating-active-records-query-methods-in-rails-6-63d431dbfdd6?source=collection_archive---------18-----------------------#2019-12-11">https://medium.com/analytics-vidhya/fascinating-active-records-query-methods-in-rails-6-63d431dbfdd6?source=collection_archive---------18-----------------------#2019-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a42b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你好，</p><p id="f3d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最近偶然发现了一些迷人的rails魔术(方法),我想和大家分享一下..</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/3b92dc5a543a6e9cdb54db94176a7509.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*2J4iGRg4RihQNB-TbLGD5A.jpeg"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">查询方法</figcaption></figure><ol class=""><li id="d928" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated"><strong class="ih hj">注解:</strong></li></ol><p id="ae79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好的。让我们从注释rails 6中新引入的活动记录方法开始。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jy"><img src="../Images/c384379583404c6fcedcd9ba3957d2f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/1*IeN9lRHjXT5jJxavvAXqAg.gif"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">给…作注解</figcaption></figure><p id="d8e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有没有想过给SQL查询加注释。这样一个新手可以很容易地理解你所做的复杂查询。</p><p id="0555" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么注释就是做到这一点的魔法。</p><p id="08ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">例句:</strong></p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="0bcc" class="ke kf hi ka b fi kg kh l ki kj"><a class="ae kk" href="https://apidock.com/rails/User" rel="noopener ugc nofollow" target="_blank">User</a><strong class="ka hj">.</strong><a class="ae kk" href="https://apidock.com/rails/ActiveRecord/QueryMethods/annotate" rel="noopener ugc nofollow" target="_blank">annotate</a><strong class="ka hj">("</strong>selecting user names<strong class="ka hj">").</strong><a class="ae kk" href="https://apidock.com/rails/ActiveRecord/QueryMethods/select" rel="noopener ugc nofollow" target="_blank">select</a><strong class="ka hj">(</strong>:name<strong class="ka hj">)</strong><br/><em class="kl"># SELECT "users"."name" FROM "users" /* selecting user names */</em><br/><br/><a class="ae kk" href="https://apidock.com/rails/User" rel="noopener ugc nofollow" target="_blank">User</a><strong class="ka hj">.</strong><a class="ae kk" href="https://apidock.com/rails/ActiveRecord/QueryMethods/annotate" rel="noopener ugc nofollow" target="_blank">annotate</a><strong class="ka hj">("</strong>selecting<strong class="ka hj">",</strong> <strong class="ka hj">"</strong>user<strong class="ka hj">",</strong> <strong class="ka hj">"</strong>names<strong class="ka hj">").</strong><a class="ae kk" href="https://apidock.com/rails/ActiveRecord/QueryMethods/select" rel="noopener ugc nofollow" target="_blank">select</a><strong class="ka hj">(</strong>:name<strong class="ka hj">)</strong><br/><em class="kl"># SELECT "users"."name" FROM "users" /* selecting */ /* user */ /* names */</em></span></pre><p id="b8e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">SQL块注释分隔符“/*”和“*/”将自动添加。</p><p id="dbdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2。创建方式:</strong></p><p id="b9da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它的工作是设置从一个关系对象创建新记录时使用的属性。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es km"><img src="../Images/569b66d2485e20b6d85c998c831aeeae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WKNFjQbF8JAPFQQ7h7r6tw.jpeg"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">创造</figcaption></figure><p id="f13d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">例如:</strong></p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="7b51" class="ke kf hi ka b fi kg kh l ki kj">users = User.where(name: 'Oscar')<br/>users.new.name <em class="kl"># =&gt; 'Oscar'</em><br/><br/>users = users.create_with(name: 'DHH')<br/>users.new.name <em class="kl"># =&gt; 'DHH'</em></span></pre><p id="ccfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还可以将nil传递给create_with来重置属性。</p><p id="dff8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 3。扩展:</strong></p><p id="9cae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用于通过提供的模块或块用附加方法扩展范围。</p><p id="5bbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">返回的对象是一个关系，可以进一步扩展。</p><blockquote class="kr ks kt"><p id="1a04" class="if ig kl ih b ii ij ik il im in io ip ku ir is it kv iv iw ix kw iz ja jb jc hb bi translated">语法:扩展(*模块和块)</p></blockquote><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kx"><img src="../Images/89b3afcc18c37858f4641482987aa4ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*6JfttxT7jBRlkCuzn9N08g.gif"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">延伸</figcaption></figure><p id="d06b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">例如:</strong></p><p id="da05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个名为分页的模块。</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="4c10" class="ke kf hi ka b fi kg kh l ki kj"><strong class="ka hj">module Pagination</strong><br/>  <strong class="ka hj">def</strong> <strong class="ka hj">page</strong>(number)<br/>    <em class="kl"># pagination code goes here</em><br/>  <strong class="ka hj">end</strong><br/><strong class="ka hj">end</strong></span></pre><p id="eb09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">scope = model . all . extending(Pagination)<br/>scope . page(params[:page])</p><p id="ba61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用块:</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="e277" class="ke kf hi ka b fi kg kh l ki kj">scope = Model.all.extending <strong class="ka hj">do</strong><br/>  <strong class="ka hj">def</strong> <strong class="ka hj">page</strong>(number)<br/>    <em class="kl"># pagination code goes here</em><br/>  <strong class="ka hj">end</strong><br/><strong class="ka hj">end</strong><br/>scope.page(params[:page])</span></pre><p id="dc3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 4。提取关联:</strong></p><p id="698c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是rails 6中新引入的方法。它的任务是从关系中提取一个名为<code class="du ky kz la ka b">association</code>的。首先预加载命名关联，然后从关系中收集单个关联记录。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lb"><img src="../Images/1ca5678487543759c5f49b703c73f043.png" data-original-src="https://miro.medium.com/v2/resize:fit:334/format:webp/1*_xxMZF7hkCnV3ojrt5FqXQ.jpeg"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">提取</figcaption></figure><p id="fd58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">例如:</strong></p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="bd29" class="ke kf hi ka b fi kg kh l ki kj">account.memberships.extract_associated(:user)<br/><em class="kl"># =&gt; Returns collection of User records</em></span></pre><p id="25cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这也可以写成这样:</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="b819" class="ke kf hi ka b fi kg kh l ki kj">account<strong class="ka hj">.memberships.preload</strong>(:user)<strong class="ka hj">.collect</strong>(&amp;:user)</span></pre><p id="b9ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 5。优化器提示:</strong></p><p id="a96e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果想在数据库查询中使用提示，rails 6提供了一个名为optimizer_hints的新方法。</p><p id="ff08" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如:</p><p id="aee2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">指定要在SELECT语句中使用的优化程序提示。</p><p id="e2cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例(对于MySQL):</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="00e6" class="ke kf hi ka b fi kg kh l ki kj">Topic.optimizer_hints("MAX_EXECUTION_TIME(50000)", "NO_INDEX_MERGE(topics)")<br/><em class="kl"># SELECT /*+ MAX_EXECUTION_TIME(50000) NO_INDEX_MERGE(topics) */ `topics`.* FROM `topics`</em></span></pre><p id="f7a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例(对于带有pg_hint_plan的PostgreSQL):</p><pre class="je jf jg jh fd jz ka kb kc aw kd bi"><span id="b207" class="ke kf hi ka b fi kg kh l ki kj">Topic.optimizer_hints("SeqScan(topics)", "Parallel(topics 8)")<br/><em class="kl"># SELECT /*+ SeqScan(topics) Parallel(topics 8) */ "topics".* FROM "topics"</em></span></pre></div></div>    
</body>
</html>