<html>
<head>
<title>How to Create a Stock Market Watcher Using Ruby.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Ruby创建股市观察者？</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-create-a-stock-market-watcher-using-ruby-edcd2c69ee76?source=collection_archive---------21-----------------------#2020-05-22">https://medium.com/analytics-vidhya/how-to-create-a-stock-market-watcher-using-ruby-edcd2c69ee76?source=collection_archive---------21-----------------------#2020-05-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/fb92e1a19d4eddbeed8f09c1e353bcdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*cStacbcB7ylqz6gutZvQkQ.png"/></div></figure><p id="5ad3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于我写的第一篇文章，我决定写关于网络抓取以及我如何使用Ruby和Nokogiri Gem构建一个股市观察器。</p><p id="b3e6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先遵循本指南的一些要求:</p><ol class=""><li id="faf1" class="jk jl hi io b ip iq it iu ix jm jb jn jf jo jj jp jq jr js bi translated">红宝石</li><li id="1c26" class="jk jl hi io b ip jt it ju ix jv jb jw jf jx jj jp jq jr js bi translated">HTML/CSS基础知识</li></ol><p id="80ed" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">本指南的目的是展示你可以使用Ruby做什么，也许在那里你会找到更好/更专业的方法。</p><p id="183c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">包含本指南中使用的完整代码的repo将在文章末尾链接。</p><p id="fb62" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们开始吧</p><p id="1c47" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，设置您的环境，创建一个ruby文件，其中包含我们的scrapper代码。</p><p id="ea1c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这种情况下，我将创建一个名为stock_watcher.rb的文件，并向其中添加以下代码。</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="6c36" class="kh ki hi kd b fi kj kk l kl km">#stock_watcher.rb<br/>require ‘nokogiri’<br/>require ‘open-uri’</span></pre><p id="e55d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这段代码需要一个名为Nokogiri的Ruby Gem(帮助我们处理从网站提取的数据)和open-uri模块来从web中提取数据。</p><p id="4d06" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在此之后，我们需要定义我们将从哪里为我们的scrapper获取数据，在这里，您可以使用任何网站，对于本指南，我将使用TradingView数据。</p><p id="d13f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在定义了源，我们需要从页面中获取数据，Nokogiri得到了一些有用的解析方法来帮助我们，我们将使用Nokogiri::HTML解析器，因为我们正在抓取HTML页面。</p><p id="eec5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将以下代码添加到stock_watcher.rb中</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="cde3" class="kh ki hi kd b fi kj kk l kl km">#stock_watcher.rb<br/>page = Nokogiri::HTML(URI.open(‘https://www.tradingview.com/markets/stocks-usa/market-movers-large-cap'))</span></pre><p id="637a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这个简单的使用URI模块从web上获取数据，并使用Nokogiri解析它，它返回一个Nokogiri::HTML::Document。</p><p id="5488" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有了page对象，我们就有了一堆有用的方法。</p><p id="a615" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们必须使用我们的HTML/CSS确认来定义从页面上的什么地方获取数据。Chrome dev tools是这里的好朋友。</p><p id="b049" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">出现问题的页面是<a class="ae kn" href="https://www.tradingview.com/markets/stocks-usa/market-movers-large-cap/" rel="noopener ugc nofollow" target="_blank">https://www . trading view . com/markets/stocks-USA/MARKET-movers-large-cap/</a>，这个页面向我们展示了按大盘股排序的美国股市公司。这个页面在主表上存储数据，正如你所看到的，我们需要找到一种方法来识别这个表。</p><p id="bfcf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Nokogiri为我们提供了一个名为“css”的方法，让我们在Nokogiri::HTML::文档中搜索特定的CSS规则，我们可以搜索特定的CSS类、id等…</p><p id="aef2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们尝试使用Chrome inspect工具找出表的类或ID，只需右键单击任何表元素，然后进行检查，您会发现一个类似的窗口:</p><figure class="jy jz ka kb fd ij er es paragraph-image"><div class="er es ko"><img src="../Images/760e7d037280bc89719084ea82d07a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/format:webp/1*1pv3slqPIwY6CtapikvLUw.png"/></div></figure><p id="93b8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">滚动一点直到你找到像这样的<table>标签:</table></p><figure class="jy jz ka kb fd ij er es paragraph-image"><div class="er es kp"><img src="../Images/b43856845473717347b1f1d2d48c9b08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*b_qZOMFYCWV7ismyUx1suw.png"/></div></figure><p id="84c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">正如您所看到的，我们的表使用了“tv-data-table”类，该类将成为我们的目标类。</p><p id="f857" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在我们有了表类，将下面的代码添加到stock_watcher.rb中:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="38ae" class="kh ki hi kd b fi kj kk l kl km">#stock_watcker.rb<br/>table = page&amp;.css(‘.tv-data-table’);</span></pre><p id="1c41" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这段代码获取我们的page对象，找到一个分配了“tv-data-table”类的HTML元素，并返回一个Nokogiri::XML::NodeSet。</p><p id="03a6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们从表中唯一需要的是表数据，表数据(td)存储在表行(tr)中。Nokogiri::XML::NodeSet提供了更有用的方法，允许我们在其中搜索特定的键。</p><p id="1bc1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将以下代码添加到stock_watcher.rb中:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="7be8" class="kh ki hi kd b fi kj kk l kl km">#stock_watcker.rb<br/>rows = table.search(‘tr’);</span></pre><p id="cf24" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将返回另一个Nokogiri::XML:NodeSet，其中包含来自包含“tr”的表的键和值的子集。</p><p id="b530" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们正在接近我们的目标。</p><p id="ad6e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在将以下代码添加到stock_wacher.rb中:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="9733" class="kh ki hi kd b fi kj kk l kl km">#stock_watcher.rb<br/>rows.each do |row|</span><span id="e58b" class="kh ki hi kd b fi kq kk l kl km">stock_content = row.search(‘td’).map { |td| td.text.strip }</span><span id="913b" class="kh ki hi kd b fi kq kk l kl km">stock_content[0]&amp;.gsub!(“\n\t\t\t\t\t\t\t\t\t”, “ “)</span><span id="37cd" class="kh ki hi kd b fi kq kk l kl km">end</span></pre><p id="fb7a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，我们迭代XML子集，在本例中，是包含股票数据的行。然后，我们使用相同的方法search在每一行中搜索表数据(td ),它返回一个包含迭代行的所有数据的数组。我们需要剥离我们的文本，因为Nokogiri在我们的字符串中返回了大量无用的文本。</p><p id="ca24" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在您可以使用这段代码，尝试使用“puts stock_content”在最后一段代码的end关键字之前打印您得到的股票内容，看看您得到了什么，它应该会返回类似下面的内容:</p><p id="27ab" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">["MSFT微软公司"，" 182.51 "，" 2.27% "，"-4.23 "，"买入"，" 1384.054B "，" 31.09 "，" 6.06 "，" 144000.00 "，"技术服务"]"</p><p id="b0aa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有了这些数据，谁来定义下一步应该做什么是你，有数以千计的可能性可以用它来做什么，我会给出几个例子:将数据存储在一个文件中供以后检查，将数据存储在一个数据库中供以后处理，甚至在另一个网站上显示数据(首先检查许可)，如果股票价格是你想要的价格，创建触发器。我说过，有很多可能性。</p><p id="56c3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，为了完成本指南，我创建了一个类来处理我们从上一段代码中获得的数据。</p><p id="760f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，在同一个文件夹中创建另一个名为stock.rb的文件，并添加以下代码:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="ddf2" class="kh ki hi kd b fi kj kk l kl km">class Stock</span><span id="21bd" class="kh ki hi kd b fi kq kk l kl km">attr_reader :name, :last, :change_percentage, :change_value, :rating, :vol, :market_cap</span><span id="9d90" class="kh ki hi kd b fi kq kk l kl km">def initialize(stock_data)</span><span id="8e2a" class="kh ki hi kd b fi kq kk l kl km">@name = stock_data[0]</span><span id="f460" class="kh ki hi kd b fi kq kk l kl km">@last = stock_data[1]</span><span id="30ff" class="kh ki hi kd b fi kq kk l kl km">@change_percentage = stock_data[2]</span><span id="a542" class="kh ki hi kd b fi kq kk l kl km">@change_value = stock_data[3]</span><span id="632f" class="kh ki hi kd b fi kq kk l kl km">@rating = stock_data[4]</span><span id="1bc9" class="kh ki hi kd b fi kq kk l kl km">@vol = stock_data[5]</span><span id="18a8" class="kh ki hi kd b fi kq kk l kl km">@market_cap = stock_data[6]</span><span id="b163" class="kh ki hi kd b fi kq kk l kl km">end</span><span id="ae72" class="kh ki hi kd b fi kq kk l kl km">end</span></pre><p id="f264" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我不打算解释Ruby上的类是如何工作的，因为这不是本指南的目的。但基本上，该类接收我们在“stack_content”变量上获得数据，并优雅地存储它。</p><p id="8534" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在替换stock_watcher.rb文件中的整个代码，如下所示:</p><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="9e89" class="kh ki hi kd b fi kj kk l kl km">require ‘nokogiri’</span><span id="bbe4" class="kh ki hi kd b fi kq kk l kl km">require ‘open-uri’</span><span id="beae" class="kh ki hi kd b fi kq kk l kl km">require_relative ‘stock’</span><span id="0962" class="kh ki hi kd b fi kq kk l kl km">page = Nokogiri::HTML(URI.open(‘https://www.tradingview.com/markets/stocks-usa/market-movers-large-cap'))</span><span id="2032" class="kh ki hi kd b fi kq kk l kl km">table = page&amp;.css(‘.tv-data-table’);</span><span id="fd21" class="kh ki hi kd b fi kq kk l kl km">rows = table.search(‘tr’);</span><span id="7359" class="kh ki hi kd b fi kq kk l kl km">stock_arr = []</span><span id="b4c1" class="kh ki hi kd b fi kq kk l kl km">rows.each do |row|</span><span id="5a57" class="kh ki hi kd b fi kq kk l kl km">stock_content = row.search(‘td’).map { |td| td.text.strip }</span><span id="47f7" class="kh ki hi kd b fi kq kk l kl km">stock_content[0]&amp;.gsub!(“\n\t\t\t\t\t\t\t\t\t”, “ “)</span><span id="ab35" class="kh ki hi kd b fi kq kk l kl km">stock_arr &lt;&lt; Stock.new(stock_content) if stock_content.length.positive?</span><span id="aacd" class="kh ki hi kd b fi kq kk l kl km">end</span></pre><p id="6d9f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它需要我们的新类文件，创建一个名为stock_arr的新数组，并在其上存储每个新的stock对象。</p><p id="0e42" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你在stock_arr上打印第一个对象，你会得到这样的结果:" # <0x00007fffd443e2f8 microsoft="" corp.="">"</0x00007fffd443e2f8></p><p id="096f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如您所见，这是存储股票的更好方式，您可以使用点符号访问其属性，如stock.name、stock.last、stock.change_value等…</p><p id="d954" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">感谢您阅读本指南，我希望它在某些方面对您有所帮助。</p><p id="fe02" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请随时通过以下社交媒体联系我:</p><p id="bfb7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">推特:<a class="ae kn" href="https://twitter.com/iKazumaki" rel="noopener ugc nofollow" target="_blank">https://twitter.com/iKazumaki</a></p><p id="2fc8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">GitHub:<a class="ae kn" href="http://github.com/kazumaki/" rel="noopener ugc nofollow" target="_blank">http://github.com/kazumaki/</a></p><p id="865b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">领英:<a class="ae kn" href="https://www.linkedin.com/in/vcamposcarvalho/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/vcamposcarvalho/</a></p><h2 id="9d69" class="kh ki hi bd kr ks kt ku kv kw kx ky kz ix la lb lc jb ld le lf jf lg lh li lj bi translated">有用的链接:</h2><p id="c45e" class="pw-post-body-paragraph im in hi io b ip lk ir is it ll iv iw ix lm iz ja jb ln jd je jf lo jh ji jj hb bi translated">完整的代码库:<a class="ae kn" href="https://github.com/kazumaki/stock-market-watcher" rel="noopener ugc nofollow" target="_blank">https://github.com/kazumaki/stock-market-watcher</a></p><p id="bcb2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">TradingView网站:【https://www.tradingview.com/ T2】T3</p><p id="a435" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Nokogiri文档:【https://nokogiri.org/rdoc/index.html T4】</p></div></div>    
</body>
</html>