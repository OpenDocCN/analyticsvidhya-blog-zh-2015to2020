<html>
<head>
<title>How to load Keras h5 model format from Google Cloud Bucket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从谷歌云桶加载Keras h5模型格式</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-load-keras-h5-model-format-from-google-cloud-bucket-abf9a77d3cb4?source=collection_archive---------13-----------------------#2020-09-19">https://medium.com/analytics-vidhya/how-to-load-keras-h5-model-format-from-google-cloud-bucket-abf9a77d3cb4?source=collection_archive---------13-----------------------#2020-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/48a360fbe32c72587d5d54d285bd3d23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HB9U2WQJgwnrDyqq"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">卡洛琳五世在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="1327" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">注1:此方法只在Google云存储桶上有效。</em> </strong></p><p id="01ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">注2:tensor flow 2 . 3 . 0和Keras 2.4.3 </em> </strong>上训练的所有命令和模型</p><p id="6877" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">注3:我还假设你知道如何在谷歌云存储桶中上传数据，以及如何创建</em> </strong> <a class="ae iu" href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> <em class="jt">服务帐户JSON键</em> </strong> </a> <strong class="ix hj"> <em class="jt">来访问你的谷歌项目中的任何内容。</em>T25】</strong></p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="e804" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我部署我的模型时，由于的尺寸很大，很难将它们从一个环境移动到另一个环境，如果我想从任何地方访问它们，都非常困难。所以，我想知道为什么我不只是把它们上传到谷歌云存储桶，并进行适当的版本控制，以便随时随地访问任何版本。所以，这是步骤。</p><p id="be58" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第一步:</strong>将您保存的<strong class="ix hj"> .h5格式的Keras模型</strong>上传到桶中。</p><figure class="kc kd ke kf fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kb"><img src="../Images/8854561a9fe9d53cac651711b8e17563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wYl2X-BCw3FLRd-STG77cg.png"/></div></div></figure><p id="d46d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第二步:</strong>创建<strong class="ix hj">服务账户密钥</strong>。因此，您可以从云存储桶中访问文件。</p><p id="785a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">第三步</strong>:现在安装这些python包<strong class="ix hj"> gcsfs </strong>用于访问bucket文件<strong class="ix hj"> h5py </strong>用于读取<strong class="ix hj"> h5格式</strong>文件。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="7860" class="kl km hi kh b fi kn ko l kp kq">pip install h5py<br/>pip install gcsfs</span></pre><p id="de9d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">步骤4: </strong>现在，运行下面的代码来访问你的模型。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="6a3e" class="kl km hi kh b fi kn ko l kp kq">from keras.models import load_model<br/>import h5py<br/>import gcsfs</span><span id="5d38" class="kl km hi kh b fi kr ko l kp kq">PROJECT_NAME = 'testone'<br/>CREDENTIALS = 'cred.json'<br/>MODEL_PATH = 'gs://testarticleone/1/model.h5'</span><span id="b000" class="kl km hi kh b fi kr ko l kp kq">FS = gcsfs.GCSFileSystem(<em class="jt">project</em>=PROJECT_NAME,<br/>                         token=CREDENTIALS)</span><span id="1796" class="kl km hi kh b fi kr ko l kp kq">with FS.open(MODEL_PATH, 'rb') as model_file:<br/>     model_gcs = h5py.File(model_file, 'r)<br/>     myModel = load_model(model_gcs)</span></pre><p id="73a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> FS </strong>是文件系统对象。</p><p id="5e96" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> PROJECT_NAME </strong>是你的云桶所在项目的名称。</p><p id="ea78" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">凭证</strong>是你的服务账号<strong class="ix hj"> JSON </strong>文件的路径。</p><p id="63fc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> MODEL_PATH </strong>是您的模型在桶中的路径。</p><p id="42f3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<strong class="ix hj">我的模型</strong>中，你将得到你的模型，现在你可以用它来预测。</p><p id="9e23" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，如果您在将令牌发送到模型之前使用预处理、令牌化或填充，并且您已经获得了<strong class="ix hj"> pickle </strong>文件，您也可以将它上传到bucket并访问它，只需遵循以下代码，确保您的令牌文件在<strong class="ix hj">中。pkl或者。泡菜</strong>格式。</p><pre class="kc kd ke kf fd kg kh ki kj aw kk bi"><span id="7c84" class="kl km hi kh b fi kn ko l kp kq">import pickle</span><span id="1eb4" class="kl km hi kh b fi kr ko l kp kq">TOKEN_PATH = 'gs://testarticleone/token.pkl'</span><span id="aa83" class="kl km hi kh b fi kr ko l kp kq">with FS.open(TOKEN_PATH, 'rb') as handle:<br/>     myToken = pickle.load(handle)</span></pre><p id="53fb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> TOKEN_PATH </strong>是您的令牌文件在bucket中的路径。</p><p id="9258" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在<strong class="ix hj"> myToken </strong>中，您将获得您的令牌文件，并使用它来预处理您的输入。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="1d0c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">注:如果你有任何建议和疑问，可以在评论区问我。谢谢，祝编码愉快。</em>T5】</strong></p></div></div>    
</body>
</html>