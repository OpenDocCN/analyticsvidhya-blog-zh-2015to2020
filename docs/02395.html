<html>
<head>
<title>The Multiple Comparisons Problem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多重比较问题</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/the-multiple-comparisons-problem-11482dd08197?source=collection_archive---------18-----------------------#2019-12-14">https://medium.com/analytics-vidhya/the-multiple-comparisons-problem-11482dd08197?source=collection_archive---------18-----------------------#2019-12-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f87a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用Northwind数据库了解问题以及如何避免</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/e01791aec0b7eac366b5bd45143a6377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3gXwrlwIID_d-w6e"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae jn" href="https://unsplash.com/@austindistel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Austin Distel </a>拍摄的照片</figcaption></figure><p id="3859" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">想象以下场景:你是一名数据科学家，被要求协助一家公司更好地了解其业务的不同方面。这可能包括员工绩效、产品销售和客户人口统计。你的工作是进行实验，尽可能多地从结果中学习，并提出商业建议。</p><p id="38c2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">通常，这是通过定义几个有用的指标或细分来实现的。这两种策略都有助于你更好地了解企业。在细分的情况下，您可以运行统计分析来发现重要的发现。这意味着深入挖掘以获得更好的见解。然而，这样做的代价很高，因为你做的比较越多，就越有可能得出错误的结论。这是一个常见的错误，被称为<strong class="jq hj">多重比较</strong>问题。在这篇文章中，我将强调这个问题是如何影响你的统计分析的，以及纠正它的技巧。</p><p id="6041" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">北风数据库</strong></p><p id="51de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于这个项目，我使用了Northwind公司的数据库来获得一些有价值的商业见解。Northwind数据库是Microsoft为一家虚构的专门从事食品和饮料分销的公司创建的示例数据库。该数据库包含一系列关于公司活动的信息，包括其客户、产品、订单和客户统计数据。我对理解折扣如何影响订单很感兴趣。所以，我决定问的一个问题是:</p><h2 id="055b" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">折扣如何影响订单数量？</h2><p id="ac57" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">这个问题突出了一个多重比较的例子，因为您需要比较不同的折扣级别并多次执行相同的分析。</p><p id="1559" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">陈述假设</strong></p><p id="003b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了回答这个问题，我首先需要创建两个假设:零假设和替代假设。</p><p id="fccb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">零假设:折扣水平不影响订单数量</p><p id="f012" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">替代假设:折扣水平确实会影响订单数量(增加或减少订单数量)</p><p id="b2c5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">alpha水平(当假设为真时拒绝零假设的概率)设置为0.05。</p><p id="99ce" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">获取数据</strong></p><p id="f7be" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">既然我们已经设置了假设和alpha值，我们可以从下面的模式中提取相关数据:</p><p id="c44b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae jn" href="https://raw.githubusercontent.com/learn-co-students/dsc-mod-3-project-online-ds-pt-041519/master/Northwind_ERD_updated.png" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/learn-co-students/DSC-mod-3-project-online-ds-pt-041519/master/north wind _ ERD _ updated . png</a></p><p id="b6fc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了回答这个问题，我需要从上面模式的订单细节表中提取产品id、折扣、单价和数量</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="6c0f" class="kk kl hi ll b fi lp lq l lr ls">#import relevant libraries<br/>import sqlite3<br/>import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>from matplotlib.dates import DateFormatter<br/>import matplotlib.dates as mdates<br/>from statsmodels.graphics.factorplots import interaction_plot<br/>import seaborn as sns<br/>import scipy.stats as stats<br/>import statsmodels.api as sm<br/>from statsmodels.formula.api import ols<br/>from statsmodels.stats.multicomp import pairwise_tukeyhsd<br/>from statsmodels.stats.multicomp import MultiComparison<br/>from statsmodels.stats.power import TTestIndPower, TTestPower<br/>import warnings<br/>warnings.filterwarnings(‘ignore’)<br/>import scipy as sp</span><span id="eeb2" class="kk kl hi ll b fi lt lq l lr ls">#connect to database<br/>conn = sqlite3.connect('Northwind_small.sqlite')<br/>c = conn.cursor()</span><span id="dcc2" class="kk kl hi ll b fi lt lq l lr ls">#create list of tables<br/>c.execute("""SELECT name from sqlite_master WHERE type = 'table';""")<br/>tables = c.fetchall()<br/>tables = [i[0] for i in tables]</span><span id="9da9" class="kk kl hi ll b fi lt lq l lr ls">c.execute("""SELECT ProductId, UnitPrice, Quantity, Discount FROM OrderDetail""")<br/>discounts = pd.DataFrame(c.fetchall())<br/>discounts.columns = [column[0] for column in c.description]<br/>discounts.head()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lu"><img src="../Images/9d29ff9b5eb25b0399041ccc4af8ec6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*NzpL_NA_Yaf5CmyPOgz-7Q.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图1:折扣数据框架</figcaption></figure><p id="db85" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，我需要检查是否有折扣:</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="9d16" class="kk kl hi ll b fi lp lq l lr ls">query = 'DiscBool != 0' #removing the non-discounted orders<br/>discounted = discounts.query(query)<br/>discounted.head(3)</span></pre><p id="694a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因为这个问题与折扣级别有关，所以我检查了折扣级别的数量。仔细研究后，我发现大多数折扣都在0到25之间，幅度为0.05。这些订单数量保持不变，而其他较小的折扣级别则有所下降。</p><p id="2578" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">探索数据</strong></p><p id="c219" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，相关数据已经被正确提取和分组，我可以开始研究它了。下面的代码块显示了打折订单和未打折订单之间的订单数量和平均订单规模的图表:</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="941b" class="kk kl hi ll b fi lp lq l lr ls">#Viewing difference between discount levels against number of orders and average order size visually<br/>#fig, axes = plt.subplot(1, 2, figsize = (12,5))<br/>fig, axes = plt.subplots(2, 1, figsize=(12,5))<br/>sns.set_style('whitegrid')<br/>#Grouping dataframe<br/>discounted.groupby(['Discount'])['Quantity'].count().plot(kind = 'barh', ax = axes[0], color=['#E78AC3', '#A6D854', '#FFD92F', '#E5C494', '#B3B3B3', '#66C2A5'])<br/>discounted.groupby(['Discount'])['Quantity'].mean().plot(kind = 'barh', ax = axes[1], color=['#E78AC3', '#A6D854', '#FFD92F', '#E5C494', '#B3B3B3', '#66C2A5'])<br/>#Plot 1 labels<br/>axes[0].set_title('Number of Orders per Discount Level', fontweight = 'bold', fontsize = 13)<br/>axes[0].set_xlabel('Order Size', fontweight = 'semibold')<br/>axes[0].set_ylabel('')<br/>axes[0].set_yticklabels(['0.05', '0.10', '0.15', '0.20', '0.25'])</span><span id="ff22" class="kk kl hi ll b fi lt lq l lr ls">#Plot 2 labels<br/>axes[1].set_title('Average Order Size by Discount Level', fontweight = 'bold', fontsize = 13)<br/>axes[1].set_xlabel('Average Order Size', fontweight = 'semibold')<br/>axes[1].set_ylabel('')<br/>axes[1].set_yticklabels(['0.05', '0.10', '0.15', '0.20', '0.25'])<br/>fig.subplots_adjust(hspace = .75);<br/>fig.savefig('discountlevels.png', bbox_inches = 'tight')</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lv"><img src="../Images/80748c6b500d282615882fc1b455f022.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4sciSjqOaFVSYOEdtOiBow.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图2:不同折扣级别的图表</figcaption></figure><p id="999f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">图表显示，不打折的商品越多，订单数量越多，但打折商品的平均订单规模也越大。</p><p id="497f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">假设检验</strong></p><p id="6986" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了回答折扣是否影响订货量的问题，使用了方差分析。ANOVA或方差分析生成多个组的统计分析。</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="c770" class="kk kl hi ll b fi lp lq l lr ls">#fitting using statsmodels ols<br/>lm = ols('Quantity ~ C(Discount)', discounted).fit()<br/>lm.summary()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lw"><img src="../Images/77ca96fb5ebdfc7bed70002a7e07c0cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*_E2bx8nBlMILZmW8ve2Hlw.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图3:折扣级别的方差分析表</figcaption></figure><p id="04e2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">上表显示了不同折扣级别的p值。下一步是进行Tukey测试。Tukey检验是一种单步统计检验，用于找出彼此显著不同的均值。对于多重比较，我们需要为不同的折扣级别创建数据框。</p><pre class="iy iz ja jb fd lk ll lm ln aw lo bi"><span id="e216" class="kk kl hi ll b fi lp lq l lr ls">#ANOVA analysis to test multiple comparisons test<br/>sm.stats.anova_lm(lm, typ = 2)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lx"><img src="../Images/1395e8ee5fbd65f9d91792437445e255.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*ySX961IZPL0f1UcqIYpnjA.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图4: Tukey表结果</figcaption></figure><p id="fb4e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">结果表给出了所有折扣级别的组合对，以进行比较，并给出了平均差异以及该平均差异是否拒绝了零假设或未能拒绝零假设。在Northwind项目的例子中，我发现在大多数情况下，产品定价的折扣水平不会影响订单数量。这些折扣有可能对收入产生负面影响。</p><p id="cca7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">结论</strong></p><p id="d3dd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在进行统计分析或检查研究时，多重比较问题是一个需要牢记的重要问题。因为如果我们足够努力地寻找，我们可能会在不存在相关性的地方发现相关性。人类非常善于发现模式，并可能犯在随机噪音中发现意义的错误。从商业角度来看，意识到这一点意味着更仔细地分析索赔，并做出更理性的决策。</p></div></div>    
</body>
</html>