<html>
<head>
<title>A Data Flow POC using Apache Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache气流的数据流概念验证</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/a-data-flow-poc-using-airflow-47820eac85b2?source=collection_archive---------9-----------------------#2020-08-20">https://medium.com/analytics-vidhya/a-data-flow-poc-using-airflow-47820eac85b2?source=collection_archive---------9-----------------------#2020-08-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="afe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个漂亮的数据ETL冒险工具。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/31c8f54cd6cc3e7eef75b3d778eee555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mnz0t-iIHzDucuu-"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">马库斯·斯皮斯克在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="ecd4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">什么是气流？</h1><p id="b2a4" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi kx translated"><span class="l ky kz la bm lb lc ld le lf di"> A </span> irflow是Airbnb在2014年创建的一个工作流管理平台。由于Airbnb中日益复杂的工作流，它最初是一个解决方案。气流用<strong class="ih hj"> <em class="lg"> Python </em> </strong>编写，工作流通过Python脚本创建。Airflow遵循“配置即代码”的原则，使用有向无环图(DAGS)来管理工作流编排。</p><p id="6f1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于在气流井教程指南，我不会在这里说明安装过程。</p><p id="cf93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你成功安装气流，只需运行以下命令启动气流。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="8515" class="lm jv hi li b fi ln lo l lp lq">$ airflow initdb<br/>$ airflow webserver<br/>$ airflow scheduler</span></pre></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="53a3" class="ju jv hi bd jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr bi translated">目的</h1><p id="8672" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我的目的是从雅虎财经抓取一家公司(以华硕为目标)的股价，每隔10分钟将结果插入MongoDB。</p><p id="16b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过Airflow web界面在图形视图或树形视图中查看作业，如下图所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es md"><img src="../Images/e2b31ca7b8bbad4a1b48fbb2b54469c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:774/format:webp/1*OZVd8VqNX5ssYB4zmSGEww.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图表视图</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es me"><img src="../Images/f4d22c6a627eadb4ffc61ed12e9de4df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yl-kQACmLMhGZtIkdnpMAw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">树形视图</figcaption></figure><p id="a1b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">树形视图告诉我们该作业何时开始以及每个任务的状态。第一个作业开始于“<em class="lg">2020–08–13t 16:00:00+00:00</em>”。Airflow中默认时区为<strong class="ih hj"> <em class="lg"> UTC </em> </strong>。这意味着我告诉DAG开始运行的实际时间是台北时间“2020–08–14t 00:00:00”。</p><p id="15f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用命令行或从web界面触发DAG。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="d90f" class="lm jv hi li b fi ln lo l lp lq">$ airflow trigger_dag &lt;dag_id&gt;</span></pre><p id="5385" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在启动dag之前，您可以单独测试您的任务。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="5008" class="lm jv hi li b fi ln lo l lp lq">$ airflow test &lt;dag_id&gt; &lt;task_id&gt; &lt;execution_date&gt;</span></pre><p id="f846" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除此之外，我们可以看出任务“get_stock_price”和“insert_to_mongo”有依赖关系。这个我以后再说。</p><p id="9596" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一种颜色代表一种状态，下面是颜色状态匹配图。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mf"><img src="../Images/131363d9223ad2d287d68234925bb48d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8pmR_0oW0DJHcdmfxELLJQ.png"/></div></div></figure></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="e266" class="ju jv hi bd jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr bi translated">配置为代码</h1><p id="7b70" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">在这一部分，我将讨论气流DAG配置。在谈论这个话题之前，你需要在你的airflow项目里面创建一个名为<strong class="ih hj"> <em class="lg"> dags </em> </strong>的文件夹。这个文件夹将存储所有的。py文件。</p><p id="4ac3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认dag配置如下所示。这是基本设置。</p><blockquote class="mg mh mi"><p id="0f9b" class="if ig lg ih b ii ij ik il im in io ip mj ir is it mk iv iw ix ml iz ja jb jc hb bi translated">“provide_context”用于传递一组可以在函数中使用的关键字参数。</p></blockquote><p id="47ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“provide_context”应该放在<strong class="ih hj"><em class="lg">python operator</em></strong>中，但是我放在了default_args中。</p><p id="4f0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">气流使用<a class="ae jt" href="https://airflow.apache.org/docs/stable/concepts.html?highlight=xcom#xcoms" rel="noopener ugc nofollow" target="_blank"> Xcom(交叉通信)</a>交换消息，Xcom可以“推”也可以“拉”。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="b70d" class="lm jv hi li b fi ln lo l lp lq">default_args = {<br/>    'owner': 'DennyChen',<br/>    'start_date':datetime(2020, 8, 14, 0, 0),<br/>    'depends_on_past': True,<br/>    #With this set to true, the pipeline won't run if the previous day failed<br/>    'email': [''],<br/>    'email_on_failure': True,<br/>    #upon failure this pipeline will send an email to your email set above<br/>    'email_on_retry': False,<br/>    'retries': 5,<br/>    'retry_delay': timedelta(seconds = 5),<br/>    'provide_context': True,<br/>}</span><span id="d9c0" class="lm jv hi li b fi mm lo l lp lq">dag = DAG(<br/>    'my_first_dags',<br/>    default_args = default_args,<br/>    description = 'A simple DAG',<br/>    schedule_interval= '*/10 * * * *'<br/>)</span></pre><p id="a89a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成这些基本配置后，我们可以创建自己的工作。首先，我们创建一个bash作业。这项工作只是简单地打印问候和时间。</p><p id="a08d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为' provide_context '是放在' default_args '里面的，所以我需要把<strong class="ih hj"> <em class="lg"> **context </em> </strong>放在我的函数里面，以便获取环境变量。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="362d" class="lm jv hi li b fi ln lo l lp lq">def test(**context):<br/>    print("Hi, I'm Denny")<br/>    time  = str(datetime.today())<br/>    print("Time: " + time)</span></pre><p id="00c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们编写一个小函数，通过Yahoo Finance获取华硕股票价格。在函数结束时，我返回三个值。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="ef42" class="lm jv hi li b fi ln lo l lp lq">def get_asus_stock_price(**context):<br/>    r = requests.get('<a class="ae jt" href="https://finance.yahoo.com/quote/2357.TW%3FP%3DASUS/'" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/2357.TW%3FP%3DASUS/'</a>)<br/>    soup = BeautifulSoup(r.text, 'lxml')</span><span id="3a62" class="lm jv hi li b fi mm lo l lp lq">org = soup.find('h1', 'D(ib) Fz(18px)').text<br/>    print(org)</span><span id="61a9" class="lm jv hi li b fi mm lo l lp lq">price = soup.find('span', 'Trsdu(0.3s) Fw(b) Fz(36px) Mb(-4px) D(ib)').text<br/>    print(price)</span><span id="cb4d" class="lm jv hi li b fi mm lo l lp lq"># up_or_down = soup.find('span', 'Trsdu(0.3s) Fw(500) Pstart(10px) Fz(24px)').text<br/>    # up_or_down = soup.find('span', {'data-reactid': '33'})<br/>    # print(up_or_down)</span><span id="3aca" class="lm jv hi li b fi mm lo l lp lq">date = soup.find('span', {'data-reactid':'35'}).text<br/>    print(date)</span><span id="f529" class="lm jv hi li b fi mm lo l lp lq">return org, price, date</span></pre><p id="81b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我从雅虎财经获取数据后，我需要将它们插入数据库。在这里，我选择MongoDB。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="1e1a" class="lm jv hi li b fi ln lo l lp lq">def insert_to_mongo(**context):<br/>    client = pymongo.MongoClient("")</span><span id="789c" class="lm jv hi li b fi mm lo l lp lq"><br/>    db = client["stock"]<br/>    collection = db["stock_price"]</span><span id="1f6e" class="lm jv hi li b fi mm lo l lp lq">dblist = client.list_database_names()<br/>    # dblist = myclient.database_names()<br/>    # print(dblist)<br/>    if "stock" in dblist:<br/>        print("Exist")<br/>    org, price, date = context['ti'].xcom_pull(task_ids='get_stock_price')<br/>    print(org)<br/>    print(price)<br/>    print(date)<br/>    time  = str(datetime.today())<br/>    dict = {"Company": org, "Price": price, "Date":date,  "Insert_Time":time}<br/>    collection.insert_one(dict)</span></pre><p id="c808" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我用xcom_pull从def get_asus_stock_price()获取数据返回。</p><p id="2259" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我需要设置每个作业。python_callable链接到我刚刚在上面写的def。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="2e21" class="lm jv hi li b fi ln lo l lp lq"># allow to call bash commands<br/>bashtask = BashOperator(<br/>    task_id = 'bash_task',<br/>    bash_command = 'date',<br/>    dag = dag,<br/>)</span><span id="8ea8" class="lm jv hi li b fi mm lo l lp lq"># allow to call python tasks<br/>python_task = PythonOperator(<br/>    task_id = 'python_task',<br/>    python_callable = test,<br/>    dag = dag,<br/>)</span><span id="d70d" class="lm jv hi li b fi mm lo l lp lq">dummy_task  = DummyOperator(<br/>    task_id='dummy_task',<br/>    # retries=3,<br/>    dag = dag,<br/>)</span><span id="295a" class="lm jv hi li b fi mm lo l lp lq">get_stock_price = PythonOperator(<br/>    task_id = 'get_stock_price',<br/>    python_callable = get_asus_stock_price,<br/>    provide_context=True,<br/>    dag = dag,<br/>)</span><span id="3e54" class="lm jv hi li b fi mm lo l lp lq">insert_to_mongo=PythonOperator(<br/>    task_id='insert_to_mongo',<br/>    python_callable=insert_to_mongo,<br/>    dag=dag,<br/>)</span></pre><p id="251a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在上面提到get_stock_price和insert_to_mongo有依赖关系。在气流中，您可以设置下游和上游</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="5bbc" class="lm jv hi li b fi ln lo l lp lq">get_stock_price &gt;&gt; insert_to_mongo</span></pre><p id="79ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很简单，对吧？或者您可以使用另一种语法。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="cc7b" class="lm jv hi li b fi ln lo l lp lq">get_stock_price.set_downstream(insert_to_mongo)</span></pre><p id="2b49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用下游或上游来设置任何您想要的依赖关系。在气流中，它被称为<a class="ae jt" href="https://airflow.apache.org/docs/stable/concepts.html#relationship-builders" rel="noopener ugc nofollow" target="_blank">关系建立者</a>。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="d47e" class="ju jv hi bd jw jx ly jz ka kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr bi translated">结论</h1><p id="d737" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">这是一个小型概念验证，使用气流来运行我的爬虫，并控制/监视爬虫的整个数据流。与crontab不同，Airflow可以管理和调度离线作业，并且易于修改。当你需要管理大量的crontabs时，你会喜欢Airflow和其他类似的工具。</p><p id="6035" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下一篇文章中，我将展示如何用其他类似的工具来管理Hadoop作业，比如由<strong class="ih hj"> <em class="lg">网飞</em> </strong>提供的<em class="lg"> Apache Oozie </em>或<em class="lg"> Genie </em>。下次见。如果您有任何意见或问题，欢迎在下方留言，谢谢。</p></div></div>    
</body>
</html>