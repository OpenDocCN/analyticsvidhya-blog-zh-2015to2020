<html>
<head>
<title>Animating Soccer Transfer Fees with Python and Matplotlib</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python和Matplotlib制作足球转会费动画</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/animating-soccer-transfer-fees-with-python-and-matplotlib-ea1491999ef6?source=collection_archive---------14-----------------------#2020-02-16">https://medium.com/analytics-vidhya/animating-soccer-transfer-fees-with-python-and-matplotlib-ea1491999ef6?source=collection_archive---------14-----------------------#2020-02-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/9e1825cdd3f7818fead86024bf093f0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*aQxjwQg-NMDK6DrmjnY_Yw.gif"/></div></div></figure><p id="9a97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转会费是足球界永无休止的讨论，每年夏天都会带来更高的价格和更奢侈的交易。</p><p id="5233" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我决定用一个动画条形图，按照头寸分组，来形象化显示转会费随时间的增长。为此，我依赖于<a class="ae jo" href="https://matplotlib.org/index.html" rel="noopener ugc nofollow" target="_blank"> matplotlib </a>和<a class="ae jo" rel="noopener" href="/@6berardi/how-to-create-a-smooth-bar-chart-race-with-python-ad2daf6510dc"> Gabriel Berardi </a>和<a class="ae jo" href="https://towardsdatascience.com/bar-chart-race-in-python-with-matplotlib-8e687a5c8a41" rel="noopener" target="_blank"> Pratap Vardhan </a>的两篇非常有用的媒体文章。</p><p id="3297" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据是通过ewenme的git <a class="ae jo" href="https://github.com/ewenme/transfers" rel="noopener ugc nofollow" target="_blank"> repo </a>收集的，它最初是从<a class="ae jo" href="https://www.transfermarkt.co.uk/" rel="noopener ugc nofollow" target="_blank"> Transfermarkt </a>刮来的。首先，我合并了存储库中的各个数据集:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="141e" class="jy jz hi ju b fi ka kb l kc kd">mytemplist=[]</span><span id="9231" class="jy jz hi ju b fi ke kb l kc kd">#loop over folders in directory<br/>for folder in os.listdir(os.getcwd()):<br/>    if '.' in folder:<br/>        continue<br/>    <br/>    current_folder = os.getcwd() + '/' + folder<br/>    print(current_folder)<br/>    <br/>    #loop over file in folder and read csv<br/>    for file in os.listdir(current_folder):<br/>        print(os.getcwd() + '/' + folder + file)<br/>        df = pd.read_csv(os.getcwd() + '/' + folder + '/'+ file)<br/>        <br/>        mytemplist.append(df)<br/>        <br/>        print('done writing file: {}'.format(file))</span><span id="fdb7" class="jy jz hi ju b fi ke kb l kc kd">df = pd.concat(mytemplist)</span></pre><p id="bba8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第二步是通过将位置分组为四个主要位置来清理数据，删除重复的位置(保留球员加入球队的行——“in”，删除球员离开球队的行——“out”)，并创建一个包含球员姓名和球队名称的新变量(即“埃登·阿扎尔(皇马)”)。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="4bc6" class="jy jz hi ju b fi ka kb l kc kd">#group positions based on attack, mid, def, goalkeeper<br/>positions = [df['position'].isin(['Centre-Forward',<br/>                                  'Left Winger',<br/>                                  'Right Winger',<br/>                                  'Striker',<br/>                                  'Second Striker',<br/>                                  'Forward']),<br/>            (df['position'].isin(['Central Midfield',<br/>                                'Attacking Midfield',<br/>                                'Defensive Midfield',<br/>                                'Right Midfield',<br/>                                'Midfielder'])),<br/>             (df['position'] == 'Goalkeeper')]<br/>             <br/>generic_position = ['Attacker', 'Midfielder', 'Goalkeeper']</span><span id="abbd" class="jy jz hi ju b fi ke kb l kc kd">df['generic_position'] = np.select(positions, generic_position, default = 'Defender')</span><span id="69cc" class="jy jz hi ju b fi ke kb l kc kd"><br/>#drop players where fee_cleaned==NA<br/>df.dropna(subset = ['fee_cleaned'], inplace=True)</span><span id="38e1" class="jy jz hi ju b fi ke kb l kc kd">df = df[df['fee_cleaned'] &gt; 0.1]</span><span id="b0f8" class="jy jz hi ju b fi ke kb l kc kd">#keep only players with transfers "in" to club - not leaving (duplicates otherwise)<br/>df = df[df['transfer_movement'] == 'in']</span><span id="c677" class="jy jz hi ju b fi ke kb l kc kd">#make new variable: player_name + club_name<br/>df['player_name_club'] = df.apply(lambda x: str(x['player_name'] + ' (' + x['club_name'] + ')'), axis=1)</span></pre><p id="c210" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第三，我创建了一个新的数据框架(top_transfers)，其中保存了他们年度位置组合中前10名的球员行(即1999年后卫)。这使得数据集更小，更清晰，更容易查看。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="53e1" class="jy jz hi ju b fi ka kb l kc kd">#Get top 10 transfers for each year + position; sort by fee_cleaned, group by, and take top 10<br/>top_transfers = df.sort_values(by=['fee_cleaned'],ascending=False).groupby(['year','generic_position']).head(10)</span><span id="f659" class="jy jz hi ju b fi ke kb l kc kd">#keep necessary columns only<br/>top_transfers = top_transfers[['player_name_club', 'club_involved_name','fee_cleaned','year','generic_position']]</span><span id="81c1" class="jy jz hi ju b fi ke kb l kc kd">#Sort by year<br/>top_transfers = top_transfers.sort_values(by=['year'],ascending=True)</span></pre><p id="5116" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第四步是使用一个类似于R的<a class="ae jo" href="https://tidyr.tidyverse.org/reference/complete.html" rel="noopener ugc nofollow" target="_blank"> complete </a>函数(tidyr包)的函数，它在pandas中并不作为一个独立的函数存在，需要几行代码(这篇<a class="ae jo" href="https://stackoverflow.com/questions/40093971/pandas-dataframe-insert-fill-missing-rows-from-previous-dates" rel="noopener ugc nofollow" target="_blank"> stackoverflow </a>的帖子非常有用)。简而言之，这一步骤允许转会费(即恩戈洛·坎特在2016年转会切尔西)在2017年、2018年和2019年继续存在。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="c3a0" class="jy jz hi ju b fi ka kb l kc kd">#complete rows to keep player row after year of signing (i.e. player_x signed in 2018, keep player_x in 2019 data as well)<br/>#credit to: <a class="ae jo" href="https://stackoverflow.com/questions/40093971/pandas-dataframe-insert-fill-missing-rows-from-previous-dates" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/40093971/pandas-dataframe-insert-fill-missing-rows-from-previous-dates</a></span><span id="a650" class="jy jz hi ju b fi ke kb l kc kd">levels = ['year','player_name_club']<br/>full_idx = pd.MultiIndex.from_product([top_transfers[col].unique() for col in levels], names=levels)<br/>top_transfers_complete = top_transfers.set_index(levels).reindex(full_idx)</span><span id="4178" class="jy jz hi ju b fi ke kb l kc kd">top_transfers_complete = top_transfers_complete.groupby(level=['player_name_club']).ffill().reset_index()</span><span id="1055" class="jy jz hi ju b fi ke kb l kc kd">top_transfers_complete.fillna(0, inplace=True)</span></pre><p id="1cc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们的新数据集中查看N'Golo坎特，结果如下:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="2d30" class="jy jz hi ju b fi ka kb l kc kd">top_transfers_complete[top_transfers_complete['player_name_club'].str.contains('Kant')].tail(10)</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kf"><img src="../Images/389417a6e6dd6128577b85f7ab9bb3a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oe12-EqxR7_sgfEMaL3s6A.png"/></div></div></figure><p id="bf5e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如你在上面看到的，一旦转会发生(在这个例子中是在2016年)，我们的新数据框架包括一个用于每个年份和player_name_club组合的行。</p><p id="780f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于该项目的数据可视化方面，我创建了两个函数，这两个函数根据位置(守门员、后卫、中场、进攻者)创建条形图并将条形分成支线剧情。</p><p id="0913" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面显示的第一个函数使用matplotlib设计了一个单独的条形图，列出了前五名玩家的姓名和价格，以及年份和位置类型。下面的大部分代码纯粹是格式化。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="2ef2" class="jy jz hi ju b fi ka kb l kc kd">def draw_indiv_barchart(ax,df, position,year):<br/>    df = df[df.generic_position == position]<br/>    dff = df[df['year'].eq(year)].sort_values(by='fee_cleaned', <br/>                                              ascending=True).tail(5)<br/>    ax.clear()<br/>    ax.set_xlim([0, 250])<br/>    ax.set_xticks(np.arange(0, 250, 50))<br/>    ax.barh(dff['player_name_club'], dff['fee_cleaned'])<br/>    dx = dff['fee_cleaned'].max() / 200<br/>    <br/>    for i, (value, name) in enumerate(zip(dff['fee_cleaned'], dff['player_name_club'])):<br/>        ax.text(value + dx, i + 0.1, '    ' + name, color='#3b4463',size=16, weight=600, <br/>                ha='left', va='bottom', fontdict = {'fontname': 'Georgia'})<br/>        ax.text(value + dx, i - 0.1, '   £'+str(value)+'mil', size = 14, weight =200,<br/>                ha = 'left', va = 'center', fontdict = {'fontname': 'Georgia'})<br/>    ax.text(0, 1.09, '  £ (Millions)', transform=ax.transAxes, size=16, color='#777777')<br/>    ax.xaxis.set_major_formatter(ticker.StrMethodFormatter('{x:,.0f}'))<br/>    ax.xaxis.set_ticks_position('top')<br/>    ax.tick_params(axis='x', colors='#777777', labelsize=14)<br/>    ax.set_yticks([])<br/>    ax.margins(0, 0.01)<br/>    ax.grid(which='major', axis='x', linestyle='-')<br/>    ax.set_axisbelow(True)<br/>    ax.xaxis.set_ticks_position('top')<br/>    ax.spines['top'].set_visible(False)<br/>    ax.spines['right'].set_visible(False)<br/>    ax.spines['bottom'].set_visible(False)<br/>    ax.spines['left'].set_visible(False)    <br/>    plt.subplots_adjust(left = 0.075, right = 0.75, top = 0.825, bottom = 0.05, wspace = 0.2, hspace = 0.2)<br/>    plt.locator_params(axis = 'x', nbins = 12)<br/>    plt.box(False)</span></pre><p id="204b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第二个函数调用了第一个函数四次，在字典ax_dict上循环。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="6152" class="jy jz hi ju b fi ka kb l kc kd">ax_dict = {ax1: "Attacker",<br/>          ax2: "Midfielder",<br/>          ax3 : "Defender",<br/>          ax4: "Goalkeeper"}</span><span id="5d36" class="jy jz hi ju b fi ke kb l kc kd">def draw_subplots(year):<br/>    <br/>    for ax, position in ax_dict.items():<br/>        draw_indiv_barchart(ax,top_transfers_complete,position,year)<br/>        if ax == ax1:<br/>            ax.set_title(year, size=42, weight=600, ha='center',fontdict = {'fontname': 'Georgia'}, y = 1.1)<br/>        ax.set_ylabel(position, size = 22,fontdict = {'fontname': 'Georgia'})</span></pre><p id="86fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了可视化一年的数据(本例中为2019年)，运行了以下代码:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="acd6" class="jy jz hi ju b fi ka kb l kc kd">current_year=2019</span><span id="0b8b" class="jy jz hi ju b fi ke kb l kc kd">fig, (ax1, ax2,ax3,ax4) = plt.subplots(4,figsize=(22, 16))<br/>fig.suptitle('Most Expensive Soccer Transfers (1992-2019)', <br/>             ha='center', va='center', y= 0.9, x = 0.4,<br/>           fontsize=48, fontdict = {'fontname': 'Georgia'})<br/>ax1.set_ylabel('Attacker')<br/>fig.text(0.65, 0.02, 'Source: Transfermarkt', ha='right',fontsize=30,<br/>             bbox=dict(facecolor='white', alpha=0.8, edgecolor='white'),fontdict = {'fontname': 'Georgia'})</span><span id="ddac" class="jy jz hi ju b fi ke kb l kc kd"><br/>draw_subplots(year = current_year)</span></pre><p id="471e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">生成以下静态条形图:</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/9777c02f82401c9ba0655b7d1104d8e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SnX2HOaKuhB-6H4c7QBPPA.png"/></div></div></figure><p id="4c55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后一步是动画可视化，使用IPython的HTML函数和matplotlib的动画函数。页面顶部的gif是以fps = 2生成的，下面的是0.7，因此移动缓慢:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="2bdd" class="jy jz hi ju b fi ka kb l kc kd">animator = animation.FuncAnimation(fig, draw_subplots, frames=range(1992, 2020), interval = 600)<br/>HTML(animator.to_jshtml())</span><span id="f709" class="jy jz hi ju b fi ke kb l kc kd">animator.save('animation.gif', writer='imagemagick', fps = 2, bitrate = 1800)</span></pre><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/88b2c29b213c6605f0a5af711f2aa35e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ZWh-Bu0b5hwX-1ti7QATZQ.gif"/></div></div></figure><p id="0662" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是最终的可视化，显示了过去20年的良好上升趋势。</p><p id="e646" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里是完整的git库:<a class="ae jo" href="https://github.com/stefangouyet/transfers" rel="noopener ugc nofollow" target="_blank">https://github.com/stefangouyet/transfers</a></p><p id="f8cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文转载于:</p></div></div>    
</body>
</html>