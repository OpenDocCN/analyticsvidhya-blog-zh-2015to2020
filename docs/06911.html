<html>
<head>
<title>How to fine-tune BERT on text classification task?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在文本分类任务上微调BERT？</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-fine-tune-bert-on-text-classification-task-723f82786f61?source=collection_archive---------5-----------------------#2020-06-07">https://medium.com/analytics-vidhya/how-to-fine-tune-bert-on-text-classification-task-723f82786f61?source=collection_archive---------5-----------------------#2020-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a221886d1e0c91a48d343ee9c0e15438.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*x3vhaoJdGndvZqmL.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">来源:-<a class="ae iu" href="https://pytorch.org/tutorials/_images/bert.png" rel="noopener ugc nofollow" target="_blank">https://pytorch.org/tutorials/_images/bert.png</a></figcaption></figure><p id="82d6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">BERT(来自变形金刚的双向编码器表示)是Google在2016年的论文<strong class="ix hj"><em class="jt"/></strong><a class="ae iu" href="https://papers.nips.cc/paper/7181-attention-is-all-you-need.pdf" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj"><em class="jt">中发布的基于变形金刚的架构【注意就是你需要的全部</em></strong></a><strong class="ix hj"><em class="jt"/></strong>。BERT模型于2019年在论文中发表——“<a class="ae iu" href="https://arxiv.org/pdf/1810.04805.pdf" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj"><em class="jt">BERT:用于语言理解的深度双向变压器的预训练</em> </strong> </a> <strong class="ix hj"> <em class="jt">”。</em> </strong>发布时，在<a class="ae iu" href="https://gluebenchmark.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> <em class="jt">胶水基准</em> </strong> </a>上展示了最先进的成果。</p><h1 id="d30c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">介绍</h1><p id="33f8" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">首先，我将简单介绍一下Bert体系结构，然后将继续介绍如何使用is执行文本分类任务的代码。</p><p id="9543" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">BERT架构是在论文<a class="ae iu" href="https://arxiv.org/pdf/1810.04805.pdf" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> <em class="jt"> BERT:用于语言理解的深度双向变换器的预训练</em> </strong> </a>中描述的多层双向变换器编码器。</p><p id="198a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">本文提出了两种不同的体系结构。<strong class="ix hj"> BERT_base </strong>和<strong class="ix hj"> BERT_large。</strong><strong class="ix hj">BERT base</strong>架构有<strong class="ix hj"> L=12，H=768，A=12 </strong>，总共110M左右的参数。此处<strong class="ix hj"> L </strong>指变压器块数，<strong class="ix hj"> H </strong>指隐藏尺寸，<strong class="ix hj"> A </strong>指自关注头数。对于<strong class="ix hj">伯特大</strong>，<strong class="ix hj"> L=24，H=1024，A=16。</strong></p></div><div class="ab cl kx ky gp kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="hb hc hd he hf"><figure class="le lf lg lh fd ij er es paragraph-image"><div class="ab fe cl li"><img src="../Images/23d4243cb4c577b66d3ca502b38eb38d.png" data-original-src="https://miro.medium.com/v2/format:webp/0*m_kXt3uqZH9e7H4w.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">来源:-<a class="ae iu" href="https://www.kdnuggets.com/2018/12/bert-sota-nlp-model-explained.html" rel="noopener ugc nofollow" target="_blank">https://www . kdnugges . com/2018/12/Bert-sota-NLP-model-explained . html</a></figcaption></figure><p id="aee8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上图给出了BERT的输入格式。我不会在这方面讲太多细节。你可以参考上面的链接获得更详细的解释。</p><h1 id="62a6" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">源代码</h1><p id="a874" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">我将遵循的代码可以从下面的<strong class="ix hj"> HuggingFace的</strong> GitHub repo中克隆出来</p><blockquote class="lj"><p id="596a" class="lk ll hi bd lm ln lo lp lq lr ls js dx translated"><a class="ae iu" href="https://github.com/huggingface/transformers/" rel="noopener ugc nofollow" target="_blank">https://github.com/huggingface/transformers/</a></p></blockquote><h1 id="7bec" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf lt kh ki kj lu kl km kn lv kp kq kr bi translated">要使用的脚本</h1><p id="9c71" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">我们将主要修改和使用两个脚本来完成我们的文本分类任务。一个是<strong class="ix hj"><em class="jt">【glue.py】</em></strong>另一个是<strong class="ix hj"> <em class="jt"> run_glue.py. </em> </strong>文件glue . py路径是“<em class="jt">transformers/data/processors/”</em>文件run_glue.py可以在位置“<em class="jt">examples/text-class ification/”找到。</em></p><h1 id="eb5a" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">数据格式</h1><p id="ff26" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">数据的格式是这样的。第一列应该是id列。第二列应该是包含标签的列。第三列应该包含需要分类的文本。</p><pre class="le lf lg lh fd lw lx ly lz aw ma bi"><span id="5987" class="mb jv hi lx b fi mc md l me mf">data = pd.DataFrame()<br/>data['id'] = [i for i in range(num_text)]<br/>data['label'] = labels<br/>data['text'] = text</span></pre><p id="068b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里<em class="jt"> num_text </em>是要使用的数据点数，<em class="jt"> text </em>是要分类的实际查询，<em class="jt"> labels </em>是与其对应的文本相关联的标签。你应该把你的数据保存为没有标题的tsv 格式。</p><pre class="le lf lg lh fd lw lx ly lz aw ma bi"><span id="6a5d" class="mb jv hi lx b fi mc md l me mf">#if data is your training file <br/>data.to_csv('train.tsv', sep='\t', index=False, header=None)</span><span id="c4b3" class="mb jv hi lx b fi mg md l me mf"><br/>#if data is your validation file<br/>data.to_csv('dev.tsv', sep='\t', index=False, header=None)</span><span id="5077" class="mb jv hi lx b fi mg md l me mf"><br/>#if data is your test file<br/>data.to_csv('test.tsv', sep='\t', index=False, header=None)</span></pre><p id="1baa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在您的测试文件中，如果您愿意，您可以忽略标签列。我用它是因为它可以用来在预测后检查模型的性能。此外，可以根据个人的方便保留文件的名称。但是相应地，需要通过改变文件名来改变<em class="jt"> glue.py </em>文件。</p><h1 id="efcf" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">脚本中要做的更改</h1><h2 id="2e3d" class="mb jv hi bd jw mh mi mj ka mk ml mm ke jg mn mo ki jk mp mq km jo mr ms kq mt bi translated">glue.py</h2><blockquote class="mu mv mw"><p id="4108" class="iv iw jt ix b iy iz ja jb jc jd je jf mx jh ji jj my jl jm jn mz jp jq jr js hb bi translated">路径—变压器/数据/处理器/胶水. py</p></blockquote><figure class="le lf lg lh fd ij"><div class="bz dy l di"><div class="na nb l"/></div></figure><figure class="le lf lg lh fd ij"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="885c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">出于分类目的，可以选择这些任务中的一个——可乐、SST-2、MRPC、STS-B、QQP、MNLI、QNLI、RTE、WNLI。</p><p id="8dd6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将继续SST-2任务；其他任务也可以进行相同的更改。将要使用的类是-</p><p id="2390" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是需要进行的更改-</p><ol class=""><li id="25f3" class="nc nd hi ix b iy iz jc jd jg ne jk nf jo ng js nh ni nj nk bi translated">将函数<strong class="ix hj"> <em class="jt"> get_labels() </em> </strong>的返回列表从['0 '，' 1']更改为数据中的标签列表。</li><li id="3f00" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">在<strong class="ix hj"><em class="jt">_ create _ examples()</em></strong>函数中，修改-</li></ol><pre class="le lf lg lh fd lw lx ly lz aw ma bi"><span id="fc36" class="mb jv hi lx b fi mc md l me mf">text_a = line[text_index]</span><span id="fcb2" class="mb jv hi lx b fi mg md l me mf">⬇ ⬇ ⬇(to)</span><span id="1378" class="mb jv hi lx b fi mg md l me mf">text_a = line[-1]</span></pre><p id="952a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.在定义为<strong class="ix hj"> <em class="jt"> glue_task_num_labels的字典中，</em> </strong>将key<strong class="ix hj"><em class="jt">【SST-2】</em></strong>的值更改为数据中存在的num_labels。</p><h2 id="e41f" class="mb jv hi bd jw mh mi mj ka mk ml mm ke jg mn mo ki jk mp mq km jo mr ms kq mt bi translated">运行_glue.py</h2><blockquote class="mu mv mw"><p id="bf46" class="iv iw jt ix b iy iz ja jb jc jd je jf mx jh ji jj my jl jm jn mz jp jq jr js hb bi translated">path-examples/text-classification/run _ glue . py</p></blockquote><figure class="le lf lg lh fd ij"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="875b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更改该文件是可选的。如果您想将概率与预测一起保存，只需在该文件中进行更改。</p><p id="e0aa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可以通过保存预测数组来保存预测，该数组显示在文本文件中的上述代码中。</p><h1 id="30f9" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">如何运行脚本</h1><p id="6fe2" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">要运行该脚本，可以运行以下命令-</p><pre class="le lf lg lh fd lw lx ly lz aw ma bi"><span id="74f0" class="mb jv hi lx b fi mc md l me mf">python ./examples/text-classification/run_glue.py \<br/>    --model_name_or_path bert-base-uncased \<br/>    --task_name $TASK_NAME \<br/>    --do_train \<br/>    --do_eval \<br/>    --data_dir $GLUE_DIR/$TASK_NAME \<br/>    --max_seq_length 128 \<br/>    --per_device_eval_batch_size=8   \<br/>    --per_device_train_batch_size=8   \<br/>    --learning_rate 2e-5 \<br/>    --num_train_epochs 3.0 \<br/>    --output_dir /tmp/$TASK_NAME/</span></pre><p id="4a6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我会一个一个解释所有的参数-</p><ol class=""><li id="ce5a" class="nc nd hi ix b iy iz jc jd jg ne jk nf jo ng js nh ni nj nk bi translated">-模型名称或路径-此参数指定要使用的BERT模型类型。</li><li id="3f94" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">—任务名称—指定我们要使用的粘合任务。可以使用可乐、SST-2、MRPC、STS-B、QQP、MNLI、QNLI、RTE、WNLI中的一种。</li><li id="3d3f" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">do _ train指定是否要微调模型。如果要使用预训练模型，只需移除此参数。</li><li id="37ca" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">— do_eval —如果要执行验证</li><li id="83d3" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">— do_predict —如果要对测试数据生成预测。</li><li id="3b58" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">—数据目录—需要保存训练、验证和测试数据的目录路径。</li><li id="4a39" class="nc nd hi ix b iy nl jc nm jg nn jk no jo np js nh ni nj nk bi translated">output _ dir要保存预测和其他生成文件的目录路径。</li></ol><p id="cacd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我认为所有其他参数从它们的名字就很明显。另一个可以使用的设置是-</p><ul class=""><li id="4b29" class="nc nd hi ix b iy iz jc jd jg ne jk nf jo ng js nq ni nj nk bi translated">— save_total_limit =指定要保存多少个检查点目录。</li></ul><p id="6d2a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所有这些都足以在文本分类任务上微调BERT。</p><p id="2bf9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这次都是我这边的。我希望这篇博文能帮助你完成指定的任务。</p></div></div>    
</body>
</html>