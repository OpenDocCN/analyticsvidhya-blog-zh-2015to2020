<html>
<head>
<title>Cohort Analysis: From SQL to Plotly visualization</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">群组分析:从SQL到Plotly可视化</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/cohort-analysis-95a794b4e58c?source=collection_archive---------6-----------------------#2019-12-16">https://medium.com/analytics-vidhya/cohort-analysis-95a794b4e58c?source=collection_archive---------6-----------------------#2019-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><h2 id="7650" class="hg hh hi bd b fp hj hk hl hm hn ho dx hp translated" aria-label="kicker paragraph">从头开始构建交互式群组表</h2><div class=""/><figure class="ev ex ip iq ir is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es io"><img src="../Images/df7bbd472232bcd190820a78d67d6d87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gpPUS_5aRGHAaToV"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">马库斯·斯皮斯克在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="c27c" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="4fe5" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">群组分析的温和方法，它的目的，它看起来如何以及如何建立它。代码可以在我的<a class="ae jd" href="https://github.com/IsmaelMasharo/behavioral-analytics/tree/master/cohort-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到，作为独立的脚本。外卖是用Plotly制作的可定制<a class="ae jd" href="https://plot.ly/~masharo/20/#/" rel="noopener ugc nofollow" target="_blank">队列表</a>。</p></div><div class="ab cl la lb gp lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="hb hc hd he hf"><h2 id="cd74" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">把我们自己放在环境中</h2><p id="6293" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">想象一个电子商务平台。它提供服务。用户开始注册。他们中的一些人频繁互动，一些人在一两个月后离开。我们如何总结这种行为？我们可以执行哪种报告来从收集的数据中获取价值？这就是群组分析的意义所在。</p><h2 id="26df" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">什么是队列？</h2><p id="bd44" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">这是一个和一个有着共同特征的人。再说一遍？以这群蓝色的学生为例:</p><figure class="lz ma mb mc fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es ly"><img src="../Images/0384ba2bf54d68edddae0a3f478f0403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jUxKTG-9EMSaIS4PYkQ4cg.png"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">米凯尔·克里斯滕森在<a class="ae jd" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="416b" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">想象一下他们都是2018年毕业的。这个团体就是<code class="du lu lv lw lx b">cohort</code>。都是共享毕业年份。</p><h2 id="1713" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">好吧，那么什么是队列分析？</h2><p id="4d13" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">它是对在给定时期聚集的这些个人的分析，他们与服务交互的频率以及这些交互如何随时间变化。</p><p id="b3a5" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">在一个更正式的定义中，它是在<a class="ae jd" href="https://en.wikipedia.org/wiki/Behavioral_analytics" rel="noopener ugc nofollow" target="_blank">行为分析</a>中使用的现有机制之一，用于识别客户保留的趋势及其与给定服务(比如我们的电子商务网站)的交互和演变。</p><h2 id="8cf7" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">它回答了什么问题？</h2><p id="0645" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">让我们考虑用户<code class="du lu lv lw lx b">registration date</code>和用于聚类用户的<code class="du lu lv lw lx b">monthly time frame</code>。问题如下:</p><ul class=""><li id="58c1" class="mi mj hi ke b kf md kj me kn mk kr ml kv mm kz mn mo mp mq bi translated"><strong class="ke hs">在Y月注册的用户在X个月后仍然活跃的比例是多少？</strong></li></ul><p id="b2a5" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">这里的<code class="du lu lv lw lx b">users registered in month Y</code>是一个<code class="du lu lv lw lx b">Cohort</code>。<code class="du lu lv lw lx b">X months after</code>对其行为进行分析，对其进行登记。</p><ul class=""><li id="dcec" class="mi mj hi ke b kf md kj me kn mk kr ml kv mm kz mn mo mp mq bi translated"><strong class="ke hs">不同群组的用户互动有何不同？</strong></li></ul><p id="c0c6" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">第一个问题分析的是<code class="du lu lv lw lx b">one cohort and its evolution over time</code>，这里我们关注的是<code class="du lu lv lw lx b">how do different cohorts are compared to one another</code>。</p><h2 id="d020" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">输出是什么，看起来怎么样？</h2><p id="9453" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">分析结果被总结为<code class="du lu lv lw lx b">Cohort Table</code>。</p><figure class="lz ma mb mc fd is er es paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="er es mr"><img src="../Images/914766e74ec8d4f054bcbe9c091c2b2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mMICHHAUHGvPskiA8g118Q.png"/></div></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">2018年用户活动月度队列表。用<a class="ae jd" href="https://plot.ly/" rel="noopener ugc nofollow" target="_blank">精心打造</a>。</figcaption></figure><p id="25e4" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">横轴代表独立组群随时间的演变，而纵轴比较它们之间的差异。</p><p id="5636" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">每个单元格中的值是给定<code class="du lu lv lw lx b">cohort month vs numbers of months ahead</code>交叉点中活动用户的百分比。这就是所谓的<em class="ms">用户留存百分比</em>。</p><p id="477d" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">让我们再深入一点。</p><h2 id="afa9" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">如何解读这份报告？</h2><p id="1042" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">在我们的例子中，我们将采用上面图中的值。我们再来考虑一下1月和2月的注册用户数分别为<a class="ae jd" href="#aad2" rel="noopener ugc nofollow"> 450和1010</a>。</p><p id="cd2b" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">然后，分析一月份的队列，故事将是:</p><blockquote class="mt"><p id="8eed" class="mu mv hi bd mw mx my mz na nb nc kz dx translated">从1月份注册的用户来看，我们有24.89%的用户保留率，其中只有112人进行了互动。注册五个月后，只有39家(8.67%)仍然活跃。</p></blockquote><p id="eb60" class="pw-post-body-paragraph kc kd hi ke b kf nd kh ki kj ne kl km kn nf kp kq kr ng kt ku kv nh kx ky kz hb bi translated">问题是关于什么的？我们想知道一组用户如何与我们的平台交互，不仅如此，还要知道这些交互的演变。</p><p id="5f69" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">现在让我们比较一下一月和二月的队列:</p><blockquote class="mt"><p id="a9ae" class="mu mv hi bd mw mx my mz na nb nc kz dx translated"><em class="ni">看一下每个群组中活跃用户的百分比，我们可以看到留存率增加了11 %, 1月份450名活跃用户中有112名，而下个月1010名活跃用户中有363名。</em></p></blockquote><p id="912a" class="pw-post-body-paragraph kc kd hi ke b kf nd kh ki kj ne kl km kn nf kp kq kr ng kt ku kv nh kx ky kz hb bi translated">我们在这里看到了什么？两个不同的群体是如何彼此不同的。</p><h1 id="9dcd" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">变得有点技术化</h1><p id="cac6" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">我们已经讨论了队列分析的一些主要概念。现在，让我们简单谈谈如何构建这样一个报告。</p><h2 id="4799" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">我从哪里获得数据？它可能存储在数据库中</h2><p id="468e" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">分析的来源将是具有以下模式的数据库模型:</p><figure class="lz ma mb mc fd is"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="3a40" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">这里，<code class="du lu lv lw lx b">user</code>保存注册用户的信息，而<code class="du lu lv lw lx b">interaction</code>记录不同的用户交互以及它们执行的日期。</p><h2 id="aad2" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">几乎是一个队列表</h2><p id="4745" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">直接通过查询数据库来构建队列表将是一项艰巨的任务。因此，我们将首先从模式转到如下内容:</p><figure class="lz ma mb mc fd is"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="034c" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">然后，我们可以使用Excel或Tableau之类的数据操作工具来执行最终调整，并获得群组表。我已经用<a class="ae jd" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">熊猫</a>完成了这个任务。</p><p id="519f" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">让我们检查上面的列:</p><ul class=""><li id="98e4" class="mi mj hi ke b kf md kj me kn mk kr ml kv mm kz mn mo mp mq bi translated"><code class="du lu lv lw lx b">cohort month</code>相当于<code class="du lu lv lw lx b">Y</code>变量(每月分析的用户),<code class="du lu lv lw lx b">number of months ahead</code>相当于<code class="du lu lv lw lx b">X</code>变量(给定月数后的发展)。</li><li id="a181" class="mi mj hi ke b kf nl kj nm kn nn kr no kv np kz mn mo mp mq bi translated"><code class="du lu lv lw lx b">total user</code>在给定月份具有相同的值，因为它是该群组中分析的用户数量。</li><li id="900b" class="mi mj hi ke b kf nl kj nm kn nn kr no kv np kz mn mo mp mq bi translated"><code class="du lu lv lw lx b">retention percentage</code>的值是我们想要从分析中得到的。</li></ul><h2 id="efd4" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">SQL您最亲密的盟友</h2><p id="e0b8" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">正如我们所看到的，要开始构建我们的群组表，我们需要在数据库上执行一些聚合和分组。解释构建这样一个查询的过程会偏离这篇文章的目的。更多细节请查看Holistycs的<a class="ae jd" href="https://www.holistics.io/blog/calculate-cohort-retention-analysis-with-sql/" rel="noopener ugc nofollow" target="_blank">这篇很棒的文章</a>，在那里他们详细描述了这些步骤。</p><p id="af91" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">下面是我们从中获取汇总表的查询:</p><figure class="lz ma mb mc fd is"><div class="bz dy l di"><div class="nj nk l"/></div></figure><h2 id="dc04" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">让群组表格互动</h2><p id="ad9f" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">SQL查询返回一些我们可以轻松处理的内容。但是想象一下有几十个群组，那么每个群组都有几十个值。现在不太好办了。</p><p id="2971" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">幸运的是，我们可以使用一些非常简洁的工具来处理数据。我使用了<a class="ae jd" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank"> pandas </a>来合并、堆叠和整形从SQL获得的表。你可以看一下<a class="ae jd" href="https://github.com/IsmaelMasharo/behavioral-analytics/blob/master/cohort-analysis/cohort_analisis.ipynb" rel="noopener ugc nofollow" target="_blank">代码</a>并用你自己的数据做实验。这是最终表格的样子:</p><figure class="lz ma mb mc fd is"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="c609" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated"><code class="du lu lv lw lx b">This is the actual Cohort Table</code>。它看起来很好，但如果我们能与它互动，它会更好。这就是<a class="ae jd" href="https://plot.ly/" rel="noopener ugc nofollow" target="_blank">plottly</a>闪耀的地方，将表格显示为一个交互的情节。然后，您可以自定义悬停时显示的内容、颜色渐变、图例，并将其嵌入到您的站点中，等等。同样，你可以查看<a class="ae jd" href="https://github.com/IsmaelMasharo/behavioral-analytics/blob/master/cohort-analysis/cohort_analisis.ipynb" rel="noopener ugc nofollow" target="_blank">代码</a>来了解构建它的步骤。</p><p id="43c3" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">这是最终的视觉效果:</p><figure class="lz ma mb mc fd is"><div class="bz dy l di"><div class="nq nk l"/></div><figcaption class="iz ja et er es jb jc bd b be z dx translated">互动队列表由<a class="ae jd" href="https://plot.ly/online-chart-maker/" rel="noopener ugc nofollow" target="_blank">图表工作室</a>提供。</figcaption></figure><h2 id="5d8e" class="lh jf hi bd jg li lj lk jk ll lm ln jo kn lo lp js kr lq lr jw kv ls lt ka ho bi translated">最终想法</h2><p id="b639" class="pw-post-body-paragraph kc kd hi ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz hb bi translated">记住<code class="du lu lv lw lx b">cohort analysis is a tool</code>开始解决其他有趣的问题，比如<strong class="ke hs">为什么会这样？</strong> <strong class="ke hs">我们该怎么办？我们如何从中获利？</strong>这样，您可以继续进行更丰富的分析。</p><p id="eaa1" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">这是我的第一篇帖子！希望你觉得有用。</p><p id="01e9" class="pw-post-body-paragraph kc kd hi ke b kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv mh kx ky kz hb bi translated">开心分析！</p></div></div>    
</body>
</html>