<html>
<head>
<title>Hyperparameter Tuning with Kubeflow Katib</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubeflow Katib进行超参数调谐</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/hyperparameter-tuning-with-kubeflow-katib-148d92208d73?source=collection_archive---------4-----------------------#2019-09-16">https://medium.com/analytics-vidhya/hyperparameter-tuning-with-kubeflow-katib-148d92208d73?source=collection_archive---------4-----------------------#2019-09-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/27234512cfc661ce4d8ce33031f128dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YnuKtQmT0zetNamlf5QFlw.png"/></div></div></figure><div class=""/><h1 id="e2e0" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">介绍</h1><p id="762c" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">Katib是Kubeflow附带的一个工具，专门用于超参数调整。Kubeflow是相当新的，Katib也是。同时，还有很多其他的超参数调优框架。那么，为什么要为卡提卜费心呢？</p><p id="e80b" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">对我来说，使用Katib进行超参数调优的最大优势是它通过Kubeflow与Kubernetes (K8s)的直接集成。这提供了一些优势:</p><h2 id="6fd3" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">A.享受K8s的可扩展性</h2><p id="9768" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">如果训练模型很慢，超参数调整会慢10到100倍。K8s的水平可伸缩性意味着您可以并行训练任意数量的模型<strong class="jq hu"/>。这完全由Katib管理，包括超参数生成和指标收集。</p><h2 id="98c4" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">B.将调整后的模型直接部署到K8s</h2><p id="e517" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">虽然我们不会在本文中讨论如何将模型部署到K8s，但您可能会意识到，越来越多的机器学习模型部署在K8s中用于生产。它们享有高可用性、自动可伸缩性、模型滚动更新以及比单个web服务器更多的优势。</p><p id="2063" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">像<a class="ae lf" href="https://www.seldon.io/" rel="noopener ugc nofollow" target="_blank">塞尔顿</a>或<a class="ae lf" href="https://github.com/kubeflow/fairing" rel="noopener ugc nofollow" target="_blank">库伯弗洛整流罩</a>这样的框架简化了机器学习工程师将模型部署到K8s的工作。作为Kubeflow生态系统的一部分，Katib可以确保您的模型可以轻松地部署到K8s。</p><h2 id="b81e" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">C.Katib的其他一些特性</h2><ol class=""><li id="c903" class="lg lh ht jq b jr js jv jw jz li kd lj kh lk kl ll lm ln lo bi translated">足够通用，任何包装成Docker容器的模型都可以使用。</li><li id="3ff9" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated"><strong class="jq hu">可抢占实例(GCP) /现场实例(AWS)可用于</strong>大幅削减基础设施成本。K8s的自动可伸缩性意味着您只需为您花费的计算能力付费。</li><li id="1cec" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated"><strong class="jq hu">用于结果管理和可视化的基本UI </strong>。通过对研究配置文件和Docker容器图像进行版本控制，<strong class="jq hu">结果可重现并得到管理</strong>。</li><li id="7097" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated"><strong class="jq hu">一些预先构建的算法</strong>，从随机抽样到强化学习方法来调整超参数。</li></ol><h1 id="9f4f" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">设置Kubeflow Katib(一次性)</h1><h2 id="b205" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">A.设置Kubeflow</h2><p id="f6b1" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">本文假设你已经安装了Kubeflow的K8s设置，否则你应该按照Kubeflow的<a class="ae lf" href="https://www.kubeflow.org/docs/started/" rel="noopener ugc nofollow" target="_blank">官方文档</a>来设置一个。确保您的“kubectl”命令行设置正确。</p><h2 id="4faa" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">B.设置K8s节点池</h2><p id="e71b" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">Kubeflow在K8s上运行后，下一件事就是创建一个节点池来运行超参数调优作业。下面我们以GCP为例来说明如何做到这一点。</p><ol class=""><li id="f073" class="lg lh ht jq b jr km jv kn jz lu kd lv kh lw kl ll lm ln lo bi translated">在Kubernetes引擎中，找到您的Kubeflow K8s集群。选择“添加节点池”</li></ol><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lx"><img src="../Images/80da592acd847c92f8d1f1a3dc7562a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J0LanTskaBQS6OPoQATlsg.png"/></div></div></figure><p id="a615" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">2.为您的节点池命名，我们稍后会用到它。启用自动缩放，选择最小值0和最大值100。“节点数”填写0。</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div class="er es mc"><img src="../Images/4f1e8a0818ced1ef9981ea1975a9a80e.png" data-original-src="https://miro.medium.com/v2/resize:fit:962/format:webp/1*WLJwN-LT-LtxZvZCRkIfgw.png"/></div></figure><p id="9f0e" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">3.选择您喜欢的机器类型，选择“启用可抢占节点(测试版)”以使用可抢占实例来降低成本。</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div class="er es md"><img src="../Images/016586f5d829d37d57539bb79287d875.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*jAE4yO1o-kbcbAjcoZ_d8g.png"/></div></figure><p id="cb5d" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">4.保存您的配置。您应该看到您的节点池出现在K8s面板中。</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es me"><img src="../Images/1a1bcfdf853bb53c2550308453e3f326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qpGTj-C_RU42RK7BgJB9yA.png"/></div></div></figure><h1 id="636d" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">使用Katib</h1><h2 id="0595" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">A.Katib仪表板</h2><p id="1217" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">您可以从Kubeflow的下拉菜单中访问Katib仪表板。以下是我的仪表板示例，其中包括2项研究。</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mf"><img src="../Images/e363e66dd8a6380d56ebca5dac276349.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EL_GVAUxzxNj8Bpiphmgag.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx translated">显示两项研究和多项研究工作的Katib仪表板。</figcaption></figure><p id="1968" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">一个<strong class="jq hu">研究</strong>是一个<strong class="jq hu">研究工作</strong>的集合。</p><p id="809c" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">每项研究工作都是一系列跑步的集合。例如，一项研究工作可能包含50次运行的指标和50组不同的超参数。</p><h2 id="29a4" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">B.准备一个Docker图像</h2><p id="206f" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">Katib支持任何类型的机器学习模型，满足以下要求:</p><ol class=""><li id="742e" class="lg lh ht jq b jr km jv kn jz lu kd lv kh lw kl ll lm ln lo bi translated">作为Docker映像构建并上传到K8s可访问的地方，</li><li id="85e5" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated">以超参数为自变量，如<em class="mk"> "— epochs=10" </em>，"<em class="mk"> — rl=0.5" </em></li><li id="8ecc" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated">以“<em class="mk">metric</em>=<em class="mk">metric _ value”的格式将指标打印到标准输出。</em></li></ol><p id="8de8" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我个人偏好使用<a class="ae lf" href="https://github.com/openshift/source-to-image" rel="noopener ugc nofollow" target="_blank"> s2i </a>，它可以将Python包直接转换成Docker映像。因此，我的构建脚本只包含三行代码，用于构建、标记和推送图像:</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="ed8b" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">我的Docker映像可通过命令“python -u train.py <arguments> <hyperparameters>”执行，以进行训练和打印指标。</hyperparameters></arguments></p><h2 id="b800" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">C.创建研究工作</h2><p id="2e8e" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">您可以参考Katib仪表板用户界面来创建新的研究。我个人觉得直接应用K8s配置要简单得多。以下是创建研究工作配置的模板。</p><figure class="ly lz ma mb fd hk"><div class="bz dy l di"><div class="ml mm l"/></div></figure><ol class=""><li id="753d" class="lg lh ht jq b jr km jv kn jz lu kd lv kh lw kl ll lm ln lo bi translated">分别填写<strong class="jq hu">元数据.名称</strong>、<strong class="jq hu">特定研究名称</strong>和<strong class="jq hu">特定所有者</strong>作为您的研究工作标识符、您的研究标识符和您的姓名。</li><li id="b31a" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated">spec.objectvievaluename 是Katib要收集的主要客观指标。其他指标可在<strong class="jq hu">规格指标名称</strong>中指定，以便交叉检查。确保您的程序将这些指标以"<em class="mk">metric</em>=<em class="mk">metric _ value "</em>的格式打印到stdout</li><li id="2570" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated"><strong class="jq hu"> spec.parameterconfigs </strong>让您指定超参数的范围，采样的超参数将以<em class="mk"> " —超参数=超参数值"</em>的形式传入您的程序。</li><li id="23ef" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated"><strong class="jq hu">spec . workers pec . gotemplate . raw template</strong>是实际要运行的作业。确保填写上传的图像和要执行的命令。请注意，采样的超参数由Katib注入到命令中。<br/>此外，您可以通过<strong class="jq hu"> nodeSelector </strong>属性指定哪个节点池来执行您的作业。</li><li id="bd4c" class="lg lh ht jq b jr lp jv lq jz lr kd ls kh lt kl ll lm ln lo bi translated"><strong class="jq hu"> spec.suggestionSpec </strong>让您指定选择超参数的策略。在本例中，我们选择了最简单的随机抽样策略，并行执行10次运行。只要您的节点池支持，您可以并行调度更多作业。就我个人而言，我安排了100个任务并行训练一个相对庞大的模型，没有任何问题。Katib支持其他策略，如<em class="mk">网格搜索</em>、<em class="mk">超带</em>、<em class="mk">贝叶斯优化</em>等等。更多信息请参考<a class="ae lf" href="https://github.com/kubeflow/katib/tree/master/examples/v1alpha2" rel="noopener ugc nofollow" target="_blank">示例配置yaml </a>。</li></ol><p id="cb1f" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">创建配置yaml后，<strong class="jq hu">只需执行“ku bectl apply-f study _ job . YAML”</strong>即可开始超参数调优！您可以随时使用“kubectl delete -f study_job.yaml”删除并重新运行研究作业。</p><h2 id="a8f0" class="kr ir ht bd is ks kt ku iw kv kw kx ja jz ky kz je kd la lb ji kh lc ld jm le bi translated">D.检查结果</h2><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mn"><img src="../Images/48f20f4c419a1dfbcb12ec1b655069b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ywdY_jlw1ruc-talTV7HWw.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx translated">学习工作结果的典型截图。</figcaption></figure><p id="0d16" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">上面显示了一个典型的研究工作结果截图。每行代表一次运行的配置及其指标。</p><p id="4131" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">您甚至可以通过限制沿着每个度量轴的运行来做一些基本的分析。例如，下图显示，对于我的模型，高IoU指标的运行通常使用骰子损失。</p><figure class="ly lz ma mb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mo"><img src="../Images/a588b04a20cbd2ba2ed02e81349e5ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vkv409N2Y2UAhlvbqNje7Q.png"/></div></div><figcaption class="mg mh et er es mi mj bd b be z dx translated">通过仅显示具有高IoU的运行进行分析。</figcaption></figure><h1 id="f662" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">结论</h1><p id="8ce1" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在本文中，我们介绍了通过Kubeflow的Katib工具在K8s上进行超参数调优的动机。我们首次展示了如何设置Katib，如何将模型包装到Docker映像中，以及如何应用研究作业配置yaml来调整超参数。您还可以通过Katib的用户界面进行基本分析，以深入了解超参数选择。</p><p id="16ab" class="pw-post-body-paragraph jo jp ht jq b jr km jt ju jv kn jx jy jz ko kb kc kd kp kf kg kh kq kj kk kl hb bi translated">本文旨在为您提供一个快速入门指南，帮助您建立一个高效的超参数调优解决方案。你可能会发现这篇文章遗漏了一些细节，如果有任何问题，请随时给我留言。</p></div></div>    
</body>
</html>