<html>
<head>
<title>Analysing Non-Tabular Data, Transitioning from SQL to NoSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分析非表格数据，从SQL过渡到NoSQL</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/sql-to-nosql-4dd15ab121b0?source=collection_archive---------0-----------------------#2018-11-06">https://medium.com/analytics-vidhya/sql-to-nosql-4dd15ab121b0?source=collection_archive---------0-----------------------#2018-11-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="8fb8" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">开始在MongoDB上编写查询，只知道SQL</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/8a03f5477a1bcf889a342601e95cf5b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*cHYLDJN_mHB1MTojdfZBVw.png"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated"><em class="jj">Image via[</em>]T2<em class="jj">https://www . holistics . io</em><em class="jj">]</em></figcaption></figure><p id="75aa" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">几乎每个数据科学发烧友都听说过<a class="ae jk" href="https://obamawhitehouse.archives.gov/blog/2015/02/18/white-house-names-dr-dj-patil-first-us-chief-data-scientist" rel="noopener ugc nofollow" target="_blank">DJ Patil博士</a>。他是美国白宫前首席数据科学家；像任何其他职业一样，我也很兴奋知道&amp;跟随他的工作。去年我有机会在现场见到他，这让我对数据科学应用的思考有了一个新的视角。更令人兴奋的是，帕蒂尔博士<a class="ae jk" href="https://www.youtube.com/watch?v=9UNVZXNdvXE" rel="noopener ugc nofollow" target="_blank">强调了</a>技术创新&amp;数据科学如何帮助制造颠覆&amp;提升全球医疗保健水平。</p><p id="1689" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">医疗保健就是这样一个领域，整个行业都可以从电子病历的使用中受益，从而提高医疗保健的质量，同时降低成本。该行业面临的主要挑战之一是各种来源的数据不标准化，这使得医疗系统之间的<a class="ae jk" href="https://www.forbes.com/sites/forbestechcouncil/2018/05/31/the-state-of-interoperability-in-healthcare/" rel="noopener ugc nofollow" target="_blank">互操作性</a>本身就是一项艰巨的任务。随着技术的进步每天都在发生，我强烈地感到这个领域是可以解决的。接下来的帖子是我在这方面的小小努力。它涵盖了一些在解决用例时会派上用场的技能/技术知识。</p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="3afc" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated">我们从哪里开始？</h1><p id="01f8" class="pw-post-body-paragraph jl jm hi jn b jo lg ij jq jr lh im jt ju li jw jx jy lj ka kb kc lk ke kf kg hb bi translated"><em class="ll">非结构化数据</em></p><p id="63a8" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">数据大致可以分为两类，即结构化数据和非结构化数据。非结构化数据的一个非常幼稚的定义是任何不能放入传统的行-列或表格数据库的数据。非结构化数据的常见示例有基于文本或文档的数据、网络或图形数据、图像数据、视频数据、音频数据、基于网络的日志、传感器数据等。</p><p id="8a12" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">事实证明，在过去的几年里，数据量一直以指数级的速度增长。截至2018年，每天生成的数据量是数据库云服务器(100万兆兆字节)的倍数。这一指数级增长主要归功于全球互联网用户和物联网设备的增加。有趣的是，这一数据量的激增主要是非结构化数据造成的，根据专家的说法，这超过了生成的整个数据的80–85%。</p><p id="e404" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll">这种引入的想法是医疗保健数据的主要部分以非结构化格式存储，无论是图像、身体扫描还是患者症状等。</em></p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lm"><img src="../Images/53c2523ef8fd04a75207d8300ebc3d34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8UYfdvbXbdoUdp2S97U2A.jpeg"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">来源:帕特里克·切斯曼</figcaption></figure><h2 id="2b44" class="lr kp hi bd kq ls lt lu ku lv lw lx ky ju ly lz la jy ma mb lc kc mc md le me bi translated"><strong class="ak"> <em class="jj">好了，我明白了，非结构化数据已经够大了，但是接下来呢？</em> </strong></h2><p id="ebaa" class="pw-post-body-paragraph jl jm hi jn b jo lg ij jq jr lh im jt ju li jw jx jy lj ka kb kc lk ke kf kg hb bi translated"><em class="ll">半结构化数据来拯救我们</em></p><p id="e576" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">随着如此多的发展，第三类数据也在不断发展。这种新类型被称为半结构化数据。为了理解这意味着什么，钻研一下历史是很重要的。根据Gartner &amp; PwC的独立研究，据说尽管数据量有了巨大的增长，但业务/企业仍然无法利用存储的全部数据并从中产生价值。这本身可能听起来非常反直觉，但同样的主要原因是难以从可用的数据集利用价值。</p><p id="28cf" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">这让我们明白，尽管非结构化数据有着非常光明的未来，并且可能使用数据科学技术创造巨大的价值，但将数据转化为见解的过程需要简化。这是半结构化数据的核心，其中非结构化数据被转换，因此数据访问和分析变得不那么麻烦。半结构化数据的常见例子是基于文档的数据(<em class="ll">转换为键值对象</em>)或图像数据(<em class="ll">转换为向量</em>)或像XML或JSON这样的数据格式，它们构成了当今大多数基于web的应用程序的基础。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mf"><img src="../Images/f0003252f39d77fbd3966f37dfe82997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ml3Q52J9GczdjvN0NYNe8g.jpeg"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">图片来自[<a class="ae jk" href="https://memegenerator.net/" rel="noopener ugc nofollow" target="_blank">https://memegenerator.net/</a></figcaption></figure><p id="9a02" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll">我们将介绍如何分析MongoDB上以JSON格式存储的数据。</em></p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="0330" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated"><strong class="ak">MongoDB简介</strong></h1><p id="e114" class="pw-post-body-paragraph jl jm hi jn b jo lg ij jq jr lh im jt ju li jw jx jy lj ka kb kc lk ke kf kg hb bi translated">MongoDB是技术领域中可用的开源文档数据库之一，也就是说它不是唯一可用的数据库。MongoDB中的每条记录都是一个文档。文档类似于数据记录，而集合类似于RDBMS中的表。MongoDB上加载的数据通常是JSON/BSON格式，用简单的语言来说就是CSV/SQL数据转储的非关系版本。</p><p id="2a9f" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">要快速浏览MongoDB和文档数据库，请参考<a class="ae jk" href="https://slideplayer.com/slide/9859102/" rel="noopener ugc nofollow" target="_blank">这个</a>资源。该数据集是来自<a class="ae jk" href="https://open.fda.gov/tools/downloads/" rel="noopener ugc nofollow" target="_blank"> FDA </a>的药物数据的开源版本。一个更小的版本是JSON(<em class="ll">Java Script Object Notation</em>)格式<a class="ae jk" href="https://github.com/navneetgupta91/medium/blob/master/sql_to_nosql/FDADrugLabel.json" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mg"><img src="../Images/c93c80fbdf574af77befe5df532b047a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*h4xUAUmm_FLJCS9Ey6eKAQ.jpeg"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">图片via[<a class="ae jk" href="https://pixabay.com/en/pill-capsule-medicine-medical-1884775/" rel="noopener ugc nofollow" target="_blank">https://pix abay . com/en/pill-capsule-medicine-medical-1884775/</a>]</figcaption></figure><p id="db0c" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll">请注意，用MongoDB编写的所有查询都没有使用map reduce概念，只是SQL的MongoDB等价物。</em></p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="d0d1" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated">编写查询—第1部分</h1><p id="26a4" class="pw-post-body-paragraph jl jm hi jn b jo lg ij jq jr lh im jt ju li jw jx jy lj ka kb kc lk ke kf kg hb bi translated">在这一节中，我将浏览一些例子，这些例子为SQL和MongoDB查询提供了一对一的例子(<em class="ll">以同样的顺序</em>)。第1部分只有非聚集查询。</p><p id="265f" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 1。从表/集合中获取所有记录</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="0a9b" class="lr kp hi mi b fi mm mn l mo mp">select * from FDADrugLabel;</span><span id="7815" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({});</span></pre><p id="894d" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 2。获取表格/集合中记录/文档的数量</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="bec9" class="lr kp hi mi b fi mm mn l mo mp">select count(*) from FDADrugLabel;</span><span id="2b23" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({})<br/>    .count();</span></pre><p id="9295" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 3。从表/集合中获取前“n”条记录</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="ee5b" class="lr kp hi mi b fi mm mn l mo mp">select * from FDADrugLabel<br/>limit 10;</span><span id="90ae" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({})<br/>    .limit(10);</span></pre><p id="6bac" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 4。使用一列/字段排序获取样本数据</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="102c" class="lr kp hi mi b fi mm mn l mo mp">select * from FDADrugLabel<br/>order by effective_time desc<br/>limit 10;</span><span id="6f48" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({})<br/>    .sort({'effective_time':-1})<br/>    .limit(10);</span></pre><p id="0096" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 5。用单个过滤器或where条件获取样本数据</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="14c3" class="lr kp hi mi b fi mm mn l mo mp">select * from FDADrugLabel<br/>where openfda_product_type = 'HUMAN OTC DRUG'<br/>limit 10;</span><span id="0b8c" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({<br/>     'openfda.product_type' : 'HUMAN OTC DRUG'<br/>}).limit(10);</span></pre><p id="3227" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll">上述查询中类似‘A . b’的格式意味着‘b’是字典中的嵌套字段或键，或者是‘A’中的对象。这里的“openfda”是一个键，其值是一个字典列表，而“product_type”是“openfda”中字典的键之一</em></p><p id="b274" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 6。获取具有多个过滤条件的样本数据</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="93dc" class="lr kp hi mi b fi mm mn l mo mp">select * from FDADrugLabel<br/>where openfda_product_type != 'HUMAN OTC DRUG'<br/>and openfda_route in ('ORAL', 'TOPICAL')<br/>limit 10;</span><span id="73c6" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({<br/>   $and : [ <br/>           {'openfda.product_type' : {$ne : 'HUMAN OTC DRUG' } },<br/>           {'openfda.route' : {$in : {'ORAL', 'TOPICAL'} } }<br/>         ]<br/>}).limit(10);</span></pre><p id="a57a" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">7。从表/集合中获取选择的列/字段</p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="84bb" class="lr kp hi mi b fi mm mn l mo mp">select <br/>    active_ingredient, inactive_ingredient, effective_time<br/>from FDADrugLabel<br/>where product_type = 'HUMAN OTC DRUG'<br/>limit 10;</span><span id="b8fc" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({<br/>    'product_type' : 'HUMAN OTC DRUG'<br/>},{<br/>    'active_ingredient':1, <br/>    'inactive_ingredient':1,<br/>    'effective_time':1<br/>}).limit(10);</span></pre><p id="630a" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">8。使用' null '获取带有过滤条件的样本数据</p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="ca38" class="lr kp hi mi b fi mm mn l mo mp">select *<br/>from FDADrugLabel<br/>where openfda_drug_interactions is not null<br/>limit 10;</span><span id="a090" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({<br/>  $and : [    <br/>          {'openfda.drug_interactions' : {$exists : true} },<br/>          {'openfda.drug_interactions' : {$ne : ""} }<br/>        ]<br/>}).limit(10);</span></pre><p id="b588" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">9。使用通配符获取带有过滤条件的样本数据</p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="b00b" class="lr kp hi mi b fi mm mn l mo mp">select *<br/>from FDADrugLabel<br/>where openfda_manufacturer_name like '%Johnson%'<br/>limit 10;</span><span id="170d" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({<br/>  'openfda.manufacturer_name' : '<!-- -->/<!-- -->Johnson<!-- -->/'<br/>}).limit(10);<br/><strong class="mi hj">OR</strong><br/>db.FDADrugLabel.find({<br/>  'openfda.manufacturer_name' : { $regex : '/Johnson/'}<br/>}).limit(10);</span></pre><p id="d56a" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">10。同时使用'与'&amp;或'得到多个过滤条件的样本数据</p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="33bc" class="lr kp hi mi b fi mm mn l mo mp">select <br/>  openfda_brand_name, <br/>  openfda_generic_name, <br/>  openfda_product_type,<br/>  openfda_route,<br/>  openfda_manufacturer_name<br/>from FDADrugLabel<br/>where openfda_product_type = 'HUMAN OTC DRUG'<br/>and (openfda_route = 'TOPICAL' <br/>      or openfda_manufacturer_name like '%Johnson%')<br/>limit 10;</span><span id="68dc" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.find({<br/>  $and : [ <br/>          {'openfda.product_type' : 'HUMAN OTC DRUG'},<br/>          { $or : [<br/>                   { 'openfda.route' : 'TOPICAL' },<br/>                   { 'openfda.manufacturer_name' : '/Johnson/' } ]<br/>]},{<br/>    'openfda.brand_name':1,<br/>    'openfda.generic_name':1,<br/>    'openfda.product_type':1,<br/>    'openfda.route':1,<br/>    'openfda.manufacturer_name':1<br/>}).limit(10);</span></pre></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="061d" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated">编写查询—第2部分</h1><p id="401d" class="pw-post-body-paragraph jl jm hi jn b jo lg ij jq jr lh im jt ju li jw jx jy lj ka kb kc lk ke kf kg hb bi translated">在这一节中，我们将更进一步，尝试在SQL和MongoDB上进行聚合查询(<em class="ll">以同样的顺序</em>)。</p><p id="8841" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 1。对表/集合中的一列/字段进行计数聚合查询</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="c12c" class="lr kp hi mi b fi mm mn l mo mp">select <br/>  effective_time,<br/>  count(*)<br/>from FDADrugLabel<br/>where effective_time is not null<br/>group by effective_time<br/>;</span><span id="acc8" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.aggregate([<br/>  {$match : <br/>       {$and :[ { 'effective_time' : {$exists:true} },<br/>               { 'effective_time': "" }]<br/>}},<br/>  {"group":<br/>       {_id:"$effective_time",<br/>             count:{$sum:1}}<br/>});</span></pre><p id="8206" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll">在上面的查询中，‘_ id’就像是对数据进行分组的字段的别名，我们可以选择使用任何别名</em></p><p id="4e66" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 2。对表/集合中的多个列/字段进行计数聚合查询</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="d4b2" class="lr kp hi mi b fi mm mn l mo mp">select<br/>  version as data_version,<br/>  effective_time,<br/>  count(*)<br/>from FDADrugLabel<br/>where effective_time is not null<br/>and version is not null<br/>group by version, effective_time<br/>order by count(*) desc;</span><span id="ff47" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.aggregate([<br/>  {$match : <br/>       {$and :[ { 'version' : {$exists:true} },<br/>                { 'version': "" },<br/>                { 'effective_time' : {$exists:true} },<br/>                { 'effective_time': "" }]<br/>}},<br/>  {"group":<br/>       {_id: { data_version : '$version',<br/>               effective_time : "$effective_time" },<br/>               count : { $sum : 1 } } }<br/>  {$sort : {"count" : -1 } }<br/>]);</span></pre><p id="79c0" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 3。表/集合中聚合值的过滤条件</strong></p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="482d" class="lr kp hi mi b fi mm mn l mo mp">select<br/>  version as data_version,<br/>  count(*)<br/>from FDADrugLabel<br/>where effective_time is not null<br/>and version is not null<br/>group by version<br/>having count(*) &gt; 5;</span><span id="509c" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.aggregate([<br/>  {$match : <br/>       {$and :[ { 'version' : {$exists:true} },<br/>                { 'version': "" }]<br/>}},<br/>  {"group":<br/>       {_id: { data_version : '$version'<br/>               count : { $sum : 1 } } }<br/>  {$match :<br/>          { { count: { $gt : 5} } }<br/>]);</span></pre><p id="bad7" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><strong class="jn hj"> 4。文档中具有嵌套字典/对象的聚合查询</strong></p><p id="f6a3" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">这有点棘手，因为我们需要对嵌套在数组中的东西进行计数。这里使用的方法是首先展开或反规范化数据，然后计算记录的数量。这个不断展开或取消字典嵌套的过程利用了管道。同样也可以通过Map-Reduce来实现。</p><pre class="iy iz ja jb fd mh mi mj mk aw ml bi"><span id="e892" class="lr kp hi mi b fi mm mn l mo mp">select<br/>  openfda_manufacturer_name as manufacturer_name,<br/>  openfda_product_type as product_type,<br/>  openfda_route as route,<br/>count(openfda_unii)<br/>from FDADrugLabel<br/>where openfda_manufacturer_name is not null<br/>and openfda_product_type is not null<br/>and openfda_route is not null<br/>group by openfda_manufacturer_name, openfda_product_type, openfda_route<br/>having count(*)&gt;2;</span><span id="2439" class="lr kp hi mi b fi mq mn l mo mp">db.FDADrugLabel.aggregate([<br/>  {$match : <br/>       {$and :[ { 'openfda.manufacturer_name' : {$exists:true} },<br/>                { 'openfda.manufacturer_name': "" },<br/>                { 'openfda.product_type' : {$exists:true} },<br/>                { 'openfda.product_type': "" },<br/>                { 'openfda.route' : {$exists:true} },<br/>                { 'openfda.route': "" }]<br/>}},<br/>  {$project : {<br/>            "manufacturer_name" : "$openfda.manufacturer_name",<br/>            "product_type" : "$openfda.product_type",<br/>            "route" : "$openfda.route",<br/>            "unii" : "$openfda.unii" <br/>}},<br/>  {$unwind : {<br/>            path : "$unii"<br/>}},<br/>  {"group":<br/>       {_id: { manufacturer_name : '$manufacturer_name',<br/>               product_type : "$product_type"<br/>               route : "$route" },<br/>               count : { $sum : 1 } <br/>}},<br/>  {$match :<br/>          { { count: { $gt : 2} } }<br/>]);</span></pre></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="3a5f" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">MongoDB中分析数据的范围并没有到此为止。随着MongoDB新版本的发布，社区推出了许多特性和功能。它现在支持一系列功能，比如放置连接、编写子查询、使用变量、类型转换数据等。</p><p id="3677" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll">对于对这个话题感兴趣的读者来说，我会推荐阅读MongoDB的官方</em> <a class="ae jk" href="https://docs.mongodb.com/manual/reference/sql-comparison/" rel="noopener ugc nofollow" target="_blank"> <em class="ll">文档</em> </a> <em class="ll">。</em></p><p id="0505" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated">如果你已经阅读了这篇文章，我会非常感激。如果你发现它对你自己、同事或朋友有用，请随意分享，为让世界卫生保健变得更好做出贡献，并鼓掌支持👏。我也很想听到对这篇文章的反馈😃。</p><p id="3110" class="pw-post-body-paragraph jl jm hi jn b jo jp ij jq jr js im jt ju jv jw jx jy jz ka kb kc kd ke kf kg hb bi translated"><em class="ll"> PS:任何想联系的人都可以通过</em><a class="ae jk" href="https://www.linkedin.com/in/navneetguptapec/" rel="noopener ugc nofollow" target="_blank"><em class="ll">LinkedIn</em></a><em class="ll">联系。</em></p></div></div>    
</body>
</html>