<html>
<head>
<title>COVID-19 Death Count Animation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">新冠肺炎死亡计数动画</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/covid-19-death-count-animation-d3e19c16e332?source=collection_archive---------24-----------------------#2020-04-08">https://medium.com/analytics-vidhya/covid-19-death-count-animation-d3e19c16e332?source=collection_archive---------24-----------------------#2020-04-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2e0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这本书指导你使用Python库制作每日冠状病毒死亡人数的动画。</p><p id="64c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们使用的数据集可以从下面的链接下载:</p><p id="25a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://ourworldindata.org/grapher/covid-confirmed-deaths-since-5th-death" rel="noopener ugc nofollow" target="_blank">https://ourworldindata . org/grapher/covid-confirmed-deaths-since-5-death</a></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a0a8" class="jn jo hi jj b fi jp jq l jr js">import pandas as pd<br/>import numpy as np<br/>import matplotlib.pyplot as plt<br/>import seaborn as sns<br/>sns.set(style="darkgrid",palette="tab10")<br/># plt.style.use("seaborn-pastel")<br/>import warnings<br/>warnings.filterwarnings("ignore")</span><span id="a4e0" class="jn jo hi jj b fi jt jq l jr js">%matplotlib widget</span></pre><p id="7d2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据表在。逗号分隔值（csv）文件格式</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="7d56" class="jn jo hi jj b fi jp jq l jr js">df=pd.read_csv("covid-confirmed-deaths-since-5th-death.csv")<br/>df.head()</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es ju"><img src="../Images/5152b6e389808c98e55bd074b6d6a3f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*VyzBvRVnzVLA8cLKO1oRSQ.png"/></div></figure><p id="9530" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">行数将每天增加，截至今天(2020年4月8日)已有10，803行。该表有5列:</p><ul class=""><li id="0204" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc kd ke kf kg bi translated"><strong class="ih hj">实体</strong>:国家名称</li><li id="60a1" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">代码</strong>:国家代码</li><li id="b8a9" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">日期</strong>:日</li><li id="557e" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">总确认死亡人数</strong>:总死亡人数</li><li id="7a03" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">自第5例总确诊死亡后的天数</strong>:该特定国家自第5例死亡后经过的天数</li></ul><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b9e8" class="jn jo hi jj b fi jp jq l jr js">df.Date <strong class="jj hj">=</strong> pd.to_datetime(df.Date)</span><span id="cc5e" class="jn jo hi jj b fi jt jq l jr js">df.info()</span><span id="0301" class="jn jo hi jj b fi jt jq l jr js">&lt;class 'pandas.core.frame.DataFrame'&gt;<br/>RangeIndex: 10803 entries, 0 to 10802<br/>Data columns (total 5 columns):<br/> #   Column                                    Non-Null Count  Dtype         <br/>---  ------                                    --------------  -----         <br/> 0   Entity                                    10803 non-null  object        <br/> 1   Code                                      9346 non-null   object        <br/> 2   Date                                      10803 non-null  datetime64[ns]<br/> 3   Total confirmed deaths (deaths)           10795 non-null  float64       <br/> 4   Days since the 5th total confirmed death  2159 non-null   float64       <br/>dtypes: datetime64[ns](1), float64(2), object(2)<br/>memory usage: 422.1+ KB</span></pre><p id="b86a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们检索一个国家的数据，看看它是什么样子:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="d091" class="jn jo hi jj b fi jp jq l jr js">df[df.Entity <strong class="jj hj">==</strong> "Turkey"]</span></pre><figure class="je jf jg jh fd jv er es paragraph-image"><div class="er es km"><img src="../Images/d8ab8daaf3f41ffac6935d1ba41f68ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*--8fywvMXRDDkU524sKH1w.png"/></div></figure><h1 id="e25c" class="kn jo hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">动画</h1><p id="8f7f" class="pw-post-body-paragraph if ig hi ih b ii lk ik il im ll io ip iq lm is it iu ln iw ix iy lo ja jb jc hb bi translated">让我们制作一个动画，它输出一个<strong class="ih hj"> gif </strong>文件，该文件也显示了笔记本内的动画。首先，我们需要从数据中剔除非国家条目。数据集不仅有国家，还有地区，如“亚洲”、“欧洲”等。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="8aa5" class="jn jo hi jj b fi jp jq l jr js">import pycountry</span><span id="6539" class="jn jo hi jj b fi jt jq l jr js">data_all =  pd.pivot_table(values="Total confirmed deaths (deaths)",index="Date",columns="Entity", data=df)</span><span id="21c3" class="jn jo hi jj b fi jt jq l jr js">is_country = dict()<br/>for cd in data_all:<br/>    try:<br/>        is_country[cd] = pycountry.countries.get(name=cd).alpha_3<br/>    except:<br/>        data_all.drop(cd,axis=1,inplace=True)</span></pre><p id="7719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择要绘制的前10个死亡人数国家(默认，下面最后一行)，或列出要制作动画的国家</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6b53" class="jn jo hi jj b fi jp jq l jr js"># selected = ['Italy', 'Spain', 'United States', 'France', 'United Kingdom', 'China']<br/># selected = ['France','Belgium', 'Germany', 'Turkey']<br/>selected = data_all.iloc[-1,:].sort_values(ascending=False)[:10].index</span></pre><p id="ac78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于选择修剪数据。我们还将在日期之间插入数据点，以获得平滑的动画。插值数据将是每小时<strong class="ih hj">计数(使用线性插值)</strong></p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="2cba" class="jn jo hi jj b fi jp jq l jr js">data = data_all[selected].round()<br/>data = data[data.sum(axis=1)&gt;0]<br/>data.replace(0,np.nan,inplace=True)</span><span id="20f7" class="jn jo hi jj b fi jt jq l jr js">#interpolation<br/>data = data.resample("1H").interpolate(method="linear")</span></pre><p id="5bc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">导入创建动画和保存动画所需的包，并启动情节及其元素(线、条、文本等)。)</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a128" class="jn jo hi jj b fi jp jq l jr js">from matplotlib.animation import FuncAnimation, FFMpegWriter</span><span id="7240" class="jn jo hi jj b fi jt jq l jr js">fig,(ax,ax2) = plt.subplots(1,2,figsize=(15,7))<br/>fig.subplots_adjust(wspace=0.3,bottom=0.2)<br/>no_of_frames = data.shape[0] #Number of frames</span><span id="d330" class="jn jo hi jj b fi jt jq l jr js">#initiate the barplot with the first rows of the dataframe<br/>#BARPLOT<br/>bars = sns.barplot(y=data.columns,x=data.iloc[0,:],orient="h",ax=ax)<br/>ax.set_xlim(0,30000)<br/>txts = [ax.text(0,i,0,va="center") for i in range(data.shape[1])]<br/>title_txt = ax.text(10000,-1,"Date: ")<br/>ax.set_xlabel("Death Count")<br/>ax.set_ylabel(None)</span><span id="582c" class="jn jo hi jj b fi jt jq l jr js">#LINEPLOT<br/>lines = ax2.plot(data.iloc[:1,:])<br/>xdata,ydata = [],[]<br/>ax2.set_ylabel("Death Count (log)")<br/>ax2.set_yscale("log")<br/>ax2.set_ylim(-0.1,30000) #ylim has to be declared after defining log scale<br/>ax2.set_xlim(data.index[0].date(),data.index[-1].date())</span><span id="40ad" class="jn jo hi jj b fi jt jq l jr js">#LINEPLOT texts<br/>txts_line = [ax2.text(0,0,data.columns[i],va="center") for i in range(data.shape[1])]</span></pre><p id="0a64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">定义生成每一帧时将被调用的动画函数</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="ae3b" class="jn jo hi jj b fi jp jq l jr js">def animate(i):<br/>    ax2.set_xticklabels(ax2.get_xticklabels(),rotation=45)<br/>    <br/>    #get i'th row of data <br/>    y = data.iloc[i,:]<br/>    <br/>    #update title of the barplot axis<br/>    title_txt.set_text(f"Date: {str(data.index[i].date())}")<br/>    <br/>    #update elements in both plots<br/>    for j, b, in enumerate(bars.patches):<br/>        #update each bar's height<br/>        b.set_width(y[j])<br/>        <br/>        #update text for each bar (optional)<br/>        txts[j].set_text((y[j].astype(int)))<br/>        txts[j].set_x(y[j])<br/>        <br/>        #update lines<br/>        lines[j].set_ydata(data.iloc[:i,j])<br/>        lines[j].set_xdata(data.index[:i])<br/>        <br/>        #update line texts<br/>        txts_line[j].set_text(data.columns[j])<br/>        txts_line[j].set_x(data.index[i])<br/>        txts_line[j].set_y(y[j])</span></pre><p id="5f65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以所需的帧数和延迟(单位为毫秒)运行动画功能</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="b2fd" class="jn jo hi jj b fi jp jq l jr js">anim=FuncAnimation(fig,animate,repeat=False,frames=no_of_frames,interval=1,blit=False)<br/>plt.show()</span></pre><p id="0719" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后保存动画，有很多选项可以选择比如mp4，gif等。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9b8a" class="jn jo hi jj b fi jp jq l jr js">import time<br/>import warnings<br/>warnings.filterwarnings("ignore")<br/>t1 = time.time()<br/>print("Rendering started...")</span><span id="56a6" class="jn jo hi jj b fi jt jq l jr js">#save the animation with desired frames per second <br/># smoothness of the video depends on the number of datapoints and fps, the interval parameter above does not affect the video<br/>anim.save('covid_movie.mp4',writer=FFMpegWriter(fps=35))</span><span id="b1ac" class="jn jo hi jj b fi jt jq l jr js"># #save the animation in gif format<br/># anim.save("covid_gif.gif",writer="pillow",bitrate=5)</span><span id="2c69" class="jn jo hi jj b fi jt jq l jr js">print(f"Saving of {no_of_frames} frames Took {time.time()-t1} seconds")</span></pre><figure class="je jf jg jh fd jv"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="d837" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，你可以用<strong class="ih hj">赛璐珞</strong>包制作动画。它有一个非常简单的API，易于实现；但是，制作动画和创建输出文件需要更长的时间</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="aa4b" class="jn jo hi jj b fi jp jq l jr js">from celluloid import Camera<br/>fig = plt.figure(figsize=(12,5))<br/>fig.subplots_adjust(wspace=0.4,bottom=0.2)<br/>ax = fig.add_subplot(121)<br/>ax.set_yscale("log")<br/>ax.set_ylabel("Death Count")<br/>ax2 = fig.add_subplot(122)<br/>ax2.set_xlabel("Death Count")</span><span id="ee1c" class="jn jo hi jj b fi jt jq l jr js">camera = Camera(fig)<br/>for j,day in enumerate(data.index):<br/>    print("{0}".format(day),end="\r")<br/>    sns.barplot(x=data.iloc[j,:].values,y=data.columns,orient="h",ax=ax2)<br/>    for i,coun in enumerate(data.columns):<br/>        data[coun].loc[:day].plot(ax=ax,legend=False)<br/>        ax.text(day,data[coun].loc[day],coun,va="center")<br/>        try:<br/>            count = int(data[coun][day])<br/>        except:<br/>            count = data[coun][day]  <br/>        ax2.text(count+1,i,count,va="center")<br/>    ax2.set_ylabel(None)<br/>    ax2.text(0.35,1.03,f"Date: {day.date()}",fontsize=12,transform=ax2.transAxes)<br/>    camera.snap()</span><span id="4506" class="jn jo hi jj b fi jt jq l jr js">anim = camera.animate(interval=50)<br/>anim.save("Death Count per Country.gif",writer="pillow")</span></pre></div></div>    
</body>
</html>