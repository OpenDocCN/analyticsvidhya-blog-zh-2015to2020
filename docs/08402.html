<html>
<head>
<title>Apache Airflow — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇气流—第 1 部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/apache-airflow-part-1-8844113bda5e?source=collection_archive---------10-----------------------#2020-07-28">https://medium.com/analytics-vidhya/apache-airflow-part-1-8844113bda5e?source=collection_archive---------10-----------------------#2020-07-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="965d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个程序员都喜欢自动化他们的工作。学习和使用任何自动化工具对我们来说都很有趣。几个月前，我偶然发现了一个很棒的开源项目，叫做<a class="ae je" href="https://github.com/apache/airflow" rel="noopener ugc nofollow" target="_blank"><em class="jd">Apache-air flow</em></a><em class="jd">。我试图发现这个开源项目，并在我现有的代码库中使用它。这个博客系列只是我最近学习这个工具的总结。在本系列的第一部分，我们将讨论工作流、气流安装、Dag 以及在气流中实施 Dag 等主题。所以让我们从头开始。</em></p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><p id="c6ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是工作流？</strong></p><p id="42d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开始讨论 apache airflow 之前，让我们通过一个简单的例子来理解什么是工作流。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es jm"><img src="../Images/1730391bcb0c4c3ec1ca7375a5aba472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*htpbZoewf8JXZex_gVY5_A.png"/></div></figure><p id="2fe5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们经常遇到这种类型的用例，我们需要运行一组步骤来创建预期的输出。完成给定数据<br/>工程任务的这组步骤称为<strong class="ih hj">工作流</strong>。我们可以使用许多工作流工具来安排这些类型的任务。使用<code class="du ju jv jw jx b">Cron Job</code>是解决方案之一，但是管理几个<code class="du ju jv jw jx b">Cron Jobs</code>是一项繁琐的任务。世界正在选择其他几个工作流工具，如 Apache-Airflow、Luigi、SSIS 等。我们将关注阿帕奇气流。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es jy"><img src="../Images/c92cd17b68c33970a1b9581e40df0352.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/1*rGAJOeEAba5nO6ge-o2MyQ.png"/></div></figure><p id="c41e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是气流？<br/> </strong> Airflow 是一个编程工作流的平台，包括:</p><ul class=""><li id="5ff1" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">创造</li><li id="3322" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">行程安排</li><li id="8133" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">监视</li></ul><p id="37f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以用任何语言实现程序，但是工作流是用 Python 在 apache-airflow 中编写的。它将工作流实现为 DAG，即可以通过命令行或 web 界面访问的直接非循环图。</p><p id="6bd7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">什么是 DAG？<br/>  DAG 代表有向无环图，通过下图我们可以很容易理解。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kn"><img src="../Images/8afee080a61d81f799d613ef53ddfbd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*sOrwWdI4Zdgzdc79kLxm_w.png"/></div></figure><ul class=""><li id="6e0d" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">定向的，有一个内在的流程表示组件之间的依赖关系。</li><li id="4c53" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">非循环，不循环/循环/重复。</li></ul><p id="87c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 Airflow 中，这代表了构成我们工作流的任务集。我们可以使用下面的代码结构定义一个简单的 DAG。</p><pre class="jn jo jp jq fd ko jx kp kq aw kr bi"><span id="855a" class="ks kt hi jx b fi ku kv l kw kx">from airflow.models import DAG<br/>dag = DAG(<br/>    dag_id='first_dag',<br/>    default_args={"start_date": datetime(2020, 7, 25)}<br/>)</span></pre><p id="c44e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 Airflow 中，dag 是用 Python 编写的，但是它可以使用用任何其他语言编写的组件(通常是任务)。我们可以使用<code class="du ju jv jw jx b">airflow list_dags</code>命令列出气流中出现的所有 Dag。</p><p id="6709" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经了解了气流的基本原理。让我们尝试将它安装到我们的虚拟环境中，以便进一步理解和使用。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="09bf" class="ky kt hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">快速安装指南。</h1><p id="15f5" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">我们将使用 python 虚拟环境在我们的本地系统中安装<code class="du ju jv jw jx b">apache-airflow</code>。</p><ul class=""><li id="1f33" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">创建一个名为<code class="du ju jv jw jx b">airflow_sandbox</code>的目录，并在其中创建一个名为<code class="du ju jv jw jx b">backend</code>的目录</li><li id="3d3e" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">在您的<code class="du ju jv jw jx b">backend</code>目录中打开您的终端。</li><li id="6825" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">在您的<code class="du ju jv jw jx b">backend</code>目录中，创建一个 python 虚拟环境，并激活它以备将来使用。</li><li id="e82d" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">运行` export air flow _ HOME = ` pwd `/air flow _ HOME '</li><li id="ae78" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">跑<code class="du ju jv jw jx b">pip install apache-airflow</code></li><li id="2019" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">通过<code class="du ju jv jw jx b">airflow initdb</code>初始化数据库</li><li id="6dd6" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">启动 web 服务器，默认端口是 8080 <code class="du ju jv jw jx b">airflow webserver -p 8080</code></li><li id="060a" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">通过<code class="du ju jv jw jx b">airflow scheduler</code>启动调度程序</li></ul><p id="f139" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你卡住了，那么请参考<a class="ae je" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache-air flow 的官方文档</a>。安装完成后，在<code class="du ju jv jw jx b">airflow_home</code>文件夹中创建一个名为<code class="du ju jv jw jx b">dags</code>的目录。Dag 总是在这个<code class="du ju jv jw jx b">dags</code>文件夹中创建。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="7744" class="ky kt hi bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">实施气流 Dag</h1><h2 id="6750" class="ks kt hi bd kz ma mb mc ld md me mf lh iq mg mh ll iu mi mj lp iy mk ml lt mm bi translated">气流操作员</h2><p id="011a" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">Dag 定义了如何运行一个工作流，而<em class="jd">操作符</em>决定了一个任务实际上完成了什么。一个操作符代表一个单一的幂等任务，它们通常(但不总是)是原子的。它们可以独立存在，不需要与任何其他运营商共享资源。DAG 将确保操作符以正确的顺序运行；除了这些依赖性，操作符通常独立运行。事实上，它们可能运行在两台完全不同的机器上。<br/>总结以上关于气流算子的讨论:</p><ul class=""><li id="0b13" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">代表工作流中的单个任务。</li><li id="879a" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">独立运行(通常)</li><li id="8e1a" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">一般不共享信息</li></ul><p id="d0b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">气流为许多常见任务提供了操作符，一些最常用的操作符如下。</p><ul class=""><li id="8a3f" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated"><strong class="ih hj"><em class="jd">python operator:</em></strong>调用 python 函数</li><li id="87a5" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated"><strong class="ih hj"><em class="jd">bash operator:</em></strong>执行 bash 命令或调用 bash 脚本</li><li id="ffcf" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated"><strong class="ih hj"><em class="jd">SimpleHttpOperator:</em></strong>发送 HTTP 请求</li><li id="edae" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated"><strong class="ih hj"> <em class="jd">电子邮件操作员:</em> </strong>发送电子邮件</li></ul><p id="90d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">气流提供了许多其他操作符，我们可以从其<a class="ae je" href="https://airflow.apache.org/docs/stable/" rel="noopener ugc nofollow" target="_blank">文档</a>中查看。</p><p id="dfac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们试着通过一个简单的例子来发现<em class="jd"> BashOperator </em>和<em class="jd">python operator</em>。</p><p id="ff28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生成随机数的简单 BashOperator。</p><pre class="jn jo jp jq fd ko jx kp kq aw kr bi"><span id="7e12" class="ks kt hi jx b fi ku kv l kw kx">from airflow.operators.bash_operator import BashOperator</span><span id="ce3c" class="ks kt hi jx b fi mn kv l kw kx">task_1 = BashOperator(<br/>    task_id='generate_random_number_by_bash',<br/>    bash_command='echo $RANDOM',<br/>    dag=dag<br/>)</span></pre><p id="f500" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个简单的生成随机数的 python 运算符。</p><pre class="jn jo jp jq fd ko jx kp kq aw kr bi"><span id="69c2" class="ks kt hi jx b fi ku kv l kw kx">import random<br/>from airflow.operators.python_operator import PythonOperator<br/></span><span id="25fd" class="ks kt hi jx b fi mn kv l kw kx">def generate_random_number():<br/>    return random.randint(0, 100)</span><span id="6461" class="ks kt hi jx b fi mn kv l kw kx">task_2 = PythonOperator(<br/>    task_id='generate_random_number_by_python',<br/>    python_callable=generate_random_number,<br/>    dag=dag<br/>)</span></pre><h2 id="b8b0" class="ks kt hi bd kz ma mb mc ld md me mf lh iq mg mh ll iu mi mj lp iy mk ml lt mm bi translated">任务</h2><p id="73e8" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated">任务是:</p><ul class=""><li id="aa6d" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">运算符的实例</li><li id="3759" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">赋给 python 变量(通常)</li><li id="ab8b" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">气流中的<code class="du ju jv jw jx b">task_id</code>所指。</li></ul><p id="0351" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们看上面的例子，那么 python 变量<code class="du ju jv jw jx b">task_1</code>和<code class="du ju jv jw jx b">task_2</code>就是任务的两个例子。</p><h2 id="6089" class="ks kt hi bd kz ma mb mc ld md me mf lh iq mg mh ll iu mi mj lp iy mk ml lt mm bi translated">任务相关性</h2><ul class=""><li id="a45b" class="jz ka hi ih b ii lv im lw iq mo iu mp iy mq jc ke kf kg kh bi translated">定义任务完成的给定顺序。</li><li id="f657" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">在 Airflow 或以上版本中，它是由位移位运算符定义的。<br/> * &gt; &gt;或上游运算符(简单来说就是之前)<br/> * &lt; &lt;或下游运算符(简单来说就是之后)</li></ul><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es mr"><img src="../Images/e6dc4f2288ed6a2152862e650efe3d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:624/format:webp/1*B8ahi79a9zzSil08242AEA.png"/></div></figure><p id="d4b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们在气流中定义<code class="du ju jv jw jx b">task_1 &gt;&gt; task_2</code>，那么<code class="du ju jv jw jx b">task_1</code>将在<code class="du ju jv jw jx b">task_2</code>之前执行。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kn"><img src="../Images/325282a3329dd4474aa6a2ded0f93771.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*J7B-yF6fOu-5mqa1iGg0_g.png"/></div></figure><p id="1576" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们定义<code class="du ju jv jw jx b">task_1 &gt;&gt; task_3 &lt;&lt; task_2</code>，那么这意味着<code class="du ju jv jw jx b">task_1</code>和<code class="du ju jv jw jx b">task_2</code>将在<code class="du ju jv jw jx b">task_3</code>之前执行。</p><h2 id="724f" class="ks kt hi bd kz ma mb mc ld md me mf lh iq mg mh ll iu mi mj lp iy mk ml lt mm bi translated">气流调度</h2><p id="682b" class="pw-post-body-paragraph if ig hi ih b ii lv ik il im lw io ip iq lx is it iu ly iw ix iy lz ja jb jc hb bi translated"><strong class="ih hj">达格运行</strong></p><ul class=""><li id="7e98" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated">工作流在某个时间点的特定实例。</li><li id="0037" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">可以手动运行，也可以通过<code class="du ju jv jw jx b">schedule_interval</code>运行。</li><li id="3b7e" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated">可以有多种状态，如<code class="du ju jv jw jx b">running</code>、<code class="du ju jv jw jx b">failed</code>、<code class="du ju jv jw jx b">success</code>等。</li></ul><p id="86b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在计划 DAG 时，这些属性会派上用场。</p><ul class=""><li id="191f" class="jz ka hi ih b ii ij im in iq kb iu kc iy kd jc ke kf kg kh bi translated"><code class="du ju jv jw jx b">start_date</code>:最初安排 DAG 运行的日期/时间。</li><li id="82d6" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated"><code class="du ju jv jw jx b">end_date</code>:何时停止正在运行的 DAG 实例(可选参数)。</li><li id="c031" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated"><code class="du ju jv jw jx b">max_tries</code>:停止前的最大尝试次数(可选参数)</li><li id="bbb0" class="jz ka hi ih b ii ki im kj iq kk iu kl iy km jc ke kf kg kh bi translated"><code class="du ju jv jw jx b">schedule_interval</code>:多长时间安排一次 DAG？您可以通过任何类似<code class="du ju jv jw jx b">*/5 * * * *</code>的<code class="du ju jv jw jx b">cron</code>语法进行定义，即每 5 分钟定义一次。你可以检查这个<a class="ae je" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">网站</a>来生成任何正确的<code class="du ju jv jw jx b">cron</code>语法。</li></ul><p id="0b8f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">schedule _ interval gotcha:<br/></strong>调度 DAG 时，气流会一直，在<br/> <code class="du ju jv jw jx b">start_date + schedule_interval</code>调度任务。</p><p id="e76e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如</p><pre class="jn jo jp jq fd ko jx kp kq aw kr bi"><span id="63d0" class="ks kt hi jx b fi ku kv l kw kx">task_2 = PythonOperator(<br/>    task_id='generate_random_number_by_python',<br/>    python_callable=generate_random_number,<br/>    start_date=datetime(2020, 7, 28),<br/>    schedule_interval='0 0 * * *',<br/>    dag=dag<br/>)</span></pre><p id="f01b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着启动 DAG 的最早开始时间是 7 月 29 日午夜 00:00</p><p id="abc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">太棒了。！！我们已经安装了 Apache-Airflow，并讨论了 Apache-Airflow 的一些介绍性概念。让我们在本系列的下一部分见面，并尝试发现更多关于这个令人惊奇的开源软件的信息。直到那时再见，继续学习。</p></div></div>    
</body>
</html>