<html>
<head>
<title>Using Kops to setup up Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kops建立Kubernetes集群</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/using-kops-to-setup-up-kubernetes-cluster-f83d83139f6a?source=collection_archive---------10-----------------------#2020-09-30">https://medium.com/analytics-vidhya/using-kops-to-setup-up-kubernetes-cluster-f83d83139f6a?source=collection_archive---------10-----------------------#2020-09-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c6f82f7fe27502fab1f651c07cfd6dca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2zXQMK-6exyVoBz-.png"/></div></div></figure><figure class="ir is it iu fd ij er es paragraph-image"><div class="er es iq"><img src="../Images/17410d20fc6e3ae6444a08e250308841.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/format:webp/1*RIOeTmk35_xGY8mgqVShNw.png"/></div></figure><h1 id="3976" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">Kubernetes和Kops概述</h1><p id="1ed5" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Kubernetes是一个开源的容器编排平台。打包成Docker映像的应用程序可以在Kubernetes集群中轻松部署、扩展和管理。Kubernetes的一些主要特征是:</p><ul class=""><li id="709a" class="kr ks hi jv b jw kt ka ku ke kv ki kw km kx kq ky kz la lb bi translated">自我修复<br/>失败的容器被重新启动，以确保应用程序的期望状态得到维护。如果集群中的一个节点失效，那么容器将在另一个节点上重新调度。不响应应用程序定义的健康检查的容器被终止，从而被重新调度。</li><li id="4e53" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">水平缩放<br/>容器的数量可以根据CPU的使用情况自动缩放，或者使用命令手动缩放。</li><li id="4caa" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">服务发现和负载平衡<br/>可以使用DNS名称将多个容器组合在一起进行发现。该服务可以通过集成到云提供商提供的本地LB来实现负载平衡。</li><li id="6b80" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">应用程序升级和回滚<br/>应用程序可以升级到新版本，而不会影响现有版本。如果出现问题，Kubernetes会回滚更改。</li></ul><p id="7490" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">Kops是Kubernetes Operations的缩写，是一套在云中安装、操作和删除Kubernetes集群的工具。也可以将旧版本的Kubernetes滚动升级到新版本。它还管理集群附加组件。创建集群后，通常的<a class="ae lk" href="https://kubernetes.io/docs/user-guide/kubectl-overview/" rel="noopener ugc nofollow" target="_blank"> kubectl CLI </a>可以用来管理集群中的资源。</p><p id="ff66" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv hj">在之前的</strong> <a class="ae lk" rel="noopener" href="/@sarthak3398/using-minikube-for-local-deplyment-of-single-node-kubernetes-cluster-25bb576d532b"> <strong class="jv hj">帖子</strong> </a> <strong class="jv hj">中，我使用Minikube在本地部署单节点Kubernetes集群，在这篇帖子中，我将在AWS上部署N节点集群。</strong></p><p id="f3e1" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">链接:<a class="ae lk" rel="noopener" href="/@sarthak3398/using-minikube-for-local-deplyment-of-single-node-kubernetes-cluster-25bb576d532b">https://medium . com/@ sarthak 3398/using-minikube-for-local-deplyment-of-single-node-kubernetes-cluster-25bb 576d 532 b</a></p><h2 id="a429" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated">先决条件:</h2><ul class=""><li id="0f32" class="kr ks hi jv b jw jx ka kb ke lz ki ma km mb kq ky kz la lb bi translated">AWS-cli设置</li><li id="d095" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">S3水桶</li><li id="f250" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">必要的库</li></ul><p id="6261" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">我附上了一个<a class="ae lk" href="https://docs.google.com/document/d/1TkBfQaEfK9nlK0rvnq_X70BDzidSPeN__K8n6zzj-QE/edit?usp=sharing" rel="noopener ugc nofollow" target="_blank"> pdf </a>，我在其中添加了安装docker、kubectl和kops的所有命令。只有完成这一步后才能前进。</p><h1 id="bab4" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">AWS-cli设置</h1><ol class=""><li id="da7b" class="kr ks hi jv b jw jx ka kb ke lz ki ma km mb kq mc kz la lb bi translated">在AWS上创建一个帐户。</li><li id="9a3e" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq mc kz la lb bi translated">转到<strong class="jv hj">身份&amp;访问管理</strong> (IAM)，创建一个用户并生成一个访问密钥以在您的机器上配置AWS。您需要向该IAM用户授予AdministratorAccess权限。</li><li id="31eb" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq mc kz la lb bi translated">打开命令行并配置AWS</li></ol><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="ab71" class="ll iw hi me b fi mi mj l mk ml">aws configure</span></pre><p id="c777" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">4.提供您刚刚生成的<strong class="jv hj">访问密钥</strong>和<strong class="jv hj">秘密</strong>，以及您将要部署集群的区域。AWS建议用户选择地理上靠近他们的地区，以减少延迟和成本。</p><p id="6b51" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">对于那些正在使用<strong class="jv hj"> AWS教育初学者帐户。</strong>进入AWS教育- &gt;登录- &gt; AWS账户- &gt; AWS教育入门账户- &gt;账户详情</p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/2e01a7f00844c20fda6c7df7e470b635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HKdhXykaBQvP9s1kZo79Lg.png"/></div></div></figure><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="405e" class="ll iw hi me b fi mi mj l mk ml">gedit ~/.aws/credentials</span></pre><p id="169b" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">删除凭证文件的内容，并将以下内容粘贴到凭证文件上</p><figure class="ir is it iu fd ij er es paragraph-image"><div class="er es mn"><img src="../Images/f6175fbc24df7f504bc7938b47fa1c1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*O5XMTDZXBPcQSKHGNsjs2Q.png"/></div></figure><p id="6d6d" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">5.转到<strong class="jv hj"> S3(简单存储服务)桶</strong>，这是一个公共云存储资源，创建一个桶。</p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/d9ee045bf6fd8e00b1998dae17c6c1c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kRyrbb-3vzuI3LoXfHqMoA.png"/></div></div></figure><h2 id="91a7" class="ll iw hi bd ix lm ln lo jb lp lq lr jf ke ls lt jj ki lu lv jn km lw lx jr ly bi translated"><strong class="ak">现在让我们使用KOPS在AWS上创建一个集群</strong></h2><p id="e9e9" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Kops CLI可用于创建高可用性集群，其中多个主节点分布在多个可用性区域中。工人也可以分布在多个区域。在集群创建过程中，后台发生的一些任务包括:</p><ul class=""><li id="6ac8" class="kr ks hi jv b jw kt ka ku ke kv ki kw km kx kq ky kz la lb bi translated">设置EC2实例</li><li id="bd6e" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">设置AWS资源，如网络、自动扩展组、IAM用户和安全组</li><li id="946b" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">安装Kubernetes。</li></ul><p id="67aa" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">如您所见，没有实例正在运行</p><figure class="ir is it iu fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/710bc7a7c2c75480153508fd0c7bbf40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*8DMgIyF4s61XxtMRoIdRCg.png"/></div></figure><p id="8e06" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">6.创建AWS Kubernetes集群</p><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="2f82" class="ll iw hi me b fi mi mj l mk ml">kops create cluster --yes --state=s3://kops-storage-03091999 --zones=us-east-1a --node-count=2 --node-size=t2.micro --master-size=t2.micro --name=test.k8s.local</span></pre><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/753cc4df54c247b7d3e1c9ddaf057c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fgH4v5pPvyAre_tEbs5A9g.png"/></div></div></figure><p id="15a3" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">当您运行该命令时，您将看到两个从节点和一个主节点开始旋转。您可以通过转到AWS服务中的EC2实例部分来验证它</p><figure class="ir is it iu fd ij er es paragraph-image"><div class="er es mr"><img src="../Images/2278a5aa92773ae4e7d1801144f1803a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*wFeve4-j-sCZbYK0MvejbQ.png"/></div></figure><p id="e054" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">7.您可以验证Kubernetes集群</p><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="e6f5" class="ll iw hi me b fi mi mj l mk ml">kops validate cluster <br/>kops validate cluster -o json ##show output in json format<br/>kops validate cluster -o yaml ##show output in yaml format</span></pre><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/f9e0e75bb67daef104e43b78711ec04c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nFGhsAQ08UplfvsNom-9Yw.png"/></div></div></figure><p id="21da" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">8.现在我们开始在Kubernetes集群上进行部署。我们正在docker hub上公开部署一个<a class="ae lk" href="https://hub.docker.com/repository/docker/7985260261/magicalnginx" rel="noopener ugc nofollow" target="_blank"> docker镜像</a></p><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="3db3" class="ll iw hi me b fi mi mj l mk ml">sudo kubectl create deployment &lt;Deployment_Name&gt; --image=&lt;Image_Name&gt;</span><span id="0943" class="ll iw hi me b fi mt mj l mk ml">kubectl create deployment magicalnginx --image=anshuldevops/ magicalnginx</span></pre><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/6e137b747acb629cb9753ce199555b4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nEFd0xglamVQmeCiOxleBg.png"/></div></div></figure><p id="ce54" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">9.使用获取运行部署的信息</p><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="0b05" class="ll iw hi me b fi mi mj l mk ml">kubectl get deployments</span></pre><figure class="ir is it iu fd ij er es paragraph-image"><div class="er es mv"><img src="../Images/311894d8b94e6950533f3b63a290b38b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*E-2rFh_vzHkpyEja6dJWmg.png"/></div></figure><p id="458d" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">10.kubectl描述部署magicalnginx</p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/be1f1b8c19ef94e4e73995ff850bee7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_kX5kF1dwzz46zqpD7y9YQ.png"/></div></div></figure><p id="bbf9" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">11.现在，我们将通过负载平衡器在互联网上公开NGINX容器。这个命令也有助于负载平衡。</p><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="54dd" class="ll iw hi me b fi mi mj l mk ml"> kubectl create service loadbalancer magicalnginx --tcp=80:80</span></pre><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/88c4ee40482709c0e9472d7c4b95aa64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mnn0xu-vR-5o5FKMw5n6Fw.png"/></div></div></figure><p id="6972" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">现在，当您转到AWS服务中的EC2实例部分时，您将看到负载平衡器1。这样，您的负载平衡器就启动了</p><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/518ab6f54b808dfd910990a2734b9608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IrGAuv-C43Oxe_JRmPgMg.png"/></div></div></figure><p id="19ef" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">12.要运行服务，请使用</p><pre class="ir is it iu fd md me mf mg aw mh bi"><span id="2101" class="ll iw hi me b fi mi mj l mk ml">kubectl get svc</span></pre><p id="ba20" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">该命令将给出可访问您的应用程序的IP和端口。转到浏览器，键入IP地址和端口号</p><p id="909d" class="pw-post-body-paragraph jt ju hi jv b jw kt jy jz ka ku kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">Kubectl命令:</p><ul class=""><li id="6a7c" class="kr ks hi jv b jw kt ka ku ke kv ki kw km kx kq ky kz la lb bi translated">要列出部署:<strong class="jv hj"> sudo kubectl获取部署</strong></li><li id="08c2" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">删除服务:<strong class="jv hj"> sudo kubectl删除服务magicalnginx </strong></li><li id="32dc" class="kr ks hi jv b jw lc ka ld ke le ki lf km lg kq ky kz la lb bi translated">删除一个特定的部署:<strong class="jv hj">sudo ku bectl delete deployment magicalnginx</strong></li></ul><figure class="ir is it iu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es et"><img src="../Images/d135b9e5a851b6ab13bdff9473e1fade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Ana60XFfQHr6enC_7mIpw.png"/></div></div></figure></div></div>    
</body>
</html>