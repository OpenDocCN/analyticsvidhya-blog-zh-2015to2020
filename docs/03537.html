<html>
<head>
<title>Python — Cloudformation templates and parameters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python云形成模板和参数</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/python-cloudformation-templates-and-parameters-de4a6b183b91?source=collection_archive---------16-----------------------#2020-02-06">https://medium.com/analytics-vidhya/python-cloudformation-templates-and-parameters-de4a6b183b91?source=collection_archive---------16-----------------------#2020-02-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/85143d23647616812ca00b1e85e19b50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oJ6-SZXqS_BAAb8691MJ7Q.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">马克斯·尼尔森在<a class="ae iu" href="https://unsplash.com/s/photos/python?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="debf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我已经在IT行业工作了10年，主要是作为一名生产工程师，3-4年前我成为了一名devops工程师。</p><p id="5f28" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最近，我一直在关注AWS和云在效率方面能给我们带来什么。这让我为一个外国客户实施了一个完整的CI/CD解决方案，从开发交付开始，到使用Gitlab CI/CD管道进行生产的基本环节。</p><p id="916a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你熟悉AWS，你就不能忽视Cloudformation(或者Terraform，或者任何你想用来做一些基础设施如代码的工具)。</p><p id="ca65" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，在我们的CI/CD管道中，我们有如下的结构:<br/> -每个git分支是一个环境<br/> -每个环境有一个特定的参数文件<br/> -一个公共的模板文件被所有的env使用</p><p id="e948" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">cloudformation模板文件在这里描述了我们想要的基础设施:负载平衡器、DNS条目、自动扩展组等等。</p><p id="ec5a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">顾名思义，参数文件用于通过专用于特定环境的值来覆盖模板中的基本参数(例如，在DEV环境中，您的VPC可能与PROD环境中的不同)。</p><p id="3ec5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们遇到的一个问题是，params文件可能因环境而异，有时我们会丢失一些条目，这会导致管道故障。</p><p id="c164" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了避免这种情况，我们使用python脚本来比较这两个文件(我忘了说param文件是JSON，而模板是YAML ),如果它们之间有一些差异，就打印出来。</p><p id="3dd1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们对参数文件使用json.load，对模板使用yaml BaseLoader来加载这两个文件。</p><p id="5cfe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">json.load和yaml.load函数将我们的文件转换为dicts，因此我们可以通过使用各自的键提取想要的值来获得参数。</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="5358" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后我们创建两个列表:paramListInParamFile和paramListInTemplateFile，我们从这两个文件中推送所有参数值。</p><p id="29bb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们对列表进行排序，以便能够轻松地进行比较。</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="jx jy l"/></div></figure><p id="1c80" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在开始有意思了。</p><p id="1662" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果两个列表不相同，需要找出哪个键出现在列表1中，而不是列表2中。为此，我们用典型的python语法创建了一个结果列表</p><pre class="jt ju jv jw fd jz ka kb kc aw kd bi"><span id="9459" class="ke kf hi ka b fi kg kh l ki kj">resultNotInParamFile = [x for x in paramListInTemplateFile if x not in paramListInParamFile]</span></pre><p id="3804" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这意味着:resulatNotInParamFile将由“x”填充，只有当x不在paramListInParamFile中时，它才是paramListInTemplateFile的对象。</p><p id="afde" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，如果我们的新列表的长度不为0(即不为空)，我们从列表中取出所有的条目，并将它们转换为string(参见map函数)并转换为一个新的var，我们可以用它来打印结果(第9行和第14行)。</p></div><div class="ab cl kk kl gp km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="hb hc hd he hf"><p id="19fc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，这个脚本可以在部署之前运行，并触发您想要的任何东西(警报、自动纠正……)。</p><p id="3320" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我的第一篇媒体文章(顺便说一下，在英语中，我是法国人:)</p><p id="c9b5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望你喜欢。</p></div></div>    
</body>
</html>