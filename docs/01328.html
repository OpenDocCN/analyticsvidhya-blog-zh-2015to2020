<html>
<head>
<title>Serverless Telegram bot on Now.sh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器电报机器人on Now.sh</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/serverless-telegram-bot-on-now-sh-b8522fb1e7fc?source=collection_archive---------5-----------------------#2019-10-15">https://medium.com/analytics-vidhya/serverless-telegram-bot-on-now-sh-b8522fb1e7fc?source=collection_archive---------5-----------------------#2019-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="810f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个故事中，我将告诉你我是如何在Zeit.co(now . sh)上部署无服务器python telegram bot的。如果您使用Javascript或其他编程语言，本教程也会有所帮助。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/d43410daebf6e4f784f18d8569e5d2dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Qm_U_6XHJgqjfcOFPjeng.png"/></div></div></figure><h1 id="a44f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">动机</h1><p id="603c" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我不喜欢来自<code class="du ks kt ku kv b"><a class="ae kw" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank">python-telegram-bot</a></code> GitHub的例子，我只是觉得它们不可扩展。我真的很想把“前端”(电报机器人接口)和“后端”(所有逻辑、数据库处理、后台任务)分开。在这种情况下，您可以分别开发这两个部分，在不同的服务器上托管它们…或者无服务器？</p><p id="eb3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的一些朋友使用Heroku来托管他们的机器人前端，这是一个很好的解决方案。但在某些情况下，如果你使用免费的Heroku实例，你的应用程序和telegram bot可能会“进入睡眠状态”，用户应该等待10秒钟，然后应用程序才能再次工作。是的，您可以编写“pinger”来阻止Heroku实例进入睡眠状态，但是这个解决方案不是可伸缩的和特定于平台的。咩。</p><p id="de01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我发现Now.sh有一个免费的无服务器层，每天有5000个调用。对于小项目来说，我觉得这远远绰绰有余。但是Zeit公司没有关于如何运行无服务器电报机器人的教程，所以我决定写一个。</p><h1 id="de8d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="fb9e" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">最重要也是最棘手的步骤:</p><ol class=""><li id="944c" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><strong class="ih hj">烧瓶</strong> <strong class="ih hj">终点</strong>同<strong class="ih hj">岗位</strong>方法允许，</li><li id="d543" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">通过<strong class="ih hj"> Now CLI </strong>设置<strong class="ih hj"> TELEGRAM_TOKEN </strong> env var并链接到<code class="du ks kt ku kv b">now.json</code>，</li><li id="45c2" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">通过Telegram API调用将Now.sh https URL注册为webhook。</li></ol><h1 id="c44c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">无服务器机器人</h1><p id="2817" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我给大家简单了解一下无服务器电报机器人的工作原理:</p><ol class=""><li id="8f93" class="kx ky hi ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated">电报服务器捕捉所有机器人传入的信息，</li><li id="faa5" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">你给了电报发送这些信息的秘密。这是您部署的前端的Now.sh的URL。</li><li id="7df0" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">电报转发您的前端所有传入的信息</li><li id="9aeb" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">Now.sh接收传入的消息，调用bot的实例</li><li id="ea5e" class="kx ky hi ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">现在，您可以访问用户的消息，并可以对其进行回复(如果您在前端也有可用的令牌)。</li></ol><h1 id="8d42" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">无服务器Python电报机器人</h1><p id="d7a8" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">下面你可以找到简单的烧瓶电报回声机器人。<code class="du ks kt ku kv b">/api</code>端点将接收Telegram webhook的消息，并用相同的消息文本进行回复。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ll lm l"/></div></figure><h1 id="a4ca" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">设置环境变量</h1><p id="1d47" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><em class="ln">我相信你知道如何创建电报机器人，电报机器人令牌是什么，如果不知道，请谷歌一下。</em></p><p id="3660" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以注意到，我正在使用<code class="du ks kt ku kv b">TELEGRAM_TOKEN</code>环境变量来通过电报机器人回显消息。为了向Now sh提供这个秘密信息，你需要他们的Now CLI(谷歌如何安装它)。</p><p id="0786" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不喜欢现在的CLI，但我很喜欢Zeit的GitHub集成。遗憾的是，我不能用Zeit.co网站指定环境变量。亲爱的Zeit，为什么？</p><p id="2c8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要添加<strong class="ih hj"> TELEGRAM_TOKEN </strong>环境变量，请使用以下代码:</p><pre class="je jf jg jh fd lo kv lp lq aw lr bi"><span id="617d" class="ls jq hi kv b fi lt lu l lv lw">now secrets add telegram-token &lt;TELEGRAM_TOKEN&gt;</span></pre><p id="fa7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我添加了一个名为“telegram-token”的新环境变量，因为Zeit无法添加高档变量名称。亲爱的Zeit，为什么？</p><h1 id="a5c7" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">在Now.sh应用程序中使用环境变量</h1><p id="6fd7" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">现在，您应该添加now.json配置文件，以允许您的应用程序读取这个秘密变量。</p><p id="c50a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是你该做的。注意，我还添加了特定于Zeit的配置来运行python项目。我花了很多时间试图找到一个适合我的。亲爱的Zeit，为什么？</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="75ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看看我是如何引用我在上一步中创建的“telegram-token”变量的。</p><p id="1d81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然已经完成了Ziet设置，就可以部署应用程序了。我喜欢通过连接GitHub repo来部署我的应用程序——现在每个commit都部署到现在，这是一个非常棒的CD。</p><h1 id="4458" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">注册电报机器人网络钩子</h1><p id="e99f" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">既然您现在已经部署了您的应用程序，您应该有指向它的<code class="du ks kt ku kv b">https://</code>链接。现在sh为您的项目生成了许多别名，您将需要不带提交散列的URL——因此您的项目URL在每次提交时都是相同的。</p><p id="f23d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在打开您的终端，运行以下命令:</p><pre class="je jf jg jh fd lo kv lp lq aw lr bi"><span id="a4a1" class="ls jq hi kv b fi lt lu l lv lw">curl “https://api.telegram.org/bot&lt;TELEGRAM_TOKEN&gt;/setWebhook?url=https://your-now-sh-project.now.sh/api"</span></pre><p id="2838" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有<code class="du ks kt ku kv b">https://</code>环节很重要。因为我使用的是<code class="du ks kt ku kv b">/api</code>端点，所以我也把它添加到了链接中。</p><p id="c894" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那都是乡亲们！现在你的电报机器人应该无服务器地回显你的信息。</p><p id="1a01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本教程的所有代码都可以在这里找到:<a class="ae kw" href="https://github.com/ohld/python-zeit-serverless-telegram-bot" rel="noopener ugc nofollow" target="_blank">https://github.com/ohld/python-zeit-serverless-telegram-bot</a></p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><p id="546d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的阅读！请在评论区问我任何问题。当然，请关注我获取更多信息！</p></div></div>    
</body>
</html>