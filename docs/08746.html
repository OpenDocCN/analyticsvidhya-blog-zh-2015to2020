<html>
<head>
<title>CI/CD Observability: Tekton + Prometheus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI/CD 可观察性:泰克顿+普罗米修斯</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/ci-cd-observability-tekton-prometheus-471606dcb564?source=collection_archive---------13-----------------------#2020-08-11">https://medium.com/analytics-vidhya/ci-cd-observability-tekton-prometheus-471606dcb564?source=collection_archive---------13-----------------------#2020-08-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ce18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2020 年 8 月 11 日<br/> ( <em class="jd">原载于</em><a class="ae je" href="https://ish-ar.io/tekton-and-prometheus/" rel="noopener ugc nofollow" target="_blank"><em class="jd">https://ish-ar . io</em></a><em class="jd">。)</em></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jf"><img src="../Images/76a24ea8b88d6bad66e583a79680ffea.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/0*gYVorFJp6g_kuM83.jpg"/></div></figure><p id="3796" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">亲爱的读者们，你们好，</p><p id="008a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天的文章是关于我用 Tekton CI/CD + Prometheus 做的一些实验。</p><p id="4f02" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">持续集成和部署正变得越来越热门——每个人都想要 100%自动化的、完美的、快速的代码集成和部署。</p><p id="caec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是一个团队或一家公司如何才能做到这一点呢？</p><p id="7298" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">通常</strong>是一个循序渐进的过程，而不是一个现成的安装解决方案(如果有，请告诉我！！；) ).</p><p id="74e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，指标将帮助您跟踪 CI/CD 的改进，并了解需要调整的内容。</p><p id="ce1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，如果您使用的是<strong class="ih hj"> Tekton </strong>，默认情况下会有一些非常有用的指标。</p><p id="c9e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">老实说，我找不到足够的关于 Tekton 公开的指标的文档。然而，经过几次实验，我列出了(在我看来)最有价值的指标。</p><p id="6913" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我准备的演示使用 Prometheus 作为后端来收集和显示指标，但是注意其他后端(比如 StackDriver/Cloud Monitoring)也是受支持的。</p><h1 id="251d" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Tekton CI/CD:有用的指标</h1><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kl"><img src="../Images/a0f5a6bb0abf2290d965989c20d317fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmyWLImUOEH9YyztvdoW_Q.png"/></div></div></figure><h1 id="767c" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Tekton 的一些有用的 PromQL 表达式:</h1><h2 id="5f31" class="kq jo hi bd jp kr ks kt jt ku kv kw jx iq kx ky kb iu kz la kf iy lb lc kj ld bi translated">管道运行持续时间</h2><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="a1bc" class="kq jo hi lf b fi lj lk l ll lm">tekton_pipelinerun_duration_seconds_sum{pipelinerun="app-ci-run-bzl48"} / tekton_pipelinerun_duration_seconds_count{pipelinerun="app-ci-run-bzl48"}</span></pre><h2 id="585a" class="kq jo hi bd jp kr ks kt jt ku kv kw jx iq kx ky kb iu kz la kf iy lb lc kj ld bi translated">管道运行持续时间趋势</h2><p id="472b" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated"><em class="jd">如果管道开始显示持续时间增加的趋势，该值也将增加。</em></p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="b825" class="kq jo hi lf b fi lj lk l ll lm">rate(tekton_pipelinerun_duration_seconds_sum{pipelinerun="xxx"}[5m]) / rate(tekton_pipelinerun_duration_seconds_count{pipelinerun="xxx"}[5m])</span></pre><h2 id="23b2" class="kq jo hi bd jp kr ks kt jt ku kv kw jx iq kx ky kb iu kz la kf iy lb lc kj ld bi translated">检查管道运行故障</h2><p id="78be" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated"><em class="jd">如果超过 15%的管道运行出现故障，本规则将适用</em></p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="807d" class="kq jo hi lf b fi lj lk l ll lm">tekton_pipelinerun_count{status="failed"} * 100 / ignoring(status) tekton_pipelinerun_count{status="success"} &gt; 15</span></pre><h2 id="6869" class="kq jo hi bd jp kr ks kt jt ku kv kw jx iq kx ky kb iu kz la kf iy lb lc kj ld bi translated">检查任务运行失败</h2><p id="c133" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated"><em class="jd">如果超过 15%的任务运行失败，该规则将适用</em></p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="638f" class="kq jo hi lf b fi lj lk l ll lm">tekton_taskrun_count{status="failed"} * 100 / ignoring(status) tekton_taskrun_count{status="success"} &gt; 15</span></pre><h2 id="b2bb" class="kq jo hi bd jp kr ks kt jt ku kv kw jx iq kx ky kb iu kz la kf iy lb lc kj ld bi translated">监控 Tekton 控制器</h2><p id="5c2d" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">以下两个指标更有可能暴露与 K8s 而非 Tekton 相关的问题:</p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="d8a7" class="kq jo hi lf b fi lj lk l ll lm">tekton_workqueue_adds_total -&gt; *It's the number of required actions per unit time. A high value could indicate problems in the cluster of some of the nodes.* </span><span id="c51e" class="kq jo hi lf b fi ls lk l ll lm">tekton_workqueue_depth -&gt; *It's the number of actions waiting in the queue to be performed. It should remain in low values.*</span></pre><p id="f7b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些都是非常基本的例子，你还可以用这些指标做其他很酷的事情。例如，您可以监控一个项目中分配了多少 pods/资源，用户在重试上浪费了多少时间，在延迟、pods 延迟、工作队列等方面浪费了多少秒！</p><p id="c5c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我看来，测量管道是每个想要转向数据驱动思维的公司都应该做的事情。</p><h1 id="9998" class="jn jo hi bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">如何设置 Tekton 使用 Prometheus</h1><p id="271a" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">如前所述，Tekton 自带 Prometheus 作为默认后端。用户只需确保 Tekton 配置上启用了指标。</p><p id="fe54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在安装 Tekton 管道控制器的名称空间中，有一个名为“observability”或“tekton…-observability”的配置映射。在 configmap 中，有一个配置，Knative/Tekton 控制器将使用它来公开指标。</p><p id="2d37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里解释一下可观测性配置:<a class="ae je" href="https://github.com/tektoncd/pipeline/blob/edc453934a183d44fde739dc24d6ca6b25cdeb6b/config/config-observability.yaml" rel="noopener ugc nofollow" target="_blank">https://github . com/tektoncd/pipeline/blob/EDC 453934 a 183d 44 FDE 739 DC 24 D6 ca 6b 25 CDE 6b/config/config-observability . YAML</a></p><p id="c197" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦配置了 Tekton，唯一缺少的是相关的服务监视器，它允许 Prometheus 操作者收集暴露的指标！</p><p id="6669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务监视器配置应该如下所示:</p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="5839" class="kq jo hi lf b fi lj lk l ll lm">apiVersion: monitoring.coreos.com/v1<br/>kind: ServiceMonitor<br/>metadata:<br/>  annotations:<br/>    meta.helm.sh/release-name: prometheus-operator-1595779515-custom-sm<br/>    meta.helm.sh/release-namespace: tekton-demo<br/>  generation: 1<br/>  labels:<br/>    app: prometheus-operator-tekton-pipeline-controller<br/>    app.kubernetes.io/managed-by: Helm<br/>    chart: prometheus-operator-8.15.6<br/>    heritage: Helm<br/>    release: prometheus-operator-1595779515<br/>  name: prometheus-operator-159577-tekton-pipeline-controller<br/>  namespace: tekton-demo<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app.kubernetes.io/instance: tekton-pipeline-1593528871<br/>      app.kubernetes.io/component: controller<br/>  endpoints:<br/>  - port: metrics<br/>    path: /metrics<br/>    interval: 15s</span></pre><p id="569f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以上就是我的全部内容，希望你喜欢今天的文章:)</p><p id="5320" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">干杯！</p></div></div>    
</body>
</html>