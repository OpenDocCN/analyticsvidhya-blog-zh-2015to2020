<html>
<head>
<title>Kafka, Drilled down to its bits</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卡夫卡，深入到它的位</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/kafka-drilled-down-to-its-bits-1fada1aa6fc1?source=collection_archive---------14-----------------------#2020-05-05">https://medium.com/analytics-vidhya/kafka-drilled-down-to-its-bits-1fada1aa6fc1?source=collection_archive---------14-----------------------#2020-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c7ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自从我开始软件工程师的职业生涯以来，已经有将近两年的时间了，这是我第一次遇到卡夫卡，谁知这家伙是个野兽。给定的参数太多，无法将其调整到最佳状态。在四处寻找了一个星期后，我想把它都写在一个地方。:-P</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/6b898ab2a971eeae14e220715d355c35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cOZD_WR0vmjPAUHK"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae jt" href="https://unsplash.com/@steve_j?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯蒂夫·约翰森</a>在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="1d52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">首先要明白为什么需要卡夫卡？</strong></p><p id="7fda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kafka用于实时数据流，做大数据或者做实时分析。它通常用作两个或多个微服务之间的数据连接桥</p><p id="f909" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将首先尝试清除卡夫卡作品中的所有术语，即主题、经纪人</p><ol class=""><li id="2d9b" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">Topic = A Topic的意思是<code class="du kd ke kf kg b">“about which something is said”.</code>，比如把Kafka看成一个数据库(只是说明一下)，Topic看成一个表格。</li><li id="c323" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">Producer = A <strong class="ih hj"> Kafka producer </strong>是一个应用程序，可以充当<strong class="ih hj"> Kafka </strong>集群中的数据源。一个<strong class="ih hj">制作人</strong>可以发布一个或多个<strong class="ih hj">卡夫卡</strong>主题的消息。</li><li id="a320" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">Broker = A <strong class="ih hj"> broker </strong>是一个<strong class="ih hj"> Kafka </strong>服务器。Kafka broker允许消费者通过主题、分区和偏移量获取消息。</li><li id="5927" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">Partition =代理中的数据按分区划分，用于并行处理。(这个我们后面会详细讲)</li><li id="bd90" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">偏移量= T21偏移量是一个简单的整数，卡夫卡用它来保持消费者的当前位置</li></ol><p id="c417" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">卡夫卡给出了一些高层次的保证</p><ol class=""><li id="e537" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">由生产者发送到特定主题分区的消息将按照发送的顺序被附加。也就是说，如果记录M1与记录M2由同一个制作人发送，并且M1被首先发送，那么M1将具有比M2更低的偏移量，并且在日志中出现得更早。</li><li id="4d8c" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">使用者实例按照记录在日志中的存储顺序查看记录。</li><li id="b273" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">对于复制因子为N的主题，我们最多可以容忍N-1个服务器故障，而不会丢失任何提交到日志中的记录。(这方面有几个例外)</li></ol><p id="1133" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">卡夫卡有三个部分:</p><ol class=""><li id="597a" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">生产者</li><li id="f742" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated"><a class="ae jt" rel="noopener" href="/@alpitanand20/kafka-drilled-down-to-its-bits-e28df4700ec6">经纪人</a>(文章的第二部分)</li><li id="0758" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">消费者</li></ol><p id="d7a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这一点上，我们将试图了解卡夫卡的第一部分<strong class="ih hj">制片人</strong>。</p><p id="e8a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是制作人？</strong></p><p id="d03c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它只是一个通过使用producer api向Kafka集群发送数据或消息的应用程序。无论我们发送什么数据，对卡夫卡来说都只是一个字节数组。假设我们在数据库中有一个orders表，表中的每一行都对应一条消息，您可以使用Kafka producer API将消息发送到Kafka Orders主题。</p><blockquote class="km kn ko"><p id="91f6" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated"><strong class="ih hj">生产者的消息大小限制:</strong></p><p id="bc3b" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated">开箱即用，一个代理最多可以处理1 MB，(略小于1 mb)，如果你真的需要增加消息大小，你必须调整，<em class="hi"> message.max.bytes </em></p></blockquote><p id="a8b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，生产者不会等待来自代理的任何类型的确认，但是它可以根据需要进行配置，假设一个Kafka集群有3个副本代理。</p><p id="42b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似这样的。(图片来自dzone)</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kt"><img src="../Images/d0e9af468f19e01eb1cecf4b3f7bd49e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VeNoYQSlz38eE1jim18jjg.png"/></div></div></figure><p id="cc85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里，在映像中，ISR是同步副本</p><p id="6e56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主要有3种类型的ACK(确认)。</p><ol class=""><li id="4c78" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">ACK = 0，生产者不会等待任何类型的确认。在这种情况下，不能保证经纪人收到了记录。重试配置不会生效，因为没有办法知道是否发生了任何故障。</li><li id="a9e1" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">ACK = 1，一旦记录被代理写入，代理就会给出一个确认。但是，它不会等待复制完成。这意味着，如果在复制完成之前，引导程序(稍后将详细介绍引导程序部分)发生故障，记录将会丢失。</li><li id="033e" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">ACK = all or -1，all or -1 →一旦记录被代理写入并在所有跟随者中同步，代理就给予确认。这种模式，当与config<strong class="ih hj"><em class="kp">min . in sync . replicas</em></strong>结合使用时，提供高耐久性。它定义了必须确认写入才能认为写入成功的最小复制副本数量。</li></ol><blockquote class="km kn ko"><p id="c729" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated">考虑以下情况<br/>代理数量= 3 <br/>复制因子= 3 <br/> min.insync.replicas = 2(这包括leader)<br/>ack = all<br/>你只能容忍一个代理宕机。如果一个以上的代理关闭，则抛出<strong class="ih hj">notenoughpreplicas</strong>或<strong class="ih hj">notenoughpreplicasafterappend</strong>异常。</p></blockquote><p id="7575" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在真实的场景中，即使数据在代理上提交，您的Kafka生成器也很有可能没有收到确认(可能是由于网络故障)并重试请求。在这种情况下，存在数据的重复。为了处理这种情况，您需要使您的生产者幂等。<br/>让您的生产者幂等就像设置配置<strong class="ih hj"> enable.idempotence = true一样简单。</strong></p><p id="71eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是这是如何工作的呢？</p><p id="61e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个生产者都被分配了一个生产者Id (PID ),并且每次它向代理发送消息时都会包含它的PID。此外，每条消息都有一个递增的序列号(SqNo)。在代理端，每个主题分区都有另一个序列。代理跟踪每个分区的最大PID-SqNo组合。当收到较低的序列号时，它将被丢弃。</p><p id="ea6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，生产者如何决定向哪个分区发送数据，比如主题可能被分成10个分区，它应该从哪个分区开始发送数据？</p><p id="c45c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">生产者向Kafka代理请求关于哪个Kafka代理具有哪个主题分区领导的元数据，因此不需要路由层。这个领导数据允许生产者将记录直接发送给Kafka代理分区领导(稍后将详细介绍代理分区领导)。</p><blockquote class="km kn ko"><p id="7883" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated">目前，只需了解每个分区副本都有一个分区领导者，并且每个分区副本都存在于不同的代理中</p></blockquote><p id="9182" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有两种方法可以将数据发送到主题中的分区。</p><ol class=""><li id="8b73" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">循环法</li><li id="4148" class="ju jv hi ih b ii kh im ki iq kj iu kk iy kl jc jz ka kb kc bi translated">将数据发送到特定分区的基于哈希的键。</li></ol><blockquote class="km kn ko"><p id="5650" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated">循环赛的定义？</p><p id="c72a" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated">为了公平地调度进程，循环调度器通常采用分时方式，给每个任务分配一个时隙或时间量[4](分配给CPU的时间)，如果任务没有完成，就中断任务。下次为该进程分配时隙时，作业将继续。如果进程在其指定的时间段内终止或将其状态更改为等待，调度程序将选择就绪队列中的第一个进程来执行。在没有时间共享的情况下，或者如果量程相对于作业的大小来说很大，那么产生大量作业的进程会比其他进程更受青睐。</p></blockquote><p id="87d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在循环法中，根据循环法选择分区，因为首先在分区0中发送消息，然后在分区1、分区2中发送，以此类推，再次发送到分区0。</p><p id="8841" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，在生产者和消费者的基于散列的键-值对中，具有相同键的记录被发送到相同的分区，确保每个分区中消息的顺序，有点像下图中的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ku"><img src="../Images/7baf6faaf50e246914ee199500bc0f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p33HggYGiunT5tKdaO6CFQ.png"/></div></div></figure><p id="8ee3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">生产者中的批处理是什么？</strong></p><p id="02c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">术语批处理简单地说是指在发送给代理之前累积消息。</p><p id="8995" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据按主题的每个分区累积在一个缓冲区中。数据根据生成器批次大小属性分组到批次中。主题中的每个分区都有一个单独的累加器/缓冲区。</p><p id="ebee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">kakfa producer的缓冲存储器= 32 mb</p><p id="9c29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">两个参数对于延迟和吞吐量特别重要:批量大小和逗留时间。</p><p id="c81c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kp"> batch.size = </em> </strong>以总字节数而不是消息数来衡量批量大小。它控制在向Kafka代理发送消息之前收集多少字节的数据。在不超过可用内存的情况下，尽可能将该值设置得高一些。默认值为16384字节</p><p id="81b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"><em class="kp">linger . ms</em>=</strong>linger . ms设置添加了一个延迟，以等待更多记录的建立，因此会发送更大的批次。增加linger.ms以生产者延迟为代价增加代理吞吐量。如果生产者获得的记录的大小为batch.size或更大，那么它会被立即发送。如果Producers获得的值小于batch.size，但经过了linger.ms间隔，则发送该分区的记录。增加linger.ms以提高代理的吞吐量，降低代理负载(常见改进)。</p><p id="30bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">压缩式生产者？</strong></p><p id="4d39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="kp"> compression.type </em> </strong>默认为none，该设置设置为none、gzip、snappy或lz4，我们可以将该设置更改为向代理发送更小的数据(更少的带宽)。</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="be6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唷，这是一篇相当大的文章，但是它大概涵盖了生产者的所有重要概念。</p><p id="53b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">文章的第二部分，关于<a class="ae jt" rel="noopener" href="/@alpitanand20/kafka-drilled-down-to-its-bits-e28df4700ec6"> <strong class="ih hj">经纪人</strong> </a>就在这里</p><p id="f854" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的下一篇文章中，我将很快写下关于消费者的内容。</p><blockquote class="km kn ko"><p id="6803" class="if ig kp ih b ii ij ik il im in io ip kq ir is it kr iv iw ix ks iz ja jb jc hb bi translated">请鼓掌。:-)，会喜欢反馈的。</p></blockquote></div></div>    
</body>
</html>