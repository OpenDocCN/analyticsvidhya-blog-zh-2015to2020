<html>
<head>
<title>Deploy your ML models using 5 easy steps with Azure Machine Learning Workspace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure机器学习工作区的5个简单步骤部署您的ML模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploy-your-ml-models-using-5-easy-steps-with-azure-machine-learning-workspace-c1ca5b6aa284?source=collection_archive---------12-----------------------#2020-01-24">https://medium.com/analytics-vidhya/deploy-your-ml-models-using-5-easy-steps-with-azure-machine-learning-workspace-c1ca5b6aa284?source=collection_archive---------12-----------------------#2020-01-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/82dd5ac048e934be4b463180155ba194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jPDkwLvaHM7YMdqba2taiw.jpeg"/></div></div></figure><p id="cab7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你正在读这篇文章，你要么已经开始了旅程，要么已经绝望了。好了，现在你有了最棒的机器学习模型，现在你可以预测股票市场了。你就要成为百万富翁了。但为了实现这一点，还有最后一个障碍需要跨越，那就是部署你的模型，也就是你的印钞机(简称MP)。</p><p id="f115" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这一点上，你还决定使用云平台，因为你想让它不断运行，因为你知道…钱不会睡觉。所以，明智的选择。让我们把这个云叫做微软Azure。你做了一点阅读，找到了你想要的东西，Azure Machine Learning Workspace(简称AMLW读作Am-low)。好吧，我们离你的百万富翁越来越近了，我们真的很近了。有多近？大约五步之遥。所以让我们得到这笔钱。</p><h1 id="e266" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤0:包含您的库</h1><p id="6bb0" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">作为程序员，我们总是从0开始。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="ff62" class="la jp hi kw b fi lb lc l ld le">#included libraries<br/>import azureml.core<br/>from azureml.core import Workspace, Dataset, Model, Webservice, Environment<br/>from azureml.core.conda_dependencies import CondaDependencies<br/>import json<br/>import pandas as pd</span><span id="251b" class="la jp hi kw b fi lf lc l ld le">#check the azureml core being used<br/>azureml.core.VERSION</span></pre><h1 id="4e9d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤1:初始化工作区</h1><p id="5542" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">当您使用Workspace.from_config()命令时，它会连接到笔记本所在的工作区。如果笔记本不在同一工作区，请手动指定工作区。我在这里包含了这两个选项。</p><p id="1bff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选项1:从配置</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="ae26" class="la jp hi kw b fi lb lc l ld le">#inititalise workspace from config<br/>ws = Workspace.from_config()<br/>print(ws.name, ws.resource_group, ws.location, ws.subscription_id, sep=’\n’)</span></pre><p id="e609" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选项2:手动初始化</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="3ebc" class="la jp hi kw b fi lb lc l ld le">#initialise workspace manually<br/>subscription_id = ‘&lt;enter user subscription Id&gt;’<br/>resource_group = ‘&lt;name of resource group&gt;’<br/>workspace_name = ‘&lt;name of azure machine learning resource name&gt;’</span><span id="d1bc" class="la jp hi kw b fi lf lc l ld le">ws = Workspace(subscription_id, resource_group, workspace_name)<br/>print(ws.name, ws.resource_group, ws.location, ws.subscription_id, sep=’\n’)</span></pre><h1 id="7cf4" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤2:连接到注册的模型</h1><p id="ee98" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这一步假设模型已经被登记到模型存储中。如果这个假设是错误的，我需要把事情保持在5个步骤，所以你可以在这里找到细节<a class="ae lg" href="https://docs.microsoft.com/en-us/python/api/azureml-ore/azureml.core.model.model?view=azure-ml-py" rel="noopener ugc nofollow" target="_blank"/></p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="919a" class="la jp hi kw b fi lb lc l ld le">#Connect to model<br/>modelname = ‘&lt;name of model&gt;’<br/>model = Model(ws,modelname)<br/>print(‘model name: ‘, model)</span></pre><h1 id="da29" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤3:初始化环境</h1><p id="884a" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这是模型将要运行的容器。所以这可以是Kubernetes或者Azure容器实例(ACI)。对于运行在少量数据上的模型，我推荐使用ACI。否则，使用Kubernetes选项。同样，在这里可以找到关于不同环境<a class="ae lg" href="https://docs.microsoft.com/en-us/azure/machine-learning/how-to-deploy-and-where#deploy-to-target" rel="noopener ugc nofollow" target="_blank">的更多细节。</a></p><h2 id="f295" class="la jp hi bd jq lh li lj ju lk ll lm jy jb ln lo kc jf lp lq kg jj lr ls kk lt bi translated">这一步声明了您的模型可能需要的所有依赖项。可以认为这是为您的模型安装的pip</h2><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="9d7c" class="la jp hi kw b fi lb lc l ld le">#Initialise the environment (pip packages to be installed, example shown below)<br/>environment = Environment(‘&lt;User chosen name&gt;’)<br/>environment.python.conda_dependencies = CondaDependencies.create(pip_packages=[<br/> ‘azureml-defaults’,<br/> ‘inference-schema[numpy-support]’,<br/> ‘joblib’,<br/> ‘scikit-learn’,<br/> ‘numpy==1.16.4’,<br/> ‘tensorflow==1.14’<br/>])</span></pre><p id="6ea9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请伙计们，非常重要的是，确保库版本与用于训练模型的库版本<strong class="is hj">完全</strong>相同。如果没有，你可能会得到一个502错误，这可能是误导性的，并可能花费你生命中的几个小时…我想你可以告诉，我已经经历了火灾。</p><h1 id="d5da" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤4:创建/导入score.py文件</h1><p id="e0a4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">分数文件基本上是在容器中运行模型的文件。因此，当数据被发送到部署的模型时，任何预处理或后处理步骤都可以在这个文件中完成。</p><p id="64a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我使用Spyder创建了score.py文件，但是，您可以使用您喜欢的文件，但是它必须是. py格式</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="9630" class="la jp hi kw b fi lb lc l ld le">#create a score file variable as this is referenced in the deployment in step 5<br/>score_file = ‘&lt;name of score file&gt;’</span></pre><p id="a9a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可能在想，但是这个文件在哪里？事不宜迟…</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="795d" class="la jp hi kw b fi lb lc l ld le">import joblib<br/>import os<br/>import json</span><span id="63b3" class="la jp hi kw b fi lf lc l ld le">#model specific libraries<br/>import numpy as np <br/>import pandas as pd</span><span id="2427" class="la jp hi kw b fi lf lc l ld le">def init():<br/> ‘’’This function initialises the model. The model file is retrieved used<br/> within the script.<br/> ‘’’<br/> global model <br/> <br/> model_filename = ‘&lt;name of model file (.sav or .pkl)&gt;’<br/> model_path = os.path.join(os.environ[‘AZUREML_MODEL_DIR’], model_filename)<br/> <br/> model = joblib.load(model_path)<br/> <br/>#===================================================================<br/>#Function definitions<br/>#===================================================================<br/> <br/># Convert Series Data into Supervised Data<br/>def functions(parameter):<br/> ‘’’<br/> Define functions neeeded in your model. If not needed, remove this part<br/> ‘’’</span><span id="ad3e" class="la jp hi kw b fi lf lc l ld le">#Run function</span><span id="57ee" class="la jp hi kw b fi lf lc l ld le">def run(data):<br/> ‘’’<br/> Input the data as json and returns the predictions in json. All preprocessing <br/> steps are specific to this model and usecase<br/> ‘’’<br/> #input data<br/> raw = pd.read_json(data) <br/> <br/> #preprocessing steps <br/> <br/> #prediction steps <br/> pred = model.predict(data)<br/> <br/> #postprocessing steps</span><span id="e3f3" class="la jp hi kw b fi lf lc l ld le"> <br/> #packaging steps<br/> <br/> result = pred.to_json()<br/> <br/> # You can return any JSON-serializable object.<br/> return result</span></pre><p id="53c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用下面的代码检查分数文件，以确保使用了正确的代码。我想安全总比后悔好。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="abf3" class="la jp hi kw b fi lb lc l ld le">#inspect the score script to ensure the correct script is being referenced<br/>with open(score_file) as f:<br/>    print(f.read())</span></pre><h1 id="43c0" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤5:将模型部署到环境中(将所有的东西放在一起)</h1><p id="feb9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">每次运行这个步骤都需要一些时间。所以在你等待的时候，花点时间煮点咖啡吧。不过，加快速度的一个方法是在本地机器上部署docker容器，然后在将其推送到ACI之前在那里进行调试。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="659a" class="la jp hi kw b fi lb lc l ld le">#deploy model to ACI<br/>from azureml.core import Webservice<br/>from azureml.core.model import InferenceConfig<br/>from azureml.exceptions import WebserviceException</span><span id="91eb" class="la jp hi kw b fi lf lc l ld le">#name given here will be the name of the deployed service<br/>service_name = ‘&lt;name of the deployed service&gt;’</span><span id="00e3" class="la jp hi kw b fi lf lc l ld le"># Remove any existing service under the same name.<br/>try:<br/> Webservice(ws, service_name).delete()<br/>except WebserviceException:<br/> pass</span><span id="2455" class="la jp hi kw b fi lf lc l ld le">inference_config = InferenceConfig(entry_script= score_file,<br/> source_directory=’.’,<br/> environment=environment)</span><span id="8d57" class="la jp hi kw b fi lf lc l ld le">service = Model.deploy(ws, service_name, [model], inference_config)<br/>service.wait_for_deployment(show_output=True)</span></pre><p id="3638" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就是这样！您的容器应该部署到您的资源组中，并且应该在AMLW模型存储中创建一个REST端点。</p><p id="5aeb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但除此之外…钱！</p><h1 id="41cf" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">不是步骤0:测试</h1><p id="8ebb" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在，我知道我说了5个步骤，但这只是测试，以确保一切正常。</p><p id="882a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们将连接到AMLW中的一个数据存储。有趣的事实是，这些数据集既可以手动加载到工作区，也可以引用数据存储，并在源位置连接数据，我认为这非常酷！aaaannnyyywaayy…我们继续</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="65b6" class="la jp hi kw b fi lb lc l ld le">#connect to dataset<br/>dataset = Dataset.get_by_name(ws, name=’&lt;Name of dataset in AMLW&gt;’)<br/>dataset = dataset.to_pandas_dataframe()</span></pre><p id="5d6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用您部署的模型，输入数据需要是JSON格式，然后输入到您的模型中。您可以使用下面的代码来打包并运行您的模型。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="38cc" class="la jp hi kw b fi lb lc l ld le">#package and run input data to model</span><span id="e564" class="la jp hi kw b fi lf lc l ld le">#input data<br/>input_data = dataset.to_json()</span><span id="44f7" class="la jp hi kw b fi lf lc l ld le">#run model<br/>pred = service.run(input_data)</span><span id="f393" class="la jp hi kw b fi lf lc l ld le">#Convert returned json back to a pandas dataframe<br/>pred = pd.read_json(pred)</span></pre><h1 id="a19c" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">不是步骤1:使用端点</h1><p id="a2ea" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">一旦部署了模型，就会创建一个REST端点，并且可以在您的其他平台中使用。下面的代码可以用在Databricks或其他Python环境中。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="0722" class="la jp hi kw b fi lb lc l ld le">import requests<br/>import json</span><span id="c788" class="la jp hi kw b fi lf lc l ld le"># URL for the web service<br/>scoring_uri = ‘&lt;Your deployment enpoint&gt;’<br/># If the service is authenticated, set the key or token<br/>key = ‘&lt;your key or token&gt;’</span><span id="035f" class="la jp hi kw b fi lf lc l ld le"># Convert to JSON string<br/>input_data = dataset.to_json()</span><span id="2402" class="la jp hi kw b fi lf lc l ld le"># Set the content type<br/>headers = {‘Content-Type’: ‘application/json’}<br/># If authentication is enabled, set the authorization header<br/>headers[‘Authorization’] = f’Bearer {key}’</span><span id="641b" class="la jp hi kw b fi lf lc l ld le"># Make the request and display the response<br/>resp = requests.post(scoring_uri, input_data, headers=headers)<br/>print(resp.text)</span><span id="35d0" class="la jp hi kw b fi lf lc l ld le">#load the returned prediction and read it into a pandas dataframe<br/>pred = json.loads(resp.text)<br/>pred = pd.read_json(pred)</span></pre></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="8a36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">故事就是这样。我认为这有点长，但公平地说，它的大部分是代码，所以如果我们仔细想想，它真的不算数。我应该提到，在AMLW GitHub和docs页面上可以找到很多这样的内容。如果你确实想学习更专业的东西，我建议你深入学习。那里有一些令人惊奇的东西，例如这里的<a class="ae lg" href="https://github.com/Azure/MachineLearningNotebooks/tree/master/how-to-use-azureml" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="f0a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我感谢你的阅读！享受你新发现的财富。</p></div></div>    
</body>
</html>