<html>
<head>
<title>How to create a tensorflow custom operation with gpu support (how to overcome some build errors using docker)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在gpu支持下创建tensorflow自定义操作(如何使用docker克服一些构建错误)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-create-a-tensorflow-custom-operation-with-gpu-support-how-to-overcome-some-build-errors-2cd12ffeb236?source=collection_archive---------15-----------------------#2020-01-03">https://medium.com/analytics-vidhya/how-to-create-a-tensorflow-custom-operation-with-gpu-support-how-to-overcome-some-build-errors-2cd12ffeb236?source=collection_archive---------15-----------------------#2020-01-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/b429a5d694452c34b69805c3d5e2ff2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*QLvZzPvNge4ivYabLXis7w.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated"><a class="ae iq" href="https://www.google.com/url?sa=i&amp;source=images&amp;cd=&amp;ved=2ahUKEwjjvdO7m-zmAhUtxoUKHYadBZEQjhx6BAgBEAI&amp;url=https%3A%2F%2Fwww.tensorflow.org%2Ftutorials%2Fcustomization%2Fperformance&amp;psig=AOvVaw1pPIe0xp8KTfM-NYpryVC7&amp;ust=1578305262082985" rel="noopener ugc nofollow" target="_blank"> tensorflow自定义操作</a></figcaption></figure><p id="d02f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi jp translated"><span class="l jq jr js bm jt ju jv jw jx di"> T </span>他的教程并不是构建定制操作的完整教程，但是它可以帮助你避免一些构建错误。Tensorflow自定义操作有两个关于制作tensorflow操作的官方教程:<a class="ae iq" href="https://www.tensorflow.org/guide/create_op" rel="noopener ugc nofollow" target="_blank">创建操作</a>和<a class="ae iq" href="https://github.com/tensorflow/custom-op" rel="noopener ugc nofollow" target="_blank">使用docker图像创建pip包</a>。您可能会在这两个教程中找到所有问题的答案。不幸的是，事实并非如此。这些教程对于初学者来说并不像我想象的那么容易理解和详尽。事实上，使用docker，用c++、cuda和tensorflow预制函数编程，手动链接或用bazel链接，最后用python测试是一项压力很大的任务。所以大概用@tf.function对你的时间管理和心理健康会好很多。事实上，在完成这项任务之前，我每天都在做这件事，做了一个月。</p><div class="jz ka kb kc fd ab cb"><figure class="kd ij ke kf kg kh ki paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><img src="../Images/827f432227bfa5d3863eb27fd6babdcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:342/format:webp/1*8ni-eXNRYSmvnmTUWgxvTQ.png"/></div></figure><figure class="kd ij kn kf kg kh ki paragraph-image"><img src="../Images/b7fda74a8a885a9fa4ffd576004831bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*vvwp7d31yI3PQ0mrXv7NYw.png"/></figure><figure class="kd ij ko kf kg kh ki paragraph-image"><img src="../Images/c803da107e07f0122a563c04b13b995f.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*FsuU9l7-RVeUVxPzveIoDQ.jpeg"/></figure></div><p id="1b8c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">然而，如果您决定使用自定义操作，我可以提供一些帮助，告诉您应该遵循的一些命令。此外，如果您想进行tensorflow自定义操作，我强烈建议您使用docker图像。这个<strong class="it hj"> docker </strong>图像应该与您将在项目中使用的tensorflow兼容。例如，我使用了<strong class="it hj">tensor flow tensor flow:devel-GPU-py3</strong>。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kp"><img src="../Images/37009d859791d5d1520ca31050a272e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oLxD7ayzJ0ybOcy--_1Frw.png"/></div></div></figure><p id="2325" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">对我来说，主要的挑战是我在。cc或. cu.cc文件中。这些文件基本上来自<strong class="it hj">tensor flow/core/framework</strong>和<strong class="it hj">tensor flow/core/common _ runtime/GPU</strong>。事实上，问题是共享库文件成功创建，但导致了奇怪的错误，如<strong class="it hj"> <em class="jy">分段错误</em> </strong>和<strong class="it hj"> <em class="jy">找不到一些cudnn文件</em> </strong>总之，我会尽可能简单地解释我所做的步骤。</p><p id="647a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">首先，从克隆tensorflow存储库开始。我遵循这个指南<a class="ae iq" href="https://www.tensorflow.org/install/source" rel="noopener ugc nofollow" target="_blank">从源代码</a> <strong class="it hj"> </strong>来帮助我做到这一点。事实上，您只需要执行以下命令:</p><pre class="jz ka kb kc fd kq kr ks kt aw ku bi"><span id="e75c" class="kv kw hi kr b fi kx ky l kz la"><em class="jy">git clone </em><a class="ae iq" href="https://github.com/tensorflow/tensorflow.git" rel="noopener ugc nofollow" target="_blank"><em class="jy">https://github.com/tensorflow/tensorflow.git</em></a></span><span id="acba" class="kv kw hi kr b fi lb ky l kz la"><em class="jy">cd tensorflow</em></span><span id="4d3f" class="kv kw hi kr b fi lb ky l kz la"><em class="jy">git checkout r2.0 (you should take your time and know what branch you want to chose. Chose the branch that you will install in your python project.)</em></span></pre><p id="2e55" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">准备好张量流分布之后，我们继续准备docker图像，我们将使用它来构建我们的操作。这个docker图像不是必须的，但是tensorflow的配置是一个非常微妙和烦人的事情。所以强烈推荐使用。你可能需要花几个小时来理解<a class="ae iq" href="https://www.tensorflow.org/install/docker" rel="noopener ugc nofollow" target="_blank"> <strong class="it hj"> docker </strong> </a>是如何工作的，但这是一件值得学习的事情。如果你的操作支持gpu，你需要安装<a class="ae iq" href="https://github.com/NVIDIA/nvidia-docker" rel="noopener ugc nofollow" target="_blank"> <strong class="it hj"> nvidia-docker </strong> </a>。您必须选择一个与您选择的分支兼容的docker映像。</p><p id="b6f0" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">然后运行docker容器并将其挂载到tensorflow目录:</p><pre class="jz ka kb kc fd kq kr ks kt aw ku bi"><span id="5503" class="kv kw hi kr b fi kx ky l kz la">docker run — runtime=nvidia -it -w /tensorflow -v $PWD:/tensorflow -e HOST_PERMS=”$(id -u):$(id -g)” tensorflow/tensorflow:devel-gpu-py3 bash</span><span id="4ab9" class="kv kw hi kr b fi lb ky l kz la">./configure</span></pre><p id="db7d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">组织你的代码最好的方法就是在<strong class="it hj">/tensor flow/core/user _ ops/</strong>中做一个目录，命名为:<strong class="it hj">tensor flow _ operation _ name</strong>。代码可以这样组织:</p><pre class="jz ka kb kc fd kq kr ks kt aw ku bi"><span id="effc" class="kv kw hi kr b fi kx ky l kz la">├── tensorflow_operation_name # A GPU op</span><span id="e800" class="kv kw hi kr b fi lb ky l kz la">│ ├── cc</span><span id="874d" class="kv kw hi kr b fi lb ky l kz la">│ │ ├── kernels # op kernel implementation</span><span id="d603" class="kv kw hi kr b fi lb ky l kz la">│ │ │ |── operation_name.h</span><span id="e5f7" class="kv kw hi kr b fi lb ky l kz la">│ │ │ |── operation_name.cc</span><span id="b052" class="kv kw hi kr b fi lb ky l kz la">│ │ │ └── operation_name.cu.cc # GPU kernel</span><span id="338f" class="kv kw hi kr b fi lb ky l kz la">│ │ └── ops # op interface definition</span><span id="5817" class="kv kw hi kr b fi lb ky l kz la">│ │ └── operation_name_ops.cc</span><span id="2fae" class="kv kw hi kr b fi lb ky l kz la">│ ├── python</span><span id="c6c1" class="kv kw hi kr b fi lb ky l kz la">│ │ ├── ops</span><span id="755a" class="kv kw hi kr b fi lb ky l kz la">│ │ │ ├── __init__.py</span><span id="de16" class="kv kw hi kr b fi lb ky l kz la">│ │ │ ├── operation_name_ops.py # Load and extend the ops in python</span><span id="072d" class="kv kw hi kr b fi lb ky l kz la">│ │ │ └── operation_name_ops_test.py # tests for ops</span><span id="d12d" class="kv kw hi kr b fi lb ky l kz la">│ │ └── __init__.py</span><span id="389a" class="kv kw hi kr b fi lb ky l kz la">| |</span><span id="7f54" class="kv kw hi kr b fi lb ky l kz la">│ ├── BUILD # BUILD file</span></pre><p id="7f1a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">本教程不会考虑测试部分，也不会把操作变成pip可安装操作。所以所有的__init__。py和operation_name_ops_test.py都将保持为空，如果你真的想实现那些特性，可以参考开头提到的两个教程。</p><p id="56bc" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在，您必须以一种有组织的方式将代码放入这些文件中。如果你不知道怎么做，那就花点时间从这里的<a class="ae iq" href="https://github.com/tensorflow/custom-op" rel="noopener ugc nofollow" target="_blank">复制代码</a>或者从这里的<a class="ae iq" href="https://www.tensorflow.org/guide/create_op" rel="noopener ugc nofollow" target="_blank">复制代码</a>。如果你不熟悉c++、cuda，这个任务将会很难完成。问题是，你必须使用预定义的张量流代码添加到这两种编码语言中，这使得任务更加复杂。</p><p id="dd40" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">成功完成所有这些步骤后，您现在需要完成构建文件。如果您的操作仅使用来自<strong class="it hj"> third_party/eigen3 </strong>、<strong class="it hj">tensor flow/core/framework</strong>、<strong class="it hj">tensor flow/core/platform</strong>、<strong class="it hj"> tensorflow/core/util </strong>和<strong class="it hj"> tensorflow/core/lib </strong>的文件，此代码应该工作正常:</p><p id="5b5c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">张量流_操作_名称/版本:</p><pre class="jz ka kb kc fd kq kr ks kt aw ku bi"><span id="acf6" class="kv kw hi kr b fi kx ky l kz la">package(default_visibility = ["//visibility:public"])</span><span id="3b7e" class="kv kw hi kr b fi lb ky l kz la">load("//tensorflow:tensorflow.bzl", "tf_custom_op_library")</span><span id="b6d1" class="kv kw hi kr b fi lb ky l kz la">tf_custom_op_library(</span><span id="4b0d" class="kv kw hi kr b fi lb ky l kz la">name = 'python/ops/_operation_name_ops.so',</span><span id="d265" class="kv kw hi kr b fi lb ky l kz la">srcs = ["cc/kernels/operation_name.h",</span><span id="7050" class="kv kw hi kr b fi lb ky l kz la">"cc/kernels/operation_name.cc",</span><span id="d582" class="kv kw hi kr b fi lb ky l kz la">"cc/ops/operation_name_ops.cc",],</span><span id="2dd8" class="kv kw hi kr b fi lb ky l kz la">gpu_srcs = ["cc/kernels/operation_name.cu.cc", "cc/kernels/operation_name.h"],<br/>)</span></pre><p id="0c6e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果您正在使用来自<strong class="it hj">tensor flow/core/common _ runtime</strong>的其他文件或任何其他文件，您应该查找包含该文件的适当规则，并将其放入构建文件的deps中。比如我收录:<em class="jy">deps =[" @ cub _ archive//:cub "]</em>因为我用的是cub目录。再比如，我在包含了<strong class="it hj">tensor flow/core/common _ runtime/GPU</strong>目录下的文件后，添加了<em class="jy">deps =["//tensor flow/core:GPU _ headers _ lib "]</em>。您必须理解，不包含您的依赖项可能会导致异常行为，例如分段错误和构建错误。如果你包含了多个文件，我建议你了解一下<a class="ae iq" href="https://docs.bazel.build/versions/master/tutorial/cpp.html" rel="noopener ugc nofollow" target="_blank"> bazel </a>是如何工作的。</p><p id="cf4e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在剩下的就是建造你的图书馆了。此构建指令适用于gcc&gt;=5。</p><pre class="jz ka kb kc fd kq kr ks kt aw ku bi"><span id="9a9b" class="kv kw hi kr b fi kx ky l kz la">bazel build — config=opt — config=cuda — cxxopt=”-D_GLIBCXX_USE_CXX11_ABI=0" //tensorflow/core/user_ops/tensorflow_operation_name:python/ops/_operation_name_ops.so</span></pre><p id="7645" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果没有编译错误，结果文件将会在某个bazel目录中构建。只需执行这个命令，就可以获得。所以文件:</p><pre class="jz ka kb kc fd kq kr ks kt aw ku bi"><span id="8849" class="kv kw hi kr b fi kx ky l kz la">find / -iname _operation_name_ops.so</span></pre><p id="1358" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">找到您的文件后，您现在可以在python中使用<em class="jy">tensor flow . python . framework . load _ library(path _ to _)包含并使用它。然后测试你的操作，希望一切正常！</em></p></div></div>    
</body>
</html>