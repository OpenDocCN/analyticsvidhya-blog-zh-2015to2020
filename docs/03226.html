<html>
<head>
<title>Google Analytics Multi-Channel Funnel Data Extraction using API in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python中的API进行Google Analytics多渠道漏斗数据提取</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/google-analytics-multi-channel-funnel-data-extraction-using-api-in-python-bb8ed137b39f?source=collection_archive---------8-----------------------#2020-01-21">https://medium.com/analytics-vidhya/google-analytics-multi-channel-funnel-data-extraction-using-api-in-python-bb8ed137b39f?source=collection_archive---------8-----------------------#2020-01-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/55a8c59c96e043ce2b62814fdca1588d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vld3KrVCJhm3wqtwa0zwmQ.png"/></div></div></figure><div class=""/><p id="c399" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上一篇文章中，我在<a class="ae jo" href="https://www.linkedin.com/pulse/google-analytics-data-extraction-using-api-inpython-sheranga-gamwasam/" rel="noopener ugc nofollow" target="_blank">上解释了如何使用python </a>提取谷歌分析数据，因为谷歌分析被数字营销人员、数据分析师和数字分析师用来通过查看报告来获得一些洞察力，从而发展他们的业务。</p><p id="c75b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌分析标准报告是基于最后一个cookie的基础上，这意味着他们给信贷的最后一个渠道，用户已经转换。但是一个典型的网站访问者在转化之前会经历多种渠道(有机的、付费搜索、社交媒体、横幅广告等)。因此，要查看网站访问者的旅程，我们使用多渠道漏斗报告。</p><p id="54f0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天，我将讲述通过Python中的API从多渠道漏斗中提取数据的步骤。</p><p id="4aa4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一步是在谷歌开发者控制台中创建一个项目，获取<strong class="is hu">客户端id、客户端机密</strong>，并启用<strong class="is hu">谷歌分析报告API </strong>和<strong class="is hu">分析API </strong>。</p><p id="a6a6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">演示如何创建项目的视频链接</em> ( <a class="ae jo" href="https://youtu.be/533nliQZWEg" rel="noopener ugc nofollow" target="_blank">在开发人员控制台</a>中创建项目)</p><p id="2aee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">获得客户端id和客户端密码后的下一步是身份验证。这一步包括从有权访问谷歌分析账户的gmail账户获得许可。此后，谷歌将提供一个独特的刷新令牌。使用唯一的刷新令牌，可以获得属于gmail帐户的Google analytics数据。</p><p id="1a97" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">导入以下库</em></p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="1649" class="jz ka ht jv b fi kb kc l kd ke">from oauth2client.client import OAuth2WebServerFlow<br/>from oauth2client.tools import run_flow<br/>from oauth2client.file import Storage<br/>import json<br/>import os<br/>import re<br/>import httplib2 <br/>from oauth2client import GOOGLE_REVOKE_URI, GOOGLE_TOKEN_URI, client<br/>import requests<br/>import pandas as pd</span></pre><p id="7564" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">以下函数用于检查目录</em>中是否存在该文件</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="652f" class="jz ka ht jv b fi kb kc l kd ke">'''function check whether file exist in the path or not'''<br/><br/>def where_json(file_name):return os.path.exists(file_name)</span></pre><p id="9db1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">以下函数用于获取刷新令牌</em></p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="ca99" class="jz ka ht jv b fi kb kc l kd ke">''' function return the refresh token '''<br/><br/>def get_refresh_token(client_id,client_secret):<br/>    CLIENT_ID = client_id<br/>    CLIENT_SECRET = client_secret<br/>    SCOPE = 'https://www.googleapis.com/auth/analytics.readonly'<br/>    REDIRECT_URI = 'http:localhost:8080'<br/>  <br/>    flow = OAuth2WebServerFlow(client_id=CLIENT_ID,client_secret=CLIENT_SECRET,scope=SCOPE,redirect_uri=REDIRECT_URI)<br/>    if where_json('credential.json')==False:<br/>       storage = Storage('credential.json') <br/>       credentials = run_flow(flow, storage)<br/>       refresh_token=credentials.refresh_token<br/>       <br/>    elif where_json('credential.json')==True:<br/>       with open('credential.json') as json_file:  <br/>           refresh_token=json.load(json_file)['refresh_token']<br/>  <br/>    return(refresh_token)</span></pre><p id="5fec" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">执行上述函数后，我们可以通过调用以下代码来获得刷新令牌。这里我们使用客户机id和客户机秘密，它们是在创建时从项目中获得的</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="1521" class="jz ka ht jv b fi kb kc l kd ke">client_id = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'<br/>client_secret = 'XXXXXXXXXXXXXX'<br/>refresh_token=get_refresh_token(client_id,client_secret)</span></pre><p id="40e3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了访问google analytics数据的刷新令牌。然而，要访问这些数据，我们还需要一个参数，即特定google analytics帐户的视图id。</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kf"><img src="../Images/b8a72692fb0f9f7c92821293580aace7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVKpeifp-34mszbtAVrJsA.png"/></div></div></figure><p id="d348" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了客户机id、客户机密码、刷新令牌和视图id。通过使用下面给出的函数，可以获得多通道漏斗数据</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="d853" class="jz ka ht jv b fi kb kc l kd ke">''' function return the multi channel data for given dimension, metrics, start data, end data access token, transaction_type, condition'''<br/><br/>def google_analytics_multi_channel_funnel_reporting_api_data_extraction(<br/>viewID,dim,met,start_date,end_date,refresh_token,transaction_type,condition):<br/>         <br/>            <br/>    metric="%2C".join([re.sub(":","%3A",i) for i in met])<br/>    dimension="%2C".join([re.sub(":","%3A",i) for i in dim])<br/>            <br/>    dimension=dimension+"&amp;filters=mcf%3AconversionType%3D%3D"+transaction_type+"&amp;samplingLevel=HIGHER_PRECISION&amp;max-results=8000"<br/>            <br/>    if where_json('credential.json')==True:<br/>        with open('credential.json') as json_file:  <br/>            storage_data = json.load(json_file)<br/>   <br/>        client_id=storage_data['client_id']<br/>        client_secret=storage_data['client_secret']<br/>        credentials = client.OAuth2Credentials(<br/>                access_token=None, client_id=client_id, client_secret=client_secret, refresh_token=refresh_token,<br/>                token_expiry=3600,token_uri=GOOGLE_TOKEN_URI,user_agent='my-user-agent/1.0',revoke_uri=GOOGLE_REVOKE_URI)<br/><br/><br/>        credentials.refresh(httplib2.Http())<br/>        rt=(json.loads(credentials.to_json()))['access_token']<br/>  <br/>        api_url="https://www.googleapis.com/analytics/v3/data/mcf?access_token="<br/>            <br/>       <br/>        url="".join([api_url,rt,'&amp;ids=ga:',viewID,'&amp;start-date=',start_date,'&amp;end-date=',end_date,'&amp;metrics=',metric,'&amp;dimensions=',dimension,condition])<br/>            <br/>        try:<br/>            r = requests.get(url)<br/>            try:<br/>                data=pd.DataFrame(list((r.json())['rows']))<br/>                print("data extraction is successfully completed")<br/>                <br/>                table=pd.DataFrame()<br/>                if data.shape[0]!=0:<br/>                    for i in range(0,data.shape[0]):<br/>                        <br/>                        #print(i)<br/>                        data1=pd.DataFrame()<br/>                        data1=(data.iloc[i,:]).tolist()<br/>                        <br/>                        for k in range(0,len(data1)):<br/>                            if 'conversionPathValue' in data1[k]:<br/>                                value_list=[]<br/>                                for k1 in range(0,len(data1[k]['conversionPathValue'])):<br/>                                    value_list.append(data1[k]['conversionPathValue'][k1]['nodeValue'])<br/>                                table.loc[i,k]=('&gt;').join(value_list)<br/>                            elif 'primitiveValue' in data1[k]:<br/>                                table.loc[i,k]=data1[k]['primitiveValue']<br/>                        <br/>                             <br/>                    if table.shape[0]!=0:   <br/>                        <br/>                        table.columns=[re.sub("mcf:","",i) for i in dim+met]<br/>                        table['date']=start_date<br/>                        return(table) <br/>                <br/>            except:<br/>                print(r.json())<br/>        <br/>        except:<br/>            print(r.json())</span></pre><p id="8090" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了提取数据的所有参数。这里我们需要记住，在传递维度(dim)和度量(met)时，你必须将它们作为一个列表来传递。</p><p id="9818" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有两个事务类型值，即事务或目标。因此，该条件按度量排序[例如:&amp; sort =-mcf % 3a total conversions<em class="jp">(按</em> totalConversions <em class="jp">降序排序)，</em>&amp;sort = mcf % 3a total conversions<em class="jp">(按</em> totalConversions <em class="jp">升序排序)，等等] </em></p><ul class=""><li id="b92f" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">场景1:当交易类型为“交易”且无条件时</li></ul><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="c804" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['mcf:sourceMediumPath','mcf:campaignPath','mcf:conversionType']<br/>met=['mcf:totalConversions', 'mcf:totalConversionValue']<br/>start_date='2019-04-10'<br/>end_date='2019-04-20'<br/>transaction_type='Transaction'<br/>refresh_token=refresh_token<br/>condition=''<br/><br/>data=google_analytics_multi_channel_funnel_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,condition)</span></pre><p id="dc56" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kp"><img src="../Images/eb7c806f51c3775ded2d7314eb3945cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-wb61tY1vdNbvgaIcdyoGA.jpeg"/></div></div></figure><ul class=""><li id="6945" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">场景2:当交易类型为“交易”且有条件时</li></ul><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="66a8" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['mcf:sourceMediumPath','mcf:campaignPath','mcf:conversionType']<br/>met=['mcf:totalConversions', 'mcf:totalConversionValue']<br/>start_date='2019-04-10'<br/>end_date='2019-04-20'<br/>transaction_type='Transaction'<br/>refresh_token=refresh_token<br/>condition='&amp;sort=-mcf%3AtotalConversions'<br/><br/>data=google_analytics_multi_channel_funnel_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,condition)</span></pre><p id="e46b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kq"><img src="../Images/2602d51a48fec663489dd02f5ed61964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vFJ8VZ8kgdGFaY7E1-LcMQ.jpeg"/></div></div></figure><ul class=""><li id="1d1f" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">场景3:当交易类型为“目标”且无条件时</li></ul><p id="b323" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您已经在google analytics帐户中设置了目标，您可以访问。</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="8867" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['mcf:sourceMediumPath','mcf:campaignPath','mcf:conversionType']<br/>met=['mcf:totalConversions', 'mcf:totalConversionValue']<br/>start_date='2019-04-10'<br/>end_date='2019-04-20'<br/>transaction_type='Goal'<br/>refresh_token=refresh_token<br/>condition=''<br/><br/>data=google_analytics_multi_channel_funnel_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,condition)</span></pre><p id="6cc6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kr"><img src="../Images/04525825b98784197971efb215190b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wvtdr20MX6_XjfAMJCY_HQ.jpeg"/></div></div></figure><ul class=""><li id="2bc3" class="kg kh ht is b it iu ix iy jb ki jf kj jj kk jn kl km kn ko bi translated">场景4:当交易类型为“目标”且有条件时</li></ul><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="d757" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['mcf:sourceMediumPath','mcf:campaignPath','mcf:conversionType']<br/>met=['mcf:totalConversions', 'mcf:totalConversionValue']<br/>start_date='2019-04-10'<br/>end_date='2019-04-20'<br/>transaction_type='Goal'<br/>refresh_token=refresh_token<br/>condition='&amp;sort=-mcf%3AtotalConversions'<br/><br/>data=google_analytics_multi_channel_funnel_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,condition)</span></pre><p id="3a3a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ks"><img src="../Images/76ef4097bdf59fa44cc7965e01e2d0f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5SAZh8hvXWU5-BdfGPikSg.jpeg"/></div></div></figure></div></div>    
</body>
</html>