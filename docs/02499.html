<html>
<head>
<title>Spark Streaming in Nagios Monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nagios监控中的火花流</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-streaming-in-nagios-monitoring-4111bd53b84c?source=collection_archive---------15-----------------------#2019-12-19">https://medium.com/analytics-vidhya/spark-streaming-in-nagios-monitoring-4111bd53b84c?source=collection_archive---------15-----------------------#2019-12-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d786438e7581ac32ecca935f538b4aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D-qtsrr2lLaxm-_-"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">约书亚·索蒂诺在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="99d1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大家好，距离我发表上一篇故事已经有一段时间了。这一次我写的是关于使用python spark结构化流和nagios在事件管理工具中自动创建事件的博客。</p><p id="4cc5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi jt translated"><span class="l ju jv jw bm jx jy jz ka kb di"> N </span> agios是一款监控工具，用于监控各种基础设施设备，如服务器、网络设备、应用程序和网站。</p><h2 id="61ae" class="kc kd hi bd ke kf kg kh ki kj kk kl km jg kn ko kp jk kq kr ks jo kt ku kv kw bi translated">业务问题:</h2><p id="e51c" class="pw-post-body-paragraph iv iw hi ix b iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">我们有3台Nagios服务器，每个区域一台，Ilabs、EMEA、美国和10K周围的服务器和网络设备都受到监控。它每分钟发出大约50–80个警报。这些包括问题和恢复警报。为所有这些警报手动创建事件是一项繁忙的任务。</p><h2 id="9ce2" class="kc kd hi bd ke kf kg kh ki kj kk kl km jg kn ko kp jk kq kr ks jo kt ku kv kw bi translated">早期方法:</h2><p id="cc5c" class="pw-post-body-paragraph iv iw hi ix b iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">以前我写过一个python插件，它使用Service NOW REST API来引发事件。但我们注意到，创建事件和重复事件的延迟也很高。我们已经注意到nagios服务器上的高负载和Service Now应用程序上的延迟。有时事件甚至不会被创建。因此，我们将其限制为仅为主机故障警报创建事件。由于这些问题，有必要寻找其他的可能性。</p><h2 id="7f7a" class="kc kd hi bd ke kf kg kh ki kj kk kl km jg kn ko kp jk kq kr ks jo kt ku kv kw bi translated">新方法:</h2><p id="0a05" class="pw-post-body-paragraph iv iw hi ix b iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">我遇到了Apache Spark Streaming API，它看起来更好，是我们以前方法的所有问题的解决方案。</p><p id="3bff" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇博客中，我将尝试解释我使用PySpark在ServiceNow中为Nagios alerts创建事件的方法。在这篇博客中，我曾使用pyspark shell来解释一些事情。</p><blockquote class="lc ld le"><p id="5f8d" class="iv iw lf ix b iy iz ja jb jc jd je jf lg jh ji jj lh jl jm jn li jp jq jr js hb bi translated"><strong class="ix hj">步骤:<br/> * </strong>你可以按照这个<a class="ae iu" href="https://towardsdatascience.com/how-to-get-started-with-pyspark-1adc142456ec" rel="noopener" target="_blank"> <strong class="ix hj"> <em class="hi">文件</em> </strong> </a>来安装spark和pyspark <br/> *确保所有的环境变量都设置好了。<br/> *将通过端口9999从nagios服务器读取nagios.log中的流数据。<br/> *这个脚本是用Python3 &amp; spark 2.4编写的*</p></blockquote><p id="f132" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">导入PySpark模块</strong></p><p id="b1b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">默认情况下，Spark shell附带名为“Spark”的spark会话，因此您不需要再次启动spark会话。如果您正在使用notebook或其他Python IDE，您可能需要使用下面的代码块启动spark会话。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="66c0" class="kc kd hi lo b fi ls lt l lu lv">from pyspark.sql import SparkSession<br/>from pyspark.sql.functions import *<br/>from pyspark.sql.types import StringType, StructType, StructField</span></pre><p id="14b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">现在让我们开始火花会议</strong></p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="921f" class="kc kd hi lo b fi ls lt l lu lv">spark = SparkSession.builder.appName('Nagios_streaming').load()</span></pre><p id="58a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">创建流对象<br/> </strong>我们通过端口9999从nagios服务器的控制台读取流。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="138f" class="kc kd hi lo b fi ls lt l lu lv">ilabsalerts = spark.readStream.format('socket').option('host','ilabs-nagios').option('port',9999).load()</span><span id="436c" class="kc kd hi lo b fi lw lt l lu lv">emeaalerts = spark.readStream.format('socket').option('host','emea-nagios').option('port',9999).load()</span><span id="2946" class="kc kd hi lo b fi lw lt l lu lv">usalerts = spark.readStream.format('socket').option('host','us-nagios').option('port',9999).load()</span></pre><p id="05d6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用union API将所有这3个流对象合并为一个。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="60fd" class="kc kd hi lo b fi ls lt l lu lv">allAlerts = ilabsalerts.union(emeaalerts).union(usalerts)</span></pre><p id="253c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最初，这些流对象以字符串形式出现一个名为“值”的列，我们将对该列进行转换，以获得新列，如拆分和过滤等。</p><p id="f084" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用下面的行查看对象的模式。</p><p id="351d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lx ly lz lo b">allAlerts.printSchema()</code></p><figure class="lj lk ll lm fd ij er es paragraph-image"><div class="er es ma"><img src="../Images/d35e9e3f0daa7c209ed02944ad1312ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*0-uzmR-J49nxuyXwh21RUA.png"/></div></figure><p id="e093" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们必须对<code class="du lx ly lz lo b">allAlerts</code>对象进行转换。<br/>实际上，nagios日志文件包含正在进行的检查的所有信息，但是我们只对警报感兴趣，所以过滤数据帧。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="d8d8" class="kc kd hi lo b fi ls lt l lu lv">filteredAlerts = allAlerts.filter(allAlerts.value.like('%ALERT%'))</span></pre><p id="a0ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">日志条目的示例如下所示</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="5cba" class="kc kd hi lo b fi ls lt l lu lv">[1576600755] SERVICE ALERT: HOSTNAME;SERVICE;WARNING;HARD;1;Link Down -- GigabitEthernet1/0/24 -- #[V] name Video conference# -- propPointToPointSerial -- down</span></pre><p id="1d26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如您在上面的日志条目中看到的，我们的必填字段用“；”分隔。<br/>因此，我们将使用“；”分割数据帧并提取所有字段。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="1b2d" class="kc kd hi lo b fi ls lt l lu lv">splitAlerts = split(filteredAlerts.value,’;’)<br/>filteredAlerts = filteredAlerts.withColumn('Host',splitAlerts.getItem(0))<br/>filteredAlerts = filteredAlerts.withColumn('Service',splitAlerts.getItem(1))<br/>filteredAlerts = filteredAlerts.withColumn('type',splitAlerts.getItem(2))<br/>filteredAlerts = filteredAlerts.withColumn('State',splitAlerts.getItem(3))<br/>filteredAlerts = filteredAlerts.withColumn('Attempt',splitAlerts.getItem(4))<br/>filteredAlerts = filteredAlerts.withColumn('StatusInfo',splitAlerts.getItem(5))</span></pre><p id="d94f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Nagios有两种状态&amp;软状态和硬状态。警报将处于软状态，直到完成最大检查尝试次数并变为硬状态。nagios将只发送硬声明警报通知。因此，我们将不得不只寻找硬性规定的警报。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="aced" class="kc kd hi lo b fi ls lt l lu lv">result = filteredAlerts.filter(col(‘State’) == ‘HARD’)</span></pre><p id="80d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们必须从主机列中提取时间戳和主机名，因为它看起来类似于<strong class="ix hj">[1576600559]SERVICE ALERT:Host<br/></strong>在这里，时间戳用[]括起来，主机名在最后。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="9ef5" class="kc kd hi lo b fi ls lt l lu lv">hostsplit = split(result.Host,' ')<br/>result = result.withColumn('HostName',hostsplit.getItem(3))<br/>result = result.withColumn('TimeStamp',hostsplit.getItem(0))</span></pre><p id="40c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们从最终的数据框中删除不需要的列。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="c333" class="kc kd hi lo b fi ls lt l lu lv">result = result.drop('value','Host')<br/>&gt;&gt;&gt; result.printSchema()<br/>root<br/> |-- Service: string (nullable = true)<br/> |-- type: string (nullable = true)<br/> |-- State: string (nullable = true)<br/> |-- Attempt: string (nullable = true)<br/> |-- StatusInfo: string (nullable = true)<br/> |-- HostName: string (nullable = true)<br/> |-- TimeStamp: string (nullable = true)</span><span id="50df" class="kc kd hi lo b fi lw lt l lu lv">&gt;&gt;&gt;</span></pre><p id="769a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在开始接收数据之前，您必须允许通过端口9999将nagios.log文件打印到套接字。您可以通过从nagios服务器控制台运行下面一行代码来做到这一点。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="6d1f" class="kc kd hi lo b fi ls lt l lu lv">root@ilabs-nagios ~]# tail -f /usr/local/nagios/var/nagios.log | nc -lk 9999<br/>root@emea-nagios ~]# tail -f /usr/local/nagios/var/nagios.log | nc -lk 9999<br/>root@us-nagios ~]# tail -f /usr/local/nagios/var/nagios.log | nc -lk 9999</span></pre><p id="d993" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们有了最终的流对象，并能够通过端口9999接收流，所以我们只需要将数据发送到您需要的任何地方。在本例中，我将输出写入控制台。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="0856" class="kc kd hi lo b fi ls lt l lu lv">query = result.writeStream.format('console').outputMode('append')<br/>query.start()</span><span id="76eb" class="kc kd hi lo b fi lw lt l lu lv">query.<!-- -->awaitTermination()</span></pre><p id="33f2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它将开始把流数据打印到控制台，输出如下所示。</p><figure class="lj lk ll lm fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/518353a2534d4db80dc99289d2f69462.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P5JtkZ8xfg48PISvKPRHdw.png"/></div></div></figure><p id="4645" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这只是为了测试，我们不能使用套接字作为输入源，我们必须进行一些基于窗口的转换，并且必须对流数据进行多个聚合。我将在本系列的下一篇博客中解释这一点。</p><p id="38da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用nagios中的被动检查概念，通过spark流监控关键应用程序、日志和网络设备。</p><p id="89ac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用PySpark继续在这个空间寻找更多关于Nagios的内容。</p><p id="f349" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你在这篇文章中发现任何错误，请随时通过电子邮件发送反馈或留下评论。</p><p id="52c4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">非常感谢您花时间阅读这篇文章！<br/>圣诞快乐！！！！</p><p id="d4c5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">电子邮件:harimittapalli24@gmail.com</p></div></div>    
</body>
</html>