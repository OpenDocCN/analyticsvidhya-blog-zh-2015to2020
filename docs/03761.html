<html>
<head>
<title>Instance Launch Detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实例启动检测</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/instance-launch-detection-6027b441b5ab?source=collection_archive---------16-----------------------#2020-02-17">https://medium.com/analytics-vidhya/instance-launch-detection-6027b441b5ab?source=collection_archive---------16-----------------------#2020-02-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e7b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从业务角度来看，我们使用云在附近区域启动实例，以避免延迟。</p><p id="0c6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，由于无人值守，其他区域会发生什么情况呢？如果实例启动到这些区域会怎么样呢？这也将导致无噪声的计费。</p><p id="ccc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个博客中，发布了一个脚本，它会在实例发生变化时通知我们，这是一个基本的脚本，实例计数硬编码在所有区域中(不是完全自动的)。</p><p id="59be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个脚本如何工作</p><ol class=""><li id="218d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">每5分钟检查所有与硬编码实例计数匹配的区域。</li><li id="4618" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">如果实例计数发生变化，将会触发一封电子邮件，声明“检测到实例启动”。</li></ol><p id="2279" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先决条件:</p><p id="c934" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装了以下组件的服务器。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="ee4f" class="ka kb hi jw b fi kc kd l ke kf">Python3<br/>boto3<br/>crontab</span></pre><p id="fc54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">脚本:</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="76b4" class="ka kb hi jw b fi kc kd l ke kf">import boto3<br/>import os<br/>from time import gmtime, strftime<br/>from datetime import date, timedelta<br/>import datetime<br/>from email.mime.multipart import MIMEMultipart<br/>from email.mime.base import MIMEBase<br/>from email.mime.text import MIMEText<br/>from email.utils import COMMASPACE, formatdate<br/>from email import encoders<br/>import smtplib,ssl</span><span id="59de" class="ka kb hi jw b fi kg kd l ke kf">today = datetime.datetime.now().strftime('%d-%m-%y')<br/>ec =  boto3.client('ec2')</span><span id="abf8" class="ka kb hi jw b fi kg kd l ke kf"><a class="ae kh" href="mailto:sfrom='example@gmail.com" rel="noopener ugc nofollow" target="_blank">sfrom='example@gmail.com</a>'                     //Update Your Mail ID <br/><a class="ae kh" href="mailto:sto='example@gmail.com" rel="noopener ugc nofollow" target="_blank">sto='example@gmail.com</a>'                      // To address<br/>sub='ATTENTION REQUIRED : INSTANCE LAUNCH DETECTED'<br/>txt="INSTANCE LAUCH DETAILS"<br/>ser='email-smtp.us-east-1.amazonaws.com'<br/>port='587'<br/>username='SMTP USername'        # Add SMTP Username<br/>password='SMTP Password'       # ADD SMTP Password</span><span id="1aac" class="ka kb hi jw b fi kg kd l ke kf">def sendMail(message):<br/>    ses_user = username         #Update the SMTP USername<br/>    ses_pwd = password          #Update the SMTP Password<br/>    fromadd = sfrom<br/>    to = sto</span><span id="3aea" class="ka kb hi jw b fi kg kd l ke kf">msg = MIMEMultipart()<br/>    msg['From'] =fromadd<br/>    msg['To'] = to<br/>    msg['Subject'] = "ATTENTION REQUIRED INSTANCE LAUNCH DETECTED"<br/>    body = message<br/>    msg.attach(MIMEText(body,'plain'))</span><span id="406a" class="ka kb hi jw b fi kg kd l ke kf">#part = MIMEBase('application', 'octet-stream')<br/>    #part.set_payload(open(attach, 'rb').read())<br/>    #Encoders.encode_base64(part)<br/>    #part.add_header('Content-Disposition','attachment; filename="%s"' % os.path.basename(attach))<br/>    #msg.attach(part)</span><span id="3e11" class="ka kb hi jw b fi kg kd l ke kf">mailServer = smtplib.SMTP("email-smtp.us-east-1.amazonaws.com", 587)<br/>    mailServer.ehlo()<br/>    mailServer.starttls()<br/>    mailServer.ehlo()<br/>    mailServer.login(ses_user, ses_pwd)<br/>    mailServer.sendmail(fromadd, to, msg.as_string())<br/>    # Should be mailServer.quit(), but that crashes...<br/>    mailServer.close()</span><span id="fd73" class="ka kb hi jw b fi kg kd l ke kf">def instance_count_details(x,reg, short_hand_region):<br/>    message = ""<br/>    instance_count = 0<br/>    orbit_value = x<br/>    ec = boto3.client('ec2',short_hand_region)<br/>    reservations = ec.describe_instances()<br/>    for r in (reservations["Reservations"]):<br/>        for i in r["Instances"]:<br/>            instance_count +=1<br/>    print(instance_count)<br/>    if instance_count == 0:<br/>        print(reg + " region has no server registered")<br/>    elif instance_count == orbit_value:<br/>        print(reg + " runs with the same Instance count",(instance_count))<br/>    elif instance_count &gt; orbit_value:<br/>        inst = instance_count - orbit_value<br/>        print(inst)<br/>        temp = reg + " Detected more running instances than expected " +  str(x) + "\n" "Instance Launched on : " + today + "\n" "Total Instance Count : "+ str(inst) + "\n" "Consider Updating the Instance Count Value in Script it this is Expected to run for long term"<br/>        message += temp<br/>        sendMail(message)<br/>    else:<br/>        print("GoodBye")</span><span id="636e" class="ka kb hi jw b fi kg kd l ke kf">def main():<br/>    instance_count_details(2,'Northern-virginia', 'us-east-1')<br/>    instance_count_details(0,'Ohio', 'us-east-2')<br/>    instance_count_details(0,'california', 'us-west-1')<br/>    instance_count_details(0,'oregon', 'us-west-2')<br/>    instance_count_details(0,'Mumbai', 'ap-south-1')<br/>    instance_count_details(0,'seoul', 'ap-northeast-2')<br/>    instance_count_details(0,'seoul', 'ap-southeast-1')<br/>    instance_count_details(0,'sydney', 'ap-southeast-2')<br/>    instance_count_details(0,'Tokyo', 'ap-northeast-1')   <br/>    instance_count_details(0,'canada', 'ca-central-1')<br/>    instance_count_details(0,'Frankfurt', 'eu-central-1')<br/>    instance_count_details(0,'Ireland', 'eu-west-1')<br/>    instance_count_details(0,'London', 'eu-west-2')<br/>    instance_count_details(0,'paris', 'eu-west-3')<br/>    instance_count_details(0,'stockholm', 'eu-north-1')<br/>    instance_count_details(0,'Saopaulo', 'me-south-1')</span><span id="af0a" class="ka kb hi jw b fi kg kd l ke kf">main()</span></pre><p id="821d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的脚本中，N.virginia地区有2个实例，其他地区为0。</p><p id="b8e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当这些值发生变化时，我们会收到一封电子邮件通知，指出检测到实例启动。</p><p id="35f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">预期的实例计数为2，总实例计数将是预期计数和当前计数之差。</p><figure class="jr js jt ju fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es ki"><img src="../Images/1c0bcf5130338ccfa0052b26bf113f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASQ1rSHi3VxyshTa_Y5oog.png"/></div></div></figure><p id="7ae4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Jumpbox服务器上运行这个脚本，它需要一个ec2只读访问角色。</p><p id="11e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个简单的脚本，它会在实例启动时提醒我们，在优化时，它可以与AWS config和Lambda连接，以便进行更多的数据检索。</p></div></div>    
</body>
</html>