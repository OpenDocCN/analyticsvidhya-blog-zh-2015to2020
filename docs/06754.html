<html>
<head>
<title>Mock AWS &amp; Pytest Click</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模拟AWS和Pytest点击</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mock-aws-pytest-click-51a2a7b41123?source=collection_archive---------20-----------------------#2020-06-01">https://medium.com/analytics-vidhya/mock-aws-pytest-click-51a2a7b41123?source=collection_archive---------20-----------------------#2020-06-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b0dfea22cfd2953669705c329f8d4f4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j4KH_W-JAkMTYWdBoZRL8g.png"/></div></div></figure><p id="03c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作为DevOps团队的一员，我开始使用多种不同的工具和应用程序。最近，我有机会用python开发了一个点击应用程序，它连接到AWS来获取数据。我使用<em class="jo"> setup.py </em> build进行部署(<code class="du jp jq jr js b">setup.py</code>是<a class="ae jt" href="https://packaging.python.org/key_projects/#setuptools" rel="noopener ugc nofollow" target="_blank"> setuptools </a>的构建脚本)。它告诉setuptools关于包的信息(比如名称和版本)以及要包含哪些代码文件。我遇到的一个问题是如何编写模拟AWS调用的测试用例。每个组件都有很好的文档，比如如何测试click app，如何测试setup.py，以及如何模拟AWS调用。在这篇博客中，我试图将它们结合起来。</p><h1 id="6eb0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">从哪里开始？</h1><p id="34d5" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">在这个报告(<a class="ae jt" href="https://github.com/tomarv2/demo-python-aws-click" rel="noopener ugc nofollow" target="_blank">链接</a>)中，我放了一小部分文件给某人来测试所有这些组件是如何工作的。</p><h2 id="1ea8" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak">主要功能:</strong></h2><p id="e783" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated"><code class="du jp jq jr js b">src/demo/manage-secrets.py</code>中的<code class="du jp jq jr js b">get_value_from_paramter_store()</code>接受从SSM参数库中获取的参数<code class="du jp jq jr js b">name</code>。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h2 id="eb88" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak">点击命令行界面:</strong></h2><p id="a0ee" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated"><code class="du jp jq jr js b">src/demo/cli.py</code>它接受一个必需的选项<code class="du jp jq jr js b">--name</code>。我们可以根据需要添加更多的参数。我留着它是为了理解。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h2 id="4c18" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak"> setup.py: </strong></h2><p id="0f93" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">这花了我一些时间来完成，有多种方法来创建这个文件。</p><p id="91e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们来回顾一下:</p><ul class=""><li id="6da4" class="lr ls hi is b it iu ix iy jb lt jf lu jj lv jn lw lx ly lz bi translated"><code class="du jp jq jr js b">setup</code>是<code class="du jp jq jr js b">setuptools</code>包的一部分。</li><li id="e47c" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj">版本:</strong>对于一个项目的版本号，有很多技术可以维护单一的真实来源。我更喜欢这样。您也可以创建一个版本文件并指定它。</li><li id="126f" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj"> ROOT_PATH </strong>:指定setup.py文件的父目录。有时，我会面临路径问题。</li><li id="7bc1" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated">您会注意到两条打印语句，这只是为了确保setup.py正常工作。它们可以被移除。</li><li id="f3e6" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj">描述</strong>和<strong class="is hj"> long_description </strong>:你的项目的一个短desc，而long_description指向一个<code class="du jp jq jr js b">README.md</code>文件。</li><li id="f81f" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj"> package_dir: </strong></li><li id="a46d" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj">包:</strong>包括<code class="du jp jq jr js b">src</code>下的所有包</li><li id="5969" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj"> tests_require: </strong>如果你的项目的测试除了需要安装它之外，还需要一个或多个额外的包。</li><li id="149a" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj"> install_requires: </strong>一个字符串或字符串列表，指定当这个发行版被安装时还需要安装哪些其他发行版。我放了一个函数来处理这个问题。</li><li id="c7b7" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><strong class="is hj">入口点:</strong> <em class="jo">入口点</em>是一种机制，用于已安装的发行版通告它所提供的组件，以便被其他代码发现和使用。基本上，它指定了要运行的命令。</li></ul><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h2 id="2e06" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak"> test_cli.py: </strong></h2><p id="7f4f" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated"><code class="du jp jq jr js b">@pytest.fixture</code> —此范围仅限于此模块，可选:<code class="du jp jq jr js b">function</code>、<code class="du jp jq jr js b">class</code>、<code class="du jp jq jr js b">module</code>、<code class="du jp jq jr js b">package</code>或<code class="du jp jq jr js b">session</code></p><p id="7cb5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">根据moto的文档，由于botocore的变化，建议指定虚拟AWS凭证，因此moto不使用凭证文件中指定的实际AWS凭证。另一个建议是，如果不需要，不要在顶部导入模块。</p><p id="932d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了使用<code class="du jp jq jr js b">get_ssm</code>,我需要执行<code class="du jp jq jr js b">put_ssm</code>,因为它不包含现有数据。</p><p id="f2d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong> <code class="du jp jq jr js b">response = runner.invoke(entrypoint,["get", "--name", “demo_parameter"])</code>，entrypoint是启动cli的函数名，get和name是传递给cli命令的参数。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h2 id="ff93" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated">如何运行:</h2><p id="81b8" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">克隆存储库后，运行:</p><p id="5522" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jp jq jr js b">python setup.py develop</code>以开发模式部署。</p><p id="3ff9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后运行:<code class="du jp jq jr js b"><strong class="is hj">demo</strong></code><strong class="is hj"/><strong class="is hj"/>你应该会看到下面的输出。我使用开发，因为它将创建链接，而不是安装实际的软件包，当你开发时，它真的很方便。关于何时使用<code class="du jp jq jr js b">develop</code>和<code class="du jp jq jr js b">install</code>的良好解释:此处<a class="ae jt" href="https://stackoverflow.com/questions/20339183/difference-between-setup-py-install-and-setup-py-develop" rel="noopener ugc nofollow" target="_blank">为</a></p><pre class="ll lm ln lo fd mf js mg mh aw mi bi"><span id="54d0" class="kx jv hi js b fi mj mk l ml mm"><strong class="js hj">demo</strong><br/>Usage: demo [OPTIONS] COMMAND [ARGS]...</span><span id="29d8" class="kx jv hi js b fi mn mk l ml mm">Options:<br/>  --help  Show this message and exit.</span><span id="a696" class="kx jv hi js b fi mn mk l ml mm">Commands:<br/>  get  get secrets</span></pre><h2 id="77bf" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak">如何运行测试:</strong></h2><p id="877f" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">运行测试有多种方式，并且支持多个参数。<code class="du jp jq jr js b">pytest</code>将运行所有测试:<code class="du jp jq jr js b">pytest -v -s</code> <code class="du jp jq jr js b">-v</code>用于详细测试，而<code class="du jp jq jr js b">-s</code>用于打印测试中指定的任何打印语句。</p><h2 id="ad55" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak">发布到</strong><a class="ae jt" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"><strong class="ak">PyPI</strong></a><strong class="ak">:</strong></h2><p id="3c54" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">现在如果你需要将你的包发布到<a class="ae jt" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> PyPI </strong> </a> <strong class="is hj"> </strong>并与其他人分享。在<a class="ae jt" href="https://test.pypi.org/" rel="noopener ugc nofollow" target="_blank"> TestPyPI </a>和<a class="ae jt" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> PyPI </a>上创建一个帐户。在你的虚拟世界里:</p><pre class="ll lm ln lo fd mf js mg mh aw mi bi"><span id="5f92" class="kx jv hi js b fi mj mk l ml mm">python3 -m pip install --user --upgrade setuptools wheel<br/>pip install wheel<br/>pip install twine</span></pre><p id="fd32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从回购的基础上:</p><pre class="ll lm ln lo fd mf js mg mh aw mi bi"><span id="9d71" class="kx jv hi js b fi mj mk l ml mm">python3 setup.py sdist bdist_wheel</span></pre><p id="df3d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后检查捆绳:</p><pre class="ll lm ln lo fd mf js mg mh aw mi bi"><span id="e271" class="kx jv hi js b fi mj mk l ml mm"><strong class="js hj">twine check dist/*</strong><br/>Checking dist/demo-0.0.1.dev1-py3-none-any.whl: PASSED<br/>Checking dist/demo-0.0.1.dev1.tar.gz: PASSED</span></pre><p id="3b32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上传:</p><pre class="ll lm ln lo fd mf js mg mh aw mi bi"><span id="7790" class="kx jv hi js b fi mj mk l ml mm"><strong class="js hj">python3 -m twine upload dist/* --verbose</strong><br/>Uploading distributions to <a class="ae jt" href="https://upload.pypi.org/legacy/" rel="noopener ugc nofollow" target="_blank">https://upload.pypi.org/legacy/</a><br/>Enter your username: demo<br/>Enter your password: <br/>Uploading demo_python_aws_click-0.0.1.dev1-py3-none-any.whl<br/>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 5.99k/5.99k [00:02&lt;00:00, 2.27kB/s]<br/>Uploading demo-python-aws-click-0.0.1.dev1.tar.gz<br/>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4.63k/4.63k [00:01&lt;00:00, 3.23kB/s]</span><span id="7168" class="kx jv hi js b fi mn mk l ml mm">View at:<br/><a class="ae jt" href="https://pypi.org/project/demo-python-aws-click/0.0.1.dev1/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/demo-python-aws-click/0.0.1.dev1/</a></span></pre><h2 id="96d0" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated">如何测试PyPI包:</h2><p id="e669" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">创建一个新的virtualenv，使用pip下载并运行<code class="du jp jq jr js b">demo</code>命令:</p><pre class="ll lm ln lo fd mf js mg mh aw mi bi"><span id="d765" class="kx jv hi js b fi mj mk l ml mm">- python3 -m venv ~/Documents/virtualenv/demo-venv<br/>- source ~/Documents/virtualenv/demo-venv/bin/activate<br/>- pip install <a class="ae jt" href="https://pypi.org/project/demo-python-aws-click/0.0.1.dev1/" rel="noopener ugc nofollow" target="_blank">demo-python-aws-click</a><br/>- demo</span></pre><h2 id="32f2" class="kx jv hi bd jw ky kz la ka lb lc ld ke jb le lf ki jf lg lh km jj li lj kq lk bi translated"><strong class="ak">注:</strong></h2><ul class=""><li id="6471" class="lr ls hi is b it ks ix kt jb mo jf mp jj mq jn lw lx ly lz bi translated">建议使用virtualenv</li><li id="ffdc" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated">使用Python 3.8测试包</li><li id="9eb2" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated">上传到PyPI时，包名必须是唯一的。</li></ul><h1 id="717d" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论:</h1><p id="3c05" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">Click是在python中创建命令行界面最流行的包之一。当集成多个组件时，有时很难找出什么适合什么。希望有帮助。如有需要，请随时纠正或评论。</p><h1 id="1985" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">参考资料:</h1><ul class=""><li id="d93d" class="lr ls hi is b it ks ix kt jb mo jf mp jj mq jn lw lx ly lz bi translated"><a class="ae jt" href="https://github.com/spulec/moto" rel="noopener ugc nofollow" target="_blank">https://github.com/spulec/moto</a></li><li id="0011" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated"><a class="ae jt" href="https://packaging.python.org/specifications/entry-points/" rel="noopener ugc nofollow" target="_blank">https://packaging.python.org/specifications/entry-points/</a></li></ul></div></div>    
</body>
</html>