<html>
<head>
<title>Deploying FastAPI application in Google App Engine in Standard Environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在标准环境中在 Google App Engine 中部署 FastAPI 应用程序</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-fastapi-application-in-google-app-engine-in-standard-environment-dc061d3277a?source=collection_archive---------1-----------------------#2020-11-12">https://medium.com/analytics-vidhya/deploying-fastapi-application-in-google-app-engine-in-standard-environment-dc061d3277a?source=collection_archive---------1-----------------------#2020-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e7fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">FastAPI 是一个现代、快速(高性能)的 web 框架，用于基于标准 Python 类型提示用 Python 3.6+构建 API。要了解更多关于 FastAPI 的信息，你可以点击<a class="ae jd" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank">这里</a>访问 FastAPI 的文档。</p><p id="51c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">FastAPI 还在{base_url}/docs 中默认提供 Swagger UI 来测试 API。</p><h2 id="8c66" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">装置</h2><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="06d8" class="je jf hi ke b fi ki kj l kk kl">pip install fastapi</span></pre><p id="0528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还需要一个 ASGI 服务器，用于生产诸如<a class="ae jd" href="https://www.uvicorn.org/" rel="noopener ugc nofollow" target="_blank">uvicon</a>或<a class="ae jd" href="https://gitlab.com/pgjones/hypercorn" rel="noopener ugc nofollow" target="_blank"> Hypercorn </a>之类的产品。我们将在这篇文章中使用 uvicorn。</p><p id="8683" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Uvicorn 是一个快如闪电的 ASGI 服务器实现，使用了<a class="ae jd" href="https://github.com/MagicStack/uvloop" rel="noopener ugc nofollow" target="_blank"> uvloop </a>和<a class="ae jd" href="https://github.com/MagicStack/httptools" rel="noopener ugc nofollow" target="_blank"> httptools </a>。</p><p id="d1da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到最近，Python 还缺少一个用于 asyncio 框架的最低限度的底层服务器/应用程序接口。ASGI 规范<a class="ae jd" href="https://asgi.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">填补了这一空白，意味着我们现在能够开始构建一套可以跨所有 asyncio 框架使用的通用工具。</a></p><p id="5ec6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要安装 uvicorn:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="0819" class="je jf hi ke b fi ki kj l kk kl">pip install uvicorn</span></pre><p id="3932" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将安装具有最小(纯 Python)依赖性的 uvicorn。</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e84a" class="je jf hi ke b fi ki kj l kk kl">pip install uvicorn[standard]</span></pre><p id="b60c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将安装带有“基于 Cython”的依赖项(可能的话)和其他“可选附件”的 uvicorn。</p><p id="650b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，“基于 Cython”的含义如下:</p><ul class=""><li id="7754" class="km kn hi ih b ii ij im in iq ko iu kp iy kq jc kr ks kt ku bi translated">如果可能，将安装并使用事件回路<code class="du kv kw kx ke b">uvloop</code>。</li><li id="4d25" class="km kn hi ih b ii ky im kz iq la iu lb iy lc jc kr ks kt ku bi translated">如果可能的话，http 协议将由<code class="du kv kw kx ke b">httptools</code>处理。</li></ul><p id="4552" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我更喜欢使用 uvicon[standard ],因为它安装了基于 cython 的依赖项，这将防止在生产中运行时出现与 uvloop 和 httptools 相关的错误。</p><p id="34c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，您还应该安装 Gunicorn，因为这可能是在生产环境中运行和管理 Uvicorn 的最简单方式。Uvicorn 包含一个 gunicorn worker 类，这意味着只需很少的配置就可以完成设置。在本地运行时，不需要安装 Gunicorn。</p><p id="5a6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要安装 Gunicorn:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="b836" class="je jf hi ke b fi ki kj l kk kl">pip install gunicorn</span></pre><h2 id="b0f2" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">冻结需求文件</h2><p id="5187" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">在 virtualenv 中安装每个必需的依赖项后，不要忘记在部署之前冻结需求文件以进行更新，因为 App Engine 会从 requirements.txt 文件安装依赖项。</p><p id="2160" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要冻结需求文件:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e927" class="je jf hi ke b fi ki kj l kk kl">pip freeze &gt; requirements.txt</span></pre><h2 id="a971" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">配置 app.yaml 文件</h2><p id="5735" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">您的 python 版本应该高于 3.6，FastAPI 才能工作。以下是我的项目配置:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a7df" class="je jf hi ke b fi ki kj l kk kl">runtime: python37<br/>entrypoint: gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app<br/>instance_class: F2</span></pre><p id="25e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以根据需要选择任何高于 3.6 的 python 版本和 instance_class。下面将用四个工作进程启动 Gunicorn:</p><p id="8a8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kv kw kx ke b">gunicorn -w 4 -k uvicorn.workers.UvicornWorker</code></p><p id="7ae2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">main 是我的 main.py 文件，app 是我的 FastAPI 应用程序的实例。App Engine 处理端口号，但您可以定义您想要的端口号。</p><h2 id="d1cb" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">部署前确认</h2><p id="3e91" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">完成上述所有步骤后，最后一次确认以下内容:</p><ol class=""><li id="ca44" class="km kn hi ih b ii ij im in iq ko iu kp iy kq jc li ks kt ku bi translated">您的 virtualenv 已激活，并且通过激活环境安装了所有要求。</li><li id="3195" class="km kn hi ih b ii ky im kz iq la iu lb iy lc jc li ks kt ku bi translated">确保您只安装了必要的依赖项并包括。gcloudignore 在部署过程中忽略不必要的文件和文件夹。</li><li id="15dc" class="km kn hi ih b ii ky im kz iq la iu lb iy lc jc li ks kt ku bi translated">在部署之前冻结 requirements.txt 文件，这样您就不会错过在需求文件中添加新安装的依赖项。</li><li id="5242" class="km kn hi ih b ii ky im kz iq la iu lb iy lc jc li ks kt ku bi translated">您的 app.yaml 文件已正确配置。</li><li id="b263" class="km kn hi ih b ii ky im kz iq la iu lb iy lc jc li ks kt ku bi translated">您的服务帐户 json 文件具有必要的访问权限。</li></ol><h2 id="e870" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">在应用引擎中部署</h2><p id="6960" class="pw-post-body-paragraph if ig hi ih b ii ld ik il im le io ip iq lf is it iu lg iw ix iy lh ja jb jc hb bi translated">如果您尚未安装 Google Cloud SDK，那么您必须安装并配置该 SDK。你可以点击<a class="ae jd" href="https://cloud.google.com/sdk/docs/how-to" rel="noopener ugc nofollow" target="_blank">这个链接</a>来正确配置你的 google cloud sdk。</p><p id="19f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装 sdk 后，您需要初始化 sdk。要初始化云 SDK:</p><p id="6b8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从终端运行<code class="du kv kw kx ke b">gcloud init</code>。</p><p id="8e9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">初始化后，确保选择了正确的项目 id。要从 google cloud 中选择项目，您必须运行<code class="du kv kw kx ke b">gcloud config set project [project_id]</code></p><p id="063a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，在选定的项目 id 中部署您的 FastAPI 应用程序:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="8c9b" class="je jf hi ke b fi ki kj l kk kl">gcloud app deploy</span></pre><p id="bfa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将获得在终端中查看应用程序的 url。</p></div></div>    
</body>
</html>