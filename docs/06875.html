<html>
<head>
<title>Developing, deploying and testing Flask applications on Kubernetes — Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上开发、部署和测试Flask应用程序—第一部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/developing-deploying-and-testing-flask-applications-on-kubernetes-part-i-64c24c29cfeb?source=collection_archive---------17-----------------------#2020-06-05">https://medium.com/analytics-vidhya/developing-deploying-and-testing-flask-applications-on-kubernetes-part-i-64c24c29cfeb?source=collection_archive---------17-----------------------#2020-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/e09f2bc439478143716309a632c4c7da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oaFxGVXhwyJ0EY_Uy8Dz0A.png"/></div></figure><h1 id="475d" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">概观</h1><p id="d8ea" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在这篇逐步介绍如何将Python Flask应用程序与Docker集成并在Kubernetes集群中运行的博文中，我们将讨论以下主题:</p><ul class=""><li id="b848" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated">将现有的Flask应用程序归档。</li><li id="fccc" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">使用docker-compose部署它。</li><li id="9436" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">部署到Kubernetes集群。</li><li id="e561" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">检查、测试和缩放</li></ul><h1 id="3c29" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">要求</h1><p id="ebe6" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">在继续之前，请确保您的环境满足这些要求。首先在您的机器上安装以下依赖项。</p><ul class=""><li id="77bb" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated">码头工人</li><li id="9930" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">库伯内特斯</li><li id="8554" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">饭桶</li></ul><h1 id="a440" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">烧瓶应用程序</h1><p id="24e0" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">本文中我们将使用的应用程序是一个简单的Python应用程序，它被用作天气API <a class="ae ky" href="https://samples.openweathermap.org/" rel="noopener ugc nofollow" target="_blank"> OpenWeatherMap </a>的包装器。该应用程序具有以下HTTP端点</p><ul class=""><li id="77c9" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated">“/”:这是根路由，它基本上以静态字符串作为响应。此端点可用作应用程序的健康检查。</li><li id="0ec3" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">“//”:用于检索给定城市的天气信息的API端点。城市和农村都要提供。</li></ul><p id="3ff8" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">完整的应用程序源代码如下所示。应用程序简单地处理请求，并将它们转发给https://samples.openweathermap.org<a class="ae ky" href="https://samples.openweathermap.org/" rel="noopener ugc nofollow" target="_blank">的</a>天气API端点，然后用从API端点检索到的相同数据进行响应。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="496a" class="ll in hi lh b fi lm ln l lo lp">from flask import Flask<br/>import requests<br/><br/>app = Flask(__name__)<br/><br/>API_KEY = "b6907d289e10d714a6e88b30761fae22"<br/><br/>@app.route('/')<br/>def index():<br/>    return 'App Works!'<br/><br/>@app.route('///')<br/>def weather_by_city(country, city):<br/><br/>    url = 'https://samples.openweathermap.org/data/2.5/weather'<br/>    params = dict(<br/>        q=city + "," + country,<br/>        appid= API_KEY,<br/>    )<br/><br/>    response = requests.get(url=url, params=params)<br/>    data = response.json()<br/>    return data<br/><br/>if __name__ == '__main__':<br/>    app.run(host="0.0.0.0", port=5000)</span></pre><h1 id="1a5f" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">归档我们的烧瓶申请</h1><p id="572c" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">编写python应用程序的文档是一项简单明了的任务。为此，我们需要将以下文件引入到项目中:</p><ul class=""><li id="3f8a" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated">需求文件:该文件包含应用程序所需的所有依赖项的列表。例如，我们的应用程序的一个依赖项是Flask。该文件将用于在Docker构建期间安装所有已定义的包。下面是需求文件的内容。</li></ul><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="351f" class="ll in hi lh b fi lm ln l lo lp">certifi==2019.9.11<br/>chardet==3.0.4<br/>Click==7.0<br/>Flask==1.1.1<br/>idna==2.8<br/>itsdangerous==1.1.0<br/>Jinja2==2.10.3<br/>MarkupSafe==1.1.1<br/>requests==2.22.0<br/>urllib3==1.25.7<br/>Werkzeug==0.16.0</span></pre><ul class=""><li id="8720" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated">Dockerfile:这个文件包括构建应用程序的Docker映像所需的所有Docker指令。如以下文件所示，Docker将执行以下操作来构建Docker映像:</li><li id="f59e" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">使用python:3作为我们应用程序的基础映像。</li><li id="c04a" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">在映像中创建工作目录，并复制需求文件。(这一步有助于优化Docker构建时间。)</li><li id="744a" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">使用pip安装所有依赖项。</li><li id="b530" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">复制其余的应用程序文件。</li><li id="cd73" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">暴露端口5000并为映像设置默认命令(CMD)。</li></ul><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="7add" class="ll in hi lh b fi lm ln l lo lp">FROM python:3<br/>ENV PYTHONUNBUFFERED 1<br/>RUN mkdir /app<br/>WORKDIR /app<br/>COPY requirements.txt /app<br/>RUN pip install --upgrade pip<br/>RUN pip install -r requirements.txt<br/>COPY . /app<br/>EXPOSE 5000<br/>CMD [ "python", "app.py" ]</span></pre><p id="4e0e" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">我们现在可以使用下面的命令构建应用程序的Docker映像:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4ed2" class="ll in hi lh b fi lm ln l lo lp">$&gt; docker build -t weather:v1.0 .</span></pre><h1 id="5b86" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">运行应用程序</h1><p id="c2e1" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">我们可以使用Docker CLI在本地运行应用程序，如下所示:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="0bb7" class="ll in hi lh b fi lm ln l lo lp">$&gt; docker run -dit --rm -p 5000:5000 --name weather weather:v1.0</span></pre><p id="d4bf" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">或者，我们可以使用docker-compose文件来管理本地开发环境中应用程序的构建和部署。例如，下面的合成文件将负责为应用程序构建Docker映像并部署它。</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="9869" class="ll in hi lh b fi lm ln l lo lp">version: '3.6'<br/>services:<br/>  weather:<br/>    build: .<br/>    ports:<br/>      - "5000:5000"<br/>    volumes:<br/>      - .:/app</span></pre><p id="56b1" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">使用docker-compose运行应用程序可以使用:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="bbc4" class="ll in hi lh b fi lm ln l lo lp">$&gt; docker-compose up</span></pre><p id="540b" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">应用程序运行后，可以使用CURL命令检索伦敦的天气数据，例如:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="b756" class="ll in hi lh b fi lm ln l lo lp">$&gt; curl http://0.0.0.0:5000/london/uk/</span></pre><h1 id="6289" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">Kubernetes概述</h1><p id="5107" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">对于生产服务，不建议直接使用docker命令甚至docker-compose运行服务，因为它不是一个生产就绪的工具。它既不能确保您的应用程序以高可用性模式运行，也不能帮助您扩展您的应用程序。</p><p id="8397" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">为了更好地说明最后一点，Compose仅限于一个Docker主机，并且不支持在集群中运行Docker服务。</p><p id="0316" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">因此，需要使用提供这种羽毛的其他解决方案。最著名和最常用的解决方案之一是Kubernetes。该工具是一个开源项目，用于自动化容器化应用程序的部署、扩展和管理。它被世界各地的公司和个人广泛使用，原因如下</p><figure class="lc ld le lf fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/1b4ee249c4c583bf765725d004f73581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DkoTj7cE_VxdJf7z.png"/></div></div></figure><ul class=""><li id="0ea8" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated">它是免费的:该项目是开源的，由CNCF维护。</li><li id="80bb" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">它被谷歌、AWS、微软等大公司采用。</li><li id="23d0" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">有许多云系统提供Kubernetes托管服务，如AWS、Google Cloud和DigitalOcean。</li><li id="fb27" class="ki kj hi jm b jn kt jr ku jv kv jz kw kd kx kh kp kq kr ks bi translated">Kubernetes社区开发了许多插件和工具来使管理Kubernetes变得更加容易和高效。</li></ul><h1 id="8a54" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">为您的开发环境创建Kubernetes集群</h1><p id="b072" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Kubernetes是一个分布式系统，集成了几个组件和二进制文件。这使得构建生产集群具有挑战性，同时在开发环境中运行Kubernetes将消耗大部分机器资源。此外，开发人员很难维护本地集群。</p><p id="f4be" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">这就是为什么真正需要以一种简单流畅的方式在本地运行Kubernetes。这是一个工具，可以帮助开发人员专注于开发，而不是维护集群。</p><p id="4e7c" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">有几个选项可用于实现这一任务，下面是前三个</p><ul class=""><li id="deb9" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated"><strong class="jm hj"> Docker for mac: </strong>如果你有MacBook，你可以安装Docker for mac，并从应用程序的配置中启用Kubernetes，如下图所示。您将在本地部署一个Kubernetes集群。</li></ul><figure class="lc ld le lf fd ij er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/38f6305be050f522ce13eebb4285430b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vermsjbs8_jawbBp.png"/></div></div></figure><ul class=""><li id="86f1" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated"><a class="ae ky" href="https://github.com/ubuntu/microk8s" rel="noopener ugc nofollow" target="_blank"> <strong class="jm hj"> Microk8s: </strong> </a>单包完全符合轻量级Kubernetes，工作于42种<a class="ae ky" href="https://snapcraft.io/microk8s" rel="noopener ugc nofollow" target="_blank">风格的Linux </a>。这可以用来在包括Raspberry Pi在内的Linux系统上本地运行Kubernetes。可以使用Snap命令行在CentOS上安装MicroK8s，如下面的代码片段所示</li></ul><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="2e41" class="ll in hi lh b fi lm ln l lo lp">$&gt; sudo yum install epel-release<br/>$&gt; sudo yum install snapd<br/>$&gt; sudo systemctl enable --now snapd.socket<br/>$&gt; sudo ln -s /var/lib/snapd/snap /snap<br/>$&gt; sudo snap install microk8s --classic</span></pre><p id="e258" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">如果您有不同的Linux发行版，您可以在下面的<a class="ae ky" href="https://snapcraft.io/microk8s" rel="noopener ugc nofollow" target="_blank">页面上找到说明。</a></p><ul class=""><li id="3266" class="ki kj hi jm b jn kk jr kl jv km jz kn kd ko kh kp kq kr ks bi translated"><a class="ae ky" href="https://github.com/kubernetes/minikube/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm hj"> Minikube: </strong> </a>在macOS、Linux和Windows上实现本地Kubernetes集群，支持大多数Kubernetes特性。根据您的操作系统，您可以从这个<a class="ae ky" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank">页面</a>中选择安装Kubernetes所需的命令。例如，要在macOS上安装并启动应用程序，您可以使用以下命令:</li></ul><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="8b43" class="ll in hi lh b fi lm ln l lo lp">$&gt; brew install minikube<br/>$&gt; minikube start</span></pre><p id="4258" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">一旦安装并运行了Minikube、Microk8s或Docker for Mac，就可以开始使用Kubernetes命令行与Kubernetes集群进行交互。</p><p id="27ac" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">上述工具可以很容易地用于引导开发环境，并在本地测试您的Kubernetes部署。然而，它们并没有实现Kubernetes支持的所有特性，也不是所有的特性都支持多节点集群。</p><h1 id="abaf" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">结论</h1><p id="2173" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">Minikube，Microk8s，或者Docker for Mac都是本地开发的好工具。但是，对于测试和试运行环境，需要高度可用的集群在类似生产的环境中模拟和测试应用程序。另一方面，为测试环境运行Kubernetes集群24/7可能非常昂贵。您应该确保仅在需要时运行集群，不再需要时将其关闭，然后在再次需要时重新创建。</p><p id="301f" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated"><a class="ae ky" href="https://app.cloudplex.io/register?planName=developer-free?ref=blog" rel="noopener ugc nofollow" target="_blank">使用Cloudplex </a>，创建、运行、终止和重新创建集群非常简单。您可以<a class="ae ky" href="https://app.cloudplex.io/register?planName=developer-free?ref=blog" rel="noopener ugc nofollow" target="_blank">免费部署您的第一个集群</a>。几分钟后，您的集群启动并运行，您可以保存其配置，关闭它，并在需要时重新创建它。</p><p id="1b19" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">在本系列的第二部分中，我们将介绍如何将我们的应用程序部署到Kubernetes测试集群中。我们将为我们的Flask应用程序创建Kubernetes部署，并使用Traefik来管理我们的入口，并将我们的应用程序暴露给外部流量。</p><p id="7c51" class="pw-post-body-paragraph jk jl hi jm b jn kk jp jq jr kl jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">阿萨德·法伊兹<br/>创始人兼首席执行官<br/> Cloudplex.io</p></div></div>    
</body>
</html>