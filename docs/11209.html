<html>
<head>
<title>Versioning data and models in ML projects using DVC and AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 DVC 和 AWS S3 对 ML 项目中的数据和模型进行版本控制</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/versioning-data-and-models-in-ml-projects-using-dvc-and-aws-s3-286e664a7209?source=collection_archive---------0-----------------------#2020-11-23">https://medium.com/analytics-vidhya/versioning-data-and-models-in-ml-projects-using-dvc-and-aws-s3-286e664a7209?source=collection_archive---------0-----------------------#2020-11-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="04db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我们将详细探讨如何使用<a class="ae jd" href="https://dvc.org/doc/start" rel="noopener ugc nofollow" target="_blank"> DVC </a>对我们的数据和模型进行版本化。这个博客的代码可以在<a class="ae jd" href="https://github.com/bhuvanakundumani/NER_tf_dvc_s3" rel="noopener ugc nofollow" target="_blank">这里</a>找到。有关使用 Tensorflow2.2.0 对句子(<a class="ae jd" href="https://www.clips.uantwerpen.be/conll2003/ner/" rel="noopener ugc nofollow" target="_blank"> CoNLL-2003 数据集</a>)进行命名实体识别(NER)标记的模型训练的详细信息，请在此阅读博客<a class="ae jd" rel="noopener" href="/analytics-vidhya/ner-tensorflow-2-2-0-9f10dcf5a0a"/>。</p><h2 id="ad1a" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated"><strong class="ak">什么是 DVC？</strong></h2><p id="0a6e" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">数据版本控制，或 DVC，是一个数据和 ML 实验管理工具，非常类似于 Git。它帮助我们跟踪和保存数据和 ML 模型。DVC 将有关数据的信息保存在特殊的<a class="ae jd" href="https://dvc.org/doc/user-guide/dvc-files-and-directories" rel="noopener ugc nofollow" target="_blank">元文件</a>中，这些元文件替换了存储库中的数据。这些可以用常规的 Git 工作流(分支、拉请求等)来版本化。DVC 使用内置缓存来存储数据，并支持与 was s3、google drive、Microsoft azure、google cloud 等远程存储选项同步数据。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es ke"><img src="../Images/b56fc9446df8077858b5c88f07692537.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IE7FM99th8pDlIIKHWM2lg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated"><a class="ae jd" href="https://dvc.org/doc/use-cases/versioning-data-and-model-files" rel="noopener ugc nofollow" target="_blank"><em class="ku">DVC 代码和数据流</em> </a></figcaption></figure><p id="a546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将把数据文件夹中的数据、嵌入和模型输出存储在 S3 存储桶的 model_output 文件夹中。我已经创建了一个 s3 bucket s3://dvc-example。参考<a class="ae jd" href="https://docs.aws.amazon.com/AmazonS3/latest/gsg/CreatingABucket.html" rel="noopener ugc nofollow" target="_blank">链接</a>创建 S3 铲斗。</p><p id="a5cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从 dvc 开始吧。使用 pip 安装 dvc 包。要使用其他选项进行安装，请参考此<a class="ae jd" href="https://dvc.org/doc/install" rel="noopener ugc nofollow" target="_blank">链接</a>。还要安装 boto3、dvc[all]和 dvc[s3]包。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="8403" class="je jf hi kw b fi la lb l lc ld">pip install dvc <br/>pip boto3 dvc[all] dvc[s3]</span></pre><p id="8919" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装后，在 git 项目中初始化 dvc</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="187a" class="je jf hi kw b fi la lb l lc ld">dvc init</span></pre><p id="7ca2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du le lf lg kw b">.dvc/.gitignore</code>和<code class="du le lf lg kw b">.dvc/config</code>被创建。提交此更改</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="65ce" class="je jf hi kw b fi la lb l lc ld">git commit -m "Initialize DVC"</span></pre><p id="f1a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该项目的文件夹结构如下所示</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="4632" class="je jf hi kw b fi la lb l lc ld">├── data<br/>│   ├── train.txt<br/>│   ├── valid.txt<br/>│   ├── test.txt<br/>│<br/>├── embeddings<br/>│   ├── glove.6B.100d.txt<br/>│   <br/>├── model_output<br/>│   ├── checkpoint<br/>│   ├── embedding.pkl<br/>│   ├── idx2Label.pkl<br/>│   ├── model_weights.data-00000-of-00001<br/>│   ├── model_weights.index<br/>│   ├── word2Idx.pkl</span></pre><p id="6ef1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将不得不跟踪数据、嵌入和模型输出目录。让我们首先用 dvc 跟踪数据文件夹。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="644e" class="je jf hi kw b fi la lb l lc ld">dvc add data</span></pre><p id="c2df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DVC 将文件内容移动到缓存中。它还在数据文件夹中创建一个名为<code class="du le lf lg kw b">data.dvc</code>的相应的<code class="du le lf lg kw b"><a class="ae jd" href="https://dvc.org/doc/user-guide/dvc-files-and-directories#dvc-files" rel="noopener ugc nofollow" target="_blank">.dvc</a></code>文件来跟踪文件，使用它的路径和散列来标识缓存的数据。它还将文件添加到数据文件夹<code class="du le lf lg kw b">.gitignore</code>中，以防止它们被提交到 Git 存储库中。</p><p id="e48d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提交。git 中的 dvc 文件。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="b472" class="je jf hi kw b fi la lb l lc ld">git add data.dvc<br/>git commit -m “add data”</span></pre><p id="fbed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，使用 dvc 跟踪嵌入文件夹和 model_output 文件夹，使用如下所示的代码。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="c214" class="je jf hi kw b fi la lb l lc ld">dvc add embeddings<br/>git add embeddings.dvc<br/>git commit -m “add embeddings”<br/>dvc add model_output<br/>git add model_output.dvc<br/>git commit -m “add models”</span></pre><p id="f7b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们设置 s3 存储桶:S3://DVC——远程存储的例子。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="5d80" class="je jf hi kw b fi la lb l lc ld">dvc remote add -d remote s3://dvcexample/ner</span></pre><p id="62fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令在 DVC 项目的<a class="ae jd" href="https://dvc.org/doc/command-reference/config" rel="noopener ugc nofollow" target="_blank">配置文件</a>中创建一个<code class="du le lf lg kw b">remote</code>部分，并可选地将<code class="du le lf lg kw b">core</code>部分中的一个<em class="lh">默认遥控器</em>分配给 myremote。</p><p id="62ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要为 s3 存储桶设置 aws 访问密钥 id 和秘密访问密钥</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="8fc3" class="je jf hi kw b fi la lb l lc ld">dvc remote modify myremote access_key_id AWS_ACCESS_KEY_ID<br/>dvc remote modify myremote secret_access_key AWS_SECRET_ACCESS_KEY</span></pre><p id="9d12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(注意:用您的 AWS_KEY_ID 替换 AWS_ACCESS_KEY_ID，用您的 AWS_SECRET_ACCESS_KEY 替换 AWS_SECRET_ACCESS_KEY。您不需要使用双引号)</p><p id="00be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于您的远程存储器的信息被捕获并存储在<code class="du le lf lg kw b">.dvc/config</code>中。它还有 s3 存储桶名、访问密钥 id 和秘密访问密钥。请确保在按下时删除访问密钥 id 和机密访问密钥。要 git 的配置文件。或者，您可以使用 credentialpath，这将在下面的使用 credentialpath 标题下详细介绍。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="e9f0" class="je jf hi kw b fi la lb l lc ld">[core]</span><span id="b4b9" class="je jf hi kw b fi li lb l lc ld">      remote = myremote</span><span id="0bcc" class="je jf hi kw b fi li lb l lc ld">['remote "myremote"']</span><span id="0c39" class="je jf hi kw b fi li lb l lc ld">      url = s3://dvcexample/ner</span><span id="ac26" class="je jf hi kw b fi li lb l lc ld">      access_key_id = AWS_ACCESS_KEY_ID</span><span id="2548" class="je jf hi kw b fi li lb l lc ld">      secret_access_key = AWS_SECRET_ACCESS_KEY</span></pre><p id="62ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经配置了 s3 远程存储，让我们推送数据、嵌入和模型输出文件。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="c69a" class="je jf hi kw b fi la lb l lc ld">dvc push</span></pre><p id="6f1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这三个目录中的所有文件现在都被推送到 s3 存储中。</p><p id="5ce2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们将<code class="du le lf lg kw b">.dvc/config</code>文件提交给 git。确保从<code class="du le lf lg kw b">.dvc/config</code>文件中删除 AWS_ACCESS_KEY_ID 和 AWS_SECRET_ACCESS_KEY。酷！！！数据和模型存储在远程存储器中，dvc 帮助您对其进行版本化。</p><p id="6031" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们将代码推送给 git。假设它在主支行，</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="44cd" class="je jf hi kw b fi la lb l lc ld">git push origin master</span></pre><h1 id="9f2b" class="lj jf hi bd jg lk ll lm jk ln lo lp jo lq lr ls jr lt lu lv ju lw lx ly jx lz bi translated">使用凭据路径</h1><p id="a8f9" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">让我们使用 aws cli 配置 aws。确保您已经安装了 awscli。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="3014" class="je jf hi kw b fi la lb l lc ld">pip install awscli</span></pre><p id="d179" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后在终端中输入<code class="du le lf lg kw b">aws configure</code>。</p><p id="60a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您输入此命令时，AWS CLI 会提示您输入四条信息。键入您的访问密钥 ID、秘密访问密钥、AWS 区域和输出格式。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="cf93" class="je jf hi kw b fi la lb l lc ld">$ <strong class="kw hj">aws configure</strong> <br/>AWS Access Key ID [None]: <em class="lh">AKIAIOSFODNN7EXAMPLE</em> <br/>AWS Secret Access Key [None]: <em class="lh">wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</em> <br/>Default region name [None]: <em class="lh">us-west-2</em> <br/>Default output format [None]: <em class="lh">json</em></span></pre><p id="36f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS CLI 将这些信息存储在<code class="du le lf lg kw b">credentials</code>文件中名为<code class="du le lf lg kw b">default</code>的<em class="lh">配置文件</em>(一组设置)中。<code class="du le lf lg kw b"><strong class="ih hj">~/.aws/credentials</strong></code> <strong class="ih hj"> </strong>文件具有访问密钥 id 和秘密访问密钥。与下图非常相似。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="34ba" class="je jf hi kw b fi la lb l lc ld">[default] <br/>aws_access_key_id=AKIAIOSFODNN7EXAMPLE aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span></pre><p id="5253" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然您已经配置了 aws。您可以使用 credentialpath 来代替密钥。这将设置 s3 的访问。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="c317" class="je jf hi kw b fi la lb l lc ld">dvc remote modify myremote credentialpath ~/.aws/credentials</span></pre><p id="cb94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这实际上编辑了如下所示的<code class="du le lf lg kw b">.dvc/config</code>文件。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="8753" class="je jf hi kw b fi la lb l lc ld">[core]</span><span id="143b" class="je jf hi kw b fi li lb l lc ld">    remote = myremote</span><span id="da4e" class="je jf hi kw b fi li lb l lc ld">['remote "myremote"']</span><span id="d17f" class="je jf hi kw b fi li lb l lc ld">    url = s3://dvcexample/ner</span><span id="aeef" class="je jf hi kw b fi li lb l lc ld">    credentialpath = /Users/user1/.aws/credentials</span></pre><h1 id="749e" class="lj jf hi bd jg lk ll lm jk ln lo lp jo lq lr ls jr lt lu lv ju lw lx ly jx lz bi translated">获取数据和模型</h1><p id="224e" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">团队需要做的就是 git 克隆存储库。设置虚拟环境。在 requirements.txt 文件中安装所有需要的文件。记住，<code class="du le lf lg kw b">.dvc/config</code>没有 AWS_ACCESS_KEY_ID 和 AWS_SECRET_ACCESS_KEY。用您在<code class="du le lf lg kw b">.dvc/config</code>文件中的凭证替换 AWS_ACCESS_KEY_ID 和 AWS_SECRET_ACCESS_KEY。</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="aad7" class="je jf hi kw b fi la lb l lc ld">dvc pull </span></pre><p id="2536" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令提取所有的数据、嵌入和 model_output 文件。你都准备好了。</p><h1 id="4469" class="lj jf hi bd jg lk ll lm jk ln lo lp jo lq lr ls jr lt lu lv ju lw lx ly jx lz bi translated">数据/模型的变化</h1><p id="40f9" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">假设您正在更改 train.py 中的一些超参数，并训练一个新模型。训练之后，model_output 有了新的模型文件。你需要做的就是</p><pre class="kf kg kh ki fd kv kw kx ky aw kz bi"><span id="f6ae" class="je jf hi kw b fi la lb l lc ld">dvc add model_output<br/>git commit model_output.dvc -m 'model updates'<br/>dvc push<br/>git push origin master</span></pre><p id="7970" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">像<code class="du le lf lg kw b">git checkout</code>一样，我们可以使用<code class="du le lf lg kw b">dvc checkout</code>在不同版本的数据之间切换。</p><h1 id="a27d" class="lj jf hi bd jg lk ll lm jk ln lo lp jo lq lr ls jr lt lu lv ju lw lx ly jx lz bi translated">参考</h1><div class="ma mb ez fb mc md"><a href="https://towardsdatascience.com/introduction-to-dvc-data-version-control-tool-for-machine-learning-projects-7cb49c229fe0" rel="noopener follow" target="_blank"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">DVC 介绍:机器学习项目的数据版本控制工具</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">就像 Git 一样，但是有数据！</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">towardsdatascience.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr ko md"/></div></div></a></div><p id="4312" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://dvc.org/" rel="noopener ugc nofollow" target="_blank">https://dvc.org/</a></p></div></div>    
</body>
</html>