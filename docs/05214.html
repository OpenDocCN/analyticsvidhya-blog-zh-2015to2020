<html>
<head>
<title>Telegram Bot (quick start manual)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">电报机器人(快速入门手册)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/telegram-bot-quick-start-manual-8339a1d19765?source=collection_archive---------7-----------------------#2020-04-14">https://medium.com/analytics-vidhya/telegram-bot-quick-start-manual-8339a1d19765?source=collection_archive---------7-----------------------#2020-04-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="38ac" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Flask (Python)，python-telegram-bot库，webhooks，部署到Heroku</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/77530dec013f39beb90f62533cc6335f.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*-VMAyBgL79xG_flfe9_XQw.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">应用组件之间的流程</figcaption></figure><p id="2447" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">Telegram超级爽！不仅仅是因为聚集在他周围的社区，也是因为机器人的功能。总的来说——当你不想关心客户端应用程序开发，不想激励人们下载你的应用程序并保持更新时，机器人是有用的。是的，在2020年，每个人都不想在手机屏幕上多一个图标，所以使用电报作为沟通和用户互动的渠道可能是一个好主意。</p><p id="fd67" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">不幸的是，就像2020年的大多数东西一样，你不能只开始编码业务逻辑，即使是简单的休闲应用。这本手册将展示如何使用简单和免费的积木来样板你的应用程序。</p><p id="d66d" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">我们将使用Heroku作为我们的应用程序运行的平台。这对于小项目是绝对免费的，作为PaaS解决方案，它完全关心如何设置web服务器、SSL和其他基础设施。</p><h1 id="a908" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">所以我们来编码吧！</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es ko"><img src="../Images/7703563ce8f8520207c85d0b0e4272c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d5OMnkRksBjQf8Ix5966MA.png"/></div></div></figure><p id="2bdd" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">打开电报，在聊天搜索中找到BotFather，发送/newbot命令。以某种方式命名新机器人。作为回复，您将获得令牌和链接到机器人。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="8293" class="ky ig hi ku b fi kz la l lb lc">Use this token to access the HTTP API:<br/>1214342961:ACGCc7nACifIsyr1ZSxGiLNPIszbWqkDNNo<br/>---<br/>Done! Congratulations on your new bot. You will find it at t.me/test_creatiww_bot.</span></pre><p id="d289" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">现在，我们需要创建几个项目文件，其结构如下。为了简单起见，它将尽可能平坦。根据文件夹和文件的层次结构来放置带有逻辑的Python包要好得多，但是因为我们只有一个文件，所以它将与项目中的所有其他文件一起位于一个根文件夹中。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="3580" class="ky ig hi ku b fi kz la l lb lc">$ tree -a -L 1<br/>.<br/>├── .git               <br/>├── .gitignore       &lt;--we don't want to commit venv folder<br/>├── Procfile         &lt;--instructions for Heroku how to run the app<br/>├── app.py           &lt;--business logic is here<br/>├── requirements.txt &lt;--libraries required by app<br/>└── venv             &lt;--virtual environment files</span></pre><p id="37be" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">为此，请在终端中输入以下命令:</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="3a59" class="ky ig hi ku b fi kz la l lb lc"># create project folder<br/>$ mkdir tbot; cd tbot</span><span id="4996" class="ky ig hi ku b fi ld la l lb lc"># activate Python virtual environment<br/>$ python3 -m venv ./venv    <br/>$ source venv/bin/activate</span><span id="7092" class="ky ig hi ku b fi ld la l lb lc"># install required libraries<br/>$ pip install python-telegram-bot flask gunicorn</span><span id="0500" class="ky ig hi ku b fi ld la l lb lc"># freeze requirements into the file<br/>$ pip freeze &gt; requirements.txt</span><span id="5ffd" class="ky ig hi ku b fi ld la l lb lc"># create file with instructions for Heroku how to run the app<br/>$ echo "web: gunicorn app:app" &gt; Procfile</span><span id="7582" class="ky ig hi ku b fi ld la l lb lc"># let's exclude virtual environment file from the repository<br/>$ echo "venv/" &gt; .gitignore</span><span id="2ab9" class="ky ig hi ku b fi ld la l lb lc"># initiate git repository<br/>$ git init</span><span id="7169" class="ky ig hi ku b fi ld la l lb lc"># create file<br/>$ touch app.py</span></pre><p id="0fe2" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">然后将代码粘贴到setup.py中，我们将使用<a class="ae kn" href="https://flask.palletsprojects.com/en/1.1.x/" rel="noopener ugc nofollow" target="_blank"> Flask </a> web框架和<a class="ae kn" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank"> python-telegram-bot </a>库。</p><p id="7a4b" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><strong class="jr hj"> app.py </strong></p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="0186" class="ky ig hi ku b fi kz la l lb lc">from flask import Flask, request<br/>import telegram<br/>import os<br/>import json</span><span id="366c" class="ky ig hi ku b fi ld la l lb lc">TOKEN = os.environ['TOKEN']<br/>bot = telegram.Bot(token=TOKEN)</span><span id="778c" class="ky ig hi ku b fi ld la l lb lc">app = Flask(__name__)</span><span id="9099" class="ky ig hi ku b fi ld la l lb lc"><a class="ae kn" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/{}'.format(TOKEN), methods=['POST'])<br/>def respond():<br/>    update = telegram.Update.de_json(request.get_json(force=True), bot)<br/>    chat_id = update.message.chat.id<br/>    msg_id = update.message.message_id<br/>    msg = update.message.text.encode('utf-8').decode()<br/>    bot.sendMessage(chat_id=chat_id, text=msg, reply_to_message_id=msg_id)<br/>    return 'ok'</span><span id="dec3" class="ky ig hi ku b fi ld la l lb lc"><a class="ae kn" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route('/', methods=['POST'])<br/>def index():<br/>    return 'ok'</span><span id="c6e5" class="ky ig hi ku b fi ld la l lb lc">if __name__ == '__main__':<br/>    app.run(threaded=True)</span></pre><p id="fd19" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">在<a class="ae kn" href="https://id.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>和新应用程序上创建账户。以某种方式命名它，在我们的例子中名称是“<em class="le">tbot-creation www</em>”。在我们部署代码之前，我们需要用BotFather给我们的令牌设置环境变量。令牌用于对电报后端的所有API调用。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="df73" class="ky ig hi ku b fi kz la l lb lc">$ heroku config:set TOKEN="1214342961:ACGCc7nACifIsyr1ZSxGiLNPIszbWqkDNNo"</span></pre><p id="ef9b" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">并且设置Webhook让Telegram了解我们的App在哪里。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="3714" class="ky ig hi ku b fi kz la l lb lc"># set<br/>$ curl <a class="ae kn" href="https://api.telegram.org/bot$(heroku" rel="noopener ugc nofollow" target="_blank">https://api.telegram.org/bot$(heroku</a> config:get TOKEN)/setWebhook\?url=$(heroku apps:info -s  | grep web_url | cut -d= -f2)$(heroku config:get TOKEN)</span><span id="99da" class="ky ig hi ku b fi ld la l lb lc"># test<br/>$ curl <a class="ae kn" href="https://api.telegram.org/bot$(heroku" rel="noopener ugc nofollow" target="_blank">https://api.telegram.org/bot$(heroku</a> config:get TOKEN)/getWebhookInfo</span></pre><p id="6440" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">最后，我们准备部署代码。</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="a1a3" class="ky ig hi ku b fi kz la l lb lc"># add files to repository and push it to Heroku<br/>$ heroku git:remote -a tbot-creatiwww<br/>$ git add .<br/>$ git commit -am "make it better"<br/>$ git push heroku master</span></pre><p id="e3cf" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">就是这样！</p><p id="6f6c" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">Heroku将通过汇集依赖项来开始构建项目，并将提供所需的服务。我们可以通过运行以下命令来跟踪错误和其他日志:</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="42ad" class="ky ig hi ku b fi kz la l lb lc">$ heroku logs --tail  --app tbot-creatiwww</span></pre><p id="626f" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">最后一步是测试我们的机器人。</p><p id="5499" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">只要通过电报客户端找到我们的新机器人(机器人父亲应该在创建时提供链接)并给他发送一些消息。如果一切正常，您应该会收到相同的回复消息。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es lf"><img src="../Images/a0a7c8dc57eecd4a7c30ab6025040056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WOEQIOauXioczWMyUONsIw.png"/></div></div></figure><p id="463b" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">所有的项目文件都可以在这里找到:<a class="ae kn" href="https://github.com/Creatiwww/tbot" rel="noopener ugc nofollow" target="_blank">https://github.com/Creatiwww/tbot</a></p></div></div>    
</body>
</html>