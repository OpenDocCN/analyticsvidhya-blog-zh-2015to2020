<html>
<head>
<title>Fetch-Cursor in SQL Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SQL Server中提取光标</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/fetch-cursor-in-sql-server-2684d2c7d36?source=collection_archive---------4-----------------------#2020-03-04">https://medium.com/analytics-vidhya/fetch-cursor-in-sql-server-2684d2c7d36?source=collection_archive---------4-----------------------#2020-03-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5234" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当需要逐行提交数据时，使用SQL游标。尽管性能不佳，我们仍然使用游标进行数据库开发和报告。</p><p id="75f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基本提取光标步骤:</p><p id="5827" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1-声明游标。</p><p id="2a44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2-你用光标做什么？编写将要进行逐行操作的select语句。</p><p id="17e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3-打开光标。</p><p id="10e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4-Write fetch next语句。将光标中的特定值赋给变量。</p><p id="9ff3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5-While循环。开始和继续数据处理的条件。</p><p id="c9ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6-您应该在while循环中使用fetch next语句。</p><p id="2035" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7-关闭游标，然后用deallocate语句销毁游标。</p><p id="780c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">样品-1</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="fbf6" class="jm jn hi ji b fi jo jp l jq jr">use AdventureWorks2017<br/>go</span><span id="3839" class="jm jn hi ji b fi js jp l jq jr">DECLARE Location_Cursor CURSOR FOR<br/>select LocationID,Name,CostRate <br/>from Production.Location<br/>OPEN Location_Cursor;<br/>FETCH NEXT FROM Location_Cursor;<br/>WHILE @@FETCH_STATUS = 0<br/> BEGIN<br/> FETCH NEXT FROM Location_Cursor;<br/> END;<br/>CLOSE Location_Cursor;<br/>DEALLOCATE Location_Cursor;<br/>GO</span></pre><p id="0ed0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">样品-2</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="98fc" class="jm jn hi ji b fi jo jp l jq jr">use master</span><span id="592d" class="jm jn hi ji b fi js jp l jq jr">declare @database_name nvarchar(100);<br/>declare @lgname  nvarchar(100);</span><span id="aeef" class="jm jn hi ji b fi js jp l jq jr">declare crs cursor for<br/>select original_login_name, DB_NAME(database_id) as db_nm<br/>from sys.dm_exec_sessions where is_user_process=1;</span><span id="3f1c" class="jm jn hi ji b fi js jp l jq jr">open crs</span><span id="c792" class="jm jn hi ji b fi js jp l jq jr">fetch next from crs into @lgname, @database_name</span><span id="e476" class="jm jn hi ji b fi js jp l jq jr">while @@FETCH_STATUS=0</span><span id="41e6" class="jm jn hi ji b fi js jp l jq jr">begin</span><span id="6bed" class="jm jn hi ji b fi js jp l jq jr">print 'Login:'+cast(@lgname as nvarchar(100))+' Database Name:'+@database_name</span><span id="1504" class="jm jn hi ji b fi js jp l jq jr">fetch next from crs into @lgname, @database_name</span><span id="2db3" class="jm jn hi ji b fi js jp l jq jr">end</span><span id="cdbf" class="jm jn hi ji b fi js jp l jq jr">close crs<br/>deallocate crs;</span></pre><p id="79d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们通常使用光标样本的这些给定默认选项(样本-1、样本-2)。有时可能会很贵。但是，还有其他选择吗？是的，有。并且在这个站点中有很多方法的讲解:<a class="ae jt" href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/declare-cursor-transact-sql?redirectedfrom=MSDN&amp;view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/SQL/t-SQL/language-elements/declare-cursor-transact-SQL？redirectedfrom = MSDN&amp;view = SQL-server-ver 15</a></p><p id="74f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用这个脚本来比较几个提取光标选项。允许您取消对选项的注释并查看持续时间。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1c3d" class="jm jn hi ji b fi jo jp l jq jr">drop table if exists tempdb.dbo.#tmpCursor<br/>create table #tmpCursor(<br/>id int identity(1,1),<br/>obid int <br/>)<br/>go</span><span id="4af4" class="jm jn hi ji b fi js jp l jq jr">DECLARE <a class="ae jt" href="http://twitter.com/StartTime" rel="noopener ugc nofollow" target="_blank">@StartTime</a> datetime,<a class="ae jt" href="http://twitter.com/EndTime" rel="noopener ugc nofollow" target="_blank">@EndTime</a> datetime <br/>SELECT <a class="ae jt" href="http://twitter.com/StartTime" rel="noopener ugc nofollow" target="_blank">@StartTime</a>=GETDATE()</span><span id="79a6" class="jm jn hi ji b fi js jp l jq jr">DECLARE <a class="ae jt" href="http://twitter.com/i" rel="noopener ugc nofollow" target="_blank">@i</a> INT = 1;<br/> <br/>DECLARE cur CURSOR<br/> --LOCAL<br/> --LOCAL STATIC<br/> --LOCAL FAST_FORWARD<br/> --LOCAL FORWARD_ONLY<br/>FOR<br/> SELECT c.[object_id] <br/> FROM sys.objects AS c<br/> CROSS JOIN (SELECT TOP 200 name FROM sys.objects) AS c2<br/> ORDER BY c.[object_id];<br/> <br/>OPEN cur;<br/>FETCH NEXT FROM cur INTO <a class="ae jt" href="http://twitter.com/i" rel="noopener ugc nofollow" target="_blank">@i</a>;<br/> <br/>WHILE (@@FETCH_STATUS = 0)<br/>BEGIN<br/> insert into #tmpCursor<br/> values(<a class="ae jt" href="http://twitter.com/i" rel="noopener ugc nofollow" target="_blank">@i</a>)<br/> FETCH NEXT FROM cur into <a class="ae jt" href="http://twitter.com/i" rel="noopener ugc nofollow" target="_blank">@i</a><br/>END<br/> <br/>CLOSE cur;<br/>DEALLOCATE cur;</span><span id="4031" class="jm jn hi ji b fi js jp l jq jr">SELECT <a class="ae jt" href="http://twitter.com/EndTime" rel="noopener ugc nofollow" target="_blank">@EndTime</a>=GETDATE() <br/>SELECT DATEDIFF(ms,<a class="ae jt" href="http://twitter.com/StartTime" rel="noopener ugc nofollow" target="_blank">@StartTime</a>,<a class="ae jt" href="http://twitter.com/EndTime" rel="noopener ugc nofollow" target="_blank">@EndTime</a>) AS [Duration in microseconds]</span></pre><p id="11b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你选择快进，你会发现它比其他的要快。但是，根据它的良好性能。我不建议取光标操作。因为Sql server更适合<strong class="ih hj">集合操作</strong>。光标逐行操作<strong class="ih hj">因此可能会很慢。它们使用<strong class="ih hj">更多的内存</strong>，有时<strong class="ih hj">会导致阻塞</strong>。</strong></p></div></div>    
</body>
</html>