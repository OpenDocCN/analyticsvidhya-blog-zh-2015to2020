<html>
<head>
<title>Masking in Transformers’ self-attention mechanism</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">变形金刚自我注意机制中的掩蔽现象</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/masking-in-transformers-self-attention-mechanism-bad3c9ec235c?source=collection_archive---------0-----------------------#2020-01-27">https://medium.com/analytics-vidhya/masking-in-transformers-self-attention-mechanism-bad3c9ec235c?source=collection_archive---------0-----------------------#2020-01-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ef4f7b8f7a010833572616a6e99ba112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V9SYMG-wzkXGE7IsTrdNDQ.png"/></div></div></figure><p id="8ab8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要掩蔽来防止转换器的注意力机制在训练时在解码器中“作弊”(例如，在翻译任务中)。这种“防作弊屏蔽”在编码器端不存在。</p><p id="220c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我很难理解解码器是如何屏蔽的，这就是我写这篇文章的原因。希望它也能帮助其他人。</p><p id="aa3b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我开始之前，理解变形金刚的一个很好的入门读物是杰伊的阿拉玛文章“<a class="ae jo" href="http://jalammar.github.io/illustrated-transformer/" rel="noopener ugc nofollow" target="_blank">http://jalammar.github.io/illustrated-transformer/</a>”。</p><p id="ed3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从一个例子开始:</p><p id="44de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们有下面的序列作为解码器的输入:“我爱它”，那么位置1(“I”)处的标记的预期预测是下一个位置(“love”)处的标记。类似地，对标记“我爱”的预期预测是“它”。</p><p id="2f1b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当使用所有先前的标记给出预测时，我们不希望注意机制共享关于在下一个位置的标记的任何信息。</p><p id="fae3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了确保做到这一点，我们在自我关注计算的softmax步骤之前屏蔽了未来的位置(将它们设置为<code class="du jp jq jr js b">-inf</code>)。</p><p id="d89c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是一个注释示例，总结了屏蔽如何与两个令牌长序列(“Hello there例如):</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/2908f5e45e54ff8f5d38bc5e68a0f353.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2r4UGVk294c2SqehqPwLLA.jpeg"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">我不擅长画画</figcaption></figure><h1 id="fe15" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">放大:</h1><h2 id="ca01" class="la kd hi bd ke lb lc ld ki le lf lg km jb lh li kq jf lj lk ku jj ll lm ky ln bi translated">第一部分:</h2><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/7baaf83e71432ec24128ea8ebe80de42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*CYoEx5tvN152kh0GAlRAMw.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">第一部分</figcaption></figure><p id="84c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第一部分中，我展示了如何从X创建Q矩阵(这个过程对于V和K矩阵是相似的)。</p><p id="c077" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">x的大小如下:<br/> - 2是序列长度<br/> - 4是嵌入维数</p><p id="b4c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Wq的大小如下:<br/> - 4(嵌入维数)<br/> - 4，因为为了简化的目的我们假设Wq是一个方阵。现实稍微复杂一些，但是我们不需要了解更多来理解掩蔽机制。</p><p id="94cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">得到的Q、V和K矩阵具有以下大小:<br/> - 2，这是序列长度<br/> - 4</p><h2 id="5448" class="la kd hi bd ke lb lc ld ki le lf lg km jb lh li kq jf lj lk ku jj ll lm ky ln bi translated">第二部分:</h2><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/b468e03a9170dc660e12e0a87f132261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*OpihuIBHtX1UglxgAURVNg.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">第二部分</figcaption></figure><p id="4f8f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第二部分，我写了一个公式，总结了自我注意机制的步骤(更详细的解释见<a class="ae jo" href="http://jalammar.github.io/illustrated-transformer/" rel="noopener ugc nofollow" target="_blank">http://jalammar.github.io/illustrated-transformer/</a>)。</p><h2 id="5e56" class="la kd hi bd ke lb lc ld ki le lf lg km jb lh li kq jf lj lk ku jj ll lm ky ln bi translated">第三节:</h2><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/e28c8d3485f01d59d9b9259cd2fae934.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ad2GYyReh4JIYx_Cm5iZPg.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">第三节</figcaption></figure><p id="c7ab" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第三节中，我展示了矩阵“I”的值，它是Q和Kt的点积的结果:A，B，C和d。</p><p id="7cf4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可以看到对来自在第一位置(q1和k1)嵌入令牌的值的操作结果。</p><p id="0490" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这与B形成对比，B的值来自于在第一和第二位置(q1和<strong class="is hj"> k2 </strong>)的标记的嵌入。</p><p id="7b59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> N.B: </strong> q1=x1*Wq，k2=x2*Wk，其中x1和x2分别是第一个和第二个标记“hello”和“there”的嵌入。</p><h2 id="583f" class="la kd hi bd ke lb lc ld ki le lf lg km jb lh li kq jf lj lk ku jj ll lm ky ln bi translated">第四节:</h2><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/cf67a9366387d4f122115c44c392f401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZIbw8g12RF9x6kND-Q9XGg.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">第四节</figcaption></figure><p id="a7c0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第四部分，我做了同样的工作，分析我们最终值的组成(矩阵F)。<br/>它概述了如果我们不添加掩蔽机制，自我注意是如何让解码器窥视未来位置的。</p><p id="f821" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">softmax操作将分数归一化，因此它们都是正的，加起来等于1。</p><p id="5afa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们看到，如果我们想要遵守“不要向前看”的规则，我们需要将I’矩阵的值b’设置为零(用I’=softmax(i/dk^(1/2))).</p><p id="1216" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们通过在softmax操作之前向I添加掩码来获得结果，如下所示:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es ls"><img src="../Images/bac2825db333cf01c4116d4ec2382f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*vr_nECS9Y4GdS-TuSL262A.png"/></div></figure><p id="1ad4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其中:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/0517ba4856841ecf93c6cbf093a0c56e.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*ugdKZrNJns9pmKZJGDNsIw.png"/></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/b0855af4a0c1b77096ca2c510c8b1565.png" data-original-src="https://miro.medium.com/v2/resize:fit:432/format:webp/1*QIqJMz6v2K7sGWi8_dZYhw.png"/></div></figure><p id="9e23" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后我们有:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/b959b71a4ff71b07a937171dffdc87a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:484/format:webp/1*7O8hlPnDVQNTTq1zdSxSbg.png"/></div></figure><p id="9820" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们用“屏蔽开”来重复运算以获得F:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/6226076722c11cf542099e0979e603d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*f3nlV2e-BYT-hTvRoOOOLg.png"/></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">没有来自x2/“那里”的信息</figcaption></figure><p id="4b50" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我将使用Jay文章中的一个图像来总结在两个令牌长序列上掩蔽所发生的事情。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/475d00fb6f371d230ade5735a5faed47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h8xL9h6qIkqv8AvlSOCEXQ.jpeg"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx translated">来自杰伦的文章</figcaption></figure><p id="394c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。请告诉我你是否发现了什么错误，或者它是否帮助你理解了如何在下面的评论区使用屏蔽来防止“偷看”！</p></div></div>    
</body>
</html>