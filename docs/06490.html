<html>
<head>
<title>Integrating Cognito with Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Cognito与Flask集成</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/integrating-cognito-with-flask-e00010866054?source=collection_archive---------0-----------------------#2020-05-24">https://medium.com/analytics-vidhya/integrating-cognito-with-flask-e00010866054?source=collection_archive---------0-----------------------#2020-05-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d4246c039b5c2109517fed74fd420b8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yCuXkBbkJxSkw6iI8ohrhw.jpeg"/></div></div></figure><p id="d560" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">简介非常简单——“我们有一个小Flask应用程序，需要一个受保护的区域，我们不想开发自己的应用程序，所以我们认为Cognito可以很好地工作”。这是一个聪明的想法，既然AWS的研究人员已经为你做了思考，为什么还要去构建自己的认证服务呢？</p><p id="9052" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但事实证明，将Cognito集成到Flask应用程序中是一件非常容易的事情，一旦你知道如何做，就会感到沮丧，直到所有这些都合在一起。当然，在我开始看这个之前，我几乎不会拼写JWT，这一事实对我没有帮助，而且我对亚马逊呜呜呜鸟的生命周期的了解比我对Javascript之类的前端东西的了解还要多！</p><p id="73aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">什么是烧瓶？</strong></p><p id="8bcd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Flask是一个用Python构建web应用程序的微型框架。和Django一样，它也是最流行的web框架之一，我个人认为它很酷，因为它很容易上手。几分钟之内，你就可以有一个基本的网站了，而且，对我来说，Flask最大的好处之一就是在AWS Lambda上运行非常容易。你永远不会有太多的无服务器的好处(无服务器很酷，做无服务器的人很酷)。</p><p id="ad8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">亚马逊认知是什么？</strong></p><p id="7e52" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我会引用AWS的聪明人的话；</p><p id="8f69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jo"> Amazon Cognito为你的网络和移动应用提供认证、授权和用户管理。你的用户可以用用户名和密码直接登录，或者通过第三方，如脸书、亚马逊、谷歌或苹果。</em></p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jp"><img src="../Images/efb0d2fc306045e9d7a50c3732b81011.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*LQyxGP889OAdT9PAnApfjg.png"/></div></figure><p id="a38a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Cognito甚至提供了一个托管的ui，可以处理用户创建、用户验证、密码重置和所有其他您期望的功能。这是一个非常好的系统，随着前五万名用户永久被覆盖在免费层之下，这是一种非常经济有效的方式来开始向您的应用程序添加身份验证。</p><p id="31ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">样本应用</strong></p><p id="6f8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想在家继续学习，那么你需要设置示例应用程序的所有代码都可以在；</p><div class="ju jv ez fb jw jx"><a href="https://github.com/CloudySnake/flask-cognito-integration" rel="noopener  ugc nofollow" target="_blank"><div class="jy ab dw"><div class="jz ab ka cl cj kb"><h2 class="bd hj fi z dy kc ea eb kd ed ef hh bi translated">CloudySnake/flask-认知-集成</h2><div class="ke l"><h3 class="bd b fi z dy kc ea eb kd ed ef dx translated">通过在GitHub上创建一个帐户，为CloudySnake/flask-cognito-integration开发做出贡献。</h3></div><div class="kf l"><p class="bd b fp z dy kc ea eb kd ed ef dx translated">github.com</p></div></div><div class="kg l"><div class="kh l ki kj kk kg kl io jx"/></div></div></a></div><p id="44c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个repo包括Terraform代码来支撑基础设施(包括Cognito)和无服务器框架，以在Lambda上部署web应用程序。</p></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><p id="6b68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基本的身份验证流程是这样的。</p><ul class=""><li id="63eb" class="kt ku hi is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb bi translated">用户在您的网站上选择“登录”或直接进入登录url。</li><li id="e313" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">用户被重定向到Cognito托管的ui——您可以为此使用一个自定义域，这样对用户来说就像从未离开过该站点一样。注意，我链接的示例代码只使用了应用程序的原始API网关URL，所以很明显，你正在从网站转移到AWS托管工具包。</li><li id="fb81" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">成功登录后，用户将被重定向回您网站上的特定登录点。这是在Cognito设置中配置的。</li><li id="c71a" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">重定向URL现在包含一个授权码，您的应用程序可以将该授权码转换为JWT访问令牌。</li><li id="c5a4" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">JWT存储为一个HTTPonly cookie(有效期为30分钟),当我们试图访问一个受保护的页面时，它被传递给web服务器并被验证。</li><li id="be7b" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">如果用户未通过身份验证并试图访问受保护的页面，他们将被定向到登录屏幕。</li></ul><p id="fd35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个流程使用了两个主要的库；</p><ul class=""><li id="a320" class="kt ku hi is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb bi translated">烧瓶-AWS cogni:<a class="ae lh" href="https://flask-awscognito.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">https://flask-awscognito.readthedocs.io/en/latest/</a></li><li id="9f80" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">烧瓶-JWT-扩展:【https://flask-jwt-extended.readthedocs.io/en/stable/】T2</li></ul><p id="b526" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">处理重定向URL </strong></p><p id="9a1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的示例应用程序在成功登录后会返回到端点/登录。</p><pre class="jq jr js jt fd li lj lk ll aw lm bi"><span id="522a" class="ln lo hi lj b fi lp lq l lr ls"><strong class="lj hj">@app.route</strong>("/loggedin", methods=["GET"])<br/><strong class="lj hj">def logged_in</strong>():<br/>    access_token = aws_auth.get_access_token(request.args)<br/>    resp = make_response(redirect(url_for("protected")))<br/>    set_access_cookies(resp, access_token, max_age=<strong class="lj hj">30 </strong>* <strong class="lj hj">60</strong>)<br/>    <strong class="lj hj">return </strong>resp</span></pre><p id="99c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">aws_auth.get_access_token是Flask-AWSCognito获取授权码并将其交换为访问令牌。然后，我将再次重定向到“受保护的”端点(在我的授权墙后面)，并将访问令牌存储为httpOnly cookie。cookie的有效期为30分钟，之后用户需要再次登录。</p><p id="42f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">保护页面</strong></p><pre class="jq jr js jt fd li lj lk ll aw lm bi"><span id="1927" class="ln lo hi lj b fi lp lq l lr ls"><strong class="lj hj">@app.route</strong>("/secret")<br/><strong class="lj hj">def protected</strong>():<br/>    verify_jwt_in_request_optional()<br/>    <strong class="lj hj">if </strong>get_jwt_identity():<br/>        <strong class="lj hj">return </strong>render_template("secret.html")<br/>    <strong class="lj hj">else</strong>:<br/>        <strong class="lj hj">return </strong>redirect(aws_auth.get_sign_in_url())</span></pre><p id="7d9f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">JWT提供了标准的decorators来检查访问cookie，但是我想确保如果用户没有通过认证，他们会被重定向到登录屏幕。对于标准装饰器，它们只返回一些错误JSON，所以我使用了一些JWT函数来创建我需要的流。我确信有一种方法可以让装饰者做到这一点，我只是需要多考虑一下。</p><p id="3d45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在基本水平上，这就是你所需要做的。您可以使用相同的方法轻松添加更多受保护的页面，从而构建一个保护非常好的web应用程序。我确信还有可以改进的地方，我已经列出了一些我下一步的想法，但是我也很想在评论中听到你的反馈。</p><p id="385f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">需要改进的地方</strong></p><ul class=""><li id="ce75" class="kt ku hi is b it iu ix iy jb kv jf kw jj kx jn ky kz la lb bi translated">额外的CSRF保护——JWT提供了开箱即用的保护，但我还不能让它与Cognito一起工作。</li><li id="6f0e" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">用户会在登录状态下发送超过30分钟的消息吗？我是否需要一种方法来允许这一点，而不是强制登录？</li><li id="7e79" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">注销按钮来清除访问cookie。</li><li id="eab2" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">使用更多的内置JWT函数来处理我的“未认证重定向”方法。</li><li id="10bc" class="kt ku hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">添加测试。是的，我构建了一些东西，但没有添加任何单元测试。请不要太苛刻地评价我。</li></ul></div></div>    
</body>
</html>