<html>
<head>
<title>Understanding Chatbot Context using Dialogflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dialogflow了解聊天机器人上下文</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/understanding-chatbot-context-using-dialogflow-b96906cc0c42?source=collection_archive---------0-----------------------#2019-08-19">https://medium.com/analytics-vidhya/understanding-chatbot-context-using-dialogflow-b96906cc0c42?source=collection_archive---------0-----------------------#2019-08-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ec2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，在我们的上一篇文章中:<a class="ae jd" rel="noopener" href="/@fouadromieh/build-a-chatbot-using-c-and-dialogflow-93b50be39d7c">使用C#和Dialogflow构建一个聊天机器人</a>我们已经看到了Dialogflow如何从意图的角度处理对话，即用户键入一条消息，它与预定义的意图匹配，如果匹配发生，则使用该意图的响应，否则将从默认的回退意图返回响应。</p><p id="d725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">真实世界的对话并不总是一个问题和一个回答，它通常是多个问题/输入触发多个回答/输出。例如，查看下面的场景表单<a class="ae jd" href="https://cloud.google.com/dialogflow/docs/contexts-overview" rel="noopener ugc nofollow" target="_blank">对话流文档</a>:</p><ol class=""><li id="5764" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">最终用户询问有关其支票账户的信息。</li><li id="de3c" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">Dialogflow将这个最终用户表达与<code class="du js jt ju jv b">CheckingInfo</code>意图相匹配。这个意图有一个<code class="du js jt ju jv b">checking</code>输出上下文，因此该上下文被激活。</li><li id="b239" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">代理向最终用户询问他们想要的关于其支票账户的信息类型。</li><li id="44f8" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">最终用户回复“我的余额”。</li><li id="4852" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">Dialogflow将这个最终用户的表达与<code class="du js jt ju jv b">CheckingBalance</code>的意图相匹配。这个意图有一个<code class="du js jt ju jv b">checking</code>输入上下文，它需要被激活以匹配这个意图。当<code class="du js jt ju jv b">savings</code>上下文活动时，也可能存在类似的<code class="du js jt ju jv b">SavingsBalance</code>意图来匹配相同的最终用户表达。</li><li id="1bcf" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在您的系统执行必要的数据库查询后，代理会以支票帐户余额作为响应。</li></ol><p id="0ee8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是聊天机器人上下文发挥作用的地方，以维护当前正在发生的对话的状态，其中也有以前的消息，可能还有相关的未来消息。正如你所看到的，在上面的例子中，第四个用户输入了“我的余额”，如果没有上下文，聊天机器人可能会回答:对不起，我不知道你是什么意思！</p><p id="1f28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，只有当对话发生在某个上下文中时，聊天机器人才会联系用户所指的内容。在聊天机器人开发世界中，上下文是一个非常重要的特性，它使我们接近人类的对话，这是构建聊天机器人的最终目标。</p><h1 id="d231" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">对话流上下文类型</h1><p id="59af" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">我不打算从官方文档中添加更多的解释:</p><blockquote class="kz la lb"><p id="cb15" class="if ig lc ih b ii ij ik il im in io ip ld ir is it le iv iw ix lf iz ja jb jc hb bi translated"><strong class="ih hj">输入和输出上下文</strong></p><p id="3f5e" class="if ig lc ih b ii ij ik il im in io ip ld ir is it le iv iw ix lf iz ja jb jc hb bi translated">通过上下文，您可以定义特定的状态来控制会话流，会话必须处于这些状态才能进行匹配。通常，如果Dialogflow的训练短语非常类似于最终用户的表达，则它匹配一个意图。但是，当您将上下文应用于某个意图时，如果上下文处于活动状态，Dialogflow将仅考虑该意图进行匹配。</p><p id="e7dd" class="if ig lc ih b ii ij ik il im in io ip ld ir is it le iv iw ix lf iz ja jb jc hb bi translated">有两种类型的上下文允许您激活和停用上下文，并且可以控制您的对话流:</p><p id="be2a" class="if ig lc ih b ii ij ik il im in io ip ld ir is it le iv iw ix lf iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/dialogflow/docs/contexts-input-output#input_contexts" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">输入上下文</strong> </a>:当应用于意图时，输入上下文告诉Dialogflow仅在最终用户表达式是近似匹配且上下文是活动的情况下才匹配意图。</p><p id="f1e2" class="if ig lc ih b ii ij ik il im in io ip ld ir is it le iv iw ix lf iz ja jb jc hb bi translated"><a class="ae jd" href="https://cloud.google.com/dialogflow/docs/contexts-input-output#output_contexts" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">输出上下文</strong> </a>:当应用于一个意图时，一个输出上下文告诉Dialogflow激活一个还没有激活的上下文，或者在该意图匹配后保持该上下文。</p></blockquote><p id="8b70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一个Dialogflow中上下文的实际例子。</p><h1 id="449f" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">扩展Hotelbooking代理以添加上下文</h1><p id="be46" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在我们为酒店预订演示聊天机器人构建的示例中，预订基于提供的人数和总住宿天数。我们将扩展这个来询问用户他/她是否喜欢他们房间的山景/海景，并且除了其他参数之外，还将这个新参数传递给我们的web hook:<em class="lc">total nights</em>和<em class="lc"> totalPersons </em></p><ol class=""><li id="a4df" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">转到Dialogflow控制台并单击<em class="lc">预订信息</em>意向。</li><li id="d2eb" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在上下文部分键入<em class="lc"> bookingInfoCtxt </em>作为输出上下文，然后单击enter。</li></ol><figure class="lh li lj lk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lg"><img src="../Images/9b643536da0787acab979a3727dca44a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Llg75j4DoeyoSpi2NoSHfQ.png"/></div></div></figure><p id="e125" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.转到<em class="lc">文本响应</em>部分，如下所示:</p><figure class="lh li lj lk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ls"><img src="../Images/a00f7c57c254b23a29cfc581dd7a51b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ruEWAuSBK_ZPAWFe_cpPqA.png"/></div></div></figure><p id="f770" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，在真实的场景中，您会希望用户以同样的意图告诉您偏好，因此这可以以不同的方式处理，但出于上下文演示的目的，本文将跳过这一步。</p><p id="0390" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.向下滚动到fulfillment部分并关闭:<em class="lc">为此目的启用webhook调用。</em>web hook调用将被转移到另一个意图<em class="lc">。</em></p><p id="6fdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您在上面看到的，我们为此意图创建了一个输出上下文，该输出上下文将用于传递给另一个意图，该意图捕获用户对其房间的视图偏好。让我们看看如何:</p><ol class=""><li id="313b" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建新的意图，并将其命名为房间视图。</li><li id="8d70" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在<em class="lc"> Contexts </em>部分，用我们在前面步骤中创建的值填充输入上下文:<em class="lc"> bookingInfoCtxt </em>并点击enter</li><li id="6ce3" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">对于训练短语，我刚刚添加了<em class="lc">海</em>和<em class="lc">山</em>的值，当然你可以添加更多来提高捕捉用户意图的准确性。</li><li id="37ee" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">点击<em class="lc">保存</em>，进入左侧菜单<em class="lc">实体</em>，新建一个实体，名为:<em class="lc">房间-视图-偏好</em>。实体只是一种可以从意图中提取的类型，我用下面的两个值创建了它。</li></ol><figure class="lh li lj lk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lt"><img src="../Images/df530af03a8ddbc241441dc9d341f1bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EU0vuS_d0uljcyZNObMdsg.png"/></div></div></figure><p id="4f06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.现在回到房间视图意图，为训练短语设置实体如下(两者都是):</p><figure class="lh li lj lk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lu"><img src="../Images/d0e6c9fc2b98273f2e4054d7b9e064bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQcobt2IIlC-F4JpDggSqw.png"/></div></div></figure><p id="f396" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.转到“操作和参数”部分，填写如下，通过使用#[ContextName]检查上下文中的参数。[ParamName]:</p><figure class="lh li lj lk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lv"><img src="../Images/f9644d5b6771ff26093f49809649ef55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ZpJ24yMSfNLuUj5ZiaIFg.png"/></div></div></figure><p id="bcd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.点击保存，让我们通过键入<code class="du js jt ju jv b">book me a room for 2 person 3 nights</code>在模拟器中尝试一下，您会注意到上下文填充如下:</p><figure class="lh li lj lk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lw"><img src="../Images/8a1039d28050ba726e85bb4446d1de76.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*fkCBArrawN-T7fAkRrH_kw.png"/></div></div></figure><p id="11f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在模拟器中键入<code class="du js jt ju jv b">Sea</code>或<code class="du js jt ju jv b">Mountain</code>来回答视图偏好的问题。请注意，我们提取了为此目的配置的3个值，其中2个不在上下文中。</p><figure class="lh li lj lk fd ll er es paragraph-image"><div class="er es lx"><img src="../Images/a0e7c199810ee0ec7bc378fd666fbae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*D6CCdy5ng2VFVAM466SStA.png"/></div></figure><p id="1ed7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.现在转到我们在上一篇文章<a class="ae jd" rel="noopener" href="/@fouadromieh/create-a-c-netcore-webhook-for-a-dialogflow-chatbot-e22d53c40d64">中创建的webhook，创建一个C#。net core webhook，并更新其代码以检索新的<code class="du js jt ju jv b">viewPreference</code>参数，还更新代码以根据用户的视图选择返回不同的价格。</a></p><pre class="lh li lj lk fd ly jv lz ma aw mb bi"><span id="ae6d" class="mc jx hi jv b fi md me l mf mg">public class BookingController : ControllerBase</span><span id="6a91" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="a640" class="mc jx hi jv b fi mh me l mf mg">// A Protobuf JSON parser configured to ignore unknown fields. This makes</span><span id="7c0f" class="mc jx hi jv b fi mh me l mf mg">// the action robust against new fields being introduced by Dialogflow.</span><span id="708f" class="mc jx hi jv b fi mh me l mf mg">private static readonly JsonParser jsonParser =</span><span id="c8b5" class="mc jx hi jv b fi mh me l mf mg">new JsonParser(JsonParser.Settings.Default.WithIgnoreUnknownFields(true));</span><span id="2c17" class="mc jx hi jv b fi mh me l mf mg">[HttpPost]</span><span id="7244" class="mc jx hi jv b fi mh me l mf mg">public ContentResult DialogAction()</span><span id="1d5f" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="c033" class="mc jx hi jv b fi mh me l mf mg">// Parse the body of the request using the Protobuf JSON parser,</span><span id="193b" class="mc jx hi jv b fi mh me l mf mg">// *not* Json.NET.</span><span id="2885" class="mc jx hi jv b fi mh me l mf mg">WebhookRequest request;</span><span id="7ea5" class="mc jx hi jv b fi mh me l mf mg">using (var reader = new StreamReader(Request.Body))</span><span id="5cc5" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="0cf9" class="mc jx hi jv b fi mh me l mf mg">request = jsonParser.Parse&lt;WebhookRequest&gt;(reader);</span><span id="2278" class="mc jx hi jv b fi mh me l mf mg">}</span><span id="7c6c" class="mc jx hi jv b fi mh me l mf mg">double totalAmount = 0;</span><span id="adbd" class="mc jx hi jv b fi mh me l mf mg">double totalNights = 0;</span><span id="9de0" class="mc jx hi jv b fi mh me l mf mg">double totalPersons = 0;</span><span id="bf29" class="mc jx hi jv b fi mh me l mf mg">string viewPreference;</span><span id="31f2" class="mc jx hi jv b fi mh me l mf mg">if (request.QueryResult.Action == “book”)</span><span id="41f2" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="0d4a" class="mc jx hi jv b fi mh me l mf mg">//Parse the intent params</span><span id="97b1" class="mc jx hi jv b fi mh me l mf mg">var requestParameters = request.QueryResult.Parameters;</span><span id="6231" class="mc jx hi jv b fi mh me l mf mg">totalPersons = requestParameters.Fields[“totalPersons”].NumberValue;</span><span id="10df" class="mc jx hi jv b fi mh me l mf mg">totalNights = requestParameters.Fields[“totalNights”].NumberValue;</span><span id="2d43" class="mc jx hi jv b fi mh me l mf mg">viewPreference = requestParameters.Fields[“viewPreference”].StringValue;</span><span id="754d" class="mc jx hi jv b fi mh me l mf mg">if (viewPreference == “Sea”)</span><span id="be0e" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="d880" class="mc jx hi jv b fi mh me l mf mg">totalAmount = totalNights * 200;</span><span id="9d50" class="mc jx hi jv b fi mh me l mf mg">}</span><span id="1c0e" class="mc jx hi jv b fi mh me l mf mg">else</span><span id="219d" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="5a42" class="mc jx hi jv b fi mh me l mf mg">totalAmount = totalNights * 100;</span><span id="4349" class="mc jx hi jv b fi mh me l mf mg">}</span><span id="2b60" class="mc jx hi jv b fi mh me l mf mg">}</span><span id="ae58" class="mc jx hi jv b fi mh me l mf mg">// Populate the response</span><span id="0aff" class="mc jx hi jv b fi mh me l mf mg">WebhookResponse response = new WebhookResponse</span><span id="fed3" class="mc jx hi jv b fi mh me l mf mg">{</span><span id="3a76" class="mc jx hi jv b fi mh me l mf mg">FulfillmentText = $”Thank you for choosing our hotel, your total amount for the {totalNights} nights for {totalPersons} persons will be {totalAmount} USD.”</span><span id="2c66" class="mc jx hi jv b fi mh me l mf mg">};</span><span id="ae92" class="mc jx hi jv b fi mh me l mf mg">// Ask Protobuf to format the JSON to return.</span><span id="85cc" class="mc jx hi jv b fi mh me l mf mg">// Again, we don’t want to use Json.NET — it doesn’t know how to handle Struct</span><span id="02f2" class="mc jx hi jv b fi mh me l mf mg">// values etc.</span><span id="2f9d" class="mc jx hi jv b fi mh me l mf mg">string responseJson = response.ToString();</span><span id="8b15" class="mc jx hi jv b fi mh me l mf mg">return Content(responseJson, “application/json”);</span><span id="5f38" class="mc jx hi jv b fi mh me l mf mg">}</span></pre><p id="2f16" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次部署您的webhook，并在模拟器中测试结果。您现在应该会从webhook获得以下响应，如果您在海景和山景之间切换，将会返回不同的价格:</p><figure class="lh li lj lk fd ll er es paragraph-image"><div class="er es mi"><img src="../Images/0946f2cb70b672676ef88b4cdc7d83e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*3wzb_KmuywnQdx_mu41Nzw.png"/></div></figure><p id="2a26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">聊天机器人领域中的上下文讨论肯定比这要多，但是我希望这篇文章能很好地介绍如何处理上下文。</p></div></div>    
</body>
</html>