<html>
<head>
<title>Large Scale Scikit Learn ML processing for batch scoring using Azure ML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure ML进行批量评分的大规模Scikit Learn ML处理</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/large-scale-scikit-learn-ml-processing-for-batch-scoring-using-azure-ml-f8606c2516b?source=collection_archive---------32-----------------------#2020-06-25">https://medium.com/analytics-vidhya/large-scale-scikit-learn-ml-processing-for-batch-scoring-using-azure-ml-f8606c2516b?source=collection_archive---------32-----------------------#2020-06-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="9ee2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">显示流程的流程图</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/5f17e5496a23755ed81b736c04413593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UrVhuImtIkOQ3l5M.jpg"/></div></div></figure><p id="90bd" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">下面的代码示例。代码运行所需的导入。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="fff5" class="ks ig hi ko b fi kt ku l kv kw">import os <br/>import urllib <br/>import shutil <br/>import azureml <br/>import pandas as pd <br/>from azureml.core import Experiment <br/>from azureml.core import Workspace, Run <br/>from azureml.core.compute import ComputeTarget, AmlCompute <br/>from azureml.core.compute_target import ComputeTargetException</span></pre><p id="c902" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">让我们配置工作区，以便笔记本知道使用哪个工作区。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="df48" class="ks ig hi ko b fi kt ku l kv kw">ws = Workspace.from_config()</span></pre><p id="a3a0" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">设置必要的项目文件夹。使用的临时文件夹。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="2b2c" class="ks ig hi ko b fi kt ku l kv kw">project_folder = './test-project' os.makedirs(project_folder, exist_ok=True) experiment = Experiment(workspace=ws, name='test-model')</span><span id="5319" class="ks ig hi ko b fi kx ku l kv kw">output_folder = './outputs' os.makedirs(output_folder, exist_ok=True)</span><span id="46f1" class="ks ig hi ko b fi kx ku l kv kw">result_folder = './results' os.makedirs(result_folder, exist_ok=True)</span></pre><p id="f351" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">设置模型将用于评分的分类。创建一个新的集群，或者使用现有的集群。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="b7d3" class="ks ig hi ko b fi kt ku l kv kw">from azureml.core.compute import ComputeTarget, AmlCompute <br/>from azureml.core.compute_target import ComputeTargetException <br/># Choose a name for your CPU cluster <br/>cpu_cluster_name = "testcluster" <br/># Verify that cluster does not exist already <br/>try: <br/>    cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)<br/>    print('Found existing cluster, use it.') <br/>except ComputeTargetException: <br/>    compute_config= AmlCompute.provisioning_configuration(vm_size='STANDARD_D14_V2', max_nodes=4) <br/>   cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)<br/>   cpu_cluster.wait_for_completion(show_output=True)</span></pre><p id="ed17" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">为上面要操作的集群选择默认映像和依赖关系。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="1a9d" class="ks ig hi ko b fi kt ku l kv kw">from azureml.core.runconfig import RunConfiguration <br/>from azureml.core.conda_dependencies import CondaDependencies <br/>from azureml.core.runconfig import DEFAULT_CPU_IMAGE <br/># Create a new runconfig object <br/>run_amlcompute = RunConfiguration() <br/># Use the cpu_cluster you created above. <br/>run_amlcompute.target = cpu_cluster <br/># Enable Docker <br/>run_amlcompute.environment.docker.enabled = True <br/># Set Docker base image to the default CPU-based image run_amlcompute.environment.docker.base_image = DEFAULT_CPU_IMAGE <br/># Use conda_dependencies.yml to create a conda environment in the Docker image for execution run_amlcompute.environment.python.user_managed_dependencies = False # Specify CondaDependencies obj, add necessary packages run_amlcompute.environment.python.conda_dependencies = CondaDependencies.create(conda_packages=['scikit-learn'])</span></pre><p id="0da5" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">编写批处理评分文件-这是如何使用具有新数据的模型并为预测的输入评分的逻辑所在。</p><p id="6cca" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">批量评分文件的过程是加载所有必要的库。然后加载我们将要使用的模型。</p><p id="1d77" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">模型加载后，主运行函数将把每个文件作为参数和分数。每个文件可以与一个节点平行排列，以便水平缩放。run函数打开每个文件，然后预测并保存输出。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="9810" class="ks ig hi ko b fi kt ku l kv kw">%%writefile batch_scoring.py <br/>import io <br/>import pickle <br/>import argparse <br/>import numpy as np <br/>import pandas as pd <br/>import joblib <br/>import os <br/>import urllib <br/>import shutil <br/>import azureml<br/> <br/>from azureml.core.model import Model <br/>from sklearn.linear_model import LogisticRegression <br/>from sklearn.ensemble import RandomForestClassifier </span><span id="ae50" class="ks ig hi ko b fi kx ku l kv kw">def init():<br/>    global test_model<br/><br/>    model_path = Model.get_model_path("sklearn_test)<br/><br/>    #model_path = Model.get_model_path(args.model_name)<br/>    with open(model_path, 'rb') as model_file:<br/>        test_model = joblib.load(model_file)<br/><br/><br/>def run(mini_batch):<br/>    # make inference    <br/>    print(f'run method start: {__file__}, run({mini_batch})')<br/>    resultList = []<br/>    for file in mini_batch:<br/>        input_data = pd.read_parquet(file, engine='pyarrow')<br/>        num_rows, num_cols = input_data.shape<br/>        X = input_data[[col for col in input_data.columns if "encoding" in col]]<br/>        y = input_data['test_flag']<br/><br/>        X = X[[col for col in X.columns if col not in ["xxxx_premium_range_encoding", "xyz_encoding"]]]<br/>        pred = test_model.predict(X).reshape((num_rows, 1))<br/><br/>    # cleanup output<br/>    #result = input_data.drop(input_data.columns[4:], axis=1)<br/>    result = X<br/>    result['variety'] = pred<br/><br/>    return result</span></pre><p id="bb4a" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">设置用于评分的输入数据源的时间。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="b27a" class="ks ig hi ko b fi kt ku l kv kw">from azureml.core.datastore import Datastore<br/><br/>batchscore_blob = Datastore.register_azure_blob_container(ws, <br/>                      datastore_name="inputdatastore", <br/>                      container_name="containername", <br/>                      account_name="storageaccoutnname",<br/>                      account_key="xxxxx",<br/>                      overwrite=True)<br/><br/>def_data_store = ws.get_default_datastore()</span></pre><p id="32be" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">存储输出评分文件的输出数据源。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="9be3" class="ks ig hi ko b fi kt ku l kv kw">from azureml.core.datastore import Datastore batchscore_blob_out = Datastore.register_azure_blob_container(ws, datastore_name="input_datastore", container_name="containername", account_name="storageaccountname", account_key="xxxxxxx", overwrite=True) def_data_store_out = ws.get_default_datastore()</span></pre><p id="1ca6" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">用数据集配置管道。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="988f" class="ks ig hi ko b fi kt ku l kv kw">from azureml.core.datastore import Datastore<br/><br/>batchscore_blob_out = Datastore.register_azure_blob_container(ws, <br/>                      datastore_name="input_datastore", <br/>                      container_name="containername", <br/>                      account_name="storageaccountname", <br/>                      account_key="xxxxxxx",<br/>                      overwrite=True)<br/><br/>def_data_store_out = ws.get_default_datastore()</span><span id="9620" class="ks ig hi ko b fi kx ku l kv kw">from azureml.core.dataset import Dataset<br/>from azureml.pipeline.core import PipelineData<br/><br/>input_ds = Dataset.File.from_files((batchscore_blob, "/"))<br/>output_dir = PipelineData(name="scores", <br/>                          datastore=def_data_store_out, <br/>                          output_path_on_compute="results")</span><span id="e8b4" class="ks ig hi ko b fi kx ku l kv kw">#Set Environments</span><span id="9627" class="ks ig hi ko b fi kx ku l kv kw">from azureml.core import Environment<br/>from azureml.core.conda_dependencies import CondaDependencies<br/>from azureml.core.runconfig import DEFAULT_CPU_IMAGE<br/><br/>cd = CondaDependencies.create(pip_packages=["scikit-learn", "azureml-defaults","pyarrow"])<br/>env = Environment(name="parallelenv")<br/>env.python.conda_dependencies = cd<br/>env.docker.base_image = DEFAULT_CPU_IMAGE</span></pre><p id="e5e0" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">配置管道参数</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="c8a2" class="ks ig hi ko b fi kt ku l kv kw">from azureml.pipeline.core import PipelineParameter<br/>from azureml.pipeline.steps import ParallelRunConfig<br/><br/>parallel_run_config = ParallelRunConfig(<br/>    #source_directory=scripts_folder,<br/>    entry_script="batch_scoring.py",<br/>    mini_batch_size='1',<br/>    error_threshold=2,<br/>    output_action='append_row',<br/>    append_row_file_name="test_outputs.txt",<br/>    environment=env,<br/>    compute_target=cpu_cluster, <br/>    node_count=3,<br/>    run_invocation_timeout=120)</span></pre><p id="baf0" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">配置管道步骤</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="4b60" class="ks ig hi ko b fi kt ku l kv kw">from azureml.pipeline.steps import ParallelRunStep<br/><br/>batch_score_step = ParallelRunStep(<br/>    name="parallel-step-test",<br/>    inputs=[input_ds.as_named_input("input_ds")],<br/>    output=output_dir,<br/>    #models=[model],<br/>    parallel_run_config=parallel_run_config,<br/>    #arguments=['--model_name', 'sklearn_touring'],<br/>    allow_reuse=True<br/>)</span></pre><p id="be52" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">执行管道。</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="cdf1" class="ks ig hi ko b fi kt ku l kv kw">from azureml.core import Experiment<br/>from azureml.pipeline.core import Pipeline<br/><br/>pipeline = Pipeline(workspace=ws, steps=[batch_score_step])<br/>pipeline_run = Experiment(ws, 'batch_scoring').submit(pipeline)<br/>pipeline_run.wait_for_completion(show_output=True)</span></pre><p id="2002" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">显示实验运行状态</p><pre class="je jf jg jh fd kn ko kp kq aw kr bi"><span id="5610" class="ks ig hi ko b fi kt ku l kv kw">from azureml.widgets import RunDetails<br/>RunDetails(pipeline_run).show()</span></pre><p id="b779" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">管道运行结束。</p><p id="7010" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">要获得输出和调试，请单击链接<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/machine-learning/how-to-debug-parallel-run-step" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/machine-learning/how-to-debug-parallel-run-step</a></p></div><div class="ab cl kz la gp lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="hb hc hd he hf"><p id="8b62" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><em class="lg">最初发表于</em><a class="ae ky" href="https://github.com/balakreshnan/mlops/blob/master/batchscorePRS.md" rel="noopener ugc nofollow" target="_blank">T5【https://github.com】</a><em class="lg">。</em></p></div></div>    
</body>
</html>