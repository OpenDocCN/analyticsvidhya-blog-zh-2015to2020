<html>
<head>
<title>How to delete records from a Kafka topic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从Kafka主题中删除记录</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-delete-records-from-a-kafka-topic-5e82d64a5e62?source=collection_archive---------19-----------------------#2020-03-05">https://medium.com/analytics-vidhya/how-to-delete-records-from-a-kafka-topic-5e82d64a5e62?source=collection_archive---------19-----------------------#2020-03-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/014bf85b5230ca696f2078ea1efefcd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/0*8peqTGqlbHljYlog.jpg"/></div><figcaption class="im in et er es io ip bd b be z dx translated"><em class="iq">图片来源:</em> <a class="ae ir" href="https://unsplash.com/@adliwahid?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <em class="iq">阿德利</em>瓦希德</a></figcaption></figure><p id="65eb" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">我不时会收到同事的请求，他们想删除一些或所有卡夫卡主题的记录。这个请求通常是在有人在测试主题中产生了错误的数据，或者由于生产者代码中的错误而产生的。或者只是因为他们想要一个干净的石板。</p><p id="b847" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">不管是什么原因，今天我会告诉你一些方法来删除一些或所有卡夫卡主题的记录。</p><p id="8d3f" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">不言而喻，在生产环境中使用下面描述的方法之前，您应该使用您的最佳判断并(至少)检查两次。</p><h1 id="eb67" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">卡夫卡-删除-记录</h1><p id="f32b" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">该命令是Kafka CLI工具的一部分。它需要两个参数:</p><ul class=""><li id="4fa0" class="kt ku hi iu b iv iw iz ja jd kv jh kw jl kx jp ky kz la lb bi translated">引导服务器和</li><li id="4d2c" class="kt ku hi iu b iv lc iz ld jd le jh lf jl lg jp ky kz la lb bi translated">JSON文件，描述应该删除哪些记录。</li></ul><p id="1275" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">该命令允许您删除从一个分区的开始直到指定偏移量的所有记录。</p><p id="57ea" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">注意:不能在主题中间删除记录。</p><p id="cd24" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">JSON文件指定了一个或多个我们想要从中删除记录的分区。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="589a" class="lq jr hi lm b fi lr ls l lt lu">{<br/>    "partitions": [<br/>        {<br/>            "topic": "my-topic",<br/>            "partition": 0,<br/>            "offset": 3<br/>        }<br/>    ],<br/>    "version": 1<br/>}</span></pre><p id="a567" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">在这里，我们已经指定，对于主题“my-topic”的分区0，我们希望删除从开始直到偏移量3的所有记录。执行该命令后，分区0的起始偏移量将是偏移量3。</p><h1 id="f69a" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">删除主题中的所有记录</h1><blockquote class="lv lw lx"><p id="fe2f" class="is it ly iu b iv iw ix iy iz ja jb jc lz je jf jg ma ji jj jk mb jm jn jo jp hb bi translated"><strong class="iu hj">注意:这不适用于压缩主题</strong></p></blockquote><p id="ac04" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">如果您想要删除所有消息，另一个选项是将主题的保留减少到一个小值(例如100ms)，等待代理从主题中删除所有记录，然后将主题保留设置为其原始值。下面是怎么做的。</p><p id="d862" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">首先，将retention.ms设置为100毫秒。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="949a" class="lq jr hi lm b fi lr ls l lt lu">kafka-configs --zookeeper localhost:2181 \<br/>--entity-type topics \ <br/>--entity-name my-topic \ <br/>--alter --add-config retention.ms=100</span></pre><p id="0a09" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">然后，等待代理删除保留期过期的消息(即所有消息)。要知道该过程是否完成，请检查开始偏移和结束偏移是否相同。这意味着该主题没有更多可用的记录。根据您的设置，Kafka可能需要几分钟来清理主题，因此请继续检查开始偏移。</p><p id="be18" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">使用GetOffsetShell类检查主题分区的开始和结束偏移量。为了检查末端偏移，将参数<strong class="iu hj">时间</strong>设置为值-1:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="cab5" class="lq jr hi lm b fi lr ls l lt lu">kafka-run-class kafka.tools.GetOffsetShell \ <br/>--broker-list localhost:9092 \ <br/>--topic my-topic \ <br/>--time -1</span></pre><p id="2785" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">为了检查开始偏移，将参数<strong class="iu hj">时间</strong>设置为<strong class="iu hj"> -2 </strong>:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="24df" class="lq jr hi lm b fi lr ls l lt lu">kafka-run-class kafka.tools.GetOffsetShell \ <br/>--broker-list localhost:9092 \ <br/>--topic my-topic \ <br/>--time -2</span></pre><p id="9b9c" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">清除主题后，将retention.ms恢复为其原始值:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="8be8" class="lq jr hi lm b fi lr ls l lt lu">kafka-configs --zookeeper localhost:2181 \ <br/>--entity-type topics \ <br/>--entity-name my-topic \ <br/>--alter --add-config retention.ms=&lt;ORIGINAL VALUE&gt;</span></pre><h1 id="9766" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">删除一个主题，然后重新创建</h1><p id="9903" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">不如前两种方法优雅，但在某些情况下可能是更容易的解决方案(例如，如果主题创建是脚本化的)。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="b545" class="lq jr hi lm b fi lr ls l lt lu">kafka-topics --bootstrap-server localhost:9092 \ <br/>--topic my-topic \ <br/>--delete</span></pre><p id="4733" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">然后再次创建它:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="7196" class="lq jr hi lm b fi lr ls l lt lu">kafka-topics --bootstrap-server localhost:9092 \ <br/>--topic my-topic \ <br/>--create \ <br/>--partitions &lt;number_of_partitions&gt; \ <br/>--replication-factor &lt;replication_factor&gt;</span></pre><h2 id="0d18" class="lq jr hi bd js mc md me jw mf mg mh ka jd mi mj ke jh mk ml ki jl mm mn km mo bi translated">使用这种方法时需要注意的事情很少</h2><p id="a052" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">确保在集群中启用了主题删除。设置<strong class="iu hj"> delete.topic.enable=true </strong>。在Kafka 1.0.0中，该属性默认为真。</p><p id="3cde" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">确保所有消费者都已停止消费您要删除的主题中的数据。否则，它们会抛出如下错误:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="bc16" class="lq jr hi lm b fi lr ls l lt lu">Received unknown topic or partition error in fetch for partition my-topic-0</span></pre><p id="38d5" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">或者</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="bf8a" class="lq jr hi lm b fi lr ls l lt lu">Error while fetching metadata with correlation id 123 : {my-topic=LEADER_NOT_AVAILABLE}</span></pre><p id="a392" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">如果您启动并运行了消费者，还有一件事可能会发生:如果集群范围的属性<strong class="iu hj">auto . create . topics . enable</strong>为真(默认情况下为真)，那么主题将会自动创建。本质上还不错，但是它将使用默认的分区数量(1)和复制因子(1)，这可能不是您想要的。</p><p id="49f8" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated">这个故事的寓意是——如果使用这种方法，一定要阻止你的消费者🙂</p><h1 id="3fa4" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">你想了解更多关于卡夫卡的知识吗？</h1><p id="2f4e" class="pw-post-body-paragraph is it hi iu b iv ko ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl ks jn jo jp hb bi translated">我创建了一个卡夫卡迷你课程，你可以完全免费获得<strong class="iu hj"/>。<a class="ae ir" href="https://codingharbour.com/" rel="noopener ugc nofollow" target="_blank">在编码港</a>报名。</p></div><div class="ab cl mp mq gp mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="hb hc hd he hf"><p id="0903" class="pw-post-body-paragraph is it hi iu b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp hb bi translated"><em class="ly">最初发表于</em><a class="ae ir" href="https://codingharbour.com/apache-kafka/how-to-delete-records-from-a-kafka-topic/" rel="noopener ugc nofollow" target="_blank"><em class="ly">https://codingharbour.com</em></a><em class="ly">。</em></p></div></div>    
</body>
</html>