<html>
<head>
<title>Monitor the statistics of your micro-service in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes中监控你的微服务的统计数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/monitor-the-statistics-of-your-micro-service-in-kubernetes-f649f8960b0a?source=collection_archive---------20-----------------------#2019-11-12">https://medium.com/analytics-vidhya/monitor-the-statistics-of-your-micro-service-in-kubernetes-f649f8960b0a?source=collection_archive---------20-----------------------#2019-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/9134a477d66e8ee2f292fec062bb25d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*RNFUcRpPpJwqlZ_l0xpMxg.png"/></div></figure><p id="d177" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Kubernetes正在成为微服务和集装箱化技术领域的趋势。在这篇博客中，我们将了解如何使用Kubernetes的API操作器、WSO2 API Manager和WSO2 API Manager Analytics来监控和可视化您在Kubernetes中的微服务的统计数据。</p><p id="5178" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">API Operator使得在Kubernetes中将微服务作为托管API进行管理成为一项简单的任务，并且拥有最佳的架构和技术。它还提供了与API Portal和API Dashboard集成以实现可视化的能力，这为您在Kubernetes中的部署增加了额外的价值。</p></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h1 id="f44a" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">先决条件</h1><ol class=""><li id="5540" class="kp kq hi io b ip kr it ks ix kt jb ku jf kv jj kw kx ky kz bi translated"><a class="ae la" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li><li id="f9f5" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj kw kx ky kz bi translated"><a class="ae la" href="https://kubernetes.io/docs/setup/" rel="noopener ugc nofollow" target="_blank"> Kubernetes v1.12或以上</a></li><li id="75be" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj kw kx ky kz bi translated">DockerHub或私有docker注册表中的帐户</li><li id="a0b1" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj kw kx ky kz bi translated">Kubernetes的API操作员。下载<a class="ae la" href="https://github.com/wso2/k8s-apim-operator/releases/download/v1.0.0/api-k8s-crds-1.0.0.zip" rel="noopener ugc nofollow" target="_blank"> api-k8s-crds-1.0.0.zip </a>并解压</li><li id="6672" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj kw kx ky kz bi translated">从<a class="ae la" href="https://github.com/wso2/product-apim-tooling/releases/" rel="noopener ugc nofollow" target="_blank">https://github.com/wso2/product-apim-tooling/releases/</a>下载适用于您的操作系统的API控制器3.0.0版</li></ol></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><h2 id="350f" class="lg js hi bd jt lh li lj jx lk ll lm kb ix ln lo kf jb lp lq kj jf lr ls kn lt bi translated">步骤1:部署API操作符</h2><ol class=""><li id="ce6f" class="kp kq hi io b ip kr it ks ix kt jb ku jf kv jj kw kx ky kz bi translated">导航到先决条件4中解压缩的zip中的<em class="lu"> api-k8s-crds-1.0.0 </em>目录</li><li id="2e71" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj kw kx ky kz bi translated">部署与API操作符相关的工件</li></ol><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="16b7" class="lg js hi ma b fi me mf l mg mh">kubectl apply -f apim-operator/controller-artifacts/</span></pre><p id="87bf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">3.Kubernetes的API操作符通过将托管API映像推送到DockerHub，使它可以在另一个集群中重用。您可以按如下方式输入DockerHub信息，并部署控制器配置。</p><ul class=""><li id="1bdb" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">打开apim-operator/controller-configs/controller _ conf . YAML，更新<em class="lu">用户的docker注册表</em>。</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="08e0" class="lg js hi ma b fi me mf l mg mh">dockerRegistry: &lt;username-docker-registry&gt;</span></pre><ul class=""><li id="e1f6" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">打开apim-operator/controller-configs/Docker _ secret _ template . YAML .<br/>输入Docker-Hub账户的base 64编码用户名和密码</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="e6c5" class="lg js hi ma b fi me mf l mg mh">data:<br/> username: ENTER YOUR BASE64 ENCODED USERNAME<br/> password: ENTER YOUR BASE64 ENCODED PASSWORD</span></pre><ul class=""><li id="696c" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">执行以下命令来部署控制器配置。</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="c623" class="lg js hi ma b fi me mf l mg mh">kubectl apply -f apim-operator/controller-configs/</span></pre><p id="945f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">4.部署与分析相关的工件。这将部署与分析相关的配置以及默认证书。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="12e9" class="lg js hi ma b fi me mf l mg mh">kubectl apply -f apim-operator/apim-analytics-configs/</span></pre><p id="1a85" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">注意:如果要禁用特定API的分析，可以将<em class="lu">apim-analytics-configs/apim _ analytics _ conf . YAML</em>中数据下的<strong class="io hj"> analyticsEnabled </strong>属性更改为false。</p><p id="c4a8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">5.配置<a class="ae la" href="https://wso2.com/api-management/tooling/" rel="noopener ugc nofollow" target="_blank"> API控制器</a>，这是一个综合的命令行工具，用于处理与API操作符相关的操作。</p><ul class=""><li id="6686" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">提取API控制器发行版，并使用命令行工具在提取的文件夹中导航</li><li id="4f51" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj ml kx ky kz bi translated">将提取的文件夹的位置添加到系统的PATH变量中，以便能够从任何地方访问可执行文件。</li><li id="41e3" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj ml kx ky kz bi translated">将API控制器的模式设置为Kubernetes</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="645e" class="lg js hi ma b fi me mf l mg mh">apictl set --mode k8s</span></pre><h2 id="9fdb" class="lg js hi bd jt lh li lj jx lk ll lm kb ix ln lo kf jb lp lq kj jf lr ls kn lt bi translated">步骤2:部署API门户和分析仪表板</h2><p id="68bd" class="pw-post-body-paragraph im in hi io b ip kr ir is it ks iv iw ix mm iz ja jb mn jd je jf mo jh ji jj hb bi translated">我们将使用<a class="ae la" href="https://wso2.com/api-management/" rel="noopener ugc nofollow" target="_blank"> WSO2 API Manager 3.0.0 </a>作为API门户，API Manager Analytics 3.0.0作为分析仪表板，以监控和可视化Kubernetes中微服务的统计数据。</p><ul class=""><li id="c811" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">导航到我们在先决条件4中提取的wso2am-k8s-crds-1.0.0目录。</li><li id="e5ba" class="kp kq hi io b ip lb it lc ix ld jb le jf lf jj ml kx ky kz bi translated">为资源创建命名空间</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="0f59" class="lg js hi ma b fi me mf l mg mh">apictl apply -f k8s-artifacts/api-portal-with-analytics/wso2-namespace.yaml</span></pre><ul class=""><li id="a8f3" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">WSO2 API管理器和分析的几个数据库需要彼此共享，因此我们可以在Kubernetes中部署mysql，并在mysql中配置必要的数据库，如下所示。</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="b7f1" class="lg js hi ma b fi me mf l mg mh">apictl apply -f k8s-artifacts/api-portal-with-analytics/mysql/</span></pre><ul class=""><li id="fc78" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">使用下面的命令将API Manager Analytics 3.0.0部署为Kubernetes中的分析仪表板。这将用于监控和可视化kubernetes中托管API的统计数据。</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="45df" class="lg js hi ma b fi me mf l mg mh">apictl apply -f k8s-artifacts/api-portal-with-analytics/api-analytics/</span></pre><ul class=""><li id="b750" class="kp kq hi io b ip iq it iu ix mi jb mj jf mk jj ml kx ky kz bi translated">将WSO2 API Manager 3.0.0部署为Kubernetes中的API门户。这可用于生成访问令牌。</li></ul><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="c1d8" class="lg js hi ma b fi me mf l mg mh">apictl apply -f k8s-artifacts/api-portal-with-analytics/api-portal/</span></pre><p id="8d64" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以确认它们是否正确部署，如下图所示。</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mp"><img src="../Images/4c214377a47a755be915ac6be82c7832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3JJS2nnb25ut921Q_blfA.png"/></div></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">如何检查是否部署了API门户和仪表板</figcaption></figure><p id="58cd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要访问API门户和仪表板，您必须将它们在/etc/hosts中的主机名与kubernetes节点的IP进行映射，如下所示。如果使用minikube，可以使用minikube ip如果使用Docker for Mac，可以使用localhost如果使用GKE，可以使用任何kubernetes节点。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="d7fe" class="lg js hi ma b fi me mf l mg mh">&lt;minikube IP&gt;  wso2apim<br/>&lt;minikube IP&gt;  wso2apim-analytics</span></pre><p id="a336" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以使用以下URL访问API门户和仪表板。</p><p id="ddef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">API门户—<a class="ae la" href="https://wso2apim:32001/devportal" rel="noopener ugc nofollow" target="_blank">https://WSO 2 API:32001/dev Portal</a><br/>API分析仪表板—<a class="ae la" href="https://wso2apim-analytics:32201/analytics-dashboard" rel="noopener ugc nofollow" target="_blank">https://WSO 2 API-Analytics:32201/Analytics-Dashboard</a></p><h2 id="7984" class="lg js hi bd jt lh li lj jx lk ll lm kb ix ln lo kf jb lp lq kj jf lr ls kn lt bi translated"><strong class="ak">步骤3:将您的微服务部署为托管API </strong></h2><p id="dffc" class="pw-post-body-paragraph im in hi io b ip kr ir is it ks iv iw ix mm iz ja jb mn jd je jf mo jh ji jj hb bi translated">最后一步，让我们在Kubernetes中部署我们的托管API。我这里使用的是样本swagger定义可用<a class="ae la" href="https://github.com/RameshaKaru/crd-demo/blob/master/swagger2.yaml" rel="noopener ugc nofollow" target="_blank"><strong class="io hj"/></a>。您可以通过“x-wso2-production-endpoints”扩展以同样的方式使用部署在kubernetes中的微服务的端点。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="99b3" class="lg js hi ma b fi me mf l mg mh">apictl add api -n petstore-test --from-file=swagger2.yaml</span></pre><p id="1e8b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">API操作者将运行kaniko作业，用给定的swagger文件创建微网关的映像。由于启用了分析，它将使用给定的分析配置来改变微网关的配置，并将分析证书添加到微网关的客户端信任库。此外，它将在微网关上安装一个EmptyDir卷来临时存储分析数据。</p><p id="8546" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">API服务需要一段时间才可用。在API服务可用之后，我们可以调用API。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="a14c" class="lg js hi ma b fi me mf l mg mh">TOKEN=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IlpqUm1ZVE13TlRKak9XVTVNbUl6TWpnek5ESTNZMkl5TW1JeVkyRXpNamRoWmpWaU1qYzBaZz09In0.eyJhdWQiOiJodHRwOlwvXC9vcmcud3NvMi5hcGltZ3RcL2dhdGV3YXkiLCJzdWIiOiJhZG1pbkBjYXJib24uc3VwZXIiLCJhcHBsaWNhdGlvbiI6eyJvd25lciI6ImFkbWluIiwidGllciI6IlVubGltaXRlZCIsIm5hbWUiOiJzYW1wbGUtY3JkLWFwcGxpY2F0aW9uIiwiaWQiOjMsInV1aWQiOm51bGx9LCJzY29wZSI6ImFtX2FwcGxpY2F0aW9uX3Njb3BlIGRlZmF1bHQiLCJpc3MiOiJodHRwczpcL1wvd3NvMmFwaW06MzIwMDFcL29hdXRoMlwvdG9rZW4iLCJ0aWVySW5mbyI6e30sImtleXR5cGUiOiJQUk9EVUNUSU9OIiwic3Vic2NyaWJlZEFQSXMiOltdLCJjb25zdW1lcktleSI6IjNGSWlUM1R3MWZvTGFqUTVsZjVVdHVTTWpsUWEiLCJleHAiOjM3MTk3Mzk4MjYsImlhdCI6MTU3MjI1NjE3OSwianRpIjoiZDI3N2VhZmUtNTZlOS00MTU2LTk3NzUtNDQwNzA3YzFlZWFhIn0.W0N9wmCuW3dxz5nTHAhKQ-CyjysR-fZSEvoS26N9XQ9IOIlacB4R5x9NgXNLLE-EjzR5Si8ou83mbt0NuTwoOdOQVkGqrkdenO11qscpBGCZ-Br4Gnawsn3Yw4a7FHNrfzYnS7BZ_zWHPCLO_JqPNRizkWGIkCxvAg8foP7L1T4AGQofGLodBMtA9-ckuRHjx3T_sFOVGAHXcMVwpdqS_90DeAoT4jLQ3darDqSoE773mAyDIRz6CAvNzzsWQug-i5lH5xVty2kmZKPobSIziAYes-LPuR-sp61EIjwiKxnUlSsxtDCttKYHGZcvKF12y7VF4AqlTYmtwYSGLkXXXw</span></pre><p id="0e08" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们用默认的JWT令牌调用API，它允许所有用户。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="142d" class="lg js hi ma b fi me mf l mg mh">curl -X GET "https://&lt;external IP of LB service&gt;:9095/petstorerate/v1/pet/55" -H "accept: application/xml" -H "Authorization:Bearer $TOKEN" -k</span></pre><p id="a910" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您使用GKE集群，您可以使用我们部署的托管API服务的外部IP。如果您使用的是minikube，您可以使用节点端口，该服务与minikube IP一起公开。</p><p id="2bea" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">作为一个例子，你可以看到我在minikube中使用的以下命令。</p><pre class="lv lw lx ly fd lz ma mb mc aw md bi"><span id="35fd" class="lg js hi ma b fi me mf l mg mh">curl -X GET "https://192.168.99.121:32111/petstorerate/v1/pet/55?[1-4]" -H "accept: application/xml" -H "Authorization:Bearer $TOKEN" -k</span></pre><p id="a43f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在您可以访问<a class="ae la" href="https://wso2apim-analytics:32201/analytics-dashboard" rel="noopener ugc nofollow" target="_blank">https://WSO 2 apim-analytics:32201/analytics-dashboard</a>并监控与您的微服务相关的统计数据。</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es my"><img src="../Images/70c7fb2547e1cd97029979689e0f077b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NVgGRoW5cvNsLF6WOOdhGQ.png"/></div></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">API仪表板</figcaption></figure><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mz"><img src="../Images/891fb8dea45bf5f53d4e3ba5f607928a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WZkdUYIxHkFO27nmvCO6AA.png"/></div></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">微服务的使用统计</figcaption></figure></div><div class="ab cl jk jl gp jm" role="separator"><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp jq"/><span class="jn bw bk jo jp"/></div><div class="hb hc hd he hf"><p id="99c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">希望你喜欢这个博客，你可以通过下面的博客找到如何将商业计划添加到你的微服务中。</p><p id="b21b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae la" rel="noopener" href="/@ramesha.karu/apply-a-business-plan-for-your-micro-service-in-kubernetes-33e46bf33f15">https://medium . com/@ ramesha . karu/apply-a-business-plan-for-your-micro-service-in-kubernetes-33 e 46 BF 33 f 15</a></p></div></div>    
</body>
</html>