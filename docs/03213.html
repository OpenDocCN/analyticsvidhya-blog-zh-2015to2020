<html>
<head>
<title>Python Script to generate summary of cPanel Access logs.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生成cPanel访问日志摘要的Python脚本。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/python-script-to-generate-summary-of-cpanel-access-logs-9916043ff01c?source=collection_archive---------18-----------------------#2020-01-20">https://medium.com/analytics-vidhya/python-script-to-generate-summary-of-cpanel-access-logs-9916043ff01c?source=collection_archive---------18-----------------------#2020-01-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8aa1ddcb5b275cb15d4ef58df2da9fa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gs3iwpDPzc2B3Nmi"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">沙哈达特·拉赫曼在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="7907" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">过去两年我一直在托管部门工作，老实说，检查cPanel访问日志是一项单调乏味的任务。</p><p id="f6a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，如果我想检查cPanel访问日志以创建电子邮件帐户，我需要创建一个测试电子邮件帐户，然后检查访问日志并确认创建电子邮件帐户时调用了什么关键字。</p><p id="68de" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我创建了一个python字典，把所有这些关键字都作为“key”，对应的操作在“value”中。</p><p id="f863" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是我创建的python字典。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="1971" class="kc kd hi jy b fi ke kf l kg kh">keywords={<br/>    'addbhtml' : 'Database addition',<br/>    'deldbhtml' : 'Database deletion',<br/>    'simplehtml' : 'Simple DNS Zone editor',<br/>    'advancedhtml' : 'Advanced DNS Zone Editor',<br/>    'The+row+has+been+deleted   ' : 'Database Deletion (phpMyAdmin)',<br/>    'passwd' : 'cPanel password change',<br/>    'add_pop' : 'Email account creation',<br/>    'delpop' : 'Email account deletion',<br/>    'passwdpop' : 'Email account password reset ',<br/>    'doaddfwd' : 'Email forwarder creation ',<br/>    'dodelfwd' : 'Email forwarder deletion ',<br/>    'doaddparked' : 'Park Domain Addition ',<br/>    'dodelparked' : 'Park Domain deletion ',<br/>    'doadddomain' : 'Addon Domain addition ',<br/>    'confirmdodeldomain' : 'Addon Domain deletion ',<br/>    'subdomain/doadddomainhtml' : 'Sub Domain addition',<br/>    'dodeldomainconfirmhtml' : 'Sub Domain deletion',<br/>    'add_ftp' : 'FTP account addition',<br/>    'delete_ftp' : 'FTP account deletion',<br/>    'addredirecthtml' : 'Redirection addition',<br/>    'delredirectconfirmhtml' : 'Redirection deletion',<br/>    'scripts/chrootpass' : 'Root Password Reset ',<br/>    'doadddfwdhtml' : 'Addition of Domain forwarder [email]',<br/>    'dodeldfwdconfirmhtml' : 'Deletion of domain forwarder [email]',<br/>    'mxcheck=local' : 'Change in Email Routing settings (local)',<br/>    'mxcheck=remote' : 'Change in Email Routing settings (remote)',<br/>    'Cron&amp;cpanel_jsonapi_func=add_line' : 'Cron-job addition',<br/>    'Cron&amp;cpanel_jsonapi_func=remove_line' : 'Cron-job deletion',<br/>    'remove_email_id' : 'Email account deletion',<br/>    'add_email_id' : 'Email account creation',<br/><br/>}</span></pre><p id="4a97" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是最终代码:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="f250" class="kc kd hi jy b fi ke kf l kg kh">import argparse,re,os,sys<br/>#from collections import Counter<br/>def progressBar(value, endvalue, bar_length=20):<br/>        percent = float(value) / endvalue<br/>        arrow = '-' * int(round(percent * bar_length)-1) + '&gt;'<br/>        spaces = ' ' * (bar_length - len(arrow))<br/>        sys.stdout.write("\rProgress: [{0}] {1}%".format(arrow + spaces, int(round(percent * 100))))<br/>        sys.stdout.flush()<br/><br/>parser=argparse.ArgumentParser(<br/>    description="To print  cPanel access log in more readable format"<br/>)<br/>parser.add_argument('user', help="cPanel user name")<br/>args=parser.parse_args()<br/>print(args)<br/>array2=[]<br/>filesize = os.path.getsize('/usr/local/cpanel/logs/access_log')<br/>progress=0<br/>with open("/usr/local/cpanel/logs/access_log",'r') as file:<br/>    print("Reading from file:")<br/>    for i in file:<br/>         progress=progress+len(i)<br/>         progressP=(float(progress))/filesize<br/>         #print(array2)/filesize<br/>         progressBar(int(progressP*100),100)<br/>         #print(i)<br/>         #print("================================================================")<br/>         if re.search(args.user, i):<br/>          array2.append(i)<br/>keywords={<br/>    'addbhtml' : 'Database addition',<br/>    'deldbhtml' : 'Database deletion',<br/>    'simplehtml' : 'Simple DNS Zone editor',<br/>    'advancedhtml' : 'Advanced DNS Zone Editor',<br/>    'The+row+has+been+deleted   ' : 'Database Deletion (phpMyAdmin)',<br/>    'passwd' : 'cPanel password change',<br/>    'add_pop' : 'Email account creation',<br/>    'delpop' : 'Email account deletion',<br/>    'passwdpop' : 'Email account password reset ',<br/>    'doaddfwd' : 'Email forwarder creation ',<br/>    'dodelfwd' : 'Email forwarder deletion ',<br/>    'doaddparked' : 'Park Domain Addition ',<br/>    'dodelparked' : 'Park Domain deletion ',<br/>    'doadddomain' : 'Addon Domain addition ',<br/>    'confirmdodeldomain' : 'Addon Domain deletion ',<br/>    'subdomain/doadddomainhtml' : 'Sub Domain addition',<br/>    'dodeldomainconfirmhtml' : 'Sub Domain deletion',<br/>    'add_ftp' : 'FTP account addition',<br/>    'delete_ftp' : 'FTP account deletion',<br/>    'addredirecthtml' : 'Redirection addition',<br/>    'delredirectconfirmhtml' : 'Redirection deletion',<br/>    'scripts/chrootpass' : 'Root Password Reset ',<br/>    'doadddfwdhtml' : 'Addition of Domain forwarder [email]',<br/>    'dodeldfwdconfirmhtml' : 'Deletion of domain forwarder [email]',<br/>    'mxcheck=local' : 'Change in Email Routing settings (local)',<br/>    'mxcheck=remote' : 'Change in Email Routing settings (remote)',<br/>    'Cron&amp;cpanel_jsonapi_func=add_line' : 'Cron-job addition',<br/>    'Cron&amp;cpanel_jsonapi_func=remove_line' : 'Cron-job deletion',<br/>    'remove_email_id' : 'Email account deletion',<br/>    'add_email_id' : 'Email account creation',<br/><br/>}<br/>def count_IPs():<br/> m=[]<br/> print("\n=============================================================")<br/> print("IPAddress               "+"Number of access")<br/> print("=============================================================")<br/> b = {}<br/> for i in array2:<br/>         b[i.split()[0]] = b.get(i.split()[0], 0) + 1<br/>         #Counter(m).keys()<br/>         #Counter(m).values()<br/> for key,value in sorted(b.items(), key=lambda x:x[1],reverse=True):<br/>  print(str(key)+"\t\t"+str(value))<br/>count_IPs()<br/>#a_keywords = {'fileman':['POST','fileman']}<br/>print("\n=============================================================")<br/>print("Time"+"                    "+"IP"+"              "+"Operation")<br/>print("=============================================================")<br/>for i in array2:<br/>        for key,value in keywords.items():<br/>          if key in i:<br/>                print(i.split()[3].replace("[","")+"\t"+i.split()[0]+"\t"+value)<br/><br/>        if "POST" in i and "fileman" in i:<br/>                 print(i.split()[3].replace("[","")+"\t"+i.split()[0]+"\t"+"Filemanager POST")<br/>        elif "POST" in i and "phpMyAdmin" in i:<br/>                 print(i.split()[3].replace("[","")+"\t"+i.split()[0]+"\t"+"phpMyAdmin POST")</span></pre><p id="3bd5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个脚本的作用是，它将cPanel用户名作为输入，并通过将访问日志转换为“时间”、“IP”和“操作”三列来生成access_log的摘要("/usr/local/cPanel/logs/access _ log ")。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="2bdf" class="kc kd hi jy b fi ke kf l kg kh">python generate_accesslog username;</span></pre><p id="2d27" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">样本输出:</p><figure class="jt ju jv jw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ki"><img src="../Images/2a23ae5ec97a0c7c3cc8b7f6fe480c48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t3df2LCmVIfJ-oSmQ0abGg.jpeg"/></div></div></figure></div></div>    
</body>
</html>