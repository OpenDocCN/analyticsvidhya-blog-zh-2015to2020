<html>
<head>
<title>Deployment Blues : Why Won’t My Flask Web App Just @#$% Deploy On Google App Engine ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">部署问题:为什么我的Flask Web应用程序不能在Google App Engine上部署？</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deployment-blues-why-wont-my-flask-web-app-just-deploy-2ac9092a1b40?source=collection_archive---------20-----------------------#2020-09-28">https://medium.com/analytics-vidhya/deployment-blues-why-wont-my-flask-web-app-just-deploy-2ac9092a1b40?source=collection_archive---------20-----------------------#2020-09-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="3fc7" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="3806" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">公平的警告，这篇文章有点咆哮，如果你已经是一个经验丰富的开发者或者熟悉Google Cloud应用引擎，你可能会翻白眼</p><p id="9a03" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我将详细介绍我的开发运营“兔子洞”之旅，以及我使用Google的应用程序引擎以及我作为n00b数据科学爱好者发现有用的任何在线资源(Stackoverflow帖子或其他技术博客)在线部署一个简单的Flask Web应用程序所经历的故障排除。</p><p id="5b2c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">最终，我没能解决我的问题，因为我最终部署的不是谷歌应用引擎，而是一个谷歌计算引擎实例(可能会花费我更多的美元，但嘿，我想这仍然是一件事)</p><div class="kg kh ez fb ki kj"><a href="http://34.126.83.61/" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">文本分析器</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">编辑描述</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx">34.126.83.61</p></div></div></div></a></div><p id="fbbb" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">然而，我在解决其他问题的时候确实学到了一些东西，所以希望通过写这篇文章，其他人可能会受益。</p><p id="904b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我知道Medium.com不是StackOverflow，但是任何读到这篇文章的人，如果有什么建议，请在评论中给我留言。</p><p id="b316" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我的GitHub repo在这里(注意——在我修复了下面的大部分问题之后，它已经包含了文件的重构版本):-</p><div class="kg kh ez fb ki kj"><a href="https://github.com/ZhijingEu/Text_Analyzer_FlaskWebApp" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">ZhijingEu/Text _ Analyzer _ FlaskWebApp</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">这是一个Python Flask Web应用程序，接受用户提供的文本或URL地址…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">github.com</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx ky kj"/></div></div></a></div><h1 id="0077" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">概述</h1><h2 id="2415" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated">0。背景</h2><h2 id="6872" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated"><a class="ae ln" href="#c18b" rel="noopener ugc nofollow"> 1。修复由于酸洗模型导致的属性错误</a></h2><h2 id="efe6" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated"><a class="ae ln" href="#1752" rel="noopener ugc nofollow"> 2。解决Python 3.6.4和3.7之间的库兼容性问题</a></h2><h2 id="a63e" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated"><a class="ae ln" href="#8bdc" rel="noopener ugc nofollow"> 3。添加WGSI服务器库</a></h2><h2 id="577a" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated"><a class="ae ln" href="#43b3" rel="noopener ugc nofollow"> 4。内存泄露(可能)？</a></h2><h2 id="2d60" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated"><a class="ae ln" href="#74af" rel="noopener ugc nofollow"> 5。将应用部署在谷歌计算引擎上</a></h2><h2 id="03f3" class="kz ig hi bd ih la lb lc il ld le lf ip jo lg lh it js li lj ix jw lk ll jb lm bi translated"><a class="ae ln" href="#42e8" rel="noopener ugc nofollow"> 6。结论</a></h2><h1 id="74d0" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">0.背景</h1><p id="85ea" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在最近的一篇文章中，我分享了一个文本分析Flask应用程序，它是我在自己的机器上运行的。</p><div class="kg kh ez fb ki kj"><a rel="noopener follow" target="_blank" href="/analytics-vidhya/building-a-text-analysis-web-app-with-medium-claps-prediction-2ce2d59153ef"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">构建一个具有中等评分预测的文本分析Web应用程序</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">为了看看数据科学/ ML技术是否能帮助我提高写作水平，我构建了一个简单的Python Flask，基于…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">medium.com</p></div></div><div class="ks l"><div class="lo l ku kv kw ks kx ky kj"/></div></div></a></div><p id="3eaa" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">不幸的是，这对于那些想利用你的机器学习模型、代码或其他任何东西，而不需要学习python或复制你的开发环境的人来说不是很有用。</p><p id="9e73" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">因此，我开始探索如何将应用程序上线的部署选项。以前我在他们的免费服务上用过pythonanywhere.com。然而这一次，我决定尝试谷歌云的应用引擎</p><p id="9e2e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">根据下面的文档和示例教程(<strong class="jf hj">请在阅读本文其余部分之前通读一遍，因为它将在后面变得相关</strong>)，这似乎是一个足够简单的过程…</p><div class="kg kh ez fb ki kj"><a rel="noopener follow" target="_blank" href="/@dmahugh_70618/deploying-a-flask-app-to-google-app-engine-faa883b5ffab"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">将Flask应用程序部署到Google App Engine</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">这篇文章讲述了如何将一个简单的Python/Flask应用程序部署到App Engine标准环境中。我已经做了很多…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">medium.com</p></div></div><div class="ks l"><div class="lp l ku kv kw ks kx ky kj"/></div></div></a></div><p id="9fb9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我走到了这一步。当消息说部署通过时，它看起来很有希望…</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es lq"><img src="../Images/68cc7f0188436b8c681b7f16fc7674ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BEd9QiDwajTMvGi9cmDbjQ.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">看起来很简单…</figcaption></figure><p id="0bf8" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">啊哦。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es mf"><img src="../Images/6d9ad08c83d26bcceb7a5e4dc99fc033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQj1ANG42LW6j_bYVeOZ6g.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">…但是没有: (</figcaption></figure><h1 id="c18b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">1.酸洗和属性错误</h1><p id="ec75" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我在谷歌云的错误日志中快速搜索，发现了这条消息。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es mg"><img src="../Images/aae4970fa985754995a4029ad5176123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vynbNMEO4hO1odlqNEMO-g.png"/></div></div></figure><p id="2aca" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">模型类是一个自定义类，它使用RandomForestRegression和RandomForestClassifier来预测大5人格特征。这是一个有人在网上发布的模型，我只是将他们预先训练好的(和腌制的)模型整合到我的网络应用程序中。</p><p id="844f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">所以一些stackoverdrive拖网发现了这个金块:</p><p id="2679" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="mh">"当你直接在你运行的文件中定义一个类时，它被腌成来自模块</em><strong class="jf hj"><em class="mh">main</em></strong><em class="mh">。然而，当您在Flask web app中取消选中它时，没有</em> <strong class="jf hj"> <em class="mh">主</em> </strong> <em class="mh">模块，因此代码找不到定义“</em></p><p id="d5f1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">原来这是一个相当常见的新手错误，在几篇不同的文章中都有涉及。</p><div class="kg kh ez fb ki kj"><a href="https://rebeccabilbro.github.io/module-main-has-no-attribute/" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">模块Main没有属性...(在管道和泡菜上)</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">众所周知，数据科学家喜欢scikit-learn，它是Python机器学习库，提供了一个通用的…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">rebeccabilbro.github.io</p></div></div><div class="ks l"><div class="mi l ku kv kw ks kx ky kj"/></div></div></a></div><p id="c5ca" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">其要点是，如果您在一个项目中定义了一个类和函数(例如，我们称之为FileA.py ),并试图将它加载到另一个项目FileB.py中，Python将很难在模块"<code class="du mj mk ml mm b">__main__”</code>中找到相关的类，它现在与FileB相对应，而不是与它所在的FileA相对应。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div class="er es mn"><img src="../Images/9e9d7f068afd7f5864ea4ea43d814bbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*Zsb99eSpQiAlYxMM1D38_Q.png"/></div><figcaption class="mb mc et er es md me bd b be z dx translated">来源:<a class="ae ln" href="https://www.istockphoto.com/photos/pickle" rel="noopener ugc nofollow" target="_blank">https://www.istockphoto.com/photos/pickle</a></figcaption></figure><p id="3801" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">当我在本地机器上运行这个应用程序时，我从来没有注意到这个消息的原因是因为我总是使用&gt; python main.py命令运行这个应用程序。因此底部的这部分总是被执行:</p><pre class="lr ls lt lu fd mo mm mp mq aw mr bi"><span id="0df8" class="kz ig hi mm b fi ms mt l mu mv">if __name__ == "__main__":<br/>    main()</span></pre><p id="3941" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">然而，如果我不使用<code class="du mj mk ml mm b">flask run</code>和<code class="du mj mk ml mm b">set FLASK_APP=main.py</code>，我至少可以复制我在谷歌应用引擎日志中看到的错误，因为<code class="du mj mk ml mm b">flask run</code>命令通过从你的<code class="du mj mk ml mm b">main.py</code>模块导入一个<code class="du mj mk ml mm b">app</code>对象来工作。这个StackOverflow线程可能可以更好地解释它…</p><p id="d277" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">值得庆幸的是，总会有人有现成的解决方案..在深入研究StackOverflow之后，我发现一个用户发布了一个非常好的自定义Unpickler类</p><div class="kg kh ez fb ki kj"><a href="https://stackoverflow.com/questions/27732354/unable-to-load-files-using-pickle-and-multiple-modules" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">无法使用pickle和多个模块加载文件</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">我正在尝试创建一个用户系统，它使用一个设置和GUI模块，当Gui模块请求文件时…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">stackoverflow.com</p></div></div><div class="ks l"><div class="mw l ku kv kw ks kx ky kj"/></div></div></a></div><pre class="lr ls lt lu fd mo mm mp mq aw mr bi"><span id="30ec" class="kz ig hi mm b fi ms mt l mu mv">import pickle</span><span id="a2fb" class="kz ig hi mm b fi mx mt l mu mv">class CustomUnpickler(pickle.Unpickler):<br/><br/>    def find_class(self, module, name):<br/>        try:<br/>            return super().find_class(__name__, name)<br/>        except AttributeError:<br/>            return super().find_class(module, name)<br/><br/>pickle_data = CustomUnpickler(open('file_path.pkl', 'rb')).load()</span></pre><p id="bece" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这是可行的，因为它覆盖了<code class="du mj mk ml mm b">pickle.Unpickler</code>的<code class="du mj mk ml mm b">find_class</code>函数，并显式地指示它在当前模块的名称空间中查找，这样就避免了关于引用哪个<code class="du mj mk ml mm b">"___main___"</code>的混乱。</p><p id="f94c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">所以现在至少我可以在我的本地机器上‘Flask Run’这个应用程序而不会出错。我更新了main.py并上传到Google App Engine，急切地等待结果。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es mf"><img src="../Images/6d9ad08c83d26bcceb7a5e4dc99fc033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQj1ANG42LW6j_bYVeOZ6g.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">arrrrgggggggggghhhhhh</figcaption></figure><h1 id="1752" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">2.解决库兼容性问题</h1><p id="d9aa" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">回到错误日志——我发现了这条神秘的消息。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es my"><img src="../Images/b2fd3ab3df7a913d070b6ea666f78cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TP2PELZpcsESfUB10W31Zg.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx">???</figcaption></figure><p id="a188" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">回到网上寻求帮助，我偶然发现了一些相关的github帖子:</p><div class="kg kh ez fb ki kj"><a href="https://github.com/modin-project/modin/issues/647" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">AttributeError:类型对象' Callable '没有属性' _abc_registry '问题#647 …</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">解散GitHub是超过5000万开发者的家园，他们一起工作来托管和审查代码，管理项目，以及…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">github.com</p></div></div><div class="ks l"><div class="mz l ku kv kw ks kx ky kj"/></div></div></a></div><div class="kg kh ez fb ki kj"><a href="https://github.com/ethereum/eth-abi/issues/131" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">AttributeError:类型对象' Callable '没有属性' _abc_registry '问题#131 …</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">解散GitHub是超过5000万开发者的家园，他们一起工作来托管和审查代码，管理项目，以及…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">github.com</p></div></div><div class="ks l"><div class="na l ku kv kw ks kx ky kj"/></div></div></a></div><p id="0c06" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">显然，这是因为我使用Python 3.6.4构建了我的应用程序，但我使用的是默认为Python 3.7环境的谷歌应用程序引擎的“免费层”，这个“键入”包在Python 3.6之后是多余的，仅用于在早期版本中反向移植该功能。</p><p id="d675" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我甚至不记得在构建我的应用程序时在我的本地虚拟环境中安装过这个特定的库，但是当我使用<code class="du mj mk ml mm b">pip freeze &gt; requirements.txt</code>命令取出所有相关的包时，它肯定在那里。</p><p id="db79" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">所以很快删除并重新上传后，我等待结果加载。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es nb"><img src="../Images/de6eeffef548e89373c8f8401fbbd3d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iOvmFRtAlvJo3-0ZVU4EVA.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">不不不</figcaption></figure><figure class="lr ls lt lu fd lv er es paragraph-image"><div class="er es nc"><img src="../Images/f2b10338e5364b137e7ef5739c314093.png" data-original-src="https://miro.medium.com/v2/resize:fit:414/format:webp/1*WHE26Y7YmiUB6D65egjoiQ.png"/></div></figure><h1 id="8bdc" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">3.(显式)在WSGI服务器中添加…</h1><p id="4039" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我设法消除了所有的属性错误信息。该应用程序仍然无法工作，但这是一种进步。</p><p id="c1d9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我回到日志中，注意到有一条消息是<strong class="jf hj"> <em class="mh">早些时候就已经出现了</em> </strong>，但是我在处理属性错误问题时从来没有仔细看过。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es nd"><img src="../Images/9646610c98e56c6bc8ceaeea38a6e25f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uoxGaIDXmUFlnXCYym5byA.png"/></div></div></figure><p id="f3c1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在示例<a class="ae ln" rel="noopener" href="/@dmahugh_70618/deploying-a-flask-app-to-google-app-engine-faa883b5ffab">教程中，我使用的是</a>，甚至是谷歌云自己的<a class="ae ln" href="https://github.com/GoogleCloudPlatform/python-docs-samples/tree/master/appengine/standard_python3/hello_world" rel="noopener ugc nofollow" target="_blank">“Hello World”示例</a>，你只需在requirements.txt文件中指定Flask，而<a class="ae ln" href="https://cloud.google.com/appengine/docs/standard/python3/config/appref" rel="noopener ugc nofollow" target="_blank"> app.yaml文件</a>(类似于一个配置文件，告诉谷歌应用引擎如何设置容器)中唯一的东西是一个单独的LINER <code class="du mj mk ml mm b">runtime:Python37</code></p><p id="160b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">当然，我所构建的要复杂一些，但我认为GAE会在我没有明确说明的情况下“猜测”我在做什么。</p><p id="465d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">不管怎样，我回到我的requirements.txt文件，添加了:<code class="du mj mk ml mm b">gunicorn==20.0.4</code>，还将这一行添加到我的app.yaml文件:<code class="du mj mk ml mm b">entrypoint: gunicorn -b :$PORT main:app</code></p><p id="cfb7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">为了确保我可以在日志中“看到”应用程序是否加载，我在main.py文件的最后写了一行:<code class="du mj mk ml mm b">print(“Hey, At Least I Loaded Up…”)</code></p><p id="55aa" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">正如你所料，事情并没有按计划进行。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div class="er es ne"><img src="../Images/e4c12141e6cb9c04630e38728608c420.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/1*cYpQ_jdN3lUqnO7IJTKziw.png"/></div><figcaption class="mb mc et er es md me bd b be z dx translated">嘿——这是新的……哪个好？</figcaption></figure><p id="d45c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">回到日志文件…</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es nf"><img src="../Images/7d138540788a6f24d7d93a728de88ccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f3UyA6oEZCFVSujFkQ-X3Q.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">我想还不算完全失败。至少我知道它在做一些事情，即使应用程序没有加载。</figcaption></figure><h1 id="43b3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak"> 4记忆力下降？</strong></h1><figure class="lr ls lt lu fd lv er es paragraph-image"><div class="er es ng"><img src="../Images/899038f81633d2c1d6cc468fe15df8ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:464/format:webp/1*iqwOFWcORaMLBxXuP1pqQg.png"/></div><figcaption class="mb mc et er es md me bd b be z dx translated"><a class="ae ln" href="https://www.dreamstime.com/illustration/brain-missing-piece.html" rel="noopener ugc nofollow" target="_blank">资料来源:Dreamstime </a></figcaption></figure><p id="db1a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">根据帮助文件:</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es nh"><img src="../Images/c17ada67738cb7fbc669c0af49aa31dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EInSTD2zSpX3Z_I_BGfMnQ.png"/></div></div></figure><p id="a099" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">扩展内存限制超出警告，我收到一条消息，说“<em class="mh">在处理这个请求时，处理这个请求的进程被发现使用了太多的内存，并被终止。这可能会导致对应用程序的下一个请求使用新的进程。如果您经常看到此消息，则您的应用程序可能存在内存泄漏，或者可能正在使用一个内存不足的实例。考虑在app.yaml中设置一个更大的实例类</em>"</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es ni"><img src="../Images/8e417df110599cc82832f9eff3d94e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwoJFW_-G2GOwCsGxu_Pkg.png"/></div></div></figure><p id="c39e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">问题是，在修复所有其他错误的过程中，我已经升级到了最大的实例(即F4 1G，有2048MB ),只是为了排除任何内存问题，所以我不知道如何才能设置更大的实例</p><p id="519e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">看起来好像我在应用程序处理信息的方式上遇到了某种内存泄漏。</p><div class="kg kh ez fb ki kj"><a href="https://en.wikipedia.org/wiki/Memory_leak" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">内存泄漏</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">在计算机科学中，内存泄漏是一种资源泄漏，当计算机程序错误地管理…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">en.wikipedia.org</p></div></div><div class="ks l"><div class="nj l ku kv kw ks kx ky kj"/></div></div></a></div><p id="7244" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我在StackOverflow中发现了这个线程，有人编写了一个函数，帮助识别代码中消耗内存的“顶部”行Python的默认<code class="du mj mk ml mm b">tracemalloc</code>模块</p><div class="kg kh ez fb ki kj"><a href="https://stackoverflow.com/questions/552744/how-do-i-profile-memory-usage-in-python/33631986" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">如何在Python中分析内存使用情况？</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">Python 3.4包含了一个新模块:tracemalloc。它提供了关于哪个代码分配最多的详细统计数据…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">stackoverflow.com</p></div></div><div class="ks l"><div class="nk l ku kv kw ks kx ky kj"/></div></div></a></div><p id="6120" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">所以我在我的代码中添加了一个基于StackOverflow帖子的自定义函数，该函数提取了前10个内存垃圾…</p><pre class="lr ls lt lu fd mo mm mp mq aw mr bi"><span id="e164" class="kz ig hi mm b fi ms mt l mu mv">import linecache<br/>import os<br/>import tracemalloc<br/><br/>def display_top(snapshot, key_type='lineno', limit=10):<br/>    snapshot = snapshot.filter_traces((<br/>        tracemalloc.Filter(False, "&lt;frozen importlib._bootstrap&gt;"),<br/>        tracemalloc.Filter(False, "&lt;unknown&gt;"),<br/>    ))<br/>    top_stats = snapshot.statistics(key_type)<br/><br/>    print("Top %s lines" % limit)<br/>    for index, stat in enumerate(top_stats[:limit], 1):<br/>        frame = stat.traceback[0]<br/>        # replace "/path/to/module/file.py" with "module/file.py"<br/>        filename = os.sep.join(frame.filename.split(os.sep)[-2:])<br/>        print("#%s: %s:%s: %.1f KiB"<br/>              % (index, filename, frame.lineno, stat.size / 1024))<br/>        line = linecache.getline(frame.filename, frame.lineno).strip()<br/>        if line:<br/>            print('    %s' % line)<br/><br/>    other = top_stats[limit:]<br/>    if other:<br/>        size = sum(stat.size for stat in other)<br/>        print("%s other: %.1f KiB" % (len(other), size / 1024))<br/>    total = sum(stat.size for stat in top_stats)<br/>    print("Total allocated size: %.1f KiB" % (total / 1024))</span><span id="17d8" class="kz ig hi mm b fi mx mt l mu mv"># OTHER CODE GOES HERE<br/># ...</span><span id="f8f3" class="kz ig hi mm b fi mx mt l mu mv">if __name__ == '__main__':</span><span id="3382" class="kz ig hi mm b fi mx mt l mu mv">    tracemalloc.start()</span><span id="7438" class="kz ig hi mm b fi mx mt l mu mv">    app.run(debug = True)</span><span id="8cdf" class="kz ig hi mm b fi mx mt l mu mv">    print('Top prefixes:', most_common)<br/>    snapshot = tracemalloc.take_snapshot()<br/>    display_top(snapshot)<br/></span></pre><p id="5a72" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">它吐出了这个:—</p><pre class="lr ls lt lu fd mo mm mp mq aw mr bi"><span id="d358" class="kz ig hi mm b fi ms mt l mu mv">TOP 10<br/>#1: &lt;frozen importlib._bootstrap_external&gt;:487: 66267.8 KiB</span><span id="0e03" class="kz ig hi mm b fi mx mt l mu mv">#2: gensim\utils.py:1398: 65934.3 KiB<br/>  return _pickle.load(f, encoding='latin1')</span><span id="f2ee" class="kz ig hi mm b fi mx mt l mu mv">#3: main.py:107: 10321.5 KiB<br/>    cv = CustomUnpickler(open('./MTBIModels/cv.pickle', 'rb')).load()</span><span id="1aed" class="kz ig hi mm b fi mx mt l mu mv">#4: core\completer.py:174: 9945.4 KiB<br/>    names.append(unicodedata.name(chr(c)))</span><span id="a09f" class="kz ig hi mm b fi mx mt l mu mv">#5: xlrd\xlsx.py:144: 5979.9 KiB<br/>    t = elem.text</span><span id="dfda" class="kz ig hi mm b fi mx mt l mu mv">#6: main.py:161: 2161.0 KiB<br/>    models['OPN'] = CustomUnpickler(open('BigFiveModels/OPN_model.pkl', 'rb')).load()</span><span id="1651" class="kz ig hi mm b fi mx mt l mu mv">#7: main.py:164: 2160.9 KiB<br/>    models['AGR'] = CustomUnpickler(open('BigFiveModels/AGR_model.pkl', 'rb')).load()</span><span id="7c4a" class="kz ig hi mm b fi mx mt l mu mv">#8: main.py:165: 2160.9 KiB<br/>    models['NEU'] = CustomUnpickler(open('BigFiveModels/NEU_model.pkl', 'rb')).load()</span><span id="0a38" class="kz ig hi mm b fi mx mt l mu mv">#9: main.py:162: 2160.4 KiB<br/>    models['CON'] = CustomUnpickler(open('BigFiveModels/CON_model.pkl', 'rb')).load()</span><span id="888f" class="kz ig hi mm b fi mx mt l mu mv">#10: main.py:163: 2160.2 KiB<br/>    models['EXT'] = CustomUnpickler(open('BigFiveModels/CON_model.pkl', 'rb')).load()</span><span id="7f12" class="kz ig hi mm b fi mx mt l mu mv">74040 other: 61565.3 KiB</span><span id="043f" class="kz ig hi mm b fi mx mt l mu mv">Total allocated size: 230817.6 KiB</span></pre><p id="9b17" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">查看输出，主要原因是预训练的Gensim Doc2Vec模型加载了65MB的内存，importlib加载了66MB的内存，以加载所有相关模块，但Tracemalloc说我只使用了231MiB的内存，这应该远远低于我选择的F4 1G实例中的2048MB内存…</p><p id="6294" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">嗯……那很奇怪。</p><h1 id="74af" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak"> 5。在谷歌计算引擎上的部署</strong></h1><p id="2293" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我在谷歌应用引擎上没有取得任何进展，所以我想尝试一些不同的东西，并试图让我的flask应用程序在谷歌计算引擎(GCE)上运行，而不是谷歌应用引擎。</p><p id="1562" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我遵循了本文中的说明:</p><div class="kg kh ez fb ki kj"><a href="https://towardsdatascience.com/deploying-a-custom-ml-prediction-service-on-google-cloud-ae3be7e6d38f" rel="noopener follow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">在Google计算引擎上部署ML模型</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">使用Flask在Google计算引擎上部署一个对象检测模型作为API，并使用…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">towardsdatascience.com</p></div></div><div class="ks l"><div class="nl l ku kv kw ks kx ky kj"/></div></div></a></div><p id="e09c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这显然是一种非常粗糙(也更昂贵)的部署方式，并且不会扩展，但我希望对正在发生的事情有更多的了解。</p><p id="d3e5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我最终发现了问题所在——这与内存泄漏无关。</p><p id="1262" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这是因为我使用NLTK _ data“punkt”和“stopwords”语料库，这些语料库早些时候在我从事另一个项目时已经下载到我的本地机器上，但我从未在Google App Engine上安装过它们！</p><p id="f0ed" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">奇怪的是，下面的错误消息从未出现在谷歌应用引擎日志中，因为当我试图运行应用程序时，它出现在我的谷歌计算引擎命令提示符上。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div class="er es nm"><img src="../Images/b182379e2732ec26aa244bb1f3ec6cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*M9Jh2gvR4oRNrjtS98t9lQ.png"/></div></figure><p id="fa12" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">当我在谷歌计算引擎上运行时，这两行代码修复了我的应用程序</p><p id="c0b3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><code class="du mj mk ml mm b">python -m nltk.downloader punkt</code></p><p id="e8b6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><code class="du mj mk ml mm b">python -m nltk.downloader stopwords</code></p><p id="07e0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">因此，我试图通过添加ntlk_data文件夹并更改<code class="du mj mk ml mm b">app.yaml</code>文件，将此修复“复制”回Google App Engine，如下所示</p><pre class="lr ls lt lu fd mo mm mp mq aw mr bi"><span id="0b27" class="kz ig hi mm b fi ms mt l mu mv">runtime: python37</span><span id="ae5b" class="kz ig hi mm b fi mx mt l mu mv">entrypoint: gunicorn -b :$PORT main:app --timeout 120</span><span id="55df" class="kz ig hi mm b fi mx mt l mu mv">instance_class: F4_1G</span><span id="6cc0" class="kz ig hi mm b fi mx mt l mu mv">env_variables:<br/>    NLTK_DATA: './nltk_data'</span></pre><p id="72ef" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">手指交叉…这次应该能成功。</p><figure class="lr ls lt lu fd lv er es paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="er es nn"><img src="../Images/6dfa08cae6534d988c0be3b87654ba1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jMwpJ8khOVfixQDFwYkZvA.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx translated">fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</figcaption></figure><h1 id="42e8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">6.结论</h1><figure class="lr ls lt lu fd lv er es paragraph-image"><div class="er es no"><img src="../Images/fe968e170af5c75cb3f2265ac5d56fa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*6Ay1uaRM2oUmabqbVW0-gQ.png"/></div><figcaption class="mb mc et er es md me bd b be z dx translated">哇啊啊</figcaption></figure><p id="19fa" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我知道Medium.com不是StackOverflow，但是任何读到这篇文章的人，如果有什么建议，请在评论中给我留言。</p></div></div>    
</body>
</html>