<html>
<head>
<title>AWS Step Function Tricks (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS阶跃函数技巧(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/aws-step-function-tricks-part-2-328fa3bc9e50?source=collection_archive---------5-----------------------#2020-09-28">https://medium.com/analytics-vidhya/aws-step-function-tricks-part-2-328fa3bc9e50?source=collection_archive---------5-----------------------#2020-09-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c969" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">错误处理和递归工作流</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/af1cc7d9a4ba438263d6e47ec8ee6f6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OPimsVOoJ1XNsTnuS7MAaQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">AWS步骤功能的实际应用</figcaption></figure><p id="7499" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果你还没有，从最初的<a class="ae kj" rel="noopener" href="/analytics-vidhya/aws-step-function-tricks-ffe7eef81a5e"> AWS步骤功能技巧</a>故事开始你的旅程，开始一些你能做的基本技巧。</p><p id="12c4" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在本文中，我们将介绍如何:</p><ul class=""><li id="9555" class="kk kl hi jp b jq jr jt ju jw km ka kn ke ko ki kp kq kr ks bi translated">以更简洁的方式处理错误，保持我们的工作流程整洁</li><li id="1868" class="kk kl hi jp b jq kt jt ku jw kv ka kw ke kx ki kp kq kr ks bi translated">为基于日期的连续作业构建递归工作流</li></ul><h1 id="955e" class="ky kz hi bd la lb lc ld le lf lg lh li io lj ip lk ir ll is lm iu ln iv lo lp bi translated">错误处理</h1><p id="4d7f" class="pw-post-body-paragraph jn jo hi jp b jq lq ij js jt lr im jv jw ls jy jz ka lt kc kd ke lu kg kh ki hb bi translated">所以在大多数AWS步骤函数状态中，您可以指定一个<code class="du lv lw lx ly b">Catch</code>部分来允许您处理错误。通常，您希望在工作流程中发生意外情况时通知自己和团队——批处理作业失败、EMR集群死亡、Docker容器启动失败、Lambda错误等。因此，您的工作流可能看起来像这个(琐碎的)例子，其中每一步<code class="du lv lw lx ly b">Hello, World, Foo, Bar</code>您都在捕捉错误并在工作流失败之前通知自己。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lz"><img src="../Images/f45aaf3d6842f2681541bd2ce432fc7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X2YKuaNOkWAwxGBLXDCypQ.png"/></div></div></figure><p id="6419" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">正如你所看到的，每增加一个步骤，工作流程就会变得更加糟糕。</p><p id="67f3" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">下面是一个步骤函数声明，它将带我们到达那里(<strong class="jp hj">不要复制这个</strong>):</p><pre class="iy iz ja jb fd ma ly mb mc aw md bi"><span id="3638" class="me kz hi ly b fi mf mg l mh mi">{<br/>  "Comment": "One handler per state",<br/>  "StartAt": "Hello",<br/>  "States": {<br/>    "Hello": {<br/>      "Type": "Task",<br/>      "Resource": "&lt;LAMBDA_FUNCTION_ARN&gt;",<br/>      "Next": "World",<br/>      "Catch": [<br/>        {<br/>          "ErrorEquals": [<br/>            "States.ALL"<br/>          ],<br/>          "ResultPath": "$.error",<br/>          "Next": "Send Failure Message"<br/>        }<br/>      ]<br/>    },<br/>    "World": {<br/>      "Type": "Task",<br/>      "Resource": "&lt;LAMBDA_FUNCTION_ARN&gt;",<br/>      "Next": "Foo",<br/>      "Catch": [<br/>        {<br/>          "ErrorEquals": [<br/>            "States.ALL"<br/>          ],<br/>          "ResultPath": "$.error",<br/>          "Next": "Send Failure Message"<br/>        }<br/>      ]<br/>    },<br/>    "Foo": {<br/>      "Type": "Task",<br/>      "Resource": "&lt;LAMBDA_FUNCTION_ARN&gt;",<br/>      "Next": "Bar",<br/>      "Catch": [<br/>        {<br/>          "ErrorEquals": [<br/>            "States.ALL"<br/>          ],<br/>          "ResultPath": "$.error",<br/>          "Next": "Send Failure Message"<br/>        }<br/>      ]<br/>    },<br/>    "Bar": {<br/>      "Type": "Task",<br/>      "Resource": "&lt;LAMBDA_FUNCTION_ARN&gt;",<br/>      "Next": "Job Succeeded",<br/>      "Catch": [<br/>        {<br/>          "ErrorEquals": [<br/>            "States.ALL"<br/>          ],<br/>          "ResultPath": "$.error",<br/>          "Next": "Send Failure Message"<br/>        }<br/>      ]<br/>    },<br/>    "Job Succeeded": {<br/>      "Type": "Succeed"<br/>    },<br/>    "Send Failure Message": {<br/>      "Type": "Pass",<br/>      "Next": "Fail Workflow"<br/>    },<br/>    "Fail Workflow": {<br/>      "Type": "Fail"<br/>    }<br/>  }<br/>}</span></pre><p id="6583" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这很棒，除了我们添加的每一个额外步骤，我们都必须在每个步骤中添加catch组件。这给我们看起来已经很糟糕的工作流程增加了很多麻烦。</p><p id="8a1c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果我们重组它，我们可以有一个只需要捕捉一次的工作流。把它想象成一个外部异常处理程序，你通常会在你的代码中创建它，除了我们把同样的原则应用于工作流。很明显，一旦你的工作流程中有了两个以上的状态，这种效率就会提高。我们可以利用<code class="du lv lw lx ly b">Parallel</code>州的力量来得到我们想要的东西。我们想要更像这样的东西:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/748ec8139ffba9457a34f14667329244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AYwJhudqYjj6q_ILZhrAhQ.png"/></div></div></figure><p id="c941" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">更好的错误处理步骤函数声明。您可以看到里面的状态更加简洁，也更容易管理，图表是。眼睛也好看多了。(<strong class="jp hj">一定要抄这个</strong>)</p><pre class="iy iz ja jb fd ma ly mb mc aw md bi"><span id="bd1a" class="me kz hi ly b fi mf mg l mh mi">{<br/>  "Comment": "Better error handling",<br/>  "StartAt": "ErrorHandler",<br/>  "States": {<br/>    "ErrorHandler": {<br/>      "Type": "Parallel",<br/>      "Branches": [<br/>        {<br/>          "StartAt": "Hello",<br/>          "States": {<br/>            "Hello": {<br/>              "Type": "Pass",<br/>              "Result": "Hello",<br/>              "Next": "World"<br/>            },<br/>            "World": {<br/>              "Type": "Pass",<br/>              "Result": "World",<br/>              "Next": "Foo"<br/>            },<br/>            "Foo": {<br/>              "Type": "Pass",<br/>              "Result": "World",<br/>              "Next": "Bar"<br/>            },<br/>            "Bar": {<br/>              "Type": "Pass",<br/>              "Result": "World",<br/>              "End": true<br/>            }<br/>          }<br/>        }<br/>      ],<br/>      "Catch": [<br/>        {<br/>          "ErrorEquals": [<br/>            "States.ALL"<br/>          ],<br/>          "ResultPath": "$.error",<br/>          "Next": "Send Failure Message"<br/>        }<br/>      ],<br/>      "Next": "Job Succeeded"<br/>    },<br/>    "Job Succeeded": {<br/>      "Type": "Succeed"<br/>    },<br/>    "Send Failure Message": {<br/>      "Type": "Pass",<br/>      "Next": "Fail Workflow"<br/>    },<br/>    "Fail Workflow": {<br/>      "Type": "Fail"<br/>    }<br/>  }<br/>}</span></pre><p id="fc55" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">无处不在的<code class="du lv lw lx ly b">Catch</code>语句🤗；我们可以添加新的步骤，而不必记住将每个步骤绑定到错误处理。</p></div><div class="ab cl mk ml gp mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hb hc hd he hf"><h1 id="725d" class="ky kz hi bd la lb mr ld le lf ms lh li io mt ip lk ir mu is lm iu mv iv lo lp bi translated">递归工作流</h1><p id="cac7" class="pw-post-body-paragraph jn jo hi jp b jq lq ij js jt lr im jv jw ls jy jz ka lt kc kd ke lu kg kh ki hb bi translated">所以AWS说“不要这样”。就他们而言，你“应该”创建的图是一个有向无环图。这很好，除非你想重复做某件事，直到完成任务。一个很好的例子是从日期A到日期b回填一些数据。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mw"><img src="../Images/4217be624b1e0209206382ffaa8f53c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2o_rhSLwxOf9tNbmPVdkDw.png"/></div></div></figure><p id="ed7d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">方便的是，我们已经从本文前面的错误处理示例中提取出来，并在此基础上构建，因此任何失败都会向我们显示它们的错误😉。我们还将利用AWS step functions(2020年8月发布)的一个新功能，即<code class="du lv lw lx ly b">TimestampLessThanEqualsPath</code>比较器，来比较输入中的两个不同变量。在这里，我们可以利用一个<code class="du lv lw lx ly b">startDate</code>和<code class="du lv lw lx ly b">endDate</code>来限定我们希望递归工作流操作的范围。</p><pre class="iy iz ja jb fd ma ly mb mc aw md bi"><span id="7737" class="me kz hi ly b fi mf mg l mh mi">{<br/>  "Comment": "Better error handling",<br/>  "StartAt": "ErrorHandler",<br/>  "States": {<br/>    "ErrorHandler": {<br/>      "Type": "Parallel",<br/>      "Branches": [<br/>        {<br/>          "StartAt": "Is Date &lt;= X",<br/>          "States": {<br/>            "Is Date &lt;= X": {<br/>              "Type": "Choice",<br/>              "Choices": [<br/>                {<br/>                  "Variable": "$.startDate",<br/>                  "TimestampLessThanEqualsPath": "$.endDate",<br/>                  "Next": "Run the job workflow"<br/>                }<br/>              ],<br/>              "Default": "Backfill complete"<br/>            },<br/>            "Backfill complete": {<br/>              "Type": "Pass",<br/>              "Result": "World",<br/>              "End": true<br/>            },<br/>            "Run the job workflow": {<br/>              "Type": "Task",<br/>              "Resource": "arn:aws:states:::states:startExecution.sync",<br/>              "Parameters": {<br/>                "StateMachineArn": "&lt;STATE_MACHINE_ARN&gt;",<br/>                "Input": {<br/>                  "date": "$.startDate",<br/>                  "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"<br/>                }<br/>              },<br/>              "Next": "Add 1 day"<br/>            },<br/>            "Add 1 day": {<br/>              "Type": "Task",<br/>              "Resource": "&lt;LAMBDA_FUNCTION_ARN&gt;",<br/>              "Parameters": {<br/>                "date.$": "$.startDate"<br/>              },<br/>              "ResultPath": "$.startDate",<br/>              "Next": "Is Date &lt;= X"<br/>            }<br/>          }<br/>        }<br/>      ],<br/>      "Catch": [<br/>        {<br/>          "ErrorEquals": [<br/>            "States.ALL"<br/>          ],<br/>          "ResultPath": "$.error",<br/>          "Next": "Send Failure Message"<br/>        }<br/>      ],<br/>      "Next": "Job Succeeded"<br/>    },<br/>    "Job Succeeded": {<br/>      "Type": "Succeed"<br/>    },<br/>    "Send Failure Message": {<br/>      "Type": "Pass",<br/>      "Next": "Fail Workflow"<br/>    },<br/>    "Fail Workflow": {<br/>      "Type": "Fail"<br/>    }<br/>  }<br/>}</span></pre><p id="b221" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">只要用一个<code class="du lv lw lx ly b">{"startDate": "2020-09-01T00:00:00Z", "endDate": "2020-09-09T00:00:00Z"}</code>启动这个工作流，你将得到9个工作流的迭代，每个迭代的执行时间有1天的差异。</p><p id="63bb" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这个工作流确实依赖于一个lambda从您的日期输入中减去1天来覆盖<code class="du lv lw lx ly b">$.startDate</code>，但是我将把它留给您来实现。我得给你留些有趣的事做😜</p></div><div class="ab cl mk ml gp mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hb hc hd he hf"><h1 id="86e4" class="ky kz hi bd la lb mr ld le lf ms lh li io mt ip lk ir mu is lm iu mv iv lo lp bi translated">结论</h1><p id="4112" class="pw-post-body-paragraph jn jo hi jp b jq lq ij js jt lr im jv jw ls jy jz ka lt kc kd ke lu kg kh ki hb bi translated">有可能有体面的错误处理，不需要太多的努力来实现，并捕捉工作流中的所有错误。现在，您应该能够实现递归工作流，使用一个新的可用选择运算符来执行基于时间的操作。</p><p id="cfed" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">感谢阅读。</p></div></div>    
</body>
</html>