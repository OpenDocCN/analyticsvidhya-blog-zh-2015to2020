<html>
<head>
<title>RESTful API, HOW TO | Part 4 — Deployment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RESTful API，如何|第4部分—部署</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/restful-api-how-to-part-4-deployment-2347d44e4aad?source=collection_archive---------24-----------------------#2020-03-22">https://medium.com/analytics-vidhya/restful-api-how-to-part-4-deployment-2347d44e4aad?source=collection_archive---------24-----------------------#2020-03-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/45375d3f7f32820ae279c163f95b96da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aEBsUohbuE-pN7S4"/></div></div></figure><p id="f347" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">设计和实施服务是我日常工作的一部分，我想分享一些最佳实践和技巧，可以帮助你的工作。</p><p id="ce63" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个关于RESTful API的系列文章中，我将讨论几个主题:</p><ul class=""><li id="b70c" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">设计</li><li id="48a7" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">履行</li><li id="b5d1" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">测试</li><li id="b828" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><strong class="is hj">部署</strong></li></ul><h1 id="6a7b" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">一些信息</h1><blockquote class="la lb lc"><p id="a9fe" class="iq ir ld is b it iu iv iw ix iy iz ja le jc jd je lf jg jh ji lg jk jl jm jn hb bi translated"><em class="hi">我们将使用</em><a class="ae lh" href="https://editor.swagger.io/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="hi">swagger</em></strong></a><em class="hi">来设计我们的API，</em><a class="ae lh" href="https://www.python.org/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="hi">python</em></strong></a><em class="hi">语言来创建微服务，最后</em><a class="ae lh" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="hi">Docker</em></strong></a><em class="hi">来交付最终的解决方案。所有的代码都在这个</em> <a class="ae lh" href="https://github.com/dandpz/restfulapi-howto" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> <em class="hi">回购</em> </strong> </a> <em class="hi">中。</em></p></blockquote></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><p id="92f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在到了本系列的最后一篇文章。这里我们将讨论应用程序的部署。对于这个范围我们将使用Docker技术，如果你不知道它，去<a class="ae lh" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">官方网站</a>，在那里你会找到很多关于它的信息，并且<a class="ae lh" href="https://docs.docker.com/" rel="noopener ugc nofollow" target="_blank">文档</a>是一个宝贵的资源。</p><p id="4adf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将不涉及docker的安装，它取决于您的平台，所以我将直接跳到应用程序部署。</p><h1 id="867c" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">Dockerfile文件</h1><p id="d524" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">首先我们必须填充Dockerfile，在生成的代码中Dockerfile已经存在，但是我们应该稍微改变一下内容。在文件的新版本下面。</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="5950" class="md kd hi lz b fi me mf l mg mh">FROM pypy:3-7.3.0-slim<br/><br/># add a not privileged user<br/>RUN useradd base_user<br/><br/># create the application folder and set it as the working directory<br/>RUN mkdir -p /usr/src/app<br/>WORKDIR /usr/src/app<br/><br/># upgrade pip and install requirements<br/>RUN pip install --upgrade pip<br/>COPY requirements.txt /usr/src/app/<br/>RUN pip install --no-cache-dir -r requirements.txt<br/><br/># copy the application to the wd<br/>COPY . /usr/src/app<br/><br/># switch to not privileged user<br/>USER base_user<br/><br/>EXPOSE 8080<br/><br/>ENTRYPOINT ["gunicorn"]<br/><br/>CMD ["wsgi:app"]</span></pre><p id="bd3a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如您所看到的，文件已经发生了很大的变化，我想重点介绍文件的不同部分:</p><h2 id="2833" class="md kd hi bd ke mi mj mk ki ml mm mn km jb mo mp kq jf mq mr ku jj ms mt ky mu bi translated">安全性</h2><p id="3f1c" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在网上你会发现大量的Dockerfile例子，但是它们经常会带来安全漏洞。让我们来谈谈docker用户拥有的用户特权:</p><p id="263b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基本映像几乎总是以<em class="ld"> root </em>权限运行，这是因为他们需要安装包来构建基本映像，但对于最终应用程序来说，通常不再需要root用户，相反它可能会使您的系统暴露在危险的攻击之下。</p><p id="d53d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了降低这种风险，我们创建一个没有root权限的用户，然后在配置完映像后，我们切换到这个<strong class="is hj">用户</strong>。这是运行我们的容器的更安全的方式。</p><h2 id="3265" class="md kd hi bd ke mi mj mk ki ml mm mn km jb mo mp kq jf mq mr ku jj ms mt ky mu bi translated">隐藏物</h2><p id="9bc4" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">在构建阶段，缓存层非常有用，不会浪费太多时间等待，当我们编写Dockerfile时，明智地编写每个指令非常重要，例如，我们首先复制需求文件并安装它们，然后才复制应用程序文件夹。这样，如果我们更改代码中的任何内容，我们不会使需求无效，映像将使用缓存层并跳过需求的安装。</p><h2 id="da42" class="md kd hi bd ke mi mj mk ki ml mm mn km jb mo mp kq jf mq mr ku jj ms mt ky mu bi translated">图像尺寸</h2><p id="08fd" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">谈到图层，我们还应该考虑图像的大小，包括基本图像和我们用Dockerfile添加的图层。</p><p id="8207" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">始终选择符合您的<strong class="is hj">要求</strong>的基础映像！显然，从两个方向来看，浪费几个小时的工作来从一个<em class="ld"> scratch </em>映像构建您的映像，以使最终的映像大小减少4 MB是没有意义的。</p><p id="9528" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还要考虑编辑Dockerfile文件时添加的所有层。</p><p id="58e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后但同样重要的是，给你的项目添加一个<strong class="is hj">是非常重要的。dockerignore </strong>文件，其工作方式与已知的<em class="ld">完全相同。git忽略</em>文件，避免将<em class="ld">无用的</em>文件和目录复制到您的映像中。</p><h2 id="9fe8" class="md kd hi bd ke mi mj mk ki ml mm mn km jb mo mp kq jf mq mr ku jj ms mt ky mu bi translated">建设</h2><p id="0f5e" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">为了构建映像，我们运行以下命令:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="f8cb" class="md kd hi lz b fi me mf l mg mh">docker build -t test_app:1.0 .</span></pre><p id="9265" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用这个命令，我们用标签<em class="ld"> test_app:1.0来标记我们的图像。</em></p><blockquote class="mv"><p id="a92d" class="mw mx hi bd my mz na nb nc nd ne jn dx translated">这里，我们在本地环境中构建应用程序的docker映像，在真实的生产环境中，强烈建议将映像推送到docker注册表中。</p><p id="6cb9" class="mw mx hi bd my mz na nb nc nd ne jn dx translated">要了解更多信息，请参见<a class="ae lh" href="https://docs.docker.com/registry/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p></blockquote><h1 id="cd4e" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn nf kp kq kr ng kt ku kv nh kx ky kz bi translated">生产喜欢</h1><p id="bbb2" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">因此，我们现在已经构建了docker映像，为了模拟类似生产的环境，我们将使用<a class="ae lh" href="https://docs.docker.com/compose/" rel="noopener ugc nofollow" target="_blank"> docker compose </a>。请参阅文档，以便在您的系统上安装它。</p><p id="b979" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在docker-compose文件下面。</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="d749" class="md kd hi lz b fi me mf l mg mh">version: '3'<br/>services:<br/>  api:<br/>    image: test_app:1.0<br/>    ports:<br/>    - 80:8080<br/>    env_file:<br/>      - .env<br/>    restart: always</span></pre><p id="54db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在docker-compose文件中，我们描述了应用程序部署的配置，我们在<em class="ld">端口</em> 80上公开应用程序，沿着docker-compose文件我们将提供一个<strong class="is hj">。env </strong>文件包含所有对配置应用程序有用的环境变量。<em class="ld">重启</em>指令指示发动机始终重启<strong class="is hj">容器</strong>已经停止。</p><p id="9bc1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们运行它:</p><pre class="lu lv lw lx fd ly lz ma mb aw mc bi"><span id="f5ed" class="md kd hi lz b fi me mf l mg mh">docker-compose up --scale api=3</span></pre><p id="a55e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用<em class="ld"> scale </em>标志，我们告诉docker-compose创建3个服务实例，这样我们就可以处理大量的流量。</p></div><div class="ab cl li lj gp lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="hb hc hd he hf"><p id="ab57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们看到hot to <strong class="is hj">配置</strong>一个docker文件并<strong class="is hj">运行</strong>带有docker compose的容器。我们没有讨论像Docker Swarm或Kubernetes这样的<em class="ld">编排</em>工具，因为它们很复杂，不在本文的讨论范围之内。</p><p id="a019" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于Docker，我想列出一些有用的链接:</p><ul class=""><li id="b861" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><a class="ae lh" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" rel="noopener ugc nofollow" target="_blank">https://docs . docker . com/develop/develop-images/docker file _ best-practices/</a></li><li id="4c12" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">【https://docs.docker.com/engine/security/security/ T4】</li><li id="c1ad" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated"><a class="ae lh" href="https://www.docker.com/play-with-docker" rel="noopener ugc nofollow" target="_blank">https://www.docker.com/play-with-docker</a></li></ul><p id="aa68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">就这些！</strong>我们终于到了这个系列的最后一篇文章，感谢来到这里的每一个人，<strong class="is hj">感谢你们</strong>在这次冒险中跟随我，并且<strong class="is hj">永远保持学习</strong>！</p><blockquote class="la lb lc"><p id="2459" class="iq ir ld is b it iu iv iw ix iy iz ja le jc jd je lf jg jh ji lg jk jl jm jn hb bi translated"><strong class="is hj">提醒:</strong>你可以在<strong class="is hj"> </strong> <a class="ae lh" href="https://github.com/dandpz/restfulapi-howto" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">这个GitHub库找到所有更新的代码！</strong> </a></p><p id="027c" class="iq ir ld is b it iu iv iw ix iy iz ja le jc jd je lf jg jh ji lg jk jl jm jn hb bi translated">链接往期文章:<a class="ae lh" rel="noopener" href="/analytics-vidhya/restful-api-how-to-part-3-testing-8fd3fac4e1cd">https://medium . com/analytics-vid hya/restful-API-how-to-part-3-testing-8 FD 3 fac 4 E1 CD</a></p></blockquote></div></div>    
</body>
</html>