<html>
<head>
<title>Make a Weather Application using Django Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Django第2部分制作一个天气应用程序</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/make-a-weather-application-using-django-part-2-9b8c47229bb3?source=collection_archive---------11-----------------------#2019-12-26">https://medium.com/analytics-vidhya/make-a-weather-application-using-django-part-2-9b8c47229bb3?source=collection_archive---------11-----------------------#2019-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a8d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大家好，今天我想继续上一篇关于如何使用django制作天气应用的文章。这一次我想增加一些功能，如删除城市，防止重复的城市在列表中，等等。所以，让我们开始吧！</p><p id="8afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们在搜索栏中添加一个城市，例如“纽约”，现在我们将尝试添加同一个城市，我们的列表中将会有两个“纽约”。所以我们必须解决这个问题，在你的视图中输入粗体部分。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0d85" class="jm jn hi ji b fi jo jp l jq jr">import requests<br/>from django.shortcuts import render<br/>from .models import City<br/>from .forms import CityForm<br/><br/>def index(request):<br/>    url = 'http://api.openweathermap.org/data/2.5/weather?q={}&amp;units=imperial&amp;appid=271d1234d3f497eed5b1d80a07b3fcd1'<br/><br/>   <strong class="ji hj"> err_msg = ''<br/><br/>    if request.method == "POST":<br/>        form = CityForm(request.POST)<br/><br/>        if form.is_valid():<br/>            new_city = form.cleaned_data['name']<br/>            existing_city_count = City.objects.filter(name=new_city).count()<br/><br/>            if existing_city_count == 0:<br/>                form.save()<br/>            else:<br/>                err_msg = 'City already exists in the database!'</strong><br/><br/>    form = CityForm()<br/><br/>    cities = City.objects.all()<br/><br/>    weather_data = []<br/><br/>    for city in cities:<br/>        r = requests.get(url.format(city)).json()<br/><br/>        city_weather = {<br/>            'city': city.name,<br/>            'temperature': r["main"]["temp"],<br/>            'description': r["weather"][0]["description"],<br/>            'icon': r["weather"][0]["icon"],<br/>        }<br/>        weather_data.append(city_weather)<br/><br/>    context = {'weather_data' : weather_data, 'form' : form}<br/>    return render(request, 'weather/weather.html', context)</span></pre><p id="dcaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，现在如果您尝试添加一个已经在我们的城市列表中列出的城市，它将不会再次出现。接下来是我们要添加的城市必须存在于这个世界上。在views.py上键入粗体部分。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="04f1" class="jm jn hi ji b fi jo jp l jq jr">import requests<br/>from django.shortcuts import render<br/>from .models import City<br/>from .forms import CityForm<br/><br/>def index(request):<br/>    url = 'http://api.openweathermap.org/data/2.5/weather?q={}&amp;units=imperial&amp;appid=271d1234d3f497eed5b1d80a07b3fcd1'<br/><br/>    err_msg = ''<br/>  <strong class="ji hj">  message = ''<br/>    message_class = ''</strong><br/><br/>    if request.method == "POST":<br/>        form = CityForm(request.POST)<br/><br/>        if form.is_valid():<br/>            new_city = form.cleaned_data['name']<br/>            existing_city_count = City.objects.filter(name=new_city).count()<br/><br/>            if existing_city_count == 0:<br/>               <strong class="ji hj"> r = requests.get(url.format(new_city)).json()</strong><br/><br/>                <strong class="ji hj">if r['cod'] == 200:<br/>                    form.save()<br/>                else:<br/>                    err_msg = 'City does not exist in this world!'<br/>            else:<br/>                err_msg = 'City already exists in the database!'</strong><br/><br/>       <strong class="ji hj"> if err_msg:<br/>            message = err_msg<br/>            message_class = "is-danger"<br/>        else:<br/>            message = "City added succesfully!"<br/>            message_class = "is-success"</strong><br/><br/>    form = CityForm()<br/><br/>    cities = City.objects.all()<br/><br/>    weather_data = []<br/><br/>    for city in cities:<br/>        r = requests.get(url.format(city)).json()<br/><br/>        city_weather = {<br/>            'city': city.name,<br/>            'temperature': r["main"]["temp"],<br/>            'description': r["weather"][0]["description"],<br/>            'icon': r["weather"][0]["icon"],<br/>        }<br/>        weather_data.append(city_weather)<br/><br/>  <strong class="ji hj">  context = {<br/>        'weather_data' : weather_data,<br/>        'form' : form,<br/>        'message' : message,<br/>        'message_class' : message_class,<br/>    }</strong><br/>    return render(request, 'weather/weather.html', context)</span></pre><p id="450a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在转到“weather.html ”,将这段代码添加到第37行下面:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="7d55" class="jm jn hi ji b fi jo jp l jq jr"><strong class="ji hj">{% if message %}<br/>    &lt;div class="notification {{ message_class }}"&gt;{{ message }}&lt;/div&gt;<br/>{% endif %}</strong></span></pre><p id="3091" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在尝试运行服务器，您将看到如下描述</p><figure class="jd je jf jg fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es js"><img src="../Images/e76faaf740d45d52b1cc91f49acbee41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fwYvx4HgWiklGcfN_4jnaQ.png"/></div></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">如果我添加新城市</figcaption></figure><figure class="jd je jf jg fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es ke"><img src="../Images/49d0d5b804eb3566bff7d983fa1f049d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DyB9QJbVjoy1C7xYkdNQ7w.png"/></div></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">如果我加上世界上不存在的城市帽子</figcaption></figure><figure class="jd je jf jg fd jt er es paragraph-image"><div role="button" tabindex="0" class="ju jv di jw bf jx"><div class="er es kf"><img src="../Images/a291bf065bf78c33efbf804371d0b62c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wUZH5OKem3AWWDcZPg-Lcg.png"/></div></div><figcaption class="ka kb et er es kc kd bd b be z dx translated">如果我添加列表中已经存在的城市</figcaption></figure><p id="9eea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们希望允许用户删除城市。首先，我们要显示删除图标，在第67行下面的“weather.html”中键入这个图标。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="14e1" class="jm jn hi ji b fi jo jp l jq jr"><strong class="ji hj">&lt;div class="media-right"&gt;<br/>    &lt;a href="'#"&gt;<br/>        &lt;button class="delete"&gt;&lt;/button&gt;<br/>    &lt;/a&gt;<br/>&lt;/div&gt;</strong></span></pre><p id="a313" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来转到views.py并输入粗体部分。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="4010" class="jm jn hi ji b fi jo jp l jq jr">import requests<br/>from django.shortcuts import render<strong class="ji hj">, redirect</strong><br/>from .models import City<br/>from .forms import CityForm<br/><br/>def index(request):<br/>    url = 'http://api.openweathermap.org/data/2.5/weather?q={}&amp;units=imperial&amp;appid=271d1234d3f497eed5b1d80a07b3fcd1'<br/><br/>    err_msg = ''<br/>    message = ''<br/>    message_class = ''<br/><br/>    if request.method == "POST":<br/>        form = CityForm(request.POST)<br/><br/>        if form.is_valid():<br/>            new_city = form.cleaned_data['name']<br/>            existing_city_count = City.objects.filter(name=new_city).count()<br/><br/>            if existing_city_count == 0:<br/>                r = requests.get(url.format(new_city)).json()<br/><br/>                if r['cod'] == 200:<br/>                    form.save()<br/>                else:<br/>                    err_msg = 'City does not exist in this world!'<br/>            else:<br/>                err_msg = 'City already exists in the database!'<br/><br/>        if err_msg:<br/>            message = err_msg<br/>            message_class = "is-danger"<br/>        else:<br/>            message = "City added succesfully!"<br/>            message_class = "is-success"<br/><br/>    form = CityForm()<br/><br/>    cities = City.objects.all()<br/><br/>    weather_data = []<br/><br/>    for city in cities:<br/>        r = requests.get(url.format(city)).json()<br/><br/>        city_weather = {<br/>            'city': city.name,<br/>            'temperature': r["main"]["temp"],<br/>            'description': r["weather"][0]["description"],<br/>            'icon': r["weather"][0]["icon"],<br/>        }<br/>        weather_data.append(city_weather)<br/><br/>    context = {<br/>        'weather_data' : weather_data,<br/>        'form' : form,<br/>        'message' : message,<br/>        'message_class' : message_class,<br/>    }<br/>    return render(request, 'weather/weather.html', context)<br/><br/><strong class="ji hj">def delete_city(request, city_name):<br/>    return redirect('home')</strong></span></pre><p id="5edc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到“weather/urls.py”并输入粗体部分。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0d6e" class="jm jn hi ji b fi jo jp l jq jr">from django.urls import path<br/>from . import views<br/><br/>urlpatterns = [<br/>    path('', views.index<strong class="ji hj">, name='home'</strong>),<br/>    <strong class="ji hj">path('delete/&lt;city_name&gt;/', views.delete_city, name='delete_city')</strong><br/>]</span></pre><p id="dd88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来进入“weather.html ”,输入粗体部分。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="018d" class="jm jn hi ji b fi jo jp l jq jr">&lt;div class="media-right"&gt;<br/>    <strong class="ji hj">&lt;a href="{% url 'delete_city' city_weather.city %}"&gt;</strong><br/>        &lt;button class="delete"&gt;&lt;/button&gt;<br/>    &lt;/a&gt;<br/>&lt;/div&gt;</span></pre><p id="5584" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，转到views.py并键入粗体部分。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="c342" class="jm jn hi ji b fi jo jp l jq jr">import requests<br/>from django.shortcuts import render, redirect<br/>from .models import City<br/>from .forms import CityForm<br/><br/>def index(request):<br/>    url = 'http://api.openweathermap.org/data/2.5/weather?q={}&amp;units=imperial&amp;appid=271d1234d3f497eed5b1d80a07b3fcd1'<br/><br/>    err_msg = ''<br/>    message = ''<br/>    message_class = ''<br/><br/>    if request.method == "POST":<br/>        form = CityForm(request.POST)<br/><br/>        if form.is_valid():<br/>            new_city = form.cleaned_data['name']<br/>            existing_city_count = City.objects.filter(name=new_city).count()<br/><br/>            if existing_city_count == 0:<br/>                r = requests.get(url.format(new_city)).json()<br/><br/>                if r['cod'] == 200:<br/>                    form.save()<br/>                else:<br/>                    err_msg = 'City does not exist in this world!'<br/>            else:<br/>                err_msg = 'City already exists in the database!'<br/><br/>        if err_msg:<br/>            message = err_msg<br/>            message_class = "is-danger"<br/>        else:<br/>            message = "City added succesfully!"<br/>            message_class = "is-success"<br/><br/>    form = CityForm()<br/><br/>    cities = City.objects.all()<br/><br/>    weather_data = []<br/><br/>    for city in cities:<br/>        r = requests.get(url.format(city)).json()<br/><br/>        city_weather = {<br/>            'city': city.name,<br/>            'temperature': r["main"]["temp"],<br/>            'description': r["weather"][0]["description"],<br/>            'icon': r["weather"][0]["icon"],<br/>        }<br/>        weather_data.append(city_weather)<br/><br/>    context = {<br/>        'weather_data' : weather_data,<br/>        'form' : form,<br/>        'message' : message,<br/>        'message_class' : message_class,<br/>    }<br/>    return render(request, 'weather/weather.html', context)<br/><br/>def delete_city(request, city_name):<br/>    <strong class="ji hj">City.objects.get(name=city_name).delete()</strong><br/>    return redirect('home')</span></pre><p id="151d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，尝试运行服务器，如您所见，如果您愿意，可以删除城市。</p><p id="a98a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的教程到此结束，希望这对想学习的人有用。</p><p id="00b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢，请继续关注我的下一篇文章！</p></div></div>    
</body>
</html>