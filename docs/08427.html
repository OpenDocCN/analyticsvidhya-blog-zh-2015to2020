<html>
<head>
<title>Accessing Google Sheets using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 访问 Google Sheets</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/accessing-google-sheets-using-python-2ceb3b5cd3ab?source=collection_archive---------11-----------------------#2020-07-29">https://medium.com/analytics-vidhya/accessing-google-sheets-using-python-2ceb3b5cd3ab?source=collection_archive---------11-----------------------#2020-07-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a437" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用熊猫数据框架读/写 Google 工作表</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/b817053d6749575f6a3e9544932af106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*86RFEDlsENz3xgYwn0QS3w.png"/></div></div></figure><p id="fadf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将解释使用 python 读写 google sheets 的选项。Google Sheets API 允许我们读取和修改电子表格的任何方面。使用 Python 访问此功能并链接到 Python 数据帧有助于我们实现自动化并进行更多的数据分析。</p><h2 id="97cb" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">安装所需的软件和库:</h2><p id="8d2d" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">在进入实现这一目标的步骤之前，我们需要具备以下条件:</p><ul class=""><li id="5290" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated">Python 2.6 或更高版本:我更喜欢安装<a class="ae ky" href="https://docs.anaconda.com/anaconda/install/" rel="noopener ugc nofollow" target="_blank"> Anaconda 个人版、</a>，因为它有 Python 发行版和<a class="ae ky" href="https://pypi.python.org/pypi/pip" rel="noopener ugc nofollow" target="_blank"> pip </a>包管理工具。创建 Python 开发环境的说明可以在我的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/@nsanka/create-development-environment-with-vs-code-fe66f3892159">上一篇文章</a>中找到。</li><li id="544f" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc ku kv kw kx bi translated">Pandas 和 Google 客户端库:一旦我们有了 Python 和 pip，我们就可以在终端/命令提示符下安装所需的库，如下所示:</li></ul><pre class="je jf jg jh fd le lf lg lh aw li bi"><span id="3edd" class="jp jq hi lf b fi lj lk l ll lm">pip install --upgrade pandas<br/>pip install google_spreadsheet google-auth-oauthlib</span></pre><h2 id="0dbf" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">Google 云平台和 Google Sheets API</h2><p id="af8c" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">因为我们需要启用作为谷歌云平台(GCP)一部分的谷歌工作表 API，首先我们需要激活 GCP。访问<a class="ae ky" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> GCP 控制台</a>页面，使用您的谷歌帐户登录，并接受条款以激活您的帐户。激活您的 GCP 帐户后，点击左侧菜单中的“API&amp;服务”,并选择 OAuth 同意屏幕。根据您的选择选择内部或外部，然后单击创建。输入应用程序名称并保存。我们需要创建凭证来使用 API。单击左侧菜单中的“凭据”，然后单击“创建凭据”并选择“OAuth 客户端 ID”。选择“桌面应用程序”作为应用程序类型，并输入应用程序的正确名称。当您按下创建按钮，它将显示客户端 ID 和客户端密码，我们将在稍后使用。单击 Credentials 页面中的 download 按钮，保存 JSON 文件。</p><h2 id="0817" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">获取 Google 工作表 ID</h2><p id="fe77" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们安装了所需的库并启用了 Google Sheets API。我们需要获得想要在 Python 代码中访问的 Google Sheet ID。在浏览器窗口中打开 Google Sheet，然后单击绿色的 share 按钮。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ln"><img src="../Images/3732087bec04e904d5fb53cd6e1c1916.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/1*evwriLtICIaPbkLsg22drA.png"/></div></div></figure><p id="6b32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将打开权限页面，根据您的需要更改权限以允许任何人查看或编辑链接。从生成的链接中复制工作表 ID，该链接在下图中突出显示(黄色)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lo"><img src="../Images/36f074ad817b51442e75ea2f4ef63e44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/1*5WXfsMs8ZvfGVts64UM9iA.png"/></div></figure><p id="352c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们完成了所有需要的步骤，现在我们可以开始编写 Python 代码了。</p><h2 id="6e52" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">使用 Python 阅读 Google Sheet</h2><p id="15b2" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">复制下面的代码，并相应地更新用户输入部分之间的代码。</p><pre class="je jf jg jh fd le lf lg lh aw li bi"><span id="79ee" class="jp jq hi lf b fi lj lk l ll lm">import os<br/>import sys<br/>import pickle<br/>import pandas as pd<br/>from __future__ import print_function<br/>from googleapiclient.discovery import build<br/>from google_auth_oauthlib.flow import InstalledAppFlow<br/>from google.auth.transport.requests import Request</span><span id="ac77" class="jp jq hi lf b fi lp lk l ll lm"># If modifying these scopes, delete the file token.pickle.<br/>SCOPES = ['<a class="ae ky" href="https://www.googleapis.com/auth/spreadsheets'" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/spreadsheets'</a>]</span><span id="2d44" class="jp jq hi lf b fi lp lk l ll lm"># Get the script path<br/>srcDir = os.path.abspath(os.path.dirname(sys.argv[0]))</span><span id="4691" class="jp jq hi lf b fi lp lk l ll lm">#### USER INPUT ####<br/>credentialFile = os.path.join(srcDir, 'credentials.json')<br/># The ID and range of a sample spreadsheet.<br/>sheetID = '1KuUE8Ifhh6HoOg_tXGIlc3_LcZyrHkTMBLvlFffqMTM'<br/>dataRange = 'Sheet1!A1:F31'<br/>#### END USER INPUT ####</span><span id="273e" class="jp jq hi lf b fi lp lk l ll lm">def Create_Service(client_secret_file, api_service_name, api_version, *scopes):<br/>    SCOPES = [scope for scope in scopes[0]]<br/>    print(SCOPES)<br/>    <br/>    cred = None<br/>    # The file token.pickle stores the user's access and refresh tokens, and is<br/>    # created automatically when the authorization flow completes for the first<br/>    # time.<br/>    if os.path.exists('token.pickle'):<br/>        with open('token.pickle', 'rb') as token:<br/>            cred = pickle.load(token)<br/>    # If there are no (valid) credentials available, let the user log in.<br/>    if not cred or not cred.valid:<br/>        if cred and cred.expired and cred.refresh_token:<br/>            cred.refresh(Request())<br/>        else:<br/>            flow = InstalledAppFlow.from_client_secrets_file(client_secret_file, SCOPES)<br/>            cred = flow.run_local_server()</span><span id="b888" class="jp jq hi lf b fi lp lk l ll lm">with open('token.pickle', 'wb') as token:<br/>            pickle.dump(cred, token)</span><span id="f57a" class="jp jq hi lf b fi lp lk l ll lm">try:<br/>        service = build(api_service_name, api_version, credentials=cred)<br/>        print(api_service_name, 'service created successfully')<br/>        return service<br/>    except Exception as e:<br/>        print(e)<br/>        return None</span><span id="734d" class="jp jq hi lf b fi lp lk l ll lm">def get_google_sheet_data():<br/>    """Shows basic usage of the Sheets API.<br/>    Retruns the Google Sheet data as Pandas DataFrame.<br/>    """<br/>    service = Create_Service(credentialFile, 'sheets', 'v4', SCOPES)</span><span id="5f25" class="jp jq hi lf b fi lp lk l ll lm"># Call the Sheets API<br/>    sheet = service.spreadsheets()<br/>    result = sheet.values().get(spreadsheetId=sheetID, range=dataRange).execute()<br/>    values = result.get('values', [])</span><span id="66d4" class="jp jq hi lf b fi lp lk l ll lm">if not values:<br/>        print('No data found.')<br/>        return None<br/>    else:<br/>        df=pd.DataFrame(values[1:], columns=values[0])<br/>        return df</span><span id="f101" class="jp jq hi lf b fi lp lk l ll lm">if __name__ == '__main__':<br/>    sheet_df = get_google_sheet_data()</span></pre><p id="b6e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的 python 环境中运行这段代码将从 Google 工作表中读取数据，并创建一个数据帧‘Sheet _ df’。我们可以用令人惊奇的熊猫数据框来分析这些数据。如果我们观察这个代码，我们在这个代码中所做的一切如下:</p><ol class=""><li id="2a7a" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc lq kv kw kx bi translated">导入必要的模块/库。</li><li id="2fd8" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc lq kv kw kx bi translated">定义范围，这将使我们只能读取或读/写工作表。</li><li id="36a0" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc lq kv kw kx bi translated">为要运行的代码定义用户输入，例如 Google Sheet API 凭证 JSON 文件、Google Sheet ID 和 Google Sheet 中的数据范围。</li><li id="0db5" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc lq kv kw kx bi translated">验证 Google API。当我们运行代码时,“Create_Service”功能将在浏览器中打开 Google 身份验证 URL，要求我们使用我们的帐户登录并接受权限。这些凭据保存在“token.pickle”文件中以供下次使用，该文件将在它们过期时更新。</li><li id="20e8" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc lq kv kw kx bi translated">调用 Google Sheet API 来读取所需的数据。</li><li id="a547" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc lq kv kw kx bi translated">创建熊猫数据帧，并将其返回供进一步分析。</li></ol><h2 id="4836" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">使用 Python 编写 Google Sheet</h2><p id="340b" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">为了写入 Google 工作表，首先我们需要通过更改共享首选项使工作表可编辑，并选择“编辑器”而不是“查看器”,然后复制工作表 ID。</p><p id="4d32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将以下代码添加到 python 文件中，并根据您的要求更新值。</p><pre class="je jf jg jh fd le lf lg lh aw li bi"><span id="5ad8" class="jp jq hi lf b fi lj lk l ll lm">def append_google_sheet_data(values, value_input_option):<br/>    body = {<br/>        'values': values<br/>    }<br/>    service = Create_Service(credentialFile, 'sheets', 'v4', SCOPES)</span><span id="d5aa" class="jp jq hi lf b fi lp lk l ll lm"># Call the Sheets API<br/>    sheet = service.spreadsheets()<br/>    result = sheet.values().append(spreadsheetId=sheetID, range=dataRange, valueInputOption=value_input_option, body=body).execute()<br/>    print('{0} cells appended.'.format(result \<br/>                                           .get('updates') \<br/>                                           .get('updatedCells')))</span><span id="d44a" class="jp jq hi lf b fi lp lk l ll lm">values = [<br/>    ["Name1", "Male", "4. Senior", "CA", "English", "Basketball"],<br/>    ["Name2", "Female", "3. Junior", "MA", "Math", "Baseball"],<br/>]<br/>append_google_sheet_data(values, "RAW")</span></pre><p id="5d21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">调用“append_google_sheet_data”函数会将值追加到工作表现有数据的末尾。请访问<a class="ae ky" href="https://developers.google.com/sheets/api/guides/values#python_4" rel="noopener ugc nofollow" target="_blank"> Google Sheet API 文档</a>了解更多选项。</p><h2 id="b175" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">参考资料:</h2><ul class=""><li id="f29a" class="kp kq hi ih b ii kk im kl iq lr iu ls iy lt jc ku kv kw kx bi translated"><a class="ae ky" href="https://developers.google.com/sheets/api/quickstart/python" rel="noopener ugc nofollow" target="_blank">谷歌工作表 API Python 快速入门</a></li><li id="3430" class="kp kq hi ih b ii kz im la iq lb iu lc iy ld jc ku kv kw kx bi translated"><a class="ae ky" href="https://learndataanalysis.org/create-a-function-to-construct-service-instance-for-google-api/" rel="noopener ugc nofollow" target="_blank">为 Google API 构建服务实例的函数</a></li></ul></div></div>    
</body>
</html>