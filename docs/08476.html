<html>
<head>
<title>How to read tfrecords files in PyTorch !</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在PyTorch中读取tfrecords文件！</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-read-tfrecords-files-in-pytorch-72763786743f?source=collection_archive---------3-----------------------#2020-07-31">https://medium.com/analytics-vidhya/how-to-read-tfrecords-files-in-pytorch-72763786743f?source=collection_archive---------3-----------------------#2020-07-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1ea0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一步</strong> →首先你需要知道你的数据内容是什么。为了便于理解，我将使用kaggle数据对104种花类 进行<a class="ae jd" href="https://www.kaggle.com/c/tpu-getting-started" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">分类。因此，有4个文件夹，每个文件夹有3个子文件夹，分别用于训练、验证和测试图像。因此，我将只使用培训和验证子文件夹。tfrec文件用于我们的演示。<strong class="ih hj">注</strong>:已给出每个。子文件夹中的tfrec fie包含<code class="du je jf jg jh b">id</code>、<code class="du je jf jg jh b">label</code>(样本的类别，用于训练&amp;验证数据)和<code class="du je jf jg jh b">img</code>(字节串格式的实际像素)。</strong></a></p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/1c03c3de18fa2c3811efafbd4642f57a.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*RIPm54ZiLvrtIhZDS-94dg.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">我们数据集的样本图片</figcaption></figure><p id="47b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第2步</strong> →我们将使用<strong class="ih hj"> glob </strong>库来获取文件，并在训练和验证子文件夹中使用它们的路径名</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="4f43" class="kc kd hi jh b fi ke kf l kg kh">import glob</span><span id="3e12" class="kc kd hi jh b fi ki kf l kg kh">train_files = glob.glob(‘/kaggle/input/tpu-getting-started/*/train/*.tfrec’)</span><span id="4996" class="kc kd hi jh b fi ki kf l kg kh">val_files = glob.glob(‘/kaggle/input/tpu-getting-started/*/val/*.tfrec’)</span></pre><p id="7246" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看在train_files变量中加载了什么</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="33ce" class="kc kd hi jh b fi ke kf l kg kh">print(train_files[:5])</span></pre><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es kj"><img src="../Images/9bead461c4b0daa0f7ec7ebd85e29ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mPsu06ETeMvr7sc4fJkD8Q.png"/></div></div></figure><p id="eafa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3 </strong> →现在，我们将在三个不同的列表变量中收集id、文件名和图像字节，用于训练&amp;验证文件。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="7336" class="kc kd hi jh b fi ke kf l kg kh"># importing tensorfow to read .tfrec files<br/>import tensorflow as tf</span></pre><p id="b7b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先导入tensorflow</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="4fdd" class="kc kd hi jh b fi ke kf l kg kh"># Create a dictionary describing the features.<br/>train_feature_description = {<br/>    'class': tf.io.FixedLenFeature([], tf.int64),<br/>    'id': tf.io.FixedLenFeature([], tf.string),<br/>    'image': tf.io.FixedLenFeature([], tf.string),<br/>}</span></pre><p id="3716" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们正在创建一个字典，描述字节字符串中的类、id和图像的特征。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="bbf6" class="kc kd hi jh b fi ke kf l kg kh">def _parse_image_function(example_proto):<br/> return tf.io.parse_single_example(example_proto, train_feature_description)</span></pre><p id="f374" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后创建一个函数来解析输入tf。使用字典的示例原型(<strong class="ih hj">train _ feature _ description</strong>)</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="fbf1" class="kc kd hi jh b fi ke kf l kg kh">train_ids = []<br/>train_class = []<br/>train_images = []</span><span id="929e" class="kc kd hi jh b fi ki kf l kg kh">for i in train_files:<br/>  train_image_dataset = tf.data.TFRecordDataset(i)</span><span id="a439" class="kc kd hi jh b fi ki kf l kg kh">train_image_dataset = train_image_dataset.map(_parse_image_function)</span><span id="4bd4" class="kc kd hi jh b fi ki kf l kg kh">ids = [str(id_features['id'].numpy())[2:-1] for id_features in train_image_dataset] # [2:-1] is done to remove b' from 1st and 'from last in train id names<br/>  train_ids = train_ids + ids</span><span id="aa2d" class="kc kd hi jh b fi ki kf l kg kh">classes = [int(class_features['class'].numpy()) for class_features in train_image_dataset]<br/>  train_class = train_class + classes</span><span id="6795" class="kc kd hi jh b fi ki kf l kg kh">images = [image_features['image'].numpy() for image_features in train_image_dataset]<br/>  train_images = train_images + images</span></pre><p id="c1a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，将特征存储在3个不同的列表中。为了方便起见，您也可以使用这些列表创建一个数据框架。<strong class="ih hj">注</strong> : [2:-1]用于删除列车id名称中第一个<strong class="ih hj"> b' </strong>和最后一个【T23 '。我们也可以为我们的验证做同样的事情。tfrec文件</p><p id="8f01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了测试，我们可以这样做。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="de20" class="kc kd hi jh b fi ke kf l kg kh">import IPython.display as display</span><span id="05b6" class="kc kd hi jh b fi ki kf l kg kh">display.display(display.Image(data=train_images[211]))</span></pre><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es ji"><img src="../Images/2460f5d01475c25aac86c5a71507aa6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*MEvA0uE_6jYd7pRquW3X5A.png"/></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">上述代码的输出</figcaption></figure><p id="19d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤4 </strong> →最后，我们将使用提取的特征创建pytorch数据集类，即train _ ids、train_class、train_images。</p><p id="be5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先做一些进口</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="e478" class="kc kd hi jh b fi ke kf l kg kh">from PIL import Image<br/>import cv2<br/>import albumentations<br/>import torch<br/>import numpy as np<br/>import io<br/>from torch.utils.data import Dataset</span></pre><p id="fac1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们使用albumentations库进行转换，然后定义我们的数据集类</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es kk"><img src="../Images/9c66ca4155a4a2212d15ace109e2a315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-D4r1WVJ8EdR28kbati3-Q.png"/></div></div></figure><p id="1129" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于空转测试，</p><p id="40f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为我们的FlowerDataset类创建对象→</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es kl"><img src="../Images/b01758df188fe1682b2098ae62253854.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GR4ac2oK6OZU_1qVWWlvUQ.png"/></div></div></figure><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es km"><img src="../Images/b02b12a070af6a0ddda1f26b3980bba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*Q-aOUXYZdYSwFnkZanO2jQ.png"/></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">以上代码的输出</figcaption></figure><p id="c060" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以将FlowerDataset的train_dataset &amp; val_dataset对象直接加载到pytorch数据加载器中。</p><p id="dd46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们阅读的方式。pytorch中的tfrec文件。让我知道你是否有任何问题，评论或意见。感谢阅读，并在此之前享受学习。</p></div></div>    
</body>
</html>