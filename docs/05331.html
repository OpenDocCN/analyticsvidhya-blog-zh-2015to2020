<html>
<head>
<title>Inserting an image in an excel file using pandas and SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用pandas和SQL在excel文件中插入图像</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/inserting-an-image-in-an-excel-file-using-pandas-and-sql-e88826680b05?source=collection_archive---------3-----------------------#2020-04-18">https://medium.com/analytics-vidhya/inserting-an-image-in-an-excel-file-using-pandas-and-sql-e88826680b05?source=collection_archive---------3-----------------------#2020-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="166c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将做以下事情:-</p><ul class=""><li id="43d5" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">通过对数据帧执行SQL查询来创建汇总表。</li><li id="45bc" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用<em class="jr"> matplotlib生成一个图。</em></li><li id="de8e" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">使用<em class="jr"> ExcelWriter </em>编写汇总表并将绘图插入excel文件</li></ul><p id="f250" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了达到以上几点，我将使用我以前的<a class="ae js" rel="noopener" href="/@songaraankit/exporting-a-data-frame-to-custom-formatted-excel-a82a35116e92">文章</a>中的数据集。</p><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/@songaraankit/exporting-a-data-frame-to-custom-formatted-excel-a82a35116e92"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">将数据框导出到自定义格式的Excel</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">介绍</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk kl jw"/></div></div></a></div></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><h2 id="4025" class="kt ku hi bd kv kw kx ky kz la lb lc ld iq le lf lg iu lh li lj iy lk ll lm ln bi translated">好的，让我们从导入必要的包开始:</h2><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="f869" class="kt ku hi lt b fi lx ly l lz ma">#importing necessary modules<br/>import sqlite3<br/>import pandas as pd<br/>import matplotlib.pyplot as plt<br/>%matplotlib inline<br/>from PIL import Image</span></pre><p id="10db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能对上面的包很熟悉。我使用sqlite3编写sql查询Pillow来调整绘图的大小。</p><h2 id="b09f" class="kt ku hi bd kv kw kx ky kz la lb lc ld iq le lf lg iu lh li lj iy lk ll lm ln bi translated">创建数据库:</h2><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="1133" class="kt ku hi lt b fi lx ly l lz ma">#Creating a data base with name df_Summary<br/>connection =  sqlite3.connect("df_Summary.db")</span></pre><p id="c9f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令将在<strong class="ih hj"><em class="jr">C:\ Users \ username</em></strong>位置创建一个<strong class="ih hj"><em class="jr">df _ summary . db</em></strong><em class="jr"/>文件。</p><p id="44d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将读取excel文件，并使用dataframe将内容存储到上面的df_summary.db文件中。与我在下面代码中所做的不同，您还可以直接将数据文件名和位置保存到一个变量中。使用<em class="jr"> read_excel() </em>方法将数据文件的内容导入到dataframe <em class="jr"> df中。</em>为了将数据从dataframe导入到df_Summary.db，我使用了<em class="jr"> to_sql() </em>方法。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="dff0" class="kt ku hi lt b fi lx ly l lz ma">loc = "Y:\\test\\"</span><span id="84e2" class="kt ku hi lt b fi mb ly l lz ma">df = pd.read_excel(loc+"test_Records_modified_2.xlsx")</span><span id="4f3e" class="kt ku hi lt b fi mb ly l lz ma">df.to_sql("df_Summary",con=connection)</span></pre><h2 id="c7f0" class="kt ku hi bd kv kw kx ky kz la lb lc ld iq le lf lg iu lh li lj iy lk ll lm ln bi translated">SQL查询:</h2><p id="484d" class="pw-post-body-paragraph if ig hi ih b ii mc ik il im md io ip iq me is it iu mf iw ix iy mg ja jb jc hb bi translated">现在，使用下面的命令，我们将从df_Summary中提取一些特定的信息。如果列名中没有空格，就没有必要将列名放在方括号中。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="3f3c" class="kt ku hi lt b fi lx ly l lz ma">df2= pd.read_sql_query("select <br/>[Card Type Code],<br/>[Card Type Full Name],<br/>count (*) as Accounts,<br/>sum(Balance) as Type_Balance<br/>from df_Summary<br/>group by 1;",connection)</span><span id="cafa" class="kt ku hi lt b fi mb ly l lz ma">connection.commit()<br/>connection.close()<br/>df3 = df2.dropna()</span></pre><p id="6c1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jr"> commit() </em>保存所有修改，而<em class="jr"> close() </em>将关闭与数据库的连接。<em class="jr"> dropna() </em>删除数据帧中所有缺失的值。</p><figure class="lo lp lq lr fd mi er es paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="er es mh"><img src="../Images/318aa82f2604baf0f79310059367db00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sY-4ygRgf6gT5HOH7Hy5tQ.png"/></div></div></figure><h2 id="f6dd" class="kt ku hi bd kv kw kx ky kz la lb lc ld iq le lf lg iu lh li lj iy lk ll lm ln bi translated">生成绘图:</h2><p id="9312" class="pw-post-body-paragraph if ig hi ih b ii mc ik il im md io ip iq me is it iu mf iw ix iy mg ja jb jc hb bi translated">这里，我们正在生成水平条形图，并将其保存为png图像。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="db8f" class="kt ku hi lt b fi lx ly l lz ma">plt.barh(df3["Card Type Full Name"],  df3["Type_Balance"], linewidth=2.0)</span><span id="dbde" class="kt ku hi lt b fi mb ly l lz ma">plt.ylabel("Banks")<br/>plt.xlabel("Accounts")<br/>plt.title("Money Density")</span><span id="d002" class="kt ku hi lt b fi mb ly l lz ma">plt.xticks(rotation =40)</span><span id="c8c9" class="kt ku hi lt b fi mb ly l lz ma">plt.savefig(loc+"Money Density.png",dpi=300, bbox_inches='tight')<br/>plt.show()</span></pre><figure class="lo lp lq lr fd mi er es paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="er es mo"><img src="../Images/cd5e992cebd96db3ad2b61b0a9e99f27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3y7bgteBuLH7auD__XoCOA.png"/></div></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">金钱Density.png</figcaption></figure></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><p id="faa3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到这里为止，我们已经有了所有想要放入excel文件的内容。现在，我们将使用<em class="jr"> ExcelWriter </em>创建一个新的excel文件，使用<em class="jr"> to_excel </em>在其中写入df3，并使用<em class="jr"> insert_image插入“Money Density.png”。</em></p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="690a" class="kt ku hi lt b fi lx ly l lz ma"><em class="jr">#Creating a new excel file "bank_summ.xlsx"</em><br/>writer_4 = pd.ExcelWriter(loc+"bank_summ.xlsx", engine= "xlsxwriter")</span><span id="82a2" class="kt ku hi lt b fi mb ly l lz ma"><em class="jr">#Writing df3 to writer_4. The name of the sheet of the workbook will be "Bank Summary"</em><br/>df3.to_excel(writer_4, index=False, sheet_name= "Bank Summary")</span><span id="fe9b" class="kt ku hi lt b fi mb ly l lz ma"><em class="jr">#Below command should be the last one. It physically saves the file.</em><br/>writer_4.save()</span></pre><figure class="lo lp lq lr fd mi er es paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="er es mt"><img src="../Images/76483851aa1caf35e85ac9cee28a78cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bh-x4w9m8nxcW-BFUlN4dQ.png"/></div></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">bank_summ.xlsx</figcaption></figure><p id="d279" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你看上面的文件，它看起来一点也不整洁，因为它目前还没有格式化。让我们稍微格式化一下，以改善数据的外观。您必须在没有writer_4.save()命令的情况下运行以上语句，然后运行以下命令。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="379e" class="kt ku hi lt b fi lx ly l lz ma">workbook_4 = writer_4.book<br/>worksheet_4 = writer_4.sheets["Bank Summary"]</span><span id="dada" class="kt ku hi lt b fi mb ly l lz ma"><em class="jr">#Defining formats and storing them in variables so that they can be used further in the code.</em></span><span id="f420" class="kt ku hi lt b fi mb ly l lz ma">fmt_currency = workbook_4.add_format({<br/>    "num_format" : "$#,##0.00" ,"bold" :False<br/>    })</span><span id="7bc9" class="kt ku hi lt b fi mb ly l lz ma">fmt_header = workbook_4.add_format({<br/>    'bold': True,<br/>    'text_wrap': True,<br/>    'valign': 'top',<br/>    'fg_color': '#093159',<br/>    'font_color': '#FFFFFF',<br/>    'border': 2})</span><span id="ebde" class="kt ku hi lt b fi mb ly l lz ma"><em class="jr">#Applying the above created formats on the excel file</em><br/>worksheet_4.set_column("A:D", 20)<br/>worksheet_4.set_column("D:D", 20, fmt_currency)<br/>for col , value in enumerate(df3.columns.values):<br/>    worksheet_4.write(0, col, value, fmt_header)</span></pre><p id="f063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，我们没有使用save()，因为我们仍然需要将绘图插入bank_summ.xlsx文件。我们将首先改变图像的尺寸。完全是可选的。在我的例子中，图像对于桌子来说太大了。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="8948" class="kt ku hi lt b fi lx ly l lz ma">#Changing dimensions a bit. <br/>img=Image.open(loc+"Money Density.png")<br/>new_img= img.resize((512,300))<br/>new_img.save(loc+"new_img.png")</span></pre><p id="dcb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后保存文件。</p><p id="2875" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">insert_image()的第一个参数是<em class="jr"> 1 </em>,它显示了您希望图形开始的行号。第二个参数是列号。df3.shape[1]将返回<em class="jr"> 4 </em>，因此第二个参数将变成<em class="jr"> 6 </em>。第三个是你想要插入的图片的名字。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="e90e" class="kt ku hi lt b fi lx ly l lz ma">worksheet_4.insert_image(1, df3.shape[1]+2, loc+"new_img.png")<br/>writer_4.save()</span></pre><figure class="lo lp lq lr fd mi er es paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="er es mt"><img src="../Images/7b2ae56b193ce099248f16a54598ff37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*reDto_Tf4RXbOmaPkcpKgA.png"/></div></div></figure></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><p id="5cc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是完整的代码:</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="e86e" class="kt ku hi lt b fi lx ly l lz ma">#importing necessary modules<br/>import sqlite3<br/>import pandas as pd<br/>import os<br/>import matplotlib.pyplot as plt<br/>%matplotlib inline<br/>from PIL import Image</span><span id="60b8" class="kt ku hi lt b fi mb ly l lz ma">#Creating a data base with name Summary<br/>connection =  sqlite3.connect("df_Summary.db")</span><span id="af54" class="kt ku hi lt b fi mb ly l lz ma">loc = "Y:\\test\\"</span><span id="9409" class="kt ku hi lt b fi mb ly l lz ma">df = pd.read_excel(loc+"test_Records_modified_2.xlsx")</span><span id="2bfa" class="kt ku hi lt b fi mb ly l lz ma">df.to_sql("df_Summary",con=connection)<br/>df2= pd.read_sql_query("select [Card Type Code], [Card Type Full Name],count (*) as Accounts, sum(Balance) as Type_Balance from df_Summary group by 1;",connection)</span><span id="41e1" class="kt ku hi lt b fi mb ly l lz ma">connection.commit()<br/>connection.close()</span><span id="cf7e" class="kt ku hi lt b fi mb ly l lz ma">plt.barh(df3["Card Type Full Name"],  df3["Type_Balance"], linewidth=2.0)</span><span id="1a95" class="kt ku hi lt b fi mb ly l lz ma">plt.ylabel("Banks")<br/>plt.xlabel("Accounts")<br/>plt.title("Money Density")</span><span id="f2c5" class="kt ku hi lt b fi mb ly l lz ma">plt.xticks(rotation =40)</span><span id="bdfc" class="kt ku hi lt b fi mb ly l lz ma">plt.savefig(loc+"Money Density.png",dpi=300, bbox_inches='tight')<br/>plt.show()</span><span id="4ec8" class="kt ku hi lt b fi mb ly l lz ma">writer_4 = pd.ExcelWriter(loc+"bank_summ.xlsx", engine= "xlsxwriter")<br/>df3.to_excel(writer_4, index=False, sheet_name= "Bank Summary")</span><span id="222f" class="kt ku hi lt b fi mb ly l lz ma">workbook_4 = writer_4.book<br/>worksheet_4 = writer_4.sheets["Bank Summary"]</span><span id="5481" class="kt ku hi lt b fi mb ly l lz ma">fmt_currency = workbook_4.add_format({<br/>    "num_format" : "$#,##0.00" ,"bold" :False<br/>    })</span><span id="ad0b" class="kt ku hi lt b fi mb ly l lz ma">fmt_header = workbook_4.add_format({<br/>    'bold': True,<br/>    'text_wrap': True,<br/>    'valign': 'top',<br/>    'fg_color': '#093159',<br/>    'font_color': '#FFFFFF',<br/>    'border': 2})</span><span id="278d" class="kt ku hi lt b fi mb ly l lz ma">img=Image.open(loc+"Money Density.png")<br/>new_img= img.resize((512,300))<br/>new_img.save(loc+"new_img.png")</span><span id="9061" class="kt ku hi lt b fi mb ly l lz ma">worksheet_4.insert_image(1, df3.shape[1]+2, loc+"new_img.png")<br/>writer_4.save()</span></pre><h1 id="777f" class="mu ku hi bd kv mv mw mx kz my mz na ld nb nc nd lg ne nf ng lj nh ni nj lm nk bi translated">谢谢！！</h1></div></div>    
</body>
</html>