<html>
<head>
<title>ML Model Interpretability : ELI5 &amp; Permutation Importance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ML模型的可解释性:ELI5和排列重要性</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/why-should-i-trust-your-model-bdda6be94c6f?source=collection_archive---------2-----------------------#2020-05-09">https://medium.com/analytics-vidhya/why-should-i-trust-your-model-bdda6be94c6f?source=collection_archive---------2-----------------------#2020-05-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="abb2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="6fb0" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">尽管被广泛采用，机器学习模型仍然主要是黑箱。理解为什么做出某些预测在评估信任时非常重要，如果一个人计划根据预测采取行动，这是非常重要的。这种理解还提供了对模型的深入了解，可用于将不可信的模型或预测转换为可信的模型或预测。<em class="kb">如果用户不信任该模型，他们将永远不会使用它</em>。</p><p id="e4f1" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">目前，使用可用验证数据集的准确性度量来评估模型。然而，真实世界的数据往往有很大的不同，评估指标可能并不代表产品的目标。除了这样的度量标准之外，检查单个预测及其解释是一个有价值的解决方案。</p><blockquote class="kh ki kj"><p id="5a2e" class="jd je kb jf b jg kc ji jj jk kd jm jn kk ke jq jr kl kf ju jv km kg jy jz ka hb bi translated">模型是嵌入数学中的观点——凯西·奥尼尔</p></blockquote><h1 id="c02d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">动机</strong></h1><p id="eb0e" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">当我开始使用不同的数据科学模型时，我经常问自己现实世界中的输出质量(不考虑准确性指标)。大多数情况下，作为数据科学家，你得到测试数据，你不知道数据中的偏差，但你会产生一个具有高精度指标的模型。机器学习模型用于各种行业，在这些行业中，数据偏差可能会导致非常有影响力的决策。</p><figure class="kn ko kp kq fd kr er es paragraph-image"><div class="ab fe cl ks"><img src="../Images/09c32f1a50f76d23fe9b6fbb70f5bdb1.png" data-original-src="https://miro.medium.com/v2/format:webp/1*vMV_FdR1yPAc-ktQrkH_hA.jpeg"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">数据科学家的生活对话</figcaption></figure><p id="f166" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">当您使用简单模型(线性或逻辑回归)时，可以解释样本数据集的结果。通常这些模型是不够的，我们最终使用深度学习模型，这些模型提供了高性能，但对大多数数据科学从业者来说是黑箱。机器学习模型现在被用于做出许多关键决策——<em class="kb">欺诈检测、信用评级、自动驾驶、检查病人等。</em></p><p id="482c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">有四个主要框架可以让我们深入了解模型预测</p><ol class=""><li id="3401" class="kz la hi jf b jg kc jk kd jo lb js lc jw ld ka le lf lg lh bi translated"><a class="ae li" href="https://github.com/TeamHG-Memex/eli5" rel="noopener ugc nofollow" target="_blank"> ELI5 </a></li><li id="e0a9" class="kz la hi jf b jg lj jk lk jo ll js lm jw ln ka le lf lg lh bi translated"><a class="ae li" href="https://github.com/marcotcr/lime" rel="noopener ugc nofollow" target="_blank">石灰</a></li><li id="1516" class="kz la hi jf b jg lj jk lk jo ll js lm jw ln ka le lf lg lh bi translated"><a class="ae li" href="https://github.com/oracle/Skater" rel="noopener ugc nofollow" target="_blank">溜冰者</a></li><li id="7393" class="kz la hi jf b jg lj jk lk jo ll js lm jw ln ka le lf lg lh bi translated"><a class="ae li" href="https://github.com/slundberg/shap" rel="noopener ugc nofollow" target="_blank"> SHAP </a></li></ol><h1 id="7c77" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">ELI5(解释为我5岁)&amp;排列重要性</h1><p id="e6bc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">ELI5是一个Python库，它允许使用统一的API来可视化和调试各种机器学习模型。它支持所有的scikit-learn算法。适合&amp;。预测方法)。它内置了对几个ML框架的支持，并提供了一种解释白盒模型(线性回归、决策树)和黑盒模型(Keras、XGBoost、LightGBM)的方法。它适用于回归和分类模型。</p><p id="fb61" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">查看分类或回归模型有两种主要方式:</p><ol class=""><li id="e996" class="kz la hi jf b jg kc jk kd jo lb js lc jw ld ka le lf lg lh bi translated">全局解释:检查模型参数，并试图弄清楚模型如何全局工作。</li><li id="bfc0" class="kz la hi jf b jg lj jk lk jo ll js lm jw ln ka le lf lg lh bi translated">局部解释:检查一个模型的单个预测，试图找出为什么模型会做出这样的决定。</li></ol><p id="2aa5" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">对于白盒模型，它支持全局和局部解释，对于黑盒模型，它只支持全局解释。</p><p id="5441" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">对于(1) ELI5提供了<code class="du lo lp lq lr b"><a class="ae li" href="https://eli5.readthedocs.io/en/latest/autodocs/eli5.html#eli5.show_weights" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">eli5.show_weights()</strong></a></code>功能；对于(2)它提供了<code class="du lo lp lq lr b"><a class="ae li" href="https://eli5.readthedocs.io/en/latest/autodocs/eli5.html#eli5.show_prediction" rel="noopener ugc nofollow" target="_blank"><strong class="jf hj">eli5.show_prediction()</strong></a></code>功能。</p><p id="f2ed" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">它还提供了格式器模块来生成模型解释的HTML、JSON和panda数据帧</p><h2 id="29a2" class="ls ig hi bd ih lt lu lv il lw lx ly ip jo lz ma it js mb mc ix jw md me jb mf bi translated">演示</h2><p id="aa78" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们将使用银行营销数据集— <a class="ae li" href="https://archive.ics.uci.edu/ml/datasets/bank+marketing" rel="noopener ugc nofollow" target="_blank"> LINK </a>。该数据与一家葡萄牙银行机构的直接营销活动相关。营销活动以电话为基础。通常，为了了解产品(银行定期存款)是否认购(“是”)或不认购(“否”)，需要与同一客户进行多次联系。</p><p id="8111" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在笔记本中，我解释了如何将ELI5与逻辑回归、决策树以及排列重要性概念结合使用</p><h2 id="1661" class="ls ig hi bd ih lt lu lv il lw lx ly ip jo lz ma it js mb mc ix jw md me jb mf bi translated">数据分析</h2><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="8c2c" class="ls ig hi lr b fi mk ml l mm mn">df = pd.read_csv("bank.csv")</span><span id="fb53" class="ls ig hi lr b fi mo ml l mm mn">df.head()</span></pre><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mp"><img src="../Images/556397de1f38f0d371641db4457d1ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ocDxqDwxyMAJjzMTJOtofw.png"/></div></div></figure><p id="8655" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我在笔记本上详细描述了运行不同算法所需的预处理步骤。</p><h2 id="6f3c" class="ls ig hi bd ih lt lu lv il lw lx ly ip jo lz ma it js mb mc ix jw md me jb mf bi translated">使用Eli5获得全局和局部特征的重要性</h2><h2 id="5246" class="ls ig hi bd ih lt lu lv il lw lx ly ip jo lz ma it js mb mc ix jw md me jb mf bi translated">1.逻辑回归</h2><p id="8ace" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在数据处理之后，我们可以使用GridSearch参数来训练我们的模型。</p><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="244e" class="ls ig hi lr b fi mk ml l mm mn"># Logistic Regression<br/>lr_model = LogisticRegression(class_weight="balanced",random_state=42)</span><span id="0dda" class="ls ig hi lr b fi mo ml l mm mn">gs = GridSearchCV(lr_model, {"C": [1., 1.3, 1.5]}, n_jobs=-1, cv=5, scoring="balanced_accuracy")<br/>gs.fit(X_train, y_train)</span></pre><p id="09ac" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们得到0.70的平衡准确度分数。没什么印象。现在，我们将使用ELI5来了解盒子内部，并了解它的工作原理。导入eli5并使用<code class="du lo lp lq lr b">show_weights</code>来可视化你的模型的重量(全局解释)。</p><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="d2a5" class="ls ig hi lr b fi mk ml l mm mn">import eli5</span><span id="abdb" class="ls ig hi lr b fi mo ml l mm mn">eli5.show_weights(lr_model, feature_names=all_features)</span></pre><figure class="kn ko kp kq fd kr er es paragraph-image"><div class="er es mu"><img src="../Images/69900e08ccf56e1878829b928b7fb5b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:762/format:webp/1*QSHj1CO4tSTZ25e-OuHCCg.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">分配给特征的权重描述</figcaption></figure><p id="e24b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">该表给出了与每个特性相关的权重(与逻辑回归给出的现成权重相同)。值告诉我们某个特征对预测的平均影响程度，符号告诉我们影响的方向。在这种情况下，如果营销活动在三月份进行，那么潜在客户订阅该计划的可能性就会大大增加。营销团队在三月份做了一些不同的事情吗？还是潜在客户更有可能在3月份订阅？这是一个要问营销团队的问题，取决于答案，这个发现可能有用，也可能没用。</p><p id="0e76" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">我们也可以用‘Eli 5’来解释一个特定的预测，让我们在测试数据中挑选一行(局部解释):</p><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="fa8a" class="ls ig hi lr b fi mk ml l mm mn">i = 4<br/>X_test.iloc[[i]]</span></pre><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mv"><img src="../Images/8ec252b1192bf09981a49c04036c8497.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iwTateS0uI3kto7phRQ2ig.png"/></div></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">客户的详细信息</figcaption></figure><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mw"><img src="../Images/ab11c83a460d2b34c0779d556765a7d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JCgkH_LKVsIDQFukcXVC8g.png"/></div></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">所选客户已订阅</figcaption></figure><p id="4238" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">活动结束后，我们的潜在客户认购了定期存款。让我们看看我们的模型会预测什么，以及我们如何向领域专家解释它。</p><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="cf2e" class="ls ig hi lr b fi mk ml l mm mn">eli5.show_prediction(lr_model, X_test.iloc[i], feature_names=all_features, show_feature_values=True)</span></pre><figure class="kn ko kp kq fd kr er es paragraph-image"><div class="er es mx"><img src="../Images/b6e533cb1da100f1dbf3b4e4f6b445b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*gGZd_zDHw5g3u5pQUBHnng.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">每个特征对预测的贡献。</figcaption></figure><p id="c343" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">对于这个预测，看起来最重要的因素是通过电话联系了潜在客户(<code class="du lo lp lq lr b">contact__cellular</code> ==1)，并且没有违约(<code class="du lo lp lq lr b">default__no</code> ==1)。这些信息可以与领域专家共享，以理解为什么这些特性很重要。贡献是权重*列值。</p><p id="69b2" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">2 <strong class="jf hj">。决策树</strong></p><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="e888" class="ls ig hi lr b fi mk ml l mm mn">dt_model = DecisionTreeClassifier(class_weight="balanced")</span><span id="cf34" class="ls ig hi lr b fi mo ml l mm mn">eli5.show_weights(dt_model, feature_names=all_features )</span></pre><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es my"><img src="../Images/e77dacc281d467b6fe46901fb69316e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OVovFNQW41yaG-MFhlEYYQ.png"/></div></div></figure><p id="314a" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">与逻辑回归相比，这种解释价值较低。它只是给出了特征重要性，只是给了我这些特征相对于彼此有多重要的幅度，而不是方向。没有红色的值。“pdays”似乎是一个重要的功能，但我不知道减少或增加它会对模型产生什么影响。</p><p id="751c" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">通常，对于基于树的模型，ELI5不做任何特殊处理，而是使用我们在上一节中讨论的现成的特性重要性计算方法。默认情况下，使用“增益”，这是该功能在树中使用时的平均增益。</p><p id="d522" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj"> ELI5排列模型</strong></p><p id="a67f" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">置换模型是理解黑盒模型的一种方式。它只适用于全局解释。作为输出，它给出的权重值类似于默认情况下通过算法获得的要素重要性，这显示了要素之间的相对重要性。</p><p id="58ba" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated"><strong class="jf hj">概念</strong></p><p id="d700" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">对于每个功能:</p><ol class=""><li id="32da" class="kz la hi jf b jg kc jk kd jo lb js lc jw ld ka le lf lg lh bi translated">打乱所提供数据集中的值</li><li id="8c83" class="kz la hi jf b jg lj jk lk jo ll js lm jw ln ka le lf lg lh bi translated">使用修改后数据集上的模型生成预测</li><li id="1d60" class="kz la hi jf b jg lj jk lk jo ll js lm jw ln ka le lf lg lh bi translated">计算与洗牌前相比准确度的下降</li></ol><p id="f3b5" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">比较单独随机播放每个特征对准确性的影响。</p><p id="6959" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果打乱某个特征的值会增加模型误差，则该特征是“重要的”，因为在这种情况下，模型依赖于该特征进行预测。如果对某个特征的值进行调整后模型误差保持不变，则该特征“不重要”，因为在这种情况下，模型会忽略该特征进行预测。</p><pre class="kn ko kp kq fd mg lr mh mi aw mj bi"><span id="095b" class="ls ig hi lr b fi mk ml l mm mn">from eli5.sklearn import PermutationImportance</span><span id="0093" class="ls ig hi lr b fi mo ml l mm mn">perm = PermutationImportance(dt_model, scoring="balanced_accuracy")</span><span id="97b6" class="ls ig hi lr b fi mo ml l mm mn">perm.fit(X_test, y_test)</span><span id="ae22" class="ls ig hi lr b fi mo ml l mm mn">eli5.show_weights(perm, feature_names=all_features)</span></pre><p id="6ca7" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在上面的代码中，我们创建了一个新的<code class="du lo lp lq lr b">PermutationImportance</code>实例，它采用我们训练好的模型来解释和评分方法。使用<code class="du lo lp lq lr b">eli5</code>的<code class="du lo lp lq lr b">show_weigths</code>调用排列重要对象&amp;上的<code class="du lo lp lq lr b">fit</code>。这将绘制新功能的重要性:</p><figure class="kn ko kp kq fd kr er es paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="er es mz"><img src="../Images/1a68accc3c0f295441a14a7e3713bbd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qz3_L5NYu9sUaZaV9ky1Xg.png"/></div></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">特征重要性</figcaption></figure><p id="0451" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">它将洗牌的次数，并作为输出平均重要性和标准差。它没有给出特征影响模型的方向，只是显示了特征的幅度。当你在新数据上使用你的模型来预测某人是否会同意你的计划时，最重要的是你是否通过电话联系了那个人。你不是在看模型在学习时最重视什么，而是从现在开始，它将如何根据所学的知识来重视特性。</p><p id="c7b4" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">尽管所有模型都提供了自己的方法来计算权重或特性重要性，但ELI5提供了一个统一的API来访问特性重要性信息。这使得比较模型变得有点容易</p><p id="a23b" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">ELI5为XGBoost和大多数scikit-learn树集成提供了该算法的独立实现，这无疑是朝着模型不可知解释的方向发展，但不像LIME那样纯粹是模型不可知的。</p><p id="19ed" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">本文使用的代码可以在<a class="ae li" href="https://github.com/mayur29/Machine-Learning-Model-Interpretation" rel="noopener ugc nofollow" target="_blank"> <strong class="jf hj"> my GitHub </strong> </a>上获得。</p><p id="7ef0" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">在以后的系列文章中，我将介绍模型解释技术。</p><p id="44b9" class="pw-post-body-paragraph jd je hi jf b jg kc ji jj jk kd jm jn jo ke jq jr js kf ju jv jw kg jy jz ka hb bi translated">如果你对ELI5有任何问题，请告诉我，我很乐意帮忙。如果你想收到我的博客更新，请在<a class="ae li" rel="noopener" href="/@sand.mayur"> Medium </a>或<a class="ae li" href="https://www.linkedin.com/in/mayursand/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上关注我！</p></div></div>    
</body>
</html>