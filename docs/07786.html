<html>
<head>
<title>Intro to Multiprocessing on Python from a guy with almost 12 months of rock hard technical training.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自一个受过近12个月艰苦技术培训的人的Python多处理介绍。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/intro-to-multiprocessing-on-python-from-a-guy-with-almost-12-months-of-rock-hard-technical-training-d57f374e9529?source=collection_archive---------16-----------------------#2020-07-07">https://medium.com/analytics-vidhya/intro-to-multiprocessing-on-python-from-a-guy-with-almost-12-months-of-rock-hard-technical-training-d57f374e9529?source=collection_archive---------16-----------------------#2020-07-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d3c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你好，谢谢你阅读我的第一篇文章。在本教程中，我将介绍一些多重处理的方法，并重点介绍我遇到的一些用例。</p><p id="9bc8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们希望从各种来源收集和清理数据，我们可以按顺序完成所有的任务，或者我们可以同时运行它们。实际上，你应该问自己这个问题，你是愿意一个接一个地吃小熊软糖让你的手疲劳，还是愿意把整包软糖塞进你的嘴里，让你无用的下巴来完成这项工作？</p><p id="a387" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，您需要使用pip安装多处理包</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="82ac" class="jm jn hi ji b fi jo jp l jq jr">pip install multiprocessing</span></pre><p id="b2ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">开个玩笑</strong>它附带了自<strong class="ih hj"> python 2.6 </strong>以来的所有Python标准版本。</p><p id="87b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以只需导入我们将要使用的函数。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b2b8" class="jm jn hi ji b fi jo jp l jq jr">from multiprocessing import Process, Pool, Manager, Queue</span></pre><p id="4117" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，让我们编写一个虚拟函数来演示如何使用多处理中的一些基本功能。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="9888" class="jm jn hi ji b fi jo jp l jq jr">def doComplexCalculation (num) :<br/>    otherNum = 9</span><span id="ba40" class="jm jn hi ji b fi js jp l jq jr">    if num == 10 :<br/>      return 21<br/>  <br/>    return num + otherNum</span></pre><p id="6180" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们需要多次执行doComplexCalculation，我们总是可以创建一个工人池来执行任务。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="776c" class="jm jn hi ji b fi jo jp l jq jr">pool = Pool(5)</span><span id="7684" class="jm jn hi ji b fi js jp l jq jr">result = pool.map(doComplexCalculation, [25, 42, 69])</span><span id="d730" class="jm jn hi ji b fi js jp l jq jr">print (result)</span><span id="9d6c" class="jm jn hi ji b fi js jp l jq jr">// [34, 51, 78]</span></pre><p id="0416" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">够简单吧？如果你的函数需要特殊的关键字参数呢？</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a875" class="jm jn hi ji b fi jo jp l jq jr">def doEvenMoreComplexStuff (num, isMutable=False, isDirty=True) :</span><span id="cda8" class="jm jn hi ji b fi js jp l jq jr">    otherNum = 9</span><span id="aa8c" class="jm jn hi ji b fi js jp l jq jr">    if isMutable == True :</span><span id="0f56" class="jm jn hi ji b fi js jp l jq jr">        otherNum += 6</span><span id="c786" class="jm jn hi ji b fi js jp l jq jr">    if isDirty == False :</span><span id="d0d5" class="jm jn hi ji b fi js jp l jq jr">        num += 6</span><span id="b442" class="jm jn hi ji b fi js jp l jq jr">    return num + otherNum</span></pre><p id="193d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，更直接的方法是生成一个流程对象，并伪同时运行这些对象。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="dab2" class="jm jn hi ji b fi jo jp l jq jr">processes = []</span><span id="7f15" class="jm jn hi ji b fi js jp l jq jr">nums = [25, 42, 69]<br/></span><span id="8af9" class="jm jn hi ji b fi js jp l jq jr">for i in range(3):</span><span id="3eec" class="jm jn hi ji b fi js jp l jq jr">    p = Process(</span><span id="5ab4" class="jm jn hi ji b fi js jp l jq jr">        target=doEvenMoreComplexStuff,</span><span id="fd14" class="jm jn hi ji b fi js jp l jq jr">        kwargs={"isMutable":True, "isDirty":False, "num":nums[i]},</span><span id="41e9" class="jm jn hi ji b fi js jp l jq jr">    )</span><span id="ea11" class="jm jn hi ji b fi js jp l jq jr">    processes.append(p)</span><span id="d4bb" class="jm jn hi ji b fi js jp l jq jr">for p in processes :</span><span id="1e26" class="jm jn hi ji b fi js jp l jq jr">    p.start()</span><span id="8b37" class="jm jn hi ji b fi js jp l jq jr">for p in processes :</span><span id="d307" class="jm jn hi ji b fi js jp l jq jr">    p.join()</span></pre><p id="264c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我现在要分解代码，让你可爱的小脑袋明白。第一段代码生成一个流程对象，并将一个函数与其所需参数进行映射。请注意，在声明目标时，避免在函数末尾添加“()”，因为这将告诉Python在该行执行所述函数。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b840" class="jm jn hi ji b fi jo jp l jq jr">p = Process(</span><span id="073d" class="jm jn hi ji b fi js jp l jq jr">    target=doEvenMoreComplexStuff,</span><span id="7839" class="jm jn hi ji b fi js jp l jq jr">    kwargs={"isMutable":True, "isDirty":False, "num":nums[i]},</span><span id="2d52" class="jm jn hi ji b fi js jp l jq jr">)</span></pre><p id="0a8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">的方法。start()基本上是“启动”进程。鉴于。join()确保您已经启动的这些进程在其余主代码执行之前完成。我们把start和join方法分开，就好像它们在同一个for循环中执行一样，你的解释器只是在开始下一个进程之前等待前一个进程的加入，这实质上违背了多重处理的目的。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1c6b" class="jm jn hi ji b fi jo jp l jq jr">for p in processes :</span><span id="f522" class="jm jn hi ji b fi js jp l jq jr">    p.start()</span><span id="bc8f" class="jm jn hi ji b fi js jp l jq jr">for p in processes :</span><span id="31af" class="jm jn hi ji b fi js jp l jq jr">    p.join()</span></pre><p id="87f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，精明的读者(或者那些真正阅读整篇文章的怪人)可能会意识到，您无法从这些函数中检索返回值。你完全正确！</p><p id="1ec3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能会想，您可以将字典或列表传递给变量来存储值。但是，这些函数是在与主函数分开的内存块中执行的，因此您无法使用普通的字典和列表来检索返回值。相反，您需要使用Manager和Queue类。</p><p id="39da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您对结果的返回顺序不太感兴趣时，可以使用队列。队列也比管理器类需要更少的计算能力。</p><p id="caf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您对对象的返回顺序感兴趣时，可以使用管理器类。例如，如果您需要将文件上传到S3存储桶中，这将非常有用。我个人使用dict函数，但也可以在Manager类中随意尝试其他函数。</p><p id="179f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，管理器类本身需要一个处理核心，所以要考虑到这一点，而队列不需要。</p><p id="a2e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要实现Manager.dict()或Queue，我们需要在函数中添加一个关键字参数。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="6112" class="jm jn hi ji b fi jo jp l jq jr">## Implementation of a Manager.dict()<br/>def doComplexCalculation (num, queue=None) :<br/>    otherNum = 9</span><span id="a707" class="jm jn hi ji b fi js jp l jq jr">    if num == 10 :<br/>        return 21</span><span id="4139" class="jm jn hi ji b fi js jp l jq jr">    if queue != None :<br/>        queue['complexCalculation'] = num + otherNum<br/>   <br/>    return num + otherNum</span><span id="15f3" class="jm jn hi ji b fi js jp l jq jr">## Implementation of a Queue<br/>def doComplexCalculation (num, queue=None) :<br/>    otherNum = 9</span><span id="0d8a" class="jm jn hi ji b fi js jp l jq jr">    if num == 10 :<br/>        return 21</span><span id="0a8b" class="jm jn hi ji b fi js jp l jq jr">    if queue != None :<br/>        queue.put( num + otherNum )<br/>   <br/>    return num + otherNum</span></pre><p id="674e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在把所有这些放在一起。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="35e9" class="jm jn hi ji b fi jo jp l jq jr">from multiprocessing import Process, Manager</span><span id="aa6e" class="jm jn hi ji b fi js jp l jq jr">## Implementation of a Manager.dict()</span><span id="1bda" class="jm jn hi ji b fi js jp l jq jr">def doComplexCalculation (num, queue=None) :<br/>    otherNum = 9</span><span id="4223" class="jm jn hi ji b fi js jp l jq jr">    if num == 10 :<br/>        result = 21</span><span id="2de5" class="jm jn hi ji b fi js jp l jq jr">    else :<br/>        result = num + otherNum</span><span id="2faf" class="jm jn hi ji b fi js jp l jq jr">    if queue != None :<br/>        queue[f'complexCalculation for {num}'] = result</span><span id="1bf9" class="jm jn hi ji b fi js jp l jq jr">    return result</span><span id="00be" class="jm jn hi ji b fi js jp l jq jr">q = Manager().dict()</span><span id="b836" class="jm jn hi ji b fi js jp l jq jr">processes = []</span><span id="0559" class="jm jn hi ji b fi js jp l jq jr">process1 = Process(target=doComplexCalculation, kwargs={'num': 42, 'queue': q})<br/>process2 = Process(target=doComplexCalculation, kwargs={'num': 69, 'queue': q})<br/>process3 = Process(target=doComplexCalculation, kwargs={'num': 10, 'queue': q})</span><span id="9b13" class="jm jn hi ji b fi js jp l jq jr">processes.append(process1)<br/>processes.append(process2)<br/>processes.append(process3)</span><span id="931c" class="jm jn hi ji b fi js jp l jq jr">for p in processes :<br/>    p.start()</span><span id="41ca" class="jm jn hi ji b fi js jp l jq jr">for p in processes :<br/>    p.join()</span><span id="43e1" class="jm jn hi ji b fi js jp l jq jr">print (q)</span><span id="1b8e" class="jm jn hi ji b fi js jp l jq jr">"""<br/>{'complexCalculation for 42': 51, 'complexCalculation for 69': 78, 'complexCalculation for 10': 21}<br/>"""</span></pre><p id="d049" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">她就写了这么多！</p></div></div>    
</body>
</html>