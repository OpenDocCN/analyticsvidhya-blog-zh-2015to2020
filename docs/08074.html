<html>
<head>
<title>One way to utilize Lambda, CodeDeploy, S3 For your continuous deployment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Lambda、CodeDeploy、S3进行持续部署的一种方式</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/one-way-to-utilize-lambda-codedeploy-s3-for-your-continuous-development-eac845b0b5bb?source=collection_archive---------20-----------------------#2020-07-16">https://medium.com/analytics-vidhya/one-way-to-utilize-lambda-codedeploy-s3-for-your-continuous-development-eac845b0b5bb?source=collection_archive---------20-----------------------#2020-07-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/36a847f985856aae4857783944b33a9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lAASONnSkzzSehFGrHm0nQ.jpeg"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="8638" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这是一个简单的持续部署过程，根据您使用以下AWS工具上传到S3 bucket的目录，在所需的环境中触发部署</p><ul class=""><li id="9309" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">云的形成</li><li id="3320" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">代码部署</li><li id="85ec" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">萨姆·拉姆达</li><li id="754f" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">S3</li></ul><p id="9a71" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我也不会把Slack (SNS，Lambda，Slack配置)因为会有另一个职位</p><p id="5523" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">还要注意，这是利用代码部署，所以你必须按照官方<a class="ae kj" href="https://docs.aws.amazon.com/codedeploy/latest/userguide/application-revisions.html" rel="noopener ugc nofollow" target="_blank">文档</a>上传修订版</p></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="4274" class="kk kl hi bd km kn ko kp kq kr ks kt ku ji kv kw kx jm ky kz la jq lb lc ld le bi translated">创建AWS代码部署堆栈:</h2><ul class=""><li id="fe46" class="jv jw hi iz b ja lf je lg ji lh jm li jq lj ju ka kb kc kd bi translated">AWS CodeDeploy第一块是应用程序，每个应用程序都包含DeploymentGroup(一种模式是让每个组部署在特定的环境中，比如一个用于开发，一个用于试运行…。等等)</li><li id="b149" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">首先，创建<a class="ae kj" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codedeploy-application.html" rel="noopener ugc nofollow" target="_blank">应用程序</a></li><li id="f58c" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">然后创建<a class="ae kj" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codedeploy-deploymentgroup.html" rel="noopener ugc nofollow" target="_blank">部署组</a></li></ul></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><h2 id="72ff" class="kk kl hi bd km kn ko kp kq kr ks kt ku ji kv kw kx jm ky kz la jq lb lc ld le bi translated">创建部署Lambda:</h2><ul class=""><li id="cf41" class="jv jw hi iz b ja lf je lg ji lh jm li jq lj ju ka kb kc kd bi translated">你可以选择你喜欢的方式来创建lambda，但是在下面的例子中，我使用的是AWS <a class="ae kj" href="https://github.com/awslabs/aws-sam-cli" rel="noopener ugc nofollow" target="_blank"> SAM </a></li><li id="7947" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">如果您使用SAM，您将有一个空项目，因此这里是将创建Lambda、S3存储桶和Lambda将使用的IAM角色的模板</li><li id="ecce" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">我指的是模板中的slack SNS，我用它来调用另一个lambda向它发送通知，然后发送给slack</li></ul><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="aa77" class="kk kl hi lp b fi lt lu l lv lw">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/>Description: &gt;<br/>  deployment_lambda</span><span id="7549" class="kk kl hi lp b fi lx lu l lv lw">Sam template for lambda invoked by uploading inc to s3 bucket</span><span id="5234" class="kk kl hi lp b fi lx lu l lv lw">Parameters:<br/>  BucketNameParam:<br/>    Description: deployment bucket name paramter<br/>    Type: String<br/>    Default: &lt;NAME OF THE BUCKET&gt;<br/>Globals:<br/>  Function:<br/>    Timeout: 15<br/>    MemorySize: 128<br/>    Runtime: python3.7</span><span id="5a29" class="kk kl hi lp b fi lx lu l lv lw">Resources:<br/>  DeploymentIamRole:<br/>    Type: AWS::IAM::Role<br/>    Properties:<br/>      RoleName: File_Basic_Role<br/>      AssumeRolePolicyDocument:<br/>        Version: '2012-10-17'<br/>        Statement:<br/>        - Effect: Allow<br/>          Principal:<br/>            Service:<br/>            - lambda.amazonaws.com<br/>          Action:<br/>          - sts:AssumeRole<br/>      Path: "/"<br/>      ManagedPolicyArns:<br/>      - arn:aws:iam::aws:policy/AWSCodeDeployDeployerAccess<br/>      - &lt;SNS PUBLISH ROLE ARN&gt;<br/>      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole<br/>      - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole<br/>  S3DeploymentsBucket:<br/>    Type: AWS::S3::Bucket<br/>    DeletionPolicy: Delete<br/>    Properties:<br/>      BucketName: !Ref BucketNameParam<br/>  DevelopmentDeployer:<br/>    Type: AWS::Serverless::Function <br/>    Properties:<br/>      FunctionName: deployment_Lambda<br/>      CodeUri: lambda/<br/>      Handler: deployment.lambda_handler<br/>      Role:<br/>        Fn::GetAtt:<br/>        - DeploymentIamRole<br/>        - Arn<br/>      Environment: <br/>        Variables:<br/>          TOPIC: !ImportValue &lt;SNS TO SLACK TOPIC&gt;<br/>          BUCKET: !Ref BucketNameParam<br/>      Events:<br/>        EventDeployer:<br/>          Type: S3<br/>          Properties:<br/>            Bucket: !Ref S3DeploymentsBucket<br/>            Events: s3:ObjectCreated:*<br/>            Filter:<br/>              S3Key:<br/>                Rules:<br/>                  - Name: prefix<br/>                    Value: deployments</span></pre><ul class=""><li id="b823" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">您必须在SAM和LAMBDA指南中提到的相同模板中创建s3存储桶</li><li id="fcc8" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">正如你在lambda函数的events部分看到的，我使用了在path上创建的S3:object</li><li id="251a" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">此外，路径是在上传bucket中的第一个文件时创建的。本<a class="ae kj" href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/using-folders.html" rel="noopener ugc nofollow" target="_blank">指南</a>可以解释s3 bucket中的路径是如何工作的</li><li id="bcde" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">我对s3铲斗解剖的想法是这样的</li></ul><figure class="lk ll lm ln fd ij er es paragraph-image"><div class="er es ly"><img src="../Images/b9bc055da241cd380977bac855ac0b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*OYcUke50ysR87m9b-73DvQ.jpeg"/></div><figcaption class="lz ma et er es mb mc bd b be z dx translated">S3桶解剖</figcaption></figure><ul class=""><li id="62dd" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">所以我使用子目录来决定我应该部署到哪个env换句话说，当我上传到部署/测试时，测试代码部署部署组将被触发</li><li id="59af" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">发送给lambda的事件对象如下所示</li></ul><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="b732" class="kk kl hi lp b fi lt lu l lv lw">{<br/>   "Records": [<br/>      {<br/>         "eventVersion": "2.1",<br/>         "eventSource": "aws:s3",<br/>         "awsRegion": "",<br/>         "eventTime": "",<br/>         "eventName": "ObjectCreated:Put",<br/>         "userIdentity": {<br/>            "principalId": ""<br/>         },<br/>         "requestParameters": {<br/>            "sourceIPAddress": ""<br/>         },<br/>         "responseElements": {<br/>            "x-amz-request-id": "",<br/>            "x-amz-id-2": ""<br/>         },<br/>         "s3": {<br/>            "s3SchemaVersion": "1.0",<br/>            "configurationId": "",<br/>            "bucket": {<br/>               "name": "some-bucket",<br/>               "ownerIdentity": {<br/>                  "principalId": ""<br/>               },<br/>               "arn": "arn:aws:s3:::some-bucket"<br/>            },<br/>            "object": {<br/>               "key": "deployments/development/file.zip",<br/>               "size": 0000,<br/>               "eTag": "",<br/>               "sequencer": ""<br/>            }<br/>         }<br/>      }<br/>   ]<br/>}</span></pre><ul class=""><li id="bd19" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">我利用了事件包含一些关于上传对象的信息这一事实来在我的lambda中使用它(检查object下的键)</li><li id="bece" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">所以lambda代码应该是这样的</li></ul><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="4d86" class="kk kl hi lp b fi lt lu l lv lw">def lambda_handler(event, context):<br/>    deployment_env = event['Records'][0]['s3']['object']['key'].split('/')[1].strip() <br/>    response = deployment_creator(deployment_env)<br/>    message = "this is the deployment start response: " + response <br/>    slacker(message, 'deployments')</span></pre><ul class=""><li id="e8f7" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">因此，根据上面的事件，deployment_env值应该是“development ”,这个值将定义它应该运行哪个部署组(感谢<a class="ae kj" href="https://www.linkedin.com/in/sayedomar/" rel="noopener ugc nofollow" target="_blank"> Sayed </a>帮助我进行对象导航)</li><li id="9702" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">deployment_creator函数如下所示</li></ul><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="2b3a" class="kk kl hi lp b fi lt lu l lv lw">def deployment_creator(deployment_env):<br/>    client = boto3.client('codedeploy')<br/>    response = client.create_deployment(<br/>    applicationName=&lt;YOUR APPLICATION NAME&gt;,<br/>    deploymentGroupName='prefix_' + deployment_env + '_suffix', <br/>    revision={<br/>        'revisionType': 'S3',<br/>        's3Location': {<br/>            'bucket': os.environ['BUCKET'],<br/>            'key': 'deployments/' + deployment_env + '/&lt;FILE NAME&gt;',<br/>            'bundleType': 'zip'<br/>        }<br/>    },<br/>    description='deployment triggered from s3 upload for file',<br/>    ignoreApplicationStopFailures=True,<br/>    targetInstances={<br/>        'tagFilters': [<br/>            {<br/>                'Key': 'deployment_environment',<br/>                'Value': deployment_env,<br/>                'Type': 'KEY_AND_VALUE'<br/>            },<br/>        ]<br/>    },<br/>    autoRollbackConfiguration={<br/>        'enabled': True,<br/>        'events': [<br/>            'DEPLOYMENT_FAILURE',<br/>        ]<br/>    },<br/>    updateOutdatedInstancesOnly=False,<br/>    fileExistsBehavior='OVERWRITE'<br/>    )<br/>    return response['deploymentId']</span></pre><ul class=""><li id="d8f1" class="jv jw hi iz b ja jb je jf ji jx jm jy jq jz ju ka kb kc kd bi translated">请注意，DeploymentGroupName被设置为“' ' prefix _ '+deployment _ env+' _ suffix ' '”，因此最终结果将是prefix _ development _ suffix<strong class="iz hj"><em class="md">，如果在基于我们上传到部署组的文件夹的事件中更改了键，则该键将根据进行更改，并将更改我们部署到</em> </strong>的服务器</li><li id="464f" class="jv jw hi iz b ja ke je kf ji kg jm kh jq ki ju ka kb kc kd bi translated">为了简单起见，我在上面的模板中将bucket名称定义为env变量，所以我只能在模板中的一个地方更改它，它将在任何地方反映出来</li></ul></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="8a98" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">希望我已经帮助你解决了你的问题，当然也欢迎所有的建议；)</p></div></div>    
</body>
</html>