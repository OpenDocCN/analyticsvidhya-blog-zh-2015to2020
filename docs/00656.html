<html>
<head>
<title>Generating masks from Encoded Pixels — Semantic Segmentation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从编码像素生成遮罩—语义分割</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/generating-masks-from-encoded-pixels-semantic-segmentation-18635e834ad0?source=collection_archive---------2-----------------------#2019-08-23">https://medium.com/analytics-vidhya/generating-masks-from-encoded-pixels-semantic-segmentation-18635e834ad0?source=collection_archive---------2-----------------------#2019-08-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="565e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于分割任务，有时我们会遇到csv文件中列出的遮罩编码像素，而不是遮罩图像。</p><p id="0fdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，让我们了解如何生成遮罩，如果编码像素而不是遮罩图像。</p><p id="6477" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在severstal-steel-defect-detection ka ggle竞赛中，<a class="ae jd" href="https://www.kaggle.com/c/severstal-steel-defect-detection/data" rel="noopener ugc nofollow" target="_blank">https://www . ka ggle . com/c/severstal-steel-defect-detection/data</a>我们得到的不是掩模图像，而是具有EncodedPixels列的train.csv文件。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/8ac44df05008ddcb8fff0c33b5913ec2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJZHVOqbh8o_CKEPTDvVWQ.png"/></div></div></figure><p id="8329" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您仔细观察EncoderPixels列，它看起来有些不同。让我们深入了解如何使用这些信息来生成蒙版图像。</p><p id="f492" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们举一个例子，</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="e944" class="jv jw hi jr b fi jx jy l jz ka">This is how each EncodedPixels column values are</span><span id="bfa9" class="jv jw hi jr b fi kb jy l jz ka">['29102 12 29346 24 29602 24 29858 24 30114 24 30370 24 30626 24 30882 24 31139 23 31395 23 31651 23 31907 23 32163 23 32419 23 32675 23 77918 27 78174 55 78429 60 78685 64 78941 68 79197 72 79452 77 79708 81 79964 85 80220 89 80475 94 80731 98 80987 102 81242 105 81498 105 81754 104 82010 104 82265 105 82521 31 82556 69 82779 27 82818 63 83038 22 83080 57 83297 17 83342 50 83555 13 83604 44 83814 8 83866 37 84073 3 84128 31 84390 25 84652 18 84918 8 85239 10 85476 29 85714 47 85960 57 86216 57 86471 58 86727 58 86983 58 87238 59 87494 59 87750 59 88005 60 88261 60 88517 60 88772 61 89028 53 89283 40 89539 32 89667 10 89795 30 89923 28 90050 29 90179 37 90306 27 90434 38 90562 14 90690 38 90817 9 90946 38 91073 3 91202 38 91458 38 91714 38 91969 39 92225 39 92481 39 92737 39 92993 39 93248 40 93504 40 93760 40 94026 30 94302 10 189792 7 190034 21 190283 28 190539 28 190795 28 191051 28 191307 28 191563 28 191819 28 192075 28 192331 28 192587 28 192843 23 193099 14 193355 5']</span></pre><p id="7994" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RGB图像的形状为(256，1600，3)。意味着有256*1600 = 409600个位置。它对应的掩码(256，1600)没有给出，而是给了我们编码像素。</p><p id="0ad0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1235 2 1459 1 5489 10表示从1235开始取2个像素，从1459开始取1个像素，从5489开始取10个像素。</p><p id="3406" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在变成1235，1236，1459，5489，5490，5491，5492，5493，5494，5495，5496，5497，5498。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="9697" class="jv jw hi jr b fi jx jy l jz ka">en_pix = [‘29102 12 29346 24 29602 24 29858 24 30114 24 30370 24 30626 24 30882 24 31139 23 31395 23 31651 23 31907 23 32163 23 32419 23 32675 23 77918 27 78174 55 78429 60 78685 64 78941 68 79197 72 79452 77 79708 81 79964 85 80220 89 80475 94 80731 98 80987 102 81242 105 81498 105 81754 104 82010 104 82265 105 82521 31 82556 69 82779 27 82818 63 83038 22 83080 57 83297 17 83342 50 83555 13 83604 44 83814 8 83866 37 84073 3 84128 31 84390 25 84652 18 84918 8 85239 10 85476 29 85714 47 85960 57 86216 57 86471 58 86727 58 86983 58 87238 59 87494 59 87750 59 88005 60 88261 60 88517 60 88772 61 89028 53 89283 40 89539 32 89667 10 89795 30 89923 28 90050 29 90179 37 90306 27 90434 38 90562 14 90690 38 90817 9 90946 38 91073 3 91202 38 91458 38 91714 38 91969 39 92225 39 92481 39 92737 39 92993 39 93248 40 93504 40 93760 40 94026 30 94302 10 189792 7 190034 21 190283 28 190539 28 190795 28 191051 28 191307 28 191563 28 191819 28 192075 28 192331 28 192587 28 192843 23 193099 14 193355 5’]</span></pre><p id="1af5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是给定的编码像素，让我们用它来生成一个遮罩</p><p id="eb51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们使用分割函数在空间上分割这些数字:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="476f" class="jv jw hi jr b fi jx jy l jz ka">print(len(en_pix[0].split(‘ ‘)))<br/>en_pix[0].split(‘ ‘)</span><span id="c5a4" class="jv jw hi jr b fi kb jy l jz ka">216<br/>['29102','12','29346','24','29602','24','29858','24','30114','24','30370','24','30626','24','30882','24','31139','23','31395','23','31651','23','31907','23','32163','23','32419','23','32675','23','77918','27','78174','55','78429','60','78685','64','78941','68','79197',<br/>'72','79452','77','79708','81','79964','85','80220','89','80475',<br/>'94','80731','98','80987','102','81242','105','81498','105',<br/>'81754','104','82010','104','82265','105','82521','31','82556',<br/>'69','82779','27','82818','63','83038','22','83080','57','83297',<br/>'17','83342','50','83555','13','83604','44','83814','8',<br/>'83866','37','84073','3','84128','31','84390','25','84652','18',<br/>'84918','8','85239','10','85476','29','85714','47','85960','57',<br/>'86216','57','86471','58','86727','58','86983','58','87238','59',<br/>'87494','59','87750','59','88005','60','88261','60','88517','60',<br/>'88772','61','89028','53','89283','40','89539','32','89667','10',<br/>'89795','30','89923','28','90050','29','90179','37','90306','27',<br/>'90434','38','90562','14','90690','38','90817','9','90946','38','91073','3','91202','38','91458','38','91714','38','91969','39','92225','39','92481','39','92737','39','92993','39','93248','40','93504','40','93760','40','94026','30','94302','10','189792','7','190034','21',<br/>'190283','28','190539','28','190795','28','191051','28','191307',<br/>'28','191563','28','191819','28','192075','28','192331','28','192587','28','192843','23','193099','14','193355','5']</span></pre><p id="d1e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们使用映射函数将这些字符串转换成整数</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="6c50" class="jv jw hi jr b fi jx jy l jz ka">rle = list(map(int, en_pix[0].split(‘ ‘)))<br/>rle</span><span id="b9cd" class="jv jw hi jr b fi kb jy l jz ka">[29102, 12, 29346, 24, 29602, 24, 29858, 24, 30114, 24, 30370, 24, 30626, 24, 30882, 24, 31139, 23, 31395, 23, 31651, 23, 31907, 23, 32163, 23, 32419, 23, 32675, 23, 77918, 27, 78174, 55, 78429, 60, 78685, 64, 78941, 68, 79197, 72, 79452, 77, 79708, 81, 79964, 85, 80220, 89, 80475, 94, 80731, 98, 80987, 102, 81242, 105, 81498, 105, 81754, 104, 82010, 104, 82265, 105, 82521, 31, 82556, 69, 82779, 27, 82818, 63, 83038, 22, 83080, 57, 83297, 17, 83342, 50, 83555, 13, 83604, 44, 83814, 8, 83866, 37, 84073, 3, 84128, 31, 84390, 25, 84652, 18, 84918, 8, 85239, 10, 85476, 29, 85714, 47, 85960, 57, 86216, 57, 86471, 58, 86727, 58, 86983, 58, 87238, 59, 87494, 59, 87750, 59, 88005, 60, 88261, 60, 88517, 60, 88772, 61, 89028, 53, 89283, 40, 89539, 32, 89667, 10, 89795, 30, 89923, 28, 90050, 29, 90179, 37, 90306, 27, 90434, 38, 90562, 14, 90690, 38, 90817, 9, 90946, 38, 91073, 3, 91202, 38, 91458, 38, 91714, 38, 91969, 39, 92225, 39, 92481, 39, 92737, 39, 92993, 39, 93248, 40, 93504, 40, 93760, 40, 94026, 30, 94302, 10, 189792, 7, 190034, 21, 190283, 28, 190539, 28, 190795, 28, 191051, 28, 191307, 28, 191563, 28, 191819, 28, 192075, 28, 192331, 28, 192587, 28, 192843, 23, 193099, 14, 193355, 5]</span></pre><p id="1367" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一个数字是起始像素，下一个数字是从该起始像素开始计数。让我们把它们放在两个不同的列表中</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="ed21" class="jv jw hi jr b fi jx jy l jz ka">pixel,pixel_count = [],[]<br/>[pixel.append(rle[i]) if i%2==0 else pixel_count.append(rle[i]) for i in range(0, len(rle))]<br/>print(‘pixel starting points:\n’,pixel)<br/>print(‘pixel counting:\n’, pixel_count)</span></pre></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><pre class="jq jr js jt aw ju bi"><span id="bb56" class="jv jw hi jr b fi kj kk kl km kn jy l jz ka">pixel starting points:<br/> [29102, 29346, 29602, 29858, 30114, 30370, 30626, 30882, 31139, 31395, 31651, 31907, 32163, 32419, 32675, 77918, 78174, 78429, 78685, 78941, 79197, 79452, 79708, 79964, 80220, 80475, 80731, 80987, 81242, 81498, 81754, 82010, 82265, 82521, 82556, 82779, 82818, 83038, 83080, 83297, 83342, 83555, 83604, 83814, 83866, 84073, 84128, 84390, 84652, 84918, 85239, 85476, 85714, 85960, 86216, 86471, 86727, 86983, 87238, 87494, 87750, 88005, 88261, 88517, 88772, 89028, 89283, 89539, 89667, 89795, 89923, 90050, 90179, 90306, 90434, 90562, 90690, 90817, 90946, 91073, 91202, 91458, 91714, 91969, 92225, 92481, 92737, 92993, 93248, 93504, 93760, 94026, 94302, 189792, 190034, 190283, 190539, 190795, 191051, 191307, 191563, 191819, 192075, 192331, 192587, 192843, 193099, 193355]<br/>pixel counting:<br/> [12, 24, 24, 24, 24, 24, 24, 24, 23, 23, 23, 23, 23, 23, 23, 27, 55, 60, 64, 68, 72, 77, 81, 85, 89, 94, 98, 102, 105, 105, 104, 104, 105, 31, 69, 27, 63, 22, 57, 17, 50, 13, 44, 8, 37, 3, 31, 25, 18, 8, 10, 29, 47, 57, 57, 58, 58, 58, 59, 59, 59, 60, 60, 60, 61, 53, 40, 32, 10, 30, 28, 29, 37, 27, 38, 14, 38, 9, 38, 3, 38, 38, 38, 39, 39, 39, 39, 39, 40, 40, 40, 30, 10, 7, 21, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 23, 14, 5]</span></pre><p id="8815" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们使用上面的2个列表来生成屏蔽的像素位置，</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="725d" class="jv jw hi jr b fi jx jy l jz ka">rle_pixels = [list(range(pixel[i],pixel[i]+pixel_count[i])) for i in range(0, len(pixel))]<br/>print(‘rle_pixels\n:’, rle_pixels)</span><span id="82bc" class="jv jw hi jr b fi kb jy l jz ka">rle_pixels<br/>: [[29102, 29103, 29104, 29105, 29106, 29107, 29108, 29109, 29110, 29111, 29112, 29113], [29346, 29347, 29348, 29349, 29350, 29351, 29352, 29353, 29354, 29355, 29356, 29357, 29358, 29359, 29360, 29361, 29362, 29363, 29364, 29365, 29366, 29367, 29368, 29369], [29602, 29603, 29604, 29605, 29606, 29607, 29608, 29609, 29610, 29611, 29612, 29613, 29614, 29615, 29616, 29617, 29618, 29619, 29620, 29621, 29622, 29623, 29624, 29625], [29858, 29859, 29860, 29861, 29862, 29863, 29864, 29865, 29866, 29867, 29868, 29869, 29870, 29871, 29872, 29873, 29874, 29875, 29876, 29877, 29878, 29879, 29880, 29881], ........., [192843, 192844, 192845, 192846, 192847, 192848, 192849, 192850, 192851, 192852, 192853, 192854, 192855, 192856, 192857, 192858, 192859, 192860, 192861, 192862, 192863, 192864, 192865], [193099, 193100, 193101, 193102, 193103, 193104, 193105, 193106, 193107, 193108, 193109, 193110, 193111, 193112], [193355, 193356, 193357, 193358, 193359]]</span></pre><p id="d148" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们将列表的列表转换成单个列表，</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="0cbb" class="jv jw hi jr b fi jx jy l jz ka">rle_mask_pixels = sum(rle_pixels,[]) <br/>print(‘rle mask pixels:\n’, rle_mask_pixels)</span><span id="0314" class="jv jw hi jr b fi kb jy l jz ka">rle mask pixels:<br/> [29102, 29103, 29104, 29105, 29106, 29107, 29108, 29109, 29110, 29111, 29112, 29113, 29346, 29347, 29348, 29349, 29350, 29351, 29352, 29353, 29354, 29355, 29356, 29357, 29358, 29359, 29360, 29361, 29362, 29363, 29364, 29365, 29366, 29367, 29368, 29369, 29602, 29603, 29604, 29605, 29606, 29607, 29608, 29609, 29610, 29611, 29612, 29613, 29614, 29615, 29616, 29617, 29618, 29619, 29620, 29621, 29622, 29623, 29624, 29625, 29858, 29859, 29860, 29861, 29862, 29863, 29864, ...............,192597, 192598, 192599, 192600, 192601, 192602, 192603, 192604, 192605, 192606, 192607, 192608, 192609, 192610, 192611, 192612, 192613, 192614, 192843, 192844, 192845, 192846, 192847, 192848, 192849, 192850, 192851, 192852, 192853, 192854, 192855, 192856, 192857, 192858, 192859, 192860, 192861, 192862, 192863, 192864, 192865, 193099, 193100, 193101, 193102, 193103, 193104, 193105, 193106, 193107, 193108, 193109, 193110, 193111, 193112, 193355, 193356, 193357, 193358, 193359]</span></pre><p id="02c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在这些位置，输入图像应该被屏蔽。让我们采取一个黑色的面具，并使其在这些像素位置的白色。</p><p id="b3af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">加载并显示输入图像:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="e2b7" class="jv jw hi jr b fi jx jy l jz ka">plt.imshow(cv2.imread(img_location))</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ko"><img src="../Images/8a9da47460a5004a346c60a1510b5b03.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*kOYBdpF4AaJKXuQv7k7UxA.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">输入图像</figcaption></figure><p id="ab68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RGB图像的形状是:(256，1600，3)</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="72d3" class="jv jw hi jr b fi jx jy l jz ka">mask_img = np.zeros((256*1600,1), dtype=int)</span></pre><p id="e742" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用白色像素(255)替换上面提到的位置(rle_mask_pixels)。</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="b212" class="jv jw hi jr b fi jx jy l jz ka">mask_img[rle_mask_pixels] = 255</span></pre><p id="2833" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将数组调整为输入图像大小(256，1000)</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="ad1a" class="jv jw hi jr b fi jx jy l jz ka">l,b=cv2.imread(img_location).shape[0], cv2.imread(img_location).shape[1]</span><span id="7654" class="jv jw hi jr b fi kb jy l jz ka">mask = np.reshape(mask_img, (b, l)).T</span></pre><p id="9b64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们显示最终的蒙版图像:</p><pre class="jf jg jh ji fd jq jr js jt aw ju bi"><span id="b442" class="jv jw hi jr b fi jx jy l jz ka">plt.imshow(mask)</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kt"><img src="../Images/6861d549bc6d1de3a05db31e8ad733bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*VQKndN2In8ajy1YllZQ-4Q.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">根据给定的编码像素生成的遮罩图像</figcaption></figure></div></div>    
</body>
</html>