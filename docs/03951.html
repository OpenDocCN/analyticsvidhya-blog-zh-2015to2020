<html>
<head>
<title>How to run Pyppeteer on Google App Engine Flex</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google App Engine Flex上运行Pyppeteer</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-run-pyppeteer-on-google-app-engine-flex-or-how-i-lost-it-trying-701b09fadf99?source=collection_archive---------5-----------------------#2020-02-27">https://medium.com/analytics-vidhya/how-to-run-pyppeteer-on-google-app-engine-flex-or-how-i-lost-it-trying-701b09fadf99?source=collection_archive---------5-----------------------#2020-02-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/4b1889e817fc07d5dd0729a212912f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HrnrET5FuH2vTdeBsumeJQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">演职员表:<a class="ae iu" href="https://hackingandslacking.com/deploy-app-containers-with-gcp-app-engine-1681bd120357" rel="noopener ugc nofollow" target="_blank">https://hacking ands lacking . com/deploy-app-containers-with-GCP-app-engine-1681 BD 120357</a></figcaption></figure><p id="7e38" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">TL；DR: </strong>我浪费了一天时间研究如何让Pyppeteer在GCP的App Engine Flex环境下运行(特别是)。在网上找不到解决方案，只是运用常识，我正在写一篇我希望已经找到的解决方案的文章。跳到下面的解决方案</p><h1 id="fed4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">一些背景</h1><p id="3870" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated"><a class="ae iu" href="https://github.com/puppeteer/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>是一个为NodeJS构建的无头Chromium API。<a class="ae iu" href="https://github.com/miyakogi/pyppeteer" rel="noopener ugc nofollow" target="_blank"> Pyppeteer </a>是一个<em class="kw">或多或少</em>奇偶Python 3端口的木偶师。</p><p id="201a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它的主要用途是前端单元测试，但也可以作为一个自动化的虚拟浏览器，从中提取有价值的数据。</p><p id="4ca7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="http://www.paulpierre.com" rel="noopener ugc nofollow" target="_blank">我是Adtech的一名数据工程师</a>(意思是:喜欢大数据的后端工程师),我目前从事的项目的一部分涉及到从专有平台提取数据，通常没有API <strong class="ix hj"> <em class="kw">或类似的东西。</em>T15】</strong></p><p id="7a10" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大多数时候，对前端进行逆向工程、提取devtools中的XHR并将它们放入Python的请求库中是相当容易的。对于通过请求和cookies的简单身份验证，获取所需的数据是轻而易举的。</p><p id="94b9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我很少会遇到障碍，但如果我遇到了，通常要么是一个非常安全的前端，带有烦人的计时令牌，要么是一个设计复杂的遗留系统，不值得为其构建模块。</p><p id="850c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在所有情况下，Pyppeteer都是非常可靠的<em class="kw">，直到您决定将其集成到App Engine Flex </em>代码库并进行部署。</p><p id="3ff8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="kw">标准的GCR Python docker镜像缺少Chromium运行</em> </strong>的合适库和驱动。当您部署它时，构建会很好地完成<strong class="ix hj">但是</strong>当您实例化“launch”方法时，您会得到:</p><blockquote class="kx ky kz"><p id="f452" class="iv iw kw ix b iy iz ja jb jc jd je jf la jh ji jj lb jl jm jn lc jp jq jr js hb bi translated"><strong class="ix hj">加载共享库时出错:libX11.so.6:无法打开共享对象文件:没有这样的文件或目录</strong></p></blockquote><h1 id="bbed" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">解决方案</h1><p id="946e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">不幸的是，Pyppeteer的任何文档中都没有这个解决方案，而且一开始也不明显，但是以下是必需的:</p><p id="2c96" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不要在你的应用程序的YAML文件中使用默认的“python”值作为<strong class="ix hj">运行时</strong>，而是将其设置为“<strong class="ix hj">自定义</strong>”。这让App Engine知道您将使用Dockerfile文件。</p><ol class=""><li id="841c" class="ld le hi ix b iy iz jc jd jg lf jk lg jo lh js li lj lk ll bi translated">在应用程序的主目录中创建一个docker文件</li><li id="4ac7" class="ld le hi ix b iy lm jc ln jg lo jk lp jo lq js li lj lk ll bi translated">使用以下内容作为模板:</li></ol><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="1efe" class="ma ju hi lw b fi mb mc l md me">FROM gcr.io/google_appengine/python</span><span id="0c6a" class="ma ju hi lw b fi mf mc l md me">RUN apt-get update &amp;&amp; apt-get -y install  gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget<br/><br/>RUN virtualenv /env<br/>ENV <em class="kw">VIRTUAL_ENV </em>/env<br/>ENV <em class="kw">PATH </em>/env/bin:$<em class="kw">PATH<br/><br/></em>RUN mkdir /your/app/path<br/>ADD . /your/app/path<br/>WORKDIR /your/app/path<br/>ADD requirements.txt /your/app/path/requirements.txt<br/>RUN pip3 install -r /your/app/path/requirements.txt<br/>EXPOSE 8080<br/>ENTRYPOINT ["gunicorn", "-b", ":8080", "main:app"]</span></pre><p id="99e7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，让我们一部分一部分地看一下。</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="7a1b" class="ma ju hi lw b fi mb mc l md me">FROM gcr.io/google_appengine/python</span></pre><p id="7ded" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们想使用Google Cloud Repository的容器映像。这相当于将您的运行时设置为“python”..所以什么都不会改变，但是我们可以向我们的环境中添加包。</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="4766" class="ma ju hi lw b fi mb mc l md me">RUN apt-get update &amp;&amp; apt-get -y install ...etc</span></pre><p id="f2ca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来我们要运行apt-get并安装所有的Chromium依赖项。</p><p id="2fb3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">后续步骤是可选的，但为您的应用程序创建一个虚拟环境是一种很好的做法，这样就不会与容器映像发生冲突。</p><p id="4348" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另外你喜欢整洁，对吗？</p><p id="d7b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后在requirements.txt中安装软件包，公开端口8080 (App Engine Flex的默认端口)，并设置入口点——在我的例子中是gunicorn。</p><p id="41e8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.在使用Pyppeteer的Python文件中，确保将标记“-no-sandbox”添加到参数中，如下所示:</p><pre class="lr ls lt lu fd lv lw lx ly aw lz bi"><span id="78b6" class="ma ju hi lw b fi mb mc l md me">args = ['--no-sandbox']<br/>browser = await launch(args=args)<br/>page = await browser.newPage()</span></pre><p id="4ddb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个标志很重要，因为默认情况下你的容器将以root用户身份运行，而Chromium不允许你以root用户身份在沙盒模式下运行。</p><h1 id="093a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="9658" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我希望你会发现这很有用，它可以节省一些开发人员的时间，这些时间本可以花在<a class="ae iu" href="https://www.reddit.com/r/PraiseTheCameraMan" rel="noopener ugc nofollow" target="_blank">/r/PraiseTheCameraMan</a><em class="kw">(稍后感谢我)</em>上。如果是的话，请在下面留下您的评论和反馈。</p><p id="372a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你好奇，我创建了“<a class="ae iu" href="https://github.com/paulpierre/informer" rel="noopener ugc nofollow" target="_blank">告密者——电报大规模监视</a>”这是一段代码，演示了如何大规模部署无限数量的电报机器人，这些机器人与“真实”账户没有区别，它向你展示了如何以自动化的方式完成这一任务。</p><p id="4e0d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">原谅该项目的标题，FWIW它是<a class="ae iu" href="https://news.ycombinator.com/item?id=21750353" rel="noopener ugc nofollow" target="_blank">特色的黑客新闻</a>，随时<a class="ae iu" href="https://github.com/paulpierre/informer" rel="noopener ugc nofollow" target="_blank">发送一些明星</a>研究员开发。</p><p id="7a73" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">祝你愉快。继续。</p></div></div>    
</body>
</html>