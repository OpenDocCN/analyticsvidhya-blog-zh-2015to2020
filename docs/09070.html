<html>
<head>
<title>Automated Reporting with Python (Part 3) : Scheduling, Creating and Sending periodical COVID19 data as Reports.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 自动报告(第 3 部分) :调度、创建和发送定期的 COVID19 数据作为报告。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automated-reporting-with-python-part-3-scheduling-creating-and-sending-periodical-covid19-842f6794421d?source=collection_archive---------9-----------------------#2020-08-24">https://medium.com/analytics-vidhya/automated-reporting-with-python-part-3-scheduling-creating-and-sending-periodical-covid19-842f6794421d?source=collection_archive---------9-----------------------#2020-08-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3658b88c26e3479d383d2f74ab8bddc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d2pqL9LlfBH8xBe4cYFvkw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Tobias Rehbein 在<a class="ae iu" href="https://unsplash.com/s/photos/covid-data?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="0f97" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在这里找到前两部分→</p><p id="2e12" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 1 部分→ <a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-1-generating-pivot-tables-and-charts-and-saving-to-html-ecd6590cd1b1"> <strong class="ix hj">数据透视表、图表和报表转 HTML </strong> </a></p><p id="fd32" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 2 部分→ <a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-2-converting-an-html-file-to-pdf-and-sending-automated-2fb85eec89e9"> <strong class="ix hj"> HTML 到 PDF 和 Gmail API 自动发送邮件</strong> </a></p><p id="56fb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设每天、每周或每天 n 次，您需要从某个 API 链接、共享驱动器或手动归档等来源获取或下载数据。你正在创建一份报告，并将其发送给你的老板。它重复、无聊又耗时。为什么不自动化呢？</p><p id="aadb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这一部分，我将解释一个<strong class="ix hj">定期报告机制，用于在邮件</strong>中发送自动报告。</p><p id="215e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了便于说明，我从下面的链接<a class="ae iu" href="https://api.covid19india.org/csv/latest/district_wise.csv" rel="noopener ugc nofollow" target="_blank">https://api.covid19india.org/csv/latest/district_wise.csv</a>获取 COVID19 数据</p><p id="d10a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我建议你同时使用 Jupyter 笔记本和一些 IDE，如果不可用，使用文本编辑器- Sublime Text3，它与 Python 配合得很好。</p><p id="5a38" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建两个独立的文件:<strong class="ix hj"> report.py </strong>和<strong class="ix hj"> scheduler.py </strong></p><p id="c849" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可以用 IDE 或使用终端上的<strong class="ix hj">触摸</strong>命令来完成</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/fabb6525517f3876ef6ff9d855a32c98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*FkPlUkgoYpZujtvUFcE_nw.png"/></div></figure><p id="6e91" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了简单起见，我们将首先在 Jupyter 上工作，然后将代码移到。py 文件</p><p id="21ea" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">导入库</strong></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="defc" class="kd ke hi jz b fi kf kg l kh ki">import numpy as np<br/>import pandas as pd<br/>import matplotlib.pyplot as plt</span><span id="b586" class="kd ke hi jz b fi kj kg l kh ki">import requests<br/>import datetime</span></pre><p id="cfa1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">获取数据</strong>:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="e074" class="kd ke hi jz b fi kf kg l kh ki">link = '<a class="ae iu" href="https://api.covid19india.org/csv/latest/district_wise.csv'" rel="noopener ugc nofollow" target="_blank">https://api.covid19india.org/csv/latest/district_wise.csv'</a></span><span id="60a8" class="kd ke hi jz b fi kj kg l kh ki">response = requests.get(link)<br/>content = response.content</span><span id="d728" class="kd ke hi jz b fi kj kg l kh ki"># Name the file as current day<br/>file = open('covid/covid_data_'<br/>            +str(datetime.date.today())+<br/>            '.csv','wb')<br/>file.write(content)</span><span id="5458" class="kd ke hi jz b fi kj kg l kh ki">df = pd.read_csv('covid/covid_data_'+str(datetime.date.today())+'.csv')<br/>df.head()</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/7f443335ce4b2fc33bf41d2dc7f211df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c4281BoCsrClmIfgQNQzKQ.png"/></div></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kl"><img src="../Images/c27713947febd8fab76144f11c7757d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*Tazuk6uWMV9FRLbBu35vVg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated"><strong class="bd km"> df.head() </strong>显示顶行，而<strong class="bd km"> df.columns </strong>显示列名</figcaption></figure><p id="f140" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">争论:让我们把它分组</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="21af" class="kd ke hi jz b fi kf kg l kh ki">state_wise_data = df.groupby(‘State’)</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/3830797ae5981d4f1237774979cf8832.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*u2mw_yetF-e9Sc5xH8kbFg.png"/></div></figure><p id="c17f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们将通过 Covid 选择受影响最大的州的数据。<strong class="ix hj">让我们在“已确认”栏上对数据帧进行排序。</strong></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="16dd" class="kd ke hi jz b fi kf kg l kh ki">state_wise_data = df.groupby('State')</span><span id="eeb0" class="kd ke hi jz b fi kj kg l kh ki">state_data = []</span><span id="127b" class="kd ke hi jz b fi kj kg l kh ki">for state,data in state_wise_data:<br/># summing all the districts data[columns-&gt;confirmed:deceased ] to a variable</span><span id="39f7" class="kd ke hi jz b fi kj kg l kh ki">row_list=[]<br/>    row_list.append(state)<br/>    for d in data.iloc[:,5:14].sum():<br/>        row_list.append(d)<br/>    state_data.append(row_list)</span><span id="2136" class="kd ke hi jz b fi kj kg l kh ki">new_columns=['state']<br/>for col in df.columns[5:14]:<br/>    new_columns.append(col)</span><span id="602b" class="kd ke hi jz b fi kj kg l kh ki">new_data = pd.DataFrame(state_data,<br/>                        columns=new_columns<br/>                       ).sort_values(<br/>                        by=['Confirmed'],<br/>                        ascending=False<br/>                                       )<br/>new_data</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/bf6ff4469536f1c781869786b21ffa0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W9rWtsRVrtSxGtmbxkMB5w.png"/></div></div></figure><p id="059f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们从排序的数据帧中获取前 5 行和前 5 列</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="989a" class="kd ke hi jz b fi kf kg l kh ki">df_to_plot = new_data.iloc[:5,:5]</span></pre><p id="433b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">绘制它:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="bdb7" class="kd ke hi jz b fi kf kg l kh ki">plt=df_to_plot.plot(kind=’bar’,width=0.5,figsize=(10,5))<br/>plt.set_xticklabels(df_to_plot[‘state’],rotation=’30')</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kp"><img src="../Images/89de0eae3c8fd4edbcdb2c6342985d2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*BIhufbIRIHEzDVbro0g3ig.png"/></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kq"><img src="../Images/ae1f5c0c86477d18f3dc9822d02cbfb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*6jzTZMSbJFSJ2MMEJ5jJ5Q.png"/></div></figure><p id="27b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">保存为 HTML，转换为 PDF，Gmail API </strong> : →已经在<a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-1-generating-pivot-tables-and-charts-and-saving-to-html-ecd6590cd1b1"> <strong class="ix hj">报表第一部分</strong></a><a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-2-converting-an-html-file-to-pdf-and-sending-automated-2fb85eec89e9"><strong class="ix hj">报表第二部分</strong> </a> <strong class="ix hj"> &lt; - </strong>请点击打开<strong class="ix hj">。</strong></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="b7d1" class="kd ke hi jz b fi kf kg l kh ki">from datetime import datetime<br/>#Converting to HTML</span><span id="cac1" class="kd ke hi jz b fi kj kg l kh ki"># saving plot image to local file<br/>image = plt.get_figure().savefig(‘covid_plot.png’)<br/>image_tag = ‘&lt;img src=”covid_plot.png”&gt;’</span><span id="fbf0" class="kd ke hi jz b fi kj kg l kh ki">#Table<br/>table = data_to_plot.set_index(‘state’)</span><span id="f6d6" class="kd ke hi jz b fi kj kg l kh ki">#writing HTML Content<br/>heading = ‘&lt;h1&gt; Scheduled Covid Report&lt;/h1&gt;’</span><span id="4fa1" class="kd ke hi jz b fi kj kg l kh ki"># Using .now() from datetime library<br/>now = datetime.now()<br/>current_time = now.strftime(“%m/%d/%Y %H:%M:%S”)<br/>header = ‘&lt;div class=”top”&gt;’ + heading +’&lt;/div&gt;’</span><span id="663d" class="kd ke hi jz b fi kj kg l kh ki">footer = ‘&lt;div class=”bottom”&gt; &lt;h3&gt; This Report has been Generated on ‘<br/>footer = footer+current_time +’&lt;/h3&gt; &lt;/div&gt;’</span><span id="98d1" class="kd ke hi jz b fi kj kg l kh ki">content = ‘&lt;div class=”table”&gt; ‘+ table.to_html()+’ &lt;/div&gt; &lt;div class=”chart”&gt; ‘<br/>content = content+ image_tag +’&lt;/div&gt;’</span><span id="a02a" class="kd ke hi jz b fi kj kg l kh ki">html = ‘&lt;body&gt;’ + header + content + footer +’&lt;/body&gt;’</span><span id="9e18" class="kd ke hi jz b fi kj kg l kh ki"># Writing the file<br/>with open(‘covid_report.html’,’w+’) as file:<br/> file.write(html)</span><span id="4f52" class="kd ke hi jz b fi kj kg l kh ki"># HTML to PDF <br/>import pdfkit<br/>pdfkit.from_file(‘covid_report.html’,’covid_report.pdf’)</span></pre><p id="72a1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Gmail API :-在<a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-2-converting-an-html-file-to-pdf-and-sending-automated-2fb85eec89e9"> <strong class="ix hj">部分解释</strong> </a> <strong class="ix hj"> 2 : </strong>在此粘贴代码</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="2de6" class="kd ke hi jz b fi kf kg l kh ki">from googleapiclient.discovery import build<br/>from google_auth_oauthlib.flow import InstalledAppFlow<br/>from google.auth.transport.requests import Request</span><span id="76c7" class="kd ke hi jz b fi kj kg l kh ki"># Local Libraries<br/>import base64<br/>from email.mime.text import MIMEText<br/>from email.mime.audio import MIMEAudio<br/>from email.mime.application import MIMEApplication<br/>from email.mime.multipart import MIMEMultipart</span><span id="4171" class="kd ke hi jz b fi kj kg l kh ki">SCOPES = [‘<a class="ae iu" href="https://mail.google.com/'" rel="noopener ugc nofollow" target="_blank">https://mail.google.com/'</a>]<br/>class Main:</span><span id="c3e0" class="kd ke hi jz b fi kj kg l kh ki">def __init__(self):<br/> self.creds = None<br/> # The file token.pickle stores the user’s access and refresh tokens, and is<br/> # created automatically when the authorization flow completes for the first<br/> # time.<br/> if os.path.exists(‘credentials/token.pickle’):<br/> with open(‘credentials/token.pickle’, ‘rb’) as token:<br/> self.creds = pickle.load(token)<br/> # If there are no (valid) credentials available, let the user log in.<br/> if not self.creds or not self.creds.valid:<br/> if self.creds and self.creds.expired and self.creds.refresh_token:<br/> self.creds.refresh(Request())<br/> else:<br/> flow = InstalledAppFlow.from_client_secrets_file(<br/> ‘credentials/credentials.json’, SCOPES)<br/> self.creds = flow.run_local_server(port=0)<br/> # Save the credentials for the next run<br/> with open(‘credentials/token.pickle’, ‘wb’) as token:<br/> pickle.dump(self.creds, token)</span><span id="8dd9" class="kd ke hi jz b fi kj kg l kh ki">self.service = build(‘gmail’, ‘v1’, credentials=self.creds)</span><span id="916b" class="kd ke hi jz b fi kj kg l kh ki">class CreateAndSend:</span><span id="b67c" class="kd ke hi jz b fi kj kg l kh ki">def __init__(self,service, to, sender, user_id, subject, message_text,attachment):</span><span id="c942" class="kd ke hi jz b fi kj kg l kh ki">message = MIMEMultipart()<br/> message[‘to’] = to<br/> message[‘from’] = sender<br/> message[‘bcc’] = ‘’<br/> message[‘subject’] = subject<br/> body = MIMEText(message_text)<br/> message.attach(body)<br/> <br/> with open(attachment, “rb”) as f:<br/> #attach = email.mime.application.MIMEApplication(f.read(),_subtype=”pdf”)<br/> attach = MIMEApplication(f.read(),_subtype=”pdf”)<br/> <br/> attach.add_header(‘Content-Disposition’,<br/> ‘attachment’,<br/> filename=str(attachment))<br/> message.attach(attach)<br/> <br/> to_send = {<br/> ‘raw’: base64.urlsafe_b64encode(message.as_string().encode()).decode()<br/> }<br/> print(message)</span><span id="0a06" class="kd ke hi jz b fi kj kg l kh ki">try:<br/> to_send = (service.users().messages().send(userId=user_id, body=to_send)<br/> .execute())<br/> print(‘Message Id: %s’ % to_send[‘id’])</span><span id="9c98" class="kd ke hi jz b fi kj kg l kh ki">except Exception as e:<br/> print(‘An error occurred’, e)</span><span id="2073" class="kd ke hi jz b fi kj kg l kh ki">main = Main()<br/>service = main.service<br/>to = ‘<a class="ae iu" href="mailto:abhinavsharma150@gmail.com" rel="noopener ugc nofollow" target="_blank">sender_id@something.com</a>’<br/>sender = ‘’<br/>user_id = ‘<a class="ae iu" href="mailto:mailstream99@gmail.com" rel="noopener ugc nofollow" target="_blank">gmailapiid@gmail.com</a>’<br/>subject = ‘Automated Report mail’<br/>message_text = ‘Hi,\n\n This report has been generated automatically for a demo purpose.\n\n\nSender Signature.’<br/>attachment=’covid_report.pdf’</span><span id="3755" class="kd ke hi jz b fi kj kg l kh ki">def send_mail():<br/> CreateAndSend(service, to, sender, user_id, subject, message_text,attachment)</span><span id="0462" class="kd ke hi jz b fi kj kg l kh ki">send_mail()</span></pre><p id="477c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">使用 nohup (linux)调度任务</strong></p><p id="a5e6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">nohup 是一个 POSIX 命令，这里的“hup”代表“挂断”。当用户注销时，hup 被发送给系统以通知挂断，nohup 截获该命令并允许进程继续运行。</p><p id="25dc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">语法:</strong></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="b7fb" class="kd ke hi jz b fi kf kg l kh ki"><strong class="jz hj">nohup</strong> <em class="kr">command</em> [<em class="kr">command-argument</em> ...]</span><span id="57a0" class="kd ke hi jz b fi kj kg l kh ki"><strong class="jz hj">nohup</strong> <em class="kr">command</em> [<em class="kr">command-argument</em> ...] &amp;</span></pre><p id="0651" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">命令末尾的&amp;指示 bash 在前台运行命令。让我们试一个例子:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/757f4ad47e35f28887e15a1340c1fd00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*jf6bVLThUcOP84Q5v6HOjQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">创建 Python 文件</figcaption></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kt"><img src="../Images/9ddb8eccf3045a02c8d5042bb9695da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*DCYGXiwQD57bEGSdTyXwfA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">编辑 Python 文件</figcaption></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/8e77aabfa5c8f24d768413a0ad2d3792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eTGHbYJUHOJ84vweBKTbng.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">作为 nohup 运行</figcaption></figure><p id="aa80" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我们运行 nohup 时，它会创建一个带有输出的 nohup.out 文件</p><p id="7953" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关闭 nohup 进程:可以通过将进程置于前台来完成</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kv"><img src="../Images/7ac1ecf4fd4236f9318ece0c75464dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*Y2_3pWfK0fSykUHOZ8nK8A.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">我们可以通过 fg %n 将作业放到前台来停止运行作业，其中 n 是作业的数量</figcaption></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/5cbdbe5bf8bdf964413f5977cb8395d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*q4OdVW1q7L11PwwTwolCJw.png"/></div></figure><p id="1d73" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们创建一个 scheduler.py 并在其中编写一些代码</p><p id="b107" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Python 进度表库</strong>点击此处<strong class="ix hj"> → </strong> <a class="ae iu" href="https://pypi.org/project/schedule/#:~:text=Schedule%20lets%20you%20run%20Python,and%20the%20clockwork%20Ruby%20module." rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">进度表库</strong> </a> <strong class="ix hj"> :- </strong>获取官方文档。可以通过<strong class="ix hj"> pip3 安装进度表</strong>下载</p><p id="a846" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们试着安排每 3 分钟报告一次。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="cec2" class="kd ke hi jz b fi kf kg l kh ki">import schedule<br/>import time,datetime<br/>import os</span><span id="55c0" class="kd ke hi jz b fi kj kg l kh ki">def run_report():<br/> # os.system runs system commands same as in os<br/> os.system(‘python3 report.py’)</span><span id="190f" class="kd ke hi jz b fi kj kg l kh ki">schedule.every(2).minutes.do(run_report)</span><span id="9e05" class="kd ke hi jz b fi kj kg l kh ki">while True:<br/> schedule.run_pending()<br/> time.sleep(1)</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kx"><img src="../Images/6a53bd8179dce3b2c8f25ded485041fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*lVFkIvYceyY3ccl67lN7Vg.png"/></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/32694127e1728b9b5b57b472293188c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p0xvfxc3LjbH8cmrHPSEHg.png"/></div></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/07418c5b0d79ebb084206a5fdda07566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cq3zwqZEKImbmu_88zv8zw.png"/></div></div></figure><p id="23c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">完整代码如下:</strong></p><ol class=""><li id="cb47" class="la lb hi ix b iy iz jc jd jg lc jk ld jo le js lf lg lh li bi translated"><strong class="ix hj"> Report.py </strong></li></ol><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="661c" class="kd ke hi jz b fi kf kg l kh ki">import numpy as np<br/>import pandas as pd<br/>import matplotlib.pyplot as plt<br/>import requests<br/>import datetime<br/>import os</span><span id="89cf" class="kd ke hi jz b fi kj kg l kh ki">link = ‘<a class="ae iu" href="https://api.covid19india.org/csv/latest/district_wise.csv'" rel="noopener ugc nofollow" target="_blank">https://api.covid19india.org/csv/latest/district_wise.csv'</a><br/>response = requests.get(link)<br/>content = response.content<br/># Name the file as current day<br/>file = open(‘covid_data_’<br/> +str(datetime.date.today())+<br/> ‘.csv’,’wb’)</span><span id="2af4" class="kd ke hi jz b fi kj kg l kh ki">file.write(content)<br/>df = pd.read_csv(‘covid_data_’+str(datetime.date.today())+’.csv’)</span><span id="500e" class="kd ke hi jz b fi kj kg l kh ki">state_wise_data = df.groupby(‘State’)</span><span id="2dd4" class="kd ke hi jz b fi kj kg l kh ki">state_data = []<br/>for state,data in state_wise_data:<br/># summing all the districts data[columns-&gt;confirmed:deceased ] to a variable<br/> row_list=[]<br/> row_list.append(state)<br/> for d in data.iloc[:,5:14].sum():<br/> row_list.append(d)<br/> state_data.append(row_list)<br/> new_columns=[‘state’]<br/> for col in df.columns[5:14]:<br/> new_columns.append(col)</span><span id="cb64" class="kd ke hi jz b fi kj kg l kh ki">new_data = pd.DataFrame(state_data,<br/> columns=new_columns<br/> ).sort_values(<br/> by=[‘Confirmed’],<br/> ascending=False<br/> )</span><span id="8c5e" class="kd ke hi jz b fi kj kg l kh ki"># Lets plot first 5 rows<br/>df_to_plot = new_data.iloc[:5,:5]</span><span id="ff94" class="kd ke hi jz b fi kj kg l kh ki">plt=df_to_plot.plot(kind=’bar’,width=0.5,figsize=(10,5))<br/>plt.set_xticklabels(df_to_plot[‘state’],rotation=’30')</span><span id="ba7e" class="kd ke hi jz b fi kj kg l kh ki"># to HTML<br/>from datetime import datetime<br/>#Converting to HTML<br/># saving plot image to local file<br/>image = plt.get_figure().savefig(‘covid_plot.png’)<br/>image_tag = ‘&lt;img src=”covid_plot.png”&gt;’<br/>#Table<br/>table = df_to_plot.set_index(‘state’)<br/>#writing HTML Content<br/>heading = ‘&lt;h1&gt; Scheduled Covid Report&lt;/h1&gt;’<br/># Using .now() from datetime library<br/>now = datetime.now()<br/>current_time = now.strftime(“%m/%d/%Y %H:%M:%S”)<br/>header = ‘&lt;div class=”top”&gt;’ + heading +’&lt;/div&gt;’<br/>footer = ‘&lt;div class=”bottom”&gt; &lt;h3&gt; This Report has been Generated on ‘<br/>footer = footer+current_time +’&lt;/h3&gt; &lt;/div&gt;’<br/>content = ‘&lt;div class=”table”&gt; ‘+ table.to_html()+’ &lt;/div&gt; &lt;div class=”chart”&gt; ‘<br/>content = content+ image_tag +’&lt;/div&gt;’<br/>html = ‘&lt;body&gt;’ + header + content + footer +’&lt;/body&gt;’<br/># Writing the file<br/>with open(‘covid_report.html’,’w+’) as file:<br/> file.write(html)</span><span id="a83c" class="kd ke hi jz b fi kj kg l kh ki"># HTML to PDF <br/>import pdfkit<br/>pdfkit.from_file(‘covid_report.html’,’covid_report.pdf’)</span><span id="e44d" class="kd ke hi jz b fi kj kg l kh ki"># Running Gmail File to Send mail<br/>os.system(‘python3 gmail.py’)<br/></span></pre><p id="0bf0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.谷歌邮箱</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="cd59" class="kd ke hi jz b fi kf kg l kh ki"># Google API Libraries<br/>from __future__ import print_function<br/>import pickle<br/>import os.path<br/>from googleapiclient.discovery import build<br/>from google_auth_oauthlib.flow import InstalledAppFlow<br/>from google.auth.transport.requests import Request</span><span id="982e" class="kd ke hi jz b fi kj kg l kh ki"># Local Libraries<br/>import base64<br/>from email.mime.text import MIMEText<br/>from email.mime.audio import MIMEAudio<br/>from email.mime.application import MIMEApplication<br/>from email.mime.multipart import MIMEMultipart</span><span id="0d71" class="kd ke hi jz b fi kj kg l kh ki">SCOPES = [‘<a class="ae iu" href="https://mail.google.com/'" rel="noopener ugc nofollow" target="_blank">https://mail.google.com/'</a>]<br/>class Main:</span><span id="bb0f" class="kd ke hi jz b fi kj kg l kh ki">def __init__(self):<br/> self.creds = None<br/> # The file token.pickle stores the user’s access and refresh tokens, and is<br/> # created automatically when the authorization flow completes for the first<br/> # time.<br/> if os.path.exists(‘../credentials/token.pickle’):<br/> with open(‘../credentials/token.pickle’, ‘rb’) as token:<br/> self.creds = pickle.load(token)<br/> <br/># If there are no (valid) credentials available, let the user log in.<br/> if not self.creds or not self.creds.valid:<br/> if self.creds and self.creds.expired and self.creds.refresh_token:<br/> self.creds.refresh(Request())<br/> else:<br/> flow = InstalledAppFlow.from_client_secrets_file(<br/> ‘../credentials/credentials.json’, SCOPES)<br/> self.creds = flow.run_local_server(port=0)<br/> # Save the credentials for the next run<br/> with open(‘../credentials/token.pickle’, ‘wb’) as token:<br/> pickle.dump(self.creds, token)</span><span id="cd85" class="kd ke hi jz b fi kj kg l kh ki">self.service = build(‘gmail’, ‘v1’, credentials=self.creds)</span><span id="2641" class="kd ke hi jz b fi kj kg l kh ki">class CreateAndSend:</span><span id="7ae6" class="kd ke hi jz b fi kj kg l kh ki">def __init__(self,service, to, sender, user_id, subject, message_text,attachment):</span><span id="9b1b" class="kd ke hi jz b fi kj kg l kh ki">message = MIMEMultipart()<br/> message[‘to’] = to<br/> message[‘from’] = sender<br/> message[‘bcc’] = ‘’<br/> message[‘subject’] = subject<br/> body = MIMEText(message_text)<br/> message.attach(body)<br/> <br/> with open(attachment, “rb”) as f:<br/> #attach = email.mime.application.MIMEApplication(f.read(),_subtype=”pdf”)<br/> attach = MIMEApplication(f.read(),_subtype=”pdf”)<br/> <br/> attach.add_header(‘Content-Disposition’,<br/> ‘attachment’,<br/> filename=str(attachment))<br/> message.attach(attach)<br/> <br/> to_send = {<br/> ‘raw’: base64.urlsafe_b64encode(message.as_string().encode()).decode()<br/> }<br/> print(message)</span><span id="eae5" class="kd ke hi jz b fi kj kg l kh ki">try:<br/> to_send = (service.users().messages().send(userId=user_id, body=to_send)<br/> .execute())<br/> print(‘Message Id: %s’ % to_send[‘id’])</span><span id="9019" class="kd ke hi jz b fi kj kg l kh ki">except Exception as e:<br/> print(‘An error occurred’, e)</span><span id="c26a" class="kd ke hi jz b fi kj kg l kh ki">main = Main()<br/>service = main.service<br/>to = ‘to_recipient<a class="ae iu" href="mailto:abhinavsharma150@gmail.com" rel="noopener ugc nofollow" target="_blank">@g</a>mail.com’<br/>sender = ‘’<br/>user_id = ‘your_api_gmail_id@gmail.com’<br/>subject = ‘Automated Report mail’<br/>message_text = ‘Hi,\n\n This report has been generated automatically for a demo purpose.\n\n\nSender Signature.’<br/>attachment=’covid_report.pdf’</span><span id="d80b" class="kd ke hi jz b fi kj kg l kh ki">def send_mail():<br/> CreateAndSend(service, to, sender, user_id, subject, message_text,attachment)</span><span id="c01c" class="kd ke hi jz b fi kj kg l kh ki">send_mail()</span></pre><p id="c23b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.scheduler.py</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="7a42" class="kd ke hi jz b fi kf kg l kh ki">import schedule<br/>import time<br/>import datetime<br/>import os</span><span id="d2d3" class="kd ke hi jz b fi kj kg l kh ki">def run_report():<br/> # os.system runs command same as system command line <br/> os.system(‘python3 report.py’)</span><span id="2385" class="kd ke hi jz b fi kj kg l kh ki"># Just select or edit the way the scheduling is needed from below <br/>schedule.every(2).minutes.do(run_report)</span><span id="5535" class="kd ke hi jz b fi kj kg l kh ki">#-------- SOME MORE WAYS IT CAN BE SCHEDULED-------<br/># schedule.every(10).minutes.do(job)<br/># schedule.every().hour.do(job)<br/># schedule.every().day.at(“10:30”).do(job)<br/># schedule.every(5).to(10).minutes.do(job)<br/># schedule.every().monday.do(job)<br/># schedule.every().wednesday.at(“13:15”).do(job)<br/># schedule.every().minute.at(“:17”).do(job)</span><span id="00a2" class="kd ke hi jz b fi kj kg l kh ki">while True:<br/> schedule.run_pending()<br/> time.sleep(1)</span></pre><p id="9794" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果对报告制作或 Gmail API 有任何疑问，你可以阅读我之前的两篇博客，链接如下</p><blockquote class="lj lk ll"><p id="0e80" class="iv iw kr ix b iy iz ja jb jc jd je jf lm jh ji jj ln jl jm jn lo jp jq jr js hb bi translated"><a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-1-generating-pivot-tables-and-charts-and-saving-to-html-ecd6590cd1b1">用 Python 自动报告(第 1 部分):生成数据透视表和图表并保存到 HTML </a></p><p id="d5c2" class="iv iw kr ix b iy iz ja jb jc jd je jf lm jh ji jj ln jl jm jn lo jp jq jr js hb bi translated"><a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-2-converting-an-html-file-to-pdf-and-sending-automated-2fb85eec89e9">用 Python 实现自动报告(第 2 部分) :将 HTML 文件转换成 PDF，并用 Gmail API 发送自动邮件</a></p></blockquote><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/e0b6916dbf2ffa0427fa3d01ba7dab23.png" data-original-src="https://miro.medium.com/v2/resize:fit:420/format:webp/1*CbCAKQYoZHQ5s_e9MGZGMw.jpeg"/></div></figure><p id="f638" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果博客有任何问题，任何你认为合适的修改或编辑，请随意评论。</p><p id="6bbc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">再见！！！！！！！</p></div></div>    
</body>
</html>