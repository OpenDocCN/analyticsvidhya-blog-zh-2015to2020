<html>
<head>
<title>Build OpenCV DNN Module with Nvidia GPU Support on Ubuntu 18.04</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Ubuntu 18.04上使用Nvidia GPU支持构建OpenCV DNN模块</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/build-opencv-dnn-module-with-nvidia-gpu-support-on-ubuntu-18-04-e7dec52521b4?source=collection_archive---------13-----------------------#2020-02-22">https://medium.com/analytics-vidhya/build-opencv-dnn-module-with-nvidia-gpu-support-on-ubuntu-18-04-e7dec52521b4?source=collection_archive---------13-----------------------#2020-02-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="989a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一个完整的指南，用示例代码教你构建OpenCV CUDA支持的DNN模块。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/fb0c5e93b83ed242484dcd932c7b75d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5NUuqqhoDu8hHwBAvbvUGw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">我们终于得到了等待多年的OpenCV DNN模块与Nvidia GPU的合作。</figcaption></figure><blockquote class="jn jo jp"><p id="6b1a" class="jq jr js jt b ju jv ij jw jx jy im jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><em class="hi">使用</em> <a class="ae kn" rel="noopener" href="/analytics-vidhya/build-opencv-dnn-module-with-nvidia-gpu-support-on-ubuntu-18-04-e7dec52521b4?source=friends_link&amp;sk=4c34e8743d5300d548ede9626b543e72"> <em class="hi">这个朋友链接</em> </a> <em class="hi">如果你被挡在付费墙后面，就可以阅读故事的其余部分。</em></p></blockquote><p id="73c9" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">2017年，OpenCV 3.3带来了革命性的DNN模块。久而久之，目前支持大量深度学习框架，如TensorFlow、Caffe、Darknet等。在该模块的帮助下，我们可以使用OpenCV来:</p><ol class=""><li id="4a7a" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km kw kx ky kz bi translated">从磁盘加载预训练模型。</li><li id="4c86" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">对输入图像进行预处理。</li><li id="3cd5" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">通过网络传递图像并获得输出结果。</li><li id="c3c6" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">最少依赖(只有OpenCV！).</li></ol><p id="a8de" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">虽然我们<em class="js">不能</em>用OpenCV训练一个深度学习模型(虽然这没有意义)，但是我们可以用其他深度学习框架训练的模型，在CPU上用OpenCV以不可思议的速度进行推理。</p><p id="1eaa" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">然而，DNN模块直到现在还不支持Nvidia GPU。在Google Summer of Code (GSoC) 2019中，OpenCV DNN模块终于<a class="ae kn" href="https://summerofcode.withgoogle.com/archive/2019/projects/6169918255398912/" rel="noopener ugc nofollow" target="_blank">用<a class="ae kn" href="https://github.com/davisking" rel="noopener ugc nofollow" target="_blank">Davis King</a>—<a class="ae kn" href="https://github.com/davisking/dlib" rel="noopener ugc nofollow" target="_blank">dlib</a>的创造者<a class="ae kn" href="https://github.com/YashasSamaga" rel="noopener ugc nofollow" target="_blank"> Yashas Samaga </a>的作品支持Nvidia GPU </a>进行推理，而这个作品在<a class="ae kn" href="https://github.com/opencv/opencv/wiki/ChangeLog#version420" rel="noopener ugc nofollow" target="_blank">版本4.2.0 </a>中公开。作为一个精通OpenCV的程序员，我想我应该在第一时间分享这个令人兴奋的消息。此外，我将教您如何使用Nvidia GPU的工具编译和安装OpenCV，以进行深度神经网络推理，并且我将提供C++和Python的最小可行示例代码。</p><h1 id="5206" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">菜单，使用CUDA和支持cuDNN的DNN模块编译OpenCV</h1><h1 id="93c0" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">假设</h1><p id="1a0d" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">我假设您正在使用以下设置:</p><ol class=""><li id="d651" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km kw kx ky kz bi translated">一个Nvidia GPU(当然！).</li><li id="20f0" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">Ubuntu 18.04(或其他等效的基于Debian的发行版)。</li><li id="5273" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">CUDA 10.0和cuDNN的对应版本(这里我用的是v7.6.5)。</li><li id="058a" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">您的系统帐户拥有<code class="du mc md me mf b">sudo</code>权限。</li><li id="0a15" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">OpenCV版本4.2.0。</li></ol><h1 id="194a" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">步骤1:安装Nvidia CUDA驱动程序、CUDA工具包和cuDNN</h1><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mg"><img src="../Images/d6e598f5b6207c50379c01e043bd5666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*5w5_Z3p4nL78JMpl.png"/></div></figure><ol class=""><li id="7845" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km kw kx ky kz bi translated"><strong class="jt hj"> <em class="js">备份你的系统，句号。</em> </strong>根据我的经验，你在安装任何一种驱动的时候都有可能不小心弄坏系统。虽然您可以恢复反向安装的系统，但有时您无法成功恢复，因为您忘记了步骤，甚至驱动程序做了一些更改，而您根本没有注意到。作为一个两次破坏系统的人(都是用安装CUDA驱动)，我<strong class="jt hj"> <em class="js">强烈建议</em> </strong>你在任何情况下都要备份你的系统。</li><li id="6ba7" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">安装前的行动我在这里做一些概述。有关详细信息，您可以访问此处的<a class="ae kn" href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#pre-installation-actions" rel="noopener ugc nofollow" target="_blank"/>。</li></ol><ul class=""><li id="598f" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km mh kx ky kz bi translated"><code class="du mc md me mf b">lspci | grep -i nvidia</code>:确认你有一个支持CUDA的GPU。</li><li id="d77e" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km mh kx ky kz bi translated"><code class="du mc md me mf b">uname -m &amp;&amp; cat /etc/*release</code>:验证您是否拥有受支持的Linux版本。</li><li id="8e52" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km mh kx ky kz bi translated"><code class="du mc md me mf b">gcc --version</code>:验证系统是否安装了GCC。</li><li id="a43e" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km mh kx ky kz bi translated"><code class="du mc md me mf b">uname -r</code>:检查系统是否安装了正确的内核头文件和开发包。</li><li id="5fd2" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km mh kx ky kz bi translated"><code class="du mc md me mf b">sudo apt-get install linux-headers-$(uname -r)</code>:安装当前运行内核的内核头文件和开发包。</li></ul><p id="eeac" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">3.安装CUDA驱动程序通过键入以下命令安装CUDA驱动程序:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="4669" class="mm lg hi mf b fi mn mo l mp mq">$ sudo add-apt-repository ppa:graphics-drivers/ppa<br/>$ sudo apt-get update<br/>$ sudo apt-get install nvidia-driver-418</span></pre><p id="660f" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">4.安装后，重新启动系统:</p><p id="d320" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">一旦您的系统启动，输入<code class="du mc md me mf b">nvidia-smi</code>，它应该会给出类似的输出:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mr"><img src="../Images/00faf9fdf19511dad1f14ce1686e4c8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jZDICtqfDTvKsWkbGUVDCQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">nvidia-smi的示例输出。</figcaption></figure><p id="8c8d" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">5.安装CUDA toolkit我会选择runfile包来安装CUDA驱动程序，因为如果你用特定于发行版的包方法安装，你可能会升级这些包，这将在以后引起巨大的问题。</p><p id="5452" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">首先，从<a class="ae kn" href="https://developer.nvidia.com/cuda-downloads" rel="noopener ugc nofollow" target="_blank">这里</a>下载适合您系统的运行文件。</p><p id="b926" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">然后键入以下命令来运行运行文件:<code class="du mc md me mf b">sudo sh cuda_&lt;version&gt;_linux.run --override</code></p><p id="e55e" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">完成安装后，通过在概要文件的底部插入下面几行来更新bash概要文件(<code class="du mc md me mf b">~/.bashrc</code>):</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="6197" class="mm lg hi mf b fi mn mo l mp mq"># NVIDIA CUDA Toolkit<br/>export PATH=/usr/local/cuda-10.0/bin:$PATH<br/>export LD_LIBRARY_PATH=/usr/local/cuda-10.0/lib64:$LD_LIBRARY_PATH</span></pre><p id="ea4e" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">然后获取配置文件:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="5c7d" class="mm lg hi mf b fi mn mo l mp mq">$ source ~/.bashrc</span></pre><p id="3297" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">类型<code class="du mc md me mf b">nvcc -V</code>。如果您得到类似的输出，您就完成了！</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="4964" class="mm lg hi mf b fi mn mo l mp mq">$ nvcc -V<br/>nvcc: NVIDIA (R) Cuda compiler driver<br/>Copyright (c) 2005-2018 NVIDIA Corporation<br/>Built on Sat_Aug_25_21:08:01_CDT_2018<br/>Cuda compilation tools, release 10.0, V10.0.130</span></pre><p id="4b19" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">6.安装cuDNN安装cuDNN比安装CUDA驱动和CUDA工具包要乏味得多。</p><p id="bca0" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">一开始，从<a class="ae kn" href="https://developer.nvidia.com/rdp/cudnn-archive" rel="noopener ugc nofollow" target="_blank">这里</a>下载cuDNN v7.6.5 for CUDA 10.0(可能需要登录或注册才能下载cuDNN)。</p><p id="daf4" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">接下来，提取zip文件，并将头文件和共享库:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="8ff5" class="mm lg hi mf b fi mn mo l mp mq">$ tar -zvf cudnn-10.0-linux-x64-v7.6.5.32.tgz<br/>$ cd cuda<br/>$ sudo cp -P lib64/* /usr/local/cuda/lib64/<br/>$ sudo cp -P include/* /usr/local/cuda/include/<br/>$ cd ~</span></pre><p id="6427" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">如果你在这里没有遇到任何问题，恭喜你！你已经完成了最难的部分！</p><h1 id="2be6" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">步骤2安装OpenCV依赖项</h1><p id="5b12" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">OpenCV有大量的依赖项，我写在这里，所以你只需复制和粘贴以下命令:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="339f" class="mm lg hi mf b fi mn mo l mp mq">$ sudo apt-get update<br/>$ sudo apt-get upgrade<br/>$ sudo apt-get install build-essential cmake unzip pkg-config git \<br/>libjpeg-dev libpng-dev libtiff-dev \<br/>libavcodec-dev libavformat-dev libswscale-dev \<br/>libv4l-dev libxvidcore-dev libx264-dev \<br/>libgtk-3-dev \<br/>libatlas-base-dev gfortran \<br/>python3-dev</span></pre><h1 id="705a" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">步骤3下载OpenCV源代码</h1><p id="6a38" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">目前没有python wheels或dpkg包是在Nvidia GPU支持下构建的。所以我们必须从源代码编译OpenCV。</p><p id="a50a" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">在本教程中，我将<code class="du mc md me mf b">opencv</code>和<code class="du mc md me mf b">opencv_contrib</code>存储库都放在<code class="du mc md me mf b">~/opencv</code>目录中。我会用<code class="du mc md me mf b">git</code>下载源代码，这样我就可以换我喜欢的版本了:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="c724" class="mm lg hi mf b fi mn mo l mp mq">$ cd ~<br/>$ mkdir opencv<br/>$ cd opencv<br/>$ git clone https://github.com/opencv/opencv.git<br/>$ git clone https://github.com/opencv/opencv_contrib.git<br/>$ cd opencv<br/>$ git checkout 4.2.0<br/>$ cd ..<br/>$ cd opencv_contrib<br/>$ git checkout 4.2.0<br/>$ cd ../opencv</span></pre><h1 id="3fdb" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">步骤4配置Python虚拟环境</h1><p id="066b" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">对于使用Python进行开发，使用虚拟环境是一个很好的实践，因为可以隔离使用不同版本的Python库，并且在生产环境中产生的问题较少。</p><p id="5bb0" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">在这一部分，我将使用<code class="du mc md me mf b">virtualenv</code>和<code class="du mc md me mf b">virtualenvwrapper</code>作为虚拟环境。</p><ol class=""><li id="15fc" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km kw kx ky kz bi translated">使用<code class="du mc md me mf b">pip</code>安装<code class="du mc md me mf b">virtualenv</code>和<code class="du mc md me mf b">virtualenvwrapper</code>。</li></ol><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="1e9d" class="mm lg hi mf b fi mn mo l mp mq">$ sudo pip install virtualenv virtualenvwrapper</span></pre><p id="e285" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">安装完这两个包后，您需要在<code class="du mc md me mf b">~/.bashrc</code>中添加以下代码行，以便让bash在每次终端启动时加载virtualenv和virtualenvwrapper:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="5db5" class="mm lg hi mf b fi mn mo l mp mq"># virtualenv and virtualenvwrapper<br/>export WORKON_HOME=$HOME/.virtualenvs<br/>export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3<br/>source /usr/local/bin/virtualenvwrapper.sh</span></pre><p id="ca9c" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">然后重新加载您的<code class="du mc md me mf b">~/.bashrc</code>，让设置立即激活:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="6a90" class="mm lg hi mf b fi mn mo l mp mq">source ~/.bashrc</span></pre><p id="64fc" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">2.创建一个虚拟环境。第一步是创建虚拟环境:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="185b" class="mm lg hi mf b fi mn mo l mp mq">$ mkvirtualenv opencv_cuda -p python3</span></pre><p id="d899" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">这个命令将使用Python 3创建一个名为<code class="du mc md me mf b">opencv_cuda</code>的虚拟环境。创建完成后，您当前工作的虚拟环境应该是<code class="du mc md me mf b">opencv_cuda</code>。</p><p id="30b6" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated"><strong class="jt hj">注意</strong>:如果您曾经关闭您的终端或停用虚拟环境，您可以通过键入以下命令来重新激活它:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="68d9" class="mm lg hi mf b fi mn mo l mp mq">$ workon opencv_cuda</span></pre><p id="b6a3" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">因为OpenCV Python将使用<code class="du mc md me mf b">numpy</code>，所以我们接着安装<code class="du mc md me mf b">numpy</code>:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="66c5" class="mm lg hi mf b fi mn mo l mp mq">$ pip install numpy</span></pre><h1 id="54a7" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">第5步确定你的CUDA架构版本</h1><p id="0567" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">作为一名经验丰富的CUDA程序员，确定CUDA架构版本是一项必需的实践，因为它让编译器在您的GPU上生成更高效的代码。此外，设置不包括Nvidia GPU架构的架构参数会让您的程序在执行时无法工作。</p><p id="0697" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">我们可以用<code class="du mc md me mf b">nvidia-smi</code>算出你的Nvidia GPU是什么型号:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mr"><img src="../Images/00faf9fdf19511dad1f14ce1686e4c8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jZDICtqfDTvKsWkbGUVDCQ.png"/></div></div></figure><p id="c072" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">你可以看到我用的是名字部分写的<strong class="jt hj">Nvidia Geforce GTX 1080 GPU</strong>。请确保您已经通过运行<code class="du mc md me mf b">nvidia-smi</code>让<em class="js">验证了您的GPU型号</em>，然后再继续下一部分。</p><p id="7e4c" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">获得Nvidia GPU模型后，您可以使用此页面找到您的CUDA架构:</p><blockquote class="jn jo jp"><p id="e902" class="jq jr js jt b ju jv ij jw jx jy im jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><a class="ae kn" href="https://developer.nvidia.com/cuda-gpus" rel="noopener ugc nofollow" target="_blank"><em class="hi">https://developer.nvidia.com/cuda-gpus</em></a></p></blockquote><p id="481d" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">向下滚动到“您的GPU计算能力”段落。由于我使用的是GTX 1080，我将点击“支持CUDA的GeForce和TITAN产品”部分。</p><p id="d34d" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">检查后，我意识到我的Nvidia GPU架构版本是<code class="du mc md me mf b">6.1</code>。提醒一下，您的GPU架构版本可能会有所不同。</p><p id="dfce" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">一旦你拿到了GPU架构版本，<em class="js">请记下它</em>，因为我们将在下一步使用它。</p><h1 id="2818" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">第6步:用Nvidia GPU支持配置OpenCV</h1><p id="5112" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">OpenCV使用CMake来配置和生成构建。首先激活<code class="du mc md me mf b">opencv_cuda</code>虚拟环境:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="d7b6" class="mm lg hi mf b fi mn mo l mp mq">$ workon opencv_cuda</span></pre><p id="363c" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">然后，将目录更改到您克隆OpenCV源代码的位置(例如<code class="du mc md me mf b">~/opencv</code>，然后创建一个构建目录(我们使用的是out-of-source build):</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="8416" class="mm lg hi mf b fi mn mo l mp mq">$ cd ~/opencv<br/>$ cd opencv<br/>$ mkdir build &amp;&amp; cd build</span></pre><p id="c2b7" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">接下来，运行下面的<code class="du mc md me mf b">cmake</code>命令，<strong class="jt hj">更改您在步骤#5 </strong>中写下的 <code class="du mc md me mf b"><strong class="jt hj">CUDA_ARCH_BIN</strong></code> <strong class="jt hj">变量:</strong></p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="b7ec" class="mm lg hi mf b fi mn mo l mp mq">$ cmake -D CMAKE_BUILD_TYPE=RELEASE \<br/>-D CMAKE_INSTALL_PREFIX=/usr/local \<br/>-D INSTALL_PYTHON_EXAMPLES=ON \<br/>-D INSTALL_C_EXAMPLES=OFF \<br/>-D OPENCV_ENABLE_NONFREE=ON \<br/>-D WITH_CUDA=ON \<br/>-D WITH_CUDNN=ON \<br/>-D OPENCV_DNN_CUDA=ON \<br/>-D ENABLE_FAST_MATH=1 \<br/>-D CUDA_FAST_MATH=1 \<br/>-D CUDA_ARCH_BIN=6.1 \<br/>-D WITH_CUBLAS=1 \<br/>-D OPENCV_EXTRA_MODULES_PATH=~/opencv/opencv_contrib-4.2.0/modules/ \<br/>-D HAVE_opencv_python3=ON \<br/>-D PYTHON_EXECUTABLE=~/.virtualenvs/opencv_cuda/bin/python \<br/>-D BUILD_EXAMPLES=ON</span></pre><p id="a9e1" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">还有一点，检查CMake输出的<code class="du mc md me mf b">Python 3</code>部分的<code class="du mc md me mf b">install path</code>。我们将在第8步中使用<code class="du mc md me mf b">install path</code>。<strong class="jt hj">所以请留下</strong>T8】的备注。</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="a370" class="mm lg hi mf b fi mn mo l mp mq">--   Python 3:<br/>--     Interpreter:                 /home/cudachen/.virtualenvs/opencv_cuda/bin/python3 (ver 3.6.9)<br/>--     Libraries:                   /usr/lib/x86_64-linux-gnu/libpython3.6m.so (ver 3.6.9)<br/>--     numpy:                       /home/cudachen/.virtualenvs/opencv_cuda/lib/python3.6/site-packages/numpy/core/include (ver 1.18.1)<br/>--     install path:                lib/python3.6/site-packages/cv2/python-3.6</span></pre><h1 id="b45a" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">步骤7编译OpenCV</h1><p id="b8b2" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">如果<code class="du mc md me mf b">cmake</code>没有错误地退出，那么用下面的命令编译OpenCV:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="8f23" class="mm lg hi mf b fi mn mo l mp mq">$ make -j$(nproc)</span></pre><h1 id="7c72" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">步骤8:安装OpenCV和CUDA DNN模块</h1><p id="1f54" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">如果<code class="du mc md me mf b">make</code>成功完成，您键入以下命令来安装OpenCV:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="604b" class="mm lg hi mf b fi mn mo l mp mq">$ sudo make install<br/>$ sudo ldconfig</span></pre><p id="d69e" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">然后，我们将创建一个符号链接，将OpenCV Python绑定到您的Python虚拟环境中。在步骤#6中提到，我们知道<code class="du mc md me mf b">install path</code>就是<code class="du mc md me mf b">/usr/local/lib/python3.6/site-packages/cv2/python-3.6</code>。</p><p id="ef2e" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">要确认，您可以使用<code class="du mc md me mf b">ls</code>命令:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="6ccf" class="mm lg hi mf b fi mn mo l mp mq">$ ls -l /usr/local/lib/python3.6/site-packages/cv2/python-3.6<br/>...</span></pre><p id="2b8a" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">您可以看到我的OpenCV Python绑定的名称是<code class="du mc md me mf b">cv2.cpython-36m-x86_64-linux-gnu.so</code>(您可能有自己构建的绑定的类似名称)。</p><p id="0129" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">接下来，创建一个指向虚拟环境的符号链接:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="56d1" class="mm lg hi mf b fi mn mo l mp mq">$ ln -s /usr/local/lib/python3.6/site-packages/cv2/python-3.6 ~/.virtualenvs/opencv_cuda/lib/python3.6/site-packages/cv2.so</span></pre><p id="2247" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">记得花点时间检查你的文件路径，因为如果OpenCV绑定的路径不正确的话<code class="du mc md me mf b">ln</code>将<em class="js"> slient失败</em>。</p><h1 id="1154" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">验证安装</h1><h1 id="865a" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">C++</h1><p id="0ee9" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">我们可以通过两种方式验证安装是否成功:</p><ol class=""><li id="07d6" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km kw kx ky kz bi translated">程序用OpenCV编译没问题。</li><li id="747f" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">程序执行时没有错误。</li></ol><h2 id="a65e" class="mm lg hi bd lh ms mt mu ll mv mw mx lp ko my mz lr kp na nb lt kq nc nd lv ne bi translated">验证步骤，C++部分</h2><ol class=""><li id="4b2c" class="kr ks hi jt b ju lx jx ly ko nf kp ng kq nh km kw kx ky kz bi translated">下载自述文件中提到的<a class="ae kn" href="https://github.com/Cuda-Chen/opencv-dnn-cuda-test" rel="noopener ugc nofollow" target="_blank"> repo </a>和权重。</li><li id="e1e9" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">转到<code class="du mc md me mf b">cpp_code</code>目录并键入以下命令:<code class="du mc md me mf b">g++ -o opencv_dnn_cuda_test_cpp main.cpp -I/usr/local/include/opencv4 -lopencv_core -lopencv_dnn -lopencv_highgui -lopencv_imgcodecs</code></li><li id="8d83" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">使用以下命令运行可执行文件:<code class="du mc md me mf b">opencv_dnn_cuda_test_cpp</code></li><li id="f5b1" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">如果终端输出类似的信息，你就完了！</li></ol><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="9260" class="mm lg hi mf b fi mn mo l mp mq">$ ./opencv_dnn_cuda_test_cpp <br/>Time per inference: 14 ms<br/>FPS: 71.4286</span></pre><h1 id="f232" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">计算机编程语言</h1><p id="60c0" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">我们可以通过两种方式验证安装是否成功:</p><ol class=""><li id="ec1c" class="kr ks hi jt b ju jv jx jy ko kt kp ku kq kv km kw kx ky kz bi translated">我们可以用Python脚本导入OpenCV。</li><li id="c325" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">我们能够通过DNN模块使用Nvidia GPU。</li></ol><h2 id="2b0d" class="mm lg hi bd lh ms mt mu ll mv mw mx lp ko my mz lr kp na nb lt kq nc nd lv ne bi translated">验证步骤，Python部分</h2><ol class=""><li id="aea8" class="kr ks hi jt b ju lx jx ly ko nf kp ng kq nh km kw kx ky kz bi translated">下载自述文件中提到的<a class="ae kn" href="https://github.com/Cuda-Chen/opencv-dnn-cuda-test" rel="noopener ugc nofollow" target="_blank"> repo </a>和砝码。</li><li id="c476" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">激活虚拟环境(即<code class="du mc md me mf b">opencv_cuda</code>)。</li><li id="5334" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">转到<code class="du mc md me mf b">python_code</code>目录，键入命令:<code class="du mc md me mf b">python main.py</code></li><li id="2b04" class="kr ks hi jt b ju la jx lb ko lc kp ld kq le km kw kx ky kz bi translated">如果终端输出类似的信息，你就完了！</li></ol><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="1990" class="mm lg hi mf b fi mn mo l mp mq">$ python main.py <br/>Time per inference: 14.480803 ms<br/>FPS:  69.05694381124881</span></pre><h1 id="7b4a" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">概述</h1><p id="7de8" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">在这篇文章中，我将教你如何在Ubuntu 18.04上从头开始安装OpenCV和支持CUDA的DNN模块。此外，我还提供了一个C++和Python的最小样本代码，以便您可以在以后的项目中方便地使用它们。</p><p id="6f7a" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">要使用CUDA作为OpenCV DNN模块的后端，您只需在加载预训练模型后添加这两行代码:</p><pre class="iy iz ja jb fd mi mf mj mk aw ml bi"><span id="21c8" class="mm lg hi mf b fi mn mo l mp mq">// C++<br/>net.setPreferableBackend(cv::dnn::DNN_BACKEND_CUDA);<br/>net.setPreferableTarget(cv::dnn::DNN_TARGET_CUDA);<br/><br/>...<br/><br/># Python<br/>net.setPreferableBackend(cv.dnn.DNN_BACKEND_CUDA)<br/>net.setPreferableTarget(cv.dnn.DNN_TARGET_CUDA)</span></pre><h1 id="5396" class="lf lg hi bd lh li lj lk ll lm ln lo lp io lq ip lr ir ls is lt iu lu iv lv lw bi translated">特别感谢</h1><p id="e24a" class="pw-post-body-paragraph jq jr hi jt b ju lx ij jw jx ly im jz ko lz kc kd kp ma kg kh kq mb kk kl km hb bi translated">我非常感谢<a class="ae kn" href="https://www.pyimagesearch.com/2020/02/03/how-to-use-opencvs-dnn-module-with-nvidia-gpus-cuda-and-cudnn/" rel="noopener ugc nofollow" target="_blank">在pyimagesearch.com的这篇文章</a>。如果没有这篇文章，我不会简单地完成这篇文章。</p><p id="dff9" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated">我还要特别感谢<a class="ae kn" href="https://github.com/YashasSamaga" rel="noopener ugc nofollow" target="_blank"> YashasSamaga </a>，他是OpenCV DNN模块和CUDA的主要贡献者。他还讲授了很多关于OpenCV GitHub repo的问题，这帮助很多人解决了使用OpenCV CUDA支持的DNN模块进行编译的问题。</p></div><div class="ab cl ni nj gp nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="hb hc hd he hf"><p id="2afd" class="pw-post-body-paragraph jq jr hi jt b ju jv ij jw jx jy im jz ko kb kc kd kp kf kg kh kq kj kk kl km hb bi translated"><em class="js">原载于2020年2月22日</em><a class="ae kn" href="https://cuda-chen.github.io/image%20processing/programming/2020/02/22/build-opencv-dnn-module-with-nvidia-gpu-support-on-ubuntu-1804.html" rel="noopener ugc nofollow" target="_blank"><em class="js">https://cuda-Chen . github . io</em></a><em class="js">。</em></p></div><div class="ab cl ni nj gp nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="hb hc hd he hf"><blockquote class="jn jo jp"><p id="27d1" class="jq jr js jt b ju jv ij jw jx jy im jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><em class="hi">如果你有什么想法和问题要分享，请联系我</em><a class="ae kn" href="http://clh960524@gmail.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jt hj"><em class="hi">clh 960524【at】Gmail . com</em></strong></a><em class="hi">。还有，其他作品可以查看我的</em> <a class="ae kn" href="https://github.com/Cuda-Chen" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> GitHub库</em> </a> <em class="hi">。如果你和我一样热衷于机器学习、图像处理和并行计算，欢迎在LinkedIn上</em> <a class="ae kn" href="https://www.linkedin.com/in/lu-hsuan-chen-78071b171/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">加我</em> </a> <em class="hi">。</em></p></blockquote><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="np nq l"/></div></figure></div></div>    
</body>
</html>