<html>
<head>
<title>Journey of Apache Kafka &amp; Zookeeper Administrator ( Part 10 )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇卡夫卡与动物园管理员之旅(十)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-10-6f72d3e6d98f?source=collection_archive---------21-----------------------#2020-09-01">https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-10-6f72d3e6d98f?source=collection_archive---------21-----------------------#2020-09-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="33cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2020 年 4 月(Python 作为救世主第 3 部分)</p><p id="4dd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/@116davinder/journey-of-apache-kafka-zookeeper-administrator-part-9-614993e6ca85">在上一篇文章</a>中，我们讨论了使用我的自定义脚本进行 MM1 监控。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><blockquote class="jl"><p id="f2ca" class="jm jn hi bd jo jp jq jr js jt ju jc dx translated">老实说，我从来没有读过 Apache Zookeeper 的发行说明和文档，因为它只是工作。</p></blockquote><figure class="jw jx jy jz ka kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es jv"><img src="../Images/3249302a7c7518a11be53626fe7a1d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tLAbaZF24GgJrl7NnPhykQ.png"/></div></div></figure><p id="e3c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我在为 Apache Kafka 定制脚本时，不知何故我看到 Zookeeper 3 . 5 . 0 版有一个叫做<a class="ae jd" href="https://zookeeper.apache.org/doc/r3.6.1/zookeeperAdmin.html#sc_adminserver" rel="noopener ugc nofollow" target="_blank">管理服务器</a>的东西。</p><blockquote class="ki kj kk"><p id="e2f2" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">管理服务器</p><p id="011a" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated"><strong class="ih hj">3 . 5 . 0 中的新特性:</strong>AdminServer 是一个嵌入式 Jetty 服务器，它为四个字母的 word 命令提供了一个 HTTP 接口。默认情况下，服务器在端口 8080 上启动，通过转到 URL“/commands/[命令名]”发出命令，例如<a class="ae jd" href="http://localhost:8080/commands/stat." rel="noopener ugc nofollow" target="_blank">http://localhost:8080/commands/stat。</a>命令响应作为 JSON 返回。与原始协议不同，命令不限于四个字母的名称，命令可以有多个名称；例如，“stmk”也可以称为“set_trace_mask”。要查看所有可用命令的列表，请将浏览器指向 URL/命令(例如，<a class="ae jd" href="http://localhost:8080/commands)." rel="noopener ugc nofollow" target="_blank">http://localhost:8080/commands)。</a>参见<a class="ae jd" href="https://zookeeper.apache.org/doc/r3.6.1/zookeeperAdmin.html#sc_adminserver_config" rel="noopener ugc nofollow" target="_blank"> AdminServer 配置选项</a>了解如何更改端口和 URL。</p></blockquote><p id="12e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我对自己说，监视 Apache Zookeeper 变得超级容易。工藤的阿帕奇动物园管理员。</p><p id="481e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我决定编写一个脚本来删除这些指标，并将它们保存在 zookeeper-logs 目录中，以便 Splunk 可以读取它们。</p><p id="080d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/116davinder/zooki/blob/af0b0ae3c910ccd88a59fc4891e66824e2a557cd/zooki.py" rel="noopener ugc nofollow" target="_blank">脚本版本一:</a></p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="6e81" class="ky kz hi ku b fi la lb l lc ld">#!/usr/bin/env python3</span><span id="0dfa" class="ky kz hi ku b fi le lb l lc ld"># usage: python3 zooki.py /zookeeper /zookeeper/zookeeper-logs/metric.out</span><span id="37db" class="ky kz hi ku b fi le lb l lc ld"># This script suppose to export all zookeeper metric from one node and write to file<br/># from where either splunk like tools can read it.</span><span id="6593" class="ky kz hi ku b fi le lb l lc ld">from urllib import request<br/>from socket import gethostname<br/>from datetime import datetime<br/>import json<br/>import sys</span><span id="ce99" class="ky kz hi ku b fi le lb l lc ld">class zooki:<br/>    def __init__(self):<br/>        self.zAddr = gethostname()<br/>        self.zPort = 8080<br/>        self.zHttpAddr = "http://" + self.zAddr + ":" + str(self.zPort) + "/commands/"<br/>        self.cTimeNow = str(datetime.now())</span><span id="244c" class="ky kz hi ku b fi le lb l lc ld">def getZMetric(self, commandPath):<br/>        with request.urlopen( self.zHttpAddr + commandPath ) as f:<br/>            _szMetric = json.loads(f.read().decode('utf-8'))<br/>            _szMetric["<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>"] = self.cTimeNow<br/>        return json.dumps(_szMetric)</span><span id="2c99" class="ky kz hi ku b fi le lb l lc ld">def main():</span><span id="65b8" class="ky kz hi ku b fi le lb l lc ld">commandPaths = ['connections', 'dump', 'leader', 'monitor',<br/>                    'observers', 'ruok', 'server_stats',<br/>                    'voting_view', 'watch_summary',  'watches_by_path', 'zabstate']</span><span id="4fd5" class="ky kz hi ku b fi le lb l lc ld">with open(sys.argv[2], "w") as zMetricFile:<br/>        z = zooki()<br/>        for c in commandPaths:<br/>            zMetricFile.write("\n")<br/>            zMetricFile.write(z.getZMetric(c))</span><span id="2c14" class="ky kz hi ku b fi le lb l lc ld">main()</span></pre><p id="3de7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有一件小事要记住，我正在更新从 Zookeeper 废弃的 JSON，因为我必须在其中插入时间戳。</p><p id="29d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">剧本很好。</p><p id="1a2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注:</strong> <a class="ae jd" href="https://github.com/116davinder/zooki" rel="noopener ugc nofollow" target="_blank">版本一脚本/库</a>已存档。</p><p id="141c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦 Splunk 开始索引这些指标，我就意识到了问题所在。<br/> 1。<strong class="ih hj"> Splunk 在指数指标上苦苦挣扎。<br/> 2。指标太多。</strong></p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><blockquote class="ki kj kk"><p id="f287" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">Splunk 对每一行都有限制，因此如果行大于 20 KB(可能有所不同),它就会跳过它，而您不知道为什么行/指标没有被索引。</p></blockquote><p id="c648" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决上述问题，我创建/修改了脚本以减少工作量并使 Splunk 正常工作。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="66d6" class="ky kz hi ku b fi la lb l lc ld"># usage: python3 zooki.py /zookeeper /zookeeper/zookeeper-logs/ dev-zookeeper</span><span id="3ae6" class="ky kz hi ku b fi le lb l lc ld"># This script suppose to export all zookeeper metric from one node and write to file<br/># from where splunk/cloudwatch like tools can read it.</span><span id="ec7c" class="ky kz hi ku b fi le lb l lc ld">from urllib import request<br/>import shutil<br/>from socket import gethostname<br/>from datetime import datetime<br/>import json<br/>import sys<br/>import os.path</span><span id="9452" class="ky kz hi ku b fi le lb l lc ld">class zooki:<br/>    def __init__(self):<br/>        self.zAddr = gethostname()<br/>        self.zPort = 8080<br/>        self.zHttpAddr = "http://" + self.zAddr + ":" + str(self.zPort) + "/commands/"<br/>        self.cTimeNow = str(datetime.now())</span><span id="6594" class="ky kz hi ku b fi le lb l lc ld">def getStorageMetric(self):<br/>        total, used, free = shutil.disk_usage(sys.argv[1])<br/>        _sMetric = {<br/>                    "<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>": self.cTimeNow,<br/>                    "command": "disk",<br/>                    "environment": sys.argv[3],<br/>                    "totalInGB": total // (2**30),<br/>                    "usedInGB":  used // (2**30),<br/>                    "freeInGB": free // (2**30)<br/>                    }<br/>        return json.dumps(_sMetric)</span><span id="ba63" class="ky kz hi ku b fi le lb l lc ld">def getZMetric(self, commandPath):<br/>        with request.urlopen( self.zHttpAddr + commandPath ) as f:<br/>            if f.status == 200:<br/>                _zMetric = json.loads(f.read().decode('utf-8'))<br/>                _zMetric["<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>"] = self.cTimeNow<br/>                _zMetric["environment"] = sys.argv[3]<br/>            else:<br/>                _zMetric = {}<br/>        return json.dumps(_zMetric)</span><span id="1578" class="ky kz hi ku b fi le lb l lc ld"># json retruned by monitor is too big to be handled by splunk indexer<br/># so separate function to reduce the json size<br/>    def getMonitorMetric(self):<br/>        with request.urlopen( self.zHttpAddr + "monitor" ) as f:<br/>            if f.status == 200:<br/>                _MM = json.loads(f.read().decode('utf-8'))<br/>                _zMetric = {<br/>                    "<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>": self.cTimeNow,<br/>                    "environment": sys.argv[3],<br/>                    "command": _MM["command"],<br/>                    "znode_count": _MM["znode_count"],<br/>                    "watch_count": _MM["watch_count"],<br/>                    "outstanding_requests": _MM["outstanding_requests"],<br/>                    "open_file_descriptor_count": _MM["open_file_descriptor_count"],<br/>                    "ephemerals_count": _MM["ephemerals_count"],<br/>                    "max_latency": _MM["max_latency"],<br/>                    "avg_latency": _MM["avg_latency"],<br/>                    "synced_followers": _MM["synced_followers"] if _MM["server_state"] == "leader" else 0,<br/>                    "pending_syncs": _MM["pending_syncs"] if _MM["server_state"] == "leader" else 0,<br/>                    "version": _MM["version"],<br/>                    "quorum_size": _MM["quorum_size"],<br/>                    "uptime": _MM["uptime"]<br/>                }<br/>            else:<br/>                _zMetric = {}<br/>        return json.dumps(_zMetric)</span><span id="c3fa" class="ky kz hi ku b fi le lb l lc ld">def main():</span><span id="a33c" class="ky kz hi ku b fi le lb l lc ld">commandPaths = ['connections', 'leader', 'watch_summary']</span><span id="dee4" class="ky kz hi ku b fi le lb l lc ld">z = zooki()<br/>    with open(os.path.join(sys.argv[2], "disk.out"), "w") as zMetricFile:<br/>        zMetricFile.write(z.getStorageMetric())</span><span id="a3db" class="ky kz hi ku b fi le lb l lc ld">for command in commandPaths:<br/>        with open(os.path.join(sys.argv[2], command, ".out"), "w") as zMetricFile:<br/>            zMetricFile.write(z.getZMetric(command))</span><span id="7ae7" class="ky kz hi ku b fi le lb l lc ld">with open(os.path.join(sys.argv[2], "monitor.out"), "w") as zMetricFile:<br/>        zMetricFile.write(z.getMonitorMetric())<br/>main()</span></pre><p id="a051" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">脚本的主要变化:</strong></p><ul class=""><li id="72ce" class="lf lg hi ih b ii ij im in iq lh iu li iy lj jc lk ll lm ln bi translated">减少要运行的度量命令的数量。</li><li id="20f9" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">为“monitor”命令创建一个单独的函数，以便从中剥离输出。</li><li id="efef" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">为不同的指标创建单独的输出文件，这样 Splunk 可以更快地索引它们，以后的查询也会更快一些。</li><li id="924e" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">添加了系统磁盘指标。</li><li id="549d" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">与 Ansible 代码集成。</li><li id="0b63" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">插入环境标签和命令标签。</li></ul><p id="abb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在 Ansible 代码中创建了新的角色:</strong><a class="ae jd" href="https://github.com/116davinder/zookeeper-cluster-ansible/tree/master/roles/customMetricExporter" rel="noopener ugc nofollow" target="_blank">116 davinder/zookeeper-cluster-ansi ble/roles/customMetricExporter</a></p><p id="c033" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个可行的任务应该做两件事</p><ul class=""><li id="040b" class="lf lg hi ih b ii ij im in iq lh iu li iy lj jc lk ll lm ln bi translated">复制脚本。</li><li id="ac91" class="lf lg hi ih b ii lo im lp iq lq iu lr iy ls jc lk ll lm ln bi translated">用参数为上面的脚本创建 cron 任务。</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="d0cf" class="ky kz hi ku b fi la lb l lc ld">---</span><span id="bc61" class="ky kz hi ku b fi le lb l lc ld">- name: copying zooki.py to {{ zookeeperInstallDir }}<br/>  copy:<br/>    src: zooki.py<br/>    dest: "{{ zookeeperInstallDir }}"<br/>    owner: "{{ zookeeperUser }}"<br/>    group: "{{ zookeeperGroup }}"<br/>    mode: 0777</span><span id="f7bb" class="ky kz hi ku b fi le lb l lc ld">- name: cron for zookeeper metric collector ( zooki.py )<br/>  cron:<br/>    name: "zookeeper metric collector"<br/>    minute: "*"<br/>    hour: "*"<br/>    weekday: "*"<br/>    user: root<br/>    job: 'find /bin/ -name "python3*m" -print0 -exec {} {{ zookeeperInstallDir }}/zooki.py {{ zookeeperInstallDir }} {{ zookeeperLogDir }}/  {{ zookeeperEnvironment }} \;'</span></pre><p id="b5c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 Ansible Task 中还有一件有趣的事情需要注意，那就是如何找到 python3 二进制文件并运行它。我在不同的环境中见过不同的安装，它们有不同的二进制名称，这导致了默认命令“python3”的问题，所以我添加了小的 bash 命令来变魔术。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="ef8f" class="ky kz hi ku b fi la lb l lc ld">find /bin/ -name "python3*m" -print0 -exec {} zooki.py ......</span></pre><p id="1170" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的脚本适用于所有环境，Splunk 也没有问题。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><p id="b2e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，是我动手使用 Splunk 仪表盘的时候了。</p><blockquote class="ki kj kk"><p id="7067" class="if ig kl ih b ii ij ik il im in io ip km ir is it kn iv iw ix ko iz ja jb jc hb bi translated">直到这个时候，我还在 Splunk 仪表盘上为我的用例做忍者。</p></blockquote><p id="42aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Splunk Dashboard Code</strong>:<a class="ae jd" href="https://github.com/116davinder/zookeeper-cluster-ansible/blob/master/files/splunk%20dashboards/apache-zookeeper.xml" rel="noopener ugc nofollow" target="_blank">116 davinder/zookeeper-cluster-ansi ble/Splunk-dashboards/Apache-zookeeper . XML</a><br/><strong class="ih hj">Splunk Dashboard Sample:</strong>不好意思，忘记上传到 GitHub:(。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><p id="9b9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一旅程将在下一篇文章中继续(云与地形的乐趣)</p></div></div>    
</body>
</html>