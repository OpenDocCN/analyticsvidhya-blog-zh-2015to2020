<html>
<head>
<title>Turn Right in 2 Miles: Simple Method to Find Distance Using the Google Maps API and Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在2英里内右转:使用谷歌地图API和熊猫查找距离的简单方法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/turn-right-in-2-miles-finding-distances-using-the-google-maps-api-and-pandas-fef8554f0b7d?source=collection_archive---------4-----------------------#2019-12-19">https://medium.com/analytics-vidhya/turn-right-in-2-miles-finding-distances-using-the-google-maps-api-and-pandas-fef8554f0b7d?source=collection_archive---------4-----------------------#2019-12-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="31a3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="d8ac" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">每天都会产生大量的位置数据。优步、Lyft、谷歌地图、Yelp、Lime和许多其他公司都在各自的平台上使用和生成这些数据。有大量的信息等待访问，但是您可能会发现自己需要一些关于如何处理这些数据并从中获得洞察力的指导。</p><p id="8a9b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在本帖中，我们将使用Google Maps API，在给定纬度和经度的情况下，确定上下车地点之间的距离。</p><p id="4d2a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们将查看以下数据框架来计算接送点之间的距离:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="04ec" class="kp ig hi kl b fi kq kr l ks kt">df.head()</span></pre><figure class="kg kh ki kj fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ku"><img src="../Images/5e7465dce1dee860ad6a8a125b04f1c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y7b3rmviVuxY7IPHEHsUbQ.png"/></div></div></figure><p id="d108" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在访问API之前，您需要首先<a class="ae lc" href="https://developers.google.com/maps/documentation" rel="noopener ugc nofollow" target="_blank">在谷歌地图平台上创建一个账户</a>。</p><p id="e5ad" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">请注意，你将不得不把支付信息，但你得到每月200美元的信用免费访问。如果您需要访问更多API，可以在<a class="ae lc" href="https://cloud.google.com/maps-platform/pricing/sheet/?_ga=2.244908933.1023964652.1576690143-691402014.1576690143" rel="noopener ugc nofollow" target="_blank">这里</a>找到更多定价。查看距离矩阵单元。</p><p id="7139" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我使用的数据来自Kaggle，可以在这里找到<a class="ae lc" href="https://www.kaggle.com/c/new-york-city-taxi-fare-prediction/data" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="905a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">为什么要使用谷歌地图API？</h1><p id="bd1a" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">根据您对数据的处理，您可能希望以不同的方式计算距离。下面，我将讨论两种流行的利用三角形计算距离的方法(勾股定理)。谷歌地图API给你实际的驾驶距离，因此如果你的模型需要这种精度，它可以更精确。</p><p id="b6aa" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">让我们看一个例子，用每种方法计算从纽约到休斯顿的距离:</p><p id="592c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">欧几里德距离</strong></p><p id="09ec" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">欧几里得距离被计算为直角三角形的斜边，就像勾股定理一样。这只是一条从A点到b点的直接路径。在下图中，这将是黑线。欧几里得距离大约是1417英里。虽然不完美，但这可能是对飞行距离的一个很好的估计。</p><figure class="kg kh ki kj fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ld"><img src="../Images/b61e229389aa3f343c8ce3f06d6e50b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yG8UYjGvefnFmFow8XOWYg.png"/></div></div></figure><p id="9f2f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">曼哈顿距离</strong></p><p id="3bb9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">曼哈顿距离的计算方法是直角三角形边的总和。这在图中用红线表示。从纽约到休斯顿的曼哈顿距离约为2015英里。这种方法有其问题，但在基于网格的城市中可能是一个很好的估计。</p><p id="3752" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">谷歌地图API距离</strong></p><p id="c840" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">谷歌地图API给我们提供了实际的行驶距离，就像你在谷歌地图手机应用程序中绘制从纽约到休斯顿的地图一样。在图像中，蓝线是谷歌地图的API距离，大约为1，630英里。如果您有优步数据或任何其他想要了解行驶距离的数据，这将非常有用。</p><p id="6c7e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">根据您的目的，每种方法都有其优点和缺点，但是我们将在下面的代码中介绍如何访问Google Maps API距离。</p><p id="58c2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">理解这个API遵循交通规则是很重要的。因此，您的纬度和经度需要尽可能精确。如果你只偏离了10英尺，API可能会认为你在马路的另一边，并错误地计算了驾驶距离。</p><h1 id="ea28" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">Python代码</h1><h2 id="a9cd" class="kp ig hi bd ih le lf lg il lh li lj ip jo lk ll it js lm ln ix jw lo lp jb lq bi translated">1.要导入的包</h2><ul class=""><li id="6088" class="lr ls hi jf b jg jh jk jl jo lt js lu jw lv ka lw lx ly lz bi translated"><strong class="jf hj">pandas</strong>:Python中的数据分析工具。这些可以用来操作数据和创建数据帧。</li><li id="4eec" class="lr ls hi jf b jg ma jk mb jo mc js md jw me ka lw lx ly lz bi translated"><strong class="jf hj"> json </strong>:数据交换包。我用它来访问存储在. json文件中的API密钥；这是为了保持我的API密匙私有。</li><li id="1b52" class="lr ls hi jf b jg ma jk mb jo mc js md jw me ka lw lx ly lz bi translated"><strong class="jf hj">请求:</strong>使用最常见的HTTP方法发出请求。</li></ul><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="71a1" class="kp ig hi kl b fi kq kr l ks kt">import json<br/>import requests<br/>import pandas as pd</span></pre><h2 id="edf0" class="kp ig hi bd ih le lf lg il lh li lj ip jo lk ll it js lm ln ix jw lo lp jb lq bi translated">2.使用Test Try访问API</h2><p id="888c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">首先，您需要访问您的API密钥。我把我的API存储在不同的。json文件，并使用下面的代码访问它们(如果您有访问API密钥的首选方式，那么就使用它。):</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="25a1" class="kp ig hi kl b fi kq kr l ks kt">def get_keys(path):<br/>    with open(path) as f:<br/>        return json.load(f)</span><span id="403b" class="kp ig hi kl b fi mf kr l ks kt">API_key = get_keys("/Users/Documents/google_key.json")</span><span id="469c" class="kp ig hi kl b fi mf kr l ks kt">google_key = list(API_key.values())[0]</span></pre><p id="16f6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">引入API Url并调用一个测试(我通常从在Postman中进行测试开始，然后转移到我的Jupyter笔记本)。输出如下所示:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3a32" class="kp ig hi kl b fi kq kr l ks kt">url = f"<a class="ae lc" href="https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&amp;origins=40.6655101,-73.89188969999998&amp;destinations=40.6905615%2C-73.9976592&amp;key={google_key" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&amp;origins=40.6655101,-73.89188969999998&amp;destinations=40.6905615%2C-73.9976592&amp;key={google_key</a>}"</span><span id="a8ff" class="kp ig hi kl b fi mf kr l ks kt">r = requests.get(url)<br/>data = r.json()<br/>data</span></pre><figure class="kg kh ki kj fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es mg"><img src="../Images/d6616f0ecc858e37e11d42501e5c098b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tedDNmU3l-H0Y2I2eOi7yw.png"/></div></div></figure><p id="5e73" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">好吧，看来API成功了。我们可以在上面的输出中看到信息。对于这个特殊的例子，我只对显示我“6.5英里”的参数感兴趣——或者行程的距离。我们可以使用以下代码来访问该特定项目:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="2db7" class="kp ig hi kl b fi kq kr l ks kt">data['rows'][0]['elements'][0]['distance']['text']</span></pre><p id="a810" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这将输出字符串:“6.5英里”</p><p id="6fbb" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们稍后将处理字符串。</p><h2 id="1ed7" class="kp ig hi bd ih le lf lg il lh li lj ip jo lk ll it js lm ln ix jw lo lp jb lq bi translated">3.访问数据帧中所有值的API</h2><p id="1a42" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我们知道了如何访问API，我们希望对数据帧中的每一行都这样做。我首先将每个lat/long转换成它们自己的列表，并遍历每个列表项的API。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="c42c" class="kp ig hi kl b fi kq kr l ks kt">lat_origin = df['pickup_latitude'].tolist()<br/>long_origin = df['pickup_longitude'].tolist()<br/>lat_destination = df['dropoff_latitude'].tolist()<br/>long_destination = df['dropoff_longitude'].tolist()</span><span id="4c7f" class="kp ig hi kl b fi mf kr l ks kt">distance = []<br/>for i in range(len(long_destination)):<br/>    url = f"<a class="ae lc" href="https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&amp;origins={lat_origin[i]},{long_origin[i]}&amp;destinations={lat_desitnation[i]}%2C{long_destination[i]}&amp;key={google_key" rel="noopener ugc nofollow" target="_blank">https://maps.googleapis.com/maps/api/distancematrix/json?units=imperial&amp;origins={lat_origin[i]},{long_origin[i]}&amp;destinations={lat_destination[i]}%2C{long_destination[i]}&amp;key={google_key</a>}"<br/>    r=requests.get(url)<br/>    data = r.json()<br/>    try:<br/>        distance.append(data['rows'][0]['elements'][0]['distance']['text'])<br/>    except:<br/>        pass</span><span id="4a98" class="kp ig hi kl b fi mf kr l ks kt">distance</span></pre><figure class="kg kh ki kj fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es mh"><img src="../Images/0eb7b6420c83e43564785f41f93f88e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFhfqR2NEuaRgP5Fc4GbWg.png"/></div></div></figure><p id="492c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从上面的输出可以看到，我们现在有了一个距离列表，按照我们从API访问它们的顺序排列。</p><h2 id="dd45" class="kp ig hi bd ih le lf lg il lh li lj ip jo lk ll it js lm ln ix jw lo lp jb lq bi translated">4.清理数据并添加到数据帧</h2><p id="95b7" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">最后，我们将从列表中的每个项目中删除“mi ”,然后将新列表放入我们的原始数据帧中。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3006" class="kp ig hi kl b fi kq kr l ks kt">distance2 = []<br/>for i in range(len(distance)):<br/>    distance2.append(float((distance[i].replace(' mi', ''))))</span><span id="58f8" class="kp ig hi kl b fi mf kr l ks kt">df['Distance_in_Miles'] = distance2</span><span id="6b61" class="kp ig hi kl b fi mf kr l ks kt">df.head()</span></pre><figure class="kg kh ki kj fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es mi"><img src="../Images/2579cacb306c3cd86619e036f40501bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Khc2Q67zjFUNnTqC91y7-w.png"/></div></div></figure><p id="80f9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从上图中，您可以看到带有经度/纬度数据的原始数据框架，以及我们创建的新列，该列显示了每次旅行的行驶距离。</p><p id="589d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">有许多方法可以找到位置之间的距离，但是您必须了解哪种方法可以为您正在处理的项目或模型增加最大的价值。Google Maps API是一个有用的工具，可以用来查找两点之间的行驶距离。</p></div></div>    
</body>
</html>