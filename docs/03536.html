<html>
<head>
<title>Azure Function (Serverless concept) for creating a simple service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于创建简单服务的Azure函数(无服务器概念)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-function-serverless-concept-for-creating-a-simple-service-b1bc5a110c9?source=collection_archive---------15-----------------------#2020-02-06">https://medium.com/analytics-vidhya/azure-function-serverless-concept-for-creating-a-simple-service-b1bc5a110c9?source=collection_archive---------15-----------------------#2020-02-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="87f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无服务器的概念并不新鲜，但它的流行才开始不久。2014年，无服务器与Kubernetes同时出现。对于不同的服务提供商，无服务器的概念有不同的名称，在Azure或GCP中称为Function (fx ),而在AWS中称为know by lambda，在幕后它的工作原理是相同的。</p><p id="5536" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个演示中，我将使用Azure Function (fx ),但我将使用AWS来部署过去系列<a class="ae jd" rel="noopener" href="/delvify/bert-rest-inference-from-the-fine-tuned-model-499997b32851?source=friends_link&amp;sk=922b4670ed9f9673f2e47c9c972f8484">中的服务。让我们从简单的“你好，世界！”Azure模板。在本地机器上创建一个目录。一旦有了要使用的目录，就可以通过以下命令创建Azure函数(fx)。因为我们使用python作为我们的服务，所以init-worker是python。</a></p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="150d" class="jq jr hi jh b fi js jt l ju jv">(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ func init --worker-runtime python<br/>Found Python version 3.6.8 (python).<br/>Writing .gitignore<br/>Writing host.json<br/>Writing local.settings.json<br/>Writing /home/jugs/Desktop/azurefxDemo/.vscode/extensions.json<br/>(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ <br/>(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ tree<br/>.<br/>├── host.json<br/>├── local.settings.json<br/>└── requirements.txt</span><span id="0303" class="jq jr hi jh b fi jw jt l ju jv">0 directories, 3 files</span></pre><p id="6f05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建了以下配置文件，要了解文件的细节可以参考Azure Function文档页面，现在，我将跳过这些配置文件后面的细节。</p><p id="9fde" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以现在我们可以用函数命令<code class="du je jf jg jh b">func new --name exampledemo --template “Http trigger</code>从模板或“Hello World”创建一个最小的应用程序。这将创建一个具有给定名称和起始应用程序文件的新目录。下图展示了我们所看到的，</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="0af5" class="jq jr hi jh b fi js jt l ju jv">(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ func new --name exampledemo --template "Http trigger"<br/>Select a template: Http trigger<br/>Function name: [HttpTrigger] Writing /home/jugs/Desktop/azurefxDemo/exampledemo/__init__.py<br/>Writing /home/jugs/Desktop/azurefxDemo/exampledemo/function.json<br/>The function "exampledemo" was created successfully from the "Http trigger" template.<br/>(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ tree<br/>.<br/>├── exampledemo<br/>│   ├── function.json<br/>│   └── __init__.py<br/>├── host.json<br/>├── local.settings.json<br/>└── requirements.txt</span><span id="9f68" class="jq jr hi jh b fi jw jt l ju jv">1 directory, 5 files</span></pre><p id="8a26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">名为<code class="du je jf jg jh b">function.json</code>的文件是配置文件，<code class="du je jf jg jh b">__init__.py</code>是我们要使用的应用文件。只需这么多，您就可以使用函数run命令<code class="du je jf jg jh b">func start</code>运行本地主机web服务。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="dd4d" class="jq jr hi jh b fi js jt l ju jv">(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ func start<br/>Found Python version 3.6.8 (python).</span><span id="d85d" class="jq jr hi jh b fi jw jt l ju jv">%%%%%%<br/>                 %%%%%%<br/>            @   %%%%%%    @<br/>          @@   %%%%%%      @@<br/>       @@@    %%%%%%%%%%%    @@@<br/>     @@      %%%%%%%%%%        @@<br/>       @@         %%%%       @@<br/>         @@      %%%       @@<br/>           @@    %%      @@<br/>                %%<br/>                %</span><span id="1aaa" class="jq jr hi jh b fi jw jt l ju jv">Azure Functions Core Tools (2.7.1948 Commit hash: 29a0626ded3ae99c4111f66763f27bb9fb564103)<br/>Function Runtime Version: 2.0.12888.0<br/>...................<br/>...................</span><span id="c43c" class="jq jr hi jh b fi jw jt l ju jv">[2/5/20 3:48:08 AM] Job host started<br/>Hosting environment: Production<br/>Content root path: /home/jugs/Desktop/azurefxDemo<br/>Now listening on: <a class="ae jd" href="http://0.0.0.0:7071" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:7071</a><br/>Application started. Press Ctrl+C to shut down.</span><span id="e1dd" class="jq jr hi jh b fi jw jt l ju jv">Http Functions:</span><span id="77bf" class="jq jr hi jh b fi jw jt l ju jv">exampledemo: [GET,POST] <a class="ae jd" href="http://localhost:7071/api/exampledemo" rel="noopener ugc nofollow" target="_blank">http://localhost:7071/api/exampledemo</a></span><span id="79dd" class="jq jr hi jh b fi jw jt l ju jv">[2/5/20 3:48:08 AM]  INFO: Starting Azure Functions Python Worker.</span></pre><p id="d79f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您现在可以卷曲或使用您的浏览器来检查服务。这就是模板的样子。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="b848" class="jq jr hi jh b fi js jt l ju jv">(myvenv) jugs@jugs:~$ curl <a class="ae jd" href="http://localhost:7071/api/exampledemo" rel="noopener ugc nofollow" target="_blank">http://localhost:7071/api/exampledemo</a><br/>Please pass a name on the query string or in the request body(myvenv) jugs@jugs:~$ <br/>(myvenv) jugs@jugs:~$ <br/>(myvenv) jugs@jugs:~$ curl <a class="ae jd" href="http://localhost:7071/api/exampledemo?name=Azure%20Function" rel="noopener ugc nofollow" target="_blank">http://localhost:7071/api/exampledemo?name=Azure%20Function</a><br/>Hello Azure Function!</span></pre><p id="b98f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们都在本地主机中，让我们开始在Azure web服务中创建一个Azure函数，然后在Azure中推送和构建我们的程序。</p><ol class=""><li id="9534" class="jx jy hi ih b ii ij im in iq jz iu ka iy kb jc kc kd ke kf bi translated">从你的浏览器使用你的Azure登录凭证登录Azure <code class="du je jf jg jh b"> $ az login</code>。</li><li id="f39b" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">创建一个离你最近的资源组<code class="du je jf jg jh b">$ az group create --name myResGroup --location westeurope</code></li><li id="27ab" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">创建存储帐户<code class="du je jf jg jh b">$ az storage account create --name myStorageName --location westeurope --resource-group --myResGroup --sku standard_LRS</code>，您可以根据您的需求从列表中选择SKU。</li><li id="3905" class="jx jy hi ih b ii kg im kh iq ki iu kj iy kk jc kc kd ke kf bi translated">现在，一旦我们有了所有的成分，你就可以创建一个函数<code class="du je jf jg jh b">$ az functionapp create resource-group myResGroup --consumption-plan-location westeurope --name myAppName --storage-account myStorageName --runtime python</code>，对于<code class="du je jf jg jh b">--runtime</code>，我们应该指定语言作为我们的参数。</li></ol><p id="a267" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从Azure门户查看在资源组中创建的资源。最低要求应该是这样的。</p><figure class="ji jj jk jl fd km er es paragraph-image"><div class="er es kl"><img src="../Images/274ddba5cc5c875224ff7574a2306d1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*ZYAzHRM-wdaN_hjAd3qoxQ.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图:Azure功能资源组</figcaption></figure><p id="e5d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们可以将代码从本地推送到我们的Azure函数并构建<code class="du je jf jg jh b">$ az func azure functionapp publish myAppName --build remote</code>，这个命令会将你所有的代码和数据从本地推送到你的Azure资源组。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="b8ff" class="jq jr hi jh b fi js jt l ju jv">...............<br/>func azure functionapp publish simpleFuncClass --build remote<br/>Getting site publishing info...<br/>Creating archive for current directory...<br/>Performing remote build for functions project.<br/>Deleting the old .python_packages directory<br/>Uploading 132.48 KB [#############################################################################]<br/>Remote build in progress, please wait...<br/>Updating submodules.<br/>Preparing deployment for commit id 'a9ac5db900'.<br/>Repository path is /tmp/zipdeploy/extracted<br/>Running oryx build...<br/>Command: oryx build /tmp/zipdeploy/extracted -o /home/site/wwwroot --platform python --platform-version 3.6 -p packagedir=.python_packages/lib/python3.6/site-packages<br/>Build orchestrated by Microsoft Oryx, <a class="ae jd" href="https://github.com/Microsoft/Oryx" rel="noopener ugc nofollow" target="_blank">https://github.com/Microsoft/Oryx</a><br/>You can report issues at <a class="ae jd" href="https://github.com/Microsoft/Oryx/issues" rel="noopener ugc nofollow" target="_blank">https://github.com/Microsoft/Oryx/issues</a></span><span id="9b9b" class="jq jr hi jh b fi jw jt l ju jv">Oryx Version      : 0.2.20191018.1, Commit: b56054ad55c50d02d333db35752b7f0aee706ad5, ReleaseTagName: 20191018.1<br/>Build Operation ID: |Ta78ExE4dr0=.45926069_<br/>Repository Commit : a9ac5db9005d4a5d9bf926f173ee644a</span><span id="4b70" class="jq jr hi jh b fi jw jt l ju jv">..................<br/>..................<br/>Number of files 12066<br/>Number of fragments 925<br/>Number of symbolic links  0<br/>Number of device nodes 0<br/>Number of fifo nodes 0<br/>Number of socket nodes 0<br/>Number of directories 2636<br/>Number of ids (unique uids + gids) 1<br/>Number of uids 1<br/> root (0)<br/>Number of gids 1<br/> root (0)<br/>Uploading built content /home/site/deployments/functionappartifact.squashfs -&gt; <a class="ae jd" href="https://funcjugsstorage01.blob.core.windows.net/scm-releases/scm-latest-simpleFuncClass.zip?sv=2014-02-14&amp;sr=b&amp;sig=a6aGacuN2hIr9o2ThF6NYn%2Fj7uDyc5nSz4u6LNCsaBE%3D&amp;se=2030-01-27T04%3A24%3A44Z&amp;sp=rw" rel="noopener ugc nofollow" target="_blank">https://funcjugsstorage01.blob.core.windows.net/scm-releases/scm-latest-simpleFuncClass.zip?sv=2014-02-14&amp;sr=b&amp;sig=a6aGacuN2hIr9o2ThF6NYn%2Fj7uDyc5nSz4u6LNCsaBE%3D&amp;se=2030-01-27T04%3A24%3A44Z&amp;sp=rw</a><br/>Resetting all workers for simplefuncclass.azurewebsites.net<br/>Deployment successful.<br/>Remote build succeeded!<br/>Syncing triggers...<br/>Functions in simpleFuncClass:<br/>    HttpExample - [httpTrigger]<br/>        Invoke url: <a class="ae jd" href="https://simplefuncclass.azurewebsites.net/api/httpexample?code=c0U7ThcnusamBfmeaHuRAulAhC488PlKhVbnAbi2pdxVnqqjyvajlQ==" rel="noopener ugc nofollow" target="_blank">https://simplefuncclass.azurewebsites.net/api/httpexample?code=c0U7ThcnusamBpQRscAulAhC488PlKhVbnAbi2pdxVnqqjyvajlQ==</a></span></pre><p id="19de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">推送已经完成，并在Azure中构建了代码，现在您可以使用URL来检查您的应用程序是否正在运行。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="4b93" class="jq jr hi jh b fi js jt l ju jv">(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ curl <a class="ae jd" href="https://simplefuncclass.azurewebsites.net/api/httpexample?code=c0U7ThcnusamBfmeaHuRAulAhC488PlKhVbnAbi2pdxVnqqjyvajlQ==" rel="noopener ugc nofollow" target="_blank">https://simplefuncclass.azurewebsites.net/api/httpexample?code=c0U7ThcnusamBfmeaHuRAulAhC488PlKhVbnAbi2pdxVnqqjyvajlQ==</a><br/>Please pass a name on the query string or in the request body</span><span id="f025" class="jq jr hi jh b fi jw jt l ju jv">(myvenv) jugs@jugs:~/Desktop/azurefxDemo$ curl <a class="ae jd" href="https://simplefuncclass.azurewebsites.net/api/httpexample?code=c0U7ThcnusamBfmeaHuRAulAhC488PlKhVbnAbi2pdxVnqqjyvajlQ==&amp;name=Azure%20Function" rel="noopener ugc nofollow" target="_blank">https://simplefuncclass.azurewebsites.net/api/httpexample?code=c0U7ThcnusamBfmeaHuRAulAhC488PlKhVbnAbi2pdxVnqqjyvajlQ==&amp;name=Azure%20Function</a><br/>Hello Azure Function!</span></pre><p id="b341" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经完成了最简单的应用程序。让我们试试您现有的应用程序。在我的例子中，我有这个文本分类，它作为一个web服务在一个实际的应用程序中运行。我将使用无服务器使它可用。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="8220" class="jq jr hi jh b fi js jt l ju jv">jugs@jugs:~/Desktop/LocalFunctionProj$ tree<br/>.<br/>├── host.json<br/>├── HttpExample<br/>│   ├── function.json<br/>│   ├── host.json<br/>│   ├── __init__.py<br/>│   ├── prediction.py<br/>│   ├── __pycache__<br/>│   │   ├── __init__.cpython-36.pyc<br/>│   │   ├── prediction.cpython-36.pyc<br/>│   │   └── tokenization.cpython-36.pyc<br/>│   ├── tokenization.py<br/>│   └── vocab.txt<br/>├── local.settings.json<br/>└── requirements.txt</span><span id="597c" class="jq jr hi jh b fi jw jt l ju jv">2 directories, 12 files</span></pre><p id="78c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些是我创建的文件列表，我将展示文件的内容。首先，<code class="du je jf jg jh b">__init__.py</code>文件看起来像这样。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="57a9" class="jq jr hi jh b fi js jt l ju jv">import logging</span><span id="b658" class="jq jr hi jh b fi jw jt l ju jv">import azure.functions as func<br/>from . import prediction as pred</span><span id="483e" class="jq jr hi jh b fi jw jt l ju jv">def main(req: func.HttpRequest) -&gt; func.HttpResponse:<br/>    logging.info('Python HTTP trigger function processed a request.')</span><span id="0215" class="jq jr hi jh b fi jw jt l ju jv">name = req.params.get('name')<br/>    if not name:<br/>        try:<br/>            req_body = req.get_json()<br/>        except ValueError:<br/>            pass<br/>        else:<br/>            name = req_body.get('name')</span><span id="c058" class="jq jr hi jh b fi jw jt l ju jv">if name:<br/>        res = pred.predict(name)<br/>        return func.HttpResponse(f"Your query = {name} \n\nLabel = {res}!")<br/>    else:<br/>        return func.HttpResponse(<br/>             "Please pass a name on the query string or in the request body",<br/>             status_code=400<br/>        )</span></pre><p id="6a9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这个主函数中导入了<code class="du je jf jg jh b">prediction</code>类，以便能够使用它的方法。</p><p id="b150" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">prediction.py文件如下所示。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="5ac2" class="jq jr hi jh b fi js jt l ju jv">import json<br/>import requests<br/>import numpy as np<br/>from . import tokenization<br/>import argparse<br/>import os<br/>import urllib.request<br/>import pathlib</span><span id="1be3" class="jq jr hi jh b fi jw jt l ju jv">def get_query(query):<br/>  return query + "now new query"</span><span id="191a" class="jq jr hi jh b fi jw jt l ju jv">def predict(query):<br/>    query = query #request.args.get('text')</span><span id="1055" class="jq jr hi jh b fi jw jt l ju jv">endpoints = "<a class="ae jd" href="http://18.162.113.148:8501/v1/models/newchicclassifier:predict" rel="noopener ugc nofollow" target="_blank">http://1x.1xx.1x3.1x8:85xx/v1/models/myclassifier:predict</a>"<br/>    headers = {"content-type": "application-json"}</span><span id="ea3f" class="jq jr hi jh b fi jw jt l ju jv">filepath = pathlib.Path(__file__).parent / 'vocab.txt'</span><span id="9255" class="jq jr hi jh b fi jw jt l ju jv">tokenizer = tokenization.FullTokenizer(vocab_file=filepath, do_lower_case=True)</span><span id="e6f6" class="jq jr hi jh b fi jw jt l ju jv">........ <br/>Follow the previous tutorial for details<br/>........</span><span id="296b" class="jq jr hi jh b fi jw jt l ju jv">label_id = 0</span><span id="737c" class="jq jr hi jh b fi jw jt l ju jv">instances = [{"input_ids": input_ids, "input_mask": input_mask, "segment_ids": segment_ids, "label_ids": label_id}]</span><span id="e849" class="jq jr hi jh b fi jw jt l ju jv">data = json.dumps({"signature_name": "serving_default", "instances": instances})</span><span id="8808" class="jq jr hi jh b fi jw jt l ju jv">response = requests.post(endpoints, data=data, headers=headers, verify=False)<br/>    prediction = json.loads(response.text)['predictions']<br/>    idx_res = np.argmax(prediction)</span><span id="52fa" class="jq jr hi jh b fi jw jt l ju jv">with urllib.request.urlopen("<a class="ae jd" href="https://fashion-demo-assets.s3-ap-southeast-1.amazonaws.com/catDict.txt" rel="noopener ugc nofollow" target="_blank">https://myexample.s3-ap-southeast-1.amazonaws.com/catDict.txt</a>") as f:<br/>      data = f.readlines()</span><span id="ff34" class="jq jr hi jh b fi jw jt l ju jv">catlib = {}<br/>    for l in data:<br/>      strsplit = (l.decode('utf-8')).split('\t')<br/>      catlib[strsplit[1].strip()] = strsplit[0].strip()</span><span id="e465" class="jq jr hi jh b fi jw jt l ju jv">result = catlib[str(idx_res)]<br/>return result</span></pre><p id="0060" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">predict方法中的变量名<code class="du je jf jg jh b">endpoint</code>的值是我在AWS中运行的服务，你可以参考我以前关于提供BERT服务的博客来了解更多信息。<code class="du je jf jg jh b">tokenization.py</code>和<code class="du je jf jg jh b">vocab.txt</code>也来自伯特。此外，我将类别/标签列表作为AWS s3存储文件。</p><p id="e3aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du je jf jg jh b">requirement.txt</code>文件中添加所有python依赖项。</p><pre class="ji jj jk jl fd jm jh jn jo aw jp bi"><span id="987a" class="jq jr hi jh b fi js jt l ju jv">azure-functions<br/>tensorflow==1.14<br/>Pillow<br/>requests<br/>....</span></pre><p id="a3a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦全部完成，我们就可以使用相同的Azure Function命令行将代码推送到Azure。这个概念也融合了CI/CD的思想。推送的输出与前一个相同。我将使用推送产生的URL，并在终端中卷曲或检查浏览器。这是输出。</p><figure class="ji jj jk jl fd km er es paragraph-image"><div class="er es kt"><img src="../Images/8066453c698af713e03a99e61e51d4f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*wiUGz9mvrtvIPYBYsnGmCQ.png"/></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">图:Azure函数输出</figcaption></figure></div></div>    
</body>
</html>