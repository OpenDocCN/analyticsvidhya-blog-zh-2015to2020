<html>
<head>
<title>Put Deep Learning Image Classifier in Action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将深度学习图像分类器付诸行动</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/put-deep-learning-image-classifier-in-action-a956c4a9bc58?source=collection_archive---------8-----------------------#2020-01-23">https://medium.com/analytics-vidhya/put-deep-learning-image-classifier-in-action-a956c4a9bc58?source=collection_archive---------8-----------------------#2020-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="eae2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将基于fastai框架的图像分类器部署到heroku。查看github上的完整项目代码:【https://github.com/we-make-ai/detect-eye-diseases T2】</p><p id="4671" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在全球范围内，超过10亿人因未治疗的白内障(6520万)、青光眼(690万)和视网膜疾病(300万)而受到视力障碍或失明的影响。</p><p id="cf09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博文展示了如何使用<a class="ae jd" href="https://www.fast.ai/" rel="noopener ugc nofollow" target="_blank"> fast.ai框架</a>来检测眼部疾病——感谢杰瑞米·霍华德开发了这个奇妙的框架——并将模型部署到heroku这样的平台上(作为python web-app)。</p><p id="40a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">图像分类器能够将视网膜图像分类为以下4类之一:</strong></p><ul class=""><li id="1310" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">常态</li><li id="0dae" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">白内障</li><li id="6f95" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">青光眼</li><li id="7582" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">视网膜疾病</li></ul><p id="074e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用一个相当小的数据集进行训练，大约有300张来自kaggle比赛的图片:<a class="ae jd" href="https://www.kaggle.com/jr2ngb/cataractdataset/version/2" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/jr2ngb/cataractdataset/version/2</a></p><p id="664f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然数据集不是很大，但在迁移学习的帮助下，我获得了大约75%的准确率。浏览笔记本，我将解释我做了什么来展示如何使用fast.ai来解决图像分类器的问题。</p><p id="759d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">aveat:我没有和眼科医生讨论过这个结果。</p><p id="7168" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博客文章将关注部署完全训练好的模型的步骤。如果你对使用fastai框架更感兴趣，可以看看包含在项目github repo中的<a class="ae jd" href="http://detect_eye_diseases.ipynb" rel="noopener ugc nofollow" target="_blank"> jupyter笔记本文件</a>。</p><h1 id="11bd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">数据集</h1><p id="cf90" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">让我们来看看一些训练数据:</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es kw"><img src="../Images/a1208035682f79a414a12fb693fdca29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGtZnkJ0jsg81b8_m5ZxYg.png"/></div></div></figure><p id="072b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还显示了混淆矩阵:</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es li"><img src="../Images/6b12090fdf1ab0e1ccea103bfa1efa42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*caYtDQrTY2du6kwfb5-EbA.png"/></div></div></figure><p id="c2fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终模型的准确率约为75%。第一次尝试还不错。</p><h1 id="f43a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">导出模型</h1><p id="6593" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">训练完模型后，我们必须导出它:</p><pre class="kx ky kz la fd lj lk ll lm aw ln bi"><span id="7f3c" class="lo ju hi lk b fi lp lq l lr ls">learn.export()</span></pre><p id="0fb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该函数将模型保存到项目路径(export.pkl)中。</p><p id="8098" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望使用一个低成本的cpu实例来进行预测。因此，我们必须将模型放在cpu上，而不是gpu上。</p><pre class="kx ky kz la fd lj lk ll lm aw ln bi"><span id="97fb" class="lo ju hi lk b fi lp lq l lr ls">defaults.device = torch.device(‘cpu’)</span></pre><p id="d075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以使用load_learner(PROJECT_PATH)在我们的web应用程序中重新加载模型。</p><h1 id="9405" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">创建Web应用程序</h1><p id="1f82" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">starlette框架是一种在网络上部署我们的模型的简单方法。我们可以使用任何网络前端来访问我们的模型。</p><p id="ce00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们必须实现服务于我们模型的webapp文件。</p><p id="d970" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就看我在github 上的<a class="ae jd" href="https://github.com/we-make-ai/detect-eye-diseases/blob/master/detect-eye-diseases.py" rel="noopener ugc nofollow" target="_blank">实现吧。Starlette非常简单，只需定义一个路由和实现代码来提供一个API-Backend。对于这个简单的演示，我只使用静态HTML，但你也可以实现任何javascript前端客户端。</a></p><p id="a042" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了Jeremy的存储库中的模板代码:<a class="ae jd" href="https://github.com/render-examples/fastai-v3/blob/master/app/server.py" rel="noopener ugc nofollow" target="_blank">https://github . com/render-examples/fastai-v3/blob/master/app/server . py</a></p><p id="b8bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了访问分类器，我提供了上传图像或粘贴图像URL的功能。</p><pre class="kx ky kz la fd lj lk ll lm aw ln bi"><span id="a982" class="lo ju hi lk b fi lp lq l lr ls">@app.route(“/upload”, methods=[“POST”])async def upload(request): data = await request.form() bytes = await (data[“file”].read()) return predict_image_from_bytes(bytes) </span><span id="cee0" class="lo ju hi lk b fi lt lq l lr ls">@app.route(“/classify-url”, methods=[“GET”])async def classify_url(request): bytes = await get_bytes(request.query_params[“url”]) return predict_image_from_bytes(bytes)</span></pre><h1 id="f740" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设置heroku应用程序</h1><p id="bcf5" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">为了建立部署管道，我将github存储库与heroku集成在一起。只需创建一个新应用程序:</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lu"><img src="../Images/2e017f0fb67e8b1f2ab0ce0baef5d5e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btgfUEkCkXXjGpvy854OJw.png"/></div></div></figure><p id="5e78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<strong class="ih hj">新建</strong>，选择<strong class="ih hj">创建新应用</strong>。</p><p id="920f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为您的应用程序选择一个名称，并在附近选择一个部署区域。然后点击“<strong class="ih hj">创建App </strong>”。</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lv"><img src="../Images/a5477fd78c60ac99181e47eb78a4c0b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T3t8y5wzSfeXiPx3hYfasw.png"/></div></div></figure><p id="7579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，你去“连接到GitHub”部分。选择您的github组织/帐户以及您想要链接到应用程序的存储库。</p><p id="a759" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">也许你必须在你的github帐号上安装heroku插件，以允许heroku访问你的库。</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lw"><img src="../Images/f3ef67118496d3501bc715a24e33b860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cArHABKcF0k5KvVgYm4R5A.png"/></div></div></figure><p id="38ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，每当你在github repo上推你的主分支时，heroku会在你的应用程序上构建并部署一个新版本。您可以在“Activity”选项卡上看到构建过程的日志。</p><p id="21b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，您还可以使用heroku cli工具。安装CLI-tools(<a class="ae jd" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener ugc nofollow" target="_blank">https://devcenter.heroku.com/articles/heroku-cli</a>)后，只需登录您的终端并键入:</p><pre class="kx ky kz la fd lj lk ll lm aw ln bi"><span id="41bc" class="lo ju hi lk b fi lp lq l lr ls">heroku logs -t — app=NAME_OF_YOUR_APP</span></pre><p id="47cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您需要更细粒度的部署，您甚至可以使用不同的分支进行暂存。只需将您的应用程序连接到管道。</p><h1 id="dd48" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">部署所需的附加文件</strong></h1><p id="b227" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">将这些文件添加到您的存储库中:</p><p id="a669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Procfile </strong>(没有任何文件扩展名！).该文件包含heroku应用程序启动时的命令:</p><pre class="kx ky kz la fd lj lk ll lm aw ln bi"><span id="46fa" class="lo ju hi lk b fi lp lq l lr ls">heroku ps:scale web=0<br/>heroku ps:scale web=1<br/>web: uvicorn ./app/detect-eye-diseases:app — host=0.0.0.0 — port=${PORT:-5000}</span></pre><p id="6e7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我必须添加“heroku ps:scale web=0”和“heroku ps:scale web=1”来停用和激活我的应用程序的dyno。我认为这也可以通过仪表板来完成。</p><p id="a217" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> requirement.txt </strong>指定你的python模块。你需要什么就选什么。</p><p id="cb0f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> runtime.txt </strong>指定基本系统。我使用python 3.7.2</p><p id="9b6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">。赫鲁库允许一个最大值。段塞大小为500MB。添加部署时不需要的repo中的任何文件，以减少slugsize。该文件的工作方式类似于. gitignore文件。</strong></p><h1 id="b172" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">我为什么选择heroku进行部署？</h1><p id="35e6" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">首先:Heroku对于小型演示应用是免费的。如果你想运行一个生产应用，你需要更多的能量，更多的能量意味着"<em class="js">请投入更多的硬币……</em>"</p><p id="6a90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二，部署过程相当简单(如果你第一次就克服了困难……)</p><h1 id="2d72" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">我在哪里可以找到这个伟大的应用程序？</h1><p id="1541" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">就去https://detect-eye-diseases.herokuapp.com/</p><p id="45ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果需要一些医学影像进行检测:<a class="ae jd" href="https://www.medicinenet.com/image-collection/retinal_detachment_picture/picture.htm" rel="noopener ugc nofollow" target="_blank">https://www . medicine net . com/image-collection/retinal _ detachment _ picture/picture . htm</a></p><p id="33c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看github上的完整源代码:【https://github.com/we-make-ai/detect-eye-diseases T4】</p><p id="0754" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果想了解更多，关于如何利用pytorch和fastai从深度学习中获得最大收益，让我们看看我们的人工智能学院:<a class="ae jd" href="https://academy.we-make.ai/courses/" rel="noopener ugc nofollow" target="_blank">https://academy.we-make.ai/courses/</a>。</p><h1 id="a11f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">我是谁？</h1><p id="64b2" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">我是提供人工智能服务的公司we-make.ai的创始人之一。我们是一个由管理顾问和软件工程师组成的团队，专注于人工智能(尤其是深度学习)。</p><p id="7c1d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你对我们关于如何用人工智能改变商业的想法感兴趣？看看我们的新书吧！可通过亚马逊购买。</p><p id="8ed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://amzn.to/2TUimWL" rel="noopener ugc nofollow" target="_blank">https://amzn.to/2TUimWL</a></p><figure class="kx ky kz la fd lb er es paragraph-image"><div class="er es lx"><img src="../Images/e29c27c4b93a1611094044b41354eba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*s3E26wIggDVtX6CB4Gk_MQ.png"/></div></figure></div></div>    
</body>
</html>