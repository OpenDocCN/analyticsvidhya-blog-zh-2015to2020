<html>
<head>
<title>Containerize R API with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Docker封装R API</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/containerize-r-api-with-docker-da3d8f3df110?source=collection_archive---------14-----------------------#2020-04-01">https://medium.com/analytics-vidhya/containerize-r-api-with-docker-da3d8f3df110?source=collection_archive---------14-----------------------#2020-04-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5690" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，数据科学家花大部分时间训练和可视化他们的模型。他们不太重视部署。</p><p id="d4a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是如果他们不得不将它部署到生产环境中呢？好吧，他们可以部署它，但是如果生产环境不同于他们当前的环境呢？假设，他们正在开发一个ubuntu系统，生产环境是Fedora。因此，在安装时，他们会得到大量的错误，它不会工作。那这个解决办法是什么？有很多解决方法。一种方法是使用Docker将其打包。有了docker，它就变得与环境无关了。</p><h1 id="036a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">码头工人</h1><p id="1796" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">使用容器可以更快地构建和部署新应用程序。Docker容器将软件及其依赖项包装成一个标准化的软件开发单元，其中包括运行所需的一切:代码、运行时、系统工具和库。这保证了您的应用程序将总是运行相同的，并使协作像共享容器映像一样简单。</p><p id="25a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Docker容器无论是Windows还是Linux都有Docker工具和API做后盾，帮助你构建更好的软件。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kg"><img src="../Images/6cab8d78b8f446d36fc4c68a7ea35d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*T-8mYIEICu6Zos304xSxrw.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx translated">码头工人</figcaption></figure><p id="e185" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上图显示了这些容器是如何相互独立的。</p><h1 id="f6b7" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">让我们开始吧…</h1><h1 id="9d79" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">先决条件</h1><p id="2c14" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">你需要在你的系统中安装docker。如果没有，请通过以下链接安装它:</p><p id="9e53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">https://docs.docker.com/install/linux/docker-ce/centos/</p><p id="8a07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">黛比安:https://docs.docker.com/install/linux/docker-ce/debian/<a class="ae ks" href="https://docs.docker.com/install/linux/docker-ce/debian/" rel="noopener ugc nofollow" target="_blank"/></p><p id="ed62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">软呢帽:【https://docs.docker.com/install/linux/docker-ce/fedora/】T4</p><p id="3945" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ubuntu:<a class="ae ks" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p><p id="3f68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">二进制:<a class="ae ks" href="https://docs.docker.com/install/linux/docker-ce/binaries/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/install/linux/docker-ce/binaries/</a></p><p id="ad31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可选:以非超级用户身份管理docker。</p><div class="kt ku ez fb kv kw"><a href="https://docs.docker.com/install/linux/linux-postinstall/" rel="noopener  ugc nofollow" target="_blank"><div class="kx ab dw"><div class="ky ab kz cl cj la"><h2 class="bd hj fi z dy lb ea eb lc ed ef hh bi translated">Linux的安装后步骤</h2><div class="ld l"><h3 class="bd b fi z dy lb ea eb lc ed ef dx translated">本节包含配置Linux主机以更好地使用Docker的可选过程。Docker守护进程…</h3></div><div class="le l"><p class="bd b fp z dy lb ea eb lc ed ef dx translated">docs.docker.com</p></div></div><div class="lf l"><div class="lg l lh li lj lf lk km kw"/></div></div></a></div><p id="e7f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一旦你安装了docker，让我们开始吧。</p><p id="fa29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您的项目目录结构如下:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ll"><img src="../Images/780842d60c1cc95711cc8c066d070d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:626/format:webp/1*yIHMpBYexahQzDYlsDO6TA.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx translated">项目结构</figcaption></figure><p id="3f20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里R_demo是项目根目录。RFiles是一个目录，可以包含您的R文件(rds对象、R API等等)。api。r是包含您想要公开的API的r文件。</p><p id="7cb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，将Dockerfile放在项目目录下，如下所示:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lm"><img src="../Images/7be46a3590ce68564096814ada35857b.png" data-original-src="https://miro.medium.com/v2/resize:fit:616/format:webp/1*Jq4r_Augodee5MnhGDlmWQ.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx translated">放置Dockerfile后的项目结构</figcaption></figure><p id="0ec9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按如下方式更新Dockerfile文件:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="d200" class="ls je hi lo b fi lt lu l lv lw">FROM rocker/r-ver:3.4.1</span><span id="592f" class="ls je hi lo b fi lx lu l lv lw">EXPOSE 80</span><span id="de5d" class="ls je hi lo b fi lx lu l lv lw">ENV WORKON_HOME $HOME/.virtualenvs</span><span id="9147" class="ls je hi lo b fi lx lu l lv lw">LABEL version=”1.0"</span><span id="79e8" class="ls je hi lo b fi lx lu l lv lw">RUN apt-get update -qq &amp;&amp; apt-get install -y \</span><span id="4854" class="ls je hi lo b fi lx lu l lv lw">default-jre \</span><span id="ccd9" class="ls je hi lo b fi lx lu l lv lw">default-jdk \</span><span id="8413" class="ls je hi lo b fi lx lu l lv lw">libssl-dev \</span><span id="ddce" class="ls je hi lo b fi lx lu l lv lw">libcurl4-gnutls-dev \</span><span id="3e75" class="ls je hi lo b fi lx lu l lv lw">zlib1g-dev \</span><span id="9cc3" class="ls je hi lo b fi lx lu l lv lw">libssh2–1-dev \</span><span id="f67e" class="ls je hi lo b fi lx lu l lv lw">libbz2-dev \</span><span id="1f27" class="ls je hi lo b fi lx lu l lv lw">libicu-dev \</span><span id="4151" class="ls je hi lo b fi lx lu l lv lw">liblzma-dev \</span><span id="a790" class="ls je hi lo b fi lx lu l lv lw">libxml2-dev \</span><span id="2527" class="ls je hi lo b fi lx lu l lv lw">libpcre3-dev &amp;&amp; \</span><span id="7ed2" class="ls je hi lo b fi lx lu l lv lw">R CMD javareconf &amp;&amp; \</span><span id="f217" class="ls je hi lo b fi lx lu l lv lw">R -e ‘install.packages(c(“plumber”,”dplyr”,”stringr”,”jtools”,”forecast”,”tidyverse”,”tidyquant”,”magrittr”,”glmnet”,”e1071",”rpart”,”reshape2",”MLmetrics”,”TSPred”,”sweep”,”bsts”))’</span><span id="4d0b" class="ls je hi lo b fi lx lu l lv lw">COPY . .</span></pre><p id="9c30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用R模型所需的软件包更新install.packages。</p><p id="e1c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">放置Dockerfile后，放置您的主。您的项目目录下的r文件如下:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ly"><img src="../Images/85c7511cfaa698f9df62f56051c8cc79.png" data-original-src="https://miro.medium.com/v2/resize:fit:610/format:webp/1*ZEZHd-BhAeG5ouGnCCHwBA.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx translated">放置干管后的项目结构。r文件</figcaption></figure><p id="fe09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新main。r文件如下:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="1dd4" class="ls je hi lo b fi lt lu l lv lw"># This code is just for running that plumber file</span><span id="1355" class="ls je hi lo b fi lx lu l lv lw">library(plumber)</span><span id="28ca" class="ls je hi lo b fi lx lu l lv lw">plumber::plumb(“api.R”)$run(host=”0.0.0.0",port= 8765)</span></pre><p id="dc73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将运行您的服务器。</p><p id="cd0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，用入口点更新Dockerfile文件。这个入口点告诉docker，一旦构建了docker容器，要运行什么。</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="f810" class="ls je hi lo b fi lt lu l lv lw">ENTRYPOINT [“Rscript”,”main.R”]</span></pre><p id="4c93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，Dockerfile文件变成了:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="5939" class="ls je hi lo b fi lt lu l lv lw">FROM rocker/r-ver:3.4.1</span><span id="ec59" class="ls je hi lo b fi lx lu l lv lw">EXPOSE 80</span><span id="a3c7" class="ls je hi lo b fi lx lu l lv lw">ENV WORKON_HOME $HOME/.virtualenvs</span><span id="049b" class="ls je hi lo b fi lx lu l lv lw">LABEL version=”1.0"</span><span id="4f88" class="ls je hi lo b fi lx lu l lv lw">LABEL description=”Group DnA’s AI/ML product for TAF.”</span><span id="d9b7" class="ls je hi lo b fi lx lu l lv lw">RUN apt-get update -qq &amp;&amp; apt-get install -y \</span><span id="fdaa" class="ls je hi lo b fi lx lu l lv lw">default-jre \</span><span id="1f65" class="ls je hi lo b fi lx lu l lv lw">default-jdk \</span><span id="c4d9" class="ls je hi lo b fi lx lu l lv lw">libssl-dev \</span><span id="7137" class="ls je hi lo b fi lx lu l lv lw">libcurl4-gnutls-dev \</span><span id="afec" class="ls je hi lo b fi lx lu l lv lw">zlib1g-dev \</span><span id="70bb" class="ls je hi lo b fi lx lu l lv lw">libssh2–1-dev \</span><span id="68ea" class="ls je hi lo b fi lx lu l lv lw">libbz2-dev \</span><span id="9eb7" class="ls je hi lo b fi lx lu l lv lw">libicu-dev \</span><span id="e3b3" class="ls je hi lo b fi lx lu l lv lw">liblzma-dev \</span><span id="89cd" class="ls je hi lo b fi lx lu l lv lw">libxml2-dev \</span><span id="a145" class="ls je hi lo b fi lx lu l lv lw">libpcre3-dev &amp;&amp; \</span><span id="b86d" class="ls je hi lo b fi lx lu l lv lw">R CMD javareconf &amp;&amp; \</span><span id="06b2" class="ls je hi lo b fi lx lu l lv lw">R -e ‘install.packages(c(“plumber”,”dplyr”,”stringr”,”jtools”,”forecast”,”tidyverse”,”tidyquant”,”magrittr”,”glmnet”,”e1071",”rpart”,”reshape2",”MLmetrics”,”TSPred”,”sweep”,”bsts”))’</span><span id="1c5a" class="ls je hi lo b fi lx lu l lv lw">COPY . .</span><span id="58f1" class="ls je hi lo b fi lx lu l lv lw">ENTRYPOINT [“Rscript”,”main.R”]</span></pre><p id="1f68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦设置就绪，就该运行它了。</p><p id="6098" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，您必须构建docker映像，然后运行它。现在，打开终端，在项目的根目录下运行以下命令:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="99b2" class="ls je hi lo b fi lt lu l lv lw">$ docker build -t &lt;image_name&gt; .</span></pre><p id="1076" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="ee3b" class="ls je hi lo b fi lt lu l lv lw">$ docker build -t r_test .</span></pre><p id="2dea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该命令将构建docker映像。</p><p id="dfe7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦docker图像形成，就将容器制作成:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="e9b0" class="ls je hi lo b fi lt lu l lv lw">$ docker run -p 8765:8765 --name &lt;container-name&gt; &lt;image-name&gt;</span></pre><p id="aa2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="3772" class="ls je hi lo b fi lt lu l lv lw">$ docker run -p 8765:8765 --name r_test r_test</span></pre><p id="f56a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查您的docker图像:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="b729" class="ls je hi lo b fi lt lu l lv lw">$ docker images</span></pre><p id="58e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到自己制作的容器:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="6db7" class="ls je hi lo b fi lt lu l lv lw">$ docker ps</span></pre><p id="c2b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，检查API结果，如下所示</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="761b" class="ls je hi lo b fi lt lu l lv lw">http://127.0.0.1:8765/&lt;your-api-end-point&gt;</span></pre><p id="333e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您也可以使用您的IP地址进行检查，如下所示:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="29f3" class="ls je hi lo b fi lt lu l lv lw">http://&lt;your-IP&gt;:8765/&lt;your-api-end-point&gt;</span></pre><p id="5d24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者使用curl命令:</p><pre class="kh ki kj kk fd ln lo lp lq aw lr bi"><span id="7d19" class="ls je hi lo b fi lt lu l lv lw">curl http://127.0.0.1:8765/&lt;your-api-end-point&gt;</span></pre></div></div>    
</body>
</html>