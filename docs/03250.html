<html>
<head>
<title>Training your own Data set using Mask R-CNN for Detecting Multiple Classes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Mask R-CNN训练您自己的数据集以检测多个类别</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/training-your-own-data-set-using-mask-r-cnn-for-detecting-multiple-classes-3960ada85079?source=collection_archive---------0-----------------------#2020-01-22">https://medium.com/analytics-vidhya/training-your-own-data-set-using-mask-r-cnn-for-detecting-multiple-classes-3960ada85079?source=collection_archive---------0-----------------------#2020-01-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f769" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">掩模R-CNN是用于对象检测和分割的流行模型。</p><p id="1daa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">图像分类有四种主要/基本类型:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/fd1026edcdacb62ca378ec9f55771fb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQ_C4LBfFo0s2FzWnIXp8g.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图片本身不言自明，现在我们正在处理实例分割[图片鸣谢:Slide 19<a class="ae jt" href="http://cs231n.stanford.edu/slides/2017/cs231n_2017_lecture11.pdf" rel="noopener ugc nofollow" target="_blank">http://cs 231n . Stanford . edu/slides/2017/cs 231n _ 2017 _ lecture 11 . pdf</a>]</figcaption></figure><h1 id="190e" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated"><strong class="ak"> <em class="ks">目标</em> </strong></h1><p id="7250" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">训练模型，使其能够区分(屏蔽)图像中的不同类别(如猫、狗、汽车等)，同时精确屏蔽每个类别。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/21f31e19ec08dc9da824199dada3768e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jpt0u5zHgdAXht8blZqb9A.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">这是它实际上的样子</figcaption></figure><p id="0bd3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从头开始，第一步是注释我们的数据集，接下来是训练模型，接下来是使用结果权重来预测/分割图像中的类。</p><h1 id="17af" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated"><strong class="ak"> <em class="ks">让我们潜入</em> </strong></h1><ul class=""><li id="1174" class="kz la hi ih b ii kt im ku iq lb iu lc iy ld jc le lf lg lh bi translated">首先打开注释器[<a class="ae jt" href="https://www.robots.ox.ac.uk/~vgg/software/via/via_demo.html" rel="noopener ugc nofollow" target="_blank">https://www.robots.ox.ac.uk/~vgg/software/via/via_demo.html</a>]，</li><li id="14e3" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">通过选择<strong class="ih hj">项目</strong>-&gt;-<strong class="ih hj">添加本地文件来加载图像。</strong></li><li id="8a2a" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">标记所有图像后，导出注释(作为json)。</li><li id="7007" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">我们正在使用最新版本的VGG在线工具。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ln"><img src="../Images/46ea9854c9316a9831eef0f1634c0d82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ezvvnpXyjRXeYemGrqQmA.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">确保您选择了多边形工具，对于其他工具，请更新与该工具对应的代码</figcaption></figure><p id="43a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将图像分离到两个文件夹中，用于训练(train)和验证(val)，理想情况下比例为3:2。项目结构应该如下所示:</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="221c" class="lt jv hi lp b fi lu lv l lw lx">Project<br/>|-- logs (created after training)<br/>|   `-- weights.h5<br/>`-- main<br/>    |-- dataset<br/>    |   |-- train<br/>    |   `-- val<br/>    `-- Mask_RCNN<br/>        |-- train.py<br/>        |-- .gitignore<br/>        |-- LICENCE<br/>        `-- etc..</span></pre><p id="c315" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于谷歌colab，它免费提供13GB的GPU，可以连续使用12小时(谷歌通过提供免费资源将ML领域推向了一个新的水平👏🏻👏🏻).</p><p id="9b34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在无缘无故的，给你一句让人大开眼界的台词——“<em class="ly">有些人有命；有些人有面具</em>，你知道谁有这两样吗😉。</p><p id="6f92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的Mask_RCNN文件夹是GitHub中的下载zip文件选项:<a class="ae jt" href="https://github.com/matterport/Mask_RCNN" rel="noopener ugc nofollow" target="_blank">https://github.com/matterport/Mask_RCNN</a>，对于<strong class="ih hj"> train.py </strong>文件和<strong class="ih hj"> model.ipynb </strong>文件参考我的GitHub:<a class="ae jt" href="https://github.com/SriRamGovardhanam/wastedata-Mask_RCNN-multiple-classes" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/SriRamGovardhanam/wastedata-Mask _ RCNN-multiple-classes</a></p><p id="dd09" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我对Mask _ RCNN/samples/balloon/balloon . py中可用的实际代码做了一些修改。</p><p id="386d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj">配置</strong>部分，<strong class="ih hj"> </strong>根据需求<br/> NUM_CLASSES = 1 + 4 #背景+类别数改变类别数</p><p id="22ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj">数据集</strong>部分，修改现有代码如下</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="dace" class="lt jv hi lp b fi lu lv l lw lx">class CustomDataset(utils.Dataset):</span><span id="a9f3" class="lt jv hi lp b fi lz lv l lw lx">def load_custom(self, dataset_dir, subset) #Add classes as per your requirement and order<br/>        self.add_class('object', 1, 'bottle')<br/>        self.add_class('object', 2, 'glass')<br/>        self.add_class('object', 3, 'paper')<br/>        self.add_class('object', 4, 'trash')</span><span id="18c8" class="lt jv hi lp b fi lz lv l lw lx">assert subset in ['train', 'val']<br/>        dataset_dir = os.path.join(dataset_dir, subset)<br/>annotations = json.load(open(os.path.join(dataset_dir,<br/>                                 'via_region_data.json')))<br/>annotations = list(annotations.values()) <br/>annotations = [a for a in annotations if a['regions']]<br/>for a in annotations:<br/>            polygons = [r['shape_attributes'] for r in a['regions']]<br/>            objects = [s['region_attributes'] for s in a['regions']]<br/>            num_ids = []<br/>            for n in objects:<br/>                print one<br/>                print n<br/>                try:<br/>                    if n['object'] == 'bottle':<br/>                        num_ids.append(1)<br/>                    elif n['object'] == 'glass':<br/>                        num_ids.append(2)<br/>                    elif n['object'] == 'paper':<br/>                        num_ids.append(3)<br/>                    elif n['object'] == 'trash':<br/>                        num_ids.append(4)<br/>                except:<br/>                    pass</span><span id="8690" class="lt jv hi lp b fi lz lv l lw lx">image_path = os.path.join(dataset_dir, a['filename'])<br/>            image = skimage.io.imread(image_path)<br/>            (height, width) = image.shape[:2]</span><span id="0008" class="lt jv hi lp b fi lz lv l lw lx">self.add_image(  <br/>                'object',<br/>                image_id=a['filename'],<br/>                path=image_path,<br/>                width=width,<br/>                height=height,<br/>                polygons=polygons,<br/>                num_ids=num_ids,<br/>                )</span><span id="33a7" class="lt jv hi lp b fi lz lv l lw lx"># also change the return value of def load_mask()</span><span id="7e7d" class="lt jv hi lp b fi lz lv l lw lx">num_ids = np.array(num_ids, dtype=np.int32)<br/>return mask, num_ids</span></pre><p id="579d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过这些改变后，我们现在能够训练多个类。</p><p id="9a97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开终端-&gt;转到文件train.py目录并使用以下命令。</p><pre class="je jf jg jh fd lo lp lq lr aw ls bi"><span id="107b" class="lt jv hi lp b fi lu lv l lw lx">python3 train.py train - dataset='dataset path'  weights=coco</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/3492ba4626f57a7df81b4eedc59446aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KUMj8HzaC4TkrwWnR4zLfQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">现在我们在日志文件夹中得到每个历元的权重</figcaption></figure><p id="adc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们已经获得了模型的权重，现在我们检查并在inspect_model_data.ipynb文件中保存所需的权重。为此我们需要逃跑。jupyter笔记本中的ipynb文件。所以打开jupyter笔记本，在笔记本里仔细更新数据集路径和weight.h5路径。</p><h1 id="6a41" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结果</h1><p id="00a7" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">这里我们定义了4个类:</p><ul class=""><li id="940c" class="kz la hi ih b ii ij im in iq ma iu mb iy mc jc le lf lg lh bi translated">瓶子</li><li id="212f" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">玻璃</li><li id="c9c1" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">纸</li><li id="894a" class="kz la hi ih b ii li im lj iq lk iu ll iy lm jc le lf lg lh bi translated">废物</li></ul><p id="8fae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是模型准确性的示例</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/a5970354bfe47983ef662b64fc178328.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AAKmU3LGqNcWmDT_9Rd0Ng.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">玻璃预测</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ky"><img src="../Images/050935fcd14e22d48fe1d02eba003e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6CWpO9EswbFssGDBX_Znw.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">左边是不同类的输入，输入图片本身就是一个拼贴画</figcaption></figure><p id="1746" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们只是对matter port的mask-rcnn的原始代码做了一点调整，它确实具有所有的逐步检测功能</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/e6bd7e1810e6440a992adb0fc5630a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g_fm45eodO-PiYlSIQ2R9Q.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">彩色飞溅</figcaption></figure><div class="je jf jg jh fd ab cb"><figure class="me ji mf mg mh mi mj paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><img src="../Images/cfb5429a8bbedf098c8db8790b216e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/format:webp/1*w5oGBFaaZTDIqkRUHaTshA.png"/></div></figure><figure class="me ji mk mg mh mi mj paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><img src="../Images/9044f806db89e8a95a1117e453e9a6bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*KbMPmkU6nzYjs4INxTfsAg.png"/></div></figure><figure class="me ji ml mg mh mi mj paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><img src="../Images/2e95b4eaaea240f8815a5d9c5b4f500e.png" data-original-src="https://miro.medium.com/v2/resize:fit:474/format:webp/1*GGlbY6Bs5a5qbl7VHNNTUg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx mm di mn mo translated">锚排序和过滤</figcaption></figure></div><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/574a9b6958a06da7fb7b1133dee1bd62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OPEzwzoDyqKB0cxfgVZGQw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">包围盒预测</figcaption></figure><div class="je jf jg jh fd ab cb"><figure class="me ji mq mg mh mi mj paragraph-image"><img src="../Images/56b73eb96c9eee277a2ff60c8a5f6d3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:354/format:webp/1*pCW5qM4MHYP1hi97M09hrw.png"/></figure><figure class="me ji mq mg mh mi mj paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><img src="../Images/e43134a1beff3b794a49f8059ca9d49a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*EfWfq_Tt30gdqWmgTbRTsQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx mr di ms mo translated">玻璃面具和预言</figcaption></figure></div><h1 id="7aa2" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">密码</h1><p id="d0f3" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">代码完整的实现细节可以在<a class="ae jt" href="https://github.com/SriRamGovardhanam/wastedata-Mask_RCNN-multiple-classes" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="050c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="144d" class="pw-post-body-paragraph if ig hi ih b ii kt ik il im ku io ip iq kv is it iu kw iw ix iy kx ja jb jc hb bi translated">我们学习了多个类的像素分割，我希望你理解这篇文章，如果你有任何问题，请在下面评论。蒙版的边缘可以通过增加数据和仔细标记来改善，或者那些哑像素不是周围最亮的像素(糟糕的双关语是眼球转动的方式)。</p></div></div>    
</body>
</html>