<html>
<head>
<title>How to predict churn customers using machine learning : Sparkify project.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用机器学习预测流失客户:Sparkify项目。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-predict-churn-customers-using-machine-learning-sparkify-project-7b8a688b4455?source=collection_archive---------27-----------------------#2020-05-18">https://medium.com/analytics-vidhya/how-to-predict-churn-customers-using-machine-learning-sparkify-project-7b8a688b4455?source=collection_archive---------27-----------------------#2020-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fa41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于pyspark的流媒体服务客户流失预测。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/478f5948b637b9ee2ba9b8203d76d908.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*YBdrFndFl6jWrMiuE-gY6w.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图一。Sparkify流媒体服务</figcaption></figure><p id="5e0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于Sparkify这样的流媒体服务公司来说，有很多方法可以创收。商业模式之一是付费订阅。这在很大程度上取决于用户对服务的满意度。为了将用户留在平台上，流媒体服务可以使用一些方法，如免费试用或免费延长订阅期。他们可以通过瞄准将在不久的将来离开的用户群来使这种方法更加有效。现在的问题是，哪个用户在取消订阅之前需要额外的关注？</p><p id="4232" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是<strong class="ih hj">流失预测</strong>发挥作用的地方。在这个项目中，我使用机器学习模型来预测哪个用户将在不久的将来离开。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="eade" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">数据集</strong></h1><p id="662d" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在这个项目中，我使用由Udacity提供的Sparkify的基于事件的数据集。该数据集记录特定用户点击或访问事件。因此，例如当用户访问主页时，该事件将被记录在该数据集中。在图2中，我们可以看到播放下一首歌曲的用户记录的事件。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es kz"><img src="../Images/8672a9f44d499d820eb0f6eb524d145c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_mGrXcOd0HZ4WJa1kc4W0A.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图二。数据集的样本。</figcaption></figure><p id="3bdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是完整列的列表和说明:</p><ul class=""><li id="88bc" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">艺人:歌曲中的艺人名称</li><li id="dc21" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">auth:身份验证方法，登录或注销。</li><li id="2b7e" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">名字:用户的名字</li><li id="70f7" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">性别:用户性别，' M '或' F '。</li><li id="387d" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">itemInSession:会话序列的编号。如果我们在图2中看到，这意味着用户播放nextsong是用户在这个会话中做的第50个事件。</li><li id="8dd5" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">姓氏:用户的姓氏</li><li id="2d6f" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">长度:歌曲长度</li><li id="06b8" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">级别:订阅状态，是“付费”还是“免费”</li><li id="cc53" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">位置:用户位置</li><li id="2b9e" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">方法:这个特定事件的API方法，在图2中是“PUT”。</li><li id="7224" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">宋:歌名</li><li id="8fc7" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">状态:来自服务器的HTTP响应，无论是成功(例如:200)还是失败(例如:500、404)</li><li id="1eaf" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">ts:事件发生时的Unix时间戳</li><li id="cdbd" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">userAgent:记录在用户代理的单个字符串中的浏览器、平台、操作系统和其他信息</li><li id="6add" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">userId:平台中的用户Id</li></ul><p id="4f94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个数据集上，我发现了一些缺少userid的记录，如图3所示。由于我们只想预测登录用户(注销用户不能被给予防止流失的动作)，所以具有丢失的用户id的行被清除。如果用户注销，会话仍然相同，但缺少userId，这可能是错误的。然而，为了简化项目，我们简单地排除这些用户。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ls"><img src="../Images/daf9718e67f536fabb7312bdb9bb4880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l6OPBjB8j3pMUjqK0mlvpQ.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图3。不完整的行。</figcaption></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="7bba" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">数据探索</strong></h1><p id="3b84" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在本节中，我在小型数据集(128 MB)中执行数据探索，因此我们可以预期非常低的userId。</p><p id="f44b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第一部分，我想探索页面分布。从图4来看，<strong class="ih hj"> NextSong </strong> event是数据集上访问量最大的页面，大拇指排名第二。有趣的是<strong class="ih hj">添加好友</strong>页面显示频率很高。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lt"><img src="../Images/651c21a3ce2bc63d641be9859220cba0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aoImkx1PNREgP-zue_nPpw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图4。总页面频率</figcaption></figure><p id="19c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特定用户经常访问几个页面，例如主页和添加到播放列表，如图4所示。当我们看到流失用户的样本时，这也反映在图5的样本上。该用户在访问“<strong class="ih hj">取消会议”时取消订阅</strong>页面。如果用户正在搅动，此页面用作标志。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lu"><img src="../Images/332a902b41761d45231f5709660d1638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*y_X0BPphnVbXa_4R3GHteA.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图5。流失用户访问的页面列表。</figcaption></figure><p id="b402" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看图6中的订阅状态分布，我们可以看到大多数事件都是由付费用户完成的，这将有利于我们的预测，因为我们希望预测付费用户的流失。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lv"><img src="../Images/8381ebab0372f3ae2f0eaba93faeb828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzaw9z6hFf487Oe2nUmWIA.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图6。订阅状态分布</figcaption></figure><p id="56ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个迷你数据集中，我们有225个用户，其中52个用户流失，173个用户仍然活跃。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lw"><img src="../Images/43e7c7d6fa0612680752669a4d46fa1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*bjGsmpOP32FYA9RjqnesUQ.png"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图7。流失用户与活跃用户</figcaption></figure><p id="35b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我创建了一些指标来比较客户流失和活跃用户:</p><ul class=""><li id="dee6" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">avg_song_played:每个用户所有时间平均播放的歌曲</li><li id="5a78" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">avg_song_per_day_played:每个用户每天平均播放的歌曲</li><li id="0a63" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">avg_unique_song_played:每个用户所有时间平均播放的唯一歌曲</li><li id="ccd3" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">median_song_played:每个用户所有时间播放的歌曲的中位数</li><li id="79db" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">unique _ ratio:avg _ unique _ song _ played/avg _ song _ played，这可以告诉我们用户通常播放的是不同的歌曲还是同一种歌曲。</li><li id="a19b" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">user_age:平台平均用户年龄。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lx"><img src="../Images/5aa2fb8f57f15d6611f8eac022b016f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RppF3BEbnCRGCShoEu4m_A.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图8。流失用户和活跃用户之间的比较指标。</figcaption></figure><p id="7a14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据这一指标，我们可以看到流失用户的平均用户年龄低于活跃用户。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="31c3" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">特征工程</h1><p id="7b96" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">我将这些特性分为三类:</p><ul class=""><li id="ed3f" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">会话级行为:例如每次会话歌曲数量、每次会话的平均持续时间。</li><li id="a8df" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">用户属性:性别、用户设备、浏览器</li><li id="1872" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">一般行为:访问的特定页面的数量，付费或免费会话的数量，播放歌曲的数量。</li></ul><p id="9ae9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于会话级特性，因为一个用户有多个会话，所以我们需要首先基于会话聚合指标，然后归纳为userId。SQL将如下所示:</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="d49e" class="md jx hi lz b fi me mf l mg mh">SELECT userId, <br/>       AVG(hour_per_session)             AS avg_hour_per_session,<br/>       AVG(unique_song_per_session)      AS avg_unique_song_per_session,<br/>       AVG(unique_artist_per_session)    AS avg_unique_artist_per_session,<br/>       AVG(cnt_song_played_persession)   AS avg_song_played_persession<br/>FROM (       <br/>SELECT userId,<br/>       sessionId,<br/>       (MAX(ts) -MIN(ts))/(1000*3600) AS hour_per_session,<br/>       COUNT(DISTINCT song) unique_song_per_session,<br/>       COUNT(DISTINCT artist) unique_artist_per_session,<br/>       SUM(CASE WHEN page = 'NextSong' THEN 1 ELSE 0 END) AS cnt_song_played_persession<br/>FROM event_with_churn <br/>GROUP BY 1,2)<br/>GROUP BY 1</span></pre><p id="0a8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于像性别这样的用户属性，我们直接在数据集中有。然而，在平台和浏览器上，我们需要从用户代理中提取信息。如果我们在图9中看到，我们有9个平台和浏览器的组合。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mi"><img src="../Images/33884b4d7ae64099b7360632e0303617.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X-hqgXYZ-q67tVRbLbQJlA.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图9。浏览器和平台</figcaption></figure><p id="9afe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">总之，我在这个迷你数据集上使用了34个特征，其中10个特征来自用户属性，3个特征来自会话属性，21个特征来自一般行为。您可以在图10中看到完整的特性列表。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mj"><img src="../Images/6d5b4622834260041bc5855a35cb8c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QtuxpksnQWTKwdZ_s9LAvw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图10。功能列表</figcaption></figure><p id="2c4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些特征可能会给我们带来信息上的好处，但这会减慢我们建模的速度。如果你在<a class="ae mk" href="https://github.com/okids/sparkify" rel="noopener ugc nofollow" target="_blank"> github </a>上看到我的jupyter笔记本，我会在应用完整数据集中的代码时减少特性的数量。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="24f8" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">建模</h1><p id="a7f7" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">我将4个模型应用于数据集:</p><ol class=""><li id="bee8" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc ml lk ll lm bi translated">逻辑回归</li><li id="8bec" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc ml lk ll lm bi translated">朴素贝叶斯</li><li id="5de7" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc ml lk ll lm bi translated">随机森林</li><li id="7c94" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc ml lk ll lm bi translated">梯度推进</li></ol><p id="3ef1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们转向随机森林或梯度推进等更复杂模型之前，可以使用逻辑回归作为基准。我以80:20的比例将数据集分为训练和测试。我使用<strong class="ih hj"> F1-score </strong>作为衡量标准和交叉验证方法来创建模型。这是因为数据集的数量非常少。迷你数据集的建模结果如图11所示。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mm mn l"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图11。微型数据集中的预测结果</figcaption></figure><p id="c6e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">令人惊讶的是，与其他模型相比，逻辑回归的F1值最高，而朴素贝叶斯的表现最差。这可能是由我们拥有的的<a class="ae mk" href="https://stats.stackexchange.com/questions/298147/how-to-explain-low-performance-of-naive-bayes-on-a-dataset" rel="noopener ugc nofollow" target="_blank">多重分类特征(0/1)造成的。与逻辑回归相比，复杂模型的表现也不太好。这可能是由于模型在小数据集中不能更好地推广。</a></p><p id="3a88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，当我在完整的数据集中应用该模型时，上述结果是不同的。我还将特征的数量减少到17个，以克服对完整数据集运行时的缓慢。如图12所示，梯度增强和随机福里斯特具有最高的准确性和F1值。这意味着这些模型在更大的数据集中概括得更好。由于Pyspark中的一些错误，我未能获得朴素贝叶斯结果。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mm mn l"/></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图12。完整数据集中的预测结果</figcaption></figure><p id="ad8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从图13中的特征重要性系数中，我们可以看到<strong class="ih hj"> user_age </strong>和<strong class="ih hj"> cnt_thumb_down </strong>处于第一和第二高的系数等级。这非常有趣，因为从逻辑上讲<strong class="ih hj"> cnt_thumb_down </strong>意味着用户讨厌这首歌。值得检查的是<strong class="ih hj"> cnt_thumb_down </strong>是发生在建议事件中还是正常事件中。如果来自推荐引擎，Sparkify需要改进他们的引擎。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mo"><img src="../Images/847e05e6a9ec2320f85c8011f7790e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u2WMO0aQp7J8LDf7QLp7uA.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx translated">图13。特征重要性系数</figcaption></figure><h1 id="da1d" class="jw jx hi bd jy jz mp kb kc kd mq kf kg kh mr kj kk kl ms kn ko kp mt kr ks kt bi translated">结论</h1><p id="49eb" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">小数据集和大数据集之间的建模结果差异很大，但最终我们将使用在大数据集上具有良好通用性的模型。<strong class="ih hj">梯度增强</strong>在全数据集中具有最高的F1值和精确度。在应用于整个数据集之前，可以通过在小数据集中过滤最重要的基于特征的建模结果来进行改进。在现实世界中，这可以节省时间和成本，节省时间意味着降低CPU机器的成本。</p><p id="e755" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae mk" href="https://github.com/okids/sparkify" rel="noopener ugc nofollow" target="_blank"> my github </a>中关于代码的更多细节。</p></div></div>    
</body>
</html>