<html>
<head>
<title>Linear Regression and Decision Tree Implementation using Pyspark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pyspark实现线性回归和决策树</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/linear-regression-and-decision-tree-implementation-using-pyspark-bfcd93dee86?source=collection_archive---------3-----------------------#2019-12-19">https://medium.com/analytics-vidhya/linear-regression-and-decision-tree-implementation-using-pyspark-bfcd93dee86?source=collection_archive---------3-----------------------#2019-12-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0111" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将构建一个简单的线性回归和决策树来帮助您开始使用pyspark。考虑的数据集是小型汽车数据集。</p><p id="8c69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要做的第一件事是找到火花。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a0e0" class="jm jn hi ji b fi jo jp l jq jr"><strong class="ji hj">import</strong> <strong class="ji hj">findspark</strong><br/>findspark.init()<br/>findspark.find()<br/><strong class="ji hj">import</strong> <strong class="ji hj">pyspark</strong><br/><a class="ae js" href="https://gist.github.com/Debpriyo97/cb485b98c7d79f675d5eea50d3629815" rel="noopener ugc nofollow" target="_blank">findspark</a>.find()</span></pre><p id="7e6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步是创建一个Spark会话。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="2d12" class="jm jn hi ji b fi jo jp l jq jr">import matplotlib.pyplot as plt<br/>import numpy as np<br/>import pandas as pd<br/>from numpy import polyfit<br/>from pyspark.sql import SparkSession<br/>from pyspark import SparkContext,SparkConf,SQLContext</span><span id="e261" class="jm jn hi ji b fi jt jp l jq jr">conf = SparkConf().setMaster('local').setAppName('ML_learning')<br/>sc = SparkContext(conf=conf)<br/>sqlcontext = SQLContext(sc)</span></pre><p id="ae11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">加载数据，在这种情况下是一个csv文件。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="08c5" class="jm jn hi ji b fi jo jp l jq jr">data = sqlcontext.read.csv(path='C:\AAI\week 3\Small_Car_Data.csv', header = True, inferSchema = True)</span><span id="6103" class="jm jn hi ji b fi jt jp l jq jr">data.show()</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ju"><img src="../Images/6ab7dac66bc34d194cd139f408858cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q84soIN-ZIGcDBM2LeQf2g.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">小型汽车数据集</figcaption></figure><p id="1834" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，导入实现线性回归所需的模块。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1543" class="jm jn hi ji b fi jo jp l jq jr">from pyspark.ml.feature import VectorAssembler<br/>from pyspark.ml.regression import LinearRegression<br/>from pyspark.ml.evaluation import RegressionEvaluator</span></pre><p id="7a62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最初对单个变量进行线性回归，并绘制结果以便更好地理解。</p><p id="f9e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为培训和测试目的拆分数据。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="82dc" class="jm jn hi ji b fi jo jp l jq jr">data2 =data.select(data.Displacement,data.Horsepower.alias('label'))<br/>train, test = data2.randomSplit([0.9,0.1])</span></pre><p id="5137" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">矢量汇编器用于创建所有单个特征的矢量。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="9f12" class="jm jn hi ji b fi jo jp l jq jr">assembler=VectorAssembler().setInputCols(['Displacement',])\.setOutputCol('features')<br/>train01 = assembler.transform(train)</span><span id="3f28" class="jm jn hi ji b fi jt jp l jq jr">train02 = train01.select("features","label")<br/>train02.show(5)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div class="er es kg"><img src="../Images/ae3b0c32b79ce6dc730485d724b5903b.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/format:webp/1*tKBtASyO0vFuiaQJcylrcw.png"/></div></figure><p id="82de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特征:所有单个特征的向量。</p><p id="ab38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">标签:目标变量。</p><p id="0a66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，由于最初我们建立的是单变量线性回归模型，因此只有一个特征“位移”被转换为矢量。</p><p id="c860" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，建立模型。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="c092" class="jm jn hi ji b fi jo jp l jq jr">lr = LinearRegression()<br/>model = lr.fit(train02)</span></pre><p id="58c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用看不见的数据测试我们的模型。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a458" class="jm jn hi ji b fi jo jp l jq jr">test01 = assembler.transform(test)<br/>test02 = test01.select('features', 'label')<br/>test03 = model.transform(test02)<br/>test03.show(5)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div class="er es kh"><img src="../Images/723872adbf0574ba67d5ab46a1466c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:578/format:webp/1*ctpv5WNikJYyYQi1ZaKmxg.png"/></div></figure><p id="2e11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">绘制线性拟合线。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="768f" class="jm jn hi ji b fi jo jp l jq jr">import chart_studio.plotly as py<br/>import plotly.graph_objects as go<br/>fig = go.Figure()</span><span id="7ad9" class="jm jn hi ji b fi jt jp l jq jr">fig.add_trace(<br/>    go.Scatter(<br/>        x=x,<br/>        y=y,<br/>        mode='markers',<br/>        name='Original_Test',<br/>    ))</span><span id="3ba5" class="jm jn hi ji b fi jt jp l jq jr">fig.add_trace(<br/>    go.Scatter(<br/>        x=x,<br/>        y=y_pred,<br/>        name='Predicted'<br/>    ))<br/>fig.update_layout(<br/>    title="Linear Regression",<br/>    xaxis_title="Displacement",<br/>    yaxis_title="Horse Power",<br/>    font=dict(<br/>        family="Courier New, monospace",<br/>        size=18,<br/>        color="#7f7f7f"<br/>    )<br/>)</span><span id="45ef" class="jm jn hi ji b fi jt jp l jq jr">fig.show()</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ki"><img src="../Images/2ceb4b17c0bcbc4ad0e643f11474088c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGsbBacHCWZYrq9i-W1Opw.png"/></div></div></figure><p id="3537" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">模型评估。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="2db2" class="jm jn hi ji b fi jo jp l jq jr">evaluator = RegressionEvaluator()<br/>print(evaluator.evaluate(test03,<br/>{evaluator.metricName: "r2"})<br/>)</span><span id="04b8" class="jm jn hi ji b fi jt jp l jq jr">print(evaluator.evaluate(test03,<br/>{evaluator.metricName: "mse"})<br/>)<br/>print(evaluator.evaluate(test03,<br/>{evaluator.metricName: "rmse"})<br/>)<br/>print(evaluator.evaluate(test03,<br/>{evaluator.metricName: "mae"})<br/>)</span></pre><p id="ef54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们开始建立多元线性回归和决策树模型。</p><p id="f500" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择与建模相关的列。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a5d9" class="jm jn hi ji b fi jo jp l jq jr">small_cars=data.select(data._c0,data.Cylinders,data.Displacement,data.Manufacturer,data.Model_Year,data.Origin,data.Weight,data.Horsepower,data.Acceleration)<br/>small_cars.show()</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kj"><img src="../Images/2ffc5309787847a5e5ad7220fe031558.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3BxviITIeB8K5EatUc8zPA.png"/></div></div></figure><p id="0703" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在构建模型之前，需要对数据集进行一些预处理。“原产地”和“制造商”等变量具有需要转换的分类值。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="855e" class="jm jn hi ji b fi jo jp l jq jr">from pyspark.ml.feature import StringIndexer</span><span id="9901" class="jm jn hi ji b fi jt jp l jq jr">indexer = StringIndexer(inputCol="Origin", outputCol="Origin_cat")</span><span id="82ce" class="jm jn hi ji b fi jt jp l jq jr">indexed = indexer.fit(small_cars).transform(small_cars)</span><span id="dc73" class="jm jn hi ji b fi jt jp l jq jr">origin_cat=indexed.select(indexed._c0,indexed.Origin_cat)</span><span id="0b59" class="jm jn hi ji b fi jt jp l jq jr">indexer_1 = StringIndexer(inputCol="Manufacturer", outputCol="Man_cat")</span><span id="b286" class="jm jn hi ji b fi jt jp l jq jr">indexed_1 = indexer_1.fit(small_cars).transform(small_cars)<br/>man_cat=indexed_1.select(indexed_1._c0,indexed_1.Man_cat)</span><span id="4be7" class="jm jn hi ji b fi jt jp l jq jr">inner_join = small_cars.join(man_cat, small_cars._c0 == man_cat._c0).drop(man_cat._c0)</span><span id="f947" class="jm jn hi ji b fi jt jp l jq jr">inner_join_1=inner_join.join(origin_cat,inner_join._c0==origin_cat._c0).drop('_c0','Manufacturer','Origin')</span><span id="ad0a" class="jm jn hi ji b fi jt jp l jq jr">inner_join_1.show(5)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div class="er es kk"><img src="../Images/0be290848618617adcc595e46778ef26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*t1psC6gHE9wzr5UNpilVxA.png"/></div></figure><p id="11bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为训练和测试拆分数据。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f865" class="jm jn hi ji b fi jo jp l jq jr">train, test = inner_join_1.randomSplit([0.9,0.1])</span></pre><p id="cf3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用矢量汇编程序为所有单个特征创建一个矢量。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a63c" class="jm jn hi ji b fi jo jp l jq jr">assembler=VectorAssembler().setInputCols(['Displacement','Cylinders','Model_Year','Weight','Man_cat','Origin_cat'])\<br/>.setOutputCol('features')</span><span id="2cc6" class="jm jn hi ji b fi jt jp l jq jr">train_a = assembler.transform(train)</span><span id="3e96" class="jm jn hi ji b fi jt jp l jq jr">train_b=train_a.select("features",train_a.Horsepower.alias('label'))</span><span id="7cbe" class="jm jn hi ji b fi jt jp l jq jr">train_b.show(truncate=False)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kl"><img src="../Images/d4b45d26161148b81cf186c7d7ecb94d.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/format:webp/1*Pa0dNmZrdy1bfKtLS-QiaQ.png"/></div></div></figure><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="ae30" class="jm jn hi ji b fi jo jp l jq jr">lr = LinearRegression()<br/>model = lr.fit(train_b)<br/>test_a = assembler.transform(test)<br/>test_b = test_a.select('features', test_a.Horsepower.alias('label'))<br/>test_c = model.transform(test_b)<br/>test_c.show(truncate=False)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div class="er es km"><img src="../Images/4a8fe2534128692e15e0af0faebf8769.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*G3x_hSpci4PVBiYME0E__w.png"/></div></figure><p id="a142" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">评估模型。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="6ede" class="jm jn hi ji b fi jo jp l jq jr">evaluator = RegressionEvaluator()<br/>print(evaluator.evaluate(test_c,<br/>{evaluator.metricName: "r2"})<br/>)</span><span id="c337" class="jm jn hi ji b fi jt jp l jq jr">print(evaluator.evaluate(test_c,<br/>{evaluator.metricName: "mse"})<br/>)<br/>print(evaluator.evaluate(test_c,<br/>{evaluator.metricName: "rmse"})<br/>)<br/>print(evaluator.evaluate(test_c,<br/>{evaluator.metricName: "mae"})<br/>)</span></pre><p id="9b77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建决策树模型。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="98b2" class="jm jn hi ji b fi jo jp l jq jr">from pyspark.ml.regression import DecisionTreeRegressor</span><span id="2e95" class="jm jn hi ji b fi jt jp l jq jr">dt = DecisionTreeRegressor()<br/>model = dt.fit(train_b)<br/>test_dt = model.transform(test_b)<br/>test_dt.show(truncate=False)</span></pre><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kn"><img src="../Images/4fc0e2a85ffe5f0f7dc474b732654995.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*KL54HfU-59TorKR_7YIbzg.png"/></div></div></figure><p id="7352" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">评估模型</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="ae29" class="jm jn hi ji b fi jo jp l jq jr">evaluator = RegressionEvaluator()<br/>print(evaluator.evaluate(test_dt,<br/>{evaluator.metricName: "r2"})<br/>)</span><span id="7071" class="jm jn hi ji b fi jt jp l jq jr">print(evaluator.evaluate(test_dt,<br/>{evaluator.metricName: "mse"})<br/>)<br/>print(evaluator.evaluate(test_dt,<br/>{evaluator.metricName: "rmse"})<br/>)<br/>print(evaluator.evaluate(test_dt,<br/>{evaluator.metricName: "mae"})<br/>)</span></pre><p id="9eeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是如何在Pyspark中建立一个简单的线性回归和决策树模型。</p><p id="eed3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">谢谢</p></div></div>    
</body>
</html>