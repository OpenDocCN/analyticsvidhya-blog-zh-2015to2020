<html>
<head>
<title>Streaming Data with Dataflow and Apache Beam</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用数据流和Apache Beam传输数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/streaming-data-with-dataflow-and-apache-beam-20cd786649bc?source=collection_archive---------12-----------------------#2020-01-18">https://medium.com/analytics-vidhya/streaming-data-with-dataflow-and-apache-beam-20cd786649bc?source=collection_archive---------12-----------------------#2020-01-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii"><div class="bz dy l di"><div class="ij ik l"/></div></figure><figure class="il im in io fd ii"><div class="bz dy l di"><div class="ij ik l"/></div></figure><p id="c68c" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">上次我写关于数据流的文章是为了和你分享我工作的公司的一个用例，以批处理模式处理数据。今天，我想分享一个流模式下的简单管道，从pubsub读取消息，然后写入Bigquery。当您拥有基于事件的架构时，一个常见的场景如下。</p><figure class="il im in io fd ii er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es jn"><img src="../Images/302cee35a368696c118c7088d3ee2260.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ZAk5M5wVC448GNz-MBFnA.png"/></div></div></figure><p id="33ca" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">服务1可以是用户操作时你的后端触发事件。然后，服务2基于服务1上发出的事件执行另一个动作，比如在用户登录或在我们的平台上注册后在后台发送通知，等等。</p><p id="2f3d" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">假设每次用户登录我们的平台时，我们需要在数据仓库(Bigquery)中存储一条新记录。</p><p id="e7c6" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">那么，我们需要做什么？</p><p id="22d3" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">我的项目结构如下:</p><pre class="il im in io fd ju jv jw jx aw jy bi"><span id="1957" class="jz ka hi jv b fi kb kc l kd ke">pipeline<br/>   user_signin.py // our pipeline definition<br/>   __init__.py<br/>transforms<br/>   pubsub_message.py //DoFn to transform messages<br/>   __init__.py<br/>main.py<br/>README.md<br/>requirements.txt // apache-beam[gcp]<br/>setup.py // definition of our package<br/>run.sh //command to send messages to pubsub for local testing</span></pre><p id="11ea" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">让我们看看main.py</p><pre class="il im in io fd ju jv jw jx aw jy bi"><span id="4d53" class="jz ka hi jv b fi kb kc l kd ke">import logging<br/>from pipeline import user_signin</span><span id="8f6f" class="jz ka hi jv b fi kf kc l kd ke">logging.basicConfig(filename='<strong class="jv hj">debugging.log</strong>', level=logging.DEBUG)</span><span id="8ee8" class="jz ka hi jv b fi kf kc l kd ke">if __name__ == '__main__':<br/>  user_signin.run()</span></pre><p id="9aad" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">在main.py文件中，我希望将第三行代码指向我们为应用程序调试设置输出的地方。这对于本地开发非常重要，因为在这里，您将看到每个logging.error()、logging.debug()等的输出。在你的申请中。对于生产环境，如果你在数据流(谷歌平台)上托管你的管道，你会在StackDriver上看到，但目前很难做到。因此，您的管道应该在本地进行测试，这样对于生产环境来说就不会有问题。对我来说这是有意义的。假设您的管道处理数百万兆字节的数据，打印关于错误或调试的日志并不是一个好主意，因为在大量的日志中很难甚至不可能找到什么。</p><p id="e741" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">现在让我们看看pipeline/user_signin.py。</p><pre class="il im in io fd ju jv jw jx aw jy bi"><span id="0165" class="jz ka hi jv b fi kb kc l kd ke">import logging<br/>import argparse<br/>from dateutil import parser<br/>import apache_beam as beam</span><span id="c07c" class="jz ka hi jv b fi kf kc l kd ke">from apache_beam.io.gcp.internal.clients import bigquery<br/>from apache_beam.options.pipeline_options import PipelineOptions<br/>from transforms.pubsub_message import <strong class="jv hj">MessageExtractingFn</strong></span><span id="39da" class="jz ka hi jv b fi kf kc l kd ke">table_schema = bigquery.TableSchema()<br/>userid_schema = bigquery.TableFieldSchema()<br/>userid_schema.name = 'userid'<br/>userid_schema.type = 'string'<br/>userid_schema.mode = 'required'<br/>table_schema.fields.append(userid_schema)</span><span id="7430" class="jz ka hi jv b fi kf kc l kd ke">date_schema = bigquery.TableFieldSchema()<br/>date_schema.name = 'date'<br/>date_schema.type = 'timestamp'<br/>date_schema.mode = 'required'<br/>table_schema.fields.append(date_schema)</span><span id="c1e4" class="jz ka hi jv b fi kf kc l kd ke">def run():</span><span id="8221" class="jz ka hi jv b fi kf kc l kd ke">   pipe_options = {<br/>      'project': 'project_id',<br/>      'staging_location': 'gs://%s/dataflow' % 'bucket',<br/>      'runner': 'DataflowRunner', # change to DirectRunner for local<br/>      'setup_file': './setup.py',<br/>      'job_name': 'signin-user-tobigquery',<br/>      'temp_location': 'gs://%s/temp' % 'bucket',<br/>      'streaming': True, # <strong class="jv hj">important<br/>      </strong>'region': 'us-central1' # depends on your preferences<br/>   }</span><span id="f556" class="jz ka hi jv b fi kf kc l kd ke">   with <br/>      beam.Pipeline(<br/>        options=<br/>           PipelineOptions.from_dictionary(pipe_options)) as pipe:</span><span id="8578" class="jz ka hi jv b fi kf kc l kd ke">      messages = pipe | beam.io.<strong class="jv hj">ReadFromPubSub</strong>(<br/>        topic='projects/project_id/topics/topic-user-signin')<br/>      lines = messages | 'decode' &gt;&gt; <br/>          beam.Map(lambda x: x.decode('utf-8'))</span><span id="783e" class="jz ka hi jv b fi kf kc l kd ke">      pubsub_msg = (lines | 'Format Message' &gt;&gt;<br/>          (beam.ParDo(<strong class="jv hj">MessageExtractingFn</strong>())))</span><span id="9b01" class="jz ka hi jv b fi kf kc l kd ke">      output_table_name =<br/>         '{project}:YourDataset.YourTable'.format(<br/>            project=pipe_options.get('project'))</span><span id="f29a" class="jz ka hi jv b fi kf kc l kd ke">      user_sessions = (pubsub_msg | 'Write Sessions' &gt;&gt;<br/>            beam.io.WriteToBigQuery(output_table_name,<br/>                schema=table_schema,<br/>                create_disposition=<br/>                   beam.io.BigQueryDisposition.CREATE_IF_NEEDED,<br/>               write_disposition=<br/>                   beam.io.BigQueryDisposition.WRITE_APPEND))</span><span id="a7d7" class="jz ka hi jv b fi kf kc l kd ke">      logging.debug('Writing into big query')</span><span id="86df" class="jz ka hi jv b fi kf kc l kd ke">      result = pipe.run()</span></pre><p id="214f" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">现在让我们看看transforms/pubsub_message.py</p><pre class="il im in io fd ju jv jw jx aw jy bi"><span id="2ca1" class="jz ka hi jv b fi kb kc l kd ke">import json<br/>import logging<br/>import apache_beam as beam</span><span id="a596" class="jz ka hi jv b fi kf kc l kd ke">class <strong class="jv hj">MessageExtractingFn</strong>(beam.DoFn):<br/>   def process(self, element):<br/>      logging.debug('element %s', element)<br/>      message = json.loads(element)<br/>      userid = message.get('userid')<br/>      date = message.get('date')</span><span id="7448" class="jz ka hi jv b fi kf kc l kd ke">      if userid and date:</span><span id="a5d4" class="jz ka hi jv b fi kf kc l kd ke">         new_element = {<br/>           'userid': userid,<br/>           'date': date,<br/>         }</span><span id="3abc" class="jz ka hi jv b fi kf kc l kd ke">         yield new_element # add the element to the pcollection</span></pre><p id="3fb5" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">运行管道</p><ol class=""><li id="28db" class="kg kh hi ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">python main.py. For localhost别忘了在pipe_options里面改成DirectRunner。</li><li id="05a5" class="kg kh hi ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">如果你使用DataflowRunner，你会在谷歌控制台上看到类似于数据流部分的下图。</li></ol><figure class="il im in io fd ii er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ku"><img src="../Images/8e352978da866d8790aad1c227697a25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IbpYj9glcdq05k-VJWr6IQ.png"/></div></div></figure><p id="53cd" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">3.要模拟向pubsub发送消息，请使用gcloud:</p><pre class="il im in io fd ju jv jw jx aw jy bi"><span id="1b30" class="jz ka hi jv b fi kb kc l kd ke">&gt; gcloud pubsub topics publish topic-user-signin --project yourprojectid --message '{"userid": "93234234", "date": "2017-10-17T20:57:17.338320"}'</span><span id="b152" class="jz ka hi jv b fi kf kc l kd ke">&gt; messageid: 333545454 # you will see something like this in the terminal</span></pre><p id="a62e" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">4.如果您对本地主机上的身份验证有问题，可能是因为有多个google帐户，请尝试下一步并设置相应的:</p><pre class="il im in io fd ju jv jw jx aw jy bi"><span id="0226" class="jz ka hi jv b fi kb kc l kd ke">&gt; gcloud beta auth application-default login<br/>&gt; gcloud auth login</span></pre><p id="436e" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">提示:</p><ul class=""><li id="308f" class="kg kh hi ir b is it iw ix ja ki je kj ji kk jm kv km kn ko bi translated">在bigquery模式定义中对日期字段使用时间戳，因为在Bigquery上进行查询时会有更大的灵活性。</li><li id="3ebf" class="kg kh hi ir b is kp iw kq ja kr je ks ji kt jm kv km kn ko bi translated">当需要将结构化属性存储为bigquery表中的新列时，也可以定义嵌套或重复字段。</li></ul><p id="c5ee" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated">参考资料:</p><p id="111d" class="pw-post-body-paragraph ip iq hi ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm hb bi translated"><a class="ae kw" href="https://beam.apache.org/documentation/sdks/python-streaming/" rel="noopener ugc nofollow" target="_blank">https://beam . Apache . org/documentation/sdks/python-streaming/</a></p></div></div>    
</body>
</html>