<html>
<head>
<title>A Balance Portfolio of Indian Equities and Debt Funds Backtested using Quontoian zipline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Quontoian zipline对印度股票和债券基金的平衡投资组合进行回溯测试</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/a-balance-portfolio-of-indian-equities-and-debt-funds-backtested-using-quontoian-zipline-fd3f36fec929?source=collection_archive---------21-----------------------#2020-06-13">https://medium.com/analytics-vidhya/a-balance-portfolio-of-indian-equities-and-debt-funds-backtested-using-quontoian-zipline-fd3f36fec929?source=collection_archive---------21-----------------------#2020-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d4a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作者:萨比尔·贾纳</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="b0b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定在富兰克林邓普顿印度债务基金惨败后写这篇文章，因为这引起了很多关于印度债务基金投资的担忧。固定收益证券或债券基金在投资组合多样化中发挥着重要作用。在正常的市场环境下，高质量的债务基金与股票的相关性仍然很低，从而有利于分散风险。</p><p id="01cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将采用一个非常基本的启发式投资组合，60%的股权和40%的债务，并使用Quontoian zipline对其进行回溯测试，历时约九年半。然后，我们将它的性能参数与市场基准性能进行比较。使用zipline进行回溯测试需要将您的自定义数据包接收到zipline中。请参考我写的关于<a class="ae jk" rel="noopener" href="/@sabirh.jana/how-to-import-indian-equities-data-to-zipline-on-your-local-machine-3b8587aaf112">如何将印度股票数据导入本地机器上的zipline的文章？</a>为此。你可以在我的<a class="ae jk" href="https://github.com/sabirjana/blog/tree/master/Portfolio%20Diversification" rel="noopener ugc nofollow" target="_blank"> Github </a>资源库中找到这篇文章使用的Jupyter笔记本和数据。</p><p id="6ad2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所采用的方法如下:</p><ol class=""><li id="2ea0" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">确定并选择合适的股票代理人和固定收益证券。</li><li id="c2f0" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">建立一个由60%的股票和40%的债务组成的投资组合，并使用zipline进行回溯测试，每年进行一次再平衡。</li><li id="0626" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">为投资组合和基准生成性能统计数据，以进行比较和对比。</li></ol></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="a4ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">识别和选择股票和固定收益证券的合适代理人</strong></p><p id="6873" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为股票的代理，我使用了Quantum Nifty交易所交易计划(<a class="ae jk" href="https://in.finance.yahoo.com/quote/QNIFTY.NS?p=QNIFTY.NS" rel="noopener ugc nofollow" target="_blank"> QNIFTY </a>)。QNIFTY是一个非常小的ETF，AUM只有9 cr，然而，它是印度最古老的跟踪Nifty 50的ETF之一。我选择这只ETF是为了让我们有9到10年的回望期。由于被动投资在印度仍在加快步伐，只有少数ETF拥有长期历史数据。</p><p id="75f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了<a class="ae jk" href="https://in.finance.yahoo.com/quote/0P00005V68.BO/history?p=0P00005V68.BO" rel="noopener ugc nofollow" target="_blank"> Aditya Birla Sun Life公司债券(MF103178) </a>和<a class="ae jk" href="https://in.finance.yahoo.com/quote/0P0000OQWT.BO/?p=0P0000OQWT.BO" rel="noopener ugc nofollow" target="_blank"> HDFC短期债务基金(MF113047) </a>作为固定收益证券的代理。这两个都是高质量的债务共同基金，最大限度地投资于AAA级公司债券和主权证券。</p><p id="2478" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用了BSE 100指数作为性能统计比较的基准。我已经提供了所有这些的历史价格数据。还有许多选项可以让您免费下载这些数据。</p><p id="3c29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面的代码片段将执行以下任务:</p><ol class=""><li id="e182" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">进行必要的导入并读取历史价格数据文件，以制作熊猫数据框架。</li><li id="3bfd" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">清理数据，保证日常频率。</li><li id="0345" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">画出收盘价以直观显示累积回报。</li><li id="4392" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">画出每日回报的斯皮尔曼相关矩阵。</li></ol><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="02f8" class="ki kj hi ke b fi kk kl l km kn"># this is to display images in notebook<br/>%matplotlib inline<br/>%config InlineBackend.figure_format = ‘retina’</span><span id="7613" class="ki kj hi ke b fi ko kl l km kn"># make necessary imports<br/>import zipline<br/>from zipline.api import (order_target_percent, symbol,<br/>                         set_commission, set_slippage, <br/>                         schedule_function, date_rules, time_rules)<br/>from zipline.finance.commission import PerDollar<br/>from datetime import datetime<br/>import pytz<br/>from matplotlib import pyplot as plt<br/>import pandas as pd<br/>import pyfolio as pf<br/>from trading_calendars import get_calendar<br/>import seaborn as sns<br/>import zipline<br/>from os import listdir<br/>idx = pd.IndexSlice</span><span id="1658" class="ki kj hi ke b fi ko kl l km kn"># path to data files<br/>path = 'data'</span><span id="b374" class="ki kj hi ke b fi ko kl l km kn"># get the names of all .csv files in data folder<br/>symbols = [f[:-4] for f in listdir(path)]</span><span id="a4d9" class="ki kj hi ke b fi ko kl l km kn"># list symbols<br/>symbols</span><span id="c3a7" class="ki kj hi ke b fi ko kl l km kn"># read .csv files and build a pandas datafame<br/>def get(tickers): <br/>    def data(ticker):<br/>        print('Processing...', ticker)<br/>        return pd.read_csv('{}/{}.csv'.format(path, ticker), index_col=[0], parse_dates=[0])<br/>    datas = map(data, tickers)<br/>    return(pd.concat(datas, keys=tickers, names=['ticker', 'date']))<br/>               <br/>symbols_df = get(symbols)</span><span id="e8c0" class="ki kj hi ke b fi ko kl l km kn"># check the datafram head<br/>symbols_df.head(2)</span><span id="c201" class="ki kj hi ke b fi ko kl l km kn"># unstack the dataframe to get close prices<br/>symbols_prices = symbols_df.unstack('ticker')['close'].asfreq('D', method='ffill').dropna()</span><span id="4668" class="ki kj hi ke b fi ko kl l km kn"># quick verification of dataframe head and tail<br/>symbols_prices.head(2).append(symbols_prices.tail(2))</span><span id="98c7" class="ki kj hi ke b fi ko kl l km kn"># rebase the data <br/>symbols_prices = symbols_prices/symbols_prices.iloc[0]<br/>symbols_prices.head(2).append(symbols_prices.tail(2))</span><span id="1758" class="ki kj hi ke b fi ko kl l km kn"># visulize the date for a quick comparision<br/>fig, ax = plt.subplots(2, 1, sharex=True, figsize = (12,6))<br/>ax[0].plot(symbols_prices['MF103178'], label = 'Aditya Birla Sun Life Corporate Bond')<br/>ax[0].plot(symbols_prices['MF113047'], label = 'HDFC Short Term Debt')<br/>ax[0].set(title = 'Aditya Birla Sun Life Corporate Bond vs HDFC Short Term Debt Growth', ylabel = 'Price')<br/>ax[0].grid(True)<br/>ax[0].legend()</span><span id="4935" class="ki kj hi ke b fi ko kl l km kn">ax[1].plot(symbols_prices['QNIFTY'], label = 'Quantum Nifty Exchange Traded Scheme')<br/>ax[1].plot(symbols_prices['BSE-100'], label = 'S&amp;P BSE 100 INDEX')<br/>ax[1].set(title = 'Quantum Nifty Exchange Traded Scheme vs S&amp;P BSE 100 INDEX', ylabel = 'Price')<br/>ax[1].grid(True)<br/>plt.legend()</span><span id="fd1f" class="ki kj hi ke b fi ko kl l km kn">plt.tight_layout();<br/>plt.savefig('chart1', dpi=600)</span><span id="de46" class="ki kj hi ke b fi ko kl l km kn"># visulize debt funds corelation with equity<br/>fig = sns.heatmap(symbols_prices.pct_change().corr(method ='spearman'), annot=True)<br/>plt.savefig('chart2', dpi=300)</span></pre><figure class="jz ka kb kc fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kp"><img src="../Images/6c3455bb9c618e9c03dcf8079696e08a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BKhCmbAPZvkggBPc3I3kHA.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">历史累积回报</figcaption></figure><figure class="jz ka kb kc fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lb"><img src="../Images/d5bb71ac1ee63b63f697dacb2e04d0d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fYAg2vFhdPzQiq8KGCshxA.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">斯皮尔曼相关矩阵</figcaption></figure><p id="3052" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">两种债券基金的历史回报大致相同。QNIFTY回报有跳跃。这是因为基金规模小导致流动性不足。债务基金和股票之间的相关性范围从0.091到0.13，这是相当低的，有助于投资组合的多样化。</p></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="0497" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">建立一个60%股权和40%债务的投资组合，并使用每年再平衡的zipline进行回溯测试</strong></p><p id="0d35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用Quantopian zipline创建初始投资组合，QNIFTY的权重为60%，Aditya Birla Sun Life公司债券和HDFC短期债务增长的权重各为20%。我们将使用zipline从2011年1月1日到2020年6月9日进行回溯测试，并确保它每年重新平衡一次，并遵守这些重量。</p><p id="e8da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下代码执行以下任务:</p><ol class=""><li id="daac" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">在<code class="du lc ld le ke b">initialize</code>函数中创建初始投资组合权重，交易费用为0.4%。</li><li id="6180" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><code class="du lc ld le ke b">rebalance_freq</code>和<code class="du lc ld le ke b">rebalance</code>功能用于根据<code class="du lc ld le ke b">initialize </code>功能中定义的指定权重管理再平衡和下单。</li><li id="c376" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">函数<code class="du lc ld le ke b"> zipline.run_algorithm</code>触发回测算法，初始资金20万。</li></ol><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="57e3" class="ki kj hi ke b fi kk kl l km kn">#Commission and Slippage Settings<br/>enable_commission = True<br/>commission_pct = 0.004 # 0.4% commission on buy/ sell</span><span id="cd87" class="ki kj hi ke b fi ko kl l km kn">def initialize(context):</span><span id="6da4" class="ki kj hi ke b fi ko kl l km kn"># Set commission<br/>    if enable_commission:<br/>        comm_model = PerDollar(cost=commission_pct)<br/>    else:<br/>        comm_model = PerDollar(cost=0.0)<br/>    set_commission(comm_model)<br/>    <br/>    # counter for rebalance quarterly<br/>    context.counter = 0<br/>    <br/>    # Securities and target weights<br/>    context.securities = {'QNIFTY': 0.6,      # Quantum Nifty Exchange Traded Scheme<br/>                          'MF103178' : 0.2,  # Aditya Birla Sun Life Corporate Bond Fund<br/>                          'MF113047' : 0.2}  # HDFC Short Term Debt Growth<br/>                          <br/>    schedule_function(rebalance_freq, <br/>                      date_rules.month_start(), <br/>                      time_rules.market_open())</span><span id="f42f" class="ki kj hi ke b fi ko kl l km kn"># rebalance once a year only<br/>def rebalance_freq(context, data):  <br/>    freq_month = 12  <br/>    context.counter += 1  <br/>    if context.counter == freq_month:  <br/>        rebalance(context, data)  <br/>        context.counter = 0</span><span id="6527" class="ki kj hi ke b fi ko kl l km kn"># rebalance order percentages<br/>def rebalance(context, data):<br/>    # Loop through the securities<br/>    for sec, weight in context.securities.items():<br/>        sym = symbol(sec)<br/>        # Check if we can trade<br/>        if data.can_trade(sym):<br/>            # Reset the weight<br/>            order_target_percent(sym, weight)<br/>            print('today...',zipline.api.get_datetime().date())</span><span id="e8fc" class="ki kj hi ke b fi ko kl l km kn"># Fire the backtest<br/>result = zipline.run_algorithm(<br/>    start=start, # Set start<br/>    end=end,  # Set end<br/>    analyze=None, <br/>    initialize=initialize, # Define startup function<br/>    capital_base=200000, # Set initial capital<br/>    data_frequency = 'daily',  # Set data frequency<br/>    bundle= 'nse_data')</span></pre></div><div class="ab cl jd je gp jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="hb hc hd he hf"><p id="b4f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">生成投资组合和基准的业绩统计，以进行比较和对比</strong></p><p id="0b8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用Quantopian Inc .的另一个开源软件pyfolio进行性能分析。pyfolio可以很好地与zipline配合使用，尽管它也可以独立使用。</p><p id="3c2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下代码执行以下任务:</p><ol class=""><li id="85b8" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">从回溯测试结果中提取投资组合所需的输入。</li><li id="c19b" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">获取基准-S&amp;P BSE-100日收益率进行比较和对比。</li><li id="2a43" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">借助pyfolio生成性能统计数据。</li></ol><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e8a4" class="ki kj hi ke b fi kk kl l km kn"># extract the inputs needed for pyfolio<br/>returns, positions, transactions = pf.utils.extract_rets_pos_txn_from_zipline(result)</span><span id="b08e" class="ki kj hi ke b fi ko kl l km kn"># returns for the strategy<br/>returns.name = 'Strategy'<br/>returns.head(2)</span><span id="1e4a" class="ki kj hi ke b fi ko kl l km kn"># get the benchmark returns<br/>benchmark_rets = symbols_prices['BSE-100'].pct_change().dropna()<br/>benchmark_rets.index = benchmark_rets.index.tz_localize('UTC')<br/>benchmark_rets = benchmark_rets.filter(returns.index)<br/>benchmark_rets.name = 'S&amp;P BSE-100'<br/>benchmark_rets.head(2)</span><span id="8c3d" class="ki kj hi ke b fi ko kl l km kn"># generate performance stats with pyfolio<br/>fig = pf.create_returns_tear_sheet(returns, benchmark_rets=benchmark_rets, positions=positions, transactions=transactions)<br/>plt.savefig('chart3', dpi=800)</span><span id="13e6" class="ki kj hi ke b fi ko kl l km kn"># benchmark - S&amp;P BSE-100 performace stats<br/>pf.show_perf_stats(benchmark_rets)</span></pre><p id="e4ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看strategy和benchmark的性能统计数据。</p><figure class="jz ka kb kc fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lf"><img src="../Images/1e44dbd6b1b0591d6d420620dccd66e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ycHN_8EIfmjXuHhHRehCQw.png"/></div></div></figure><p id="ad4e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以看到，与基准S&amp;P BSE-100相比，该策略在所有参数上都表现出色，如年回报率、年波动性、夏普比率、稳定性和最大提款。我们还可以根据其中的一些参数来进一步可视化性能。</p><figure class="jz ka kb kc fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lg"><img src="../Images/0c5ea79b75e9c7f4817e58e30b9e97ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1152hK7yeX2d9LC-h2ag_A.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">战略与基准</figcaption></figure><figure class="jz ka kb kc fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lh"><img src="../Images/94d8f3d18dab64ca33ba9c774d9ebfb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KN8nGXx97ciOHbnvUDZy2A.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">战略绩效</figcaption></figure><p id="6804" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在这项研究中使用了债务共同基金和QNIFTY for equity ETF，因为我希望有一个更长的回顾期来进行回溯测试。印度市场现在有许多更大规模的ETF选择，包括债券和股票，供投资者选择。像这样的策略对于保守的投资者来说是个不错的选择。此外，如果投资组合在回顾期只有债务，投资者会做得更好。然而，我们需要记住，股票在历史上表现好于债券，过去十年可能是债券表现优于债券的一个特例。投资愉快:)</p><p id="97b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意:此分析仅用于教育目的，作者不对您的任何投资决策负责。</p></div></div>    
</body>
</html>