<html>
<head>
<title>Swift and Firebase — Datasource Duplication?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift和Firebase——数据源复制？</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/swift-and-firebase-datasource-repeating-dea13af8e367?source=collection_archive---------11-----------------------#2019-10-19">https://medium.com/analytics-vidhya/swift-and-firebase-datasource-repeating-dea13af8e367?source=collection_archive---------11-----------------------#2019-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b6db" class="pw-subtitle-paragraph in hh hi bd b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je dx translated"><strong class="ak">充满自信地聆听和观察的隔音方法。</strong></h2></div><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/ca10cff9f4c371f18316b626a36db77d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sixUDDLxhRBbnqYHJx_FJg.jpeg"/></div></div></figure><h1 id="53be" class="jr js hi bd jt ju jv jw jx jy jz ka kb iw kc ix kd iz ke ja kf jc kg jd kh ki bi translated"><span class="l if ig ih bm ii ij ik il im di"> P </span>先决条件</h1><p id="14e5" class="pw-post-body-paragraph kj kk hi kl b km kn ir ko kp kq iu kr ks kt ku kv kw kx ky kz la lb lc ld le hb bi translated">通过谷歌(实时数据库)对Swift和Firebase的基本了解。</p><h2 id="7b78" class="lf js hi bd jt lg lh li jx lj lk ll kb ks lm ln kd kw lo lp kf la lq lr kh ls bi translated">这是干什么用的？</h2><p id="8725" class="pw-post-body-paragraph kj kk hi kl b km kn ir ko kp kq iu kr ks kt ku kv kw kx ky kz la lb lc ld le hb bi translated">从实时数据库中加载任何类型的JSON数据，无论是加载社交提要还是下拉用户列表。这里的关键要素是以100%的准确度进行观察和自动更新。此外，当数据完成加载时，我们将调用一个完成处理程序。我们开始吧！</p><h2 id="94fc" class="lf js hi bd jt lg lh li jx lj lk ll kb ks lm ln kd kw lo lp kf la lq lr kh ls bi translated"><strong class="ak">跳跃中</strong></h2><p id="e14d" class="pw-post-body-paragraph kj kk hi kl b km kn ir ko kp kq iu kr ks kt ku kv kw kx ky kz la lb lc ld le hb bi translated">在所有选择后端的选项中，你选择了Google的Firebase，实时数据库。明白了。当你开始在你的UICollection和UITableViews中填充优秀的内容时，砰的一声，重复的悲剧发生了。您正在删除侦听器并清除数据源数组。有什么问题！？让我们用一种完全证明的方法来解决这个问题，无所畏惧地观察和倾听。</p><h2 id="eef1" class="lf js hi bd jt lg lh li jx lj lk ll kb ks lm ln kd kw lo lp kf la lq lr kh ls bi translated"><strong class="ak">观察概述</strong></h2><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="6b55" class="lf js hi lu b fi ly lz l ma mb">Step 1: .observe(.value</span><span id="346e" class="lf js hi lu b fi mc lz l ma mb">Step 2: .observeSingleEvent(of: .value</span><span id="f1ca" class="lf js hi lu b fi mc lz l ma mb">Step 3: .observe(.childAdded</span></pre><h2 id="762e" class="lf js hi bd jt lg lh li jx lj lk ll kb ks lm ln kd kw lo lp kf la lq lr kh ls bi translated">履行</h2><p id="869c" class="pw-post-body-paragraph kj kk hi kl b km kn ir ko kp kq iu kr ks kt ku kv kw kx ky kz la lb lc ld le hb bi translated">让我们创建一个新类，并在viewDidLoad函数上方添加一些变量，然后导入Firebase。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="a184" class="lf js hi lu b fi ly lz l ma mb">let databaseRef = Database.database().reference()</span><span id="1158" class="lf js hi lu b fi mc lz l ma mb">var observingRefOne = Database.database().reference()</span><span id="7474" class="lf js hi lu b fi mc lz l ma mb">var handleOne = DatabaseHandle()</span><span id="16ce" class="lf js hi lu b fi mc lz l ma mb">var compileCounter : Int = 0</span></pre><h2 id="be40" class="lf js hi bd jt lg lh li jx lj lk ll kb ks lm ln kd kw lo lp kf la lq lr kh ls bi translated">功能</h2><p id="9e88" class="pw-post-body-paragraph kj kk hi kl b km kn ir ko kp kq iu kr ks kt ku kv kw kx ky kz la lb lc ld le hb bi translated">让我们创建一个名为fetchCurrentChatMessages的函数，它在完成时进行转义。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="abdb" class="lf js hi lu b fi ly lz l ma mb">func fetchCurrentChatMessages(completion : @escaping (_ isComplete : Bool)-&gt;()) {</span><span id="49bd" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="89e1" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">步骤1:让我们检查授权并添加观察者。这将监听路径末端的任何变化，并再次触发该函数。确保在这里使用自己的路径。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="529c" class="lf js hi lu b fi ly lz l ma mb">func fetchCurrentChatMessages(completion : @escaping (_ isComplete : Bool)-&gt;()) {</span><span id="cca5" class="lf js hi lu b fi mc lz l ma mb">guard let user_uid = Auth.auth().currentUser?.uid else {return}</span><span id="920e" class="lf js hi lu b fi mc lz l ma mb">let ref = self.databaseRef.child(“messages”).child(user_uid)</span><span id="00cf" class="lf js hi lu b fi mc lz l ma mb">ref.observe(.value, with: { (snapListener : DataSnapshot) in</span><span id="844b" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="2001" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="89c3" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="6d95" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="a037" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">第2步:让我们添加compileCounter变量，看看我们要遍历多少个对象，并确保数据确实存在。如果没有，我们稍后将调用失败状态。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="5030" class="lf js hi lu b fi ly lz l ma mb">func fetchCurrentChatMessages(completion : @escaping (_ isComplete : Bool)-&gt;()) {</span><span id="1ae9" class="lf js hi lu b fi mc lz l ma mb">guard let user_uid = Auth.auth().currentUser?.uid else {return}</span><span id="f969" class="lf js hi lu b fi mc lz l ma mb">let ref = self.databaseRef.child(“messages”).child(user_uid)</span><span id="f522" class="lf js hi lu b fi mc lz l ma mb">ref.observe(.value, with: { (snapListener : DataSnapshot) in</span><span id="e42a" class="lf js hi lu b fi mc lz l ma mb">ref.observeSingleEvent(of: .value, with: { (snapCount : DataSnapshot) in</span><span id="d7f9" class="lf js hi lu b fi mc lz l ma mb">if snapCount.exists() {</span><span id="03f2" class="lf js hi lu b fi mc lz l ma mb">let snapChildrenCount = snapCount.childrenCount</span><span id="daec" class="lf js hi lu b fi mc lz l ma mb">} else if !snapCount.exists() {</span><span id="7308" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="3999" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="352e" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="f140" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="d7a9" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="9ab0" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="8e44" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="b77b" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="4ee5" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="a8eb" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">第三步:现在是棘手的部分。让我们添加一个观察器，它遍历所有现有对象并连接我们的句柄，同时将我们的compileCounter变量增加1。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="724f" class="lf js hi lu b fi ly lz l ma mb">func fetchCurrentChatMessages(completion : @escaping (_ isComplete : Bool)-&gt;()) {</span><span id="4335" class="lf js hi lu b fi mc lz l ma mb">guard let user_uid = Auth.auth().currentUser?.uid else {return}</span><span id="58aa" class="lf js hi lu b fi mc lz l ma mb">let ref = self.databaseRef.child(“messages”).child(user_uid)</span><span id="284c" class="lf js hi lu b fi mc lz l ma mb">ref.observe(.value, with: { (snapListener : DataSnapshot) in</span><span id="8d05" class="lf js hi lu b fi mc lz l ma mb">ref.observeSingleEvent(of: .value, with: { (snapCount : DataSnapshot) in</span><span id="48ea" class="lf js hi lu b fi mc lz l ma mb">if snapCount.exists() {</span><span id="9e0f" class="lf js hi lu b fi mc lz l ma mb">let snapChildrenCount = snapCount.childrenCount</span><span id="a027" class="lf js hi lu b fi mc lz l ma mb">self.observingRefOne = self.databaseRef.child(“messages”).child(user_uid)</span><span id="cad0" class="lf js hi lu b fi mc lz l ma mb">self.handleOne = self.observingRefOne.observe(.childAdded, with: { (snapLoop : DataSnapshot) in</span><span id="5f3a" class="lf js hi lu b fi mc lz l ma mb">self.compileCounter += 1</span><span id="e805" class="lf js hi lu b fi mc lz l ma mb">guard let json = snapLoop.value as? [String : Any] else {return}</span><span id="105d" class="lf js hi lu b fi mc lz l ma mb">//APPEND YOUR OBJECT DATA AND ORGANIZE/FILTER AS NEEDED</span><span id="615b" class="lf js hi lu b fi mc lz l ma mb">if self.compileCounter == snapChildrenCount {</span><span id="2d88" class="lf js hi lu b fi mc lz l ma mb">completion(true)</span><span id="d1ab" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="4645" class="lf js hi lu b fi mc lz l ma mb">}, withCancel: { (error) in</span><span id="241a" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="9786" class="lf js hi lu b fi mc lz l ma mb">})</span><span id="8f3c" class="lf js hi lu b fi mc lz l ma mb">} else if !snapCount.exists() {</span><span id="b324" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="df5b" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="282e" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="1a8f" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="ec8e" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="f567" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="4421" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="d3a0" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="7a1c" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="96f4" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">一旦我们的compileCounter变量与我们的snapChildrenCount常量匹配，我们就调用完成处理程序，因为我们的数据已经被加载了！现在我们需要移除我们的观察者。我们的完成处理程序应该根据它的完成状态调用两个函数。首先，确保在viewDidLoad中调用fetchCurrentChatMessages函数，或者将它放入一个新函数中，以保持代码的整洁。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="7d07" class="lf js hi lu b fi ly lz l ma mb">self.fetchCurrentChatMessages { (isComplete) in</span><span id="83e4" class="lf js hi lu b fi mc lz l ma mb">if isComplete == true {</span><span id="cc3d" class="lf js hi lu b fi mc lz l ma mb">self.handleSuccess()</span><span id="60d0" class="lf js hi lu b fi mc lz l ma mb">} else if isComplete == false {</span><span id="28ce" class="lf js hi lu b fi mc lz l ma mb">self.handleFailure()</span><span id="9dd4" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="8dfe" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="fd40" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">现在，添加handleSuccess和handleFailure函数。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="07a1" class="lf js hi lu b fi ly lz l ma mb">func handleSuccess() {</span><span id="ce95" class="lf js hi lu b fi mc lz l ma mb">self.compileCounter = 0</span><span id="48f0" class="lf js hi lu b fi mc lz l ma mb">self.observingRefOne.removeObserver(withHandle: self.handleOne)</span><span id="2d14" class="lf js hi lu b fi mc lz l ma mb">DispatchQueue.main.async {</span><span id="f946" class="lf js hi lu b fi mc lz l ma mb">//RELOAD YOUR COLLECTION OR TABLE VIEW</span><span id="0527" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="9ad9" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="b499" class="lf js hi lu b fi mc lz l ma mb">func handleFailure() {</span><span id="2358" class="lf js hi lu b fi mc lz l ma mb">self.compileCounter = 0</span><span id="2ff4" class="lf js hi lu b fi mc lz l ma mb">self.messageArray.removeAll() // REPLACE THIS WITH YOUR DATASOURCE</span><span id="8348" class="lf js hi lu b fi mc lz l ma mb">self.observingRefOne.removeObserver(withHandle: self.handleOne)</span><span id="ba56" class="lf js hi lu b fi mc lz l ma mb">DispatchQueue.main.async {</span><span id="2c11" class="lf js hi lu b fi mc lz l ma mb">//RELOAD YOUR COLLECTION OR TABLE VIEW</span><span id="a742" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="5798" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="7b0e" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">最后，确保在再次调用observer后，清除datasource数组并重置compileCounter变量。最终的fetchCurrentChatMessages函数应该如下所示。</p><pre class="jg jh ji jj fd lt lu lv lw aw lx bi"><span id="61bd" class="lf js hi lu b fi ly lz l ma mb">func fetchCurrentChatMessages(completion : @escaping (_ isComplete : Bool)-&gt;()) {</span><span id="4665" class="lf js hi lu b fi mc lz l ma mb">guard let user_uid = Auth.auth().currentUser?.uid else {return}</span><span id="4487" class="lf js hi lu b fi mc lz l ma mb">let ref = self.databaseRef.child(“messages”).child(user_uid)</span><span id="9ad6" class="lf js hi lu b fi mc lz l ma mb">ref.observe(.value, with: { (snapListener : DataSnapshot) in</span><span id="20ca" class="lf js hi lu b fi mc lz l ma mb">self.compileCounter = 0</span><span id="1990" class="lf js hi lu b fi mc lz l ma mb">self.messageArray.removeAll() // REPLACE THIS WITH YOUR DATASOURCE</span><span id="cc4d" class="lf js hi lu b fi mc lz l ma mb">ref.observeSingleEvent(of: .value, with: { (snapCount : DataSnapshot) in</span><span id="3fe0" class="lf js hi lu b fi mc lz l ma mb">if snapCount.exists() {</span><span id="e26c" class="lf js hi lu b fi mc lz l ma mb">let snapChildrenCount = snapCount.childrenCount</span><span id="f0f7" class="lf js hi lu b fi mc lz l ma mb">self.observingRefOne = self.databaseRef.child(“messages”).child(user_uid)</span><span id="ef88" class="lf js hi lu b fi mc lz l ma mb">self.handleOne = self.observingRefOne.observe(.childAdded, with: { (snapLoop : DataSnapshot) in</span><span id="e454" class="lf js hi lu b fi mc lz l ma mb">self.compileCounter += 1</span><span id="bdcf" class="lf js hi lu b fi mc lz l ma mb">guard let json = snapLoop.value as? [String : Any] else {return}</span><span id="c77b" class="lf js hi lu b fi mc lz l ma mb">//APPEND YOUR OBJECT DATA AND ORGANIZE/FILTER AS NEEDED</span><span id="ff58" class="lf js hi lu b fi mc lz l ma mb">if self.compileCounter == snapChildrenCount {</span><span id="ae92" class="lf js hi lu b fi mc lz l ma mb">completion(true)</span><span id="1986" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="e784" class="lf js hi lu b fi mc lz l ma mb">}, withCancel: { (error) in</span><span id="b36d" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="4f61" class="lf js hi lu b fi mc lz l ma mb">})</span><span id="08ba" class="lf js hi lu b fi mc lz l ma mb">} else if !snapCount.exists() {</span><span id="e5bf" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="1f39" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="d7ff" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="6062" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="df3a" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="f38c" class="lf js hi lu b fi mc lz l ma mb">}) { (error) in</span><span id="34b4" class="lf js hi lu b fi mc lz l ma mb">completion(false)</span><span id="06a4" class="lf js hi lu b fi mc lz l ma mb">}</span><span id="8462" class="lf js hi lu b fi mc lz l ma mb">}</span></pre><p id="85ec" class="pw-post-body-paragraph kj kk hi kl b km md ir ko kp me iu kr ks mf ku kv kw mg ky kz la mh lc ld le hb bi translated">就是这样！您现在可以监听/观察并自动更新您的UICollection和UITableViews，而无需重复数据！请根据需要随意复制和粘贴！</p></div></div>    
</body>
</html>