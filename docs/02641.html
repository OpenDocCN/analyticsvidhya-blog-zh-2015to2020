<html>
<head>
<title>Image data augmentation to balance dataset in classification tasks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在分类任务中平衡数据集的图像数据扩充</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/image-data-augmentation-to-balance-dataset-in-classification-tasks-5e25bbd9a228?source=collection_archive---------2-----------------------#2019-12-27">https://medium.com/analytics-vidhya/image-data-augmentation-to-balance-dataset-in-classification-tasks-5e25bbd9a228?source=collection_archive---------2-----------------------#2019-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="48f9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">尝试使用不平衡数据集的影像分类模型，并通过数据增强技术提高其准确性。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/a397a29555a3d94fd225eb7ff234fe4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Be41Veo_NPmvBQaV"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">美国地质勘探局在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="de29" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们将从最小且不平衡的数据集创建一个图像分类模型，然后使用数据增强技术来平衡和比较结果。</p><h1 id="f0d7" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">数据集</h1><p id="8754" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">我们的数据集有200幅花的图像和20幅鸟的图像，比例为1:10。为了形成这个数据集，我们使用了通过谷歌搜索引擎下载图像URL的技术，正如在<a class="ae jn" rel="noopener" href="/analytics-vidhya/fantastic-and-straightforward-image-classification-with-fastai-library-for-pytorch-30c3380ac284">的上一篇文章</a>中一步一步描述的那样。</p><h2 id="bb57" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">下载和检查图像</h2><p id="d4ca" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">一旦我们有了CSV文件中每个类别的URL列表，我们将运行代码来下载照片并构建我们的数据集。路径' data/data_aug '是我们的基本目录。在那个目录中，我们放置了两个CSV文件的类别；让我们执行代码来创建下载图像的子目录，并验证它们。</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="fe8b" class="lh kl hi lw b fi ma mb l mc md">%reload_ext autoreload<br/>%autoreload 2<br/>%matplotlib inline<br/>from fastai.vision import *</span><span id="e657" class="lh kl hi lw b fi me mb l mc md">classes = ['birds','flowers']<br/>path = Path('data/data_aug')</span><span id="4f81" class="lh kl hi lw b fi me mb l mc md">#creating folders<br/>for folder in classes:<br/>   dest = path/folder<br/>   dest.mkdir(parents=True, exist_ok=True)</span><span id="bece" class="lh kl hi lw b fi me mb l mc md">#downloading images from urls in csv<br/>file = 'urls_'+'<strong class="lw hj">birds</strong>''.csv'<br/>dest = path/'birds'<br/>download_images(path/file, dest, max_pics=<strong class="lw hj">20</strong>)</span><span id="cd56" class="lh kl hi lw b fi me mb l mc md">file = 'urls_'+'<strong class="lw hj">flowers</strong>''.csv'<br/>dest = path/'flowers'<br/>download_images(path/file, dest, max_pics=<strong class="lw hj">200</strong>)</span><span id="2484" class="lh kl hi lw b fi me mb l mc md">#verifying images<br/>for c in classes:<br/>   print(c)<br/>   verify_images(path/c, delete=True, max_size=500)</span></pre><h2 id="b709" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">创建和可视化数据集</h2><p id="6bf2" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">在下载照片并在对应于每个类别的目录中检查后，我们可以创建一个fast.ai数据框架，以便能够将标记的图像放入其中，并开始可视化和使用它们。我们保留20%用于验证设置。</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="ef67" class="lh kl hi lw b fi ma mb l mc md">np.random.seed(7)</span><span id="496d" class="lh kl hi lw b fi me mb l mc md">data = ImageDataBunch.from_folder(path, train=".", <strong class="lw hj">valid_pct=0.2</strong>, ds_tfms=get_transforms(), size=224, num_workers=4).normalize(imagenet_stats)</span></pre><p id="a1e4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">并运行代码来显示一个随机的3行批处理:</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="deca" class="lh kl hi lw b fi ma mb l mc md">data_gt.show_batch(rows=3, figsize=(7,8))</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mf"><img src="../Images/2c0debccfb4a5aac6e2fcc9a607dcc9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*D2f-tZqmftQlYHcpZZUxAw.png"/></div></figure><h1 id="bd72" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">分类模型</h1><p id="439a" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">在本练习中，我们将使用resnet34格式的卷积网络。<br/>在“模型”中，有一组预定义的网络架构，涉及不同的结构和复杂性。</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="d904" class="lh kl hi lw b fi ma mb l mc md">learn_gt = cnn_learner(data_gt, models.resnet34, metrics=error_rate)</span><span id="cc45" class="lh kl hi lw b fi me mb l mc md">learn_gt.fit_one_cycle(4)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mg"><img src="../Images/d0ee004122617b16a88880150a52bdb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*vjcKihCXam5f59VSOpDcSQ.png"/></div></figure><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="ca31" class="lh kl hi lw b fi ma mb l mc md">learn_gt.save('gt_stage-1')<br/>learn_gt.load('gt_stage-1')<br/>learn_gt.unfreeze()</span><span id="42de" class="lh kl hi lw b fi me mb l mc md">learn_gt.lr_find()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mh"><img src="../Images/8972ce6995e52f338d1ce6ed82aa1eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:908/format:webp/1*0Oy86t-xOByFF0cVFL9Fkg.png"/></div></figure><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="9605" class="lh kl hi lw b fi ma mb l mc md">learn_gt.fit_one_cycle(2, max_lr=slice(1e-5,1e-2))<br/>learn_gt.save('gt_stage-2')<br/>learn_gt.load('gt_stage-2')</span></pre><h2 id="c295" class="lh kl hi bd km li lj lk kq ll lm ln ku jx lo lp kw kb lq lr ky kf ls lt la lu bi translated">混淆矩阵中的结果</h2><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="422b" class="lh kl hi lw b fi ma mb l mc md">interp = ClassificationInterpretation.from_learner(learn_gt)<br/>interp.plot_confusion_matrix()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mi"><img src="../Images/2dbc36b2cd428f5b131d3b88da2673f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/format:webp/1*H_6--Ez4K_8Ep2jHJ0PTpw.png"/></div></figure><p id="25f7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">正如我们可以看到的，该模型在预测类别<br/>较少代表的类别(鸟类)方面非常无效，其中存在许多关于验证集的混淆。</p><h1 id="bfb3" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">数据扩充</h1><p id="1ed3" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">我们必须在鸟的类别中创建180个新的图像。为此，我们将使用fast.ai的apply_tfms方法遍历每个真实图像，为每个图像创建十个额外的图片。</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="d757" class="lh kl hi lw b fi ma mb l mc md">path = Path('data/data_aug')<br/>path_hr = path/'birds'</span><span id="0463" class="lh kl hi lw b fi me mb l mc md">il = ImageList.from_folder(path_hr)<br/>tfms = get_transforms(max_rotate=25)</span><span id="81c1" class="lh kl hi lw b fi me mb l mc md">def data_aug_one(ex_img,prox,qnt):<br/>   for lop in range(0,qnt):<br/>      image_name = str(prox).zfill(8) +'.jpg'<br/>      dest = path_hr/image_name<br/>      prox = prox + 1<br/>      new_img = open_image(ex_img)<br/>      new_img_fin = new_img.apply_tfms(tfms[0], new_img, xtra={tfms[1][0].tfm: {"size": 224}}, size=224)<br/>      new_img_fin.save(dest)</span><span id="dbcd" class="lh kl hi lw b fi me mb l mc md">prox = 20<br/>qnt = 10<br/>for imagen in il.items:<br/>   data_aug_one(imagen,prox,qnt)<br/>   prox = prox + qnt</span></pre><p id="775d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果我们将任何一个源图像和它们的10个新图像可视化，我们会发现这样的事情:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mj"><img src="../Images/c0c5fab1a48fffd149745f0ebc8e447e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KFDYBcQCn8Ckxs5aOkGE_Q.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">左边是原图，右边是10张变换后图像</figcaption></figure><p id="8f87" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">关于“应用_tfms”转换功能工作及其所有可能性的详细信息可在此处找到<a class="ae jn" href="https://docs.fast.ai/vision.transform.html#get_transforms" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="6053" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">具有平衡数据的相同模型</h1><p id="9ab1" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">我们用平衡的数据集创建了一个新的模型</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="f390" class="lh kl hi lw b fi ma mb l mc md">np.random.seed(7)</span><span id="6b66" class="lh kl hi lw b fi me mb l mc md">tfms = get_transforms()<br/>data = ImageDataBunch.from_folder(path, train=".", valid_pct=0.2, ds_tfms=tfms, size=224, num_workers=4).normalize(imagenet_stats)</span><span id="1271" class="lh kl hi lw b fi me mb l mc md">learn = cnn_learner(data, models.resnet34, metrics=error_rate)<br/>learn.fit_one_cycle(4)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mk"><img src="../Images/2e40b2f4b7ffc2cfb0495bca586d3ada.png" data-original-src="https://miro.medium.com/v2/resize:fit:680/format:webp/1*2yFCnzpevSsxgLS20cuuWQ.png"/></div></figure><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="5017" class="lh kl hi lw b fi ma mb l mc md">interp = ClassificationInterpretation.from_learner(learn)<br/>interp.plot_confusion_matrix()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ml"><img src="../Images/21cb4027f499008a21613e206012f755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J1QUiCsvHMJN3nc63oXOew.png"/></div></div></figure><h1 id="c213" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">好了，现在让我们展示一组新的图像</h1><p id="6cb9" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">我们拍摄了20张新图片，每个类别10张，我们看到，尽管准确性比最初的版本有了很大的提高，但在分类时仍然存在一些问题。在20张新图片中，该模型预测了18张正确的图片和两张错误的图片:</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="6008" class="lh kl hi lw b fi ma mb l mc md">path = Path('data/data_aug_test')<br/>defaults.device = torch.device('cpu')<br/>img = open_image(path/'bird01.jpg')<br/>img</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mm"><img src="../Images/3e01960408edcba3c4b165a8e9b6ce37.png" data-original-src="https://miro.medium.com/v2/resize:fit:550/format:webp/1*SyqqQoBE8qdIcskS6EQ4PQ.jpeg"/></div></figure><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="c4f4" class="lh kl hi lw b fi ma mb l mc md">pred_class,pred_idx,outputs = learn.predict(img)<br/>pred_class</span></pre><p id="812b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">鸟类分类</p><pre class="iy iz ja jb fd lv lw lx ly aw lz bi"><span id="8ce0" class="lh kl hi lw b fi ma mb l mc md">for test in range(1,11):<br/>   image_name = 'bird'+str(test).zfill(2)+'.jpg'<br/>   img = open_image(path/image_name)<br/>   pred_class,pred_idx,outputs = learn.predict(img)<br/>   print ('For image ' + image_name + ' predicted class: ');<br/>   print (pred_class)</span><span id="1acd" class="lh kl hi lw b fi me mb l mc md">   image_name = 'flower'+str(test).zfill(2)+'.jpg'<br/>   img = open_image(path/image_name)<br/>   pred_class,pred_idx,outputs = learn.predict(img)<br/>   print ('For image ' + image_name + ' predicted class: ');<br/>   print (pred_class)</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mn"><img src="../Images/ba0785b124f12a22ed282fe3ee84a8a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/format:webp/1*VABB-fKZCB3BxQjc63Z9EA.png"/></div></figure><p id="7215" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">flower07.jpg预言的鸟的形象，和bird08.jpg预言的花的形象。</p><p id="85d8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是混乱的图像:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mo"><img src="../Images/9356c5defbe9f9ad892ae11dcff455bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fPj3texiXUhkg_kyAUAV2g.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">bird08.jpg</figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mp"><img src="../Images/221b7a2998395e319466ceec466629e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:366/format:webp/1*6mKWBPj8G32tSIVP5tCrQg.jpeg"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">flower07.jpg</figcaption></figure><h1 id="8b90" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">摘要</h1><p id="f3d9" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">正如我们所看到的，用平衡数据集和不平衡数据集训练同一个模型的区别是根本性的；但是，如果数据集很小，可能是我们达到的精度不够。</p><p id="76e9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在之前的<a class="ae jn" rel="noopener" href="/analytics-vidhya/fantastic-and-straightforward-image-classification-with-fastai-library-for-pytorch-30c3380ac284">文章</a>中，我们从每个类别的200张图片中创建了一个非常相似的模型。当我们向他展示同样的20张新的测试图像时，他在同样的照片中也有同样的困惑。</p><p id="b899" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们使用fast.ai的apply_tfms方法对少量鸟类的初始图像进行转换，创建了10倍大的数据集。</p><h1 id="3023" class="kk kl hi bd km kn ko kp kq kr ks kt ku io kv ip kw ir kx is ky iu kz iv la lb bi translated">来源和参考</h1><p id="d973" class="pw-post-body-paragraph jo jp hi jq b jr lc ij jt ju ld im jw jx le jz ka kb lf kd ke kf lg kh ki kj hb bi translated">[1]—<a class="ae jn" href="https://towardsdatascience.com/an-overview-of-resnet-and-its-variants-5281e2f56035" rel="noopener" target="_blank">https://towards data science . com/an-overview-of-resnet-and-its-variants-5281 e2f 56035</a></p><p id="81f4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">[2]—<a class="ae jn" rel="noopener" href="/@14prakash/understanding-and-implementing-architectures-of-resnet-and-resnext-for-state-of-the-art-image-cf51669e1624">https://medium . com/@ 14 Prakash/understanding-and-implementing-architectures-of-resnet-and-resnext-for-state-the-art-image-cf 51669 e 1624</a></p><div class="mq mr ez fb ms mt"><a rel="noopener follow" target="_blank" href="/usf-msds/deep-learning-best-practices-1-weight-initialization-14e5c0295b94"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">深度学习最佳实践(1) —权重初始化</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">基础知识、重量初始化陷阱和最佳实践</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">medium.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh jh mt"/></div></div></a></div><p id="0f80" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在fast.ai课程中，这项技术的灵感来自:弗朗西斯科·英厄姆和杰瑞米·霍华德/ [ <a class="ae jn" href="https://www.pyimagesearch.com/2017/12/04/how-to-create-a-deep-learning-dataset-using-google-images/" rel="noopener ugc nofollow" target="_blank">阿德里安·罗斯布鲁克</a> ]</p><p id="ca2a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">https://course.fast.ai，第二课，Jupyter笔记本:第二课-下载</p></div></div>    
</body>
</html>