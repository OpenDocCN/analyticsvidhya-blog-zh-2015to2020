<html>
<head>
<title>Apache Beam: Manage your dependencies in a world without Spring/Guice…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Beam:在一个没有Spring/Guice的世界中管理您的依赖项…</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/apache-beam-a-minor-tip-for-cleaner-code-f293df3e3372?source=collection_archive---------4-----------------------#2020-02-23">https://medium.com/analytics-vidhya/apache-beam-a-minor-tip-for-cleaner-code-f293df3e3372?source=collection_archive---------4-----------------------#2020-02-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e31163f752dec524e02bfa9b3478d057.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2DYVpsxM8Wa2azG1izvcw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">布莱克·康纳利在<a class="ae iu" href="https://unsplash.com/s/photos/code-review?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="a92b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这不是一个好主意，只是ApacheBeam中隐藏的特性，你可能会在阅读整个文档时忽略它…</p><p id="f4ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Apache Beam是一个健壮的分布式流数据管道框架，它是SDK，有许多运行程序:Flink、DataFlow等等。</p><p id="cb05" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当我深入管道并必须与外部服务(如RedisClient、DB连接池或一些内部配置服务)进行通信时，我感觉我的代码开始变得混乱。</p><p id="15cd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我怀念Spring或者其他DI框架。我在一个地方定义和初始化我的服务，在另一个地方在需要时注入它们，如果没有这种能力，我必须将创建服务所需的所有参数和依赖项传递到我的<code class="du jt ju jv jw b">DoFn</code>中。<br/>除此之外，通常，服务应该是<strong class="ix hj"> singletons </strong>，这在高规模应用中非常重要，想象一下，当我的服务包含一个数据库连接池，而它不是singleton时，在这种情况下，我可能会很快达到数据库中允许的最大连接数。</p><p id="46f6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们用一个代码示例(丑陋的一个)来总结一下缺少了什么:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="kb kc l"/></div></figure><ol class=""><li id="6c4a" class="kd ke hi ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated">Singleton:创建被锁阻塞。</li><li id="8947" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">耦合:一个函数必须知道所有的Redis创建属性，即使它只需要使用它。</li><li id="5097" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">硬重构:如果我现在需要向Redis创建添加更多参数，我必须将它传递给构造函数，如果从许多地方调用它，我必须修改它们，测试可能会失败，并且这种重构容易出错。</li><li id="875f" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">测试是困难的:许多静态的、复杂的模仿依赖。</li></ol><p id="9eba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">解决方案是:</p><p id="ac62" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可能有包含所有Redis配置的管道选项:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="09ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们只需添加一个特殊选项“<code class="du jt ju jv jw b"><em class="kr">RedissonClient </em>getRedissonClient();</code>”，并用<code class="du jt ju jv jw b">@Default.InstanceFactory(RedisClientFactory.<em class="kr">class</em>)</code>对其进行注释。注释中的类是一个“知道”如何初始化我的目标服务的工厂，每个工人只需创建一次。</p><p id="0c94" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里是工厂:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="be26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的工厂获得了创建Redis客户端所需的所有属性，依赖项/参数的更改或添加仅在这里生效。</p><p id="ebeb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">变化后的<code class="du jt ju jv jw b">DoFn</code>:</p><figure class="jx jy jz ka fd ij"><div class="bz dy l di"><div class="kb kc l"/></div></figure><p id="52cc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">注意事项:</strong></p><ol class=""><li id="9dce" class="kd ke hi ix b iy iz jc jd jg kf jk kg jo kh js ki kj kk kl bi translated">在<code class="du jt ju jv jw b">@ProcessElement</code>范围外没有DI，只能从<code class="du jt ju jv jw b">DoFn</code>功能访问选项。</li><li id="3a66" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">毫无特色，没有AOP，实例生命周期挂钩。</li><li id="928e" class="kd ke hi ix b iy km jc kn jg ko jk kp jo kq js ki kj kk kl bi translated">实例总是在懒惰模式下初始化，只有当你请求它们时，它们才会被创建，没有办法克服这一点。</li></ol><p id="3484" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为什么不是春天？</p><p id="a96b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Apache Beam没有在worker初始化时暴露hook，所以我不能使用Spring，因为它需要每个worker上的一些起始点来初始化它的上下文和bean。</p><p id="44f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kr">是的，一个小的改变，非常直接，但是如果你不及时遵循它，你可能会得到耦合的、不可测试的代码，并且难以维护。</em></p></div></div>    
</body>
</html>