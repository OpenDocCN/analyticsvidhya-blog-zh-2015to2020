<html>
<head>
<title>Start Load Testing with Locust…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从蝗虫开始负载测试…</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/start-load-testing-with-locust-2600b65c22b5?source=collection_archive---------7-----------------------#2019-12-01">https://medium.com/analytics-vidhya/start-load-testing-with-locust-2600b65c22b5?source=collection_archive---------7-----------------------#2019-12-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="c8d5" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">介绍</h1><p id="c734" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">JMeter是我进行负载测试的工具，尤其是在HTTP API开发期间。但是我在配置它时总是有困难，也许是因为缺乏配置灵活性，也许它不是那么简单。</p><p id="6bd3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Locust是替代负载测试，它没有JMeter成熟，但是它解决了JMeter的一些基本问题。Locust基本上是一个基于Python的框架，与JMeter配置相反，用户需要编写代码来完成工作。作为一名开发人员，我更喜欢<strong class="jf hj">编码而不是配置</strong>，因为它提供了更多的灵活性，并且学习一点Python也不会有什么坏处(如果你还不熟悉的话)；)同样蝗虫测试可以<strong class="jf hj">轻松扩展</strong>来演示并发用户。关于JMeter和Locust的详细对比，可以参考这里[1]</p><h1 id="f2a9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">看蝗虫在行动</h1><p id="9562" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">Locust是一个基于Python的框架，所以您需要在您的机器上安装Python。我将在这个例子中使用Python3，您可以在这里找到安装python3的指南[2]</p><p id="1f4c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果你正在使用MacOSx，它可能已经有Python3了，用下面的命令验证它。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="e36c" class="kp ig hi kl b fi kq kr l ks kt">python3 --version</span></pre><h2 id="bfd1" class="kp ig hi bd ih ku kv kw il kx ky kz ip jo la lb it js lc ld ix jw le lf jb lg bi translated">REST API示例</h2><p id="f133" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们需要一个样本HTTP API来测试蝗虫。因为我们在这个例子中使用Python，所以我将使用Python Flask框架来创建一个简单的HTTP API。但是您可以使用任何您已经熟悉的方法来创建一个带有简单HTTP API的应用程序。</p><p id="1ed0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我将为每个应用程序创建两个基于Python的<strong class="jf hj">虚拟环境</strong>(REST API和Locust ),这将帮助我们将每个项目所需的所有可执行文件保存在一个隔离的环境中。因为我们使用的是Python3，所以它内嵌了venv支持。</p><p id="4504" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">你可以在这里找到我为这个演示创建的简单的REST API[3 ],通过下面的步骤你可以启动它。</p><p id="d5a0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">将HTTP API演示为四个API</p><ul class=""><li id="6771" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lm ln lo lp bi translated">[发布]:/登录</li><li id="0c70" class="lh li hi jf b jg lq jk lr jo ls js lt jw lu ka lm ln lo lp bi translated">[发布]:/注销</li><li id="c2bb" class="lh li hi jf b jg lq jk lr jo ls js lt jw lu ka lm ln lo lp bi translated">[GET]: /sampleGetApi</li><li id="0d66" class="lh li hi jf b jg lq jk lr jo ls js lt jw lu ka lm ln lo lp bi translated">[POST]: /samplePostApi</li></ul><ol class=""><li id="5055" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lv ln lo lp bi translated">创建虚拟环境[4]</li></ol><p id="e7cc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">导航到([3])<em class="lw">http-app</em>目录并运行以下命令，(这将在当前位置创建一个新目录<em class="lw"> venv </em></p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3153" class="kp ig hi kl b fi kq kr l ks kt">$ python3 -m venv venv</span></pre><p id="6481" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">2.激活虚拟环境</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="b378" class="kp ig hi kl b fi kq kr l ks kt">$ source venv/bin/activate</span></pre><p id="e15a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在Windows中</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="b1d9" class="kp ig hi kl b fi kq kr l ks kt">$ venv\Scripts\activate</span></pre><p id="58b1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">3.将烧瓶安装到venv中</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="19b7" class="kp ig hi kl b fi kq kr l ks kt">$ pip3 install flask</span></pre><p id="f65c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">4.运行应用程序</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="1617" class="kp ig hi kl b fi kq kr l ks kt">$ python3 hello_api.py</span></pre><p id="4a65" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这将在http://127.0.0.1:5000/上启动HTTP应用程序</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/da5a0725e028ff66d4e6b86ae9716a0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A1UJnyNJu1pJ-2MGLDm9Rw.png"/></div></div></figure><ul class=""><li id="38c8" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lm ln lo lp bi translated">仅供参考:您可以随时使用以下命令从venv中存在，</li></ul><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="6757" class="kp ig hi kl b fi kq kr l ks kt">$ deactivate</span></pre><h2 id="ad6a" class="kp ig hi bd ih ku kv kw il kx ky kz ip jo la lb it js lc ld ix jw le lf jb lg bi translated">奔跑的蝗虫</h2><p id="439c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">现在我们可以在我们创建的REST API上运行蝗虫负载测试。我将首先解释演示步骤，然后浏览代码。</p><ol class=""><li id="a007" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lv ln lo lp bi translated">为蝗虫创建一个虚拟环境</li></ol><p id="2d28" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">导航到([3])locust<em class="lw">-app</em>目录并运行以下命令，(这将在当前位置创建一个新目录<em class="lw"> venv </em></p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="764e" class="kp ig hi kl b fi kq kr l ks kt">$ python3 -m venv venv</span></pre><p id="5c88" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">2.激活虚拟环境</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="dce3" class="kp ig hi kl b fi kq kr l ks kt">$ source venv/bin/activate</span></pre><p id="515d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在Windows中</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="925f" class="kp ig hi kl b fi kq kr l ks kt">$ venv\Scripts\activate</span></pre><p id="1285" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">3.将蝗虫安装到venv中</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="31f7" class="kp ig hi kl b fi kq kr l ks kt">$ pip3 install locustio</span></pre><p id="394c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">4.运行应用程序(默认命令)</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="5ca7" class="kp ig hi kl b fi kq kr l ks kt">$ locust</span></pre><p id="1c69" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果文件名不是<em class="lw"> locustfile.py </em>，可以这样运行，</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="abe0" class="kp ig hi kl b fi kq kr l ks kt">$ locust -f locust_files/my_locust_file.py</span></pre><p id="aff7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这将如下启动locust服务器，</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es lx"><img src="../Images/191d574f990d06489a5895ce8aa4c7e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jVHj8gTndwwyzMU4ONtpiw.png"/></div></div></figure><p id="0776" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">5.在浏览器中打开Locust控制面板(http://localhost:8089)</p><p id="80d0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">您可以提供以下输入。Host是我们正在其上尝试负载测试的HTTP端点。为此，我将使用我在上一步中创建的端点。</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mf"><img src="../Images/aba40dbe1cb88c1e8e2e4c577de0b7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2vrJoIEq4w3u6uVdc8BMQ.png"/></div></div></figure><p id="6078" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">6.开始蜂拥而上</p><p id="598e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">单击该按钮后，负载测试将启动，过一会儿您可以停止它。在下面的结果页面中，您可以看到，登录和注销Api被调用了10次(每个用户一次)，sampleGetApi被调用的次数多于samplePostApi。</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mg"><img src="../Images/6d4df38acb184af90c7daec13419cae4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qYo3dcfi_uzI2cX_GjAh8g.png"/></div></div></figure><p id="8439" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">蝗虫代码</strong></p><p id="fd8f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果你打开<em class="lw"> locustfile.py，</em>它会是这样的。这只是Locust快速入门示例[6]的一个略微更新的版本</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mh"><img src="../Images/f69656c2395df05ba6d73eb52d7e27ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WKZ5xt-eJDHMQGzWKw0E7g.png"/></div></div></figure><p id="abc7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我将在这里讨论几个要点。更多信息可以参考[6]、[7]。</p><ol class=""><li id="11b9" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lv ln lo lp bi translated"><strong class="jf hj">用户行为</strong>类和<strong class="jf hj">网站用户</strong>类</li></ol><p id="865c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">UserBehavior <strong class="jf hj"> </strong>是TaskSet的一个子类，包含用户完成的动作，而WebsiteUser是Locust的一个子类，配置Locust测试。</p><p id="1437" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">2.启动和停止</p><p id="36ca" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">正如注释中提到的，on_start和on_stop方法将由每个线程分别在开始和结束时调用。</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mh"><img src="../Images/6204c2ef6085c26842cf5da0b8af0bfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vHg7VPrpvmwKzAcoNsgL2A.png"/></div></div></figure><p id="4f6a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">3.<code class="du mi mj mk kl b"><strong class="jf hj">@task</strong></code>注释</p><p id="bb18" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这将指定每个用户应该(迭代地)完成的每个动作，传递到注释中的数字给出了每个任务的权重。它将确保一个任务比其他任务执行得更多。</p><p id="b101" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">4.<code class="du mi mj mk kl b"><strong class="jf hj">@seq_task(n)</strong></code>注释</p><p id="2af8" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">默认情况下，任务以随机顺序执行。使用这个注释，您可以给任务执行下一个命令。</p><p id="8e29" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">5.<strong class="jf hj">任务设置</strong>和<strong class="jf hj">等待时间</strong></p><p id="8f60" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">task_set定义在执行中使用哪组任务(TaskSet的子类), wait_time定义两次任务执行之间的等待时间。</p><figure class="kg kh ki kj fd ly er es paragraph-image"><div role="button" tabindex="0" class="lz ma di mb bf mc"><div class="er es mh"><img src="../Images/efe2187f565c3f1c1dc7f6c6855b7c47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CkdwhqWXYSiGBfCfXnhlrQ.png"/></div></div></figure><p id="1334" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这就是我打算在这篇文章中介绍的全部内容，你可以参考Locust文档[6]了解所有其他很酷的特性。愉快的负载测试。</p><p id="f826" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">&gt;&gt;献给我见过的最好的QA女孩<a class="ml mm ge" href="https://medium.com/u/6ad23f43fbc0?source=post_page-----2600b65c22b5--------------------------------" rel="noopener" target="_blank">迪尔沙尼</a> :) &lt; &lt;</p><h1 id="9929" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">参考</h1><p id="69e5" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">[1].<a class="ae mn" href="https://www.blazemeter.com/blog/jmeter-vs-locust-which-one-should-you-choose/" rel="noopener ugc nofollow" target="_blank">https://www . blaze meter . com/blog/jmeter-vs-locust-which-one-should-you-choose/</a></p><p id="7f38" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">[2].<a class="ae mn" href="https://realpython.com/installing-python/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/installing-python/</a></p><p id="b27d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">[3].<a class="ae mn" href="https://github.com/erandacr/locust-tryout/tree/master/http-app" rel="noopener ugc nofollow" target="_blank">https://github . com/erandacr/locust-try out/tree/master/http-app</a></p><p id="0728" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">[4].<a class="ae mn" href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world" rel="noopener ugc nofollow" target="_blank">https://blog . miguelgrinberg . com/post/the-flask-mega-tutorial-part-I-hello-world</a></p><p id="498c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">[5].<a class="ae mn" href="https://github.com/erandacr/locust-tryout/tree/master/locust-app" rel="noopener ugc nofollow" target="_blank">https://github . com/erandacr/locust-try out/tree/master/locust-app</a></p><p id="15b7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">[6].【https://docs.locust.io/en/stable/quickstart.html T4】</p><p id="cb33" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">[7].<a class="ae mn" rel="noopener" href="/@linh22jan/load-test-with-locust-37c4f85ee2fb">https://medium . com/@ linh 22 Jan/load-test-with-locust-37 C4 f 85 ee 2 FB</a></p></div></div>    
</body>
</html>