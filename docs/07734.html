<html>
<head>
<title>Train and hyper parameter tuning model using Azure Machine learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure机器学习训练和超参数调整模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/train-and-hyper-parameter-tuning-model-using-azure-machine-learning-12ef5890fbd7?source=collection_archive---------26-----------------------#2020-07-05">https://medium.com/analytics-vidhya/train-and-hyper-parameter-tuning-model-using-azure-machine-learning-12ef5890fbd7?source=collection_archive---------26-----------------------#2020-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/27b473fc8703afcca83662c630091e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/0*H62m58dah93Tt3eL"/></div></figure><h1 id="3acf" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">用例</h1><p id="aa93" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">使用scikit RandomClassifier训练基本模型，验证并获得准确性，然后运行超参数调整。<br/>在这个例子中，我们将使用Azure机器学习管道来训练我们可以用于CI/CD的Azure DevOps</p><h1 id="06f6" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">步伐</h1><p id="ec85" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">首先训练一个基本模型。</p><p id="0132" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">让我们导入所有必需的包</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="455a" class="kw in hi ks b fi kx ky l kz la">import os</span><span id="9755" class="kw in hi ks b fi lb ky l kz la">import urllib</span><span id="c2c8" class="kw in hi ks b fi lb ky l kz la">import shutil</span><span id="beaa" class="kw in hi ks b fi lb ky l kz la">import azureml</span><span id="719f" class="kw in hi ks b fi lb ky l kz la">import pandas as pd</span><span id="6f03" class="kw in hi ks b fi lb ky l kz la">from azureml.core import Experiment</span><span id="8064" class="kw in hi ks b fi lb ky l kz la">from azureml.core import Workspace, Run</span><span id="a07c" class="kw in hi ks b fi lb ky l kz la">from azureml.core.compute import ComputeTarget, AmlCompute</span><span id="2feb" class="kw in hi ks b fi lb ky l kz la">from azureml.core.compute_target import ComputeTargetException</span><span id="0ef2" class="kw in hi ks b fi lb ky l kz la">from azureml.core import Experiment, Workspace, Run, Dataset</span><span id="9a1f" class="kw in hi ks b fi lb ky l kz la">import argparse</span><span id="f9f0" class="kw in hi ks b fi lb ky l kz la">import os<br/>import urllib<br/>import shutil<br/>import azureml<br/>import pandas as pd</span><span id="814c" class="kw in hi ks b fi lb ky l kz la">from azureml.core import Experiment<br/>from azureml.core import Workspace, Run</span><span id="077f" class="kw in hi ks b fi lb ky l kz la">from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException<br/>from azureml.core import Experiment, Workspace, Run, Dataset</span><span id="8680" class="kw in hi ks b fi lb ky l kz la">import argparse<br/>import os<br/>import pandas as pd<br/>import numpy as np<br/>import pickle<br/>import json</span><span id="89f2" class="kw in hi ks b fi lb ky l kz la">import sklearn<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.metrics import classification_report<br/>from sklearn.metrics import confusion_matrix<br/>from sklearn.metrics import accuracy_score<br/>from sklearn.metrics import roc_auc_score<br/>from sklearn.ensemble import RandomForestClassifier<br/>from sklearn.feature_selection import SelectFromModel</span><span id="2d77" class="kw in hi ks b fi lb ky l kz la">import azureml.core<br/>from azureml.core import Run<br/>from azureml.core.model import Model<br/>from azureml.core import Workspace, Dataset<br/>from azureml.core import Experiment<br/>from azureml.core import Workspace, Run</span><span id="ecd7" class="kw in hi ks b fi lb ky l kz la">from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException</span></pre><p id="c29e" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置身份验证以使用服务主体运行模型</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="161a" class="kw in hi ks b fi kx ky l kz la">import os<br/>from azureml.core.authentication import ServicePrincipalAuthentication<br/> <br/>svc_pr_password = os.environ.get("AZUREML_PASSWORD")<br/> <br/>svc_pr = ServicePrincipalAuthentication(<br/>    tenant_id="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>    service_principal_id="xxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>    service_principal_password="xxxxxxxxxxxxxxxxxxxxx")<br/> <br/>ws = Workspace(<br/>    subscription_id="xxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>    resource_group="mlops",<br/>    workspace_name="mlopsdev",<br/>    auth=svc_pr<br/>    )<br/> <br/>print("Found workspace {} at location {}".format(ws.name, ws.location))</span></pre><p id="2119" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是时候设置要使用的环境和项目文件夹了</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="19f3" class="kw in hi ks b fi kx ky l kz la">project_folder = './diabetes-project'<br/>os.makedirs(project_folder, exist_ok=True)</span><span id="2e70" class="kw in hi ks b fi lb ky l kz la">experiment = Experiment(workspace=ws, name='diabetes-model')</span><span id="1674" class="kw in hi ks b fi lb ky l kz la">output_folder = './outputs'<br/>os.makedirs(output_folder, exist_ok=True)</span><span id="e92f" class="kw in hi ks b fi lb ky l kz la">result_folder = './results'<br/>os.makedirs(result_folder, exist_ok=True)</span></pre><p id="6e80" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在加载数据:(这个数据设置是公开的，没有真实的数据)</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="b500" class="kw in hi ks b fi kx ky l kz la">df = pd.read_csv('https://mlopssa.blob.core.windows.net/chd-dataset/framingham.csv')</span></pre><p id="2643" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是时候清理数据集，只获取我们需要的特性了</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="e02c" class="kw in hi ks b fi kx ky l kz la"># create a boolean array of smokers<br/>smoke = (df['currentSmoker']==1)<br/># Apply mean to NaNs in cigsPerDay but using a set of smokers only<br/>df.loc[smoke,'cigsPerDay'] = df.loc[smoke,'cigsPerDay'].fillna(df.loc[smoke,'cigsPerDay'].mean())</span><span id="50ae" class="kw in hi ks b fi lb ky l kz la"># Fill out missing values<br/>df['BPMeds'].fillna(0, inplace = True)<br/>df['glucose'].fillna(df.glucose.mean(), inplace = True)<br/>df['totChol'].fillna(df.totChol.mean(), inplace = True)<br/>df['education'].fillna(1, inplace = True)<br/>df['BMI'].fillna(df.BMI.mean(), inplace = True)<br/>df['heartRate'].fillna(df.heartRate.mean(), inplace = True)</span><span id="a9b6" class="kw in hi ks b fi lb ky l kz la"># Features and label<br/>features = df.iloc[:,:-1]<br/>result = df.iloc[:,-1] # the last column is what we are about to forecast</span></pre><p id="b5df" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">分割数据集</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="b421" class="kw in hi ks b fi kx ky l kz la"># Train &amp; Test split</span><span id="43b3" class="kw in hi ks b fi lb ky l kz la">X_train, X_test, y_train, y_test = train_test_split(features, result, test_size = 0.2, random_state = 14)</span></pre><p id="ab11" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">火车模型</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="17bb" class="kw in hi ks b fi kx ky l kz la">clf = RandomForestClassifier(n_estimators=100, max_depth=2, random_state=0)</span><span id="70b7" class="kw in hi ks b fi lb ky l kz la">clf.fit(X_train, y_train)</span></pre><p id="e6a6" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">运行特征重要性并过滤掉不需要的列</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="cd8e" class="kw in hi ks b fi kx ky l kz la">import sklearn<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.metrics import classification_report<br/>from sklearn.metrics import confusion_matrix<br/>from sklearn.metrics import accuracy_score<br/>from sklearn.metrics import roc_auc_score<br/>from sklearn.ensemble import RandomForestClassifier<br/>from sklearn.feature_selection import SelectFromModel</span><span id="71d8" class="kw in hi ks b fi lb ky l kz la"># Create a selector object that will use the random forest classifier to identify<br/># features that have an importance of more than 0.12<br/>sfm = SelectFromModel(clf, threshold=0.12)</span><span id="be01" class="kw in hi ks b fi lb ky l kz la"># Train the selector<br/>sfm.fit(X_train, y_train)</span><span id="db5d" class="kw in hi ks b fi lb ky l kz la"># Features selected<br/>featureNames = list(features.columns.values) # creating a list with features' names<br/>print("Feature names:")<br/>for featureNameListindex in sfm.get_support(indices=True):<br/>    print(featureNames[featureNameListindex])</span><span id="07f6" class="kw in hi ks b fi lb ky l kz la"># Feature importance<br/>importances = clf.feature_importances_<br/>std = np.std([tree.feature_importances_ for tree in clf.estimators_],<br/>             axis=0)<br/>indices = np.argsort(importances)[::-1]</span><span id="7990" class="kw in hi ks b fi lb ky l kz la"># With only imporant features. Can check X_important_train.shape[1]<br/>X_important_train = sfm.transform(X_train)<br/>X_important_test = sfm.transform(X_test)<br/>#Y_important_test = sfm.transform(y_test)</span><span id="a7b8" class="kw in hi ks b fi lb ky l kz la">rfc = RandomForestClassifier(n_estimators=10000, random_state=0, n_jobs=-1)<br/>rfc.fit(X_important_train, y_train)</span></pre><p id="a096" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在用剩余数据预测</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6087" class="kw in hi ks b fi kx ky l kz la">preds = rfc.predict(X_important_test)</span></pre><p id="16cb" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">从上述模型中获取指标</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3480" class="kw in hi ks b fi kx ky l kz la">#Import scikit-learn metrics module for accuracy calculation<br/>from sklearn import metrics<br/># Model Accuracy, how often is the classifier correct?<br/>print("Accuracy:",metrics.accuracy_score(y_test, preds))</span></pre><p id="ef92" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是时候设置管道了。让我们来配置计算</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="31df" class="kw in hi ks b fi kx ky l kz la">from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException</span><span id="fd25" class="kw in hi ks b fi lb ky l kz la"># Choose a name for your CPU cluster<br/>cpu_cluster_name = "diabetescluster"</span><span id="a2ed" class="kw in hi ks b fi lb ky l kz la"># Verify that cluster does not exist already<br/>try:<br/>    cpu_cluster = ComputeTarget(workspace=ws, name=cpu_cluster_name)<br/>    print('Found existing cluster, use it.')<br/>except ComputeTargetException:<br/>    compute_config = AmlCompute.provisioning_configuration(vm_size='STANDARD_D14_V2',<br/>                                                           max_nodes=4)<br/>    cpu_cluster = ComputeTarget.create(ws, cpu_cluster_name, compute_config)</span><span id="baa1" class="kw in hi ks b fi lb ky l kz la">cpu_cluster.wait_for_completion(show_output=True)</span></pre><p id="c794" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置计算变量和环境</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="e3d3" class="kw in hi ks b fi kx ky l kz la">from azureml.core.runconfig import RunConfiguration<br/>from azureml.core.conda_dependencies import CondaDependencies<br/>from azureml.core.runconfig import DEFAULT_CPU_IMAGE</span><span id="845f" class="kw in hi ks b fi lb ky l kz la"># Create a new runconfig object<br/>run_amlcompute = RunConfiguration()</span><span id="fadc" class="kw in hi ks b fi lb ky l kz la"># Use the cpu_cluster you created above. <br/>run_amlcompute.target = cpu_cluster</span><span id="64e9" class="kw in hi ks b fi lb ky l kz la"># Enable Docker<br/>run_amlcompute.environment.docker.enabled = True</span><span id="ed27" class="kw in hi ks b fi lb ky l kz la"># Set Docker base image to the default CPU-based image<br/>run_amlcompute.environment.docker.base_image = DEFAULT_CPU_IMAGE</span><span id="79da" class="kw in hi ks b fi lb ky l kz la"># Use conda_dependencies.yml to create a conda environment in the Docker image for execution<br/>run_amlcompute.environment.python.user_managed_dependencies = False</span><span id="e58a" class="kw in hi ks b fi lb ky l kz la"># Specify CondaDependencies obj, add necessary packages<br/>run_amlcompute.environment.python.conda_dependencies = CondaDependencies.create(conda_packages=['scikit-learn'])</span></pre><p id="7f12" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">写入train.py文件的时间</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="02a2" class="kw in hi ks b fi kx ky l kz la">%%writefile $project_folder/train.py</span><span id="0130" class="kw in hi ks b fi lb ky l kz la">import joblib<br/>import os<br/>import urllib<br/>import shutil<br/>import azureml<br/>import argparse<br/>import pandas as pd<br/>import numpy as np<br/>import pickle<br/>import json<br/>from sklearn import metrics</span><span id="edb3" class="kw in hi ks b fi lb ky l kz la">import sklearn<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.metrics import classification_report<br/>from sklearn.metrics import confusion_matrix<br/>from sklearn.metrics import accuracy_score<br/>from sklearn.metrics import roc_auc_score<br/>from sklearn.ensemble import RandomForestClassifier<br/>from sklearn.feature_selection import SelectFromModel</span><span id="efff" class="kw in hi ks b fi lb ky l kz la">from azureml.core import Experiment<br/>from azureml.core import Workspace, Run</span><span id="5101" class="kw in hi ks b fi lb ky l kz la">from azureml.core.compute import ComputeTarget, AmlCompute<br/>from azureml.core.compute_target import ComputeTargetException</span><span id="3b4b" class="kw in hi ks b fi lb ky l kz la">from sklearn.ensemble import RandomForestClassifier</span><span id="c7b9" class="kw in hi ks b fi lb ky l kz la">from azureml.core import Workspace, Dataset</span><span id="d871" class="kw in hi ks b fi lb ky l kz la">from azureml.core.authentication import ServicePrincipalAuthentication<br/> <br/>svc_pr_password = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"<br/> <br/>svc_pr = ServicePrincipalAuthentication(<br/>    tenant_id="xxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>    service_principal_id="xxxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>    service_principal_password="xxxxxxxxxxxxxxxxxxxxxxxx")<br/> <br/>ws = Workspace(<br/>    subscription_id="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",<br/>    resource_group="mlops",<br/>    workspace_name="mlopsdev",<br/>    auth=svc_pr<br/>    )</span><span id="4153" class="kw in hi ks b fi lb ky l kz la">#dataset = Dataset.get_by_name(ws, name='touringdataset')<br/>#dataset.to_pandas_dataframe()<br/>data_complete = df = pd.read_csv('<a class="ae lc" href="https://mlopssa.blob.core.windows.net/chd-dataset/framingham.csv'" rel="noopener ugc nofollow" target="_blank">https://mlopssa.blob.core.windows.net/chd-dataset/framingham.csv'</a>)</span><span id="6fd7" class="kw in hi ks b fi lb ky l kz la"># Get the experiment run context<br/>run = Run.get_context()</span><span id="5af2" class="kw in hi ks b fi lb ky l kz la"># create a boolean array of smokers<br/>smoke = (df['currentSmoker']==1)<br/># Apply mean to NaNs in cigsPerDay but using a set of smokers only<br/>df.loc[smoke,'cigsPerDay'] = df.loc[smoke,'cigsPerDay'].fillna(df.loc[smoke,'cigsPerDay'].mean())</span><span id="4cfa" class="kw in hi ks b fi lb ky l kz la"># Fill out missing values<br/>df['BPMeds'].fillna(0, inplace = True)<br/>df['glucose'].fillna(df.glucose.mean(), inplace = True)<br/>df['totChol'].fillna(df.totChol.mean(), inplace = True)<br/>df['education'].fillna(1, inplace = True)<br/>df['BMI'].fillna(df.BMI.mean(), inplace = True)<br/>df['heartRate'].fillna(df.heartRate.mean(), inplace = True)</span><span id="8cdb" class="kw in hi ks b fi lb ky l kz la"># Features and label<br/>features = df.iloc[:,:-1]<br/>result = df.iloc[:,-1] # the last column is what we are about to forecast</span><span id="cb70" class="kw in hi ks b fi lb ky l kz la"># Train &amp; Test split<br/>X_train, X_test, y_train, y_test = train_test_split(features, result, test_size = 0.2, random_state = 14)</span><span id="032d" class="kw in hi ks b fi lb ky l kz la"># RandomForest classifier<br/>clf = RandomForestClassifier(n_estimators=100, max_depth=2, random_state=0)<br/>clf.fit(X_train, y_train)</span><span id="21e6" class="kw in hi ks b fi lb ky l kz la"># Create a selector object that will use the random forest classifier to identify<br/># features that have an importance of more than 0.12<br/>sfm = SelectFromModel(clf, threshold=0.12)</span><span id="7dcb" class="kw in hi ks b fi lb ky l kz la"># Train the selector<br/>sfm.fit(X_train, y_train)</span><span id="ee27" class="kw in hi ks b fi lb ky l kz la"># Features selected<br/>featureNames = list(features.columns.values) # creating a list with features' names<br/>print("Feature names:")<br/>for featureNameListindex in sfm.get_support(indices=True):<br/>    print(featureNames[featureNameListindex])</span><span id="bb25" class="kw in hi ks b fi lb ky l kz la"># Feature importance<br/>importances = clf.feature_importances_<br/>std = np.std([tree.feature_importances_ for tree in clf.estimators_],<br/>             axis=0)<br/>indices = np.argsort(importances)[::-1]</span><span id="f6ac" class="kw in hi ks b fi lb ky l kz la"># With only imporant features. Can check X_important_train.shape[1]<br/>X_important_train = sfm.transform(X_train)<br/>X_important_test = sfm.transform(X_test)</span><span id="7931" class="kw in hi ks b fi lb ky l kz la">rfc = RandomForestClassifier(n_estimators=10000, random_state=0, n_jobs=-1)<br/>rfc.fit(X_important_train, y_train)</span><span id="efce" class="kw in hi ks b fi lb ky l kz la">preds = rfc.predict(X_important_test)</span><span id="c9f6" class="kw in hi ks b fi lb ky l kz la">run.log("Accuracy:",metrics.accuracy_score(y_test, preds))</span><span id="15b0" class="kw in hi ks b fi lb ky l kz la">print(confusion_matrix(y_test,preds))<br/>print(classification_report(y_test,preds))</span><span id="17c3" class="kw in hi ks b fi lb ky l kz la">#joblib.dump(rfc, "/outputs/model.joblib")<br/>os.makedirs('./outputs', exist_ok=True)<br/># note file saved in the outputs folder is automatically uploaded into experiment record<br/>joblib.dump(value=rfc, filename='./outputs/sklearn_diabetes_model.pkl')</span></pre><p id="2e38" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">创建估算器来运行管道</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="84f7" class="kw in hi ks b fi kx ky l kz la">from azureml.train.sklearn import SKLearn</span><span id="3649" class="kw in hi ks b fi lb ky l kz la">estimator = SKLearn(source_directory=project_folder, <br/>#                     script_params=script_params,<br/>                    compute_target=cpu_cluster,<br/>                    entry_script='train.py',<br/>                    pip_packages=['joblib']<br/>                   )</span></pre><p id="8edd" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">提交并运行实验。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="84cf" class="kw in hi ks b fi kx ky l kz la">run = experiment.submit(estimator) run.wait_for_completion(show_output=True)</span></pre><p id="4b8c" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">打印来自模型的指标</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="15df" class="kw in hi ks b fi kx ky l kz la">print(run.get_metrics())</span></pre><p id="c406" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">应该是类似于{ ' Accuracy:':0.82339622641 }</p><p id="e62e" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示结果和进度</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="a3b2" class="kw in hi ks b fi kx ky l kz la">from azureml.widgets import RunDetails<br/>RunDetails(run).show()</span></pre><p id="55eb" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是时候超调参数来验证模型了</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="2e84" class="kw in hi ks b fi kx ky l kz la">from azureml.train.hyperdrive import RandomParameterSampling, BanditPolicy, HyperDriveConfig, PrimaryMetricGoal<br/>from azureml.train.hyperdrive import choice, loguniform</span><span id="a712" class="kw in hi ks b fi lb ky l kz la">param_sampling = GridParameterSampling( {<br/>        "num_hidden_layers": choice(1, 2, 3),<br/>        "batch_size": choice(16, 32)<br/>    }<br/>)</span></pre><p id="8a6d" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设定参数</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="2e37" class="kw in hi ks b fi kx ky l kz la">primary_metric_name="accuracy",<br/>primary_metric_goal=PrimaryMetricGoal.MAXIMIZE</span></pre><p id="b02d" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置强盗政策</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3537" class="kw in hi ks b fi kx ky l kz la">from azureml.train.hyperdrive import BanditPolicy<br/>early_termination_policy = BanditPolicy(slack_factor = 0.1, evaluation_interval=1, delay_evaluation=5)</span></pre><p id="02c9" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置截断策略</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7c74" class="kw in hi ks b fi kx ky l kz la">from azureml.train.hyperdrive import TruncationSelectionPolicy<br/>early_termination_policy = TruncationSelectionPolicy(evaluation_interval=1, truncation_percentage=20, delay_evaluation=5)</span></pre><p id="4f6c" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置超调参数的退出标准</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="78e6" class="kw in hi ks b fi kx ky l kz la">max_total_runs=20,<br/>max_concurrent_runs=4</span></pre><p id="4531" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置超参数调整运行</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="4967" class="kw in hi ks b fi kx ky l kz la">from azureml.train.hyperdrive import HyperDriveConfig<br/>hyperdrive_run_config = HyperDriveConfig(estimator=estimator,<br/>                          hyperparameter_sampling=param_sampling, <br/>                          policy=early_termination_policy,<br/>                          primary_metric_name="accuracy",<br/>                     primary_metric_goal=PrimaryMetricGoal.MAXIMIZE,<br/>                          max_total_runs=100,<br/>                          max_concurrent_runs=4)</span></pre><p id="c144" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">提交并运行超级参数调整</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="1c28" class="kw in hi ks b fi kx ky l kz la">from azureml.core.experiment import Experiment<br/>experiment = Experiment(workspace=ws, name='diabetes-model')<br/>hyperdrive_run = experiment.submit(hyperdrive_run_config)</span></pre><p id="c2da" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示状态</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="03c8" class="kw in hi ks b fi kx ky l kz la">from azureml.widgets import RunDetails<br/>RunDetails(hyperdrive_run).show()</span></pre><p id="0ade" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">获得性能最佳的模型</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7ffd" class="kw in hi ks b fi kx ky l kz la">best_run = hyperdrive_run.get_best_run_by_primary_metric()<br/>sprint(best_run.get_details()['runDefinition']['arguments'])</span></pre><p id="cd64" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示模型</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="fccb" class="kw in hi ks b fi kx ky l kz la">print(best_run.get_file_names())</span></pre><p id="a1f0" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是注册模特的时候了</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ba25" class="kw in hi ks b fi kx ky l kz la">model = best_run.register_model(model_name='sklearn_diabetes',<br/>                           model_path='outputs/sklearn_diabetes_model.pkl',<br/>                           tags=run.get_metrics())<br/>print(model.name, model.id, model.version, sep='\t')</span></pre><p id="0570" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">最佳模特将被注册。现在，该模型可以用于部署。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><p id="ee89" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><em class="lk">原载于【https://github.com】<a class="ae lc" href="https://github.com/balakreshnan/mlops/blob/master/traininghypertuning.md" rel="noopener ugc nofollow" target="_blank"><em class="lk"/></a><em class="lk">。</em></em></p></div></div>    
</body>
</html>