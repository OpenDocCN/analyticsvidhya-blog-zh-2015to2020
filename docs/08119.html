<html>
<head>
<title>Providing Internet Connectivity to Private Subnet through NAT Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过NAT网关为私有子网提供互联网连接</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/providing-internet-connectivity-to-private-subnet-through-nat-gateway-edf6955f8cea?source=collection_archive---------8-----------------------#2020-07-18">https://medium.com/analytics-vidhya/providing-internet-connectivity-to-private-subnet-through-nat-gateway-edf6955f8cea?source=collection_archive---------8-----------------------#2020-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div class="er es hg"><img src="../Images/f851444039f5a121cdf7fa91f33bd64c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*hHIxU-hhQnq5J7yz7NF37Q.png"/></div></figure><div class=""/><p id="60c0" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">之前在AWS上部署的web服务器使用VPC，在公共子网中运行WordPress服务器，在私有子网中运行MySql数据库<strong class="io hq"> <em class="jk">(下面给出了那篇文章的链接)</em> </strong>。由于MySql在私有子网中启动，这意味着它没有互联网连接，这很好，但在更新软件、进行一些更改、修复漏洞或补丁的情况下，它可能会成为一个主要的安全威胁。</p><div class="hh hi ez fb hj jl"><a rel="noopener follow" target="_blank" href="/@akashdeepg06/deploying-wordpress-and-mysql-server-in-our-own-vpc-59d5d4a2fedd"><div class="jm ab dw"><div class="jn ab jo cl cj jp"><h2 class="bd hq fi z dy jq ea eb jr ed ef ho bi translated">在VPC部署WordPress和MySql服务器</h2><div class="js l"><h3 class="bd b fi z dy jq ea eb jr ed ef dx translated">*我们会做什么？</h3></div><div class="jt l"><p class="bd b fp z dy jq ea eb jr ed ef dx translated">medium.com</p></div></div><div class="ju l"><div class="jv l jw jx jy ju jz hl jl"/></div></div></a></div><p id="24dc" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这种情况下，我们将使用NAT网关为我们的数据库服务器提供互联网连接。我们还将推出一个名为<strong class="io hq"> <em class="jk"> bastion host </em> </strong>的实例，它将用于ping MySql实例内部，还可以执行更新和修复bug等任务。</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="81a5" class="kh ki hp bd kj kk kl km kn ko kp kq kr ix ks kt ku jb kv kw kx jf ky kz la lb bi translated"><strong class="ak">*将在本任务中使用的术语</strong></h2><blockquote class="lc ld le"><p id="dfbd" class="im in jk io b ip iq ir is it iu iv iw lf iy iz ja lg jc jd je lh jg jh ji jj hb bi translated">NAT网关</p></blockquote><p id="5b37" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi li translated"><span class="l lj lk ll bm lm ln lo lp lq di"> N </span> AT Gateway是一项高度可用的AWS托管服务，可以轻松地从亚马逊虚拟私有云(亚马逊VPC)的私有子网内的实例连接到互联网。以前，您需要启动一个NAT实例来为私有子网中的实例启用NAT。</p><blockquote class="lc ld le"><p id="6806" class="im in jk io b ip iq ir is it iu iv iw lf iy iz ja lg jc jd je lh jg jh ji jj hb bi translated">EIP</p></blockquote><p id="414a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi li translated"><span class="l lj lk ll bm lm ln lo lp lq di"> E </span> lastic IP地址是一个保留的公共IP地址，您可以将其分配给特定区域中的任何EC2实例，直到您选择释放它。要在特定地区为您的帐户分配弹性IP地址，请参阅分配弹性IP地址。</p><blockquote class="lc ld le"><p id="0070" class="im in jk io b ip iq ir is it iu iv iw lf iy iz ja lg jc jd je lh jg jh ji jj hb bi translated">堡垒主机</p></blockquote><p id="2096" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi li translated">主机是一种服务器，其目的是提供从外部网络(如互联网)到专用网络的访问。由于面临潜在的攻击，堡垒主机必须最大限度地减少渗透的机会。</p><p id="0b6a" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hq">安全组</strong>对于保持严密的安全性是必不可少的，并且在使<strong class="io hq"> bastion host </strong>解决方案工作中起着重要作用。</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="a8b9" class="kh ki hp bd kj kk kl km kn ko kp kq kr ix ks kt ku jb kv kw kx jf ky kz la lb bi translated">*任务的解决方案</h2><ul class=""><li id="7576" class="lr ls hp io b ip lt it lu ix lv jb lw jf lx jj ly lz ma mb bi translated">在创建NAT网关之前，我们必须为此创建EIP。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="e450" class="kh ki hp mh b fi ml mm l mn mo"># — Creating EIP</span><span id="ea05" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_eip” “task4-eip” {<br/> vpc = “true”<br/>}</span></pre><p id="e63e" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">简单得没什么好解释的。</p><figure class="mc md me mf fd hk er es paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="er es mq"><img src="../Images/246e3d505030e5d2abe8d8030ee4defe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6NJSZ9wvt1qfumT3puqArQ.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">EIP</figcaption></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><ul class=""><li id="bb14" class="lr ls hp io b ip iq it iu ix mz jb na jf nb jj ly lz ma mb bi translated">正在创建NAT网关。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="e072" class="kh ki hp mh b fi ml mm l mn mo"># — Creating NAT gateway</span><span id="fb4b" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_nat_gateway” “task4-ngw” {<br/> allocation_id = “${aws_eip.task4-eip.id}<br/> subnet_id = “${aws_subnet.public-subnet-1a.id}”<br/> <br/> tags = {<br/> Name = “task4-ngw”<br/>}</span></pre><p id="7347" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将此NAT网关分配给公共子网。</p><figure class="mc md me mf fd hk er es paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="er es mq"><img src="../Images/799824f36d42c87e6d182b6137439ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JleZ1UcL-6ALVvo3eAVSuA.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">NAT网关</figcaption></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><ul class=""><li id="0a2f" class="lr ls hp io b ip iq it iu ix mz jb na jf nb jj ly lz ma mb bi translated">为NAT网关及其与私有子网的关联创建路由表，以实现互联网连接。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="cf2b" class="kh ki hp mh b fi ml mm l mn mo"># — Create route table for nat gateway</span><span id="1de2" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_route_table” “task4-route-ngw” {<br/> depends_on = [ aws_nat_gateway.task4-ngw, <br/> ]<br/> vpc_id = “${aws_vpc.task4-vpc.id}”</span><span id="a05b" class="kh ki hp mh b fi mp mm l mn mo">route {<br/> cidr_block = “0.0.0.0/0”<br/> gateway_id = “${aws_nat_gateway.task4-ngw.id}”<br/> }</span><span id="32e4" class="kh ki hp mh b fi mp mm l mn mo">tags = {<br/> Name = “task4-route-ngw”<br/> }<br/>}</span><span id="9c8b" class="kh ki hp mh b fi mp mm l mn mo"># — Subnet Association for nat gateway</span><span id="0a4b" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_route_table_association” “subnet-1b-asso” {<br/> subnet_id = “${aws_subnet.public-subnet-1b.id}”<br/> route_table_id = “${aws_route_table.task4-route-ngw.id}”<br/>}</span></pre><div class="mc md me mf fd ab cb"><figure class="nc hk nd ne nf ng nh paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><img src="../Images/2496abff2ea7eaff471163aef45fa212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*btDt5QFwRdpyRmVcm2biOA.png"/></div></figure><figure class="nc hk ni ne nf ng nh paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><img src="../Images/1d87d06165c7e0efda87306758c45a41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*GJG-M44l0Ts7tYNjnm7hOg.png"/></div><figcaption class="mv mw et er es mx my bd b be z dx nj di nk nl translated">路由表</figcaption></figure></div></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><ul class=""><li id="cc74" class="lr ls hp io b ip iq it iu ix mz jb na jf nb jj ly lz ma mb bi translated">为堡垒主机创建密钥对。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="39a0" class="kh ki hp mh b fi ml mm l mn mo"># — Creating Key Pairs for bastion host</span><span id="2a0e" class="kh ki hp mh b fi mp mm l mn mo">resource “tls_private_key” “key7” {<br/> algorithm = “RSA”<br/> rsa_bits = 4096<br/>}</span><span id="706a" class="kh ki hp mh b fi mp mm l mn mo">resource “local_file” “key8” {<br/> content = “${tls_private_key.key7.private_key_pem}”<br/> filename = “bastion_key.pem”<br/> file_permission = 0400<br/>}</span><span id="1337" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_key_pair” “key9” {<br/> key_name = “bastion_key”<br/> public_key = “${tls_private_key.key7.public_key_openssh}”<br/>}</span></pre><ul class=""><li id="3a6d" class="lr ls hp io b ip iq it iu ix mz jb na jf nb jj ly lz ma mb bi translated">为堡垒主机创建安全组。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="fb52" class="kh ki hp mh b fi ml mm l mn mo"># — Creating Security Groups for bastion host</span><span id="aed2" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_security_group” “sg-bs” {<br/> name = “bastion-sg”<br/> description = “Allow TLS inbound traffic”<br/> vpc_id = “${aws_vpc.task4-vpc.id}”</span><span id="cae4" class="kh ki hp mh b fi mp mm l mn mo">ingress {<br/> description = “SSH”<br/> from_port = 22<br/> to_port = 22<br/> protocol = “tcp”<br/> cidr_blocks = [ “0.0.0.0/0” ]<br/> }</span><span id="00eb" class="kh ki hp mh b fi mp mm l mn mo">egress {<br/> from_port = 0<br/> to_port = 0<br/> protocol = “-1”<br/> cidr_blocks = [“0.0.0.0/0”]<br/> }</span><span id="7ab2" class="kh ki hp mh b fi mp mm l mn mo">tags = {<br/> Name = “bastion-sg”<br/> }<br/>}</span></pre><p id="cac7" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">只允许ssh保护主机。</p><figure class="mc md me mf fd hk er es paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="er es mq"><img src="../Images/2a6b63cf451c2b4e9fbce7b95d49f426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z_i1t_Gya6qdjuW9yBlERQ.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">sg-bastion</figcaption></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><ul class=""><li id="2c46" class="lr ls hp io b ip iq it iu ix mz jb na jf nb jj ly lz ma mb bi translated">为MySql创建一个安全组，只允许堡垒主机安全组执行ssh。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="4f34" class="kh ki hp mh b fi ml mm l mn mo"># — Creating Security Groups for mySql for having connectivity with only bastion_host instance</span><span id="a2bf" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_security_group” “sg-db2” {<br/> depends_on = [<br/> aws_security_group.sg-bs,<br/> ]<br/> name = “mySql-sg2”<br/> description = “Allow TLS inbound traffic”<br/> vpc_id = “${aws_vpc.task4-vpc.id}”</span><span id="7faa" class="kh ki hp mh b fi mp mm l mn mo">ingress {<br/> description = “SSH”<br/> from_port = 22<br/> to_port = 22<br/> protocol = “tcp”<br/> security_groups = [ “${aws_security_group.sg-bs.id}” ]<br/> }</span><span id="53f0" class="kh ki hp mh b fi mp mm l mn mo">egress {<br/> from_port = 0<br/> to_port = 0<br/> protocol = “-1”<br/> cidr_blocks = [“0.0.0.0/0”]<br/> }</span><span id="7aaf" class="kh ki hp mh b fi mp mm l mn mo">tags = {<br/> Name = “mySql-sg2”<br/> }<br/>}</span></pre><figure class="mc md me mf fd hk er es paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="er es mq"><img src="../Images/f351d0b22c08cefb9247fce01e5a7ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vo873VuQ8bJ4I2QWN_B_6w.png"/></div></div><figcaption class="mv mw et er es mx my bd b be z dx translated">sg-mysql</figcaption></figure></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><ul class=""><li id="0f35" class="lr ls hp io b ip iq it iu ix mz jb na jf nb jj ly lz ma mb bi translated">正在启动堡垒主机实例。</li></ul><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="33c3" class="kh ki hp mh b fi ml mm l mn mo"># — Creating Ec2 instance for bastion_host</span><span id="ff4c" class="kh ki hp mh b fi mp mm l mn mo">resource “aws_instance” “bash_host” {<br/> ami = “ami-0732b62d310b80e97”<br/> subnet_id = “${aws_subnet.public-subnet-1a.id}”<br/> availability_zone = “${data.aws_availability_zones.zones.names[0]}”<br/> instance_type = “t2.micro”<br/> root_block_device {<br/> volume_type = “gp2”<br/> delete_on_termination = true<br/> }<br/> key_name = “${aws_key_pair.key9.key_name}”<br/> vpc_security_group_ids = [ “${aws_security_group.sg-bs.id}” ]<br/> associate_public_ip_address = true<br/> <br/> tags = {<br/> Name = “Bastion_host”<br/> }<br/>}</span></pre><div class="mc md me mf fd ab cb"><figure class="nc hk nm ne nf ng nh paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><img src="../Images/f2f77822f6efa43af5244aa8e0cea6e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*MhWYTlXg9g0zNfXIX7phDA.png"/></div></figure><figure class="nc hk nm ne nf ng nh paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><img src="../Images/d85e19307b7b143717555f01f8604cc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Db5tdFKAIATmII0jHHh3Mg.png"/></div><figcaption class="mv mw et er es mx my bd b be z dx nj di nk nl translated">例子</figcaption></figure></div></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><p id="c128" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，使用这个bastion主机，我们可以在我们的MySql实例中的私有子网内登录，并可以使用它的密钥对进行ssh。</p><p id="4263" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于key pair，查看您创建项目的本地存储库，并通过WindSCP将其从您的存储库发送到bastion主机实例。</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="6161" class="kh ki hp mh b fi ml mm l mn mo">Bastion host Public IP: 13.232.65.1<br/>MySql Private IP: 192.168.1.109</span><span id="fcdc" class="kh ki hp mh b fi mp mm l mn mo"># sudo su - root</span><span id="a50f" class="kh ki hp mh b fi mp mm l mn mo"># cd /home/ec2-user<br/><strong class="mh hq"><em class="jk">Note:- As going to this loction as a have copied the key(mySql)to this location</em></strong></span><span id="852e" class="kh ki hp mh b fi mp mm l mn mo"># ssh -i mysql_key.pem -l ec2-user 192.168.1.109</span><span id="2bd1" class="kh ki hp mh b fi mp mm l mn mo"># ping goo.gl</span><span id="3b35" class="kh ki hp mh b fi mp mm l mn mo"># sudo su - root</span><span id="544e" class="kh ki hp mh b fi mp mm l mn mo"># now install any software or fix bugs.</span></pre><div class="mc md me mf fd ab cb"><figure class="nc hk nm ne nf ng nh paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><img src="../Images/f80743d03ed16ddbceaed9493fdcd0a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*ZPc7cNKCeT1pyb5zQQOxuw.png"/></div></figure><figure class="nc hk nm ne nf ng nh paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><img src="../Images/679d436b6f63aaa84c3b18502570f09d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*-8np0C2JUbDrw6TcaNjVAw.png"/></div></figure></div></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="3509" class="kh ki hp bd kj kk kl km kn ko kp kq kr ix ks kt ku jb kv kw kx jf ky kz la lb bi translated">感谢阅读！！</h2><p id="df8b" class="pw-post-body-paragraph im in hp io b ip lt ir is it lu iv iw ix nn iz ja jb no jd je jf np jh ji jj hb bi translated">请随时给我建议和任何疑问，然后给我发邮件。</p><p id="0afb" class="pw-post-body-paragraph im in hp io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hq"> Github repo获取帮助和完整代码</strong></p><div class="hh hi ez fb hj jl"><a href="https://github.com/Akashdeep-47/cloud_task4.git" rel="noopener  ugc nofollow" target="_blank"><div class="jm ab dw"><div class="jn ab jo cl cj jp"><h2 class="bd hq fi z dy jq ea eb jr ed ef ho bi translated">阿卡什迪普-47/云任务4</h2><div class="js l"><h3 class="bd b fi z dy jq ea eb jr ed ef dx translated">通过NAT网关为私有子网提供互联网连接NAT网关是一个高度可用的AWS管理…</h3></div><div class="jt l"><p class="bd b fp z dy jq ea eb jr ed ef dx translated">github.com</p></div></div><div class="ju l"><div class="nq l jw jx jy ju jz hl jl"/></div></div></a></div></div></div>    
</body>
</html>