<html>
<head>
<title>Integrating Elasticsearch 7 into Django project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Elasticsearch 7集成到Django项目中</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/integrating-elasticsearch-7-to-django-project-c3812de78246?source=collection_archive---------2-----------------------#2019-12-18">https://medium.com/analytics-vidhya/integrating-elasticsearch-7-to-django-project-c3812de78246?source=collection_archive---------2-----------------------#2019-12-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/b76ce65df8e2fca9236cd33b25e888dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*8FZsWVXftREZbfS6K_C-ow.png"/></div></figure><p id="11c0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了一个项目，我不得不使用django-haystack将Elasticsearch 2.x迁移到最新的Elasticsearch 7.5.0。我是这样做的。如果你想在django项目中使用Elasticsearch，你也可以跟随。我将使用Django 2.1.5。</p><p id="4390" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Haystack是一个很棒的开源包，它为Django提供了模块化搜索。不幸的是，它不支持最近版本的Elasticsearch。所以为了迁移到最新版本的Elasticsearch，我们需要删除django-haystack包。这可以通过使用:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="d7e1" class="jt ju hi jp b fi jv jw l jx jy">pip unistall django-haystack</span></pre><p id="a2fa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们需要的软件包是Elasticsearch-DSL和Django Elasticsearch DSL:</p><p id="760d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">1) <strong class="io hj"> Elasticsearch-DSL </strong>:这是一个围绕官方低级客户端(elasticsearch-py)的高级库。</p><p id="412a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">2)<strong class="io hj">Django-elastic search-DSL</strong>:这允许elasticsearch- dsl-py与Django轻松集成。</p><h1 id="29c3" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在机器/服务器上安装和运行Elasticsearch server:</h1><p id="0f8b" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">对于基于debian的机器，如Ubuntu、Debian等:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="fcaf" class="jt ju hi jp b fi jv jw l jx jy">wget <a class="ae lb" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.0-amd64.deb" rel="noopener ugc nofollow" target="_blank">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.0-amd64.deb</a></span><span id="3555" class="jt ju hi jp b fi lc jw l jx jy">wget <a class="ae lb" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.0-amd64.deb.sha512" rel="noopener ugc nofollow" target="_blank">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.0-amd64.deb.sha512</a></span><span id="c91f" class="jt ju hi jp b fi lc jw l jx jy">shasum -a 512 -c elasticsearch-7.5.0-amd64.deb.sha512sudo </span><span id="aca3" class="jt ju hi jp b fi lc jw l jx jy">dpkg -i elasticsearch-7.5.0-amd64.deb</span></pre><p id="c9c4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要在系统启动时自动启动Elasticsearch，请运行以下命令:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="b9d1" class="jt ju hi jp b fi jv jw l jx jy">sudo /bin/systemctl daemon-reload<br/>sudo /bin/systemctl enable elasticsearch.service</span></pre><p id="bff7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在systemd上启动elasticsearch服务</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="6856" class="jt ju hi jp b fi jv jw l jx jy">sudo systemctl start elasticsearch.service</span></pre><p id="0294" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">停止systemd上的elasticsearch服务</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="a985" class="jt ju hi jp b fi jv jw l jx jy">sudo systemctl stop elasticsearch.service</span></pre><p id="0747" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">获取systemd上弹性搜索服务的状态</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="47e5" class="jt ju hi jp b fi jv jw l jx jy">systemctl status elasticsearch.service</span></pre><p id="72a2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此外，要检查Elasticsearch服务是否正常工作，您可以在浏览器中查看localhost:9200/有关其他操作系统的安装指南，请参考<a class="ae lb" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html" rel="noopener ugc nofollow" target="_blank">https://www . elastic . co/guide/en/elastic search/reference/current/install-elastic search . html</a>。</p><h1 id="ad27" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">在Django安装Django-Elasticsearch-DSL:</h1><p id="52d7" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">首先为Django安装<strong class="io hj"/>Django-elastic search-DSL。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="fbf6" class="jt ju hi jp b fi jv jw l jx jy">pip install django-elasticsearch-dsl</span></pre><p id="2da6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请记住，对于Elasticsearch 7.0和更高版本，请使用该库的主要版本7 (7.x.y)。正在做<em class="ld"> pip列表</em>显示。</p><figure class="jk jl jm jn fd ij er es paragraph-image"><div class="er es le"><img src="../Images/cc5b04bd43556bdd45e206a58f4b470d.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*u_HKOXbjQ3fFXnc9kIQt7A.png"/></div><figcaption class="lf lg et er es lh li bd b be z dx translated">第一行和最后两行，检查django-elasticsearch-dsl版本(7.x.y)</figcaption></figure><p id="7e7c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将此代码片段添加到django设置中:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="c2af" class="jt ju hi jp b fi jv jw l jx jy">ELASTICSEARCH_DSL={<br/>    'default': {<br/>        'hosts': 'localhost:9200'<br/>    },<br/>}</span></pre><p id="ad61" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这告诉Django我们的Elasticsearch服务在哪里。</p><h1 id="b43f" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">创建documents.py:</h1><p id="db72" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">我必须为django项目的“apps”应用程序实现搜索应用程序和标签模型。所以下面的代码片段会与之相关。但是你可以为你的项目遵循同样的程序。</p><p id="9578" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要在Elasticsearch中使用App和标签模型，我们需要子类化<em class="ld"> django_elasticsearch_dsl。文档</em>并在其中创建类索引来定义索引，然后使用<em class="ld">registry . register _ document</em>decorator将其注册为类。该文档子类在“apps”目录下的documents.py中定义。</p><p id="1689" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在您的应用程序目录中创建documents.py并包含此导入:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="7066" class="jt ju hi jp b fi jv jw l jx jy">from django_elasticsearch_dsl import Document, fields<br/>from django_elasticsearch_dsl.registries import registry<br/>from .models import App, Tag</span></pre><p id="717a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于应用模型，我们将使用应用模型的名称，标题，描述和摘要字段搜索应用。将此添加到documents.py。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="f6bc" class="jt ju hi jp b fi jv jw l jx jy"><a class="ae lb" href="http://twitter.com/registry" rel="noopener ugc nofollow" target="_blank">@registry</a>.register_document<br/>class AppDocument(Document):<br/>    class Index:<br/>        name = 'apps'<br/>        settings = {'number_of_shards': 1,<br/>                    'number_of_replicas': 0}<br/>    <br/>    description = fields.TextField(attr = 'get_description')<br/>    class Django:<br/>        model = App<br/>        fields = [<br/>            'name',<br/>            'title',<br/>            'website',<br/>            'abstract',<br/>        ]</span></pre><p id="6fe7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">name = 'apps '指的是索引的名称，而fields指的是我们将使用其进行搜索并出现在您的模型中的字段。也就是model = App，它指的是我们正在为其构建索引的模型。碎片和副本可以根据您的需要进行设置。</p><p id="d20a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里的描述是应用程序模型中的一个markdownx ()字段，当包含在字段部分时会出错，因此要包含搜索的描述字段，我必须在应用程序模型类中编写一个函数(get_description)来从应用程序模型返回描述字段。但这只是针对mardownx()字段的。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="ac99" class="jt ju hi jp b fi jv jw l jx jy">def get_description(self):<br/>        return self.description</span></pre><p id="e171" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于标签模型，我们将使用名称和身份来搜索标签，这可以使用相同的过程来完成。</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="4e1b" class="jt ju hi jp b fi jv jw l jx jy"><a class="ae lb" href="http://twitter.com/registry" rel="noopener ugc nofollow" target="_blank">@registry</a>.register_document<br/>class TagDocument(Document):<br/>    class Index:<br/>        name = 'tags'<br/>        settings = {'number_of_shards': 1,<br/>                    'number_of_replicas': 0}</span><span id="95e9" class="jt ju hi jp b fi lc jw l jx jy">class Django:<br/>        model = Tag<br/>        fields = [<br/>            'name',<br/>            'identity',<br/>            <br/>        ]</span></pre><p id="9d7a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建documents.py后，我们构建索引。</p><p id="f7fe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">使用以下命令创建弹性搜索索引和映射:</strong></p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="b049" class="jt ju hi jp b fi jv jw l jx jy">python manage.py search_index --rebuild</span></pre><p id="a941" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦完成，现有对象将被映射，当新对象(此处为应用程序/标签)添加到数据库时，它们将自动映射到弹性搜索索引。</p><h1 id="6b50" class="jz ju hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">显示搜索结果</h1><p id="e1d3" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">现在我们需要显示搜索结果。为您的项目创建搜索应用程序。在这个项目中，它已经被创建。我们需要修改搜索应用程序中的views.py来处理搜索请求，并为我们的模板呈现它。</p><p id="d25e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先从搜索app的views.py中的documents.py导入AppDocument和TagDocument:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="b25f" class="jt ju hi jp b fi jv jw l jx jy">from apps.documents import AppDocument, TagDocument</span></pre><p id="c886" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">搜索app的views.py内部搜索(请求)方法:</p><pre class="jk jl jm jn fd jo jp jq jr aw js bi"><span id="e95b" class="jt ju hi jp b fi jv jw l jx jy">query = request.GET.get('q', '')</span><span id="bd73" class="jt ju hi jp b fi lc jw l jx jy">sqs_app = AppDocument.search().query("multi_match", query = query\<br/>     , fields = ["name", "title", "abstract", "description"])<br/>sqs_tag = TagDocument.search().query("match", name = query)</span><span id="35b8" class="jt ju hi jp b fi lc jw l jx jy">app = sqs_app.to_queryset()<br/>tag = sqs_tag.to_queryset()</span></pre><p id="05d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这里的查询是用于搜索的实际查询。对于应用程序，我们做多匹配查询，因为有4个字段要搜索，对于标签，我们只使用名称字段查询。sqs_app和sqs_tag是获得的搜索查询结果集。现有html模板需要django查询集。因此，为了将这个查询集作为django查询集返回，我使用了to_queryset()方法。然后将查询集返回到您的模板。</p><p id="11b7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">感谢您的阅读:)</p></div></div>    
</body>
</html>