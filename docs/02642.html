<html>
<head>
<title>How to perform SCD2 in Databricks using Delta Lake (Python)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Delta Lake (Python)在数据块中执行SCD2</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-perform-scd2-in-databricks-using-delta-lake-python-e538177f23a6?source=collection_archive---------3-----------------------#2019-12-27">https://medium.com/analytics-vidhya/how-to-perform-scd2-in-databricks-using-delta-lake-python-e538177f23a6?source=collection_archive---------3-----------------------#2019-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d52b9a2560ba5d4702845f8b6255bf47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z0yISuUJGd3c8Eqn"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">米卡·鲍梅斯特在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="764d" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">什么是SCD？</h1><p id="fe17" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">SCD代表缓慢变化的数据。这意味着它根据需求维护数据库、表、文件或云上所有记录的日志。</p><p id="6681" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">比如说。</p><p id="0f56" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">凌晨1点有一次处决。该执行返回3个数据。这些数据被插入到表或任何其他源中。现在假设在凌晨2点又执行了一次，它返回5个数据。现在将这些数据与旧数据进行比较。为了比较，必须有一些独特的东西是必需的，如id，hashcode等。现在新记录和旧记录有相同的id假设1。那么现在发生了什么，在具有id 1的旧数据中被标记为停用，并且新数据被插入并且被标记为活动。如果有新的数据，则简单地插入这些数据。</p><p id="d7d9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">SCD2什么都不是，但是它维护所有记录以用于跟踪目的，并且维护日志。</p><h1 id="3064" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">背景</h1><p id="a2ab" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我的数据砖笔记本做以下事情:</p><p id="7e61" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">从azure blob存储中的JSON文件读取数据。</p><p id="f1b7" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">将JSON数据存储在增量表中。</p><p id="3036" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在笔记本中使用Python执行SCD2操作，并将最终数据存储在主增量表中。</p><h1 id="2a93" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">方案</h1><p id="7c33" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在这个场景中，Azure blob存储上总共有3个JSON文件，如下图所示。</p><p id="aa59" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">文件1: Data.json </strong></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es kw"><img src="../Images/ec035cf389c809d1c8dd84214fac2dbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:554/format:webp/1*KdRgzRR4Kekfe16qQ-mU-w.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">第一次执行时，这些数据被插入增量表中</figcaption></figure><p id="add3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">文件1: Data1.json </strong></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/389ac2d999c451bad8a09d817477797a.png" data-original-src="https://miro.medium.com/v2/resize:fit:482/format:webp/1*vPflcPgW03kj-N_wSQyALQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">第二次执行时，旧的id 1被禁用，新的id 1被启用</figcaption></figure><p id="0951" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">文件1: Data2.json </strong></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lc"><img src="../Images/cebd5ada572705c0af419ea1762952a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:496/format:webp/1*FziUMiPZGdSeDBaihJI6bQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">第三次执行你可以发现将要发生什么。</figcaption></figure><p id="beb2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">代码</strong></p><p id="a33a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">步骤1: </strong>在名称空间下添加，以启用delta lake。</p><p id="232f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">spark . SQL(" set spart . data bricksδpreview . enabled = true ")<br/>spark . SQL(" set spart . data bricksδretentiondutationcheck . preview . enabled = false ")</p><p id="6b45" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">第二步:</strong></p><p id="ab43" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#在名称空间下面添加</strong></p><p id="52f3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">从datetime导入datetime，从pyspark.sql.functions导入time delta<br/>col，concat，lit，current_date</p><p id="c61d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#声明标记的日期olddate为无效记录。</strong></p><p id="2e84" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">yesterdayday = datetime . today()—time delta(days = 1)<br/>yesterdayday = yesterdayday . strftime(" % Y-% m-% d ")</p><p id="527d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#在增量表中创建一个表。</strong></p><p id="2680" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">spark.sql("使用增量位置' DBFS路径'创建表TableName(FielName数据类型)")</p><p id="91e4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">第三步:</strong></p><p id="d23c" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#为从blob存储中读取文件创建Azure blob连接。</strong></p><p id="f21b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">spark . conf . set(" fs . azure . account . Key .<storagename>. blob . core . windows . net "，" Secrate Key ")</storagename></p><p id="4f75" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">使用文件夹路径从blob中读取文件。<br/>path = " wabss://<a class="ae iu" href="mailto:specindiacontainer@specindia.blob.core.windows.net" rel="noopener ugc nofollow" target="_blank">&lt;container name&gt;@&lt;storage name&gt;. blob . core . windows . net</a>/file path/"</p><p id="4a20" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#文件列表</strong> <br/> filelist=dbutils.fs.ls(路径)</p><p id="37bf" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">第四步:</strong></p><p id="32f9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#执行以下操作，将数据存储在增量表中。</strong></p><p id="aecc" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">对于filelist中的f:<br/>if f . path . ends with(('。JSON ')):<br/>filename = f . name<br/>data = spark . read . option(" multiline "，" true ")。json(f.path)</p><p id="c8f2" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#根据场景在datafram中添加新列，HASHCode是ID+Name+Address</strong><br/>data = data . select(col(" ID ")，col("Name ")，col("Address)，concat(col("Id)，col("Name)，col("Address "))。别名(" HashCode "))<br/>data = data . with column(' valid from '，lit(current _ date())<br/>data = data . with column(' valid to '，lit(yesterdayday))</p><p id="9a27" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#如果存在，删除表格并将数据保存到临时表格。</strong><br/>spark . SQL(" DROP TABLE IF EXISTS SCD 2 temptable ")<br/>data . createorreplacetenview(" SCD 2 temptable ")</p><p id="221e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#看数据是否插入</strong><br/>ShowTable = spark . SQL(" select * from SCD 2 temptable ")。显示()</p><p id="52e5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">步骤5:执行SCD2操作</strong></p><p id="439e" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#从主增量表和临时表中读取数据，其中SCD2是主增量表</strong></p><p id="84a4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">SCD2 =DeltaTable.forPath(spark，"/file store/Demp/SCD 2 ")<br/>updatesDF = table(" SCD 2 temptable ")</p><p id="818b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#找到要插入或要禁用旧记录的行，并插入新记录。</strong></p><p id="c3ce" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">LatestRecord = updatesDF \ <br/>。别名(" NewData") \ <br/>。join(SCD2.toDF()。别名(" SCD2 ")，" Id") \ <br/>。其中(" NewData。HashCode &lt; &gt; SCD2。HashCode和SCD2。valid to = ' false ' ")<br/>staged updates =(<br/>LatestRecord<br/>。selectExpr("NULL as mergeKey "，" NewData。*)<br/>。union(updatesdf . select expr(" Id as merge key "，" *))<br/>)</p><p id="8a5f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#在上述dode中，LatestRecord包含基于id和hashcode差异的新数据，hashcode是所有数据行的组合，并且对cusotm列有效，用于标识该数据是否将被插入。</strong></p><p id="5154" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">SCD 2 . alias(“SCD 2”)。merge(<br/>staged updates . alias(" staged _ updates ")，<br/> "SCD2。Id = mergeKey")\ <br/>。when matched update(<br/>condition = " staged _ updates。HashCode &lt; &gt; SCD2。HashCode "，<br/>set = {<br/>" valid to ":" staged _ updates。ValidTo" <br/> } <br/>)。when notmatchedinsert(<br/>values = {<br/>" Id ":" staged _ updates。Id "，<br/> "Name": "staged_updates。姓名"，<br/>"地址":"分期_更新。Address "，<br/>" valid from ":" staged _ updates。ValidFrom "，<br/> "ValidTo": "False "，<br/> "HashCode":"staged_updates。HashCode" <br/> } <br/>)。执行()</p><p id="626b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在上面的代码中，如果数据匹配，首先禁用旧记录，然后用新数据更新记录。如果数据不匹配，它将简单地输入主表。</p><p id="5e35" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">#最后一步:执行下面的查询，查看主表中的数据</strong></p><p id="9005" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">spark . SQL(" select * from SCD 2 order by id ")。显示()</p><p id="9d08" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">输出:</strong></p><p id="c8a8" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">第一次执行:如果validto为false，则记录有效，否则无效。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es ld"><img src="../Images/ff278f82f5759fe17c18fd24aa5fe579.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/1*HY7r08vUhct1TQ-UU4tPCg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在这次执行中，它只是将数据插入主增量表中。</figcaption></figure><p id="7ae5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">第二次执行:</strong></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es le"><img src="../Images/4268e5953d9201c29460b2572a877350.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*2BdiUaZG12ydYg0MUv89CQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在这个执行中，名为XYZ的Id 1被禁用，新记录被启用。</figcaption></figure><p id="395b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">第三次执行:</strong></p><figure class="kx ky kz la fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/3b8091356243de57a84d0f1024db9fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*y6UTGzi-lA2gTICQtPYIxg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在该执行中，名为ABC的Id 2被禁用，并且用启用来更新新记录，并且插入具有id 4的新记录。</figcaption></figure><p id="b636" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated"><strong class="jv hj">注意:目前合并查询只支持字符串或列名。如果使用列名，则它必须在数据框中。</strong></p></div></div>    
</body>
</html>