<html>
<head>
<title>Python: Extracting Data using API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python:使用API提取数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/python-extracting-data-using-api-4adaf786f2d3?source=collection_archive---------2-----------------------#2020-03-17">https://medium.com/analytics-vidhya/python-extracting-data-using-api-4adaf786f2d3?source=collection_archive---------2-----------------------#2020-03-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3ba4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">初学者阅读了解更多关于在python中使用API的内容，不推荐给专业人士</em></p><p id="e967" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi je translated"><span class="l jf jg jh bm ji jj jk jl jm di"> E </span>提取数据的方式有很多种，比如将数据导出到平面文件，以JSON格式下载等等。这些是输出。但是，如果<strong class="ih hj">使用脚本</strong>，您可以直接连接到您的数据(提取它)并转换成您想要的格式。</p><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="js jt l"/></div></figure><h1 id="b6a0" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">什么是API？</h1><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ks"><img src="../Images/e57aa25d9444a5f1d52a8f41ce75b433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GQ03mLPKl_qre2afSYXlOA.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">图示:API从数据库中提取数据</figcaption></figure><blockquote class="ld le lf"><p id="080a" class="if ig jd ih b ii ij ik il im in io ip lg ir is it lh iv iw ix li iz ja jb jc hb bi translated"><a class="ae lj" href="https://www.howtogeek.com/343877/what-is-an-api/" rel="noopener ugc nofollow" target="_blank"> API </a>代表<strong class="ih hj">应用编程接口</strong>，它是一组<strong class="ih hj">协议</strong>，用于<strong class="ih hj">应用服务</strong>之间的通信。</p></blockquote><p id="a93a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我相信你们中的一些人听到这件事会感到不舒服(害怕)，并认为:</p><blockquote class="ld le lf"><p id="1e89" class="if ig jd ih b ii ij ik il im in io ip lg ir is it lh iv iw ix li iz ja jb jc hb bi translated">API太难了，对于像我这样的分析师来说，我不需要知道这些，这个东西只适合工程师或科学家。</p></blockquote><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="lk jt l"/></div></figure><p id="5122" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯，你的想法一点也没错。使用API只是获取数据的众多方法之一，<strong class="ih hj">最简单的方法是手动下载/导出数据到csv(通过点击按钮)</strong>。</p><p id="cb34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不同之处在于，您可以<strong class="ih hj">以编程方式连接到API服务</strong>，导出这些数据，进行一些转换，并将其作为输出加载。基本上，您可以创建一个脚本来做所有这些事情，而不是做3-5个步骤(下载、转换、加载等)。即使您能够通过再次运行脚本将数据刷新到最新状态，否则按照传统方式，您需要再次执行3-5个步骤来更新数据。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h1 id="209b" class="ju jv hi bd jw jx ls jz ka kb lt kd ke kf lu kh ki kj lv kl km kn lw kp kq kr bi translated"><strong class="ak">案例:从App Annie中抽取活跃用户</strong></h1><p id="b5ef" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">活跃用户正成为一些公司用来衡量他们相对于竞争对手的市场地位的标准指标之一。了解竞争对手活跃用户的常用方法之一是从<a class="ae lj" href="https://www.appannie.com/en/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> App Annie </strong> </a>。</p><p id="9352" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">App Annie是一个基于应用和移动历史数据来估计活跃用户、下载或广告的平台。</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="ce7c" class="mh jv hi md b fi mi mj l mk ml"><strong class="md hj">IMAGINE THIS!</strong></span><span id="ee57" class="mh jv hi md b fi mm mj l mk ml">You want to <strong class="md hj">compare</strong> 3 biggest online content provider: <a class="ae lj" href="https://www.youtube.com" rel="noopener ugc nofollow" target="_blank"><strong class="md hj">Youtube</strong></a>, <a class="ae lj" href="https://www.instagram.com" rel="noopener ugc nofollow" target="_blank"><strong class="md hj">Instagram</strong></a>, and <a class="ae lj" href="https://www.tiktok.com/en" rel="noopener ugc nofollow" target="_blank"><strong class="md hj">TikTok</strong></a> <strong class="md hj">active users</strong> <strong class="md hj">daily</strong> for <strong class="md hj">all time</strong> both <strong class="md hj">android</strong> and <strong class="md hj">ios</strong> devices</span></pre><p id="f9a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从技术上讲，您可以通过单击导出或使用API来提取数据。我将向您介绍这两种方法。</p><h2 id="9bde" class="mh jv hi bd jw mn mo mp ka mq mr ms ke iq mt mu ki iu mv mw km iy mx my kq mz bi translated">方法1:在App Annie界面点击导出</h2><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es na"><img src="../Images/3908038335357f09a8d4dafc0c2f78a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*5t0VbxPDASz614ExymdzPA.gif"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">App Annie界面:创建比较报告并导出到csv</figcaption></figure><p id="d8f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤其实很简单，比如:</p><ol class=""><li id="3642" class="nb nc hi ih b ii ij im in iq nd iu ne iy nf jc ng nh ni nj bi translated">您只需要创建比较报告，添加您想要比较的平台</li><li id="2372" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated">选择<code class="du np nq nr md b">Single Apps + Websites</code>这样可以区分android和ios</li><li id="f5ef" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated">选择时间框架(我选择从2019年1月到2019年底)</li><li id="8be9" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated">选择您想要的聚合(我希望每天都有)</li><li id="4386" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated">点击右上角的<code class="du np nq nr md b">Export</code>，继续操作，直到您的csv准备就绪</li></ol><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="ns jt l"/></div></figure><p id="dc22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">缺点是当您在特定时间执行这些步骤时，<strong class="ih hj">报告只会更新到该特定时间</strong>，如果您想要再次更新，您需要再次运行所有这5个步骤。你将需要清理你的数据，这可以在excel或其他电子表格阅读器中完成，或者你有另一个堆栈来更容易地完成这项工作(<em class="jd">相信我，在电子表格</em>中手动完成清理工作是很累的)</p><h2 id="1088" class="mh jv hi bd jw mn mo mp ka mq mr ms ke iq mt mu ki iu mv mw km iy mx my kq mz bi translated">方法2:使用App Annie API导出数据</h2><p id="0229" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">首先，您需要<strong class="ih hj">确保您在App Annie上的访问权限也包括API访问权限</strong></p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es na"><img src="../Images/a297fe20a19464e5a96a1033494a8d04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*1JxQQttjTy6scyDMjQGClQ.gif"/></div><figcaption class="kz la et er es lb lc bd b be z dx translated">正在检查您帐户的API密钥</figcaption></figure><p id="b97f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过以下步骤完成此操作:</p><ol class=""><li id="510f" class="nb nc hi ih b ii ij im in iq nd iu ne iy nf jc ng nh ni nj bi translated">指向右上角的帐户形状按钮，单击<code class="du np nq nr md b">API Key</code></li><li id="c2d2" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated">如果您可以访问App Annie API，您应该可以查看此页面，并单击<code class="du np nq nr md b">Show Key</code>，这是您的API密钥(不要与任何人共享)</li><li id="26b0" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated">请注意点击API的使用限制，如果超过限制，您将无法再次点击API</li></ol><p id="8b1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其次，浏览<a class="ae lj" href="https://helpcenter.appannie.com/community/s/" rel="noopener ugc nofollow" target="_blank"> App Annie帮助中心</a>，该API构建器记录了连接API和提取数据所需的所有内容，例如:您需要的URL结构、响应格式、响应中每个属性的定义等。</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="daf7" class="mh jv hi md b fi mi mj l mk ml">In this case, I have to follow the steps from this <a class="ae lj" href="https://helpcenter.appannie.com/community/s/article/Usage-Engagement-APIs" rel="noopener ugc nofollow" target="_blank"><strong class="md hj">LINK</strong></a>, at <strong class="md hj">Usage App History</strong> part</span></pre><p id="7069" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您需要根据此文档指定正确的URL结构，并填写所需的参数以成功获取您的数据(请参见下图)</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nt"><img src="../Images/b17f6d82b8b879b2a2170ad27b3ad384.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nuxeI5qDK511f7xjaHyQjw.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">定义良好的API文档</figcaption></figure><h2 id="b4cf" class="mh jv hi bd jw mn mo mp ka mq mr ms ke iq mt mu ki iu mv mw km iy mx my kq mz bi translated">起始代码！！！</h2><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="nu jt l"/></div></figure><ol class=""><li id="570d" class="nb nc hi ih b ii ij im in iq nd iu ne iy nf jc ng nh ni nj bi translated">导入所需的库</li></ol><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="c6e4" class="mh jv hi md b fi mi mj l mk ml">import pandas as pd<br/>import json<br/>import requests</span></pre><p id="27b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.构造所需格式的密钥(<em class="jd"> API密钥因用户而异</em></p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="a86c" class="mh jv hi md b fi mi mj l mk ml">key = f'bearer {api_key}'</span></pre><p id="5a01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.创建一个函数将JSON传递给pandas dataframe ( <em class="jd">原因:可读性更强</em>，然后你只需改变参数<code class="du np nq nr md b">product_id</code>就可以改变不同的app，改变参数<code class="du np nq nr md b">market</code>用于ios/android，改变参数<code class="du np nq nr md b">country</code>就可以改变国家。然后，你可以调用这个函数来得到结果。</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="c289" class="mh jv hi md b fi mi mj l mk ml">def extract_active_user_appannie(product_id, market, country, app, granularity="daily", start_date="2019-01-01"):<br/>    #market = ios/all-android<br/>    #country = "2 digit country code (ID,SG,TH,etc)"<br/>    #granularity = daily, weekly, monthly<br/>    url = f"<a class="ae lj" href="https://api.appannie.com/v1.3/intelligence/apps/{market}/app/{product_id}/usage-history?countries={country}&amp;granularity={granularity}&amp;start_date={start_date" rel="noopener ugc nofollow" target="_blank">https://api.appannie.com/v1.3/intelligence/apps/{market}/app/{product_id}/usage-history?countries={country}&amp;granularity={granularity}&amp;start_date={start_date</a>}"</span><span id="6191" class="mh jv hi md b fi mm mj l mk ml">response = requests.get(url, headers={'Authorization':key})<br/>    df = pd.DataFrame(response.json()["list"])[["device","date","active_users"]]<br/>    df["country_code"] = country<br/>    df["app"] = app<br/>    return df</span></pre><p id="24df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过点击每个应用程序找到<code class="du np nq nr md b">product_id</code>，向下滚动页面，您会发现灰色字体的<code class="du np nq nr md b">App ID</code></p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nv"><img src="../Images/4bea81d9f215148d790e69ab688b68bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cdzkJHIXezCcWmwLuySmxA.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">点击应用名称进入应用页面并获取应用ID</figcaption></figure><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nw"><img src="../Images/574d5cac3f09cd9a7943f0edfbc19c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0LjMkwnYlupeOJaHznSKww.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">将应用程序ID复制为上面代码中的product_id</figcaption></figure><p id="5ad1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.激动人心的部分:使用函数从每个应用程序中提取数据</p><pre class="jn jo jp jq fd mc md me mf aw mg bi"><span id="dea4" class="mh jv hi md b fi mi mj l mk ml">#android<br/>android_instagram = extract_active_user_appannie(product_id=&lt;instagram_android_app_ID&gt;,app="instagram",market="all-android",country="ID")<br/>android_tiktok = extract_active_user_appannie(product_id=&lt;tiktok_android_app_ID&gt;,app="tiktok",market="all-android",country="ID")<br/>android_youtube = extract_active_user_appannie(product_id=&lt;youtube_android_app_ID&gt;,app="youtube",market="all-android",country="ID")</span><span id="20fc" class="mh jv hi md b fi mm mj l mk ml">#ios<br/>ios_instagram = extract_active_user_appannie(product_id=&lt;instagram_ios_app_ID&gt;,app="instagram",market="ios",country="ID")<br/>ios_tiktok = extract_active_user_appannie(product_id=&lt;tiktok_ios_app_ID&gt;,app="tiktok",market="ios",country="ID")<br/>ios_youtube = extract_active_user_appannie(product_id=&lt;youtube_ios_app_ID&gt;,app="youtube",market="ios",country="ID")</span><span id="fcab" class="mh jv hi md b fi mm mj l mk ml">df = pd.concat([android_instagram,android_tiktok,android_youtube,ios_instagram,ios_tiktok,ios_youtube])<br/>df = df.loc[df["device"].isin(["android","ios"])]<br/>df = df[["date","app","device","country_code","active_users"]]</span></pre><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es nx"><img src="../Images/87f5847aebeedea8c1cb5f18b801cc6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QwRv_3fzXYIyiYML17vBRA.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">最终输出样本</figcaption></figure><p id="a3e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd"> ❗️ </em> <strong class="ih hj"> <em class="jd">警告</em> </strong> <em class="jd">:以上数字是我自己生成的虚拟数字，根本不代表各自App的真实活跃用户</em> <strong class="ih hj">(实际活跃用户是保密的，版权归App Annie所有)</strong></p><p id="d852" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下次您想要将数据更新到最近的日期时，您只需再次运行python脚本，或者使用cron/airflow使其自动化。这显然可以节省你的时间很多，你可以做其他事情。</p><h1 id="64c1" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="162e" class="pw-post-body-paragraph if ig hi ih b ii lx ik il im ly io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">根据我的经验，你将需要以上两种方法，但在某些情况下。</p><p id="2b15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">何时可以应用方法1: </strong></p><ol class=""><li id="05af" class="nb nc hi ih b ii ij im in iq nd iu ne iy nf jc ng nh ni nj bi translated">你只需要<strong class="ih hj">一次临时分析</strong>，不需要一直更新数据。</li><li id="386f" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated"><strong class="ih hj">您很快就需要数据</strong>(例如:您的利益相关者在早上请求数据，并期望数据在当天中午/下午准备好👌)，如果是这种情况，我不希望您使用API提取数据，因为创建和测试脚本将会耗尽时间，并且您还需要清理数据。</li></ol><p id="384d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">何时可以应用方法2: </strong></p><ol class=""><li id="06b8" class="nb nc hi ih b ii ij im in iq nd iu ne iy nf jc ng nh ni nj bi translated"><strong class="ih hj">你需要的数据应该每天/每周/每月更新</strong>(例如:创建一个仪表板)，除非你不会浪费你的生命😩，我建议您自动化数据提取过程，直到它准备好结束输出。</li><li id="7c54" class="nb nc hi ih b ii nk im nl iq nm iu nn iy no jc ng nh ni nj bi translated"><strong class="ih hj">你有足够的时间来探索这种方法</strong>，我知道这种方法从来都不容易，但我很肯定你会从这种方法中获益，因为你会更了解API本身以及如何与其输出进行交互。这将是你改变人生的时刻。毕竟这种方法实在是太酷了，而不仅仅是导出手册。(哈哈哈😂😂)</li></ol><p id="b901" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> — — — — —故事结束— — </strong></p><p id="7cff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">注意事项</em> </strong> <em class="jd">:本文仅涵盖从数据提取到数据准备就绪。但是，更有趣的部分是我们如何利用这些数据成为利益相关者的有用见解。我将在另一个故事中讲述这些事情。敬请关注！！！！</em></p></div></div>    
</body>
</html>