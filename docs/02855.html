<html>
<head>
<title>How (and Why) to Add a Chart to Your D3.js Tooltip</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何(以及为什么)将图表添加到D3.js工具提示中</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-and-why-to-add-a-chart-to-your-d3-js-tooltip-6aca4ecfd79d?source=collection_archive---------10-----------------------#2020-01-05">https://medium.com/analytics-vidhya/how-and-why-to-add-a-chart-to-your-d3-js-tooltip-6aca4ecfd79d?source=collection_archive---------10-----------------------#2020-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9f36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工具提示是可视化中最被低估的部分之一。当用户最初对可视化感到困惑时，他们通常会将鼠标悬停在感兴趣的数据点上以获取更多信息。</p><p id="82c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，许多工具提示并没有真正阐明我们的数据。他们经常重复已经呈现的内容，而没有澄清数据中任何令人困惑的部分。最常见的是，我看到(甚至创造😦)显示最基本信息的工具提示(在地图中，工具提示会显示州名和感兴趣的值)，除此之外别无其他！</p><p id="c741" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，这种工具提示并没有什么错。但是他们真的做了最少的工作，结果，他们错过了工具提示的全部潜力。<strong class="ih hj">如果用户通过浏览数据来主动寻找更多信息，我们应该尽可能用最有帮助和最有趣的信息来奖励他们。</strong></p><p id="4b7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是为什么我最近更新了我的一个工具提示，从文本信息的静态呈现到描绘随时间变化的折线图。</p><p id="59f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的<a class="ae je" href="https://connorrothschild.github.io/D3.js/map-overdoses/" rel="noopener ugc nofollow" target="_blank"> choropleth图描绘了随着时间的推移与阿片类药物有关的过量死亡</a>来自于此:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/2002e80bd8ff0e343fe59ddb0aa7244f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*7FzKHR_zvj9Fju4VfFERsA.gif"/></div></div></figure><p id="1f70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对此:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jr"><img src="../Images/9399ddcc151e6db88c7a1ef8bb243c76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*aSZT1tEVL8wl68bMYtPcFw.gif"/></div></div></figure><h1 id="ab92" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">我为什么要做这样的改变？</h1><p id="094e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">以前的工具提示提供的信息相当无趣。尽管它澄清了在特定时间特定州的药物过量死亡的确切比率，但它没有做太多其他的事情。它确实提供了当前视图中的年份，但是在可视化的右下角也可以看到！它还提供了州名，但我的大多数观众可能在中学上过我们的地理课。</p><p id="5621" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，这个工具提示是相当多余的。最好的情况是，它提供了<em class="jd">精确的</em>比率，以便查看者可以比较两个状态，或者了解关于给定状态的更多信息，而不仅仅依靠颜色编码(<a class="ae je" href="https://courses.cs.washington.edu/courses/cse442/17au/lectures/CSE442-VisualEncoding.pdf" rel="noopener ugc nofollow" target="_blank">在涉及到定量编码</a>时可能有些不可靠，就像choropleth图中的情况)。</p><p id="9552" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">新的工具提示显示了一段时间的趋势。它还显示了州名(以防你在美国地理中跳过了那一天！)，以及用药过量死亡的最新数据。因为这张地图旨在显示阿片类药物危机<em class="jd">是如何演变的</em>，在我的工具提示中显示每个州的折线图允许用户在悬停时探索每个州的趋势！这比每年在每个州徘徊并试图跟踪趋势要容易得多。</p><p id="1403" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，在西弗吉尼亚州徘徊，该州在2017年似乎有最高的阿片类药物过量死亡率(如其最暗的红色阴影所示)，表明其也经历了自1999年以来该比率的最大长期增长之一:</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kv"><img src="../Images/93e14d0317f6fbaf28f98bf3bbb1f806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*joxEt06QD1fi3d3A-7Xdqg.jpeg"/></div></div></figure><h1 id="393d" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">那么，你是怎么做的呢？</h1><p id="0b21" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">很棒的问题！谢天谢地，这并不难，但回报是巨大的。由于几个<a class="ae je" href="https://stackoverflow.com/questions/43904643/add-chart-to-tooltip-in-d3" rel="noopener ugc nofollow" target="_blank">堆栈溢出答案</a>和<a class="ae je" href="https://bl.ocks.org/maelafifi/ee7fecf90bb5060d5f9a7551271f4397" rel="noopener ugc nofollow" target="_blank">在线示例</a>，从我的旧的、无聊的工具提示到我的新的、性感的工具提示只花了几个小时。</p><h1 id="1c57" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">第一步:加载<code class="du kw kx ky kz b">d3-tip</code></h1><p id="3aca" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">这个过程主要依靠<code class="du kw kx ky kz b">d3-tip</code>，你可以在这里了解更多关于<a class="ae je" href="http://labratrevenge.com/d3-tip/" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="04d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以用下面的代码加载<code class="du kw kx ky kz b">d3-tip</code>:</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="7fe5" class="le jt hi kz b fi lf lg l lh li">&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"&gt;&lt;/script&gt;</span></pre><h1 id="20c6" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">步骤2:创建工具提示对象</h1><p id="bba9" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">接下来，初始化工具提示，给它一个类(用于CSS样式)，并提供指定的<code class="du kw kx ky kz b">offset</code>。在我的例子中，我根据<a class="ae je" href="https://stackoverflow.com/questions/28536367/in-d3-js-how-to-adjust-tooltip-up-and-down-based-on-the-screen-position" rel="noopener ugc nofollow" target="_blank">用户的鼠标位置</a>来定义我的偏移量。这样，如果用户悬停在一个东部州，工具提示不会从屏幕上消失！</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="28de" class="le jt hi kz b fi lf lg l lh li">// define the tooltip <br/>var tool_tip = d3.tip()<br/>  .attr("class", "d3-tip")<br/>  // if the mouse position is greater than 650 (~ Kentucky/Missouri), offset tooltip to the left instead of the right<br/>  .offset(function() {if(current_position[0] &gt; 650) {<br/>  	return [-20,-120] } <br/>  	else { return [20,120]}<br/>  })<br/>  // input the title, and include the div<br/>  .html(<br/>  	"&lt;p&gt;Opioid-involved deaths over time in&lt;/p&gt;&lt;div id='tipDiv'&gt;&lt;/div&gt;"<br/>  );<br/><br/>svg.call(tool_tip);</span></pre><p id="9f40" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里最重要的部分是</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="8c3a" class="le jt hi kz b fi lf lg l lh li">.html(<br/>     "&lt;p&gt;Opioid-involved deaths over time in&lt;/p&gt;&lt;div id='tipDiv'&gt;&lt;/div&gt;"<br/>);</span></pre><p id="035a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里我们定义了创建工具提示本身的html。在我们的例子中，我们提供了一个标题“与阿片类药物相关的死亡”，并指定工具提示应该包含的div。</p><h1 id="6d33" class="js jt hi bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">步骤3:创建<code class="du kw kx ky kz b">tipDiv</code>对象</h1><p id="22c5" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">最后，我们可以创建上面代码中引用的<code class="du kw kx ky kz b">tipDiv</code>对象。该对象将在鼠标经过感兴趣的组(在我的例子中是states)时创建。因此，代码将如下所示:</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="b6be" class="le jt hi kz b fi lf lg l lh li">states = svg.append("g")<br/>  .attr("class", "states")<br/>  .selectAll("path")<br/>  .data(topojson.feature(us, us.objects.states).features)<br/>  .enter()<br/>  .append("path")<br/>  .attr("d", path)<br/>  .on('mouseover', function(d) {<br/><br/>// define and store the mouse position. this is used to define tooltip offset, seen above.<br/>current_position = d3.mouse(this); 				<br/><br/>// define current state<br/>current_state = nameById[d.id]<br/>	<br/>// show the tooltip<br/>tool_tip.show();</span></pre><p id="45e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在初始化和<code class="du kw kx ky kz b">show</code>函数之后，我们可以定义<code class="du kw kx ky kz b">tipDiv</code>对象:</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="afd4" class="le jt hi kz b fi lf lg l lh li">var tipSVG = d3.select("#tipDiv")<br/>     .append("svg")<br/>     .attr("width", 220)<br/>     .attr("height", 55);<br/><br/>tipSVG.append("path")<br/>     .datum(overdoses.filter(function(d) {return nameById[d.id] == current_state}))<br/>     .style("stroke", function() {<br/>     	if (rateById[d.id] &lt; 10) {<br/>     		return "grey"<br/>     	} else {<br/>     	return color(rateById[d.id])<br/>     	}<br/> 	  })<br/>     .style("stroke-width", 1.5)<br/>     .style("fill", "none")<br/>     .attr("d", line)<br/>     <br/>tipSVG.append("circle")<br/>     .attr("fill", function() {<br/>     	if (rateById[d.id] &lt; 10) {<br/>     		return "grey"<br/>     	} else {<br/>     	return color(rateById[d.id])<br/>     	}<br/> 	  })<br/>    .attr("stroke", "black")<br/>    .attr("cx", 130)<br/>    .attr("cy", y_tooltip(rateById[d.id]))<br/>    .attr("r", 3)<br/><br/>tipSVG.append("text")<br/>     .text(rateById[d.id] + " deaths")<br/>     .attr("x", 140)<br/>     .attr("y", function() {<br/>     	if (y_tooltip(rateById[d.id]) &lt; 15) { return 10 }<br/>     		else { return y_tooltip(rateById[d.id]) - 7 }<br/>     	})<br/><br/>tipSVG.append("text")<br/>     .text("per 100,000")<br/>     .attr("x", 140)<br/>     .attr("y", function() {<br/>     	if (y_tooltip(rateById[d.id]) &lt; 15) { return 24 }<br/>     		else { return y_tooltip(rateById[d.id]) + 7 }<br/>     	})<br/>	<br/>tipSVG.append("text")<br/>     .text(current_state)<br/>     .attr("x", 0)<br/>     .attr("y", 15)<br/>     .style("font-size", 18)<br/>     .style("font-weight", 400)<br/> })<br/>.on('mouseout', tool_tip.hide)</span></pre><p id="846b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里发生了什么事？让我们一次看一块。</p><p id="1c83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">首先</strong>，我们定义对象，命名为<code class="du kw kx ky kz b">tipSVG</code>。<code class="du kw kx ky kz b">tipSVG</code>选择<code class="du kw kx ky kz b">#tipDiv</code>(在我们的d3-tip中定义)并附加一个SVG。我们还定义了工具提示的宽度和高度。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="09e5" class="le jt hi kz b fi lf lg l lh li">var tipSVG = d3.select("#tipDiv")<br/>	      .append("svg")<br/>	      .attr("width", 220)<br/>	      .attr("height", 55);</span></pre><p id="c6d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">接下来</strong>，我们向SVG添加一个路径。这可以是圆形、矩形或任何其他可附加的形状。因为我在画一条简单的线，所以我们使用<code class="du kw kx ky kz b">path</code>。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="afe1" class="le jt hi kz b fi lf lg l lh li">tipSVG.append("path")<br/>  .datum(overdoses.filter(function(d) {return nameById[d.id] == current_state}))<br/>  .style("stroke", function() {<br/>  	if (rateById[d.id] &lt; 10) {<br/>  		return "grey"<br/>  	} else {<br/>  	return color(rateById[d.id])<br/>  	}<br/>	  })<br/>  .style("stroke-width", 1.5)<br/>  .style("fill", "none")<br/>  .attr("d", line)</span></pre><p id="58b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在定义<code class="du kw kx ky kz b">d</code>属性时，您会看到我使用了短语<code class="du kw kx ky kz b">line</code>。这在我的代码中定义为返回每个数据点的x和y位置，以创建路径本身。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="6837" class="le jt hi kz b fi lf lg l lh li">var x_tooltip = d3.scaleLinear()<br/>  .domain(d3.extent(overdoses, function(d) { return d.year; }))<br/>  .range([ 0, 130 ]);<br/><br/>var y_tooltip = d3.scaleLinear()<br/>  .domain([0, 60])<br/>  .range([ 50, 0 ]);<br/><br/>var line = d3.line()<br/>  .x(function(d) {<br/>    return x_tooltip(d.year);<br/>  })<br/>  .y(function(d) {<br/>    return y_tooltip(+d.rate);<br/>  })</span></pre><p id="6f3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最后</strong>，我们在线的末端添加一个圆圈来表示最终的数据点。我们还添加了2017年的文本标签。</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="c944" class="le jt hi kz b fi lf lg l lh li">tipSVG.append("circle")<br/>  .attr("fill", function() {<br/>  	if (rateById[d.id] &lt; 10) {<br/>  		return "grey"<br/>  	} else {<br/>  	return color(rateById[d.id])<br/>  	}<br/>	  })<br/>   .attr("stroke", "black")<br/>  .attr("cx", 130)<br/>  .attr("cy", y_tooltip(rateById[d.id]))<br/>  .attr("r", 3)<br/><br/>tipSVG.append("text")<br/>  .text(rateById[d.id] + " deaths")<br/>  .attr("x", 140)<br/>  .attr("y", function() {<br/>  	if (y_tooltip(rateById[d.id]) &lt; 15) { return 10 }<br/>  		else { return y_tooltip(rateById[d.id]) - 7 }<br/>  	})<br/><br/>tipSVG.append("text")<br/>  .text("per 100,000")<br/>  .attr("x", 140)<br/>  .attr("y", function() {<br/>  	if (y_tooltip(rateById[d.id]) &lt; 15) { return 24 }<br/>  		else { return y_tooltip(rateById[d.id]) + 7 }<br/>  	})<br/><br/>tipSVG.append("text")<br/>  .text(current_state)<br/>  .attr("x", 0)<br/>  .attr("y", 15)<br/>  .style("font-size", 18)<br/>  .style("font-weight", 400)<br/> })</span></pre><p id="a301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们隐藏mouseout上的工具提示:</p><pre class="jg jh ji jj fd la kz lb lc aw ld bi"><span id="f446" class="le jt hi kz b fi lf lg l lh li">.on('mouseout', tool_tip.hide)</span></pre><p id="ba66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读我的(第一？)中帖！你可以在这里<a class="ae je" href="https://connorrothschild.github.io/D3.js/map-overdoses/" rel="noopener ugc nofollow" target="_blank">亲自体验可视化和查看工具提示。</a></p></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><p id="ddf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原载</em> <a class="ae je" href="https://connorrothschild.github.io/d3js/how-to-add-a-chart-d3-tooltip" rel="noopener ugc nofollow" target="_blank"> <em class="jd">我的网站。</em>T11】</a></p></div></div>    
</body>
</html>