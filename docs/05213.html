<html>
<head>
<title>Delete Unused AMI’s — Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">删除未使用的AMI-Python</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/delete-unused-amis-python-f9db0102f12?source=collection_archive---------6-----------------------#2020-04-14">https://medium.com/analytics-vidhya/delete-unused-amis-python-f9db0102f12?source=collection_archive---------6-----------------------#2020-04-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="d28a" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">现在节约成本，或者以后后悔。</p></blockquote><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es jh"><img src="../Images/902aeb3fcfc6bd231a195aeb07f8a193.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sZoj4hXdeVdSiaamHl8bxw.jpeg"/></div></div><figcaption class="jt ju et er es jv jw bd b be z dx translated">来源:谷歌图片</figcaption></figure><p id="cec7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi ka translated">AMI在您的AWS帐户中创建的帐户对您每月的账单有很大的影响。当我们出于备份目的手动或通过脚本创建大量AMI时，就会发生这种情况。因此，为了优化成本，我们必须删除未使用的AMI，因为即使它们被使用或未被使用，它们也会增加成本。<strong class="il hj">这些AMI由快照使用，在取消注册AMI之前不能删除这些快照。</strong></p><p id="5b07" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj"> AMI: </strong> An <a class="ae kj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html" rel="noopener ugc nofollow" target="_blank"> <strong class="il hj"> Amazon机器映像(AMI) </strong> </a>提供启动EC2实例所需的信息，该实例包含一个或多个快照、启动权限和块设备映射。</p><p id="cca1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated">整个过程的简要说明如下:</p><ul class=""><li id="3add" class="kk kl hi il b im in iq ir jx km jy kn jz ko jg kp kq kr ks bi translated">获取在您的帐户中创建的所有AMI:</li><li id="e2f3" class="kk kl hi il b im kt iq ku jx kv jy kw jz kx jg kp kq kr ks bi translated">从EC2实例中查找未使用的AMI。</li><li id="3544" class="kk kl hi il b im kt iq ku jx kv jy kw jz kx jg kp kq kr ks bi translated">取消AMI的注册。</li></ul><h1 id="b1b0" class="ky kz hi bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><strong class="ak">问题陈述:</strong></h1><p id="129a" class="pw-post-body-paragraph ii ij hi il b im lw io ip iq lx is it jx ly iw ix jy lz ja jb jz ma je jf jg hb bi translated">注销/删除超过3个月且未使用的AMI，以优化成本。</p><p id="5d08" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj">脚本的逻辑和功能</strong></p><ul class=""><li id="07ce" class="kk kl hi il b im in iq ir jx km jy kn jz ko jg kp kq kr ks bi translated"><strong class="il hj"> ami_from_ami_list() </strong>:从aws cli运行<em class="ik"> ec2 describe-images </em>以获取您帐户中超过3个月的所有ami的列表(比如列表1)。</li><li id="e17f" class="kk kl hi il b im kt iq ku jx kv jy kw jz kx jg kp kq kr ks bi translated"><strong class="il hj">ami _ from _ ec2 _ instances()</strong>:从aws cli运行<em class="ik">ec2 describe-instances</em><strong class="il hj"/>以获取附加AMI或使用中AMI的列表(比如列表2)。</li><li id="455a" class="kk kl hi il b im kt iq ku jx kv jy kw jz kx jg kp kq kr ks bi translated"><strong class="il hj"> ami_not_in_use(): </strong>找到不在使用中的ami，即<em class="ik">列表1中的AMI，但不在列表2中。</em></li><li id="5f86" class="kk kl hi il b im kt iq ku jx kv jy kw jz kx jg kp kq kr ks bi translated"><strong class="il hj"> deregister_ami() </strong>:运行AWSderegister函数，取消ami的注册。</li></ul><p id="fdc3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj">要求</strong></p><ul class=""><li id="8421" class="kk kl hi il b im in iq ir jx km jy kn jz ko jg kp kq kr ks bi translated">AWS帐号:您的AWS帐号。</li><li id="d6c7" class="kk kl hi il b im kt iq ku jx kv jy kw jz kx jg kp kq kr ks bi translated">AWS (aws-cli)配置文件名称:您的aws-cli配置文件名称。</li></ul><p id="9ed9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><em class="ik">查看以下截图以添加要求。</em></p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es mb"><img src="../Images/3262907c4a792ec384ad3dce35997bac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uZXaRplnZ7TiGg99822xzQ.png"/></div></div></figure><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es mc"><img src="../Images/b377d50721b083311d4ce171619a7b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-kxZ69A_3Pfx6z3OJIHlw.png"/></div></div></figure><p id="5f26" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj">代码</strong></p><pre class="ji jj jk jl fd md me mf mg aw mh bi"><span id="4537" class="mi kz hi me b fi mj mk l ml mm">#!/usr/bin/env python3<br/># -*- coding: utf-8 -*-<br/>"""<br/>Created on Wed Apr  8 02:02:27 2020</span><span id="3550" class="mi kz hi me b fi mn mk l ml mm"><a class="ae kj" href="http://twitter.com/author" rel="noopener ugc nofollow" target="_blank">@author</a>: sachin<br/>"""<br/>import os<br/>import json<br/>import datetime<br/>import time<br/>import numpy as np <br/>from boto import ec2<br/>from boto.exception import EC2ResponseError</span><span id="3213" class="mi kz hi me b fi mn mk l ml mm">start_time = time.time() <br/>aws_profile_name="Add your aws profile name"<br/>account_number="ADD your aws account number"<br/></span><span id="0262" class="mi kz hi me b fi mn mk l ml mm"><br/>#logic to get list of ami which are being used by ec2-instances<br/>def ami_from_ec2_instances():<br/>    <br/>    resp = f"aws ec2 describe-instances --profile {aws_profile_name} --query 'Reservations[*].Instances[*].[InstanceId , InstanceType, ImageId, State.Name, LaunchTime, Placement.AvailabilityZone, InstanceLifecycle, Platform ,VirtualizationType,PrivateIpAddress, PublicIpAddress, [Tags[?Key==`Name`].Value] [0][0], [Tags[?Key==`purpose`].Value] [0][0], [Tags[?Key==`team`].Value] [0][0], [Tags[?Key==`habitat`].Value] [0][0] , [Tags[?Key==`Project`].Value] [0][0],  [Tags[?Key==`provisioner`].Value] [0][0], [Tags[?Key==`spotinst:aws:ec2:group:id`].Value] [0][0] ]' --region ap-southeast-1 --output json"<br/>    ec2_data = os.popen(resp)<br/>    output = ec2_data.read()<br/>    #converting the response into JSON<br/>    ec2_data_json=json.loads(output)<br/>    ami_from_ec2=[]<br/>    <br/>    #iterating the list <br/>    for i in ec2_data_json:<br/>        for j in i:<br/>            for k in j:<br/>                res = [str(k or 'NA') for k in j]<br/>                #print (res)<br/>                #to convert the list to string since we cannot insert list into db directly as per our use case<br/>                sac = ",".join(res)<br/>                #print(sac)<br/>                #print("\n")<br/>                val=(sac)<br/>                #to convert the string into tuple containing , in the string<br/>                val_split=tuple(val.split(','))<br/>        #print(val_split)<br/>        instance_id=val_split[0]<br/>        ami=val_split[2]<br/>        private_ip=val_split[9]<br/>        name=val_split[11]<br/>        state=val_split[3]<br/>        value=(instance_id,ami,state,private_ip,name)<br/>        if state=="running":<br/>            ami_from_ec2.append(ami)<br/>            #print("\n")               <br/>            #print (value)<br/>        else:<br/>            pass<br/>        <br/>    return (ami_from_ec2)</span><span id="aebc" class="mi kz hi me b fi mn mk l ml mm">#logic to get list of ami which exists in aws account<br/>def ami_from_ami_list():<br/>        <br/>    ami_from_amilist=[]<br/>    timeLimit=datetime.datetime.now() - datetime.timedelta(days=90)<br/>    sachin=timeLimit.date()<br/>    resp1 = f"aws ec2 describe-images --profile {aws_profile_name} --region ap-southeast-1 --filters --owners {account_number} --output json"<br/>    #method<br/>    config_data1 = os.popen(resp1)<br/>    output1 = config_data1.read()<br/>    config_data_json1=json.loads(output1)<br/>    <br/>    for num in config_data_json1['Images']:<br/>        image_id=num['ImageId']<br/>        creation_date_raw=num['CreationDate']<br/>        owner_id=num['OwnerId']<br/>        creation_date_raw_1=tuple(creation_date_raw.split('T'))<br/>        creation_date=creation_date_raw_1[0]<br/>        creation_date_object = datetime.datetime.strptime(creation_date, '%Y-%m-%d').date()<br/>        state=num['State']<br/>        try:<br/>            name=num['Name']<br/>            <br/>        except KeyError as e:<br/>            name="NA"<br/>            <br/>        if creation_date_object &lt;  timeLimit.date() and state== "available":<br/>                ami_from_amilist.append(image_id)    <br/>                #print (image_id, name,creation_date, state,owner_id)<br/>    return (ami_from_amilist)</span><span id="f0d0" class="mi kz hi me b fi mn mk l ml mm">#function which returns list of AMI which are not in use and are older than 6 months<br/>def ami_not_in_use():<br/>    <br/>    ami_from_ec2=ami_from_ec2_instances()<br/>    ami_from_amilist=ami_from_ami_list()<br/>    #Unique values in array1(ami_from_amilist) that are not in array2(ami_from_ec2)<br/>    #Below array will give me list of ami which are not in use by any instance and are older than 6 months<br/>    ami_not_inuse=(np.setdiff1d(ami_from_amilist,ami_from_ec2))<br/>    <br/>    print ("AMI which are not in use and are older than 6 months")<br/>    print (ami_not_inuse)<br/>    print("\n")<br/>    return(ami_not_inuse)</span><span id="95b0" class="mi kz hi me b fi mn mk l ml mm">#function to deregister ami's which are not in use and are older than 3 months<br/>def deregister_ami():<br/>    connection=ec2.connect_to_region("ap-southeast-1",profile_name = aws_profile_name)<br/>    ami_to_deregister=ami_not_in_use()<br/>    print ("Degistering AMI's")<br/>    print ("\n-----------------")<br/>    print ("\n")<br/>    for ami in ami_to_deregister:  <br/>      try:<br/>        connection.deregister_image(ami)<br/>        print (" Deregistering AMI %s "  %(ami))    <br/>      except EC2ResponseError as e:<br/>        print ("exception in AMI: %s" %(ami))    <br/>      else:<br/>          pass<br/>    <br/>#calling function    <br/>deregister_ami()</span><span id="abe1" class="mi kz hi me b fi mn mk l ml mm">total_ececution_time=(time.time() - start_time)<br/>print ("\n")<br/>print ("Total_ececution_time", total_ececution_time, "seconds")</span></pre><p id="a0eb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj">结果</strong></p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es mo"><img src="../Images/f6111def3f54e0ba9b7fad918bb28006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aWQAsQkm_ccy4y0UJlSY3A.png"/></div></div></figure><p id="784c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj"> <em class="ik">你可以在我的Linkedin个人资料上找到我的另一篇成本优化文章:</em></strong><a class="ae kj" href="https://www.linkedin.com/in/sssachinsharma52/" rel="noopener ugc nofollow" target="_blank"><em class="ik">https://www.linkedin.com/in/sssachinsharma52/</em></a></p><p id="3423" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jx iv iw ix jy iz ja jb jz jd je jf jg hb bi translated"><strong class="il hj">下面附上部分文章:</strong></p><div class="mp mq ez fb mr ms"><a rel="noopener follow" target="_blank" href="/lenskart-engineering/aws-infra-cost-optimisation-180e14a7e7ae"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">AWS基础设施成本优化</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">存钱就是挣钱。如果你不能照顾好你的基础设施账单，没有人会去做…</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">medium.com</p></div></div><div class="nb l"><div class="nc l nd ne nf nb ng jr ms"/></div></div></a></div><div class="mp mq ez fb mr ms"><a rel="noopener follow" target="_blank" href="/@sssachinsharma52/aws-ri-normalised-factor-3f112279c2cd"><div class="mt ab dw"><div class="mu ab mv cl cj mw"><h2 class="bd hj fi z dy mx ea eb my ed ef hh bi translated">AWS RI标准化因子</h2><div class="mz l"><h3 class="bd b fi z dy mx ea eb my ed ef dx translated">亚马逊保留实例</h3></div><div class="na l"><p class="bd b fp z dy mx ea eb my ed ef dx translated">medium.com</p></div></div><div class="nb l"><div class="nh l nd ne nf nb ng jr ms"/></div></div></a></div></div></div>    
</body>
</html>