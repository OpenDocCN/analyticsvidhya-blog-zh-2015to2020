# 使用开放数据的新方法:查询链

> 原文：<https://medium.com/analytics-vidhya/a-new-way-of-using-open-data-query-the-chain-78c8e95c172a?source=collection_archive---------19----------------------->

![](img/d21b7317e75192f39ddf50b2a58cac12.png)

由 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的 [Launchpresso](https://unsplash.com/@launchpresso?utm_source=medium&utm_medium=referral) 拍摄的照片

> “数据是新的黄金”
> 
> “大数据是新的黑金吗？”
> 
> “数据不是下一个黄金。这是下一个铀”
> 
> “世界上最宝贵的资源不再是石油，而是数据”

剧透一下，我是区块链开发者，不是数据科学家。这篇文章是关于用**图**访问数据的。但我们在 2019 年的秋天，仍然(或开始)相信数据是下一个黄金。虽然有些人可能会质疑，但这不是在这里讨论的话题。

毫无疑问，数据是我们拥有的最好的资源之一。不是因为它的货币价值(不像黄金)，而是因为它告诉我们什么。因为它描述了我们。即使听起来不舒服，我们有时也会发现我们不知道的事情。看，没有数据，人工智能或人工智能系统如何学习或训练。

再说一次，数据最有价值的方面是它给我们的生活带来的质量。我们能够以更快的速度进行研究。我们已经能够收集成千上万的照片，并创建微笑识别系统。成千上万的单词和识别文本主题，以及其他许多事情。

# 不仅如此，而且

正如我在开头提到的，我不是数据科学家。但我知道，当一家公司收到数据进行研究时，在真正开始研究之前，需要采取一些步骤。在进入任何 ML 或 AI 系统之前，都需要进行标准化和匿名化。

也就是说，我们假设下面的数据是公开的。

可以提出许多问题，但其中一些最重要的问题是:

*   如果这些数据是你的呢？没人会知道是你。
*   这会与研究相关吗？

我知道这是医疗保健相关的数据，但事实是，它没有说任何人。它可以引导我们得出非常有趣的结论。医院利用过去的信息创造财富。某些特定日期最常见的进入原因。以及我们的年龄和生活方式对此有何影响。

除了货币价值之外，这些数据还可以极大地改善我们的生活，这已经不是什么秘密了。

# 来自区块链的公开数据

最近发现，汽油价格在午餐时间达到最高点。那不是很有趣吗？

在谈及尚未公开的数据之前，我想先谈谈区块链的公开数据。在这种情况下，来自以太坊生态系统的任何链。

让我给你介绍一下 **EIP 1767** ，旨在为以太坊事件定义一个 GraphQL 模式。在我写这篇文章的时候，你只能用一个 **JSON-RPC** ，用 **HTTP** 或 **WebSocket** 来查询数据。除了在 EIP 中描述的那个界面有一些问题之外，还有可能做得更好。

已经可以使用 [**网格**](https://github.com/ethereum/grid) 和 [**ethql**](https://github.com/ConsenSys/ethql) 执行一些 GraphQL 查询。在我看来，比这两个更好的是 [**TheGraph**](https://thegraph.com/) 。

虽然我最近才发现，但这个图表是两年前开始的。它的主要目标是“为分散的未来提供可扩展的查询”。该项目总体上很复杂，超出了我在本文中所能涵盖的范围。现在，我只想展示一下这个工具是如何工作的。

# 使用图进行查询

该图适用于已经部署在网络上的智能合同。在部署子图之前，它需要知道合同地址。索引数据是一个大问题，在每个项目中都需要花费大量时间来解决。使用这个图表，这个问题就解决了。

让我们假设您已经在网络中部署了一个项目。为了简化，我们假设你用的是 [TechHQ](http://techhq.io) 的[**simple-ether eum-dapp**](https://github.com/HQ20/simple-ethereum-dapp)**。**

**克隆这个存储库，并在 **SimpleStorage.sol** 文件中做一个小小的修改，这样它就可以发出一个事件，由图形进行处理。该图通过索引事件来工作，使得检索信息更快。**

**在 **storedData** 变量之前，用 **event SetX(uint256 x)定义一个事件；****

**然后在 set 函数上，用 **emit SetX(x)发出 **SetX** 事件；****

**要让一个工作的区块链环境向图提供事件，首先，安装依赖项(使用 **yarn** )，启动网络(运行 **yarn start:ganache:dev** )并部署已部署的契约(使用**npx truffle migrate-network development**)启动子图。**

**首先安装 graph-cli(通过做**yarn add @ graph protocol/graph-CLI**)并使用**npx graph init-from-contract 0x F2 dee 5975 a 808 f 16 f 93 BF 4 FD 55 ab 5481 A8 b 20497-网络开发**启动子图。当提示输入名称时，键入 **start/simple** ，目录可以是默认的 **simple** 。当被问及网络时，选择任何一个，使用本地网络没有任何区别。合同地址应该已经自动填写。如果找不到 ABI，就把地址放到 **SimpleStorage.json** 文件中(应该是**)。/build/contracts/simple storage . JSON**。**

**现在你已经有了一个名为 **simple** 的新文件夹，其中包含了图形代码。让我们看看新的文件夹和文件。**

*   ****abis** —包含合同文件 abis**
*   ****生成的** —不要碰它，它是使用所有其他文件自动生成的**
*   ****src** —包含支持 graphql 服务器的源代码**
*   ****schema.graphql** —定义 graphql 模式**
*   ****子图. yaml** —定义子图**

# **部署子图**

**子图就像一组指令，部署并链接到 URL。它允许您使用 graphql 查询一组合同的信息。**

**您可以将一个子图部署到一个托管服务中，但是有时从命令行本地完成更容易。**

**移动到生成的**简单**文件夹。**

**第一次，你需要创建子图(用 **yarn create-local** )。一旦成功，部署子图(使用**纱线部署-局部**)。**

**到最后一步结束时，如果成功的话，你应该得到一个类似于[http://localhost:8000/subgraphs/name/start/simple](http://localhost:8000/subgraphs/name/start/simple)的链接。点击这个链接，你将会看到一个**图形 1**网页。对于那些不熟悉 graphql 的人，我将带您浏览这个简单而有用的 UI。**

**首先，让我们获取所有已经完成的操作(为 x 设置不同的值)。**

**在 GraphiQL 中使用上面的代码，您将在响应中获得一个空数组。这是因为什么也没发生。但是如果你改变值几次，再查询一次，就会有一些数据显示出来。**

**移动到我们克隆的根文件夹(不在**简单**中)并使用下面的命令**

**如果您再次执行上面的查询，您将获得一些信息。您将只能看到最后一个结果，因为我们是根据发送它们的用户来索引操作的。您可以在**的 **src/mapings.ts** 处进行更改，让 entity = example entity . load(event . transaction . from . to hex())****

**要获得更多的事件，您可以将从改为 hash。然后，图将通过散列而不是用户地址来索引事务，保存所有事务。**

# **查询在过去 2 分钟内将 x 值更改为 5 到 9 之间的用户**

**这听起来像是一个复杂的挑战，但实际上，它非常简单。为了查询这个新数据，我们需要契约来发出它。**

**该事件现在发出改变值的用户，以及根据 *block.timestamp* 的时间戳；**

**然后，让我们将**子图. yaml** 中的事件处理程序更新为**

**因此，我们还需要更新 **schema.graphql** 以**

**和 **abis/Contract.json** 来**

**最后一步是更改 **src/mapping.ts** ，但是首先，我们需要新生成的代码。可以用**纱线编码**获得。**

**最后，将 **src/mappings.ts** 更新为**

**该图现在准备使用事务散列作为 *id* 来索引数据，并保存新的 *x* 值、改变该值的*帐户地址*和*时间戳*。**

**在执行新的查询之前，您必须部署新的契约并更新子图。记住 **subgraph.yaml** 包含契约地址。如果您部署合同，您很可能会获得一个新地址。因为您正在运行一个 ganache 实例(必须是由克隆的存储库提供的，使用 **yarn start:ganache:dev** )，所以您可以利用确定性属性。因此，如果您重新启动 ganache 并再次部署契约(参见上面的命令)，您将获得相同的地址。**

**所以，只要确保有正确的地址，再次部署子图(用 **yarn deploy-local** )。**

**如果您现在执行下面的查询(在 GraphiQL 中),您将获得想要的结果**

**您可以在[图形文档](https://thegraph.com/docs/graphql-api#queries)中找到有关查询的更多详细信息。**

# **结论**

**我们已经看到数据可以带给我们很多信息，有价值的信息。**

**如果到目前为止，很难获得任何类型的数据，并且花费很长时间，这些新工具表明我们可以做得更好。**

**数据科学家，人工智能和 ML 专家，如果你在附近，加入运动。你将获得惊人的机会获得大量开放的标准化干净数据。**

**在社交媒体上找到我，保持联系。**

**特别感谢[Alberto caada](https://www.linkedin.com/in/albertocuesta/)的点评。以及 [TechHQ](https://www.techhq.io/) 。**