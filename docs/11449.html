<html>
<head>
<title>Part 3.7 !! Pandas DataFrame to PostgreSQL using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第 3.7 部分！！使用 Python 将数据帧转换为 PostgreSQL</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/part-3-7-pandas-dataframe-to-postgresql-using-python-6590fda63f41?source=collection_archive---------15-----------------------#2020-12-03">https://medium.com/analytics-vidhya/part-3-7-pandas-dataframe-to-postgresql-using-python-6590fda63f41?source=collection_archive---------15-----------------------#2020-12-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="4df9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用 to_sql()(alchemy)将批量数据插入 PostgreSQL 数据库</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/a6756e2c58ff760661fff989a312fee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zVA2By9LEKvlPimXmN-gVQ.png"/></div></div></figure><h1 id="9c78" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">先决条件</h1><p id="0914" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated"><strong class="kd hj"> Python 3.8.3 : </strong> <a class="ae kx" href="https://www.anaconda.com/products/individual" rel="noopener ugc nofollow" target="_blank">蟒蛇下载链接</a></p><p id="5bea" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj">PostgreSQL 13:</strong>T6<strong class="kd hj">T8】下载链接</strong></p><p id="2efa" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj"> Psycopg2 : </strong>安装<strong class="kd hj"> Psycopg2 </strong>使用命令:<strong class="kd hj"> pip 安装 psycopg2 </strong></p><h1 id="1667" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">目标</h1><p id="cdeb" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">本文的主要目标是逐步学习<strong class="kd hj">到<em class="ld"> _sql() </em> </strong>方法的工作代码。</p><h1 id="68b7" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">第 1 步:准备或识别您的数据</h1><p id="2d84" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">首先，准备或确定要导入 PostgreSQL 数据库的 CSV 文件。例如，我们从 GitHub 加载虹膜数据。</p><pre class="iy iz ja jb fd le lf lg lh aw li bi"><span id="e3d8" class="lj jk hi lf b fi lk ll l lm ln">import os<br/><strong class="lf hj"><em class="ld"># import sys to get more detailed Python exception info</em></strong><br/>import sys<br/><strong class="lf hj"><em class="ld"># import the connect library for psycopg2</em></strong><br/>import psycopg2<br/><strong class="lf hj"><em class="ld"># import the error handling libraries for psycopg2</em></strong><br/>from psycopg2 import OperationalError, errorcodes, errors<br/>import psycopg2.extras as extras<br/>import pandas as pd<br/>from io import StringIO<br/>import numpy as np</span><span id="3a6d" class="lj jk hi lf b fi lo ll l lm ln"><strong class="lf hj"><em class="ld"># Loading data from github</em></strong><br/>irisData = pd.read_csv('<a class="ae kx" href="https://raw.githubusercontent.com/Muhd-Shahid/Learn-Python-Data-Access/main/iris.csv',index_col=False" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/Muhd-Shahid/Learn-Python-Data-Access/main/iris.csv',index_col=False</a>)<br/>irisData.head()</span></pre><h1 id="7e75" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">步骤 2:指定连接参数</h1><pre class="iy iz ja jb fd le lf lg lh aw li bi"><span id="f867" class="lj jk hi lf b fi lk ll l lm ln"><strong class="lf hj"># Note: please change your database, username &amp; password as per your own values<br/></strong>conn_params_dic = {<br/>    "host"      : "localhost",<br/>    "database"  : "irisdb",<br/>    "user"      : "postgres",<br/>    "password"  : "Passw0rd"<br/>}</span></pre><h1 id="6a14" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">第三步:支持功能</h1><pre class="iy iz ja jb fd le lf lg lh aw li bi"><span id="6702" class="lj jk hi lf b fi lk ll l lm ln"><strong class="lf hj"><em class="ld"># Define a function that handles and parses psycopg2 exceptions</em><br/>def show_psycopg2_exception(err):</strong><br/>    <strong class="lf hj"># get details about the exception</strong><br/>    err_type, err_obj, traceback = sys.exc_info()   <strong class="lf hj"> <br/>    # get the line number when exception occured</strong><br/>    line_n = traceback.tb_lineno    <br/>    <strong class="lf hj"># print the connect() error</strong><br/>    print ("\npsycopg2 ERROR:", err, "on line number:", line_n)<br/>    print ("psycopg2 traceback:", traceback, "-- type:", err_type) <br/>    <strong class="lf hj"># psycopg2 extensions.Diagnostics object attribute</strong><br/>    print ("\nextensions.Diagnostics:", err.diag)   <strong class="lf hj"> <br/>    # print the pgcode and pgerror exceptions</strong><br/>    print ("pgerror:", err.pgerror)<br/>    print ("pgcode:", err.pgcode, "\n")</span><span id="1c35" class="lj jk hi lf b fi lo ll l lm ln"><strong class="lf hj"><em class="ld"># Using alchemy method</em></strong><br/>connect_alchemy = "postgresql+psycopg2://%s:%s@%s/%s" % (<br/>    conn_params_dic['user'],<br/>    conn_params_dic['password'],<br/>    conn_params_dic['host'],<br/>    conn_params_dic['database']<br/>)<br/>def using_alchemy(df):<br/>    try:<br/>        engine = create_engine(connect_alchemy)<br/>        df.to_sql('irisAlchemy', con=engine, index=False, if_exists='append',chunksize = 1000)<br/>        print("Data inserted using to_sql()(sqlalchemy) done successfully...")<br/>    except OperationalError as err:<br/>        <strong class="lf hj"><em class="ld"># passing exception to function</em></strong><br/>        show_psycopg2_exception(err))</span></pre><h1 id="07ea" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">步骤 4:执行主要任务</h1><pre class="iy iz ja jb fd le lf lg lh aw li bi"><span id="6237" class="lj jk hi lf b fi lk ll l lm ln"><strong class="lf hj"><em class="ld"># Connect to the database</em></strong><br/>engine = create_engine(connect_alchemy)<br/><strong class="lf hj"><em class="ld"># Importing data using_alchemy method</em></strong><br/>using_alchemy(irisData)</span></pre><h1 id="0ed4" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">第五步:查询数据库，检查我们的工作</h1><p id="3325" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">让我们查询数据库，以确保我们插入的数据已被正确保存。</p><pre class="iy iz ja jb fd le lf lg lh aw li bi"><span id="5ca6" class="lj jk hi lf b fi lk ll l lm ln">iris_df = pd.read_sql_table("irisAlchemy",con=engine)<br/>iris_df.head()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es lp"><img src="../Images/8777b2e20e10258cb493eb9db4a0c3e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*yR2xVliJgPfnpoHfzoGxRg.png"/></div></figure><p id="13dc" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj">结论:</strong>我们的<strong class="kd hj">部分 3.7 </strong>到此结束。在本教程中，我们学习了如何使用<strong class="kd hj"> to_sql() </strong>方法将批量数据插入 PostgreSQL 数据库。</p><p id="28a5" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated">本文的所有代码都可以作为 GitHub    <em class="ld">上的<a class="ae kx" href="https://github.com/Muhd-Shahid/Learn-Python-Data-Access/tree/main/PostgreSQL" rel="noopener ugc nofollow" target="_blank"> <strong class="kd hj"> <em class="ld"> Jupyter 笔记本获得。</em></strong></a></em></p><blockquote class="lq lr ls"><p id="295f" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><strong class="kd hj">下一篇</strong> <a class="ae kx" href="https://shahid-dhn.medium.com/part-4-pandas-dataframe-to-postgresql-using-python-8ffdb0323c09" rel="noopener"> <strong class="kd hj">第四部分</strong> </a> <strong class="kd hj">:寻找使用 Python 将批量数据插入 PostgreSQL 的最快方法。</strong></p><p id="93e7" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><strong class="kd hj">以前的学习:</strong></p><p id="b975" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/pandas-dataframe-to-postgresql-using-python-part-1-93f928f6fac7" rel="noopener"> <strong class="kd hj">第一部分</strong> </a> <strong class="kd hj">:简介、连接&amp;数据库创建</strong></p><p id="ac9f" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/pandas-dataframe-to-postgresql-using-python-part-2-3ddb41f473bd" rel="noopener"> <strong class="kd hj">第二部分</strong> </a> <strong class="kd hj">使用 Python 在 PostgreSQL 数据库中创建表</strong></p><p id="9809" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/part-3-1-pandas-dataframe-to-postgresql-using-python-8a3e3da87ff1" rel="noopener"> <strong class="kd hj">第 3.1 部分</strong> </a> <strong class="kd hj">:使用 executemany()将批量数据插入 PostgreSQL 数据库</strong></p><p id="d5ce" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" rel="noopener" href="/analytics-vidhya/part-3-2-pandas-dataframe-to-postgresql-using-python-8dc0b0741226"> <strong class="kd hj">第 3.2 部分</strong> </a> <strong class="kd hj">:使用 execute_batch()将批量数据插入 PostgreSQL 数据库</strong></p><p id="33af" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/part-3-3-pandas-dataframe-to-postgresql-using-python-57e68fe39385" rel="noopener"> <strong class="kd hj">第 3.3 部分</strong> </a> <strong class="kd hj">:使用 Python </strong>将使用 execute_values()方法的批量数据插入 PostgreSQL 数据库</p><p id="c8d3" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/part-3-4-pandas-dataframe-to-postgresql-using-python-d94e644a332" rel="noopener"> <strong class="kd hj">第 3.4 部分</strong> </a> <strong class="kd hj">:使用 mogrify()将批量数据插入 PostgreSQL 数据库</strong></p><p id="f363" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/part-3-5-pandas-dataframe-to-postgresql-using-python-d3bc41fcf39" rel="noopener"> <strong class="kd hj">第 3.5 部分</strong> </a> <strong class="kd hj">:使用 copy_from()将批量数据插入 PostgreSQL 数据库</strong></p><p id="7ac3" class="kb kc ld kd b ke ky ij kg kh kz im kj lt la km kn lu lb kq kr lv lc ku kv kw hb bi translated"><a class="ae kx" rel="noopener" href="/analytics-vidhya/part-3-6-pandas-dataframe-to-postgresql-using-python-ec80cb33ca4a"> <strong class="kd hj">第三部分。</strong> </a> <strong class="kd hj"> 6:使用 copy_from()和 StringIO 将批量数据插入 PostgreSQL 数据库</strong></p></blockquote><p id="2eff" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated">保持乐观！！注意安全！！继续学习:))</p><p id="db47" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj">感谢您的阅读！！</strong></p></div></div>    
</body>
</html>