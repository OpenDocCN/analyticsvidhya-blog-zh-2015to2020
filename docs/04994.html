<html>
<head>
<title>1WorldSync’s API HMAC Authentication — A Python Sample</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">1WorldSync的API HMAC身份验证Python示例</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/1worldsyncs-api-hmac-authentication-a-python-sample-31c446b945ca?source=collection_archive---------15-----------------------#2020-04-07">https://medium.com/analytics-vidhya/1worldsyncs-api-hmac-authentication-a-python-sample-31c446b945ca?source=collection_archive---------15-----------------------#2020-04-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/6dc8a1adee3df5227ab17834b2b5c6e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*E6Lb5Whs_Z8-eJThpFj6jw.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">图表来源:<a class="ae iq" href="https://marketplace.api.1worldsync.com/api/doc/1WorldSync_Content1_API_HMAC_Guide_v1.2.pdf" rel="noopener ugc nofollow" target="_blank">1世界同步内容1 API HMAC指南</a></figcaption></figure><p id="c44a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">在本文中，我们将讨论如何使用哈希消息认证码(HMAC)正确地对1WorldSync的Content1 API进行身份验证，使用Python作为编码语言。</p><p id="8701" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">若要开始，您需要1WorldSync客户端id和客户端密码。为了获得客户端凭据，您必须是订阅的开发人员。有关如何订阅的更多信息，请参考Content1 API HMAC指南。</p><p id="e4f9" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">HMAC =哈希消息验证码。1WorldSync Content1 APIs利用HMAC认证来验证正在进行的调用。HMAC认证的过程包括构建一个<strong class="it hj"> <em class="jp">定制字符串</em> </strong>，需要使用一个秘密密钥对其进行散列，返回一个散列码。然后将哈希代码附加到请求URL的末尾，以验证身份验证。</p><p id="c3a6" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们将使用《Content1 API HMAC指南》中的示例重复验证步骤，但是使用Python而不是Java。</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="b1d2" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak"> Python包</strong></h1><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2a07" class="le jy hi la b fi lf lg l lh li">import hashlib<br/>import hmac<br/>import base64<br/>import urllib<br/>from datetime import datetime<br/>import requests as r</span></pre><h1 id="5b17" class="jx jy hi bd jz ka lj kc kd ke lk kg kh ki ll kk kl km lm ko kp kq ln ks kt ku bi translated">变量</h1><p id="ac2e" class="pw-post-body-paragraph ir is hi it b iu lo iw ix iy lp ja jb jc lq je jf jg lr ji jj jk ls jm jn jo hb bi translated">声明变量，例如API协议、域、路径和查询参数。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="df5d" class="le jy hi la b fi lf lg l lh li"><strong class="la hj">########## API Protocol, Domain, and Path ##########</strong></span><span id="73cc" class="le jy hi la b fi lt lg l lh li">protocol = 'https://'<br/>domain = 'marketplace.api.1worldsync.com'<br/>path = 'V2/products'</span><span id="66a2" class="le jy hi la b fi lt lg l lh li"><strong class="la hj">########## Query Parameters ##########</strong></span><span id="ece8" class="le jy hi la b fi lt lg l lh li"><strong class="la hj"># Required  Parameters #</strong></span><span id="8b5c" class="le jy hi la b fi lt lg l lh li">app_id = '9af172d4'             #client id         <br/>secretKey = 'XXXXX'             #client secret    <br/>searchType ='advancedSearch'    <br/>access_mdm ='computer' <br/>field = 'itemPrimaryId'         <br/>upc = '00007252147019'          <br/>query = "{}:{}".format(field, upc)</span><span id="f3f3" class="le jy hi la b fi lt lg l lh li"><strong class="la hj">"""<br/>Hard coded timestamp for sample. For real time authentication, use commented timestamp derived using datetime package.<br/>"""</strong><br/>       <br/>timestamp = '2015-10-19T09:58:37Z'  <br/>#timestamp = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ') </span><span id="56da" class="le jy hi la b fi lt lg l lh li"><strong class="la hj"># Optional Parameters #</strong></span><span id="7de3" class="le jy hi la b fi lt lg l lh li">geo_loc_access_latd = 9.91      # Latitude<br/>geo_loc_access_long = 51.51     # Longitude</span></pre><h1 id="604d" class="jx jy hi bd jz ka lj kc kd ke lk kg kh ki ll kk kl km lm ko kp kq ln ks kt ku bi translated">哈希代码</h1><p id="03c1" class="pw-post-body-paragraph ir is hi it b iu lo iw ix iy lp ja jb jc lq je jf jg lr ji jj jk ls jm jn jo hb bi translated"><strong class="it hj"> <em class="jp">第一步:构建自定义字符串哈希</em> </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="cd3a" class="le jy hi la b fi lf lg l lh li">string_to_hash = "/{}?app_id={}&amp;searchType={}&amp;query={}&amp;access_mdm={}&amp;TIMESTAMP={}&amp;geo_loc_access_latd={}&amp;geo_loc_access_long={}".format(path, app_id, searchType, query, access_mdm, timestamp, geo_loc_access_latd,geo_loc_access_long)</span></pre><p id="c349" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">参数在字符串中的组织顺序也非常重要，因为如果顺序改变，生成的哈希代码会有所不同。要确定变量的顺序，请参考在线Content1产品搜索API工具的产品部分中参数的出现顺序。</p><p id="37a2" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">链接:<a class="ae iq" href="https://marketplace.api.1worldsync.com/api/V2/" rel="noopener ugc nofollow" target="_blank">https://marketplace.api.1worldsync.com/api/V2/</a></p><p id="a219" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">要查看产品搜索API工具，请单击“产品”标题旁边的“展开操作”。</p><p id="4d96" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj"> <em class="jp">第二步:哈希字符串&amp;返回哈希码</em> </strong></p><p id="d6d0" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">为了散列，被散列的数据和用于散列的密钥必须被转换成字节。使用的散列算法是安全散列算法256 (SHA-256)。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="aa2c" class="le jy hi la b fi lf lg l lh li"><strong class="la hj"># Hashing Custom String #</strong></span><span id="e2ee" class="le jy hi la b fi lt lg l lh li">message = bytes(string_to_hash, 'utf-8') #data bytes<br/>secret = bytes(secretKey, 'utf-8') #key bytes<br/>hash = hmac.new(secret, message, hashlib.sha256)</span><span id="0059" class="le jy hi la b fi lt lg l lh li"><strong class="la hj"># Retrieving Hash Code #</strong></span><span id="e201" class="le jy hi la b fi lt lg l lh li">hash_code = base64.b64encode(hash.digest())<br/>urlencoded_hash = urllib.parse.quote(hash_code).replace('/','%2F')</span></pre><p id="c22c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">结果，创建了一个包含哈希代码的HMAC对象，这是API请求中所需要的。HMAC对象中的散列码被称为<em class="jp">摘要</em>。此外，根据Content1指南，哈希代码必须经过Base 64编码和URL编码。</p><p id="d359" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><em class="jp">注意:urllib包在url编码时不会将“/”转换为其各自的十六进制表示形式，“%2F”。因此，转换是通过替换操作强制进行的。</em></p><p id="f7a8" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj">哈希码:</strong><em class="jp">dl3r5G % 2 fkswfqw3fxykjx 92 fahsindfjmn 4 fakjqhip 0% 3D</em></p><h1 id="224b" class="jx jy hi bd jz ka lj kc kd ke lk kg kh ki ll kk kl km lm ko kp kq ln ks kt ku bi translated">API获取请求</h1><p id="287d" class="pw-post-body-paragraph ir is hi it b iu lo iw ix iy lp ja jb jc lq je jf jg lr ji jj jk ls jm jn jo hb bi translated"><strong class="it hj"> <em class="jp">第一步:构建请求URL </em> </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="bdd1" class="le jy hi la b fi lf lg l lh li">requestURL= "{}/{}/{}?app_id={}&amp;searchType={}&amp;query={}&amp;access_mdm={}&amp;TIMESTAMP={}&amp;geo_loc_access_latd={}&amp;geo_loc_access_long={}&amp;hash_code={}".format(protocol, domain, path , app_id, searchType, urllib.parse.quote(query), access_mdm, urllib.parse.quote(timestamp), geo_loc_access_latd,geo_loc_access_long,urlencoded_hash)<br/></span></pre><p id="6eee" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><em class="jp">注意:查询和时间戳参数是在请求URL中编码的URL。为了安全起见，URL对任何包含特殊字符或空格的参数进行编码。</em></p><p id="c519" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">在这个阶段，当向<a class="ae iq" href="https://marketplace.api.1worldsync.com/api/V2/" rel="noopener ugc nofollow" target="_blank"> Content1 API在线工具</a>提供相同的参数时，来自Python的请求URL可以通过与返回的请求URL进行比较来验证。</p><p id="f206" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj"> <em class="jp">第二步:发出获取请求</em> </strong></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="9065" class="le jy hi la b fi lf lg l lh li"><strong class="la hj"># Making the GET Request #<br/></strong>response = r.get(requestURL)</span></pre></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="0a05" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">Cryptii</h1><p id="aaa8" class="pw-post-body-paragraph ir is hi it b iu lo iw ix iy lp ja jb jc lq je jf jg lr ji jj jk ls jm jn jo hb bi translated"><em class="jp"> Crptii </em>是一款开源的在线编码和加密工具。这个工具可以用来测试和调试哈希加密。在下面的图表中，解释了对自定义字符串进行哈希处理并为我们正在处理的示例返回正确格式化的哈希代码的流程。</p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/b185acafffbf8c96e666697b67a9eff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/format:webp/1*Vhe39sUEGm7LSEfbAzHfcg.png"/></div></figure><p id="e6bd" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><em class="jp"> HMAC密钥:58 58 58 58 58(十六进制)= XXXXX(字符)，示例中使用的密钥。</em></p><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/daa05be9ff756df0778a17a2b12a67bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*VYP3YfqRBcX5CE0zA4iepQ.png"/></div></figure><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es lw"><img src="../Images/c05b6d92df4eb8c639d5886997016c66.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*f0FqZ-uCgBTSpXJug6kUAw.png"/></div></figure></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><h1 id="389d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">链接</strong></h1><ol class=""><li id="1724" class="lx ly hi it b iu lo iy lp jc lz jg ma jk mb jo mc md me mf bi translated"><a class="ae iq" href="https://marketplace.api.1worldsync.com/api/doc/1WorldSync_Content1_API_HMAC_Guide_v1.2.pdf" rel="noopener ugc nofollow" target="_blank">内容1 API HMAC指南</a></li><li id="e33e" class="lx ly hi it b iu mg iy mh jc mi jg mj jk mk jo mc md me mf bi translated"><a class="ae iq" href="https://marketplace.api.1worldsync.com/api/doc/1WorldSync_Content1_Product_Search_API_Guide_v3.1.6.7.pdf" rel="noopener ugc nofollow" target="_blank">内容1产品搜索API指南</a></li></ol></div></div>    
</body>
</html>