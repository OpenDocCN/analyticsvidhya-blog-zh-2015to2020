<html>
<head>
<title>Deploying Machine Learning models with OpenFaas [with Warm Start]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenFaas部署机器学习模型[使用热启动]</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-machine-learning-models-with-openfaas-857f1ba0e9c2?source=collection_archive---------2-----------------------#2019-08-16">https://medium.com/analytics-vidhya/deploying-machine-learning-models-with-openfaas-857f1ba0e9c2?source=collection_archive---------2-----------------------#2019-08-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/e2d9c7c90316e2d1adbd06942af83030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OSnRV1NElE34IH_cWWAXAg.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="0de7" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">使用Docker Swarm或Kubernetes在几分钟内部署无服务器机器学习模型。</h2></div><p id="78af" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">有各种行业标准的工具可用于模型部署，但是，对于这个博客，我们将坚持使用OpenFaas。我很想听听关于OpenFaas的意见</p><p id="a316" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">以下是我试图用OpenFaas解决的问题:</p><ol class=""><li id="7ea3" class="ke kf ht jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated">版本控制——当它在<code class="du kn ko kp kq b">Kubernete</code>或<code class="du kn ko kp kq b">Docker</code>上工作时，它为版本控制提供了一个健壮的框架</li><li id="6d76" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">独立于包——因为每个模型都有自己的基本docker文件，所以您不需要编写通用的docker命令层，它可以根据模型的不同进行修改。因此提供了代码重用并加速了模型部署。在当今的数据科学领域，数据科学家拥有不同的技能来训练模型。例如，我可以用<code class="du kn ko kp kq b">PyTorch</code>训练一个模型，而另一个数据科学家可以用不同的<code class="du kn ko kp kq b">numpy</code>和<code class="du kn ko kp kq b">pandas</code>版本的<code class="du kn ko kp kq b">Tensorflow</code>训练一个模型，在软件工程团队最少的支持下支持快速的模型部署。</li><li id="b695" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">可扩展— Kubernetes和Docker Swarm有助于扩展。</li><li id="b07b" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">热启动—当模型大到每次预测都要加载到内存中时，这就变得很麻烦。使用OpenFaas，您可以在系统启动时将模型加载到内存中，并使用<code class="du kn ko kp kq b">curl</code>命令来查询模型。</li><li id="ec74" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">多模型部署——当有大量模型，并且您一次训练所有模型时，使用OpenFaas，您只需一个命令就可以部署所有模型。</li><li id="b15d" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">没有单点故障—每个模型都是相互独立的，一个模型故障不会影响其他模型。</li><li id="5eef" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">Grafana仪表板—现成的监控服务。</li></ol><p id="2353" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">按照这个博客的结构:</strong></p><ol class=""><li id="71f7" class="ke kf ht jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated">安装OpenFaas</li><li id="181f" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">构建房价模型环境</li><li id="2334" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">列车张量流模型</li><li id="dd12" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">部署张量流模型</li><li id="d253" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">使用用户界面进行预测</li><li id="d917" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">使用旋度进行预测</li></ol><p id="102b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">**以上所有步骤都是在我本地机器的MAC OS上执行的。将它扩展到云资源应该相当简单</p><ol class=""><li id="a642" class="ke kf ht jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><strong class="jk hu">安装OpenFaas </strong></li></ol><p id="7072" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">学习openfaas的最佳途径是:<a class="ae kw" href="https://github.com/openfaas/workshop" rel="noopener ugc nofollow" target="_blank">https://github.com/openfaas/workshop</a></p><p id="08a8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">有两种方法可以设置openfaas，要么是<code class="du kn ko kp kq b">Kubernetes</code>要么是<code class="du kn ko kp kq b">Docker</code>。为了简单起见，我们将坚持使用<code class="du kn ko kp kq b">Docker</code></p><p id="a2fb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">要求:</p><ol class=""><li id="30d1" class="ke kf ht jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated">Docker CE Mac OS</li><li id="41fb" class="ke kf ht jk b jl kr jo ks jr kt jv ku jz kv kd kj kk kl km bi translated">Docker Hub帐户[如果您想在另一个系统上使用Docker映像]</li></ol><p id="4bfb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第一步:安装OpenFaas CLI </em> </strong></p><p id="b745" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">OpenFaas CLI用于使用OpenFaas创建、构建和部署docker映像。打开终端并执行以下操作</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="e766" class="lg lh ht kq b fi li lj l lk ll">curl -sL cli.openfaas.com | sudo sh</span></pre><p id="01c0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">通过执行以下操作测试CLI</p><p id="97b2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">faas-cli -version</code></p><p id="c8e7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">预期产出:</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lm"><img src="../Images/96ee761ebcea242297b946bc26e2f5db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2kOyDCj72d55UNiipjwbaQ.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">OpenFaas CLI版本检查</figcaption></figure><p id="76c9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第二步:克隆OpenFaas </em> </strong></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="5052" class="lg lh ht kq b fi li lj l lk ll">git clone https://github.com/openfaas/faas</span></pre><p id="e42f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第三步:初始化Docker Swarm </em> </strong></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="3400" class="lg lh ht kq b fi li lj l lk ll">docker swarm init</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lr"><img src="../Images/403d7bec86f448ec9571bb7702ff7c45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uQcBcAPvpEVSRgkGgbXLTg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">Docker群初始化输出</figcaption></figure><p id="a44a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第四步:部署默认堆栈</em> </strong></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="9001" class="lg lh ht kq b fi li lj l lk ll">./deploy_stack.sh</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ls"><img src="../Images/b4d52f5a6246d659ed85612e8881df86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ea3h-Iy1qqrHIN0IKWObnw.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">OpenFaas默认堆栈部署</figcaption></figure><blockquote class="lt lu lv"><p id="2fe2" class="ji jj kx jk b jl jm iu jn jo jp ix jq lw js jt ju lx jw jx jy ly ka kb kc kd hb bi translated">确保你记录了密码。这是我们第一次部署堆栈时显示。</p></blockquote><p id="24ff" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第五步:登录openfaas服务</em> </strong></p><p id="0cdc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">faas-cli login --password aa 353768bbda945980755258381fe7181fedc902da412e116b743ca796c71de3</code></p><blockquote class="lt lu lv"><p id="2a86" class="ji jj kx jk b jl jm iu jn jo jp ix jq lw js jt ju lx jw jx jy ly ka kb kc kd hb bi translated"><em class="ht">确保您输入了上述步骤中的密码</em></p></blockquote><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lz"><img src="../Images/fe976d45ea420df9026fd2d9f6fcb4d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-tmQt33SEacEaY_uf0cO-w.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">faas cli登录服务</figcaption></figure><p id="80b8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在您可以打开浏览器，导航到<a class="ae kw" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8080 </a>，输入<code class="du kn ko kp kq b">username</code> = <code class="du kn ko kp kq b">admin</code>，密码与上一步相同。您应该能够看到以下页面:</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ma"><img src="../Images/53c24172a66ddbdf6b5b12613e1de929.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yx-VjYodoKP41lnjJnchdA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">部署后打开Faas第一页</figcaption></figure><p id="56dd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第六步:查看可用服务</em> </strong></p><p id="67de" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">docker service ls</code></p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mb"><img src="../Images/097f541096dac3cf57cde44d8e7e3a8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9k1VflXvlgYScMwZSv0aJA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">OpenFaas默认服务</figcaption></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="83fa" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> 2。构建房价模型环境</strong></p><p id="8a3e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第一步:创建预测服务目录</em> </strong></p><p id="b23e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">因为我们已经安装了openfaas，所以我们可以在文件系统的任何地方构建模型。我将在<code class="du kn ko kp kq b">faas</code>目录外创建一个名为<code class="du kn ko kp kq b">prediction_service</code>的目录</p><p id="2025" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">mkdir prediction_service</code></p><p id="db59" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">ls -latr</code></p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mj"><img src="../Images/029083fd3d3db40470880118b28b4d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5XFFueMdmKiQZsOL4gHT9g.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">预测服务目录</figcaption></figure><p id="c85b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第二步:下载预定义的语言模板</em> </strong></p><p id="04e1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">OpenFaas提供了不同语言的基本模板。我们可以使用它们或者定义我们自己。首先，让我们下载那些模板</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="1a3f" class="lg lh ht kq b fi li lj l lk ll">faas-cli template pull<br/>faas-cli new --list</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mk"><img src="../Images/79165c9effd97e3597cb13a880becd4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WKGwCxCFQi1s-LI8COxDBA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">OpenFaas默认模板</figcaption></figure><p id="98a6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">每种语言都包含自己的Docker文件，Template.yml，requirements.txt，index.py。</p><p id="bc8c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第三步:修改Python docker文件以满足我们的tensorflow需求</em> </strong></p><p id="5eac" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将以下内容复制并粘贴到DockerFile文件中</p><p id="4649" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">template/python/Dockerfile</code></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="85c6" class="lg lh ht kq b fi li lj l lk ll">FROM openfaas/classic-watchdog:0.13.4 as watchdog</span><span id="9e8f" class="lg lh ht kq b fi ml lj l lk ll">FROM ubuntu:16.04</span><span id="3403" class="lg lh ht kq b fi ml lj l lk ll">RUN apt-get -q update -y &amp;&amp; \<br/> apt-get -q install -y \<br/> apt-transport-https \<br/> apt-utils \<br/> build-essential \<br/> cron \<br/> curl \<br/> dsyslog \<br/> g++ \<br/> git \<br/> gcc \<br/> language-pack-id \<br/> libcairo2-dev \<br/> libexpat1 \<br/> libffi-dev \<br/> libssl-dev \<br/> libx11-dev \<br/> libxml2-dev \<br/> libxslt1-dev \<br/> libxss1 \<br/> nano \<br/> netcat \<br/> pango1.0-tests \<br/> psmisc \<br/> python \<br/> python-pip \<br/> python-dev \<br/> python-setuptools \<br/> ssl-cert \<br/> vim \<br/> zlib1g \<br/> zlib1g-dev</span><span id="c702" class="lg lh ht kq b fi ml lj l lk ll"># Allows you to add additional packages via build-arg<br/>ARG ADDITIONAL_PACKAGE</span><span id="af57" class="lg lh ht kq b fi ml lj l lk ll">COPY — from=watchdog /fwatchdog /usr/bin/fwatchdog<br/>RUN chmod +x /usr/bin/fwatchdog</span><span id="e433" class="lg lh ht kq b fi ml lj l lk ll"># Add non root user</span><span id="ac7e" class="lg lh ht kq b fi ml lj l lk ll">WORKDIR /home/app/</span><span id="c656" class="lg lh ht kq b fi ml lj l lk ll">COPY index.py .<br/>COPY requirements.txt .</span><span id="5d08" class="lg lh ht kq b fi ml lj l lk ll">ENV PATH=$PATH:/home/app/.local/bin:/home/app/python/bin/<br/>ENV PYTHONPATH=$PYTHONPATH:/home/app/python:/home/app/function</span><span id="859d" class="lg lh ht kq b fi ml lj l lk ll">RUN pip install -r requirements.txt</span><span id="38de" class="lg lh ht kq b fi ml lj l lk ll">RUN mkdir -p function<br/>RUN touch ./function/__init__.py</span><span id="c8f1" class="lg lh ht kq b fi ml lj l lk ll">WORKDIR /home/app/function/<br/>COPY function/requirements.txt .</span><span id="bb58" class="lg lh ht kq b fi ml lj l lk ll">RUN pip install -r requirements.txt</span><span id="b265" class="lg lh ht kq b fi ml lj l lk ll">WORKDIR /home/app/</span><span id="8bd4" class="lg lh ht kq b fi ml lj l lk ll">COPY function function</span><span id="fb39" class="lg lh ht kq b fi ml lj l lk ll">ENV fprocess=”python index.py”<br/>EXPOSE 8080</span><span id="1aec" class="lg lh ht kq b fi ml lj l lk ll">HEALTHCHECK — interval=3s CMD [ -e /tmp/.lock ] || exit 1</span><span id="e1ab" class="lg lh ht kq b fi ml lj l lk ll">CMD [“fwatchdog”]</span></pre><p id="45b8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">** <em class="kx">您可能不需要添加上述所有依赖项，但我还是做了，作为POC的一部分</em></p><p id="1fbd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">不下载模板我们也能做到，我太懒了！！！</p><p id="0872" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第四步:新建房价模型函数</em> </strong></p><p id="7d9a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">因为我们在这个练习中使用的是python 2.7，所以我将使用与我们操作<code class="du kn ko kp kq b">Dockerfile</code>相同的<code class="du kn ko kp kq b">python</code></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="c763" class="lg lh ht kq b fi li lj l lk ll">faas-cli new --lang python house-price-model</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mm"><img src="../Images/caa2f9dacff2be6c92fd74f641ea76fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Spvivlx6cTy8nIDWEDcYbg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">房价模型函数[环境]</figcaption></figure><p id="b765" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们刚刚用python目录中定义的<code class="du kn ko kp kq b">base</code>docker文件创建了一个函数。现在<code class="du kn ko kp kq b">house-price-model</code>有了自己的<code class="du kn ko kp kq b">house-price-model/handler/requirements.txt</code>和<code class="du kn ko kp kq b">house-price-model.yml</code>。所以你可以想象当我们有多个模型时，我们有多个这样的模型。</p><p id="5c98" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第五步:安装Tensorflow等依赖</em> </strong></p><p id="cb58" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">由于Tensorflow有PyPi包，我们可以用<code class="du kn ko kp kq b">pip</code>安装它们，因此将它们放在<code class="du kn ko kp kq b">house-price-model/handler/requirements.txt</code>中是有意义的。</p><p id="01fb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将以下内容复制到<code class="du kn ko kp kq b">house-price-model/handler/requirements.txt</code></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="012d" class="lg lh ht kq b fi li lj l lk ll">h5py==2.9.0 # Tensorflow dependency for large-scale computing using numpy<br/>numpy==1.16.3<br/>pandas==0.22.0<br/>tensorflow==1.14.0<br/>scipy==0.14.1<br/>dill==0.2.7.1<br/>scikit-learn==0.18.1</span></pre><p id="5362" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第六步:构建函数</em> </strong></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="a9e9" class="lg lh ht kq b fi li lj l lk ll">faas-cli build -f ./<!-- -->house-price-model<!-- -->.yml</span></pre><p id="b098" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这将建立一个码头工人的形象</p><p id="bf3b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第七步:部署到OpenFaas服务</em> </strong></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="8280" class="lg lh ht kq b fi li lj l lk ll">faas-cli deploy -f ./<!-- -->house-price-model<!-- -->.yml</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mn"><img src="../Images/137b268aebde2ca56592a3927423e338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vLMLJw4YPp3TsrYq7mOeGw.png"/></div></div></figure><p id="7eec" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">由于我们是在本地做这件事，我不会把它推到Docker hub并立即部署。这将创建一个新函数，您可以在<a class="ae kw" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8080 </a>查看它</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mo"><img src="../Images/7e5832fb66b048662172db8f79c0fbb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rn7ItcWux8wyUxE9zu6Qjw.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">OpenFaas中部署的新功能[房价模型]</figcaption></figure><p id="7797" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">阅读仪表板相当容易。注意，左上角提到的<code class="du kn ko kp kq b">Status</code>应该一直是<code class="du kn ko kp kq b">Ready</code>模式。<code class="du kn ko kp kq b">python index.py</code>是作为要调用的函数的入口点的文件。</p><p id="fafc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">步骤8:用随机数发生器</em> </strong>测试函数</p><p id="2542" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">让我们看看这是如何工作的，以及它是否真的达到了预期的效果。</p><p id="147a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">打开<code class="du kn ko kp kq b">house-price-model/handler.py</code>并粘贴以下内容:</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="6676" class="lg lh ht kq b fi li lj l lk ll">import numpy as np</span><span id="03db" class="lg lh ht kq b fi ml lj l lk ll">def handle(req):<br/>    """handle a request to the function<br/>    Args:<br/>        req (str): request body<br/>    """</span><span id="2f20" class="lg lh ht kq b fi ml lj l lk ll">    return {"Price" : np.random.randint(100000,500000,size=1)}</span></pre><p id="02a6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这将产生10万到50万之间的<code class="du kn ko kp kq b">random</code>价格。</p><p id="a743" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在重新构建并重新部署该功能。</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="6a60" class="lg lh ht kq b fi li lj l lk ll">faas-cli build -f ./house-price-model.yml<br/>faas-cli deploy -f ./house-price-model.yml</span></pre><p id="639d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在打开<a class="ae kw" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8080 </a>，确认<code class="du kn ko kp kq b">Status</code>处于<code class="du kn ko kp kq b">ready</code>状态。</p><p id="c3c9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">单击Invoke，您应该会看到一个输出</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/4e0906c5324706c2a8de4459cb7fe975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ysfUcEp76rFSemAzr8pCBA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">测试模型的输出</figcaption></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="63dc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> 3。训练一个张量流模型</strong></p><p id="4034" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第一步:生成假数据</em> </strong></p><p id="61fb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在<code class="du kn ko kp kq b">house-price-model/</code>内的<code class="du kn ko kp kq b">fake_data.py</code>内创建一个文件，并粘贴以下内容</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="f5f8" class="lg lh ht kq b fi li lj l lk ll">import numpy as np<br/>import pandas as pd</span><span id="64ac" class="lg lh ht kq b fi ml lj l lk ll">N = 4000<br/>sqft = np.random.randint(300,3000,size=N)<br/>garden_area = np.random.randint(300,8000,size=N)<br/>white_noise = np.random.normal(loc=0.,scale=1.,size=N)<br/>price = 40*sqft + \<br/>  60*garden_area + \<br/>  white_noise/10.</span><span id="8ddc" class="lg lh ht kq b fi ml lj l lk ll">data = pd.DataFrame({"price" : price, "sqft" : sqft, "garden_area" : garden_area})<br/>print data.describe()</span><span id="d237" class="lg lh ht kq b fi ml lj l lk ll">train = data.sample(frac=0.8)<br/>test = data[~data.index.isin(train.index)]</span><span id="55be" class="lg lh ht kq b fi ml lj l lk ll">train.to_csv("train.csv")<br/>test.to_csv("test.csv")</span></pre><p id="0459" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">python fake_data.py</code>将创建训练和测试数据</p><p id="b4bc" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第二步:用Tensorflow </em> </strong>训练模型</p><p id="571f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在<code class="du kn ko kp kq b">house-price-model</code>目录下创建一个新文件<code class="du kn ko kp kq b">train.py</code></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="4cb6" class="lg lh ht kq b fi li lj l lk ll">touch train.py</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mq"><img src="../Images/37ddc28dfe1be2c4c8b5f229af299356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M-udhklW0tB5bB5_eG7WdQ.png"/></div></div></figure><p id="db8a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">并将以下内容复制到文件中</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="6118" class="lg lh ht kq b fi li lj l lk ll">import os<br/>import pandas as pd<br/>import pickle as pkl<br/>import numpy as np<br/>import tensorflow as tf<br/>from tensorflow import keras<br/>from tensorflow.keras import layers<br/>from sklearn.preprocessing import StandardScaler<br/>from sklearn.pipeline import Pipeline<br/>from sklearn.feature_extraction import DictVectorizer</span><span id="116e" class="lg lh ht kq b fi ml lj l lk ll">train = pd.read_csv("train.csv")<br/>y_train = np.log(train.pop("price"))<br/>test = pd.read_csv("test.csv")<br/>y_test = np.log(test.pop("price"))</span><span id="9053" class="lg lh ht kq b fi ml lj l lk ll">f_ex = Pipeline([('dict vectorizer', DictVectorizer(sparse=False)),<br/>                  ('std scaler', StandardScaler())])</span><span id="af3d" class="lg lh ht kq b fi ml lj l lk ll">f_ex = f_ex.fit(train.to_dict(orient="row"))<br/>normed_train_data = f_ex.transform(train.to_dict(orient="row"))<br/>normed_test_data = f_ex.transform(test.to_dict(orient="row"))</span><span id="227a" class="lg lh ht kq b fi ml lj l lk ll">def build_model():<br/>  model = keras.Sequential([<br/>    layers.Dense(30, activation=tf.nn.relu, input_shape=[len(train.keys())]),<br/>    layers.Dense(20, activation=tf.nn.relu),<br/>    layers.Dense(1)<br/>  ])</span><span id="92c2" class="lg lh ht kq b fi ml lj l lk ll">optimizer = tf.keras.optimizers.RMSprop(0.001)</span><span id="eff8" class="lg lh ht kq b fi ml lj l lk ll">model.compile(loss='mean_squared_error',<br/>                optimizer=optimizer,<br/>                metrics=['mean_absolute_error', 'mean_squared_error'])<br/>  return model</span><span id="90d1" class="lg lh ht kq b fi ml lj l lk ll">model = build_model()</span><span id="160c" class="lg lh ht kq b fi ml lj l lk ll"># Display training progress by printing a single dot for each completed epoch<br/>class PrintDot(keras.callbacks.Callback):<br/>  def on_epoch_end(self, epoch, logs):<br/>    if epoch % 50 == 0:<br/>      print("Epoch: {}\tMSE: {}\tMAE: {}".format(epoch, logs["mean_squared_error"], logs["mean_absolute_error"]))</span><span id="da5e" class="lg lh ht kq b fi ml lj l lk ll">EPOCHS = 500<br/>model = build_model()</span><span id="c090" class="lg lh ht kq b fi ml lj l lk ll"># The patience parameter is the amount of epochs to check for improvement<br/>early_stop = keras.callbacks.EarlyStopping(monitor='val_loss', patience=100)</span><span id="2936" class="lg lh ht kq b fi ml lj l lk ll">history = model.fit(normed_train_data, y_train, epochs=EPOCHS,<br/>                    validation_split = 0.2, verbose=0, callbacks=[PrintDot()])</span><span id="2f79" class="lg lh ht kq b fi ml lj l lk ll">loss, mae, mse = model.evaluate(normed_test_data, y_test, verbose=0)</span><span id="a11a" class="lg lh ht kq b fi ml lj l lk ll">print("Test MSE: {}, MAE: {}, LOSS: {}".format(mse, mae, loss))<br/>print model.summary()</span><span id="4e82" class="lg lh ht kq b fi ml lj l lk ll">if not os.path.exists('model'):<br/>    os.makedirs('model')<br/>model.save('model/model.model')<br/>pkl.dump(f_ex, open('model/model.f_ex',"w"))</span></pre><p id="b4c6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><code class="du kn ko kp kq b">python train.py</code></p><p id="888c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这将训练一个模型来估计原木房价，并将模型保存到磁盘。</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mr"><img src="../Images/b5af70f5a9ca4a6e8073e553b0f2a127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0pBgK1dE8dIEKy_NjR_mHg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">使用Tensorflow训练模型并保存到磁盘</figcaption></figure><p id="34a0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在我们需要用这个模型进行预测。</p><p id="ff4c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> 4。部署型号</strong></p><p id="ce83" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第一步:用模型</em> </strong>建立图像</p><p id="109d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们将建立一个模型的形象。对于版本控制，我们将在<code class="du kn ko kp kq b">house-price-model.yml</code>中按型号版本设置标签，并设置</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="f491" class="lg lh ht kq b fi li lj l lk ll">image: house-price-model:rel-0.0.1</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div class="er es ms"><img src="../Images/33f7e9912ca34675cc31bea0a3896130.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*dIRo0YUJAqJkUUiOf2RsIQ.png"/></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">通过图像标记模型</figcaption></figure><p id="d48b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第二步:将模型连接到handler.py进行预测</em> </strong></p><p id="d51c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">因为我们有了模型，所以我们将在handler.py中编写一个函数来加载模型并进行预测。一个处理程序接受JSON字符串类型的<code class="du kn ko kp kq b">req</code>。让我们继续使用String，将其转换为JSON并传递给模型。</p><p id="f2a8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将以下内容复制粘贴到<code class="du kn ko kp kq b">house-price-model</code>内一个名为<code class="du kn ko kp kq b">models_loader.py</code>的新文件中</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mt"><img src="../Images/370f25fd56b28d0f0a0d1a33f264cc7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ymD2AwdjbxkXlb2EbzgSw.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">model_loaders.py</figcaption></figure><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="95c6" class="lg lh ht kq b fi li lj l lk ll">import numpy as np<br/>import pickle as pkl<br/>from tensorflow import keras</span><span id="fdb2" class="lg lh ht kq b fi ml lj l lk ll">model = keras.models.load_model('/home/app/function/model/model.model')<br/>f_ex = pkl.load(open('/home/app/function/model/model.f_ex'))</span></pre><p id="51dd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这将在启动时加载TF模型。</p><p id="14e2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在将以下内容复制粘贴到<code class="du kn ko kp kq b">handler.py</code>中</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="feaa" class="lg lh ht kq b fi li lj l lk ll">import models_loader<br/>import numpy as np<br/>import json</span><span id="f60c" class="lg lh ht kq b fi ml lj l lk ll">def handle(req):<br/>    """handle a request to the function<br/>    Args:<br/>        req (str): request body<br/>    """<br/>    transform_data = models_loader.f_ex.transform(json.loads(req))<br/>    return {"median_price" : float(np.exp(models_loader.model.predict(transform_data))[0][0])}</span></pre><p id="01c2" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">使用以下命令构建和部署容器</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="50e3" class="lg lh ht kq b fi li lj l lk ll">faas-cli build -f ./house-price-model.yml<br/>faas-cli deploy -f ./house-price-model.yml</span></pre><p id="43f3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx">第三步:从UI中查询模型</em> </strong></p><p id="f74a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">导航到<a class="ae kw" href="http://127.0.0.1:8080/ui/" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8080/ui/</a></p><p id="d90e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们想对房价进行预测</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="ed03" class="lg lh ht kq b fi li lj l lk ll">{“sqft”:1000,”garden_area”:1000}</span></pre><p id="6d8b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">点击文本，进入上面的字典。<code class="du kn ko kp kq b">handler.py</code>将字符串转换成字典。你也可以在UI里面提到字典，但是String在我们需要做<code class="du kn ko kp kq b">curl</code>的时候很有用</p><p id="b235" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您应该会看到类似这样的内容</p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mu"><img src="../Images/f05d099de57e4f9fdf152866eb621507.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZWnqsC4FoNmhiItcfeLlDA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">预测功能的第一次调用</figcaption></figure><p id="c92c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果你看到，这是非常缓慢的，大约需要2秒钟。这是预期的行为。函数即服务在每次函数调用时加载模型，因此缺少<code class="du kn ko kp kq b">WARM</code>开始。我们将使用python客户机-服务器编程对此进行调整。</p><p id="b57b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们将把<code class="du kn ko kp kq b">handler.py</code>作为客户端，把<code class="du kn ko kp kq b">models_loader.py</code>作为服务器</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="c1a9" class="lg lh ht kq b fi li lj l lk ll">touch run.sh</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mv"><img src="../Images/0779ac37c1f6a5463060181b1175362b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8WYmPwcNJQ_RfGIicLGTAA.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">创建run.sh</figcaption></figure><p id="963d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将以下内容复制到run.sh中</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="53a9" class="lg lh ht kq b fi li lj l lk ll">#!/bin/bash</span><span id="b7a1" class="lg lh ht kq b fi ml lj l lk ll">python /home/app/function/models_loader.py &amp;<br/>fwatchdog</span></pre><p id="4e23" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将以下内容复制到<code class="du kn ko kp kq b">models_loader.py</code></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="7a29" class="lg lh ht kq b fi li lj l lk ll">import numpy as np<br/>import pickle as pkl<br/>from tensorflow import keras<br/>import socket<br/>import json</span><span id="6059" class="lg lh ht kq b fi ml lj l lk ll">model = keras.models.load_model('/home/app/function/model/model.model')<br/>f_ex = pkl.load(open('/home/app/function/model/model.f_ex'))</span><span id="1830" class="lg lh ht kq b fi ml lj l lk ll">def predict(data):<br/> transform_data = f_ex.transform(data)<br/> return {"median_price" : float(np.exp(model.predict(transform_data))[0][0])}</span><span id="679a" class="lg lh ht kq b fi ml lj l lk ll">server = socket.socket()<br/>port = 12345<br/>server.bind(('', port))<br/>server.listen(5)<br/>while True:<br/>   client, addr = server.accept()<br/>   client.send(json.dumps(predict(json.loads(client.recv(1024)))))<br/>   client.close()</span></pre><p id="b5e5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">将以下内容复制到<code class="du kn ko kp kq b">handler.py</code></p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="e08d" class="lg lh ht kq b fi li lj l lk ll">import socket</span><span id="033d" class="lg lh ht kq b fi ml lj l lk ll">client = socket.socket()<br/>port = 12345<br/>client.connect(('', port))</span><span id="7d73" class="lg lh ht kq b fi ml lj l lk ll">def handle(req):<br/>    """handle a request to the function<br/>    Args:<br/>        req (str):<br/>        request body<br/>    """<br/>    client.send(req)<br/>    return client.recv(1024)</span></pre><p id="25dd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在将下面两行复制到位于<code class="du kn ko kp kq b">house-price-model</code>外部和<code class="du kn ko kp kq b">template/python/Dockerfile</code>内部的DockerFile的末尾</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="70fa" class="lg lh ht kq b fi li lj l lk ll">RUN chmod +x /home/app/function/run.sh<br/>CMD ["/bin/bash", "/home/app/function/run.sh"]</span></pre><p id="f0ed" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在重新构建并重新部署该功能</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="53c4" class="lg lh ht kq b fi li lj l lk ll">faas-cli build -f house-price-model.yml<br/>faas-cli deploy -f house-price-model.yml</span></pre></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="f20a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx"> 5。用UI </em>预测T3</strong></p><p id="0fcd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">重复<strong class="jk hu">步骤4.3<em class="kx">。</em> </strong> <em class="kx">现在预测正在飞速进行！！！</em></p><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mw"><img src="../Images/51a64449e7959292733a524978b17966.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CYk-_XI3qyHOcPS7HnwKXg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">用户界面中的快速预测</figcaption></figure></div><div class="ab cl mc md gp me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="hb hc hd he hf"><p id="69e6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu"> <em class="kx"> 6。带旋度的预测</em> </strong></p><p id="42ad" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在您的终端中执行以下代码行:</p><pre class="ky kz la lb fd lc kq ld le aw lf bi"><span id="4228" class="lg lh ht kq b fi li lj l lk ll">curl -X POST -H "Content-Type: application/json"  -d '{"sqft":100, "garden_area":100}'  http://127.0.0.1:8080/function/house-price-model</span></pre><figure class="ky kz la lb fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mx"><img src="../Images/14fb280d4fa0b5a7f0a3d18a2d3280a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dVH65nYQuOYJnRCaH94VUg.png"/></div></div><figcaption class="ln lo et er es lp lq bd b be z dx translated">卷曲输出</figcaption></figure><p id="dd79" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">结论:</strong></p><p id="811e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">上述方法还可以做很多改进，但作为概念验证，这是将模型生产为微服务的最快方法。我很想听听关于这个应用程序的想法和意见。</p><p id="00b0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">上述代码可在:<br/><a class="ae kw" href="https://github.com/dwipam/MLAAS" rel="noopener ugc nofollow" target="_blank">https://github.com/dwipam/MLAAS</a>找到</p><p id="fbe1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">Kuberflow的博客文章即将发布！！</p><p id="1150" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated"><strong class="jk hu">参考文献:</strong></p><div class="hh hi ez fb hj my"><a href="https://www.tensorflow.org/tutorials/keras/basic_regression" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab dw"><div class="na ab nb cl cj nc"><h2 class="bd hu fi z dy nd ea eb ne ed ef hs bi translated">回归:预测燃油效率|张量流核心|张量流</h2><div class="nf l"><h3 class="bd b fi z dy nd ea eb ne ed ef dx translated">面向移动和嵌入式设备的TensorFlow Lite</h3></div><div class="ng l"><p class="bd b fp z dy nd ea eb ne ed ef dx translated">www.tensorflow.org</p></div></div></div></a></div><div class="hh hi ez fb hj my"><a href="https://www.tensorflow.org/beta/guide/keras/saving_and_serializing" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab dw"><div class="na ab nb cl cj nc"><h2 class="bd hu fi z dy nd ea eb ne ed ef hs bi translated">使用TensorFlow Keras保存和序列化模型| TensorFlow Core | TensorFlow</h2><div class="nf l"><h3 class="bd b fi z dy nd ea eb ne ed ef dx translated">本指南的第一部分介绍了顺序模型和使用构建的模型的保存和序列化</h3></div><div class="ng l"><p class="bd b fp z dy nd ea eb ne ed ef dx translated">www.tensorflow.org</p></div></div></div></a></div><div class="hh hi ez fb hj my"><a href="https://github.com/openfaas/workshop" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab dw"><div class="na ab nb cl cj nc"><h2 class="bd hu fi z dy nd ea eb ne ed ef hs bi translated">openfaas/workshop</h2><div class="nf l"><h3 class="bd b fi z dy nd ea eb ne ed ef dx translated">这是一个自定进度的研讨会，学习如何使用OpenFaaS构建、部署和运行无服务器功能。在这个…</h3></div><div class="ng l"><p class="bd b fp z dy nd ea eb ne ed ef dx translated">github.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm hp my"/></div></div></a></div></div></div>    
</body>
</html>