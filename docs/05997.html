<html>
<head>
<title>Running R/RStudio in a GCP VM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP虚拟机中运行R/RStudio</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/running-r-rstudio-in-a-gcp-vm-21a8458ef086?source=collection_archive---------3-----------------------#2020-05-08">https://medium.com/analytics-vidhya/running-r-rstudio-in-a-gcp-vm-21a8458ef086?source=collection_archive---------3-----------------------#2020-05-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/6742bdbac41227da3bde29150b306c2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*GaEaAqEzAnYY_TYnHMc6pg.png"/></div></figure><p id="75d5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行大型计算密集型R脚本通常是一个非常缓慢的过程；我们如何升级到更强大的服务器，同时保持低成本？</p><p id="175b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">谷歌云平台(GCP)允许我们使用<a class="ae jk" href="https://cloud.google.com/compute/docs/machine-types" rel="noopener ugc nofollow" target="_blank">各种配置</a>的虚拟机(VM ),并且只为我们使用的东西付费。这种定价结构使得以相对低廉的价格运行大型密集型脚本变得可行。如果你的工作流程是容错的，那么<a class="ae jk" href="https://cloud.google.com/preemptible-vms" rel="noopener ugc nofollow" target="_blank">可抢占机器</a>可以大大降低你的总支出。</p><p id="991d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">出于本文的目的，我将使用一台n1-standard-16机器(16个vCPUs和60 GB内存)，配置一个Debian GNU/Linux 9 (stretch)磁盘映像和可抢占性。这台机器的成本是每小时0.161美元——我的特定任务平均每周运行3小时，每月总计约2美元。<em class="jl">确保在使用虚拟机后将其关闭，因为保持开启会增加该数量。</em></p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jm"><img src="../Images/49d58be82af64f627584ac904cd473ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UWtfWmbNOZXADBVsc09xnA.png"/></div></div></figure><p id="3df3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jl">注意:当然，对于可抢占的机器，总是存在实例在您使用时终止的风险。我个人从未遇到过这种情况，但这总是有风险的。和往常一样，如果您的工作流不是容错的，那么不推荐使用可抢占的机器。</em></p><p id="15a1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">步骤1:配置虚拟机和防火墙规则</strong></p><p id="356c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是用于创建我的特定配置的gcloud命令(注意，我添加了一个http-server标记)。</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="8650" class="ka kb hi jw b fi kc kd l ke kf">gcloud compute instances create task2r-vm --zone=us-west1-b --machine-type=n1-standard-16 --image=debian-9-stretch-v20200420 --image-project=debian-cloud --preemptible --scopes=https://www.googleapis.com/auth/cloud-platform --tags=http-server,https-server</span></pre><p id="3f5a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，让我们配置我们的防火墙规则(在VPC网络&gt;防火墙规则下)，以允许我们访问端口8787，我们将需要使用我们的RStudio GUI。防火墙规则应该使用IP-ranges: 0.0.0.0/0和端口tcp:8787，并应用于tag: http-server(以便它连接到我们的VM)。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kg"><img src="../Images/4672d87dd0f42eaf22dc2321424c4d70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fwAVI3lMFFr0utxFKQkkUg.png"/></div></div></figure><p id="8e9c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦这两个步骤完成，我们就可以通过控制台或命令行SSH到我们的虚拟机。</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="3184" class="ka kb hi jw b fi kc kd l ke kf">gcloud compute ssh task2r-vm --zone=us-west1-b</span></pre><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kh"><img src="../Images/bfc1b1e6fe24949530994f8c54094a84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*J20RTq5kbmufG8K4LcFW0Q.gif"/></div></div></figure><p id="e736" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">第二步:</strong></p><p id="1084" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">成功登录我们的服务器后，让我们安装相关的软件包:</p><p id="5276" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一如既往，从以下内容开始:</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="f2e6" class="ka kb hi jw b fi kc kd l ke kf">sudo apt-get update</span></pre><p id="d013" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，运行这两个命令(第一个<a class="ae jk" href="https://packages.debian.org/sid/admin/gdebi-core" rel="noopener ugc nofollow" target="_blank">将允许我们安装deb文件，而第二个将安装R)。</a></p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="b8f8" class="ka kb hi jw b fi kc kd l ke kf">sudo apt -y install gdebi-core</span><span id="e0b1" class="ka kb hi jw b fi ki kd l ke kf">sudo apt -y install r-base r-base-dev</span></pre><p id="e535" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此外，如果需要使用tidyverse，还需要运行以下命令:</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="37d9" class="ka kb hi jw b fi kc kd l ke kf">sudo apt-get install libcurl4-openssl-dev libssl-dev libxml2-dev</span></pre><p id="e847" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦安装了这些依赖项，确保可以在您的虚拟机中访问R:</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="7f22" class="ka kb hi jw b fi kc kd l ke kf">sudo R</span></pre><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kj"><img src="../Images/168d86377620b3df53f084d0185880db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*rtKeELE_XhKb0F9X4h3URQ.gif"/></div></div></figure><p id="8deb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">第三步:安装RStudio服务器</strong></p><p id="9677" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在R可以工作了，让我们也安装RStudio(从技术上讲，这不是一个必需的步骤，因为我们可以在没有RStudio的情况下运行R脚本)。</p><p id="0a24" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">RStudio的<a class="ae jk" href="https://rstudio.com/products/rstudio/download-commercial/debian-ubuntu/" rel="noopener ugc nofollow" target="_blank">文档</a>让这部分变得非常简单。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kk"><img src="../Images/2515927f18ba42862a7a141386d7074a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0BOifFWEVw1UJKzF8kbleQ.png"/></div></div></figure><p id="c09a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们可以运行上面的第二个和第三个命令(我们已经运行了第一个命令):</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="47be" class="ka kb hi jw b fi kc kd l ke kf">wget https://download2.rstudio.org/server/debian9/x86_64/rstudio-server-1.2.5042-amd64.deb</span><span id="2fbd" class="ka kb hi jw b fi ki kd l ke kf">sudo gdebi rstudio-server-1.2.5042-amd64.deb</span></pre><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kj"><img src="../Images/8e6610a82f239c9e8dceb06df0743769.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*KZz5GJZYQOhHfiw7habKow.gif"/></div></div></figure><p id="12f5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这两个命令成功运行之后，我们会收到一个确认消息，告知RStudio已经启动。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kl"><img src="../Images/6edaefdc9efd899386e3b5ee78509272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDi2OywOYzc-wj69pjchUw.png"/></div></div></figure><p id="fa51" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了直观地确认这种情况，导航到您的虚拟机的<strong class="io hj">外部IP </strong>，指定端口号8787。这应该类似于&lt;外部IP &gt; :8787。回想一下，tcp:8787是我们在防火墙规则中指定的端口(步骤1)。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es km"><img src="../Images/6e090cea30815b21d749579db6da073e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lYRbh1Gfocqa5MZUEwL8yA.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">查找实例的外部IP</figcaption></figure><p id="8bbf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当您导航到该URL时，您将看到“/auth-sign-in”字符串附加在8787端口号之后。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kr"><img src="../Images/dd38e7fad18eae1f703947d9702c97f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bKEM8Tsl8KcLfPtk7U6OtQ.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">访问<external ip=""> :8787</external></figcaption></figure><p id="4262" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">回到shell中，我们需要将自己添加为新用户。为此，我们使用以下命令(用您喜欢的用户名替换<stefang>):</stefang></p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="63c1" class="ka kb hi jw b fi kc kd l ke kf">sudo adduser stefang</span></pre><p id="6df3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行此程序后，返回RStudio登录页面并使用您的新凭据:</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kj"><img src="../Images/7b6cbbba4e3e76d32c5ea6a0fe776c5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*HDVfQWAgXJgeL9nF5u0x3Q.gif"/></div></div></figure><p id="73dc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">太好了！我们已经有了RStudio。现在让我们通过Github引入我们的代码(我个人喜欢在我的本地计算机上编写我的所有代码——当我的VM关闭时——然后如果有任何更改，将代码推送到VM来运行它)。</p><p id="be3c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这样做之前，我们需要在shell中安装git(下面的第二行不是必需的，但是允许登录之间有更长的“超时”)。</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="0703" class="ka kb hi jw b fi kc kd l ke kf">sudo apt-get install git-core -y</span><span id="c365" class="ka kb hi jw b fi ki kd l ke kf">git config --global credential.helper "cache --timeout 28800"</span></pre><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es ks"><img src="../Images/904a768e1f3d1823dc7a45b2d415b9d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-tQy3dJbfjqVXTdc_r5PZA.gif"/></div></div></figure><p id="c339" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">重启RStudio后，我们现在可以通过克隆git存储库来创建一个新项目。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es kt"><img src="../Images/f31e089e74906b5b5bd8b751833083e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o6G8LmQtZV1alnwrYMuXng.png"/></div></div></figure><p id="8193" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">关于目录</strong>:如果您想在VM shell中访问您的存储库，您需要更改用户，从您的默认用户更改为您用上面的“sudo adduser &lt; username &gt;命令创建的用户。</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="c262" class="ka kb hi jw b fi kc kd l ke kf">cd /home<br/>cd stefang/</span></pre><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es ks"><img src="../Images/301eff6e2443295926ce804065c7357a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9ufYVOlXyJfELAQyvfe4aw.gif"/></div></div></figure><p id="4554" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">从这个新目录，我们可以通过shell访问我们所有的文件(包括脚本的任何输出)。</p><p id="0f6a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">最后一个提示:</strong></p><p id="6e7b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我想完全自动化这个过程，这样，除非我有新的代码要推送，否则脚本可以在我不需要SSH到实例的情况下运行。</p><p id="3aca" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这项任务需要几个步骤，我将简要总结如下:</p><p id="0129" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，我设置了<a class="ae jk" href="http://console.cloud.google.com/cloudscheduler" rel="noopener ugc nofollow" target="_blank">云调度器</a>来在每周的特定时间启动/停止我的实例。云调度程序允许我们限制虚拟机的使用，保持低成本并减少任何能源浪费。设置此功能的<a class="ae jk" href="http://sudo apt-get install libcurl4-openssl-dev libssl-dev libxml2-dev" rel="noopener ugc nofollow" target="_blank">完整流程</a>还涉及云功能和发布/订阅。</p><p id="515f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">其次，我创建了一个bash脚本，它将更改当前目录，挂载一个GCS bucket，并将我的脚本的输出文件(几个CSV和一个HTML map文件)上传到bucket。</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="7753" class="ka kb hi jw b fi kc kd l ke kf">#!/bin/bash</span><span id="c128" class="ka kb hi jw b fi ki kd l ke kf">cd /home<br/>cd stefang/</span><span id="ba32" class="ka kb hi jw b fi ki kd l ke kf">gcsfuse --implicit-dirs &lt;project-name-bucket&gt; gcs-bucket/</span><span id="533f" class="ka kb hi jw b fi ki kd l ke kf">sudo mv &lt;project-name&gt;/output/ gcs-bucket/</span><span id="829d" class="ka kb hi jw b fi ki kd l ke kf">#unmount GCS bucket<br/>fusermount -u gcs-bucket</span></pre><p id="3be5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第三，我将<a class="ae jk" href="https://linux4one.com/how-to-set-up-cron-job-on-debian-9/" rel="noopener ugc nofollow" target="_blank"> Crontab </a>配置为在每周四下午1:50运行脚本，在下午6:00运行bash脚本(这给了我足够的时间，以防报告花费更长时间)。</p><pre class="jn jo jp jq fd jv jw jx jy aw jz bi"><span id="f079" class="ka kb hi jw b fi kc kd l ke kf">50 13 * * 4 cd /home/stefang/&lt;project-name&gt; &amp;&amp; /usr/bin/Rscript -e "rmarkdown::render('&lt;script-name&gt;')"</span><span id="7ba5" class="ka kb hi jw b fi ki kd l ke kf">00 18 * * 4 cd /home/stefang/&lt;project-name&gt; &amp;&amp; /usr/bin/bash write_to_bucket.sh</span></pre><p id="f5ed" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi">— — —</p><p id="151e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">原来如此！感谢您的阅读，欢迎在下面留下任何评论/问题。</p></div></div>    
</body>
</html>