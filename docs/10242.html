<html>
<head>
<title>Celebrity recognition using VGGFace and Annoy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用VGGFace和Annoy进行名人识别</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/celebrity-recognition-using-vggface-and-annoy-363c5df31f1e?source=collection_archive---------14-----------------------#2020-10-10">https://medium.com/analytics-vidhya/celebrity-recognition-using-vggface-and-annoy-363c5df31f1e?source=collection_archive---------14-----------------------#2020-10-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><figure class="in io ip iq fd ir er es paragraph-image"><div class="er es im"><img src="../Images/d179d94f38c132b18eac00a244591ce7.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*UpMQojVTKIeEYp3ioKQwwQ.png"/></div></figure><p id="a6e5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是一个关于如何创建一个使用人脸匹配算法识别名人的模型的指南。</p><p id="f19f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">本文包括以下主题:</p><ol class=""><li id="ccfc" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">使用库和创建自己的模型的指南。</li><li id="0144" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">为存储库发布pip包。</li></ol><p id="b4da" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">请参考<a class="ae kg" href="https://celeb-recognition.readthedocs.io/en/main/" rel="noopener ugc nofollow" target="_blank">本</a>获取详细文件。</p><p id="5155" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">本文中提到的所有代码都可以在我的GitHub资源库中找到。</p><div class="kh ki ez fb kj kk"><a href="https://github.com/shobhit9618/celeb_recognition" rel="noopener  ugc nofollow" target="_blank"><div class="kl ab dw"><div class="km ab kn cl cj ko"><h2 class="bd hj fi z dy kp ea eb kq ed ef hh bi translated">shobhit9618/celeb_recognition</h2><div class="kr l"><h3 class="bd b fi z dy kp ea eb kq ed ef dx translated">使用人脸匹配算法识别名人的模型。该模型基于60张照片的约6000个数据集</h3></div><div class="ks l"><p class="bd b fp z dy kp ea eb kq ed ef dx translated">github.com</p></div></div><div class="kt l"><div class="ku l kv kw kx kt ky is kk"/></div></div></a></div><h1 id="091d" class="kz la hi bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">模型的基本工作</h1><p id="4405" class="pw-post-body-paragraph iu iv hi iw b ix lx iz ja jb ly jd je jf lz jh ji jj ma jl jm jn mb jp jq jr hb bi translated">该模型的基本算法包括以下内容:</p><ol class=""><li id="133d" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">人脸检测模型(目前我正在使用MTCNN)是用来寻找图像中的人脸。</li></ol><p id="f1e2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">2.裁剪后的人脸被发送到一个名为<a class="ae kg" href="https://github.com/rcmalli/keras-vggface" rel="noopener ugc nofollow" target="_blank"> VGGFace </a>的模型。该模型以大小为2048的数组的形式为面部提供编码。</p><p id="6b60" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">3.编码通过一个名为<a class="ae kg" href="https://github.com/spotify/annoy" rel="noopener ugc nofollow" target="_blank">的库来存储和索引。这用于找到与需要检测的面部最接近的匹配。</a></p><p id="9835" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，为了训练你自己的名人模型，你需要提供一个你需要认识的名人的数据集。使用Google images、DuckDuckGo、Bing等网站可以轻松收集数据。这些数据必须安排在一个适当的文件夹结构中，每个名人有一个单独的文件夹。模特的名字取自文件夹名(所以确保文件夹名中没有空格或特殊字符)。尽可能多地提供名人照片。随着更多数据的加入，该模型将不断改进。</p><p id="2976" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，你只需要提供文件夹的路径，该文件夹中存储了所有名人的照片。使用代码的细节将在下一节中显示。</p><p id="ab9f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">模型创建完成后，我们需要进行预测。在预测过程中，每幅图像都要经历相同的过程，人脸检测和编码创建。面部的编码是使用所创建的烦恼指数模型来搜索的，这给了我们最接近的匹配面部。annoy库提供了尽可能多的最接近的匹配，我们可以只使用最接近的匹配进行预测。但是为了减少错误检测，增加了一个简单的技巧。我们找到10个最接近的匹配，如果3个或更多的匹配属于同一个名人，那么结果被考虑，否则它被丢弃。</p><h1 id="9e38" class="kz la hi bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">使用图书馆</h1><p id="8b0a" class="pw-post-body-paragraph iu iv hi iw b ix lx iz ja jb ly jd je jf lz jh ji jj ma jl jm jn mb jp jq jr hb bi translated">有几种方法可以使用该库:</p><ol class=""><li id="4857" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">Python代码文件</li></ol><p id="cd4a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">首先将库克隆到您的本地系统。使用requirements.txt文件安装依赖项:</p><pre class="in io ip iq fd mc md me mf aw mg bi"><span id="1e50" class="mh la hi md b fi mi mj l mk ml">git clone <a class="ae kg" href="https://github.com/shobhit9618/celeb_recognition.git" rel="noopener ugc nofollow" target="_blank">https://github.com/shobhit9618/celeb_recognition.git</a><br/>cd celeb_recognition<br/>pip install -r requirements.txt</span></pre><p id="d9e5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，要创建自己的模型，只需打开<code class="du mm mn mo md b">create_celeb_model.py</code>文件，提供名人图片的根文件夹路径，然后运行该文件。这将启动模型创建过程，并存储3种文件:用于存储每个名人图像(在训练期间生成)到名人姓名的映射的celeb_mapping.json，用于存储索引和快速搜索的编码的celeb_index.ann，用于存储为每个名人生成的编码的celeb_name_encoding.pkl文件。您可以在celeb_utils文件夹内的<code class="du mm mn mo md b">create_celeb_utils.py</code>文件中提供存储这些文件的路径。</p><p id="427b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了进行预测，请在celeb_utils文件夹的<code class="du mm mn mo md b">celeb_utils.py</code>文件中提供celeb_mapping.json和celeb_index.ann文件的路径。然后，在<code class="du mm mn mo md b">celeb_recognition.py</code>文件中提供图像文件的路径或图像URL，并运行它。这将提供图像中的预测和检测到的面部。您还可以选择将带有边界框的输出图像存储到本地系统。</p><figure class="in io ip iq fd ir er es paragraph-image"><div class="er es im"><img src="../Images/b497c224b5f10684ea43b55dd528556d.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*7qL5ewZEvs4kaZP0XRfGjg.png"/></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">对巴拉克·奥巴马形象的预测</figcaption></figure><p id="8f25" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">2.Pip包</p><p id="fe8e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我的pip包可以在这里找到。</p><div class="kh ki ez fb kj kk"><a href="https://badge.fury.io/py/celeb-detector" rel="noopener  ugc nofollow" target="_blank"><div class="kl ab dw"><div class="km ab kn cl cj ko"><h2 class="bd hj fi z dy kp ea eb kq ed ef hh bi translated">名人探测器</h2><div class="kr l"><h3 class="bd b fi z dy kp ea eb kq ed ef dx translated">使用人脸匹配算法识别名人的模型。该模型基于60张照片的约6000个数据集</h3></div><div class="ks l"><p class="bd b fp z dy kp ea eb kq ed ef dx translated">badge.fury.io</p></div></div><div class="kt l"><div class="mt l kv kw kx kt ky is kk"/></div></div></a></div><p id="b20a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">要安装pip包，请运行:</p><pre class="in io ip iq fd mc md me mf aw mg bi"><span id="da02" class="mh la hi md b fi mi mj l mk ml"># pip release version<br/>pip install celeb-detector<br/># also install additional dependencies with this (if not installed via requirements.txt file)<br/>pip install annoy keras-vggface keras-applications<br/># Directly from repo<br/>pip install git+https://github.com/shobhit9618/celeb_recognition.git</span></pre><p id="d7fb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果您在Linux或Ubuntu上使用conda，您可以使用以下命令创建并使用一个名为celeb-detector的新环境(这将安装所有必需的依赖项):</p><pre class="in io ip iq fd mc md me mf aw mg bi"><span id="3d48" class="mh la hi md b fi mi mj l mk ml">conda env create shobhit9618/celeb-detector<br/>conda activate celeb-detector</span></pre><p id="ccf9" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">要使用我的模型进行预测，请在安装后使用以下代码行:</p><pre class="in io ip iq fd mc md me mf aw mg bi"><span id="69e9" class="mh la hi md b fi mi mj l mk ml">import celeb_detector # on running for the first time, this will download vggface model<br/>img_path = 'sample_image.jpg'<br/>celeb_detector.celeb_recognition(img_path) # on running for the first time, 2 files (celeb_mapping.json and celeb_index_60.ann) will downloaded to the home directory</span><span id="3c32" class="mh la hi md b fi mu mj l mk ml"># if you want to use an image url, just provide the url and add url=True<br/>url = 'https://sample/sample_image_url.jpg'<br/>celeb_detector.celeb_recognition(url, url=True)</span></pre><p id="8b58" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这将返回一个字典列表，每个字典包含bbox坐标，名人姓名和图像中检测到的每个人脸的置信度(如果没有检测到匹配的人脸，名人姓名将是未知的)。</p><p id="698a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了使用您自己的定制模型，还需要提供json和ann文件的路径，如下所示:</p><pre class="in io ip iq fd mc md me mf aw mg bi"><span id="306a" class="mh la hi md b fi mi mj l mk ml">import celeb_detector<br/>img_path = 'sample_image.jpg'<br/>ann_path = 'sample_index.ann'<br/>celeb_map = 'sample_mapping.json'<br/>celeb_detector.celeb_recognition(img_path, ann_path, celeb_map)</span></pre><p id="c68c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">用于创建您自己的模型，如下运行:</p><pre class="in io ip iq fd mc md me mf aw mg bi"><span id="cce3" class="mh la hi md b fi mi mj l mk ml">import celeb_detector<br/>folder path = 'celeb_images'<br/>celeb_detector.create_celeb_model(folder path)</span></pre><p id="4720" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">3.Jupyter笔记本</p><ul class=""><li id="78e2" class="js jt hi iw b ix iy jb jc jf ju jj jv jn jw jr mv jy jz ka bi translated">在<code class="du mm mn mo md b">celeb_recognition.ipynb</code>文件中提供<code class="du mm mn mo md b">celeb_mapping.json</code>和<code class="du mm mn mo md b">celeb_index.ann</code>文件的路径。如果你想试试我的模型，忽略这一步。</li><li id="1316" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mv jy jz ka bi translated">运行<code class="du mm mn mo md b">celeb_recognition.ipynb </code>文件中的所有单元格，最后一个单元格将提供上传图像和进行预测的小部件(这也将下载必要的模型文件)。</li><li id="2e67" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mv jy jz ka bi translated">注意:<code class="du mm mn mo md b">celeb_recognition.ipynb</code>是一个独立的文件，运行时不需要repo中的任何其他文件。</li><li id="ec66" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mv jy jz ka bi translated">您也可以在<a class="ae kg" href="https://colab.research.google.com/github/shobhit9618/celeb_recognition/blob/main/celeb_recognition.ipynb" rel="noopener ugc nofollow" target="_blank"> google colab </a>中打开并使用该文件。只需取消第一个单元的注释，并运行它来安装所有的需求。</li><li id="dc5c" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mv jy jz ka bi translated">您也可以点击<a class="ae kg" href="https://mybinder.org/v2/gh/shobhit9618/celeb_recognition/main" rel="noopener ugc nofollow" target="_blank">这里</a>运行活页夹应用程序。</li><li id="8701" class="js jt hi iw b ix kb jb kc jf kd jj ke jn kf jr mv jy jz ka bi translated">你也可以点击<a class="ae kg" href="https://mybinder.org/v2/gh/shobhit9618/celeb_recognition/main?urlpath=%2Fvoila%2Frender%2Fceleb_recognition.ipynb" rel="noopener ugc nofollow" target="_blank">这里</a>，启动一个活页夹应用程序(它只有图片上传和名人预测的插件)。</li></ul><h1 id="05cd" class="kz la hi bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">发布存储库的pip包</h1><p id="bb0e" class="pw-post-body-paragraph iu iv hi iw b ix lx iz ja jb ly jd je jf lz jh ji jj ma jl jm jn mb jp jq jr hb bi translated">如果您的代码是干净的，并且是使用适当的函数和类构建的，那么制作您自己的pip包会非常容易。</p><p id="5a66" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">创建pip包的一般指南可以在以下官方文档中找到:</p><div class="kh ki ez fb kj kk"><a href="https://packaging.python.org/tutorials/packaging-projects/" rel="noopener  ugc nofollow" target="_blank"><div class="kl ab dw"><div class="km ab kn cl cj ko"><h2 class="bd hj fi z dy kp ea eb kq ed ef hh bi translated">打包Python项目——Python打包用户指南</h2><div class="kr l"><h3 class="bd b fi z dy kp ea eb kq ed ef dx translated">本教程将带您了解如何打包一个简单的Python项目。它将向您展示如何添加必要的文件…</h3></div><div class="ks l"><p class="bd b fp z dy kp ea eb kq ed ef dx translated">packaging.python.org</p></div></div></div></a></div><p id="6b6e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">基本要求是创建一个许可证文件、setup.py文件和一个文件夹，该文件夹应包含pip包中包含的所有代码。</p><p id="1170" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Python setuptools包可以直接找到所有需要包含在pip包中的函数。您还需要在PyPI站点上创建一个帐户，并获得您的令牌来发布这个包。</p><p id="81e0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在我的例子中，我添加了一个名为celeb-detector的文件夹(这是我的pip包的名称)。该文件夹包含一些文件，这些文件包含获取图像预测和创建模型的功能。</p><p id="382c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一旦安装并导入了pip包，您就可以使用这些函数来获得预测或创建您自己的模型。</p></div></div>    
</body>
</html>