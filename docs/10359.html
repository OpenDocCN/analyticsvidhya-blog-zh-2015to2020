<html>
<head>
<title>Building a 3D Map in R — Covid Density in the US by Income</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在美国按收入构建 R-Covid 密度的 3D 地图</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/building-a-3d-map-in-r-covid-density-in-the-us-by-income-fab409544fcb?source=collection_archive---------8-----------------------#2020-10-15">https://medium.com/analytics-vidhya/building-a-3d-map-in-r-covid-density-in-the-us-by-income-fab409544fcb?source=collection_archive---------8-----------------------#2020-10-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a90b1408ddb4bc1edfdfee9fe8792d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*uHGY4ACXUjeTYxQv8kEGYQ.gif"/></div></div></figure><p id="a948" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们正处于数据可视化和数据的黄金时代！有如此多的信息可用，但它需要时间和精力来理解它。在我看来，哪里适用映射可以是最好的方式<em class="jo">“查看”</em>数据。这里有一个在 R 中制作 3D 地图的方法，使用 rayshader 给一个简单的散点图以高度，该散点图覆盖在背景地图的 png 上。这是根据 Carrie Lo 的精彩教程改编的，可以在<a class="ae jp" href="https://towardsdatascience.com/introducing-3d-ggplots-with-rayshader-r-c61e27c6f0e9" rel="noopener" target="_blank">这里</a>找到。请在<a class="ae jp" href="https://twitter.com/KyleBenzle" rel="noopener ugc nofollow" target="_blank">推特</a>上提出任何改进或想法，谢谢。</p><h1 id="6772" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">很多图书馆</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="d16a" class="kx jr hi kt b fi ky kz l la lb"># Lots of libraries</span><span id="07d0" class="kx jr hi kt b fi lc kz l la lb">library(sp)<br/>library(choroplethrMaps)<br/>library(tidyverse)<br/>library(tidyverse)<br/>library(rgl)<br/>library(rayshader)<br/>library(png)<br/>library(ggplot2)<br/>library(grid)<br/>library(mapproj)<br/>library(av)</span></pre><h1 id="f1d4" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">加载并预处理第一个数据集</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="095d" class="kx jr hi kt b fi ky kz l la lb"># Preprocess 1st data set</span><span id="a369" class="kx jr hi kt b fi lc kz l la lb">income = read.csv('income.csv', stringsAsFactors = F)<br/>income2017 &lt;- income[-c(3:36)]<br/>income2017$X2017 = as.integer(gsub(',', '', income2017$X2017))<br/>colNames = c('region', 'value')<br/>colnames(income2017) &lt;- colNames<br/>map_outline = data(state.map)<br/>income2017$region = tolower(income2017$region)<br/>income2017 &lt;- income2017 %&gt;%  mutate(., region = replace(region, region=='d.c.', 'district of columbia') )<br/>joinedData &lt;- left_join(state.map, income2017, by = 'region')<br/>keep = c(1,2,3,6,10,13)<br/>joinedData &lt;- joinedData[, keep]<br/>map_data = joinedData<br/>map_data$value = as.numeric(map_data$value)<br/>map_data &lt;- map_data %&gt;% arrange(., order)<br/>map_data &lt;- map_data %&gt;% filter(., region != 'alaska')<br/>map_data &lt;- map_data %&gt;% filter(., region != 'hawaii')</span></pre><h1 id="cbe3" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">地图</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="3399" class="kx jr hi kt b fi ky kz l la lb"># Map</span><span id="2609" class="kx jr hi kt b fi lc kz l la lb">map_us = ggplot(map_data, aes(long, lat, group=group, fill = value)) +<br/>  geom_polygon() + # Shape<br/>  scale_fill_gradient(limits=range(map_data$value), <br/>                      low="#FFF3B0", high="#E09F3E") + <br/>  layer(geom="path", stat="identity", position="identity", <br/>        mapping=aes(x=long, y=lat, group=group, <br/>                    color=I('#FFFFFF'))) + <br/>  theme(legend.position = "none", <br/>        axis.line=element_blank(), <br/>        axis.text.x=element_blank(), axis.title.x=element_blank(),<br/>        axis.text.y=element_blank(), axis.title.y=element_blank(),<br/>        axis.ticks=element_blank(), <br/>        panel.background = element_blank()) +<br/>        coord_map(projection = "mercator")</span><span id="9620" class="kx jr hi kt b fi lc kz l la lb">map_us</span><span id="8fe0" class="kx jr hi kt b fi lc kz l la lb"># Save as PNG<br/>xlim = ggplot_build(map_us)$layout$panel_scales_x[[1]]$range$range<br/>ylim = ggplot_build(map_us)$layout$panel_scales_y[[1]]$range$range<br/>ggsave('map_us.png')</span></pre><h1 id="ada8" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">加载并映射第二个数据集</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="8ed1" class="kx jr hi kt b fi ky kz l la lb"># Load and map 2nd data set</span><span id="8139" class="kx jr hi kt b fi lc kz l la lb">covid_df = read.csv('covidbycounty.csv')<br/>geocode_df = read.csv('geocodedcounties.csv')<br/>uniqueGeocode &lt;- geocode_df[,-1]<br/>uniqueCountyGeocode &lt;- unique(uniqueGeocode)<br/>uniqueCountyGeocode$state_county &lt;- paste0(uniqueCountyGeocode$state, uniqueCountyGeocode$county)<br/>uniqueCountyGeo$county &lt;- paste0(uniqueCountyGeo$county, " County")<br/>uniqueCountyGeo &lt;- uniqueCountyGeo[!duplicated(uniqueCountyGeocode$state_county), ]</span><span id="cea8" class="kx jr hi kt b fi lc kz l la lb">covid_df = left_join(covid_df, uniqueCountyGeo[c(2,3,4,5)], by =c('county', 'state'))<br/>covid_df = na.omit(covid_df)<br/>covid_df &lt;- covid_df %&gt;% filter(., state != 'HI')<br/>covid_df &lt;- covid_df %&gt;% filter(., state != 'AK')</span><span id="ffe2" class="kx jr hi kt b fi lc kz l la lb">map_us_png = readPNG('map_us.png')</span><span id="ab3a" class="kx jr hi kt b fi lc kz l la lb">us_covid_deaths = ggplot(covid_df) + <br/>    annotation_custom(rasterGrob(map_us_png, width=unit(1,"npc"), height=unit(1,"npc")),<br/>                    -Inf, Inf, -Inf, Inf) + # Background<br/>  <br/>   xlim(xlim[1]-2,xlim[2]+1) + # x-axis Mapping<br/>   ylim(ylim[1]-6,ylim[2]+6.5) + # y-axis Mapping<br/>  <br/>  geom_point(aes(x=longitude, y=latitude, color=deaths), size=0.1) + <br/>  scale_colour_gradient(name = 'deaths', <br/>                        limits=range(covid_df$deaths), <br/>                        low="#FCB9B2", high="#B23A48") + <br/>  theme(axis.line=element_blank(), <br/>        axis.text.x=element_blank(), axis.title.x=element_blank(),<br/>        axis.text.y=element_blank(), axis.title.y=element_blank(),<br/>        axis.ticks=element_blank(), <br/>        panel.background = element_blank())</span><span id="bc75" class="kx jr hi kt b fi lc kz l la lb">us_covid_deaths<br/>ggsave('covid_deaths.png')</span></pre><h1 id="7863" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使这些点成为 3D 并录制视频</h1><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="5d95" class="kx jr hi kt b fi ky kz l la lb"># Make the points 3D and record video</span><span id="54e6" class="kx jr hi kt b fi lc kz l la lb">plot_gg(us_covid_deaths, multicore = TRUE)</span><span id="943c" class="kx jr hi kt b fi lc kz l la lb">par3d(windowRect = c(0, 0, diff(xlim) * 2500, diff(ylim) * 2500))</span><span id="9af8" class="kx jr hi kt b fi lc kz l la lb">render_camera(fov = 70, zoom = 0.2, theta = 30, phi = 20)<br/>render_depth(focus = 0.8, focallength = 600)</span><span id="9d67" class="kx jr hi kt b fi lc kz l la lb"><br/>phivechalf = 30 + 60 * 1/(1 + exp(seq(-7, 20, length.out = 180)/2))<br/>phivecfull = c(phivechalf, rev(phivechalf))<br/>thetavec = 0 + 45 * sin(seq(0,359,length.out = 360) * pi/180)<br/>zoomvec = 0.45 + 0.2 * 1/(1 + exp(seq(-5, 20, length.out = 180)))<br/>zoomvecfull = c(zoomvec, rev(zoomvec))<br/>render_movie(filename = 'output1', type = "custom", frames = 360,  phi = phivecfull, zoom = zoomvecfull, theta = thetavec)</span><span id="aaf1" class="kx jr hi kt b fi lc kz l la lb"><br/>transition_values &lt;- function(from, to, steps = 10, one_way = FALSE, type = "cos") {<br/>  if (!(type %in% c("cos", "lin"))){stop("type must be one of: 'cos', 'lin'")}<br/>  range &lt;- c(from, to)<br/>  middle &lt;- mean(range)<br/>  half_width &lt;- diff(range)/2<br/>  if (type == "cos") {scaling &lt;- cos(seq(0, 2*pi / ifelse(one_way, 2, 1), length.out = steps))}<br/>  else if (type == "lin"){<br/>    if (one_way) {xout &lt;- seq(1, -1, length.out = steps)} <br/>    else {xout &lt;- c(seq(1, -1, length.out = floor(steps/2)), seq(-1, 1, length.out = ceiling(steps/2)))}<br/>    scaling &lt;- approx(x = c(-1, 1), y = c(-1, 1), xout = xout)$y }<br/>  middle - half_width * scaling<br/>}<br/>theta &lt;- transition_values(from = 0, to = 360, steps = 360, one_way = TRUE, type = "lin")<br/>phi &lt;- transition_values(from = 10, to = 70, steps = 360, one_way = FALSE, type = "cos")<br/>zoom &lt;- transition_values(from = 0.4, to = 0.8, steps = 360, one_way = FALSE, type = "cos")<br/>render_movie(filename = 'output2', type = "custom", frames = 360,  phi = phi, zoom = zoom, theta = theta)</span><span id="f70d" class="kx jr hi kt b fi lc kz l la lb"><br/>rgl.close()</span></pre></div></div>    
</body>
</html>