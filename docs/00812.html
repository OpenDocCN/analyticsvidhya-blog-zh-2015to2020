<html>
<head>
<title>Detecting Anomalies in X-ray using CNN.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用CNN检测X射线中的异常。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/detecting-anomalies-in-x-ray-using-cnn-1e4c2e49f23a?source=collection_archive---------4-----------------------#2019-09-10">https://medium.com/analytics-vidhya/detecting-anomalies-in-x-ray-using-cnn-1e4c2e49f23a?source=collection_archive---------4-----------------------#2019-09-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/529a941ca833b3f14944ec523b92cf23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uCiG8VG3fc137SvjTL4gLA.jpeg"/></div></div></figure><div class=""/><p id="a346" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在神经网络中，卷积神经网络(ConvNets或CNN)广泛用于图像识别、图像分类、物体检测和人脸识别。CNN为医疗行业带来了革命性的变化，在医疗行业中，成像是X射线、CAT扫描、结核病诊断、X射线预诊断、MRI、乳房X线照片等形式的医疗数据的快速增长来源。</p><p id="6ea4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章是关于发现胸部x光图像异常。当我们谈到上述问题时，问题就出现了。我们要找出哪个异常点？这些异常是什么样子的？在开源图像的帮助下，深度学习可以有效地用于发现X射线中的异常，以检测各种疾病。</p><h1 id="fcf2" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">数据</strong></h1><p id="7649" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">本文使用<a class="ae kr" href="https://www.kaggle.com/nih-chest-xrays" rel="noopener ugc nofollow" target="_blank"> CXR数据集</a>作为训练数据集，分为“积液”和“无发现”两类。积液是一种医学状况，其中液体由于各种疾病如肺结核和正常图像而聚集在肺部。</p><p id="1414" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看正常和渗出的x光片是什么样的-</p><figure class="kt ku kv kw fd hk er es paragraph-image"><div class="er es ks"><img src="../Images/cb7b4d94eeae697313998fd05c93e667.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*Lo6qzbOH5ArFBRMuoJQ8zg.png"/></div><figcaption class="kx ky et er es kz la bd b be z dx translated">训练数据-正常和溢出的X射线。</figcaption></figure><p id="116b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">左侧X射线图像中白色液体沉积清晰可见，而右侧图像是正常的X射线样本。</p><h1 id="caac" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">数据增强。</strong></h1><p id="4cd4" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这是数据预处理步骤之一，通常在训练数据很小并且很容易过拟合时进行。CNN架构中的<a class="ae kr" href="https://www.analyticsvidhya.com/blog/2018/12/guide-convolutional-neural-network-cnn/" rel="noopener ugc nofollow" target="_blank">池层</a>增加<a class="ae kr" href="https://stats.stackexchange.com/questions/208936/what-is-translation-invariance-in-computer-vision-and-convolutional-neural-netwo" rel="noopener ugc nofollow" target="_blank">不变性</a>。如果一张狗的图片在图片的左上角，通过池化，你将能够识别出狗是否在左上角的左/右/上/下。但是训练数据由像<strong class="is hu"> <em class="lb">翻转、旋转、裁剪、平移、照明、缩放、添加噪声</em> </strong>等数据扩充组成。模型学习所有这些变化。这大大提高了模型的准确性。因此，即使狗出现在图像的任何角落，模型也能够以很高的准确度识别它。</p><p id="30fa" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kr" href="https://towardsdatascience.com/understand-data-normalization-in-machine-learning-8ff3062101f0" rel="noopener" target="_blank">数据归一化</a>确保每个输入参数(本例中为像素)具有相似的数据分布。这使得在训练网络时收敛速度更快。数据归一化是通过从每个像素中减去平均值，然后用标准偏差除以结果来实现的。此类数据的分布类似于以零为中心的高斯曲线。对于图像输入，我们需要像素数为正，因此我们可以选择缩放[0，1]或[0，255]范围内的归一化数据。</p><figure class="kt ku kv kw fd hk er es paragraph-image"><div class="er es lc"><img src="../Images/8d0fc2981c837ddf4baacb5d924f6b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/format:webp/1*SGFkI-m3MUKdRti5uspItQ.png"/></div></figure><p id="04a0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">keras的ImageDataGenerator类允许用户对x射线图像执行图像增强。然而，CXR数据有特定的限制，如宽度/高度偏移设置为0，中心裁剪设置为false，垂直翻转设置为False，因为这些图像具有自然的方向。</p><p id="27a0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于CXR图像不是“自然图像”，我们不使用“除以255”策略。相反，我们采用最大-最小法进行归一化。因为您不能确定每个像素的范围是0–255，所以您使用最小-最大值进行归一化。</p><h1 id="56da" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">网络大厦</strong></h1><p id="6e2b" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">数据类高度不平衡。“积液”与“找不到”的比率几乎是10 (107/1000)。由于大部分数据仅属于一个类别，简单的培训将不起作用，因为模型将主要学习大部分数据并将其归类为“找不到”，从而导致高精度。</p><p id="d3ee" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">90%(1000/1107)的数据是“找不到的”,如果它将所有数据分类为相同的，准确率将为90 %,接近我们获得的87%的准确率。因此，正确分类“积液”的目标没有实现。高精度显然误导了我们，因此AUC是验证结果的更好性能矩阵。</p><p id="f551" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">构建模型的基本步骤:</p><ol class=""><li id="5e65" class="ld le ht is b it iu ix iy jb lf jf lg jj lh jn li lj lk ll bi translated">导入resnet代码</li></ol><p id="bfda" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“ResNet builder”模块用于导入<a class="ae kr" href="https://arxiv.org/pdf/1603.05027.pdf" rel="noopener ugc nofollow" target="_blank">ResNet</a>(ResNet-18，ResNet-34等)的变体(所有构建模块)。).Keras的ResNet实现不是首选，因为它不能提供从这些变体中进行选择的灵活性。本文使用的resnet.py模块取自<a class="ae kr" href="https://github.com/raghakot/keras-resnet" rel="noopener ugc nofollow" target="_blank">此处为</a></p><p id="dc5e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.运行增强数据生成器</p><p id="f002" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Keras generator希望每个类中的图像都在一个独立的目录中(在多标签问题中是不可能的，比如在上下文、分割问题等中)。)并创建原始数据的副本，还必须将<code class="du lm ln lo lp b">dtype</code>从<code class="du lm ln lo lp b">uint8</code>转换为<code class="du lm ln lo lp b">float64</code>，这增加了GPU上的内存过载。然后，根据问题陈述，使用适当的用户输入构建定制的ImageDataGenerator。</p><figure class="kt ku kv kw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/9c5284555a4a2ee44b44fc63041a6943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qxqr2rFVCJgAaJMmIpt9qQ.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">定制数据生成器</figcaption></figure><p id="d2a3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Datagenerator类初始化为分类类——无发现和渗出，模式为训练数据的训练，通道为1(黑/白图像)的i/p。</p><p id="b401" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.执行消融运行</p><p id="10c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">来自训练和验证数据集的小批量数据在各种超参数上进行训练，以找到最佳学习率并观察模型在功能上的表现。</p><p id="971b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.符合模型。</p><p id="5041" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">验证AUC而不是准确性被用作评估度量以避免过度拟合，并且模型被训练以保持一切相同，例如网络层、数据扩充、预处理等</p><p id="9738" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该模型在AUC(我们选择的衡量标准)上表现不佳。</p><ol class=""><li id="9c93" class="ld le ht is b it iu ix iy jb lf jf lg jj lh jn li lj lk ll bi translated">造成这种情况的主要原因是普遍性问题。数据集中的异常案例并不多(类别不平衡)。</li><li id="9e98" class="ld le ht is b it lq ix lr jb ls jf lt jj lu jn li lj lk ll bi translated">为了解决这个问题，我们引入了“加权分类交叉熵”。</li></ol><p id="d7fd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">加权交叉熵损失</strong>对低流行等级的错误分类的惩罚比其他等级更重。因此，每当模型在异常类别(在本例中为“渗出”)上出错时，它会通过将损失乘以高权重值而受到严重惩罚。这导致错误分类类别的损失增加，因此由于反向传播而导致的权重变化更大。因此，对错误分类负责的权重的学习曲线更多。</p><figure class="kt ku kv kw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lv"><img src="../Images/483647669368de5a63f618e932d1d8bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m106Ih79tnteBkqmyWLl-w.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">加权分类交叉熵</figcaption></figure><p id="ea72" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设“没有发现”是0级，“积液”是1级。</p><p id="0f47" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> bin_weights[0，0]: </strong>实际类:0，预测类:0，所以没有惩罚，只是正常的<strong class="is hu">权重1。</strong></p><p id="e09f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> bin_weights[1，1]: </strong>实际类:1，预测类:1，所以没有惩罚，只是正常的<strong class="is hu">权重为1。</strong></p><p id="1a5c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">出现异常情况时:</p><p id="4fce" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> bin_weights[1，0] </strong> —实际类为1，预测类为0，<strong class="is hu">按权重5处罚。</strong></p><p id="9e02" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> bin_weights[0，1] </strong> —实际类为0，预测类为1，<strong class="is hu">按权重5处罚。</strong></p><h1 id="aa73" class="jo jp ht bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">最终模型</h1><p id="6bec" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在最终运行<strong class="is hu">中，kera的模型检查点</strong>仅在验证准确性增加时保存<strong class="is hu"> </strong>模型权重，并使用<strong class="is hu"> keras回调调用。</strong> AUC已经<em class="lb">从0.51(无权重)显著增加到0.72(有权重)。</em></p><p id="84d9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在初始化架构和权重后，根据来自验证数据集(此处为最后20%的数据)的未知数据预测模型。结果显示正常类的概率为. 44，渗出类的概率为. 55。</p><figure class="kt ku kv kw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lw"><img src="../Images/f6eaaa2dccfc8e820bc982499c6daf5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uo49mirdfzSFsVFhl1wG3Q.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">对验证数据集的预测。</figcaption></figure><p id="5ed0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建这篇文章的源代码可以在<a class="ae kr" href="https://github.com/snehabhatt/MachineLearningProjects/blob/master/XRAY-Submit/Working_With_Chest_XRay_Images-2.ipynb" rel="noopener ugc nofollow" target="_blank">这里</a>找到。我将很高兴收到关于上述任何反馈或问题。</p></div></div>    
</body>
</html>