<html>
<head>
<title>Converting a custom Darknet model to TensorFlow Lite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将自定义暗网模型转换为TensorFlow Lite</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/converting-a-custom-darknet-model-to-tensorflow-lite-ffdd48d58082?source=collection_archive---------2-----------------------#2020-01-30">https://medium.com/analytics-vidhya/converting-a-custom-darknet-model-to-tensorflow-lite-ffdd48d58082?source=collection_archive---------2-----------------------#2020-01-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c899590156292630834b5cf08782371c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IgJvalm1P-FHs0PMbzs5Qg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Tensorflow的移动设备框架</figcaption></figure><h1 id="4cbe" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">介绍</h1><p id="af60" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">你是否尝试过构建一个定制的Darknet模型，并意识到这个模型在移动应用程序上运行将非常困难？您是否发现自己正在寻找一种方法来将这种模型转换为移动兼容的格式(TensorFlow lite)？嗯，我希望我使用的解决方案对你有用。(跳到我用什么来转换？解决方案部分)</p><p id="79e8" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">长话短说，我设法使用<a class="ae kv" href="https://github.com/AlexeyAB/darknet" rel="noopener ugc nofollow" target="_blank"> darknet </a>框架训练了一个定制的tiny-Yolo V3模型，并需要将我的模型转换为Tensorflow Lite格式。如果你想知道为什么，请阅读下面的两个部分。</p><h1 id="cc4f" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">什么是Tensorflow Lite？</h1><p id="25ab" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated"><a class="ae kv" href="https://www.tensorflow.org/lite/guide" rel="noopener ugc nofollow" target="_blank"> Tensorflow Lite </a>是一个开源框架，旨在移动设备、物联网设备和嵌入式设备上运行Tensorflow模型。它将优化模型，使其使用非常少的手机资源。</p><h1 id="4671" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">为什么我需要转换？</h1><p id="0ef5" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">默认情况下，一旦模型为Flatbuffer文件格式(.tflite)，它是由张量流转换器生成的。在此之前，我们需要将darknet模型转换为Tensorflow支持的Protobuf文件格式(。pb)。</p><p id="4fc5" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">为您简化一下:</p><p id="75f6" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">yolo v3-tiny . weights→tiny-yolo-v3 . Pb→tiny-yolo-v3 . tflite。</p><h1 id="19a9" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">。重量-&gt;。Pb转换</h1><p id="120e" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">我使用了TF-Slim中Yolo v3的<a class="ae kv" href="https://github.com/mystic123/tensorflow-yolo-v3" rel="noopener ugc nofollow" target="_blank"> mystic123的</a>实现来进行转换。在克隆此存储库之前，您需要Python版本≥ 3.5，Tensorflow版本≥ 1.11。我用的是Python 3.7.4和Tensorflow 1.15。</p><p id="5c7a" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">要转换的命令。重量为。pb是:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="1dbf" class="lf iv hi lb b fi lg lh l li lj">python convert_weights_pb.py --class_names "~YOUR PATH~/class.names" --weights_file "~YOUR PATH~/yolov3-tiny.weights" --data_format "NHWC" --tiny</span></pre><p id="7804" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">我强烈建议使用绝对路径，因为它保证脚本会找到您需要的文件。一个好路径的例子是<strong class="ju hj">D:/tensor flow-yolo-v3-master/data/tiny-yolo . weights .</strong></p><p id="710d" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">运行之后，你将得到Protobuf文件，现在你需要把它转换成tflite格式。您也可以尝试使用NCHW，但这给我的下一步带来了一些问题。</p><h1 id="0b8a" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">。Pb -&gt;。Tflite转换</h1><p id="de57" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp hb bi translated">要执行这种转换，您需要确定输入的名称、输入的维度以及模型输出的名称。如果您已经知道这些值，那么跳到下面的命令。</p><p id="f0ba" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">如果您不知道这些值，那么您需要下载<a class="ae kv" href="https://github.com/lutzroeder/netron" rel="noopener ugc nofollow" target="_blank"> Netron </a>。Netron将帮助你想象你的。pb文件，并将显示模型中的所有层。启动Netron后，请确保打开。pb文件，并查找输入层的名称、下面的尺寸，双击最后一层可以找到输出名称。</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/6d41aaef06be654d35570cf589783269.png" data-original-src="https://miro.medium.com/v2/resize:fit:848/format:webp/1*cWRtX4mNOFAZUVhJ6ChPwA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用Netron获取输入图层值</figcaption></figure><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/6473f85c239e90a4eeff65ec62c598fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DVUNZ70SOcqjkAhlmJlMxA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用Netron获取输出层值</figcaption></figure><p id="a778" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">要运行下面的命令，您需要安装tflite_convert。如果您的Tensorflow版本≥ 1.9，则它已经安装。命令是:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9de5" class="lf iv hi lb b fi lg lh l li lj">tflite_convert --graph_def_file=~YOUR PATH~/yolov3-tiny.pb --output_file=~YOUR PATH~/yolov3-tiny.tflite --input_format=TENSORFLOW_GRAPHDEF --output_format=TFLITE --input_shape=1,416,416,3 --input_array=~YOUR INPUT NAME~ --output_array=~YOUR OUTPUT NAME~ --inference_type=FLOAT --input_data_type=FLOAT</span></pre><p id="66af" class="pw-post-body-paragraph js jt hi ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp hb bi translated">这将生成一个名为yolov3-tiny.tflite的文件。如果是这样，那么恭喜你，因为这种转换并不容易！如果这对你有用，那么我非常高兴，如果没有，那么你应该非常接近解决方案。保重，再见！</p></div></div>    
</body>
</html>