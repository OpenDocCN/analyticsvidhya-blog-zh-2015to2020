<html>
<head>
<title>Tekton: a Kubernetes Native CI/CD Solution and my own Best Practices to use it.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">tek ton:Kubernetes本地CI/CD解决方案和我自己使用它的最佳实践。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/tekton-a-kubernetes-native-ci-cd-solution-and-my-own-best-practices-to-use-it-81b7d456bf64?source=collection_archive---------12-----------------------#2020-05-30">https://medium.com/analytics-vidhya/tekton-a-kubernetes-native-ci-cd-solution-and-my-own-best-practices-to-use-it-81b7d456bf64?source=collection_archive---------12-----------------------#2020-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a66e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2020年5月28日<br/> <em class="jd">(原载于</em><a class="ae je" href="https://ish-ar.io/tekton-best-practices/" rel="noopener ugc nofollow" target="_blank">【https://ish-ar.io/tekton-best-practices/】<em class="jd">)</em></a></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jf"><img src="../Images/5c4edd9c339bbca8b3d7ce88755768d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*7FTn7LA5kYYXiWHZ.png"/></div></figure><p id="021f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">(原发布于</em><a class="ae je" href="https://ish-ar.io/tekton_best_practices/" rel="noopener ugc nofollow" target="_blank"><em class="jd">https://ish-ar . io</em></a><em class="jd">)</em></p><p id="e635" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几个月前，我开始研究一个相对较新的项目，名为<a class="ae je" href="https://tekton.dev" rel="noopener ugc nofollow" target="_blank">‘tek ton’</a>。</p><p id="5b63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我开始实现Tekton时，我已经意识到(以积极的方式)离典型的行业标准有多远。作为Kubernetes本地CI/CD解决方案，它具有革命性。</p><p id="f2b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，它也带来了早期项目经常会遇到的问题。例如:</p><ul class=""><li id="adc9" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">尽管文档写得很好，但缺乏案例研究、经验、论坛上的问答等。对新用户来说很难。</li><li id="0ddc" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">审计，授权，日志，这一切都有点混乱，但我相信它会随着时间的推移。</li></ul><p id="8d68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在今天的文章中，我将展示一些我为自己定义的最佳实践，并解释一些我刚开始时不清楚的概念。</p><p id="ede3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">注意</strong>:如果你对Tekton一无所知或者你从未尝试过，你可能想先阅读一下网上的<a class="ae je" href="https://tekton.dev/docs/" rel="noopener ugc nofollow" target="_blank">‘文档’</a>。但这完全取决于你。</p><h1 id="00eb" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">我一路走来学到的一些概念和最佳实践。</h1><h1 id="e3e3" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">可重用性</h1><p id="ec17" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">引起我注意的一个方面是可重用管道的概念。Tekton通过定义多个<em class="jd">任务</em>来工作，这些任务将被用作构建模块来创建<em class="jd">管道</em>。管道和任务都是蓝图，它们实际上不做任何事情，也不应该包含任何执行上下文。</p><p id="6c13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">事实上，<strong class="ih hj">一个任务应该尽可能“标准”</strong>。</p><p id="8a75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一些任务示例可以是<em class="jd">构建-停靠-映像、推送-停靠-映像、运行-应用-测试、下载-jar </em>等。</p><h1 id="74fb" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">一切都是Kubernetes的对象</h1><p id="35bb" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">如前所述，Tekton是一个“Kubernetes本地”应用程序。因此，当您安装它时，您的集群上将有一些新的API对象可用。</p><p id="cb79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">资源任务、资源、管道、TaskRun、PipelineRun等。，都是可以通过kubectl查询的API对象，这在我看来，让用户体验超级！</p><p id="b08a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提示:如果你正在进行故障诊断，记住一个Tekton任务对应一个Pod是很有用的，每个任务都有步骤，代表Pod中的容器。</p><p id="6edd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们在上一段中讨论的，任务和管道是“蓝图”,实际的执行是由任务运行和管道运行触发的。</p><p id="98d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的小型Tekton实现中，我当时只使用TaskRuns来测试单个任务，而不是每次都触发整个管道。</p><p id="7829" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">理想情况下，您希望您的管道由来自CVS的webhooks触发。在某些情况下，您可能需要手动运行它们，如果是这种情况，您只需通过CLI或Dashboard/UI创建PipelineRun对象。</p><h1 id="aeb9" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">TriggerTemplate:目前为止最好的方法！</h1><p id="011c" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">“完整”Tekton安装还包括一个名为Tekton Trigger的组件。</p><p id="1213" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如GitHub中所写的:"<em class="jd"> Tekton Triggers是一个Kubernetes自定义资源定义(CRD)控制器，它允许您从事件有效负载(一个“触发器”)中提取信息来创建Kubernetes资源。</em></p><p id="edfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Tekton Trigger附带3个主要资源:TriggerTemplate、TriggerBinding和EventListener。</p><p id="6e07" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要运行任务和管道，您需要TaskRun和PipelineRun对象，但是如果您希望从webhook或某种HTTP/s请求触发它们，该怎么办呢？</p><p id="6ff2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，应该使用TriggerTemplate。使用TriggerTemplate，您可以定义一个PipelineRun或TaskRun对象，并将其附加到一个事件侦听器，该事件侦听器将接收传入的HTTP/s请求，对它们进行处理并触发正确的PipelineRun或TaskRun。</p><p id="3a60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是EventListener和TriggerTemplate YAML定义的示例。</p><p id="fbf0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">事件监听器:</strong></p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="69e3" class="lj kc hi lf b fi lk ll l lm ln">apiVersion: triggers.tekton.dev/v1alpha1<br/>kind: EventListener<br/>metadata:<br/>  name: tekton-demo-el<br/>  namespace: tekton-demo<br/>spec:<br/>  serviceAccountName: tekton-triggers-1590086083<br/>  triggers:<br/>    - bindings:<br/>      - name: tekton-demo-app-ci<br/>      template:<br/>        name: tekton-demo-app-ci</span></pre><p id="1a60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">模板触发器:</strong></p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="7f2b" class="lj kc hi lf b fi lk ll l lm ln">apiVersion: triggers.tekton.dev/v1alpha1<br/>kind: TriggerTemplate<br/>metadata:<br/>  name: tekton-demo-app-ci<br/>  namespace: tekton-demo<br/>spec:<br/>  resourcetemplates:<br/>  - apiVersion: tekton.dev/v1beta1<br/>    kind: PipelineRun<br/>    metadata:<br/>      generateName: app-ci-run-<br/>    spec:<br/>      serviceAccountName: tekton-demo<br/>      pipelineRef:<br/>        name: ci<br/>      resources:<br/>      ....</span></pre><h1 id="5c29" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">赛尔截击机。</h1><p id="58c0" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">在上面的例子中，事件侦听器与管道有1:1的映射，当它接收到传入的请求时，它将总是运行那个特定的管道。</p><p id="b702" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种设置不理想；如果您希望为另一个存储库创建不同的管道，您必须创建第二个事件侦听器。</p><p id="bd18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你能想象100个不同的存储库和管道，100个不同的事件监听器(也就是web服务器)吗？？一个字:神经病。</p><p id="89c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我准备的实验室利用了一个名为CEL interceptor的“组件”,它允许您在事件侦听器中定义一些逻辑。</p><p id="e8d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用CEL拦截器，您可以这样做:“如果存储库名称是X，动作是PUSH然后运行管道y。”</p><p id="7f83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个例子:</p><pre class="jg jh ji jj fd le lf lg lh aw li bi"><span id="d134" class="lj kc hi lf b fi lk ll l lm ln">apiVersion: triggers.tekton.dev/v1alpha1<br/>kind: EventListener<br/>metadata:<br/>  name: tekton-demo-el<br/>  namespace: tekton-demo<br/>spec:<br/>  serviceAccountName: tekton-triggers-1590086083<br/>  triggers:<br/>    - name: triggers-cd<br/>      interceptors:<br/>        - cel:<br/>            filter: &gt;-<br/>              (header.match('X-GitHub-Event', 'push') &amp;&amp;<br/>               body.repository.full_name == 'tekton/triggers') &amp;&amp;<br/>               body.ref.startsWith('refs/heads/master')<br/>      bindings:<br/>        - name: triggers-cd-binding<br/>      template:<br/>        name: triggers-cd-template<br/>    - name: dashboard-cd<br/>      interceptors:<br/>        - cel:<br/>            filter: &gt;-<br/>              (header.match('X-GitHub-Event', 'push') &amp;&amp;<br/>               body.repository.full_name == 'tekton/dashboard') &amp;&amp;<br/>               body.ref.startsWith('refs/heads/master')<br/>      bindings:<br/>        - name: dashboard-cd-binding<br/>      template:<br/>        name: dashboard-cd-template</span></pre><h1 id="58fe" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">简单:有保证，但不是立即！</h1><p id="98cb" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">由于Tekton不是一个你可以执行的JAR，点击/点击，魔术，它工作(不涉及任何东西，啊:D)，它要求管理员有一些关于Kubernetes的知识，并且至少能自如地查看K8s API对象。</p><p id="f79c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最坏的情况:你必须查看一些Go代码来理解Tekton控制器/组件在做什么。我做到了；源代码做得很好，可读性很强。所以如果真的发生了，也不用太担心。</p><p id="9940" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，在最初的疲劳之后，你会感到舒适，并且希望你会看到建立新的工作流程和管理它们是多么容易。</p><h1 id="008a" class="kb kc hi bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">下一步是什么？</h1><p id="4f56" class="pw-post-body-paragraph if ig hi ih b ii kz ik il im la io ip iq lb is it iu lc iw ix iy ld ja jb jc hb bi translated">我准备写一篇关于泰克顿的小编文章。下一个主题是:“Tekton &amp; Prometheus的管道度量和监控”。</p><p id="6f9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请继续关注，如果您有任何问题，请在Twitter上提问！</p></div></div>    
</body>
</html>