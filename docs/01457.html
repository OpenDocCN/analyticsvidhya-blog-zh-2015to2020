<html>
<head>
<title>Machine Learning Automation (1): Clipper AI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">机器学习自动化(1):快船人工智能</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/machine-learning-automation-1-clipper-ai-7b896890695f?source=collection_archive---------16-----------------------#2019-10-23">https://medium.com/analytics-vidhya/machine-learning-automation-1-clipper-ai-7b896890695f?source=collection_archive---------16-----------------------#2019-10-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="41a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文是探索机器学习平台系列的一部分，旨在了解它们提供的服务以及它们如何帮助您在生产中交付更好的模型。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/95f6faa44d44940ae96c9a26a14a2b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yex3iKBI7foICdpR-L4LYg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">clipper.ai</figcaption></figure><h1 id="977d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">快船是什么？</h1><p id="c3e5" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Clipper将自己定义为:</p><blockquote class="kw kx ky"><p id="7750" class="if ig kz ih b ii ij ik il im in io ip la ir is it lb iv iw ix lc iz ja jb jc hb bi translated">一种预测服务系统，位于面向用户的应用程序和各种常用的机器学习模型和框架之间。</p></blockquote><p id="7337" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以Clipper是一个反向代理。它通过REST Api调用，并通过构建在<a class="ae ld" href="https://zeromq.org/" rel="noopener ugc nofollow" target="_blank"> zeromq </a>之上的低开销协议与模型通信。</p><p id="5750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">它由三个建筑块组成</strong>:</p><ul class=""><li id="739b" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated"><strong class="ih hj"> Admin </strong>(或管理):该服务保存配置并允许读取和更新。它需要一个简单的Redis数据库。它是用Python写的</li><li id="cfbc" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj">查询前端</strong>:这是反向代理，为了性能和避免垃圾收集，用C++写的。它实现zeromq协议，并以这种方式与模型通信。</li><li id="ea84" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj">模型</strong>:每个模型都封装在一个容器中，该容器处理来自查询前端的远程过程调用。</li></ul><p id="4ce6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你使用一个支持的编排器(Docker Cli，Kubernetes ), clipper<strong class="ih hj">极大地简化了部署步骤。不过支持其他编排器相对简单，我将在下面演示。</strong></p><h1 id="4e3f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">从Jupyter笔记本到Nomad上的部署</h1><p id="57da" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">以下示例基于目前仍在审核中的<a class="ae ld" href="https://github.com/ucbrise/clipper/pull/750" rel="noopener ugc nofollow" target="_blank">PR。</a></p><p id="e419" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先决条件:</p><ul class=""><li id="cfea" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">您需要一个带有Consul DNS和Fabio负载平衡器的Nomad集群。你可以按照<a class="ae ld" href="https://blog.scaleway.com/2016/build-your-infrastructure-with-terraform-nomad-and-consul-on-scaleway/" rel="noopener ugc nofollow" target="_blank">这个教程</a>学习Scaleway，并阅读<a class="ae ld" href="https://www.nomadproject.io/" rel="noopener ugc nofollow" target="_blank"> Nomad </a>、<a class="ae ld" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">consult</a>和<a class="ae ld" href="https://fabiolb.net/" rel="noopener ugc nofollow" target="_blank"> Fabio </a>可用的文档。</li><li id="8d9c" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">您需要在您的计算机上配置Consul DNS，请确保您可以解析*.service.consul地址。</li></ul><p id="e8d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在这个<a class="ae ld" href="https://github.com/hyperplan-io/clipper-nomad-demo" rel="noopener ugc nofollow" target="_blank"> Git存储库</a>上找到nomad部署的代码示例和资源。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ls"><img src="../Images/8ebe771ff6e74dc8eb95c4a9e998bf5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*_Q0P_JjsKNsBQW2UH2U56A.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">我在这个演示中使用的架构</figcaption></figure><p id="ec86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的目标是在我们的机器上训练一个简单的模型，并将其部署到我们的Nomad集群中。</p><p id="1f21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们首先用Scikit-Learn构建一个简单的模型。我们将在Scikit Learn的糖尿病数据集上训练一个简单的线性回归。这适合几行代码。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="9438" class="ly ju hi lu b fi lz ma l mb mc">from sklearn import datasets<br/>from sklearn.model_selection import train_test_split<br/>from sklearn.linear_model import LinearRegression</span><span id="c34c" class="ly ju hi lu b fi md ma l mb mc">diabetes = datasets.load_diabetes()</span><span id="5bac" class="ly ju hi lu b fi md ma l mb mc">X_train, X_test, y_train, y_test = train_test_split(diabetes.data, diabetes.target, test_size=0.2, random_state=0)<br/>clf = LinearRegression()<br/>clf.fit(X_train, y_train)</span></pre><h2 id="1af0" class="ly ju hi bd jv me mf mg jz mh mi mj kd iq mk ml kh iu mm mn kl iy mo mp kp mq bi translated">部署</h2><p id="7293" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">现在我们有了自己的模型，我们希望通过REST API将它提供给我们的用户。没有Clipper，我们必须经历许多步骤，这些步骤大部分是由开发人员完成的。</p><ul class=""><li id="53a5" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">创建一个Flask应用程序及其API</li><li id="ddce" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">创建指标和运行状况检查</li><li id="2d5a" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">将申请归档</li><li id="a401" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">写一个*。要部署的nomad脚本</li></ul><p id="6ab5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Clipper让我们用几行Python代码就可以避免所有这些步骤！</p><p id="0c43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们创建一个到Nomad集群的连接，并设置一些参数，比如我们使用的DNS(Consul)和负载平衡器(Fabio)。您需要<a class="ae ld" href="https://fabiolb.net/feature/tcp-proxy/" rel="noopener ugc nofollow" target="_blank">在一个端口上配置启用了tcp代理的Fabio】。这是因为<strong class="ih hj">查询前端</strong>和<strong class="ih hj">模型容器</strong>与TCP协议通信。在我的例子中，我使用了端口7000。</a></p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="1d00" class="ly ju hi lu b fi lz ma l mb mc">from clipper_admin import ClipperConnection, DockerContainerManager, NomadContainerManager, ConsulDNS, FabioLoadBalancer</span><span id="3915" class="ly ju hi lu b fi md ma l mb mc">nomad_ip_addr = ‘10.65.30.43’</span><span id="d00a" class="ly ju hi lu b fi md ma l mb mc">dns = ConsulDNS() # We use Consul for DNS resolution</span><span id="871c" class="ly ju hi lu b fi md ma l mb mc">container_manager = NomadContainerManager(<br/>  nomad_ip=nomad_ip_addr,<br/>  dns=dns,<br/>  load_balancer=FabioLoadBalancer(<br/>    address='fabio.service.consul', <br/>    http_proxy_port=9999, <br/>    tcp_proxy_port=7000<br/>  )<br/>)<br/>clipper_conn = ClipperConnection(container_manager)<br/>clipper_conn.start_clipper()</span><span id="7401" class="ly ju hi lu b fi md ma l mb mc"># use clipper_conn.connect() later</span></pre><p id="9d3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦执行了这段代码，您应该会在Nomad UI中看到<strong class="ih hj">三个任务</strong>开始。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mr"><img src="../Images/20adb10e5d34e93501b691871fc8fadf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*SL84ZCScmmBPPBqc09b_dw.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">三个工作，数据库，管理和查询前端</figcaption></figure><p id="10fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了服务于一个模型，你必须创建一个“应用程序”。你可以把它想象成一个项目，它将<strong class="ih hj">重新组合</strong>所有<strong class="ih hj">完成同一个目标</strong>的算法。您可以指定它的名称、它接收的输入数据类型、发生错误时它将输出的默认数据，以及服务级别目标，即您预期的预测交付速度。</p><p id="5d05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Clipper将尝试使用批处理等技巧，在<strong class="ih hj">延迟</strong>和<strong class="ih hj">吞吐量</strong>之间找到平衡。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="3b69" class="ly ju hi lu b fi lz ma l mb mc">my_application_name = 'app-1'<br/><br/>clipper_conn.register_application(<br/>  name=my_application_name, <br/>  input_type="doubles", <br/>  default_output="-1.0", <br/>  slo_micros=10000000<br/>)</span></pre><p id="f4cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们创建了我们的应用程序，我们可以查询它。这还不是很有用，因为我们还没有解决这个问题的模型。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="99a9" class="ly ju hi lu b fi lz ma l mb mc">{<br/>  "query_id":13,<br/>  "output":1.0,<br/>  "default":true,<br/>  "default_explanation":"No connected models found for query"<br/>}</span></pre><p id="033a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了在我们的应用程序(或项目)上提供一个新的模型，我们使用一个可用的<strong class="ih hj">部署器</strong>。Clipper为TensorFlow、Keras、PyTorch等许多框架提供了实现。他们还有一个标准的Python函数部署器，我们将使用它来部署我们的Scikit学习模型。您只需要访问Docker注册表(您可以使用Docker Hub)。在这个例子中，我使用了一个托管在Scaleway上的私有注册中心。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="aebe" class="ly ju hi lu b fi lz ma l mb mc">from clipper_admin.deployers import python as python_deployer</span><span id="9d5f" class="ly ju hi lu b fi md ma l mb mc">my_model_name='scikit-learn-model'<br/>my_model_version = 1</span><span id="1bde" class="ly ju hi lu b fi md ma l mb mc"># I use a private registry hosted on Scaleway<br/>container_registry = 'rg.fr-par.scw.cloud/hyperplan'</span><span id="6fbc" class="ly ju hi lu b fi md ma l mb mc">python_deployer.deploy_python_closure(<br/>  clipper_conn, <br/>  name=my_model_name, <br/>  version=my_model_version, <br/>  input_type="doubles", <br/>  func=clf.predict,<br/>  pkgs_to_install=['scikit-learn'],<br/>  registry=container_registry<br/>)</span></pre><p id="be99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果需要一些预处理，可以修改<strong class="ih hj"> func </strong>参数。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="e2dd" class="ly ju hi lu b fi lz ma l mb mc">def my_prediction_func(model, inputs):<br/>    return [model(x) for x in inputs]</span></pre><p id="8985" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">deployer函数将构建一个包含所有必需依赖项的Docker映像，将其推送到容器注册中心，并向Nomad提交一个新作业。您应该在Nomad UI中看到该实例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ms"><img src="../Images/5fbd1869332c47f71e53d8f960f166fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1154/format:webp/1*VrK8TKTzGvxbe8UxkDNH8Q.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">提供各种型号</figcaption></figure><p id="f5ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在使用我们的模型之前，还有最后一步，我们需要将它与我们的应用程序连接起来。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="e415" class="ly ju hi lu b fi lz ma l mb mc">clipper_conn.link_model_to_app(<br/>  app_name=my_application_name, <br/>  model_name=my_model_name<br/>)</span></pre><p id="4639" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">来测试一下吧！我们将通过fabio负载平衡器调用它(它监听端口9999上的http流量)。快船送达以下地址。</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="2ba4" class="ly ju hi lu b fi lz ma l mb mc"><a class="ae ld" href="http://fabio.service.consul:9999/clipper/{app_name}/predict" rel="noopener ugc nofollow" target="_blank">http://fabio.service.consul:9999/clipper/</a></span></pre><p id="c972" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在我们的应用程序(app-1)上创建预测，方法是在</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="251b" class="ly ju hi lu b fi lz ma l mb mc"><a class="ae ld" href="http://fabio.service.consul:9999/clipper/{app_name}/predict" rel="noopener ugc nofollow" target="_blank">http://fabio.service.consul:9999/clipper/app-1/predict</a></span></pre><p id="71fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个python的例子</p><pre class="je jf jg jh fd lt lu lv lw aw lx bi"><span id="30a8" class="ly ju hi lu b fi lz ma l mb mc">import requests, json, numpy as np<br/>headers = {"Content-type": "application/json"}<br/>requests.post(<br/>  "<a class="ae ld" href="http://fabio.service.consul:9999/clipper/{app_name}/predict" rel="noopener ugc nofollow" target="_blank">http://fabio.service.consul:9999/clipper/{app_name}/predict</a>".format(app_name=my_application_name), <br/>  headers=headers, <br/>  data=json.dumps({"input": list(np.random.random(10))})<br/>).json()</span><span id="e317" class="ly ju hi lu b fi md ma l mb mc"><br/>{'query_id': 12, 'output': 248.95820966558657, 'default': False}</span></pre><h1 id="ca69" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">我的建议</h1><p id="7c1a" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">Clipper是一个很棒的工具，我向任何有简单需求来服务机器学习模型的人推荐它。它易于使用，可扩展和高性能。我只是对一些设计决策有些担心:</p><ul class=""><li id="6b05" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated"><strong class="ih hj"> Clipper宁愿不返回结果</strong>也不愿返回超出容许SLO的结果。我更喜欢在这种情况发生时进行监控和报警。</li><li id="3844" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj">应用程序和模型之间的1:1关系</strong>，使用Clipper，您不能在模型上进行AB测试。这意味着你要么需要在查询前端添加另一个Http代理(很可能是Flask ),如<a class="ae ld" href="https://github.com/ucbrise/clipper/issues/628" rel="noopener ugc nofollow" target="_blank">本期</a>所述，但是Python是一种垃圾收集语言，这将导致意外的延迟和整体性能下降。</li><li id="89bc" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><strong class="ih hj">查询前端容器是有状态的</strong>。<strong class="ih hj"> </strong> It <strong class="ih hj"> </strong>需要<strong class="ih hj"> </strong>来保持到每个模型的至少一个实例的连接。当您向网络中添加一个新的查询前端实例时，您可能会遇到这样一种情况，即它没有与每个模型保持连接。模型实例可以使用DNS来解析查询前端的ip地址，不保证模型A的两个实例将连接到查询前端的两个不同实例。这是一个潜在的问题。解决这个问题的一个方法是使用一个无状态的协议，比如gRPC，但是这需要对Clipper的架构做一些重大的改变。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mt"><img src="../Images/fad925dc194e60f7c14fa25d4b36c827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*094y79h0ZonfObiK0ThKJQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">可能的不同场景，4是我们想要避免的</figcaption></figure><p id="10f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ld" href="https://github.com/hyperplan-io/clipper-nomad-demo" rel="noopener ugc nofollow" target="_blank">你可以在Github </a>上找到我的代码，还有额外的代码样本和关于我的基础设施设置的信息。</p></div></div>    
</body>
</html>