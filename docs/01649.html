<html>
<head>
<title>Serving a model using MLflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MLflow服务模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/serving-a-model-using-mlflow-8ba5db0a26c0?source=collection_archive---------4-----------------------#2019-11-06">https://medium.com/analytics-vidhya/serving-a-model-using-mlflow-8ba5db0a26c0?source=collection_archive---------4-----------------------#2019-11-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b3b4593ca9a7ec19626adced49c04532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xq385dWU0Nd305g6MOKwDQ.png"/></div></div></figure><p id="3b9b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是我的MLflow教程系列的第六篇也是最后一篇文章:</p><ol class=""><li id="7399" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/setup-mlflow-in-production-d72aecde7fef">在生产中设置ml flow</a></li><li id="6594" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-basic-logging-functions-e16cdea047b"> MLflow:基本测井功能</a></li><li id="1c85" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-logging-for-tensorflow-37b6a6a53e3c">张量流的MLflow测井</a></li><li id="c3af" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-projects-24c41b00854"> MLflow项目</a></li><li id="df75" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/retrieving-the-best-model-using-python-api-for-mlflow-7f76bf503692">使用Python API为MLflow检索最佳模型</a></li><li id="9078" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/serving-a-model-using-mlflow-8ba5db0a26c0">使用MLflow为模型服务</a>(你来了！)</li></ol><p id="7cbe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创造环境</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="c5fb" class="km kn hi ki b fi ko kp l kq kr">conda create -n production_env<br/>conda activate production_env<br/>conda install python<br/>pip install mlflow<br/>pip install sklearn</span></pre><p id="7fb9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从互联网上运行一个样本机器学习模型</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="f4b8" class="km kn hi ki b fi ko kp l kq kr">mlflow run git@github.com:databricks/mlflow-example.git -P alpha=0.5</span></pre><p id="bf33" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注:正如<a class="ks kt ge" href="https://medium.com/u/6708ecbce7e4?source=post_page-----8ba5db0a26c0--------------------------------" rel="noopener" target="_blank"> Mourad K </a>在评论中指出的。只有当您的<a class="ae jx" href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent" rel="noopener ugc nofollow" target="_blank"> GitHub认证</a>使用ssh-keys设置时，上面的命令才会运行。</p><p id="2842" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">检查它是否成功运行</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="0064" class="km kn hi ki b fi ko kp l kq kr">ls -al ~/mlruns/0</span></pre><p id="bee9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从上面的命令中获取我们刚刚运行的模型的<strong class="is hj"> uuid </strong>并为模型提供服务。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="d97c" class="km kn hi ki b fi ko kp l kq kr">mlflow models serve -m ~/mlruns/0/your_uuid/artifacts/model -h 0.0.0.0 -p 8001</span></pre><p id="43d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在新的终端窗口中进行推理。去狂野吧！</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="0d7f" class="km kn hi ki b fi ko kp l kq kr">curl -X POST -H "Content-Type:application/json; format=pandas-split" --data '{"columns":["alcohol", "chlorides", "citric acid", "density", "fixed acidity", "free sulfur dioxide", "pH", "residual sugar", "sulphates", "total sulfur dioxide", "volatile acidity"],"data":[[12.8, 0.029, 0.48, 0.98, 6.2, 29, 3.33, 1.2, 0.39, 75, 0.66]]}' <a class="ae jx" href="http://0.0.0.0:8001/invocations" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:8001/invocations</a></span></pre><p id="ef05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要使用Python进行推理，您可以导入<strong class="is hj">请求</strong>库:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="8467" class="km kn hi ki b fi ko kp l kq kr">import requests<br/><br/>host = '0.0.0.0'<br/>port = '8001'<br/><br/>url = f'<a class="ae jx" rel="noopener ugc nofollow" target="_blank" href="/analytics-vidhya/{host}:{port}/invocations">http://{host}:{port}/invocations</a>'<br/><br/>headers = {<br/>    'Content-Type': 'application/json',<br/>}<br/><br/># test_data is a Pandas dataframe with data for testing the ML model<br/>http_data = test_data.to_json(orient='split')<br/><br/>r = requests.post(url=url, headers=headers, data=http_data)<br/><br/>print(f'Predictions: {r.text}')</span></pre><p id="be92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您按下Ctrl+C或退出终端时，<em class="ku"> mlflow模型服务于</em>命令。如果您希望模型启动并运行，您需要为它创建一个<strong class="is hj"> systemd </strong>服务。进入<strong class="is hj"> /etc/systemd/system </strong>目录，新建一个名为<strong class="is hj"> model.service </strong>的文件，内容如下:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="ef60" class="km kn hi ki b fi ko kp l kq kr">[Unit]<br/>Description=MLFlow Model Serving<br/>After=network.target<br/><br/>[Service]<br/>Restart=on-failure<br/>RestartSec=30<br/>StandardOutput=file:/path_to_your_logging_folder/stdout.log<br/>StandardError=file:/path_to_your_logging_folder/stderr.log<br/>Environment=MLFLOW_TRACKING_URI=<a class="ae jx" href="http://host_ts:port_ts" rel="noopener ugc nofollow" target="_blank">http://host_ts:port_ts</a><br/>Environment=MLFLOW_CONDA_HOME=/path_to_your_conda_installation<br/>ExecStart=/bin/bash -c 'PATH=/path_to_your_conda_installation/envs/model_env/bin/:$PATH exec mlflow models serve -m path_to_your_model -h host -p port'<br/><br/>[Install]<br/>WantedBy=multi-user.target</span></pre><p id="c820" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用以下命令激活并启用上述服务:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="ed7b" class="km kn hi ki b fi ko kp l kq kr">sudo systemctl daemon-reload<br/>sudo systemctl enable model<br/>sudo systemctl start model<br/>sudo systemctl status model</span></pre><p id="999f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的例子非常简单。对于像<a class="ae jx" href="https://github.com/tensorflow/models/tree/master/research/deeplab" rel="noopener ugc nofollow" target="_blank"> Deeplab </a>这样的复杂模型，需要在模型保存期间定义输入和输出张量。为此，考虑参考<a class="ae jx" href="https://www.tensorflow.org/tfx/guide/serving" rel="noopener ugc nofollow" target="_blank"> TF发球</a>。<a class="ae jx" href="https://www.freecodecamp.org/news/how-to-deploy-tensorflow-models-to-production-using-tf-serving-4b4b78d41700/" rel="noopener ugc nofollow" target="_blank">这篇博客</a>是使用TF上菜的<a class="ae jx" href="https://github.com/tensorflow/models/tree/master/research/deeplab" rel="noopener ugc nofollow" target="_blank"> Deeplab </a>模型上菜的好指南。</p><h1 id="72cd" class="kv kn hi bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">参考资料:</h1><p id="2a33" class="pw-post-body-paragraph iq ir hi is b it ls iv iw ix lt iz ja jb lu jd je jf lv jh ji jj lw jl jm jn hb bi translated"><a class="ae jx" href="https://thegurus.tech/posts/2019/06/mlflow-production-setup/" rel="noopener ugc nofollow" target="_blank">https://the gurus . tech/posts/2019/06/ml flow-production-setup/</a></p></div></div>    
</body>
</html>