<html>
<head>
<title>Watch your stock shares with Grafana and InfluxDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Grafana 和 InfluxDB 查看您的股票</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/watch-your-stock-shares-with-grafana-and-influxdb-4df7a99c6d64?source=collection_archive---------3-----------------------#2020-10-06">https://medium.com/analytics-vidhya/watch-your-stock-shares-with-grafana-and-influxdb-4df7a99c6d64?source=collection_archive---------3-----------------------#2020-10-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8c5f61d48561dc6e3a06863146e578bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uM9agGLCQHiCv4Tq"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">克里斯·利维拉尼在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="e1f9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">编辑(2022): </strong>这个项目现在是第三版，用的是现在的普罗米修斯 over Influx，但是很像。查看 Github 回购<a class="ae iu" href="https://github.com/pbrissaud/suivi-bourse" rel="noopener ugc nofollow" target="_blank">这里</a>！</p><p id="ab3d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我最近在股票市场上投资了不同的股票，并希望有一种方法来可视化它们的价格。我的银行的申请可能已经足够了，但人体工程学不在那里。俗话说，永远没有比你自己更好的服务，所以我决定做一个个性化的小应用！</p><h1 id="9117" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">系统结构</h1><p id="d165" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">为了满足需要，我需要四个主要特性:</p><ul class=""><li id="87c7" class="kw kx hi ix b iy iz jc jd jg ky jk kz jo la js lb lc ld le bi translated">读取包含我拥有的股票信息的文件的值(名称、缩写、拥有的数量、成本价)</li><li id="21e8" class="kw kx hi ix b iy lf jc lg jg lh jk li jo lj js lb lc ld le bi translated">定期检索这些股票的价格</li><li id="bc52" class="kw kx hi ix b iy lf jc lg jg lh jk li jo lj js lb lc ld le bi translated">将所有这些信息存储在数据库中</li><li id="0a96" class="kw kx hi ix b iy lf jc lg jg lh jk li jo lj js lb lc ld le bi translated">查看股票价格、总估价和收益(或损失)</li></ul><p id="c56e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我决定把后两点委托给现有技术:InfluxDB 和 Grafana。</p><p id="9931" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">InfluxDB 是一个时间序列数据库，这意味着它存储一组按时间顺序组织的值。它可以是服务器指标、应用程序性能监控、网络数据、传感器数据、事件等。但这也与我们的情况密切相关。</p><p id="6b63" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://grafana.com/oss/grafana/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>是一个可视化工具，允许您从不同的数据源生成仪表板，包括 InfluxDB。它可以创建许多数据显示(直方图，曲线等)。)</p><p id="f7e5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了这两个伟大的工具，我只需编写一个简单的 Python 脚本，从 API 获取数据并将其存储在 InfluxDB 数据库中。我选择使用<a class="ae iu" href="https://github.com/ranaroussi/yfinance" rel="noopener ugc nofollow" target="_blank"> yfinance </a>库，它使用 Yahoo！金融 API。</p><h1 id="c6cc" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">我们来编码吧！</h1><p id="5e2a" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">脚本很简单:在一个无限 while 循环下…</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/ac3d11da5a377bc39e93382f5c844a6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djEyuiT5iUFNYNKop99deg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">当您的工作包管理器在您的代码中看到一个无限循环时…</figcaption></figure><p id="d7a1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">…我打开一个 JSON 文件，其中包含我所拥有的股份的信息:名称、标识符、数量和成本价(平均购买价格)。然后，对于这个文件中包含的每个股票，我通过 yfinance 库请求股票的当前价格。最后，我必须将数据存储在我的 InfluxDB 数据库中。</p><p id="54a1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，事情大概是这样的:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="4b76" class="lu ju hi lq b fi lv lw l lx ly">import json<br/>import os<br/>import time<br/>import yfinance as yf<br/>from influxdb import InfluxDBClient<br/><br/><br/>class SuiviBourse:<br/>  def __init__(self):<br/>      self.influxdbClient = InfluxDBClient(<br/>        host=os.environ['INFLUXDB_HOST'],<br/>        port=os.environ['INFLUXDB_PORT'],<br/>        database=os.environ['INFLUXDB_DATABASE'])<br/><br/>  def run(self):<br/>    while True:<br/>      with open('/data/data.json') as data_file:<br/>        data = json.load(data_file)<br/>        for action in data:<br/>          ticker = yf.Ticker(action['sigle'])<br/>          history = ticker.history()<br/>          last_quote = (history.tail(1)['Close'].iloc[0])<br/>          json_body = [{<br/>              "measurement": "cours",<br/>              "tags": {<br/>                  "nom": action['nom']<br/>              },<br/>              "fields": {<br/>                  "price": last_quote<br/>              }<br/>          }, {<br/>              "measurement": "patrimoine",<br/>              "tags": {<br/>                  "nom": action['nom'],<br/>              },<br/>              "fields": {<br/>                  "quantite": action['patrimoine']['quantite'],<br/>                  "prix_revient":<br/>                  action['patrimoine']['prix_revient']<br/>              }<br/>          }]<br/>          self.influxdbClient.write_points(json_body)<br/>          time.sleep(10)<br/><br/><br/>if __name__ == "__main__":<br/>  suivi = SuiviBourse()<br/>  suivi.run()</span></pre><h1 id="10c4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">创建 Dockerfile 文件</h1><p id="1492" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">部署应用程序的时间到了，问题出现了:我如何让脚本一天 24 小时运行，并确保它即使在重启服务器后也能运行？</p><p id="f6fb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我的第一个想法是创建一个运行程序的 bash 脚本，并创建一个运行该脚本的 systemd 服务。这种想法虽然在技术上可行，但却是错误的。如果程序遇到任何问题，脚本就会停止，服务就会崩溃。此外，这个解决方案对于我这样的年轻工程师来说非常“老派”！</p><p id="0677" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Docker 容器似乎是一个更好的解决方案:除了自己重启(使用–restart unless-stopped 选项)之外，它还向物理主机提供 python 版本和库的封装。你还想要什么？</p><p id="fece" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我创建了一个 Dockerfile 文件来部署我的容器:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="8051" class="lu ju hi lq b fi lv lw l lx ly">FROM python:3.8<br/><br/>WORKDIR /usr/src/app<br/>COPY ./app/ .<br/><br/>RUN pip install pipenv<br/>RUN pipenv lock --requirements &gt; requirements.txt<br/>RUN pip install -r requirements.txt<br/><br/>COPY ./patchs_libs/base.py /tmp/base.py<br/>RUN cp /tmp/base.py /usr/local/lib/python3.8/site-packages/yfinance/base.py<br/>RUN rm /tmp/base.py<br/><br/>ENV INFLUXDB_HOST=suivi-bourse-influxdb<br/>ENV INFLUXDB_PORT=8086<br/>ENV INFLUXDB_DATABASE=bourse<br/><br/>VOLUME [ "/data" ]<br/><br/>CMD ["python3", "main.py"]</span></pre><p id="f30f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">说明:</strong></p><p id="7b0f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 6–8 行:使用 pipenv 安装不同的书商。</p><p id="4869" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 10–12 行:为 yfinance 库中的文件应用补丁。更多详情，可以看本期 Github。</p><p id="d937" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 14–16 行:创建连接到 InfluxDB 的环境变量和默认值。</p><p id="9e4c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 18 行:装载包含数据的 JSON 文件的卷。</p><p id="be5c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第 20 行:程序启动。</p><h1 id="7fb4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">组成堆栈</h1><p id="c655" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">创建 Docker 映像后，我必须用 docker-compose 创建完整的堆栈。我做了最简单的设置，就是“即插即用”</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="7413" class="lu ju hi lq b fi lv lw l lx ly">version: "3.8"<br/>services:<br/>  app:<br/>    container_name: suivi-bourse-app<br/>    build:<br/>      context: .<br/>      dockerfile: ./Dockerfile<br/>    volumes:<br/>      - ./data:/data<br/>  influxdb:<br/>    container_name: suivi-bourse-influxdb<br/>    image: "influxdb"<br/>    ports:<br/>      - "8086:8086"<br/>    environment:<br/>      - INFLUXDB_DB=bourse<br/>  grafana:<br/>    container_name: suivi-bourse-grafana<br/>    image: "grafana/grafana"<br/>    ports:<br/>      - "3000:3000"<br/>    volumes:<br/>      - ./grafana_provisioning:/etc/grafana/provisioning</span></pre><p id="7dca" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个配置编译前面看到的 Dockerfile 文件，安装并配置 InfluxDB 和 Grafana(数据源和仪表板的自动配置)。关于安装堆栈的更多信息，请访问我的<a class="ae iu" href="https://github.com/pbrissaud/suivi-bourse-app" rel="noopener ugc nofollow" target="_blank"> Github </a>上的 repo！</p><h1 id="60fc" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="d6df" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">成功安装后，我可以登录 Grafana 并查看我的仪表板:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/21ead7b9d5144a73796072b3528fe4d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xu_EobJAqc2ivesuaIhokg.png"/></div></div></figure><p id="05be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个小项目(用我的业余时间开发三四天)允许我重做一点 Python，并使用我的 Grafana 和时序数据库知识。如果你喜欢这个项目，随时分享和评论，我会回答你的所有问题。</p></div></div>    
</body>
</html>