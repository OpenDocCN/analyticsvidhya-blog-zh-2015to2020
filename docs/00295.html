<html>
<head>
<title>Hidden Gems of Spring and Spring Boot — ServiceLocatorFactory and /actuator/refresh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弹簧和Spring Boot的隐藏宝石—服务定位工厂和/执行器/更新</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/hidden-gems-of-spring-and-spring-boot-servicelocatorfactory-and-actuator-refresh-a02eadf37714?source=collection_archive---------0-----------------------#2019-03-15">https://medium.com/analytics-vidhya/hidden-gems-of-spring-and-spring-boot-servicelocatorfactory-and-actuator-refresh-a02eadf37714?source=collection_archive---------0-----------------------#2019-03-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a276" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题陈述</strong></p><p id="c04e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我设计的API基本上调用各种第三方API，如订餐、预订火车票、寻找免费停车场，并将响应返回给前端。通常情况下，供应商会不断变化。例如，对于订单食品，第三方供应商可以根据变更的合同从Zomato切换到Swiggy。(请注意，这些名称仅用作示例)。现在，对于点餐流程/任何其他流程的要求是</p><ol class=""><li id="6654" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">食品服务API应该作为一个接口，隐藏供应商的转换。</li><li id="ac28" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在食品服务供应商属性从Zomato配置更改为Swiggy配置的情况下，应该有一个运行时更改，而不需要重启应用程序。</li></ol><p id="8660" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于第一个需求，服务工厂设计模式是最适合的。为了满足第二个需求，spring cloud config server是最合适的。</p><p id="f330" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是Spring的服务工厂模式通过配置在不同的服务实现之间切换的步骤</p><p id="c374" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤1将服务定位器工厂bean添加到spring boot配置中</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="83bc" class="ka kb hi jw b fi kc kd l ke kf">@Bean</span><span id="7ea3" class="ka kb hi jw b fi kg kd l ke kf">public ServiceLocatorFactoryBean slfbForServiceFactory() {</span><span id="b0fd" class="ka kb hi jw b fi kg kd l ke kf">    ServiceLocatorFactoryBean bean = new ServiceLocatorFactoryBean();</span><span id="1ee2" class="ka kb hi jw b fi kg kd l ke kf">    bean.setServiceLocatorInterface(ServiceFactory.class);</span><span id="4b63" class="ka kb hi jw b fi kg kd l ke kf">    return bean;</span><span id="f033" class="ka kb hi jw b fi kg kd l ke kf">}</span></pre><p id="16cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤2创建一个接口FoodService以及FoodService的两个服务实现，如下所示。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="a15c" class="ka kb hi jw b fi kc kd l ke kf">public interface FoodService {</span><span id="8a08" class="ka kb hi jw b fi kg kd l ke kf">List&lt;StoreLocation&gt; findStores(LatLong location, double radiusInMeters) ;<br/></span><span id="f4bb" class="ka kb hi jw b fi kg kd l ke kf">}<br/></span><span id="153c" class="ka kb hi jw b fi kg kd l ke kf">@Service("ZomatoFoodService")<br/>public class ZomatoFoodService implements FoodService {<br/>}<br/></span><span id="3e51" class="ka kb hi jw b fi kg kd l ke kf">@Service("SwiggyFoodService")<br/>public class ZomatoFoodService implements FoodService {<br/>}</span></pre><p id="b63a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤3创建ServiceFactory。基本上，这是一个基于限定符给出服务实现实例的接口。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="f635" class="ka kb hi jw b fi kc kd l ke kf">public interface ServiceFactory {</span><span id="f8f8" class="ka kb hi jw b fi kg kd l ke kf">    FoodService getFoodService(String qualifier);</span><span id="9b9c" class="ka kb hi jw b fi kg kd l ke kf">   <br/>}</span></pre><p id="8fc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤4创建配置文件来传递服务实现的限定符名称。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="ad4f" class="ka kb hi jw b fi kc kd l ke kf">@Configuration</span><span id="209f" class="ka kb hi jw b fi kg kd l ke kf">@ConfigurationProperties(prefix = "service")</span><span id="1d79" class="ka kb hi jw b fi kg kd l ke kf">@Data<em class="kh">#lombok annotation</em></span><span id="e0c4" class="ka kb hi jw b fi kg kd l ke kf">public class ServiceConfig {<br/></span><span id="f0a1" class="ka kb hi jw b fi kg kd l ke kf">    String foodVendor;<br/></span><span id="6fe8" class="ka kb hi jw b fi kg kd l ke kf">}</span></pre><p id="4eec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤5在application.properties文件中添加属性及其值，如下所示。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="b0b8" class="ka kb hi jw b fi kc kd l ke kf">service.foodVendor = ZomatoFoodService</span></pre><p id="a8e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过以上步骤，我们已经使服务实现注入可配置。</p><p id="9af0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是你如何从控制器/任何你需要使用服务实现的类中引用你的食物服务。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="8b5c" class="ka kb hi jw b fi kc kd l ke kf">@RestController</span><span id="d81e" class="ka kb hi jw b fi kg kd l ke kf">public class FoodController {</span><span id="7d20" class="ka kb hi jw b fi kg kd l ke kf">    <br/>    @Autowiredprivate ServiceConfig serviceConfig;<br/></span><span id="cc57" class="ka kb hi jw b fi kg kd l ke kf">    @Autowiredprivate ServiceFactory serviceFactory;</span><span id="362c" class="ka kb hi jw b fi kg kd l ke kf">    private FoodService getFoodService() {</span><span id="d93a" class="ka kb hi jw b fi kg kd l ke kf">    return serviceFactory.getFoodService(serviceConfig.getFoodVendor());</span><span id="c5fe" class="ka kb hi jw b fi kg kd l ke kf">    }</span></pre><p id="c439" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过以上步骤，我们已经让服务实现切换属性文件的职责。现在剩下的就是将应用程序的属性外部化，然后在不重启应用程序的情况下刷新它们。这项工作是由spring配置服务器完成的。</p><p id="fa1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spring Cloud Config Server——Spring Cloud Config Server为外部配置(名称-值对或等效的YAML内容)提供了一个基于HTTP资源的API。通过使用@EnableConfigServer注释，服务器可嵌入到Spring Boot应用程序中。(这就是spring文档所陈述的)——我没有使用这个注释，而是使用了actuator来刷新。</p><p id="536a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在有两种方法可以实现spring config server——嵌入到微服务/独立服务中，为所有微服务提供配置。第二个可以作为单点故障，我们选择了第一个。</p><p id="1681" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Spring Cloud嵌入式配置服务器和/执行器/刷新</p><p id="9782" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第一步在你的gradle文件中添加spring cloud依赖，如下所示。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="840f" class="ka kb hi jw b fi kc kd l ke kf">ext {<br/>   set('springCloudVersion', 'Finchley.SR2')<br/>}</span><span id="31f8" class="ka kb hi jw b fi kg kd l ke kf">dependencyManagement {<br/>   imports {<br/>      mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"<br/>   }<br/></span><span id="64d2" class="ka kb hi jw b fi kg kd l ke kf">dependencies {</span><span id="576d" class="ka kb hi jw b fi kg kd l ke kf">implementation 'org.springframework.cloud:spring-cloud-config-server'</span><span id="7164" class="ka kb hi jw b fi kg kd l ke kf">}<br/>}</span></pre><p id="5ece" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤2:创建bootstrap.yml并添加以下属性。</p><p id="0ab2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想要直接从后端存储库(而不是从配置服务器)读取应用程序的配置，那么您基本上想要一个没有端点的嵌入式配置服务器。您可以通过不使用@EnableConfigServer批注来完全关闭端点(set spring . cloud . config . server . bootstrap = true)。</p><p id="04b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，我们没有使用以下属性，因为我们没有独立的配置服务器。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="1e4c" class="ka kb hi jw b fi kc kd l ke kf">spring.cloud.config.uri</span><span id="fe5b" class="ka kb hi jw b fi kg kd l ke kf">spring:<br/><em class="kh"># change the application name for your project name</em><br/>  application:<br/>    name: foodorder-api</span><span id="887f" class="ka kb hi jw b fi kg kd l ke kf">---<br/></span><span id="7ef3" class="ka kb hi jw b fi kg kd l ke kf">spring:<br/>  cloud:<br/>    config:<br/>      server:<br/>        bootstrap: true<br/>        git:<br/>          uri: <em class="kh">#ssh url of your git repo</em></span><span id="0f65" class="ka kb hi jw b fi kg kd l ke kf">          searchPaths: foodorder-api<br/>          username: <em class="kh"># put the username of git repo</em><br/>          password: <em class="kh"># put the password of git repo</em></span></pre><p id="9813" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将在Spring boot版本中添加属性，以启用除/health和/info之外的所有执行器端点。</p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="6052" class="ka kb hi jw b fi kc kd l ke kf"><em class="kh">#property to expose /actuator/refresh endpoint to expose embedded config server refresh</em><br/>management.endpoints.web.exposure.include=refresh<br/><em class="kh">#property to expose /actuator other end points disabled by default</em><br/>management.endpoints.web.exposure.include=*</span></pre><p id="e928" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过向应用程序的刷新端点发送一个空的HTTP POST来调用刷新执行器端点，<a class="ae ki" href="http://localhost:8080/actuator/refresh" rel="noopener ugc nofollow" target="_blank">HTTP://localhost:8080/Actuator/refresh</a></p><pre class="jr js jt ju fd jv jw jx jy aw jz bi"><span id="0ea4" class="ka kb hi jw b fi kc kd l ke kf">$ curl localhost:8080/actuator/refresh -d {} -H "Content-Type: application/json"</span></pre><p id="c3f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提示-</p><ol class=""><li id="e125" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">/refresh endpoint仅刷新那些用@ConfigurationProperties批注的属性。它不像@Value那样刷新那些属性。对于@Value，您需要在使用它的类中包含@RefreshScope。</li><li id="0a79" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">在pivotal cloud foundry上，现在配置服务器作为一项服务提供。</li><li id="8d3f" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">对于docker部署，确保可以从docker swarm访问git。请确保适当的证书也存在，因为我们使用ssh连接进行git结帐。</li></ol><p id="6e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参考资料:-</p><ol class=""><li id="0919" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae ki" href="https://cloud.spring.io/spring-cloud-config/multi/multi__spring_cloud_config_server.html" rel="noopener ugc nofollow" target="_blank">https://cloud . spring . io/spring-cloud-config/multi/multi _ _ spring _ cloud _ config _ server . html</a></li><li id="76ad" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">【https://spring.io/guides/gs/centralized-configuration/ T4】</li></ol></div></div>    
</body>
</html>