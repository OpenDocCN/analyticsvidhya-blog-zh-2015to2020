<html>
<head>
<title>Structurally awkward CSVs and how you can deal with them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">结构尴尬的CSV以及如何处理它们</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/structurally-awkward-csvs-and-how-you-can-deal-with-them-26e34285b48f?source=collection_archive---------16-----------------------#2020-01-27">https://medium.com/analytics-vidhya/structurally-awkward-csvs-and-how-you-can-deal-with-them-26e34285b48f?source=collection_archive---------16-----------------------#2020-01-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="98af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我作为数据科学家的生活中，我经常要处理CSV。有时候，当它们在系统和人之间来回传递时，它们的结构已经被破坏了。这里有一种方法可以让你处理这些问题，并在此过程中做一些数据探索。我选择用AWK的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/32de156755862f5a8ee5a06066ad0009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1WeuR9OoKyD5EvtT9KjXOA.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">照片由<a class="ae jt" href="https://unsplash.com/@mbaumi?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">米卡·鲍梅斯特</a>在<a class="ae jt" href="https://unsplash.com/s/photos/csv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7c80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我经常发现自己必须在尽可能短的时间内将结构受损的CSV转换成可用的数据集。这是因为我的客户并不总是有必要的专家、软件或时间来为我采购一个<em class="ju">干净的</em>版本。</p><p id="a02d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最重要的是，被销售的工具通常为那些一开始就有相对简单的解决方案的事物提供解决方案，这并不是说它们不提供价值。在本文中，我将向您展示如何处理在将数据加载到软件之前通常必须解决的问题类型。我称之为结构性问题。</p><p id="465b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我遇到的最常见的结构问题是:</p><ul class=""><li id="97f7" class="jv jw hi ih b ii ij im in iq jx iu jy iy jz jc ka kb kc kd bi translated">字节顺序标记</li><li id="c348" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">混合使用Windows和Linux换行</li><li id="acb1" class="jv jw hi ih b ii ke im kf iq kg iu kh iy ki jc ka kb kc kd bi translated">未隔离的外壳和外壳内的分离器</li></ul><p id="5447" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一个问题特别难处理，因为它将导致CSV被读取为某些行具有不同的列数。在本文中，我们将探索如何处理字节顺序标记和未转义的闭包以及闭包内的分隔符的简单方法。</p><p id="278b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我是从IT工程背景转到数据科学的，所以我最初用来帮助我处理结构性问题的工具在大多数系统上都是现成的。我发现的最有用的工具是AWK。还将显示其他命令。</p><p id="c15e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不会提供对AWK的完整介绍，而只是解释一些有用的代码片段。如果你想了解AWK的细节，我强烈建议你阅读文档，可以通过这个链接找到。</p><div class="kj kk ez fb kl km"><a href="https://www.gnu.org/software/gawk/manual/gawk.html#SEC_Contents" rel="noopener  ugc nofollow" target="_blank"><div class="kn ab dw"><div class="ko ab kp cl cj kq"><h2 class="bd hj fi z dy kr ea eb ks ed ef hh bi translated">GNU Awk用户指南</h2><div class="kt l"><h3 class="bd b fi z dy kr ea eb ks ed ef dx translated">这个文件记录了awk，一个可以用来选择文件中特定记录并对其执行操作的程序…</h3></div><div class="ku l"><p class="bd b fp z dy kr ea eb ks ed ef dx translated">www.gnu.org</p></div></div></div></a></div></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="07bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我用来说明你如何使用AWK的数据集是大都会艺术博物馆开放存取CSV，你可以在github上找到。</p><div class="kj kk ez fb kl km"><a href="https://github.com/metmuseum/openaccess/" rel="noopener  ugc nofollow" target="_blank"><div class="kn ab dw"><div class="ko ab kp cl cj kq"><h2 class="bd hj fi z dy kr ea eb ks ed ef hh bi translated">metmuseum/openaccess</h2><div class="kt l"><h3 class="bd b fi z dy kr ea eb ks ed ef dx translated">大都会艺术博物馆展示了来自世界各地超过5000年的艺术，供每个人体验和欣赏</h3></div><div class="ku l"><p class="bd b fp z dy kr ea eb ks ed ef dx translated">github.com</p></div></div><div class="lc l"><div class="ld l le lf lg lc lh jn km"/></div></div></a></div><p id="0198" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请下载一份拷贝到你选择的文件夹，如果默认情况下没有awk，请确保在你的系统上安装awk。我创建了数据集的副本，并将其命名为<em class="ju"> data.csv </em>。代码片段已经在AWS上运行的默认Ubuntu 18.04和我的Mac上运行的AWK 5.0.1上进行了测试。</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="9746" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从初步查看数据开始。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="7064" class="ln lo hi lj b fi lp lq l lr ls">head -20 data.csv | less -S</span></pre><p id="d1cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ju"> head -20 </em>命令从<em class="ju"> data.csv </em>文件中取出前20行，然后用<em class="ju">管道</em>将它们连接成一个名为<em class="ju"> less </em>的命令。S参数告诉<em class="ju"> less </em> it，我不想换行。这两个命令的结果是，我们现在可以看到最上面的20行，并且侧滚可以看到所有列的自然顺序。</p><p id="a627" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先突出的是以下内容:</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="e4de" class="ln lo hi lj b fi lp lq l lr ls"><strong class="lj hj">&lt;U+FEFF&gt;</strong></span></pre><p id="d1a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是字节顺序标记，通常是代码转换的结果。通常，您会在曾经有特定于区域设置的字符的地方看到这些字符，如德语<em class="ju">中的“、”或“”。</em>不幸的是没有办法恢复原来的性格。您可以选择保留字节顺序标记或删除它。每当我想要一个角色丢失的提醒时，我通常会选择保留它。当数据向消费者公开时，我会删除它，因为它有时会使用以下符号显示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lt"><img src="../Images/efd6ba2d5d140a882f9c2e65c56d9165.png" data-original-src="https://miro.medium.com/v2/resize:fit:220/format:webp/1*ML98fgU1oCNOnIb4ITyGWQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">字节顺序标记，也称为替换字符</figcaption></figure><p id="ed1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了摆脱它，你可以使用以下非常简单的AWK程序。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="f71a" class="ln lo hi lj b fi lp lq l lr ls">awk '{ gsub(/^\xef\xbb\xbf/,""); print }' data.csv &gt; data1.csv</span></pre><p id="32a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这段代码所做的是找到所有出现的字节顺序标记，用空值替换它们，从而删除它们。结果是<em class="ju">使用<em class="ju"> &gt; </em>将</em>重定向到一个名为<em class="ju"> data1.csv </em>的新文件中。</p><p id="6083" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们试着找出列名是什么。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="4102" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'NR==1{ gsub(/,/, "\n"); print }' data1.csv</span></pre><p id="7897" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将查看文件的第一行，并用换行符替换所有逗号，从而转置文件的第一行。</p><p id="156c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，我们可能想要了解我们正在处理多少列。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="dcdc" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'NR==1{ print NF }' data1.csv</span></pre><p id="89ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果应该是44列。<em class="ju"> NR==1 </em>告诉awk只查看第一行，<em class="ju"> NF </em>包含了<em class="ju">字段的数量</em>(在AWK的上下文中列被称为字段)。为了计算出文件包含多少行，我们可以使用下面的代码片段。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="614e" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'END{ print NR }' data1.csv</span></pre><p id="249e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ju">结束</em>告诉<strong class="ih hj"> AWK </strong>只在结束时运行这个，这时<em class="ju"> NR </em>包含行数。你应该得到583121 <strong class="ih hj">。</strong></p><p id="c847" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="ju">dirty</em>CSV中很常见的一点是，列包含自由文本数据，这可能导致它们包含分隔符和分隔符。这几乎是最糟糕的情况，因为它可能导致不可恢复的行，因为仅仅由于缩放或者由于分隔符和外壳的嵌套方式，可能没有办法重建原始列。让我们看看如何检测到这一点，并找到一种快速简单的方法来解决它。</p><p id="e3c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过比较每行检测到的列数来实现这一点。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="a5d3" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'NR&gt;1{ print NF }' data1.csv | sort | uniq -c | sort</span></pre><p id="83c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将打印每一行大于1的字段数。第一个<em class="ju"> sort </em>命令为我们的第二个命令<em class="ju"> uniq </em>进行排序，后者计算出现的次数，最后一个<em class="ju"> sort </em>命令最后对它们进行排列，这样我们就可以在输出的底部看到最大的列号。换句话说，这个命令的结果是两个数字，第二个告诉您计算了多少列，第一个告诉您计算了多少次。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lu"><img src="../Images/8ab449af45b49824a94ac95e99bf9d2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IJiuuh4ngpICcFbScxGXQw.png"/></div></div></figure><p id="365b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是个坏消息。我们似乎只有211行，正好是44列。请记住，我们之前在查看标题行时发现，我们应该有44列。</p><p id="59d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一个非常简单的技巧可以帮助我们找到更多的行。<strong class="ih hj"> AWK </strong>让你提供一个正则表达式来定义一个字段应该是什么样子。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="18b1" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'BEGIN{ FPAT="([^,]*)|(\"[^\"]+\")" } NR&gt;1{ print NF }' data1.csv | sort | uniq -c | sort</span></pre><p id="286e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如你所看到的，这是通过在我们的<strong class="ih hj"> AWK </strong>计划的开始定义FPAT来实现的。提供的正则表达式字面意思是:一个字段要么是<strong class="ih hj">任何不是逗号的内容</strong>，要么是<strong class="ih hj">一个双引号，任何不是双引号的内容，以及一个右双引号。</strong>这个超级有用的部分是直接从文档中摘录的，这也是我认为<strong class="ih hj"> AWK </strong>如此强大的一个重要原因。</p><div class="kj kk ez fb kl km"><a href="https://www.gnu.org/software/gawk/manual/html_node/Splitting-By-Content.html" rel="noopener  ugc nofollow" target="_blank"><div class="kn ab dw"><div class="ko ab kp cl cj kq"><h2 class="bd hj fi z dy kr ea eb ks ed ef hh bi translated">按内容拆分(《GNU Awk用户指南》)</h2><div class="kt l"><h3 class="bd b fi z dy kr ea eb ks ed ef dx translated">本节讨论gawk的一个高级特性。如果你是awk的新手用户，你可能想跳过它…</h3></div><div class="ku l"><p class="bd b fp z dy kr ea eb ks ed ef dx translated">www.gnu.org</p></div></div></div></a></div><p id="b7e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然FPAT的引入导致程序需要更多的时间来运行，但它也极大地改善了结果。我们现在应该总共计数380308行，44列。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lv"><img src="../Images/2c549baec15569cf00e37fb63b22189c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*WP8DvmAbRkTOSIRkTChqVQ.png"/></div></figure><p id="e638" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不幸的是，目前仍有许多行的状况不佳。我们可以在后续文章中研究如何尝试恢复其中一些。</p><p id="0533" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们把数据集分成一个干净的文件和一个脏文件，前者只包含44列的行，后者包含所有其他内容。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="77f3" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'BEGIN{ FPAT="([^,]*)|(\"[^\"]+\")" }; NF==44{ print }' data1.csv &gt; clean.csv</span><span id="03de" class="ln lo hi lj b fi lw lq l lr ls">awk -F "," 'BEGIN{ FPAT="([^,]*)|(\"[^\"]+\")" }; NF!=44{ print }' data1.csv &gt; dirty.csv</span></pre><p id="410f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在结束本文之前，让我们先来看几个可以帮助我们探索数据的技巧。</p><p id="3579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们首先显示干净文件的各个列，并用<em class="ju"> sort </em>和<em class="ju"> uniq </em>对它们进行总结。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="ffed" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'BEGIN{FPAT="([^,]*)|(\"[^\"]+\")" } NR&gt;1{ print $1 }' clean.csv | sort | uniq -c | sort</span></pre><p id="6d41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将显示第一列的内容，经过排序和计数。你可以通过<em class="ju">打印$2 </em>来查看列，以此类推。<em class="ju"> $0 </em>包含整行。</p><p id="edbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，这里有一个查看10个随机行的第5列的简洁方法。</p><pre class="je jf jg jh fd li lj lk ll aw lm bi"><span id="e232" class="ln lo hi lj b fi lp lq l lr ls">awk -F "," 'BEGIN{ FPAT="([^,]*)|(\"[^\"]+\")";<strong class="lj hj"> </strong>srand(); for (i = 1; i &lt;= 10; i++) a[int(380308 * rand())] } (NR in a) { print $5 }' clean.csv</span></pre><p id="80dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">确保正确指定总行数，在本例中为380308，否则代码可能会试图打印不存在的行。</p><p id="4882" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这是有帮助的，并为更深入地挖掘AWK提供了一些动力。</p></div></div>    
</body>
</html>