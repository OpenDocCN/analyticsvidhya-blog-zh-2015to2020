<html>
<head>
<title>Google Analytics Data Extraction using API in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python中的API提取Google Analytics数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/google-analytics-data-extraction-using-api-in-r-and-python-e0e5dcc5be88?source=collection_archive---------2-----------------------#2019-04-04">https://medium.com/analytics-vidhya/google-analytics-data-extraction-using-api-in-r-and-python-e0e5dcc5be88?source=collection_archive---------2-----------------------#2019-04-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/febccaec9e8691e665f81cae136818bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rM5vbSYWJSgvGgFsfzVkHA.png"/></div></div></figure><div class=""/><p id="e624" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://rb.gy/x52cle" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu"> <em class="jp">视频链接演示如何使用Python提取谷歌分析数据</em> </strong> </a></p><p id="1f85" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如今，数据科学家和数据分析师使用的一种通用语言是“Python”和“R ”,这两种语言用于转换可用数据，以获得关于扩展业务的宝贵见解。Google Analytics是数字营销领域用于查看报告的主要资源之一，但是，如果您需要深度分析(机器学习、深度学习、时间序列模型等。)R或Python可以用来提取Google Analytics中的数据</p><p id="8836" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">今天我将讲述通过Python中的API从Google Analytics中提取数据的步骤。</p><p id="263b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一步是在google开发者控制台中创建一个项目，获取<strong class="is hu">客户端id </strong>、<strong class="is hu">客户端机密</strong>，并启用<strong class="is hu"> Google分析报告API </strong>和<strong class="is hu">分析API </strong>。</p><p id="48a9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">演示如何创建项目的视频链接</em> ( <a class="ae jo" href="https://youtu.be/533nliQZWEg" rel="noopener ugc nofollow" target="_blank">在开发人员控制台</a>中创建项目)</p><p id="6995" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">获得客户端id和客户端密码后的下一步是身份验证。这一步包括从有权访问谷歌分析账户的gmail账户获得许可。此后，谷歌将提供一个独特的刷新令牌。使用唯一的刷新令牌，可以获得属于gmail帐户的Google analytics数据。</p><p id="b1e7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">导入以下库</em></p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="f69b" class="jz ka ht jv b fi kb kc l kd ke">from oauth2client.client import OAuth2WebServerFlow<br/>from oauth2client.tools import run_flow<br/>from oauth2client.file import Storage<br/>import json<br/>import os<br/>import re<br/>import httplib2 <br/>from oauth2client import GOOGLE_REVOKE_URI, GOOGLE_TOKEN_URI, client<br/>import requests<br/>import pandas as pd</span></pre><p id="aab6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">以下函数用于检查目录</em>中是否存在该文件</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="4ebc" class="jz ka ht jv b fi kb kc l kd ke">'''function check whether file exist in the path or not'''<br/><br/>def where_json(file_name):return os.path.exists(file_name)</span></pre><p id="58c2" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jp">以下函数用于获取刷新令牌</em></p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="6e16" class="jz ka ht jv b fi kb kc l kd ke">''' function return the refresh token '''<br/><br/>def get_refresh_token(client_id,client_secret):<br/>    CLIENT_ID = client_id<br/>    CLIENT_SECRET = client_secret<br/>    SCOPE = 'https://www.googleapis.com/auth/analytics.readonly'<br/>    REDIRECT_URI = 'http:localhost:8080'<br/>  <br/>    flow = OAuth2WebServerFlow(client_id=CLIENT_ID,client_secret=CLIENT_SECRET,scope=SCOPE,redirect_uri=REDIRECT_URI)<br/>    if where_json('credential.json')==False:<br/>       storage = Storage('credential.json') <br/>       credentials = run_flow(flow, storage)<br/>       refresh_token=credentials.refresh_token<br/>       <br/>    elif where_json('credential.json')==True:<br/>       with open('credential.json') as json_file:  <br/>           data         = json.load(json_file)<br/>       refresh_token=data['refresh_token']<br/>  <br/>    return(refresh_token)</span></pre><p id="b12a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">执行上述函数后，我们可以通过调用以下代码来获得刷新令牌。这里我们使用客户机id和客户机秘密，它们是在创建时从项目中获得的</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="0c06" class="jz ka ht jv b fi kb kc l kd ke">client_id = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'<br/>client_secret = 'XXXXXXXXXXXXXX'</span><span id="c200" class="jz ka ht jv b fi kf kc l kd ke">refresh_token=get_refresh_token(client_id,client_secret)</span></pre><p id="c094" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了访问google analytics数据的刷新令牌。然而，要访问这些数据，我们还需要一个参数，即特定google analytics帐户的视图id。</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kg"><img src="../Images/ea26717e4a517f22f39bb1df6dc7dffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGx5YZu3_pLstWfeIPE3_w.png"/></div></div></figure><p id="afe9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了客户机id、客户机密码、刷新令牌和视图id。谷歌分析数据可以通过使用以下函数获得</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="b44e" class="jz ka ht jv b fi kb kc l kd ke">''' function return the google analytics data for given dimension, metrics, start data, end data access token, type,goal number, condition'''<br/><br/>def google_analytics_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,goal_number,condition):<br/>    <br/>    viewID=viewID;dim=dim;met=met;start_date=start_date;end_date=end_date;refresh_token=refresh_token;transaction_type=transaction_type;condition=condition<br/>    goal_number=goal_number<br/>    viewID="".join(['ga%3A',viewID])<br/>    <br/>    if transaction_type=="Goal":<br/>        met1="%2C".join([re.sub(":","%3A",i) for i in met]).replace("XX",str(goal_number))<br/>    elif transaction_type=="Transaction":<br/>        met1="%2C".join([re.sub(":","%3A",i) for i in met])<br/>        <br/>    dim1="%2C".join([re.sub(":","%3A",i) for i in dim])<br/>    <br/>    if where_json('credential.json')==True:<br/>       with open('credential.json') as json_file:  <br/>           storage_data = json.load(json_file)<br/>       <br/>       client_id=storage_data['client_id']<br/>       client_secret=storage_data['client_secret']<br/>       credentials = client.OAuth2Credentials(<br/>                access_token=None, client_id=client_id, client_secret=client_secret, refresh_token=refresh_token,<br/>                token_expiry=3600,token_uri=GOOGLE_TOKEN_URI,user_agent='my-user-agent/1.0',revoke_uri=GOOGLE_REVOKE_URI)<br/><br/>       credentials.refresh(httplib2.Http())<br/>       rt=(json.loads(credentials.to_json()))['access_token']<br/>  <br/>       api_url="https://www.googleapis.com/analytics/v3/data/ga?ids="<br/>    <br/>       url="".join([api_url,viewID,'&amp;start-date=',start_date,'&amp;end-date=',end_date,'&amp;metrics=',met1,'&amp;dimensions=',dim1,'&amp;max-results=1000000',condition,'&amp;access_token=',rt])<br/>    <br/>       data=pd.DataFrame()<br/>    <br/>       try:<br/>         r = requests.get(url)<br/>                <br/>         try:<br/>            data=pd.DataFrame(list((r.json())['rows']),columns=[re.sub("ga:","",i) for i in dim+met])<br/>            data['date']=start_date<br/>            print("data extraction is successfully completed")<br/>           <br/>            return data<br/>         except:<br/>            print((r.json()))<br/>       except:<br/>         print((r.json()))<br/>         print("error occured in the google analytics reporting api data extraction")</span></pre><p id="1f6e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了提取数据的所有参数。这里我们需要记住，在传递维度(dim)和度量(met)时，你必须将它们作为一个列表来传递。</p><p id="b838" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有两个事务类型值，即事务或目标。如果交易类型为交易，则目标编号为“”(空白引号)。如果交易类型是目标，则目标编号是一个数值(例如:1，2，3，…，20)。因此，该条件按度量排序[例如:<em class="jp"> &amp; sort=-ga%3Ausers(按用户降序排序)，&amp; sort=-ga%3Ausers(按用户升序排序)，等等] </em></p><ul class=""><li id="efea" class="kh ki ht is b it iu ix iy jb kj jf kk jj kl jn km kn ko kp bi translated">场景1:当交易类型为“交易”且无条件时</li></ul><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="8316" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['ga:browser','ga:sourceMedium']<br/>met=['ga:users','ga:revenuePerTransaction']<br/>start_date='2019-01-01'<br/>end_date='2019-01-10'<br/>transaction_type='Transaction'<br/>goal_number=''<br/>refresh_token=refresh_token<br/>condition=''<br/><br/>data=google_analytics_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,goal_number,condition)</span></pre><p id="3ac5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kq"><img src="../Images/3360678a137cc3d30b23a29a377ae1a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K4IGqnpUKzJ6B7CR7mXevg.png"/></div></div></figure><ul class=""><li id="497f" class="kh ki ht is b it iu ix iy jb kj jf kk jj kl jn km kn ko kp bi translated">场景2:当交易类型为“交易”且有条件时</li></ul><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="53a9" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['ga:browser','ga:sourceMedium']<br/>met=['ga:users','ga:revenuePerTransaction']<br/>start_date='2019-01-01'<br/>end_date='2019-01-10'<br/>transaction_type='Transaction'<br/>goal_number=''<br/>refresh_token=refresh_token<br/>condition='&amp;sort=-ga%3Ausers' <em class="jp"># sort the data set by users in descending order</em><br/><br/>data=google_analytics_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,goal_number,condition)</span></pre><p id="ad59" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kr"><img src="../Images/ec07f56a40f89e2a4c509f4ef59835e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hdnsodXLzK-K08ByxYBuAQ.png"/></div></div></figure><ul class=""><li id="9e64" class="kh ki ht is b it iu ix iy jb kj jf kk jj kl jn km kn ko kp bi translated">场景3:当交易类型为“目标”且无条件时</li></ul><p id="1fa7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您已经在google analytics帐户中设置了目标，您可以访问。</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="f525" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['ga:browser','ga:sourceMedium']<br/>met=['ga:users','ga:goalXXCompletions']<br/>start_date='2019-01-01'<br/>end_date='2019-01-10'<br/>transaction_type='Goal'<br/>goal_number=''<br/>refresh_token=refresh_token<br/>condition=''<br/><br/>data=google_analytics_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,goal_number,condition)</span></pre><p id="eabf" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出如下所示</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ks"><img src="../Images/74b1e2a81e1cbe3228e2eeefa225ce12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_jl6CvcU7O16YLrP9Xs6A.png"/></div></div></figure><ul class=""><li id="bd51" class="kh ki ht is b it iu ix iy jb kj jf kk jj kl jn km kn ko kp bi translated">场景4:当交易类型为“目标”且有条件时</li></ul><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="3cf3" class="jz ka ht jv b fi kb kc l kd ke">viewID='XXXXXXXX'<br/>dim=['ga:browser','ga:sourceMedium']<br/>met=['ga:users','ga:goalXXCompletions']<br/>start_date='2019-01-01'<br/>end_date='2019-01-10'<br/>transaction_type='Goal'<br/>goal_number='1'<br/>refresh_token=refresh_token<br/>condition='&amp;sort=-ga%3Ausers' <br/><em class="jp"># sort the data set by users in descending order</em><br/><br/>data=google_analytics_reporting_api_data_extraction(viewID,dim,met,start_date,end_date,refresh_token,transaction_type,goal_number,condition)</span></pre><p id="bbb0" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出将如下</p><figure class="jq jr js jt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kt"><img src="../Images/3493fbd492c6b2a9b5f1d3e9610abca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bJOPgNJ3yi1tXzb3dYDQOA.png"/></div></div></figure><p id="f503" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请点击链接浏览通过谷歌分析提取数据的指南。<a class="ae jo" href="https://www.youtube.com/watch?v=UVxkn8Ynbbs" rel="noopener ugc nofollow" target="_blank">如何用Python提取谷歌分析数据</a></p></div></div>    
</body>
</html>