<html>
<head>
<title>Deploying Yolo on Tensorflow Serving: Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Tensorflow服务器上部署Yolo:第2部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-yolo-on-tensorflow-serving-part-2-4ecd5edbe776?source=collection_archive---------14-----------------------#2020-07-19">https://medium.com/analytics-vidhya/deploying-yolo-on-tensorflow-serving-part-2-4ecd5edbe776?source=collection_archive---------14-----------------------#2020-07-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="9695" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" rel="noopener" href="/@gauravgola/deploying-yolo-on-tensorflow-serving-part-1-4586f97f0dd9"> <strong class="ih hj">第1部分</strong> </a> <strong class="ih hj">，</strong>中，我们实际学习了如何将Yolo权重导出为TF serving保存的模型格式，检查保存的模型，并在本地机器上启动服务器。我们还观察到托管TF服务的输出是一种特殊形状的张量，不能直接在服务器上使用，因此我们需要在它上面添加一个后处理脚本。</p><p id="ffe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">代码概述</strong></p><p id="4c77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过详细分析<a class="ae jd" href="https://github.com/thtrieu/darkflow" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">暗流</strong> </a> <strong class="ih hj">的代码库。</strong>我发现当我们从<a class="ae jd" href="https://github.com/thtrieu/darkflow/blob/master/darkflow/net/flow.py" rel="noopener ugc nofollow" target="_blank">代码</a>中调用<strong class="ih hj"> return_predict() </strong>时，它实际上是从<a class="ae jd" href="https://github.com/thtrieu/darkflow/blob/master/darkflow/cython_utils/cy_yolo2_findboxes.pyx" rel="noopener ugc nofollow" target="_blank"> cython模块</a>中调用<strong class="ih hj"> cython </strong>帮助函数。</p><p id="09af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个代码其实在核心算<strong class="ih hj">非最大抑制。</strong> <em class="je"> YOLO使用非最大抑制(NMS)只保留最佳包围盒。NMS的第一步是移除所有检测概率小于给定NMS阈值的预测边界框。并且在得到具有超过某个阈值的盒子之后，它计算所有预测的盒子</em> <strong class="ih hj"> <em class="je">的</em> <strong class="ih hj"> <em class="je">交集并(IOU) </em> </strong> <em class="je">。</em> </strong> <a class="ae jd" href="https://gist.github.com/gauravgola96/06ab080e11bd0048843dc4f3cf004326" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> <em class="je">后置处理代码</em> </strong> </a></p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="24f2" class="jo jp hi jk b fi jq jr l js jt">def box_contructor(meta,out,threshold ):<br/>    <em class="je">'''<br/>    :param meta: meta file .cfg<br/>    :param out: Image tensor from tf serving<br/>    :param threshold: Threshold for prediction (present in models.py)<br/>    :return: boxes of obejct detected<br/>    '''<br/>    </em>H, W, _ = meta['out_size']<br/>    C = meta['classes']<br/>    B = meta['num']<br/>    net_out = out.reshape([H, W, B, int(out.shape[2] / B)])<br/><br/>    Classes = net_out[:, :, :, 5:]<br/><br/>    Bbox_pred = net_out[:, :, :, :5]<br/>    probs = np.zeros((H, W, B, C), dtype=np.float32)<br/><br/>    anchors = np.asarray(meta['anchors'])<br/><br/>    for row in range(H):<br/>        for col in range(W):<br/>            for box_loop in range(B):<br/>                arr_max = 0<br/>                sum = 0;<br/>                Bbox_pred[row, col, box_loop, 4] = expit(Bbox_pred[row, col, box_loop, 4])<br/>                Bbox_pred[row, col, box_loop, 0] = (col + expit(Bbox_pred[row, col, box_loop, 0])) / W<br/>                Bbox_pred[row, col, box_loop, 1] = (row + expit(Bbox_pred[row, col, box_loop, 1])) / H<br/>                Bbox_pred[row, col, box_loop, 2] = exp(Bbox_pred[row, col, box_loop, 2]) * anchors[2 * box_loop + 0] / W<br/>                Bbox_pred[row, col, box_loop, 3] = exp(Bbox_pred[row, col, box_loop, 3]) * anchors[2 * box_loop + 1] / H<br/>                # SOFTMAX BLOCK, no more pointer juggling<br/><br/>                for class_loop in range(C):<br/>                    arr_max = max(arr_max, Classes[row, col, box_loop, class_loop])<br/><br/>                for class_loop in range(C):<br/>                    Classes[row, col, box_loop, class_loop] = exp(Classes[row, col, box_loop, class_loop] - arr_max)<br/>                    sum += Classes[row, col, box_loop, class_loop]<br/><br/>                for class_loop in range(C):<br/>                    tempc = Classes[row, col, box_loop, class_loop] * Bbox_pred[row, col, box_loop, 4] / sum<br/><br/>                    if (tempc &gt; threshold):<br/>                        probs[row, col, box_loop, class_loop] = tempc<br/><br/>    return NMS(np.ascontiguousarray(probs).reshape(H * W * B, C), np.ascontiguousarray(Bbox_pred).reshape(H * B * W, 5))</span></pre><p id="b03a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Yolo助手类</strong></p><p id="2781" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为Yolo TF服务的预处理、预测和后处理编写助手类。这个类将帮助处理来自服务器的输入图像，从TF服务器获得预测，并返回输出标签作为响应</p><figure class="jf jg jh ji fd ju"><div class="bz dy l di"><div class="jv jw l"/></div></figure><p id="39f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> API : </strong></p><p id="0cab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个小API，用于调用我在上一节中编写的TF serving hosted model和YoloHelperClass。使用Fastapi作为web框架，因为它的快速性能和异步支持可以帮助您在未来扩展您的服务。</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="fd5d" class="jo jp hi jk b fi jq jr l js jt">app = FastAPI(title="Yolov2 Deployment")<br/><br/><br/>@app.get("/ping", status_code=200, summary=" Liveliness Check ")<br/>async def ping():<br/>    return {"ping": "pong"}<br/><br/><br/>@app.post("/v1/predict", status_code=200)<br/>async def predict(image: UploadFile = File(...)):<br/>    img_read = image.file._file.read()<br/>    img = cv2.imdecode(np.fromstring(img_read, np.uint8), cv2.COLOR_RGB2BGR)<br/>    pre_img = yolohelper.preprocess(img)<br/>    predict_img = yolohelper.predict(pre_img)<br/>    return predict_img<br/></span></pre><p id="da8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结果:</strong>这个API的响应将是一个概率最大的类。您可以在<strong class="ih hj"> YoloHelperClass中更改响应的性质。</strong></p><figure class="jf jg jh ji fd ju er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es jx"><img src="../Images/f95f5b5c42dcd53982d4c57a81ed2f11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Hcb5riJJwOWsufLS7KvoaQ.gif"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">Fastapi swagger</figcaption></figure><p id="a3dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="411a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从两篇系列博客中，我们看到了如何将您的TF模型导出到TF serving保存的模型，并在TF serving上托管它。我们编写了一个小的API和helper类来对TF服务输出执行后处理，并以最大概率获得预测的类。</p><p id="8c56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一部分</strong> : <a class="ae jd" rel="noopener" href="/@gauravgola/deploying-yolo-on-tensorflow-serving-part-1-4586f97f0dd9">环节</a></p><blockquote class="ki kj kk"><p id="d642" class="if ig je ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">在<a class="ae jd" href="https://www.linkedin.com/in/gaurav-gola96/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Linkedin </strong> </a> <strong class="ih hj">和</strong><a class="ae jd" href="https://www.youtube.com/channel/UC3zK1Iuw2Rufxu8TKeyj4GQ" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Youtube</strong></a><strong class="ih hj">上跟我连线。</strong></p><p id="5455" class="if ig je ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">本项目github:<a class="ae jd" href="https://github.com/gauravgola96/Yolo_deployment" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">链接</strong> </a></p></blockquote></div></div>    
</body>
</html>