<html>
<head>
<title>Image Classification With Ease Using Fastai</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Fastai轻松进行图像分类</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/image-classification-with-ease-using-fastai-71d491d42f44?source=collection_archive---------25-----------------------#2020-04-05">https://medium.com/analytics-vidhya/image-classification-with-ease-using-fastai-71d491d42f44?source=collection_archive---------25-----------------------#2020-04-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3d9c0672acddfe5ca55de81401aabd51.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*I9kLGv5FVdZNXVaFwRAQXg.jpeg"/></div></div></figure></div><div class="ab cl iq ir gp is" role="separator"><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv iw"/><span class="it bw bk iu iv"/></div><div class="hb hc hd he hf"><p id="9319" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">完整的笔记本可从<a class="ae jv" href="https://colab.research.google.com/drive/1-e-HXyRA1fiROQALhFJHYeIB5ypSdTv2" rel="noopener ugc nofollow" target="_blank">这里</a>获得</p><p id="2c56" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我正在做Fastai的<a class="ae jv" href="https://course.fast.ai/" rel="noopener ugc nofollow" target="_blank">程序员实用深度学习v3 </a>中关于实用深度学习的课程。它是在线moocs格式的，非常棒。</p><p id="420a" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这个课程是关于他们在pytorch上建立的fastai库的。从一开始，他们就用深度学习弄脏了我们的手。他们遵循自上而下的方法。</p><p id="04ae" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我有一些使用pytorch的经验，所以我知道我必须写多少行代码，从准备数据加载器或数据迭代器到训练模型，但是在fastai中只有几行。我喜欢它，在这篇文章中，我将展示如何在经典的<a class="ae jv" href="https://www.kaggle.com/biaiscience/dogs-vs-cats" rel="noopener ugc nofollow" target="_blank">狗对猫</a>数据集上使用迁移学习进行图像分类。</p><h1 id="c8c0" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><em class="ku"> 1。设置</em></h1><p id="0640" class="pw-post-body-paragraph ix iy hi iz b ja kv jc jd je kw jg jh ji kx jk jl jm ky jo jp jq kz js jt ju hb bi translated">安装fastai非常容易。如果您正在使用anaconda环境，那么</p><p id="e6ad" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">你可以用</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="ac0b" class="lj jx hi lf b fi lk ll l lm ln">conda install -c pytorch -c fastai fastai</span></pre><p id="c44a" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">或者你想用pip</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="f3dc" class="lj jx hi lf b fi lk ll l lm ln">pip install fastai</span></pre><p id="e6cf" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">会为你工作。</p><p id="5251" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这两个命令将安装最新的pytorch-gpu版本以及最新的cuda-toolkit。</p><p id="ea88" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">Fastai非常有效地使用GPU，因此如果你有一个好的GPU，它将运行得很好，否则最好的选择是<a class="ae jv" href="https://colab.research.google.com/" rel="noopener ugc nofollow" target="_blank"> GOOGLE COLAB </a>，它是免费的，提供良好的GPU，并且没有使用限制。我有一个GTX-1050，所以它对resnet 50之前的基本东西很好，但为了更好的架构，我切换到colab。</p><h1 id="2bcb" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">2.导入数据集并对其进行处理以进行模型定型</h1><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="b612" class="lj jx hi lf b fi lk ll l lm ln">import os<br/>os.environ['KAGGLE_USERNAME'] = "your username"<br/>os.environ['KAGGLE_KEY'] = "your unique key"<br/>!kaggle datasets download -d biaiscience/dogs-vs-cats</span></pre><p id="dbcd" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这将把数据集从kaggle下载到colab workspace。狗对猫数据集有25000幅训练图像和12500幅测试图像。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="0aeb" class="lj jx hi lf b fi lk ll l lm ln">import fastai<br/>from fastai.vision import *<br/>path='train/train/'<br/>fnames = np.array([f'train/train/{f}' for f in sorted(os.listdir(f'{path}'))])<br/>tfms=get_transforms()<br/>def get_labels(file_path):<br/>     return 'cat' if 'cat' in str(file_path) else 'dog'<br/>data=ImageDataBunch.from_name_func(f'{path}train',label_func=get_labels,fnames=fnames, ds_tfms=tfms, size=224)</span></pre><p id="be08" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这几行代码将导入库，为图像准备转换，并创建一个图像数据库。数据集中就像数据加载器。</p><p id="cd14" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们可以通过键入以下命令来显示当前的类</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="427b" class="lj jx hi lf b fi lk ll l lm ln">data.classes</span></pre><p id="739d" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这会输出一个标签列表</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="b3b5" class="lj jx hi lf b fi lk ll l lm ln">[‘cat’, ‘dog’]</span></pre><p id="3cc5" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们也可以通过使用</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="7278" class="lj jx hi lf b fi lk ll l lm ln">data.show_batches(rows=3,figsize=(5,5))</span></pre><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/0be592ef969763b5dae1b8e7e8088781.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/1*npa5cbSmY1qYVyjDVLhowQ.png"/></div><figcaption class="lp lq et er es lr ls bd b be z dx translated">用于训练的一批图像</figcaption></figure><h1 id="f490" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">3.模特培训</h1><p id="fae4" class="pw-post-body-paragraph ix iy hi iz b ja kv jc jd je kw jg jh ji kx jk jl jm ky jo jp jq kz js jt ju hb bi translated">我们可以只用一行代码创建一个CNN模型</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="df21" class="lj jx hi lf b fi lk ll l lm ln">learn=cnn_learner(data,models.resnet50,metrics=[accuracy,error_rate])</span></pre><p id="2854" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">Fastai支持从resnets、vgg到densenets的许多预训练架构。我们还可以创建定制的架构。</p><p id="bcd2" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">为了拟合模型，我们使用fit_one_cycle()</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="75d9" class="lj jx hi lf b fi lk ll l lm ln">learn.fit_one_cycle(4)</span></pre><p id="fc99" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这将在训练图像上训练模型的最后一层。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/70085a29555ac3f9dab301dd1c4cfc88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*yO0Hq7Jd_FVvHxBrVsEdYQ.png"/></div></figure><p id="1b18" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">即使有冻结层，我们也能在仅仅4个时期内获得非常好的精度。我们可以在这里节省重量</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="9c6c" class="lj jx hi lf b fi lk ll l lm ln">learn.save('stage-1')</span></pre><p id="0dd3" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们可以通过解冻来进一步提高模型的准确性。解冻有助于训练模型的所有层。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="170d" class="lj jx hi lf b fi lk ll l lm ln">learn.unfreeze()</span></pre><p id="c36b" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">在训练任何深度学习模型时，设置学习率是非常重要的。</p><p id="bb61" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">Fastai也有用于此目的的API。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="e11c" class="lj jx hi lf b fi lk ll l lm ln">learn.lr_find()<br/>learn.recorder.plot()</span></pre><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/aa4e5cc8b1092ddb92fa3ce7bbc477ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Db2HGM9OrU6dcvwiVcabQ.png"/></div></div></figure><p id="79ca" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">当损失急剧减少时，我们应该选择一个学习率。我们将使用相同的fit_one_cycle api为所有层进一步训练2个周期。</p><p id="11c4" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这进一步提高了我们的准确性。</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lv"><img src="../Images/931a69c50f16694d1fa54bb00d5e62ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*U3C6y6dSTQAzqaX1TXET-g.png"/></div></figure><p id="fd32" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们的准确率甚至超过了kaggle竞赛中的前3名</p><figure class="la lb lc ld fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/8f457c0fef24b4e70eab83ebf75c6ce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eRFyBPrmJqrtaVpaMb9lDQ.png"/></div></div><figcaption class="lp lq et er es lr ls bd b be z dx translated"><a class="ae jv" href="https://www.kaggle.com/c/dogs-vs-cats/leaderboard" rel="noopener ugc nofollow" target="_blank">https://www.kaggle.com/c/dogs-vs-cats/leaderboard</a></figcaption></figure><p id="02f7" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们还可以看到分类报告和验证集中最容易混淆的案例</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="61c6" class="lj jx hi lf b fi lk ll l lm ln">interp = ClassificationInterpretation.from_learner(learn)<br/>interp.plot_confusion_matrix(figsize=(12,12), dpi=60)<br/>interp.most_confused()</span></pre><p id="4fc5" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">它输出</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="e186" class="lj jx hi lf b fi lk ll l lm ln">[(‘cat’, ‘dog’, 21), (‘dog’, ‘cat’, 8)]</span></pre><p id="b4ba" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">和</p><figure class="la lb lc ld fd ij er es paragraph-image"><div class="er es lx"><img src="../Images/3665d1ba62471989b70c3d0a8180514c.png" data-original-src="https://miro.medium.com/v2/resize:fit:714/format:webp/1*qgo_ar1IWvYEFwZiTWei1g.png"/></div></figure><p id="c661" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们的模型运行得非常好，所以我们可以用它来预测。</p><h1 id="9e85" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">4.推理</h1><p id="4cc3" class="pw-post-body-paragraph ix iy hi iz b ja kv jc jd je kw jg jh ji kx jk jl jm ky jo jp jq kz js jt ju hb bi translated">我忘了将测试图像添加到我们的数据集中，所以我们现在将在导出之前完成它。</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="915a" class="lj jx hi lf b fi lk ll l lm ln">test=ImageList.from_folder('./test/test')<br/>data.add_test(test)</span></pre><p id="94dd" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">我们现在可以使用训练好的模型来预测测试图像。我们将使用两个图像，一个为猫，一个为狗。预测的语法是</p><pre class="la lb lc ld fd le lf lg lh aw li bi"><span id="1f40" class="lj jx hi lf b fi lk ll l lm ln">learn.predict(img)</span></pre><div class="la lb lc ld fd ab cb"><figure class="ly ij lz ma mb mc md paragraph-image"><img src="../Images/2e52f486559ec62905bc0767f0d575dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:448/format:webp/1*bNTX7mdnXnqVKmQLB04llA.png"/></figure><figure class="ly ij me ma mb mc md paragraph-image"><img src="../Images/c83f761e352d1ab3a7a5b65625c1c6bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*cjyQW7N0zFry_M7gDWftaw.jpeg"/><figcaption class="lp lq et er es lr ls bd b be z dx mf di mg mh translated">(类别狗，张量(1)，张量([1.7682e-07，1.0000e+00])(类别猫，张量(0)，张量([9.9987e-01，1.2751e-04]))</figcaption></figure></div><p id="3a83" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">所以我们的模型正确地预测了这两只宠物。</p><h1 id="b812" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">5.结论</h1><p id="048e" class="pw-post-body-paragraph ix iy hi iz b ja kv jc jd je kw jg jh ji kx jk jl jm ky jo jp jq kz js jt ju hb bi translated">Fastai是一个非常容易使用的库，用于从计算机视觉到自然语言处理的各种深度学习应用，它还有一个<a class="ae jv" href="https://forums.fast.ai/" rel="noopener ugc nofollow" target="_blank">活跃社区</a>。</p><p id="9ddf" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">它的最新课程将于今年7月推出，他们的图书馆也将更新。</p><p id="ed6a" class="pw-post-body-paragraph ix iy hi iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju hb bi translated">这是我第一次写中型文章。请给一个反馈，以便我可以改进，如果你喜欢它，请鼓掌。</p></div></div>    
</body>
</html>