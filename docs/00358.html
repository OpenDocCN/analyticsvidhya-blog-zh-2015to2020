<html>
<head>
<title>Automate DEVOPS tasks using Lambda and JIRA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lambda和JIRA自动执行开发运维任务</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automate-devops-tasks-using-lambda-and-jira-29b9eea415fd?source=collection_archive---------0-----------------------#2019-04-23">https://medium.com/analytics-vidhya/automate-devops-tasks-using-lambda-and-jira-29b9eea415fd?source=collection_archive---------0-----------------------#2019-04-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c761" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">“值++”</strong></p><p id="80d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TechOps团队的一名工程师创造了这个术语。它引用了各种编码语言中“增量”的简写操作符。这也是我们作为一个团队应该做的事的座右铭…总是增加价值。</p><p id="b95f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我们日常运营中的一些重要的<strong class="ih hj">“价值”——</strong></p><ul class=""><li id="cf23" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">回答没有描述的吉拉门票</li><li id="9a35" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">"客户有问题B "..但是这句话中省略了客户名称和问题细节</li><li id="c16d" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">手动做事情，一遍又一遍</li></ul><p id="86ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的公司，TechOps团队的大部分任务都是以JIRA门票的形式出现的。新的应用程序可能已经准备好进行部署。客户帐户需要重命名。我们还必须处理运营任务，例如将新客户帐户从演示环境转移到生产环境。</p><p id="0401" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我总是想通过自动失业来提高效率。所以我开始通过AWS Lambda函数、API调用和JIRA票证来自动化我们的部分DevOps任务。这使得团队不仅可以跟踪队列中出现的现有任务，还可以将时间花在更重要的事情上。</p><p id="1124" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">【超值++】</strong></p><h1 id="bad1" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">项目和问题类型</h1><p id="437b" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">为了将任务与其他项目区分开来，我们首先必须锁定特定的JIRA项目和<a class="ae ku" href="https://confluence.atlassian.com/adminjiracloud/issue-types-844500742.html" rel="noopener ugc nofollow" target="_blank">问题类型</a>，为我们想要自动化的每个任务创建一个单独的问题类型。这不仅使事情易于组织，而且允许我们锁定谁可以或不可以制作特定的门票。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/1a1a55d238d7dc3cf75375b2fa41291c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4zYkL0XsMxxJ_FBb"/></div></div></figure><p id="6063" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇博客中，我们将回顾一个更简单的用例:自动执行帐户重命名。</p><h1 id="f7dd" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">简单的愚蠢</h1><p id="509c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这张粗糙的图表展示了我们所做的基本工作。Lambda函数由设置为每5分钟运行一次的CloudWatch事件规则触发。该函数将调用JIRA API来检索票据列表。使用这些票证，我们将获取必要的信息，并对基础架构中的后端服务进行后续API调用，以执行特定的操作…例如重命名。Lambda还会在任务完成后主动更新并关闭票证。我们需要做的第一件事是知道要找什么票。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lh"><img src="../Images/9066b8f17650dc7aaf67f724da5cd004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wiNfB0Olk-iM_QVe"/></div></div></figure><h1 id="4816" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">从Lambda查询JQL</h1><p id="33d8" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">JIRA查询语言(JQL)是在JIRA搜索问题的最灵活的方式之一。我们使用JIRA REST API的JQL查询来查找问题类型为“帐户重命名”的特定未结票据。这将返回相关票据的列表。</p><pre class="kw kx ky kz fd li lj lk ll aw lm bi"><span id="ba85" class="ln js hi lj b fi lo lp l lq lr">endpoint = “https://jira_url/rest/api"<br/> jql_issuetype = “issuetype=’Account Rename’”<br/> jql_project = “project=’TechOps Request’”<br/> status = “status=Open”<br/> jql = (“jql=” + jql_project +<br/> “+AND+” + jql_issuetype +<br/> “+AND+” + status<br/> )<br/> r = session.get(endpoint + “/2/search?” + jql % locals(), headers=headers_jira)<br/> response = json.loads(r.text)<br/> for issues in response[“issues”]:<br/> customer = issues[“fields”][“customfield_10001”]<br/> target_name = issues[“fields”][“customfield_14673”]</span></pre><p id="eab1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以开放票据列表为例，我们需要能够从中收集重要的信息，其中一些是定制字段的形式。</p><h1 id="cb2d" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">自定义字段</h1><p id="dab3" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">自定义字段由用户创建，默认情况下在吉拉中找不到。对于我们的特定用例，我们创建了几个字段，如<strong class="ih hj">客户名称</strong>、<strong class="ih hj">目标名称</strong>和<strong class="ih hj">重命名日期。</strong>从上面的代码示例中，您可以看到在JIRA API中，您不能只指定字段的名称，您需要添加一个<em class="ls"> customfield_id </em>。你可以通过这个网址得到一个列表</p><p id="b208" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ku" href="https://jira_url/rest/api/2/field" rel="noopener ugc nofollow" target="_blank">https://jira _ URL/rest/API/2/field</a></p><p id="0bd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">专业提示…如果你不想看难看的json页面，你也可以进入高级JIRA搜索栏，输入域名。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es lt"><img src="../Images/9255bf58bdf0d7ab7322c389cff31db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*nsH6ZdsJcGLbTBwR"/></div></figure><p id="9367" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">“值++”</strong></p><h1 id="8ad3" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">事件驱动计算…大多数时候</h1><p id="5023" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">通常，当我们在Lambda上构建应用时，我们会有Lambda函数和事件源之类的组件。事件源是AWS中的一项服务，它发布将由Lambda函数中的代码处理的事件。在这种情况下，在创建JIRA票证时执行重命名可以用<a class="ae ku" href="https://confluence.atlassian.com/adminjiracloud/advanced-workflow-configuration-776636620.html#Advancedworkflowconfiguration-postfunctions" rel="noopener ugc nofollow" target="_blank"> post函数</a>和<a class="ae ku" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> API网关来处理。</a>但是，客户有自己的维护窗口和帐户重命名的首选时间。有时，客户可能希望在周六凌晨4点……在我的个人维护(睡眠)窗口期间进行账户重命名。作为一种变通方法，我们决定使用一个<a class="ae ku" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/RunLambdaSchedule.html" rel="noopener ugc nofollow" target="_blank"> cloudwatch事件作为lambda调度器</a>。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lu"><img src="../Images/2b3dac7fa1ab2a5aa5d9f0e6d2729dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jSsazbyRqJMIXsoo"/></div></div></figure><pre class="kw kx ky kz fd li lj lk ll aw lm bi"><span id="80a3" class="ln js hi lj b fi lo lp l lq lr">today = datetime.datetime.today() — datetime.timedelta(hours=7)<br/> desired_date = datetime.datetime.strptime(issues[“fields”][“customfield_16105”].replace(“-0700”,””), “%Y-%m-%dT%H:%M:%S.%f”)<br/> if today &gt; desired_date:<br/> create_rename(customer, target_name)</span></pre><p id="91e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的Cloudwatch事件将每5分钟运行一次，触发我们的lambda函数。该函数将首先检查当前时间是否超过了我们从自定义字段<strong class="ih hj">重命名日期</strong>解析的值(参见上面的代码)，只有这样我们才会允许该函数继续运行。</p><h1 id="a6b7" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">把所有的放在一起</h1><p id="cd8c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">至此，我们已经收集了我们需要的信息。我们能够对后端微服务进行API调用来执行重命名(该代码不会在本博客中显示)。然而，我们也想把JIRA票当作一个状态文件。我们不想一次又一次地抢同一个开放票。在这里，我们希望使用另一个JIRA API调用将票据移动到不同的工作流步骤(例如，从“打开”到“进行中”)。然而，就像定制字段一样，我们需要一个特定的转换id，您可以通过<a class="ae ku" href="https://confluence.atlassian.com/adminjiraserver073/working-with-workflows-861253510.html" rel="noopener ugc nofollow" target="_blank">编辑您现有的项目工作流</a>来找到它。<strong class="ih hj"> </strong>我们现在可以通过编程来更新我们JIRA机票的状态</p><pre class="kw kx ky kz fd li lj lk ll aw lm bi"><span id="5460" class="ln js hi lj b fi lo lp l lq lr">def changeStatus(key, id):<br/> jira_request = {“transition”:{“id”: id }, “fields”: {“resolution”: {“name”: “Done”}}}<br/> endpoint = “https://jira_url.com/rest/api"<br/> r = session.post(endpoint + “/2/issue/%(key)s/transitions?expand=transitions.fields” % locals(), data=json.dumps(jira_request), headers=headers_jira)<br/> return r.text</span></pre><h1 id="ed97" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">从人群中拯救人们</h1><p id="e73a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">客户重命名对于团队来说曾经是一项极其艰巨的任务。回顾我们的账户重命名手册的Confluence修订历史，就像20年后清理你的地下室一样。除了非常耗时之外，还有一个混杂的进程，包括停止puppet和运行，出于某种原因…一个ruby和一个bash脚本。有时需要重启应用程序，但并不总是如此。随着我们规模的增长，唯一可扩展的解决方案是自动化重复的、手动的、通常令人难以置信的任务。这不仅让我们能够为客户提供更好的服务，也让我们有机会绕过世俗，拥抱创新。</p><p id="5c4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后一个提示——这是最重要的部分——当我们想要自动化任何需要其他人手动输入的东西时，我们必须考虑到人类愚蠢的错误。确保创建<a class="ae ku" href="https://confluence.atlassian.com/adminjiracloud/advanced-workflow-configuration-776636620.html" rel="noopener ugc nofollow" target="_blank">验证器和</a>条件来解决这个问题。</p><p id="781d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另外，机智的警告信息是一个<strong class="ih hj">“值++”</strong></p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lv"><img src="../Images/8eadcb9761fdcb5e7db8b330be8d7222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GJBi9Jm9ot0DKfea"/></div></div></figure></div></div>    
</body>
</html>