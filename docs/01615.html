<html>
<head>
<title>MLflow logging for TensorFlow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">张量流的MLflow测井</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mlflow-logging-for-tensorflow-37b6a6a53e3c?source=collection_archive---------3-----------------------#2019-11-04">https://medium.com/analytics-vidhya/mlflow-logging-for-tensorflow-37b6a6a53e3c?source=collection_archive---------3-----------------------#2019-11-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3e3e2c38abcce3b33b5fa0c420f77f01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6_PuLhj0VJJxIzjPIJyDVA.png"/></div></div></figure><p id="6d83" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是我的MLflow教程系列的第三篇文章:</p><ol class=""><li id="0941" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/setup-mlflow-in-production-d72aecde7fef">在生产中设置ml flow</a></li><li id="b455" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-basic-logging-functions-e16cdea047b"> MLflow:基本测井功能</a></li><li id="ecf4" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-logging-for-tensorflow-37b6a6a53e3c">张量流MLflow测井</a>(你来了！)</li><li id="30bd" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/mlflow-projects-24c41b00854"> MLflow项目</a></li><li id="180d" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/retrieving-the-best-model-using-python-api-for-mlflow-7f76bf503692">使用Python API为MLflow检索最佳模型</a></li><li id="f34d" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/@gyani91/serving-a-model-using-mlflow-8ba5db0a26c0">使用MLflow服务模型</a></li></ol><p id="ba80" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">而<a class="ae jx" rel="noopener" href="/@gyani91/mlflow-basic-logging-functions-e16cdea047b">基本MLflow记录功能</a>是您开始使用MLflow所需的全部。本指南将有助于解决将MLflow与TensorFlow结合使用时可能面临的初始问题。</p><p id="3d49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从一些基本的MLflow函数开始，这些函数将帮助您记录各种值和工件。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="a67e" class="km kn hi ki b fi ko kp l kq kr">import mlflow</span></pre><p id="2726" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">日志记录功能需要与特定的运行相关联。将所有内容放入一次运行的最佳方式是在main函数(或其他调用函数)的开始处指定运行的开始，在main函数的结束处指定运行的结束。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="ed34" class="km kn hi ki b fi ko kp l kq kr">if __name__ == '__main__':<br/>  mlflow.start_run()<br/>  #the model code<br/>  mlflow.end_run()</span></pre><p id="de75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ks kt ku ki b"><a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.log_param" rel="noopener ugc nofollow" target="_blank">mlflow.log_param()</a></code>记录当前运行中的单个键值参数。键和值都是字符串。</p><p id="8b41" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在TensorFlow中，如果直接记录张量，则只会记录张量的“类型”。例如:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es kv"><img src="../Images/68f1692c18b97943a7d29648b4e2705c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*-eW5SE9uOWoHf2fnOLcKmQ.png"/></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">测井张量类型</figcaption></figure><p id="95d5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">相反，我们需要记录它的值:</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div class="er es la"><img src="../Images/cc52d922507342919e9cef33c2ee81d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*txw-c8yp5cwoNV8JSIQGEA.png"/></div><figcaption class="kw kx et er es ky kz bd b be z dx translated">测井张量值</figcaption></figure><p id="9ac9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，您需要使用功能<a class="ae jx" href="https://www.tensorflow.org/api_docs/python/tf/Tensor" rel="noopener ugc nofollow" target="_blank">。eval() </a>在你的张量上。为了能够使用<a class="ae jx" href="https://www.tensorflow.org/api_docs/python/tf/Tensor" rel="noopener ugc nofollow" target="_blank">。eval() </a>您需要在一个会话中，张量应该被初始化。如果您不在会话中，或者您不想使用默认会话进行日志记录，您总是可以使用以下语句在代码中的任何位置启动分层会话。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="9485" class="km kn hi ki b fi ko kp l kq kr">with tf.Session(config=tf.ConfigProto(allow_soft_placement=True, log_device_placement=False)) as newsess:<br/>	newsess.run(tf.global_variables_initializer())<br/>	mlflow.log_param('learning_rate', learning_rate.eval())</span></pre><p id="56e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ks kt ku ki b"><a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.log_metric" rel="noopener ugc nofollow" target="_blank">mlflow.log_metric()</a></code>记录单个键值度量。该值必须始终是一个数字。与<code class="du ks kt ku ki b"><a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.log_param" rel="noopener ugc nofollow" target="_blank">mlflow.log_param()</a></code>类似，您需要使用<a class="ae jx" href="https://www.tensorflow.org/api_docs/python/tf/Tensor" rel="noopener ugc nofollow" target="_blank">。eval() </a>函数获取张量的值:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="1a5a" class="km kn hi ki b fi ko kp l kq kr">with tf.Session(config=tf.ConfigProto(allow_soft_placement=True, log_device_placement=False)) as newsess:<br/>	newsess.run(tf.global_variables_initializer())<br/>	mlflow.log_metric('Losses/%s' % loss.op.name, loss.eval())</span></pre><p id="64f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>从TensorFlow 2.0开始，可以使用。numpy()函数而不是<a class="ae jx" href="https://www.tensorflow.org/api_docs/python/tf/Tensor" rel="noopener ugc nofollow" target="_blank">。eval() </a>。</p><p id="1088" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ks kt ku ki b"><a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.log_artifacts" rel="noopener ugc nofollow" target="_blank">mlflow.log_artifacts()</a></code>将一个给定目录中的所有文件记录为工件，可选的<code class="du ks kt ku ki b">artifact_path</code>。工件可以是任何文件，如图像、模型、检查点等。MLflow有一个<a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.tensorflow.html" rel="noopener ugc nofollow" target="_blank"> mlflow.tensorflow </a>模块，用于记录模型。由于大多数模型都有自己保存模型和检查点的方式，我们建议让模型保存模型/检查点，并让MLflow使用<code class="du ks kt ku ki b"><a class="ae jx" href="https://www.mlflow.org/docs/latest/python_api/mlflow.html#mlflow.log_artifacts" rel="noopener ugc nofollow" target="_blank">mlflow.log_artifacts().</a></code>简单地记录生成的文件。这个过程相对来说是没有错误的。</p><p id="45af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想自己记录模型，可以使用以下代码:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="037e" class="km kn hi ki b fi ko kp l kq kr"># get the active mlflow run id<br/>run_uuid = mlflow.active_run().info.run_uuid</span><span id="65e3" class="km kn hi ki b fi lb kp l kq kr"># modify the default model log path to include a sub-directory named by the mlflow run id<br/>export_path = FLAGS.train_logdir + '/' + run_uuid<br/>print('Exporting trained model to', export_path)</span><span id="4487" class="km kn hi ki b fi lb kp l kq kr">#Create SavedModel object<br/>builder = tf.saved_model.builder.SavedModelBuilder(export_path)</span><span id="fa03" class="km kn hi ki b fi lb kp l kq kr">#Save the model<br/>builder.save(as_text=True)</span><span id="db75" class="km kn hi ki b fi lb kp l kq kr">#Log the saved model to the MLflow runs directory on the production server<br/>mlflow.log_artifacts(export_path, "model")</span></pre><p id="e1fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">解释:</strong>大多数模型都天真地将检查点转储到一个日志目录中。例如，<a class="ae jx" href="https://github.com/tensorflow/models/tree/master/research/deeplab" rel="noopener ugc nofollow" target="_blank"> Deeplab </a>将其所有检查点保存到一个名为<em class="lc"> train_logdir </em>的目录中。由于天真地将这个目录的所有内容复制到工件的目录中，所以一次运行不仅存储自己的工件，还存储所有以前运行的工件。这里的解决方法是用MLflow运行id增加模型导出路径，以便它将与特定运行id相关联的模型保存在目录中，并且只在生产服务器中记录该模型。</p><p id="57f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一篇文章中，我们将研究MLflow项目。</p></div></div>    
</body>
</html>