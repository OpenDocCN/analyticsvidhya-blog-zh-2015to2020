<html>
<head>
<title>Integrate Census Data into Your Website</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将人口普查数据整合到您的网站中</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/integrate-census-data-into-your-website-b6fd211f687a?source=collection_archive---------17-----------------------#2020-05-14">https://medium.com/analytics-vidhya/integrate-census-data-into-your-website-b6fd211f687a?source=collection_archive---------17-----------------------#2020-05-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="00e8" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用命令行、Python、node.js和Mapbox向您的网站添加专题地图。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/092190cc6d119758cf7e5e1a512f660d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NPx3bK_uvFkbo0YxBgTzQA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">查塔努加人口的交互式分布图</figcaption></figure><p id="b6d2" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这是一篇关于如何使用Mapbox将人口普查局的数据整合到你的网站上的文章。专题地图对于传达数据的含义非常有用。本文档将探讨如何准备用于Mapbox的数据，制作切片集和样式，以及将地图添加到您的网站。</p><p id="d023" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj">简介</strong></p><p id="9556" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">有几种方法可以将人口普查数据整合到网页中。使用这些数据的两种最流行的方法是数据检索工具和将地图集成到您的网站中。数据检索工具的工作方式是，它们接受用户输入来构造一个http请求，类似于我在“<a class="ae kk" rel="noopener" href="/@shep.nathan.d/using-the-u-s-census-bureaus-api-af113337f478">使用美国人口普查局的API </a>”中所写的请求。本文将重点介绍如何使用Census API将地图集成到您的网站中。在网站中包含专题地图是一次性传达大量数据背后含义的好方法。本文将介绍如何使用Mapbox将地图集成到您的网站中。</p><p id="ba8c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj">准备数据</strong></p><p id="e194" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">当使用Mapbox制作专题地图时，您必须从制作tileset开始。为此，您必须向它提供一个json文件，其中包含您的数据和您要绘制地图的地点的地理信息。我使用了一个UNIX shell脚本来创建我的json文件。为此，我使用了马克·博斯托克的D3。我强烈推荐他的关于使用D3的四部分系列，从“<a class="ae kk" rel="noopener" href="/@mbostock/command-line-cartography-part-1-897aa8f8ca2c">命令行制图，第1部分</a>”开始。首先，我使用了我们使用美国人口普查局的API 在<a class="ae kk" rel="noopener" href="/@shep.nathan.d/using-the-u-s-census-bureaus-api-af113337f478">中构建的http请求，只是我只使用了第二个变量。我用curl下载了数据。</a></p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="3769" class="kq kr hi km b fi ks kt l ku kv">curl <a class="ae kk" href="https://api.census.gov/data/2016/acs/acs5?get=B00001_001E,B01001_001E&amp;for=tract:*&amp;in=county:065&amp;in=state:47" rel="noopener ugc nofollow" target="_blank">'https://api.census.gov/data/2016/acs/acs5?get=B01001_001E&amp;for=tract:*&amp;in=county:065&amp;in=state:47'</a> -o src/2017-acs5.txt</span></pre><p id="614d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">当你从人口普查局的API中下载数据时，它在整件事和每条线周围都有方括号。为了清理它，我使用了sed和awk命令。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="c691" class="kq kr hi km b fi ks kt l ku kv">sed -e 's/\[\[//' src/2017-acs5.txt \<br/>  | sed -e 's/\[//' \<br/>  | sed -e 's/],//' \<br/>  | sed -e 's/\]\]//' \<br/>  | sed -e 's/,"47","065","/,"065/' \<br/>  | sed '1d' \<br/>  | awk -F, '{print $2, $1}' OFS=, \<br/>  &gt; src/2017-acs5.csv</span></pre><p id="148c" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">第5行去掉了州FIPS代码，合并了县和区域代码。这是非常重要的一步，因为我们将在一点点上执行一个连接，这将是关键。下一行去掉了列标题，因为我们要转换成不使用它们的ndjson。第7行交换了我们的两列，所以第一列包含我们的新id列，第二列包含我们的数据。</p><p id="351f" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">为了转换成ndjson，我使用了一个名为csv-to-ndjson的node.js包。可以使用命令在本地安装它</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="c53e" class="kq kr hi km b fi ks kt l ku kv">npm install csv-to-ndjson</span></pre><p id="d5b6" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">请注意，您不希望全局安装该软件包。然后，我制作了一个小脚本来转换我们的文件。</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="ff64" class="kq kr hi km b fi ks kt l ku kv">const csvToNdjson = require('csv-to-ndjson');</span><span id="6cfa" class="kq kr hi km b fi kw kt l ku kv">csvToNdjson(<br/>'./src/2017-acs5.csv', { // csv file you want to convert<br/> delimiter: ',',<br/> destination: './src/2017-acs5.ndjson', // output file<br/> header: ['id', 'population'] // column headers<br/>}).then(succes =&gt; console.log('Success!')) // prints 'Success!' in the console if successful.</span></pre><p id="6413" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">在这之后，我又用了几次sed将数据从字符串转换成整数。我剩下的大部分代码都是从“<a class="ae kk" rel="noopener" href="/@mbostock/command-line-cartography-part-1-897aa8f8ca2c">命令行制图，第1部分</a>”中复制过来的，只做了微小的修改。这是我的完整剧本</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="b140" class="kq kr hi km b fi ks kt l ku kv">#!/usr/bin/env bash</span><span id="80f3" class="kq kr hi km b fi kw kt l ku kv">rm -R tmp dest src</span><span id="4fdb" class="kq kr hi km b fi kw kt l ku kv">mkdir -p src/ tmp/ dest/</span><span id="f9ab" class="kq kr hi km b fi kw kt l ku kv">curl '<a class="ae kk" href="https://www2.census.gov/geo/tiger/GENZ2017/shp/cb_2017_47_tract_500k.zip'" rel="noopener ugc nofollow" target="_blank">https://www2.census.gov/geo/tiger/GENZ2017/shp/cb_2017_47_tract_500k.zip'</a> -o src/cb_2017_47_tract_500k.zip ## download the shapefile from Tiger<br/>unzip -o src/cb_2017_47_tract_500k.zip -d src/ ## extract shapefile</span><span id="460c" class="kq kr hi km b fi kw kt l ku kv">curl '<a class="ae kk" href="https://api.census.gov/data/2016/acs/acs5?get=B01001_001E&amp;for=tract:*&amp;in=county:065&amp;in=state:47'" rel="noopener ugc nofollow" target="_blank">https://api.census.gov/data/2016/acs/acs5?get=B01001_001E&amp;for=tract:*&amp;in=county:065&amp;in=state:47'</a> -o src/2017-acs5.txt ## download data from the Census Bureau<br/>sed -e 's/\[\[//' src/2017-acs5.txt \<br/>  | sed -e 's/\[//' \<br/>  | sed -e 's/],//' \<br/>  | sed -e 's/\]\]//' \<br/>  | sed -e 's/,"47","065","/,"065/' \<br/>  | sed '1d' \<br/>  | awk -F, '{print $2, $1}' OFS=, \<br/>  &gt; src/2017-acs5.csv ## convert to csv by removing unwanted characters, remove state column, concatenate county and tract into one column, and swap the columns</span><span id="2fd9" class="kq kr hi km b fi kw kt l ku kv">node map.js ## convert data to ndjson (output is 'src/2017-acs5.ndjson')</span><span id="4f26" class="kq kr hi km b fi kw kt l ku kv">## convert population to number<br/>sed -e 's/population":"/population":/' -i src/2017-acs5.ndjson<br/>sed -e 's/"}/}/' -i src/2017-acs5.ndjson</span><span id="c200" class="kq kr hi km b fi kw kt l ku kv">shp2json src/cb_2017_47_tract_500k.shp \<br/> | ndjson-split 'd.features' \<br/>  | ndjson-map 'd.id = d.properties.GEOID.slice(2), d' \<br/>  &gt;tmp/tn-projection-id.ndjson ## extract geography as ndjson from shapefile</span><span id="1376" class="kq kr hi km b fi kw kt l ku kv">grep -Rrih '"COUNTYFP":"065"' \<br/>  tmp/tn-projection-id.ndjson \<br/>  &gt;&gt; tmp/hamilton-projection-id.ndjson ## filter out all counties outside of Hamilton County</span><span id="ac66" class="kq kr hi km b fi kw kt l ku kv">ndjson-join --outer 'd.id' \<br/>   tmp/hamilton-projection-id.ndjson \<br/>   src/2017-acs5.ndjson \<br/>   &gt; tmp/hamilton-projection-join.ndjson ## join geography to data</span><span id="e52b" class="kq kr hi km b fi kw kt l ku kv">## convert to json<br/>ndjson-reduce \<br/>    &lt; tmp/hamilton-projection-join.ndjson \<br/>    &gt; tmp/hamilton-projection-join.json</span><span id="b192" class="kq kr hi km b fi kw kt l ku kv">echo '{"type":"FeatureCollection","features":' &gt; dest/hamilton.json<br/>cat tmp/hamilton-projection-join.json \<br/>  | sed -e 's/"id":"065......"},{"id":/"properties": {"id":/g' \<br/>  | sed -e 's/\[{"type"/{"type"/g' \<br/>  | sed -e 's/}\],{"type"/}},{"type"/g' \<br/>  | sed -e 's/"population":0}\]\]/"population":0}}\]/g' \<br/>  &gt;&gt; dest/hamilton.json<br/>echo '}' &gt;&gt; dest/hamilton.json</span></pre><p id="b300" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">现在，数据可以作为tileset上传到Mapbox。</p><p id="aad8" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj">制作瓷砖和样式</strong></p><p id="feed" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">现在，如果您还没有这样做，您需要在Mapbox上创建一个帐户。别担心，每个计费周期的前50，000次地图下载是免费的。现在点击网页右上方的图标，然后点击“工作室”。现在点击Tilesets。单击“新建tileset”。选择您的json文件，然后单击“确认”。现在我们已经准备好打造我们的风格了。</p><p id="e120" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">点击“样式”，点击“新样式”，选择“基本”，点击“自定义基本”。我喜欢去掉除了几层以外的所有东西。你包括什么完全取决于你自己。现在点击加号按钮添加一层。点击“选择数据”。选择您刚刚制作的样式表。现在点击“风格”，然后进入“颜色”。选择“跨越数据范围的样式”，并选择您的变量。点击“变化率”，并选择线性。我以前对所有东西都用step，这样可以更容易理解数据；然而，在撰写本文的过程中，我发现，使用gap statics方法，这个数据集的最佳集群大小是1。所以我决定对这些数据使用线性！对于图例，我使用浏览器的颜色选择器在地图编辑器中抓取图例的每个刻度线和端点的颜色。</p><p id="28b9" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated"><strong class="jp hj">将地图添加到您的网站</strong></p><p id="5b85" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">这是棘手的部分。点击右上角的图标，进入“账户”。您可能需要在本页底部记下您的访问令牌。在页面右侧的“工具和资源”下，点击“集成地图框”。现在选择“web”。遵循Mapbox在“<a class="ae kk" href="https://docs.mapbox.com/help/tutorials/choropleth-studio-gl-pt-2/" rel="noopener ugc nofollow" target="_blank">制作choropleth地图，第2部分</a>”中的步骤。第一部分也有一些很好的关于设计地图的技巧。</p><p id="a66d" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我的地图javascript如下所示:</p><pre class="iy iz ja jb fd kl km kn ko aw kp bi"><span id="9bc0" class="kq kr hi km b fi ks kt l ku kv">mapboxgl.accessToken = 'accessToken'; //your access token</span><span id="d2b1" class="kq kr hi km b fi kw kt l ku kv">var map = new mapboxgl.Map({<br/>  container: 'map', //container id<br/>  style: 'styleURL', //your style url<br/>  center: [-85.21,35.225], //default center of map<br/>  minZoom: 8,<br/>  maxZoom: 22,<br/>  zoom: 8.5,<br/>  zoomControl: false<br/>});</span><span id="5210" class="kq kr hi km b fi kw kt l ku kv">var nav = new mapboxgl.NavigationControl();</span><span id="9c12" class="kq kr hi km b fi kw kt l ku kv">///////////////////////////////////////</span><span id="da22" class="kq kr hi km b fi kw kt l ku kv">//legend<br/>map.on('load', function() {<br/> var layers = ['0','1900','3700','5600','7500','9400','10297'];<br/> var colors = ['#fCE29C', '#f1b987', '#e59071', '#da675c', '#ce3f47', "#c31631", "#BD0026"]; //colors from the legend in Mapbox editor</span><span id="6395" class="kq kr hi km b fi kw kt l ku kv">map.getCanvas().style.cursor = 'default';</span><span id="99f2" class="kq kr hi km b fi kw kt l ku kv">for (i = 0; i &lt; layers.length; i++) {<br/>    var layer = layers[i];<br/>    var color = colors[i];<br/>    var item = document.createElement('div');<br/>    var key = document.createElement('span');<br/>    key.className = 'legend-key';<br/>    key.style.backgroundColor = color;<br/>  <br/>  var value = document.createElement('span');<br/>  value.innerHTML = layer;<br/>  item.appendChild(key);<br/>  item.appendChild(value);<br/>    legend.appendChild(item);<br/> }</span><span id="7581" class="kq kr hi km b fi kw kt l ku kv">//information window<br/>map.on('mousemove', function(e) {<br/>   var tracts = map.queryRenderedFeatures(e.point, {<br/>     layers: ['layerName'] //this is where the name of your custom layer goes<br/>   });<br/> <br/>   if (tracts.length &gt; 0) {<br/>     document.getElementById('pd').innerHTML =<br/>      '&lt;h3&gt;&lt;strong&gt; Tract: '<br/>      + tracts[0].properties.id.substring(2,tracts[0].properties.id.length-1)<br/>      + '&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;em&gt;' <br/>      + tracts[0].properties.variable //change "variable" to the name of your data<br/>      + '&lt;/strong&gt; people&lt;/em&gt;&lt;/p&gt;'<br/>      ;<br/>   } else {<br/>     document.getElementById('pd').innerHTML = '&lt;p&gt;Hover over a tract!&lt;/p&gt;';<br/>   }<br/> });<br/>});</span></pre><p id="6b70" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">我添加了Mapbox修改后的css和html，这里的<a class="ae kk" href="https://flamboyant-galileo-f88ad5.netlify.app/jekyll/update/2020/04/29/population-density.html" rel="noopener ugc nofollow" target="_blank">就是最终产品。我坚决不张贴我的css和html，因为它们对我的网站来说太具体了。我差不多只是把Mapbox说我需要的东西添加到了我想要地图的页面上，只是根据需要调整了css。</a></p><p id="9ba2" class="pw-post-body-paragraph jn jo hi jp b jq jr ij js jt ju im jv jw jx jy jz ka kb kc kd ke kf kg kh ki hb bi translated">如果你喜欢这篇文章，请为它鼓掌。如果您有任何问题或建议，请随时发表评论。</p></div></div>    
</body>
</html>