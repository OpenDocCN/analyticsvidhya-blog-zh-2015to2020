<html>
<head>
<title>Sentiment Analysis with SparkNLP — It Couldn’t Be Easier</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SparkNLP进行情感分析—再简单不过了</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/sentiment-analysis-with-sparknlp-couldnt-be-easier-2a8ea3b728a0?source=collection_archive---------5-----------------------#2020-05-17">https://medium.com/analytics-vidhya/sentiment-analysis-with-sparknlp-couldnt-be-easier-2a8ea3b728a0?source=collection_archive---------5-----------------------#2020-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="7e67" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一个使用sparkNLP库的小型情感分析项目</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/e1ca156526bacc5b08448ecb2c7de853.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bG5-olOn50ag8ruUhZPlWw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://www.youtube.com/watch?v=SPmxsRDSmTc" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=SPmxsRDSmTc</a></figcaption></figure><p id="e830" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi kk translated"><span class="l kl km kn bm ko kp kq kr ks di">自然语言处理是一项令人兴奋的技术，因为每天都有突破，当你考虑我们如何表达自己时，没有限制。当涉及到情感分析时，它变得更加复杂。比方说，如果我们正在分析客户的反馈，客户可以在一句话中给出正面和负面的反馈，他们可以是讽刺的(！) :)而且会拼错等等。等等..那我们该怎么办？</span></p><p id="177b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><em class="kt">在我开始之前，我想提一下，在这个故事的结尾，你会发现一些我在学习NLP时看到的文章。这些只是小步骤，我在这个领域只是一个初学者… </em></p></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="06fc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于情感分析，如果数据被标记为你很幸运，你可以使用单词包/嵌入来表示文本数字，并训练分类器对你的测试数据进行预测。</p><p id="c771" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果数据没有被标记，你还是幸运的，因为我们有预先训练好的嵌入来帮助你使用聚类得到相当好的结果。</p><p id="8add" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然而，如果你在Spark和NLP上稍微搜索一下，你可能听说过sparkNLP。我们有pyspark.ml库但是我不得不说；sparkNLP让一切变得前所未有的简单。</p><p id="dd6a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您所要做的就是安装sparkNLP:</p><div class="lb lc ez fb ld le"><a href="https://nlp.johnsnowlabs.com/docs/en/install" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">装置</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">让我们创建一个新的Conda环境来管理那里的所有依赖项。您可以使用Python虚拟环境，如果…</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">nlp.johnsnowlabs.com</p></div></div></div></a></div><p id="6049" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">并开始玩它。</p></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="f4de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">数据集:</strong></p><p id="390e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><em class="kt">请随意选择任何其他数据集，这些步骤会尽可能通用地解释。</em></p><div class="lb lc ez fb ld le"><a href="https://www.kaggle.com/adarshsng/title-and-headline-sentiment-prediction" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">标题和标题情感预测</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">预测文章标题和标题的情感分数。</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">www.kaggle.com</p></div></div><div class="ln l"><div class="lo l lp lq lr ln ls jh le"/></div></div></a></div><p id="57a9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">环境:</strong> AWS EMR 5.29.0带Spark 2.4.4，TensorFlow 1.14.0</p><p id="9d15" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">(你可以在<a class="ae jn" href="https://github.com/JohnSnowLabs/spark-nlp/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">https://github . com/JohnSnowLabs/spark-NLP/blob/master/readme . MD</a>中找到需求)</p><p id="6b33" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">0.导入库和预训练的情感分析器模型:</p><pre class="iy iz ja jb fd lt lu lv lw aw lx bi"><span id="2478" class="ly lz hi lu b fi ma mb l mc md">import sparknlp<br/>from sparknlp.pretrained import PretrainedPipeline</span></pre><p id="311f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">有两种方法可以导入预训练管线:</p><p id="c856" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">a.离线:</p><p id="47bd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从:<a class="ae jn" href="https://github.com/JohnSnowLabs/spark-nlp-models" rel="noopener ugc nofollow" target="_blank">https://github.com/JohnSnowLabs/spark-nlp-models</a>下载分析_感知_使用_推特压缩文件</p><p id="0b1f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">解压缩并加载到s3。</p><p id="55e0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当你解压的时候，我建议你检查文件夹，看看有哪些阶段正在进行中。:)</p><pre class="iy iz ja jb fd lt lu lv lw aw lx bi"><span id="0153" class="ly lz hi lu b fi ma mb l mc md">pipeline = PretrainedPipeline.from_disk(<em class="kt">model_s3_location</em>)</span></pre><p id="51cf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">b.在线:</p><pre class="iy iz ja jb fd lt lu lv lw aw lx bi"><span id="6655" class="ly lz hi lu b fi ma mb l mc md">pipeline = PretrainedPipeline("analyze_sentimentdl_use_twitter", lang="en")</span></pre><p id="0a78" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我手动添加了sparkNLP jar，如果您也选择这样做，在创建sparkSession时，请确保您使用以下设置，否则我会得到诸如“Table not initialized”(设置序列化程序可以解决这个问题)、由于内存或通用语句编码器(这是此管道中的一个阶段)导致的java错误等错误，当集群模式为“yarn”时会导致一些错误。</p><pre class="iy iz ja jb fd lt lu lv lw aw lx bi"><span id="cbf6" class="ly lz hi lu b fi ma mb l mc md">spark = SparkSession.builder.master("local[*]") \<br/>.config("spark.driver.memory", "12g")\                                   .config("spark.kryoserializer.buffer.max", "2000M")\<br/>.config("spark.jars", jar_location)\<br/>.config("spark.serializer ", "org.apache.spark.serializer.KryoSerializer")\<br/>.config("spark.sql.broadcastTimeout",  "360000")\<br/>.getOrCreate()</span><span id="ddd9" class="ly lz hi lu b fi me mb l mc md">spark.sparkContext.addPyFile(jar_location)</span></pre><ol class=""><li id="d698" class="mf mg hi jq b jr js ju jv jx mh kb mi kf mj kj mk ml mm mn bi translated">将数据集读入Spark数据帧，并根据需要进行预处理:</li></ol><p id="f450" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">a.删除非ascii字符</p><p id="aa29" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">b.去掉标点符号(标点符号在某些情况下可能有用！)</p><p id="0334" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">c.删除短于特定长度的文本</p><p id="0f61" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">d.纠正拼写(您可以使用sparkNLP 'check_spelling_dl '进行上下文保留拼写纠正)</p><p id="e690" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">2.只需在数据集上运行预训练管道:</p><pre class="iy iz ja jb fd lt lu lv lw aw lx bi"><span id="4721" class="ly lz hi lu b fi ma mb l mc md"># rename the text column as 'text', pipeline expects 'text' inputCol</span><span id="b81c" class="ly lz hi lu b fi me mb l mc md">df_result = \<br/>pipeline.transform(df.withColumnRenamed("Headline", "text"))</span></pre><p id="4b85" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">3.打印Schema并从情感输出列中提取结果:</p><pre class="iy iz ja jb fd lt lu lv lw aw lx bi"><span id="1d2e" class="ly lz hi lu b fi ma mb l mc md"># extract results from "sentiments" column</span><span id="5f5a" class="ly lz hi lu b fi me mb l mc md">df_result\<br/>.selectExpr("text","explode(sentiment) sentiments", "SentimentHeadline")\<br/>.selectExpr("text","sentiments.result result", "SentimentHeadline")\<br/>.createOrReplaceTempView("result_tbl_")</span><span id="9ef5" class="ly lz hi lu b fi me mb l mc md"># sentiment labels in training data are float, so we map them to <br/># categorical classes</span><span id="1e50" class="ly lz hi lu b fi me mb l mc md">spark.sql("""<br/>    SELECT<br/>        text,<br/>        CASE WHEN SentimentHeadline&gt;0 THEN 'positive' <br/>        WHEN SentimentHeadline&lt;0 THEN 'negative'<br/>        ELSE 'neutral'<br/>        END AS label,<br/>        result<br/>    FROM<br/>    result_tbl_""").createOrReplaceTempView("result_tbl")</span><span id="c362" class="ly lz hi lu b fi me mb l mc md"># below is optional , visualize predictions<br/># calculate normalized percentage of results per labels</span><span id="31f7" class="ly lz hi lu b fi me mb l mc md">df_counts = spark.sql("""<br/>    <br/>    WITH counts_tbl AS<br/>    (SELECT COUNT(*) as label_count, label FROM result_tbl GROUP BY      label)</span><span id="ac7e" class="ly lz hi lu b fi me mb l mc md">SELECT<br/>        joined_.result, <br/>        joined_.label,<br/>        100*COUNT(*)/joined_.l_count AS normalized_percentage</span><span id="d2c3" class="ly lz hi lu b fi me mb l mc md">FROM<br/>       (SELECT counts_tbl.label_count l_count, result_tbl.* <br/>        FROM result_tbl<br/>        JOIN<br/>        counts_tbl <br/>        ON<br/>        counts_tbl.label = result_tbl.label) joined_</span><span id="6f9c" class="ly lz hi lu b fi me mb l mc md">GROUP BY  joined_.result, joined_.label, joined_.l_count</span><span id="e01a" class="ly lz hi lu b fi me mb l mc md">""")</span><span id="c9fb" class="ly lz hi lu b fi me mb l mc md"># visualize results per labels</span><span id="4426" class="ly lz hi lu b fi me mb l mc md">import seaborn as sns<br/>import matplotlib.pyplot as plt<br/>%matplotlib inline</span><span id="7427" class="ly lz hi lu b fi me mb l mc md">p_Result = result_df_.toPandas()</span><span id="8f43" class="ly lz hi lu b fi me mb l mc md">p = sns.barplot(x="label", y="normalized_percentage", hue="result", data=p_Result)</span><span id="4ac6" class="ly lz hi lu b fi me mb l mc md">plt.title('Pretrained(Twitter) Sentiment DL Model Results')<br/>plt.savefig('analyze_sentiment.png')</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mo"><img src="../Images/ef716e5429dda69682c337cc23457298.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*bo9j407WokF6BhiuudJHuA.png"/></div></figure><p id="c419" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">看起来这条渠道可能对我的数据集没有太大作用，但很明显，正面标题大多是正面的，负面和中性标题大多是负面的。</p><p id="a489" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以使用不同的数据集(例如，更“自然”语言的客户评论:)。您可以使用sklearn指标来评估混淆指标的结果，并通过添加更多清理、删除停用词等来重申。来提高产量。</p><p id="dd28" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以选择构建自己的管道，而不是使用预构建的管道。SparkNLP有大量的模型、注释器供您试用。您可以使用DocumentAssembler、Tokenizer、Normalizer、Lemmatizer和单词嵌入(可能+句子嵌入)来构建文本的数字表示，并为您的目的训练任何分类器。(如果数据集未标记，您可以应用Kmeans聚类，并使用肘方法找到最佳K，请参见最后的链接)。</p><p id="5371" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这个故事很短，但是无论是自然语言处理还是情感分析都没有这个故事讲的那么简单。我需要说，这项工作可能只是自然语言处理基础知识的“a ”,对人们建立自己的嵌入，训练自己的深度学习网络深表敬意……但是，我再次希望这个故事能为自然语言处理建立一些热情:)</p><p id="8c53" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您抽出时间！</p><p id="3f0f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> <em class="kt">关于文本预处理、情感分析和sparknlp的一些文章:</em> </strong></p><div class="lb lc ez fb ld le"><a href="https://www.kdnuggets.com/2019/04/text-preprocessing-nlp-machine-learning.html" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">关于自然语言处理和机器学习的文本预处理，你需要知道的是</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">数据科学家卡维塔·加内桑。根据最近的一些谈话，我意识到文本预处理是一个严重的…</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">www.kdnuggets.com</p></div></div><div class="ln l"><div class="mp l lp lq lr ln ls jh le"/></div></div></a></div><div class="lb lc ez fb ld le"><a href="https://towardsdatascience.com/what-the-heck-is-word-embedding-b30f67f01c81" rel="noopener follow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">什么是单词嵌入</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">透过神经网络的透镜看文本数据</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">towardsdatascience.com</p></div></div><div class="ln l"><div class="mq l lp lq lr ln ls jh le"/></div></div></a></div><div class="lb lc ez fb ld le"><a href="https://towardsdatascience.com/how-to-train-custom-word-embeddings-using-gpu-on-aws-f62727a1e3f6" rel="noopener follow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">如何在AWS上使用GPU训练自定义单词嵌入</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">语言很重要。人类用文字交流，文字承载着意义。我们能训练机器也学习吗…</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">towardsdatascience.com</p></div></div><div class="ln l"><div class="mr l lp lq lr ln ls jh le"/></div></div></a></div><div class="lb lc ez fb ld le"><a href="https://towardsdatascience.com/unsupervised-sentiment-analysis-a38bf1906483" rel="noopener follow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">无监督情感分析</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">如何从没有任何标签的数据中提取情感</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">towardsdatascience.com</p></div></div><div class="ln l"><div class="ms l lp lq lr ln ls jh le"/></div></div></a></div><div class="lb lc ez fb ld le"><a href="https://www.kaggle.com/kyen89/1-sentiment-analysis-tf-idf" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">1.情感分析:TF-IDF</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">使用Kaggle笔记本探索和运行机器学习代码|使用来自单词袋和爆米花袋的数据:)</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">www.kaggle.com</p></div></div><div class="ln l"><div class="mt l lp lq lr ln ls jh le"/></div></div></a></div><div class="lb lc ez fb ld le"><a href="https://www.kaggle.com/c/word2vec-nlp-tutorial" rel="noopener  ugc nofollow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">一袋文字遇上一袋爆米花</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">使用谷歌的Word2Vec进行电影评论</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">www.kaggle.com</p></div></div><div class="ln l"><div class="mu l lp lq lr ln ls jh le"/></div></div></a></div><div class="lb lc ez fb ld le"><a href="https://towardsdatascience.com/text-classification-in-spark-nlp-with-bert-and-universal-sentence-encoders-e644d618ca32" rel="noopener follow" target="_blank"><div class="lf ab dw"><div class="lg ab lh cl cj li"><h2 class="bd hj fi z dy lj ea eb lk ed ef hh bi translated">基于Bert和通用语句编码器的Spark NLP文本分类</h2><div class="ll l"><h3 class="bd b fi z dy lj ea eb lk ed ef dx translated">用Bert和Spark NLP中的通用语句编码器训练SOTA多类文本分类器，只需几个…</h3></div><div class="lm l"><p class="bd b fp z dy lj ea eb lk ed ef dx translated">towardsdatascience.com</p></div></div><div class="ln l"><div class="mv l lp lq lr ln ls jh le"/></div></div></a></div></div></div>    
</body>
</html>