<html>
<head>
<title>COVID-19: Those leading days are messing up your model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">新冠肺炎:那些领先的日子打乱了你的模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/covid-19-those-leading-days-are-messing-up-your-model-2746d927c030?source=collection_archive---------34-----------------------#2020-04-11">https://medium.com/analytics-vidhya/covid-19-those-leading-days-are-messing-up-your-model-2746d927c030?source=collection_archive---------34-----------------------#2020-04-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/98750ab9814ff3a9e888ba69850af984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QK3lWKkwusoRHfISqIeQJQ.png"/></div></div></figure><h1 id="bc96" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">摘要</h1><p id="03b6" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我正在研究纽约时报的新冠肺炎数据，并注意到在观察加州各县时，第一个病例和下一个病例之间有很长一段时间。我用这些数据来预测新冠肺炎的热点，而那漫长的潜伏期打乱了我的模型。例如，如果我使用加利福尼亚州奥兰治县的所有天数提前一天进行预测，该县的首例病例与持续的每日病例增长之间有30多天，则模型会产生一个明显低于前一天的数字，尽管趋势是上升的。当那些早期的日子过去后，预测开始看起来像他们应该的那样。</p><p id="aac7" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">我们倾向于使用所有的数据，因为这些数据是真实的，已经发生了，但是如果你在早期建立一个预测模型，那就没什么价值了。如果需要，完整的数据集总是在那里。</p><h1 id="d483" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">方法学</h1><p id="8830" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在看新闻联播时，我看到一张新冠肺炎的预测图表，明确表示他们的模型是在连续三天出现新病例后启动的。这对我来说很有意义，但我不知道如何实施，因为有2500多个县至少有一个病例？我做了研究，这篇文章向你展示了如何修剪这些领先的日子，并提供了一些额外的功能。</p><h1 id="a36c" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">目标</h1><p id="59e2" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">删除在每日案例的第一个3天运行的第一天之前发生的每个县的所有行。</p><h1 id="2497" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">这到底是什么意思？</h1><p id="fd77" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">首先让我们加载数据。《T2时报》的数据给出了每天和县的死亡总数&amp;。由于<strong class="jq hj">没有为新病例或死亡提供栏目</strong>，所以必须创建这些栏目。为此，我使用了“lag()”函数。我还制作了两个二元变量来表示当天是否有新的病例/死亡。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="6f7a" class="lb ir hi kx b fi lc ld l le lf">library(tidyverse)</span><span id="5885" class="lb ir hi kx b fi lg ld l le lf">us &lt;- read_csv(“Data/us-counties-2020–04–08.csv”) %&gt;% <br/> mutate(id = paste0(county, “_”, state)) %&gt;% <br/> arrange(id, date) %&gt;% <br/> rename(ttl_cases = cases, <br/> ttl_deaths = deaths) %&gt;% <br/> group_by(id) %&gt;% <br/> mutate(new_cases = ttl_cases — lag(ttl_cases),<br/> new_cases = if_else(is.na(new_cases), ttl_cases, new_cases),<br/> new_deaths = ttl_deaths — lag(ttl_deaths),<br/> new_deaths = if_else(is.na(new_deaths), ttl_deaths, new_deaths),<br/> new_case_today = if_else(new_cases &gt;= 1, 1, 0), <br/> new_death_today = if_else(new_deaths &gt;= 1, 1, 0)) %&gt;% <br/> ungroup() %&gt;% <br/> select(id, everything())</span><span id="5c10" class="lb ir hi kx b fi lg ld l le lf">glimpse(us)</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lh"><img src="../Images/68fc98213936b47c67576c6bb6e864ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bTThzJ7JA2vK1WC7O5Q4bw.png"/></div></div></figure><p id="60f5" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">如果你看上面的“今天新案例”一行，你会看到有一个单一的案例，然后几天，直到一个新的案例。根据我们的连续三天规则Abbeville，南卡罗来纳州将从最终数据集中删除，因为它在历史上没有这种模式。</p><h1 id="5ba8" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">个案研究</h1><p id="4b81" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">加州的Riverside提供了一个简洁的例子来看看我们在寻找什么样的模式以及如何修复它。沿着“new_case_today”行，3天模式直到第9天才出现。我们的目标是放弃前8天。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="e45d" class="lb ir hi kx b fi lc ld l le lf">us %&gt;% <br/>  filter(id == "Riverside_California") %&gt;% <br/>  glimpse()</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/f22261af64b01fb08aee08f619a6c0b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01ggNSjwGOtJ0q-i4188Tg.png"/></div></div></figure><h1 id="04ce" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">构建一个删除前导日的函数</h1><p id="6780" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">关键是“rle()”函数。这是一个基本的R函数，所以不需要加载新的库。游程编码寻找一系列的0和1，这就是我们创建<code class="du lj lk ll kx b">new_case_today</code>的原因，它使得在你需要的地方分割数据变得相当容易。这个函数的内容是从这篇关于RLE的<a class="ae km" href="https://technocrat.rbind.io/2019/12/26/run-length-encoding/" rel="noopener ugc nofollow" target="_blank">文章</a>中复制粘贴的&amp;。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="3caf" class="lb ir hi kx b fi lc ld l le lf">trim_lead_days &lt;- function(my_id) {<br/>  # Filter &amp; sort<br/>  df &lt;- us %&gt;%<br/>    filter(id == my_id) %&gt;% <br/>    arrange(date)<br/>  <br/>  # We want to identify the first occurrance of three days in a row with new cases<br/>  # Record sequences of 1s &amp; 0s<br/>  runs &lt;- rle(df$new_case_today)<br/>  runs &lt;- tibble(runs$lengths, runs$values)<br/>  colnames(runs) &lt;- c("lengths", "values")<br/>  #runs<br/>  <br/>  #Calculate cumulative index numbers when sequence starts<br/>  sequences &lt;- tibble(lengths = runs$lengths, <br/>                      values = runs$values) %&gt;% <br/>    mutate(indices = cumsum(runs$lengths))<br/>  #sequences<br/>  <br/>  # Get index for first occurance of new cases 3 or more days in a row<br/>  start_index &lt;- sequences %&gt;%<br/>    filter(values == 1, lengths &gt;= 3) %&gt;% <br/>    slice(1) %&gt;% <br/>    pull(indices)<br/>  <br/>  # If no 3-day sequence then return empty row<br/>  #  else return only the rows after 3-day rule met <br/>  #  starting with the first day of 3-day run.  <br/>  if(is_empty(start_index)) {<br/>    final_df &lt;- df[0, ]<br/>  } else {<br/>    final_df &lt;- df %&gt;% <br/>      slice((start_index - 2):nrow(df))<br/>  }<br/>  <br/>  return(final_df)<br/>}</span></pre><p id="24b4" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">当函数在Riverside county上运行时，我们看到新数据正确地从3月15日开始。请注意，如果一个县从未连续三天出现病例，则该县的所有记录都将被排除。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="ed6f" class="lb ir hi kx b fi lc ld l le lf">my_id &lt;- "Riverside_California"</span><span id="eb19" class="lb ir hi kx b fi lg ld l le lf">final_df &lt;- trim_lead_days(my_id)</span><span id="112c" class="lb ir hi kx b fi lg ld l le lf">glimpse(final_df)</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/83a66a37dfec5e9a3ce7167945fec4ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ESnRCHbIF9fGbDi7BY--TA.png"/></div></div></figure><h1 id="e03c" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">我们如何为所有县做到这一点？</h1><p id="07da" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">超过2500个县报告了至少一例病例。上述函数适用于一个县。我们如何能让这在所有的县运行。“purrr”包为我们提供了一种在所有县进行反馈并返回结果的单一数据框架的方法。每次我使用这种在Hadley Wickham的<a class="ae km" href="https://www.youtube.com/watch?v=bzUmK0Y07ck" rel="noopener ugc nofollow" target="_blank">的《函数式编程的快乐》(针对数据科学</a>)中很出名的模式时，我都会惊讶于它是多么的强大和优雅。</p><p id="2089" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">这是处理整个数据集并分配给<code class="du lj lk ll kx b">final_df</code>所需的所有代码。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="94f1" class="lb ir hi kx b fi lc ld l le lf">final_df &lt;-  map_dfr(unique(us$id), ~ trim_lead_days(.x))</span></pre><h1 id="fa52" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">行数和郡数有什么区别？</h1><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="033a" class="lb ir hi kx b fi lc ld l le lf">trimmed_summary &lt;- tibble(type = "trimmed", <br/>                          rows = nrow(final_df), <br/>                         counties = length(unique(final_df$id)))<br/>source_summary &lt;- tibble(type = "source", <br/>                          rows = nrow(us), <br/>                         counties = length(unique(us$id)))</span><span id="3789" class="lb ir hi kx b fi lg ld l le lf">bind_rows(trimmed_summary, source_summary) %&gt;% <br/>  arrange(-rows)</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/027d833449f0820a0cea1f025770aac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9OfSeIPwjf8ecX5X0eRoBg.png"/></div></div></figure><p id="2af5" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">行数和郡数存在显著差异，因此要小心使用。</p><h1 id="c04d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">奖金代码</h1><p id="8745" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">这可能是我就这个主题写的唯一一篇论文，所以我想包含一些额外的代码，我认为这些代码对于刚开始使用这些数据的人来说很重要。</p><h1 id="4078" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">添加自第一个案例以来的天数</h1><p id="c780" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">数据集给你日期，仅此而已。很多时候，您会希望根据自病例开始被诊断以来的天数来比较各县。我们需要一个计数器来告诉我们从第一个案例开始已经过去了多少天。这将允许我们将每个县的每日数据与第一个病例/死亡的天数联系起来。这对于绘图非常有用，因为您将能够清楚地看到哪些县在控制增长方面做得更好。<br/> <em class="ln">记住，源数据中的第一天可能与修整数据中的第一天有很大不同。</em></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="91a1" class="lb ir hi kx b fi lc ld l le lf">us2 &lt;- us %&gt;% <br/>  arrange(id, date) %&gt;%<br/>  mutate(incrementer = 1) %&gt;% <br/>  group_by(id) %&gt;% <br/>  mutate(day_num = cumsum(incrementer)) %&gt;% <br/>  ungroup() %&gt;%<br/>  mutate(id = factor(id), <br/>         id_day_num = paste0(id, "_", as.character(day_num)), <br/>         type = "Actual") %&gt;% <br/>    arrange(id, day_num)<br/></span><span id="7918" class="lb ir hi kx b fi lg ld l le lf"># Get eight random counties for plotting<br/>set.seed(317)<br/>county_sample &lt;- sample(as.character(us2$id), 8, replace = FALSE)</span><span id="6e00" class="lb ir hi kx b fi lg ld l le lf">p_data &lt;- us2 %&gt;% <br/>  filter(id %in% county_sample)</span><span id="06e5" class="lb ir hi kx b fi lg ld l le lf">library(ggthemes)<br/>ggplot(p_data, aes(day_num, ttl_cases, color = id)) + <br/>  geom_line() +<br/>  ggtitle("Set to same start date: Total cases") +<br/>  theme_solarized() +<br/>  scale_colour_solarized()</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/39bef566ebc7c29914c6a6273a4d1ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i-EQONJOe38GX1VXKP1dfQ.png"/></div></div></figure><h1 id="3a01" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">添加县人口数据</h1><p id="293d" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">如果没有居住在该县的人数，病例的数量就没有那么重要了。纽约市可能有10，000个病例，但这仍然只是居住在那里的总人口的一小部分。较小的县可能有较高比例的公民被感染，但被城市中心产生的大量病例所掩盖。</p><p id="8ddc" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">我们将使用县人口的外部数据集，该数据集使用2010年人口普查的预测，可在此处获取<a class="ae km" href="https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/" rel="noopener ugc nofollow" target="_blank">。该数据有一个州和县fips代码，在连接到主数据帧之前，必须连接该代码。</a></p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="bf87" class="lb ir hi kx b fi lc ld l le lf">us_w_pop &lt;- read_csv("Data/co-est2019-alldata.csv") %&gt;%<br/>  select(STATE, COUNTY, STNAME, CTYNAME, POPESTIMATE2019) %&gt;%<br/>  rename(population = POPESTIMATE2019) %&gt;% <br/>  mutate(fips = paste0(STATE, COUNTY)) %&gt;% <br/>  right_join(us2, by = "fips") %&gt;% <br/>  mutate(pct_infected = ttl_cases / population, <br/>         pct_dead = ttl_deaths / population)</span></pre><h1 id="bdcd" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">受感染人口百分比图表</h1><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="fc3e" class="lb ir hi kx b fi lc ld l le lf">p_data &lt;- us_w_pop %&gt;% <br/>  filter(id %in% county_sample)</span><span id="b61c" class="lb ir hi kx b fi lg ld l le lf">ggplot(p_data, aes(day_num, pct_infected*100, color = id)) + <br/>  geom_line() +<br/>  ggtitle("Percent infected") +<br/>  theme_solarized() +<br/>  scale_colour_solarized()</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/385943ee4c94c38b1e9cf6785a91426b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sG7GEd0E9JWC-8qhYYElPA.png"/></div></div></figure><p id="4070" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">八个县中没有一个县的感染率超过0.15%。</p><h1 id="6a82" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">哪些县的感染率最高？</h1><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="d0d6" class="lb ir hi kx b fi lc ld l le lf">us_w_pop %&gt;% <br/>  group_by(id) %&gt;% <br/>  filter(date == max(date)) %&gt;% <br/>  ungroup() %&gt;% <br/>  select(id, ttl_cases, population, pct_infected) %&gt;% <br/>  arrange(-pct_infected) %&gt;% <br/>  top_n(10)</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/073eb55b8e856503867782ec8af552eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v-4nszYV1RPAjHGdX0QFrw.png"/></div></div></figure><p id="9205" class="pw-post-body-paragraph jo jp hi jq b jr kn jt ju jv ko jx jy jz kp kb kc kd kq kf kg kh kr kj kk kl hb bi translated">请注意，该组中有几个低人口县，截至2020年4月8日，没有一个县的居民感染率超过2%。</p><h1 id="5764" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">纽约怎么了？</h1><p id="8e2a" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">看起来纽约市没有与人口数据相匹配的FIPS代码。我不知道为什么会这样，但我想指出来。病例和死亡人数最多的地方没有人口是个问题。希望一个温和的读者会解决，并让我们知道如何获得纽约市的人口数据。</p><pre class="ks kt ku kv fd kw kx ky kz aw la bi"><span id="af67" class="lb ir hi kx b fi lc ld l le lf">us_w_pop %&gt;% <br/>  group_by(id) %&gt;% <br/>  filter(date == max(date)) %&gt;% <br/>  ungroup() %&gt;% <br/>  select(id, ttl_cases, population, pct_infected) %&gt;% <br/>  arrange(-ttl_cases) %&gt;% <br/>  slice(1:10)</span></pre><figure class="ks kt ku kv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/a114693a21477795dfde6bc11075c925.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xTRDsGPwTPpPFIWpv7cPsw.png"/></div></div></figure><h1 id="2d7d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">结束注释</h1><p id="5a73" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">总之，现在您已经有了代码和数据源，可以直接进入新冠肺炎在美国传播的探索性数据分析了。如果您在县一级进行预测，则“trim_lead_days()”函数将移除许多县具有的导致模型失去准确性的不规则期初数据。</p><h1 id="dbde" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">确认</h1><p id="0e59" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">我要感谢<a class="ae km" href="https://community.rstudio.com/t/filter-rows-before-threshold/59913" rel="noopener ugc nofollow" target="_blank"> RStudio社区</a>的Richard Careaga(又名技术官僚)给我提供了他关于这个主题的论文。<a class="ae km" href="https://technocrat.rbind.io/2019/12/26/run-length-encoding/" rel="noopener ugc nofollow" target="_blank">连胜怎么了？rle:游程编码</a>。</p><h1 id="5f8b" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">结束</h1></div></div>    
</body>
</html>