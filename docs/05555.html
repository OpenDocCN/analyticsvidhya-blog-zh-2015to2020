<html>
<head>
<title>Introduction to window function in pyspark with examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">pyspark中的窗口函数介绍及实例</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/intro-to-window-function-in-pyspark-with-examples-3a839b6e1cac?source=collection_archive---------7-----------------------#2020-04-25">https://medium.com/analytics-vidhya/intro-to-window-function-in-pyspark-with-examples-3a839b6e1cac?source=collection_archive---------7-----------------------#2020-04-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0601" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为数据科学家/数据工程师，大数据转型是一个非常重要的方面。Spark framework目前最常用于执行这些转换，无论是构建数据管道还是准备数据集来训练机器学习模型。</p><p id="b5e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文讨论了windows函数，如何使用它和它的不同应用。所以让我们开始吧！！！</p><ol class=""><li id="466f" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><strong class="ih hj">聚合</strong></li></ol><p id="3c49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">窗口函数可用于直接聚合，如均值、中值、众数等。这里我们举一个学生的数据集的例子，包括他们的科目和分数。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es jm"><img src="../Images/2979cb1f8cc58474ebb9f63736eaeba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*akLAnrJNdw8G2BmNqNyDLg.png"/></div></figure><p id="aa75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们想找到每个学生的学科平均分数，使用窗口函数可以这样做</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es ju"><img src="../Images/48b2ccfd9c28c00053332bb6ac8dcbb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ISsrikTKqr0tq44mLqWI0Q.png"/></div></div></figure><p id="d76b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述语法的工作原理是首先partitionBy函数创建不同的数据块(分区),每个数据块由传递相同键值(列)的数据组成，例如，一个分区将包含考试名称=哲学的所有数据，其他数据包含数学等。</p><p id="adef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了找到考试的平均值，我们使用pyspark.sql.Functions，F.avg()，指定在我们要计算平均值的窗口上。</p><p id="3483" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在执行上面的语句时，我们得到</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es jz"><img src="../Images/f37bc46e1dab9d13da65b9d18af4f6b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*xFWJJ0njoX_JbR4YIGjvxQ.png"/></div></figure><p id="282d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">排名</strong></p><p id="10ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设对于上面的数据集，我们想要每个科目的第二高分。这可以通过将rank和orderBy函数与窗口相结合来实现。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es ka"><img src="../Images/4291a8b7f0d50aa31dd6a1fe962e8eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*ffTO0pd56RpdXHQF3afHdw.png"/></div></figure><p id="6abc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们再次为每个考试名称创建分区，这次按照每个学生的分数降序排列每个分区。然后，我们简单地计算我们已经划分的窗口的等级。示例输出将如下所示</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kb"><img src="../Images/5531e04d81f6a65f06be9ae2d9dc017f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*nqVe8QfzTfopdZPoVUJyRg.png"/></div></figure><p id="2489" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们想要每个科目第二好的学生，可以通过</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kc"><img src="../Images/ef750bc35e17f19f9e738e1ef4621f52.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*fenbe5-0pYFGA7sOunn6gw.png"/></div></figure><p id="3bda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们得到的结果是</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kd"><img src="../Images/2e0c19e47150395b3d31a07a767eff66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*u0kkgBNtn0TcZeYEQ26DTw.png"/></div></figure><p id="a870" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我们使用排名函数F.rank()一样，我们也可以使用dense_rank()，ntile，percent_rank根据我们的要求进行排名。</p><p id="3c6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解析</strong></p><p id="0b50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最常见的分析应用之一是累积分布。对于那些不明白什么是累积分布的人来说，它是一个取值小于或等于的概率。对于上面给出的例子，假设我们想计算考试分数的累积分布。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es ke"><img src="../Images/d627bc89028aead0984e54dec9a23e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*6F0YD37aCXjMKKftrPvnzA.png"/></div></figure><p id="fa41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它给出了</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kf"><img src="../Images/808b62da42d73041cf04f689e4b74e6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cnwWHY3WfupifWt1Tr7N9A.png"/></div></div></figure><p id="e27a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如您所见，等级越高，累积分布越多。</p><p id="61c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">滞后()和超前()</strong></p><p id="ac9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，lag()和lead()函数也可用于在数据帧中创建滞后/领先列。这两个功能在涉及时间序列数据的转换中有广泛的应用。</p><p id="e2cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们希望每个学生的分数都与在该科目中排名仅次于他的学生的分数不同。这可以通过使用lag函数和窗口划分来实现。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kg"><img src="../Images/e5ff71a98c9136ef7f47d48a2ef06e47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*Htigt0SjQexinyS0UPl9zg.png"/></div></figure><p id="6a1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将给出一个包含“prev exam points”列的输出，其中学生的分数排在他的后面。这可以被验证为以前的考试点和考试点将在对角线上相同。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kh"><img src="../Images/64f9cac889a4324220e1a8d8750e1720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X9CDx9HO9AJBGQ4HK2TbXw.png"/></div></div></figure><p id="571a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于差来说，很简单，只需要两列的差</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es ki"><img src="../Images/0f2fc502c189cf85e3bdd89e407d4cf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DrhwKi1392BDsIetHNNIzg.png"/></div></div></figure><p id="b3cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们得到了</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kj"><img src="../Images/210ce39c8e34e1034c034e108e191c94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKUHeT3qq27xxurRzeuptQ.png"/></div></div></figure><p id="3a98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用lead()函数以及升序排序也可以做到这一点。</p><p id="35db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">指定窗口边界</strong></p><p id="5f44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这本身就是一个广泛的话题，需要单独的一篇文章。这里只涉及几个广泛使用的关键概念。</p><p id="cce4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Window对象有一个rowsBetween()函数，可用于指定边界。让我们通过一个例子来研究这个问题，假设我们想要当前排的学生和比他低5排的学生在这个问题上的移动平均分数。这可以按如下方式完成</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es kk"><img src="../Images/a548b532bb0980dd7d1e58f1b4adaf56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*-mLrYKRa0cRr65f6sPFU3A.png"/></div></figure><p id="a680" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在rowsBetween(-5，0)中，-5指定起始位置在当前行之前5行，0指定当前行。</p><p id="1bb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果要求我们计算从当前行到窗口分区开始的移动平均值，在这种情况下，我们不能给出数值-5，因为这将是一个大小不同的窗口。对于这个windows对象有一个属性叫做<code class="du kl km kn ko b">Window.unboundedPreceding and Window.unboundedFollowing.</code></p><p id="2acc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">window . unbounded preding表示分区的第一行，Window.unboundedFollowing表示分区的最后一行</strong>。所以对于我们手头的问题，命令是</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es kp"><img src="../Images/746745358a9ad8bed62feb7e53e9928b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1FLRrzrOmgElU8pA2CdctQ.png"/></div></div></figure><p id="cf3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="18dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除此之外，还有一些高级主题，如在窗口分区上应用UDF，以及关于窗口边界的更深入的讨论，这些超出了本文的范围，将在后续文章中讨论。</p><p id="a1a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读！！！</p></div></div>    
</body>
</html>