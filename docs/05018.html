<html>
<head>
<title>Google Cloud Platform Custom Model Upload , REST API Inference and Model Version Monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google云平台定制模型上传、REST API推理和模型版本监控</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/google-cloud-platform-custom-model-upload-rest-api-inference-and-model-version-monitoring-80216e69fbc2?source=collection_archive---------6-----------------------#2020-04-08">https://medium.com/analytics-vidhya/google-cloud-platform-custom-model-upload-rest-api-inference-and-model-version-monitoring-80216e69fbc2?source=collection_archive---------6-----------------------#2020-04-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/24527c2397583775832f4c350fac997a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Raz_IEUcgtfzBAmRhWaAnw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌人工智能平台</figcaption></figure><h1 id="bd50" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated"><strong class="ak">目标:</strong></h1><ol class=""><li id="7cee" class="js jt hi ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">我们将建立一个自定义模型，然后上传到谷歌云人工智能平台进行推理。我们将把IRIS数据集用于机器学习模型。</li><li id="c86e" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf kg kh ki kj bi translated">通过POSTMAN REST API访问模型。</li><li id="dffd" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf kg kh ki kj bi translated">监控模型在谷歌云AI平台上的表现。</li></ol><p id="85c3" class="pw-post-body-paragraph kp kq hi ju b jv kr ks kt jx ku kv kw jz kx ky kz kb la lb lc kd ld le lf kf hb bi translated">数据集:</p><p id="5bb8" class="pw-post-body-paragraph kp kq hi ju b jv kr ks kt jx ku kv kw jz kx ky kz kb la lb lc kd ld le lf kf hb bi translated"><a class="ae lg" href="https://gist.github.com/387878da45a36d32e4ccced3c6cad3ef.git" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/387878 da 45 a 36d 32 e 4 cc ced 3c 6 CAD 3 ef . git</a></p><p id="4ed7" class="pw-post-body-paragraph kp kq hi ju b jv kr ks kt jx ku kv kw jz kx ky kz kb la lb lc kd ld le lf kf hb bi translated"><strong class="ju hj">第一步:</strong></p><p id="591d" class="pw-post-body-paragraph kp kq hi ju b jv kr ks kt jx ku kv kw jz kx ky kz kb la lb lc kd ld le lf kf hb bi translated">让我们首先使用python创建一个样本模型。我们将在谷歌云平台上启动一个jupyter笔记本实例，并开发定制模型。</p><ul class=""><li id="1d1b" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">请在<a class="ae lg" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a>登录谷歌云平台</li><li id="feab" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf lk kh ki kj bi translated">导航到人工智能-&gt;人工智能平台-&gt;笔记本，并启用API(如果尚未启用)。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/d88f07ee299953b1cc2caecdd8d89210.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rfbuNnuQdT-vC1A4DuOvCQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">启用API</figcaption></figure><ul class=""><li id="6fa5" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">点击“新建实例”并选择Python。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/8b6ebeca5f7eb314846f343ccd341be4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iMMTNn85_mxmBBAU7rWNeA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">创建一个安装了Python的新实例</figcaption></figure><ul class=""><li id="b687" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">提供实例名称并保持网络不变。默认情况下，GCP提供4C 15GB内存实例。您可以点击定制和更改配置来降低成本。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/fb783b314905591fe3d87692ff075d2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fiP8-QXe-bNP6YbvH143SA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">机器学习实例配置</figcaption></figure><ul class=""><li id="14e1" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">该实例将在几秒钟内创建，如下所示。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/0c372317f47b0fa4b2c8a46a0b6ed8ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pNPmOt3mc_wtbXh8GnrzlQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">实例已创建</figcaption></figure><ul class=""><li id="7147" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">现在点击“打开JUPYTERLAB”按钮，它将打开一个新窗口，如下所示。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/42a10d2c13db908bf5dec3def2a7ab40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MnvD1GSttzFRYy3OnlfwsQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Jupyter接口</figcaption></figure><ul class=""><li id="40b0" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">点击“Python 3”启动笔记本。将笔记本从“Untitled.ipynb”重命名为“machine-learning.ipynb”。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/03a57052395bea348913a6aa3b092741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E-rR5T2e1Cqh567bt01d5A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">重命名笔记本名称</figcaption></figure><ul class=""><li id="e76f" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">创建一个GCS bucket，上传IRIS数据集的data.csv文件，并在其中创建一个名为“model”的文件夹。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/09b05b0ba297357638a25e81bfcb5396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xORQ3MgHMqJ-Hh_4eYHR9w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Google云存储桶设置</figcaption></figure><ul class=""><li id="9e4c" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">现在在jupyter笔记本界面中执行下面这段代码。(<strong class="ju hj">注意:请适当更改BUCKET_NAME变量。</strong>)。该脚本将读取数据，训练模型，将其导出到本地，然后上传到GCS bucket。</li></ul><pre class="lm ln lo lp fd lv lw lx ly aw lz bi"><span id="2303" class="ma iv hi lw b fi mb mc l md me"># Install specific version of scilit framework that gcp supports as of this writing<br/>!pip uninstall scikit-learn --yes<br/>!pip install -Iv scikit-learn==0.20.3</span><span id="ea07" class="ma iv hi lw b fi mf mc l md me">#Libraries<br/>import datetime<br/>import os<br/>import subprocess<br/>import sys<br/>import pandas as pd<br/>from sklearn import svm<br/>from sklearn.externals import joblib<br/>import sklearn<br/>print('sklearn: {}'.format(sklearn.__version__))</span><span id="45f4" class="ma iv hi lw b fi mf mc l md me"># Cloud Storage<br/>BUCKET_NAME = '&lt;&lt;BucketName&gt;&gt;'<br/>FILENAME = 'data.csv'<br/>DIRECTORY = 'gs://&lt;&lt;BucketName&gt;&gt;'<br/>STORAGE = os.path.join(DIRECTORY, FILENAME)</span><span id="0043" class="ma iv hi lw b fi mf mc l md me">#Download the datafile<br/>!gsutil cp $STORAGE .</span><span id="b818" class="ma iv hi lw b fi mf mc l md me"># Read the data<br/>iris_data = pd.read_csv(FILENAME)<br/>iris_data.head()<br/>iris_label = iris_data.pop('species')</span><span id="a05f" class="ma iv hi lw b fi mf mc l md me">#Train the model<br/>classifier = svm.SVC(gamma='auto')<br/>classifier.fit(iris_data, iris_label)</span><span id="bbb3" class="ma iv hi lw b fi mf mc l md me"># Predict some instances<br/>print(iris_data.iloc[147:149])<br/>classifier.predict(iris_data.iloc[147:149])</span><span id="cb97" class="ma iv hi lw b fi mf mc l md me"># Classes<br/>classifier.classes_</span><span id="6c63" class="ma iv hi lw b fi mf mc l md me">#Export the model locally. The modelname should be only as mentioned below.<br/>model_filename = 'model.joblib'<br/>joblib.dump(classifier, model_filename)</span><span id="23e6" class="ma iv hi lw b fi mf mc l md me">#Upload the local model to cloud bucket.<br/>!gsutil cp $model_filename gs://$BUCKET_NAME/model</span></pre><ul class=""><li id="aee3" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">下一步是在GCP平台上创建一个模型版本，从这里可以对其进行服务和监控。请执行下面的脚本，该脚本将在其中创建一个模型和模型版本。(<strong class="ju hj">注意:请适当修改BUCKET_NAME &amp; REGION_NAME变量。</strong>)</li></ul><pre class="lm ln lo lp fd lv lw lx ly aw lz bi"><span id="de75" class="ma iv hi lw b fi mb mc l md me">MODEL_DIR="gs://&lt;&lt;BUCKET_NAME&gt;&gt;/model"<br/>VERSION_NAME="v1"<br/>MODEL_NAME="iris"<br/>FRAMEWORK="SCIKIT_LEARN"<br/>REGION_NAME="&lt;&lt;REGION_NAME&gt;&gt;"</span><span id="012d" class="ma iv hi lw b fi mf mc l md me">#Enable the service if not enabled<br/>!gcloud services enable ml.googleapis.com</span><span id="1d06" class="ma iv hi lw b fi mf mc l md me">#Create the model in GCP<br/>!gcloud ai-platform models create $MODEL_NAME --regions $REGION_NAME</span><span id="06b1" class="ma iv hi lw b fi mf mc l md me">#Create a version within the above created model.<br/>!gcloud ai-platform versions create $VERSION_NAME --model=$MODEL_NAME --origin $MODEL_DIR --runtime-version=1.14 --framework $FRAMEWORK --python-version=3.5</span></pre><ul class=""><li id="5331" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">现在，让我们转到GCP平台，验证创建的模型和版本。请访问人工智能-&gt; AI平台-&gt;模型。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/727d2d13de3335518be6c340c4827620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JE4BYy6S36p1iElbJ0JKFg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">GCP平台上托管的模型</figcaption></figure><ul class=""><li id="f0f1" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">现在我们可以创建模型的多个版本，并在这个模型上托管它。我们已经托管了模型的版本“v1 ”,该版本目前被标记为默认版本。如果对模型做了任何更改，它可以作为V2版本上传，一旦测试完成，它可以被标记为默认版本。单击型号名称，查看其中的不同版本。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/bcfe9ebb337dccf1d2632160485b8b35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DXMo6pH9dhgn7pXp8iL5YA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">GCP平台上的车型版本</figcaption></figure><ul class=""><li id="4839" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">点击版本V1查看模型的实际细节。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/6040364875e6bed29361cfded1296c2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gPODv4zcuyfF1Vgnaz0MDg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">型号版本详细信息。</figcaption></figure><ul class=""><li id="a405" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">这完成了我们上传一个定制的机器学习模型到GCP平台的第一个目标。注意，这里我们使用了一个GCP笔记本实例来创建一个样本机器学习模型。但是，您也可以在本地机器或内部创建相同的内容，然后上传到GCP进行推理。</li></ul><p id="7458" class="pw-post-body-paragraph kp kq hi ju b jv kr ks kt jx ku kv kw jz kx ky kz kb la lb lc kd ld le lf kf hb bi translated"><strong class="ju hj">第二步:</strong></p><ul class=""><li id="9b16" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">现在我们将使用POSTMAN APIs来调用这个模型进行推理。为了使用API，我们需要Auth令牌。请在笔记本中执行以下命令，以生成相同的内容并记录下来:</li></ul><pre class="lm ln lo lp fd lv lw lx ly aw lz bi"><span id="9363" class="ma iv hi lw b fi mb mc l md me">!gcloud auth application-default print-access-token</span></pre><ul class=""><li id="027f" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">这个模型推理的通用API如下。这将总是选择默认版本。</li></ul><pre class="lm ln lo lp fd lv lw lx ly aw lz bi"><span id="a11c" class="ma iv hi lw b fi mb mc l md me">POST https://ml.googleapis.com/v1/projects/&lt;&lt;projectid&gt;&gt;/models/&lt;&lt;model&gt;&gt;:predict?access_token=&lt;&lt;access_token&gt;&gt;</span></pre><ul class=""><li id="bfea" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">但是，如果您想要访问上传的模型的任何特定版本，请使用下面的API。这将选择特定的版本。</li></ul><pre class="lm ln lo lp fd lv lw lx ly aw lz bi"><span id="1a48" class="ma iv hi lw b fi mb mc l md me">POST https://ml.googleapis.com/v1/projects/&lt;&lt;projectid&gt;&gt;/models/&lt;&lt;model&gt;&gt;<strong class="lw hj"><em class="mg">/versions/&lt;&lt;version&gt;&gt;</em></strong>:predict?access_token=&lt;&lt;access_token&gt;&gt;</span></pre><ul class=""><li id="f6b5" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">请查看模型推断需要如何发出API请求。</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/cca2aa3a781629dcc04c03f29e798d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FPd4xRjQGCoYixTSBxZ1pw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用API进行模型推理</figcaption></figure><ul class=""><li id="17c0" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">这就结束了我们的第二个目标。</li></ul><p id="f09d" class="pw-post-body-paragraph kp kq hi ju b jv kr ks kt jx ku kv kw jz kx ky kz kb la lb lc kd ld le lf kf hb bi translated"><strong class="ju hj">第三步:</strong></p><ul class=""><li id="5a4c" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">现在，让我们在所提供的API的Google云平台上监控模型的性能。谷歌为此提供了一个易于使用的界面。</li><li id="ab74" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf lk kh ki kj bi translated">转到谷歌控制台-&gt;人工智能-&gt; AI平台-&gt;模型</li><li id="7ab4" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf lk kh ki kj bi translated">点击版本名V1。</li><li id="d714" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf lk kh ki kj bi translated">单击性能选项卡。您将看到如下屏幕</li></ul><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/acae79a71376798c7b293dfdb010c418.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GQykVJuUZRZmzHDYT6vWQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">模型性能— 1</figcaption></figure><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/7350d545ee12e982eaee059ce0de9075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*81tmCFVXlnldEMvvjHz5EA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">模型性能-2</figcaption></figure><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/c0a46a39a7dc5939b0c625aa3a2d2c5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a2AIj2QzJqjL3gAgXuoZLw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">模型性能-3</figcaption></figure><ul class=""><li id="52df" class="js jt hi ju b jv kr jx ku jz lh kb li kd lj kf lk kh ki kj bi translated">这就完成了我们的第三个目标。</li><li id="7c30" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf lk kh ki kj bi translated">如果有任何疑问，请提出意见，我很乐意帮助您。</li><li id="e7ee" class="js jt hi ju b jv kk jx kl jz km kb kn kd ko kf lk kh ki kj bi translated">感谢<a class="mj mk ge" href="https://medium.com/u/c869de7c23a6?source=post_page-----80216e69fbc2--------------------------------" rel="noopener" target="_blank">何塞·米格尔·阿里埃塔</a>撰写本文<a class="ae lg" rel="noopener" href="/google-cloud/online-predictions-api-using-scikit-learn-and-cloud-machine-learning-engine-on-gcp-10f86585e11e">https://medium . com/Google-cloud/online-predictions-API-using-scikit-learn-and-cloud-machine-learning-engine-on-GCP-10f 86585 e11e</a>提供了大量输入。</li></ul></div></div>    
</body>
</html>