<html>
<head>
<title>Journey of Apache Kafka &amp; Zookeeper Administrator ( Part 3 )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇卡夫卡与动物园管理员之旅(三)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-3-e31c2f330895?source=collection_archive---------17-----------------------#2020-08-22">https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-3-e31c2f330895?source=collection_archive---------17-----------------------#2020-08-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e817" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">【2019年6月(续)</p><p id="b265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/@116davinder/journey-of-apache-kafka-zookeeper-administrator-part-2-38db736d3163">在之前的文章</a>中，我已经解释了<strong class="ih hj">阿帕奇动物园管理员</strong>的不同方面，而在这篇文章中，我将涵盖最初的<strong class="ih hj">阿帕奇卡夫卡</strong>方面。<strong class="ih hj"> Ansible闪耀魔力。</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/50a085e758ef8c62ac4effe86545e808.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYez2s6xCgH_yWyw1A1n6A.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">主机集成仪表板上的新遗迹</figcaption></figure></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="a306" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> GitHub代码库:</strong><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible" rel="noopener ugc nofollow" target="_blank">116 dav inder/Kafka-cluster-ansi ble</a></p><p id="0e4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可翻译的剧本和角色的结构与<strong class="ih hj">阿帕奇动物园管理员</strong>相同，以确保我的一致性，并在需要时易于他人理解。<br/>以下是为<strong class="ih hj">阿帕奇卡夫卡增加的额外角色。</strong></p><p id="e4ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/tree/master/roles/crons" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">crons</strong></a><strong class="ih hj">:</strong>该角色将在root用户下添加一个清理cron任务，以便我们可以清理Apache Kafka服务器日志。<br/><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/tree/master/roles/nri-kafka" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">nri-Kafka</strong></a><strong class="ih hj">:</strong>这个角色将加入JMX基础的新遗迹整合。</p><p id="346b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">其他角色:</strong><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/tree/master/roles" rel="noopener ugc nofollow" target="_blank">116 da vinder/Kafka-cluster-ansi ble/Roles</a></p><p id="140c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是为阿帕奇卡夫卡增加的额外剧本。</p><p id="1061" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/clusterAddNodes.yml" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">【clusteraddnodes . yml</strong></a><strong class="ih hj">:</strong>这个剧本会给给定的Apache Kafka集群添加更多的代理节点。</p><p id="df10" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">伐木<br/> </strong>和<strong class="ih hj">阿帕奇动物园管理员</strong>一样，只是位置变了。</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="c0d3" class="kg kh hi kc b fi ki kj l kk kl">[default]<br/>host = $HOSTNAME<br/><br/>[monitor:///kafka/kafka-logs/*.log]<br/>disabled = false<br/>index = kafka<br/>sourcetype = kafka<br/>crcSalt = &lt;SOURCE&gt;</span></pre><p id="2d0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">监控过山车<br/> </strong>因为我们有Splunk，所以我发现基于Splunk的监控可以做得和<a class="ae jd" href="https://splunkbase.splunk.com/app/4268/" rel="noopener ugc nofollow" target="_blank"> Kafka智能监控</a>一样好。经过研究我意识到它需要<strong class="ih hj"> Splunk Hec模块、</strong> <a class="ae jd" href="https://www.influxdata.com/time-series-platform/telegraf/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Telegraf </strong> </a>和<strong class="ih hj">Jolokia</strong><strong class="ih hj"/>JMX出口商这些组件对于<strong class="ih hj">阿帕奇卡夫卡监听</strong>来说相当难以消化。</p><p id="54fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们也有新遗迹，所以我决定寻找新遗迹选项。<br/>在他们的网站上，他们已经批准了阿帕奇卡夫卡<strong class="ih hj">的整合，我决定试一试。<br/> <strong class="ih hj">新遗物整合:</strong><a class="ae jd" href="https://docs.newrelic.com/docs/integrations/host-integrations/host-integrations-list/kafka-monitoring-integration" rel="noopener ugc nofollow" target="_blank">docs.newrelic.com/kafka-monitoring-integration</a><br/>实施后他们提到了什么，<em class="km">我很失望</em>😞<em class="km">当我检查Apache Kafka的New Relic预定义仪表板时，他们的结果。他们的大多数仪表板图表都不起作用，许多指标都被排除在外。<br/> </em>所以我决定，我必须为它找到另一个解决方案，当前的解决方案可以工作，但如果出了问题，我将无法调试与Apache Kafka相关的生产问题，我真的不想至少在这个项目中，我不知道发生了什么，在哪里发生了什么？在谷歌上研究定制解决方案后，我知道所有的阿帕奇卡夫卡指标都可以通过JMX获得，现在，我只需要一种方法来读取它们并将它们导出到某个地方。<em class="km">幸运的是，我发现New Relic也支持JMX</em><em class="km"/>，它可以读取并导出JMX指标到<strong class="ih hj"> New Relic Insights </strong>，在那里我可以使用<strong class="ih hj"> NRQL </strong>来创建仪表板。</strong></p><p id="56d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">老实说</strong>，这是一项艰巨的工作，2019年6月几乎过去了一半，组织中的一些人开始询问Apache Kafka的准备情况。</p><p id="079d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">新遗迹JMX集成:</strong><a class="ae jd" href="https://docs.newrelic.com/docs/integrations/host-integrations/host-integrations-list/jmx-monitoring-integration" rel="noopener ugc nofollow" target="_blank"/><br/>几天之内，我就能够破解上面提到的集成方法，并开始向<strong class="ih hj">新遗迹洞察导出指标。上面的集成支持JMX查询，所以我必须为Apache Kafka构建相当多的查询。甚至在此之前，我必须知道我需要收集什么该死的指标，所以我开始再次研究，并在关于监控的汇合文件上结束:<a class="ae jd" href="https://docs.confluent.io/current/kafka/monitoring.html" rel="noopener ugc nofollow" target="_blank">docs.confluent.io/kafka/monitoring.html</a>。</strong></p><p id="0d25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想感谢你的汇合真正伟大的文件。甚至他们也提到了应该用于度量提取的JMX查询。</p><p id="ac22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还必须安装集成所需的两个插件。<a class="ae jd" href="https://download.newrelic.com/infrastructure_agent/linux/yum/el/7/x86_64/nri-jmx-2.4.4-1.x86_64.rpm" rel="noopener ugc nofollow" target="_blank">nri-JMX-2 . 4 . 4–1 . x86 _ 64 . rpm</a><br/>2 .<a class="ae jd" href="https://download.newrelic.com/infrastructure_agent/linux/yum/el/7/x86_64/nrjmx-1.5.2-1.x86_64.rpm" rel="noopener ugc nofollow" target="_blank">nrjmx-1 . 5 . 2–1 . x86 _ 64 . rpm</a></p><p id="ab3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最后，</strong>我准备好了所有的监控组件，并且迫不及待地想要尝试一下，<br/>下面是一个关于<strong class="ih hj"> JVM指标</strong>的例子</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="aa76" class="kg kh hi kc b fi ki kj l kk kl">collect:<br/># Standard JVM Metrics<br/>    - domain: java.lang<br/>      event_type: kafkaMonitoring<br/>      beans:<br/>          - query: type=GarbageCollector,name=*<br/>            attributes:<br/>                - CollectionCount<br/>                - CollectionTime<br/>          - query: type=Memory<br/>            attributes:<br/>                - HeapMemoryUsage.Max<br/>                - HeapMemoryUsage.Used<br/>                - NonHeapMemoryUsage.Used<br/>          - query: type=Threading<br/>            attributes:<br/>                - ThreadCount<br/>                - PeakThreadCount<br/>          - query: type=ClassLoading<br/>            attributes:<br/>                - LoadedClassCount</span></pre><p id="360f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个关于<strong class="ih hj">阿帕奇卡夫卡指标</strong>的例子</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="c81b" class="kg kh hi kc b fi ki kj l kk kl">collect:<br/># source: https://docs.confluent.io/current/kafka/monitoring.html<br/><br/>    - domain: kafka.controller<br/>      event_type: kafkaMonitoring<br/>      beans:<br/>          - query: type=KafkaController,name=*<br/>          - query: type=ControllerStats,name=*<br/>....<br/>    - domain: kafka.log<br/>      event_type: kafkaMonitoring<br/>      beans:<br/>          - query: type=LogFlushStats,name=LogFlushRateAndTimeMs<br/>....<br/>    - domain: kafka.network<br/>      event_type: kafkaMonitoring<br/>      beans:<br/>          - query: type=RequestChannel,name=RequestQueueSize<br/>          - query: type=RequestMetrics,name=TotalTimeMs,request=*<br/>          - query: type=RequestMetrics,name=*,request=*<br/>....</span><span id="6278" class="kg kh hi kc b fi kn kj l kk kl">    - domain: kafka.server<br/>      event_type: kafkaMonitoring<br/>      beans:<br/>          - query: type=*,name=*<br/><br/>    - domain: kafka.utils<br/>      event_type: kafkaMonitoring<br/>      beans:<br/>          - query: type=*,name=*</span></pre><p id="4ba9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据文档，我将这些YAML格式的查询添加到New Relic Infra Agent中,“瞧”,它工作了，但我没有意识到有几个指标丢失了。有点令人沮丧的是，我做了文档中所说的一切，只有一半的指标被导出到New Relic，所以我决定我必须调试这个问题，经过一天的调试，我发现New Relic插件有限制，它不能处理超过数百个事件，但我对我的配置生成的事件数量并不感到惊讶。对我来说，启用New Relic的调试模式也很有趣。无论如何，我设法启用了调试模式，并震惊地发现我的配置正在生成4-5k事件/秒，这他妈的高于默认情况下允许的新遗物插件，所以现在我必须找出地狱，我可以增加新遗物JMX插件的限制，并诚实地说，新遗物关于这些基于社区的插件的文档非常糟糕，幸运的是这些插件是由新遗物开源的(✌️ Kudos！)我开始检查这些插件的实际代码库，发现插件确实有默认限制，并且可以被一个名为“metric_limit”的参数覆盖，现在问题开始了，我他妈的应该把这个参数放在哪里，像哪个他妈的文件。在做了5-10次以上的尝试后，我发现它应该被添加到主<a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/roles/nri-kafka/templates/jmx-config.yml" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> jmx-config.yml </strong> </a>文件的arguments下。</p><p id="0335" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还删除了额外的指标以减少指标总数，并添加了标签，因为我从10多个不同的集群中导出了指标，标签是区分它们的唯一方式。</p><p id="e234" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">仅供参考:</strong>不要向New Relic发布太多指标，因为他们会向你收取每项指标的费用，对我的公司来说，这是免费的，因为💰💰💰它还会占用大量的网络带宽，而Apache Kafka应该将这些带宽用于实际工作。</p><p id="1ce1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">终于！</strong>所有指标都进入了<strong class="ih hj"> New Relic Insights </strong>并开始开发基于NRQL(又名New Relic查询语言)的Insights Dashboard。这很简单，但我意识到所有的JMX数据都被添加到New Relic Insights的默认数据库中，我有点担心如果其他人开始使用JMX集成，这个数据库会变得一团糟，所以我也找到了一个小技巧，那就是你可以在New Relic Insights中通过向JMX查询添加一个参数来创建自己的数据库。</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="aa86" class="kg kh hi kc b fi ki kj l kk kl">event_type: kafkaMonitoring</span></pre><p id="9013" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦添加了上面的“event _ type ”, NRQL查询就只对我的用例是唯一的了。<br/> <strong class="ih hj">之前事件_类型:</strong></p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="7d72" class="kg kh hi kc b fi ki kj l kk kl">SELECT latest(Value) from <strong class="kc hj">JMXSample </strong>TIMESERIES FACET host,`key:name`  where bean like 'type=KafkaController,name=%'</span></pre><p id="4ae8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">事件类型之后:</strong></p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="14a2" class="kg kh hi kc b fi ki kj l kk kl">SELECT latest(Value) from <strong class="kc hj">kafkaMonitoring </strong>TIMESERIES FACET host,`key:name`  where bean like 'type=KafkaController,name=%'</span></pre><p id="7fb1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">【docs.newrelic.com/nrql-new-relic-query-language】NRQL文档:T4</p><p id="9992" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">手动步骤😠<br/> </strong>创建新遗迹洞察仪表板。</p><p id="9634" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="km">需要记住的几件事是，New Relic Infra Agent将指标发布到New Relic Insights中的另一个数据库。</em> </strong> <br/> <strong class="ih hj">系统示例:</strong>用于存储CPU指标。<br/> <strong class="ih hj"> StorageSample: </strong>用于存储磁盘规格。<br/> <strong class="ih hj"> NetworkSample: </strong>用于存储网络度量。<br/> <strong class="ih hj"> kafkaMonitoring: </strong>用于存储实际的Kafka指标。</p><p id="ad46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<a class="ae jd" href="https://docs.newrelic.com/docs/apis/rest-api-v2/api-explorer-v2/use-api-explorer" rel="noopener ugc nofollow" target="_blank"> New Relic API Explorer </a>导入下面的dashboard JSON代码。<br/> <strong class="ih hj">新遗迹仪表盘代码:</strong> <a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/files/newrelic-dashboards/kafka.json" rel="noopener ugc nofollow" target="_blank">新遗迹-仪表盘-kafka.json </a> <br/> <strong class="ih hj">新遗迹仪表盘示例:</strong><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/files/newrelic-dashboards/Apache%20Kafka.pdf" rel="noopener ugc nofollow" target="_blank">Apache-Kafka.pdf</a></p><p id="7a3d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我从<strong class="ih hj"> New Relic Insights </strong>创建仪表板时，New Relic宣布<strong class="ih hj"> Insights </strong>将被<strong class="ih hj"> New Relic One </strong>弃用，所以我也开始将我的仪表板迁移到<strong class="ih hj"> New Relic One </strong>。</p><p id="3186" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的GitHub库也有其他剧本/角色，但我会在以后的文章中介绍它们，因为这是我的故事，而这篇文章不适合它们。</p></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="4b89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">阿帕奇卡夫卡优化之旅将在下篇开始！</p></div></div>    
</body>
</html>