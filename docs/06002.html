<html>
<head>
<title>Subscribing to Google PubSub Topics with Spring Boot GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与Spring Boot·GCP一起订阅谷歌发布主题</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/subscribing-to-google-pubsub-topics-with-spring-boot-gcp-98fb4573bf4a?source=collection_archive---------8-----------------------#2020-05-08">https://medium.com/analytics-vidhya/subscribing-to-google-pubsub-topics-with-spring-boot-gcp-98fb4573bf4a?source=collection_archive---------8-----------------------#2020-05-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/13c380d4c44c58e25c14d96557b71139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e4sUNaG9y4ErnK51LFeNPA.jpeg"/></div></div></figure><p id="b258" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是我上一篇文章<a class="ae jo" rel="noopener" href="/tech-sauce/retrieving-conversation-history-from-dialogflow-bf3d41320420">从Dialogflow </a>中检索对话历史的延续。在那里，我们将Dialogflow日志导出到<a class="ae jo" href="https://cloud.google.com/logging" rel="noopener ugc nofollow" target="_blank"> Google Stackdriver </a>，然后将它们路由到<a class="ae jo" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank"> Google PubSub </a>主题。我们还在本地机器上安装了<a class="ae jo" href="https://cloud.google.com/sdk" rel="noopener ugc nofollow" target="_blank"> Google Cloud SDK </a>，并使用<strong class="is hj"> gcloud </strong>命令订阅了主题。在本文中，我们将实现一个Spring Boot应用程序，它可以订阅我们的PubSub主题。</p><h2 id="b0d0" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">从Spring Boot开始</h2><p id="121f" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">由于这不是一个Spring Boot教程，我将不会解释如何设置您的Spring Boot应用程序。参见<a class="ae jo" href="https://spring.io/guides/gs/spring-boot/" rel="noopener ugc nofollow" target="_blank">https://spring.io/guides/gs/spring-boot/</a>开始使用。我更愿意选择使用<a class="ae jo" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring初始化器</a>来建立一个Spring Boot应用程序。</p><p id="8d79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将是我的<strong class="is hj"> pom.xml </strong></p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="fc4d" class="jp jq hi ku b fi ky kz l la lb">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;project  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;<br/>   &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br/>   &lt;parent&gt;<br/>      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>      &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;<br/>      &lt;version&gt;2.2.6.RELEASE&lt;/version&gt;<br/>      &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;<br/>   &lt;/parent&gt;<br/>   &lt;groupId&gt;com.dialog&lt;/groupId&gt;<br/>   &lt;artifactId&gt;chatboard&lt;/artifactId&gt;<br/>   &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;<br/>   &lt;name&gt;chatboard&lt;/name&gt;<br/>   &lt;description&gt;PubSub subscriber and Dashboard backend&lt;/description&gt;<br/>   &lt;properties&gt;<br/>      &lt;java.version&gt;1.8&lt;/java.version&gt;<br/>      &lt;spring-cloud.version&gt;Hoxton.SR3&lt;/spring-cloud.version&gt;<br/>      &lt;elasticsearch.version&gt;7.3.0&lt;/elasticsearch.version&gt;<br/>   &lt;/properties&gt;<br/>   &lt;dependencies&gt;<br/>      &lt;dependency&gt;<br/>         &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>         &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br/>      &lt;/dependency&gt;<br/>      &lt;dependency&gt;<br/>         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>         &lt;artifactId&gt;spring-cloud-gcp-starter&lt;/artifactId&gt;<br/>      &lt;/dependency&gt;<br/>      &lt;dependency&gt;<br/>         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>         &lt;artifactId&gt;spring-cloud-gcp-starter-pubsub&lt;/artifactId&gt;<br/>      &lt;/dependency&gt;<br/>      &lt;dependency&gt;<br/>         &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;<br/>         &lt;artifactId&gt;spring-integration-core&lt;/artifactId&gt;<br/>      &lt;/dependency&gt;<br/>      &lt;dependency&gt;<br/>         &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>         &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br/>         &lt;scope&gt;test&lt;/scope&gt;<br/>         &lt;exclusions&gt;<br/>            &lt;exclusion&gt;<br/>               &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;<br/>               &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;<br/>            &lt;/exclusion&gt;<br/>         &lt;/exclusions&gt;<br/>      &lt;/dependency&gt;<br/>   &lt;/dependencies&gt;<br/>   &lt;dependencyManagement&gt;<br/>      &lt;dependencies&gt;<br/>         &lt;dependency&gt;<br/>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br/>            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;<br/>            &lt;version&gt;${spring-cloud.version}&lt;/version&gt;<br/>            &lt;type&gt;pom&lt;/type&gt;<br/>            &lt;scope&gt;import&lt;/scope&gt;<br/>         &lt;/dependency&gt;<br/>      &lt;/dependencies&gt;<br/>   &lt;/dependencyManagement&gt;<br/>   &lt;build&gt;<br/>      &lt;plugins&gt;<br/>         &lt;plugin&gt;<br/>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;<br/>         &lt;/plugin&gt;<br/>      &lt;/plugins&gt;<br/>   &lt;/build&gt;<br/>&lt;/project&gt;</span></pre><h2 id="48ae" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">春云GCP</h2><p id="2abf" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated"><a class="ae jo" href="https://spring.io/projects/spring-cloud-gcp" rel="noopener ugc nofollow" target="_blank"> Spring Cloud GCP </a>提供了广泛的库集合，使得从Spring框架应用程序中使用Google云平台变得更加容易。我们将使用Spring Cloud GCP发布/订阅支持(Spring Integration和Spring Cloud Stream Binder)。查看本文件了解详细信息。</p><h2 id="e2a2" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">Google云服务帐户凭据</h2><p id="b688" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">还记得我们的Stackdriver日志和来自<a class="ae jo" rel="noopener" href="/tech-sauce/retrieving-conversation-history-from-dialogflow-bf3d41320420">上一篇文章</a>的PubSub主题吗？所有这些都存在于谷歌云项目中，我的项目是<strong class="is hj"> CHITTI </strong>。每个项目可以有几个服务帐户，我们需要相关的<a class="ae jo" href="https://cloud.google.com/iam/docs/service-accounts" rel="noopener ugc nofollow" target="_blank">服务帐户</a>的凭证作为json文件，以便从我们的Spring Boot应用程序与项目通信。</p><p id="e95f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从谷歌云控制台的侧边菜单中，选择<code class="du lc ld le ku b">IAM &amp; Admin -&gt; Service Accounts</code>。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/d86a9c5d6e038b848a657a9f534cf4c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/format:webp/1*G_Kc0AqJdrZTXFPnXwD7_g.png"/></div></figure><p id="60a6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击名为“App Engine默认服务帐户”的服务帐户旁边的⋮，然后选择<code class="du lc ld le ku b">Create key</code>。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/3f9128714c9989a7f4b73a288cebf893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rhSoMmOdtL0tbKRKCTffDg.png"/></div></div></figure><p id="c40a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一个窗口中，选择<strong class="is hj"> JSON </strong>作为<strong class="is hj">键类型</strong>，点击<code class="du lc ld le ku b">CREATE</code>。一个Json文件将被下载到您的计算机上。将文件复制到您喜欢的文件夹中。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div class="er es lh"><img src="../Images/90e2420d4f9949e9a1e48fb73bfa3d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*QS6HCjA2-73GUhHEmbud0g.png"/></div></figure><h2 id="31f1" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">订阅谷歌发布主题</h2><p id="c7c2" class="pw-post-body-paragraph iq ir hi is b it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj ko jl jm jn hb bi translated">在您的Spring Boot应用程序中，在<strong class="is hj"> resources </strong>文件夹中创建一个<strong class="is hj"> application.properties </strong>文件，然后添加以下内容。将<strong class="is hj"> <em class="li">项目Id </em> </strong>替换为您的Google Cloud项目Id，将<strong class="is hj"><em class="li">json文件路径</em> </strong>替换为您刚刚下载的Json文件的<strong class="is hj"> <em class="li"> </em> </strong>路径。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="f40f" class="jp jq hi ku b fi ky kz l la lb">spring.cloud.gcp.project-id=<strong class="ku hj"><em class="li">project-Id</em></strong><br/>spring.cloud.gcp.credentials.location=file:<strong class="ku hj"><em class="li">path-to-json-file</em></strong></span></pre><p id="af92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个<strong class="is hj">配置</strong>文件，并添加以下代码。将<strong class="is hj"> <em class="li">订阅名称</em> </strong>替换为您在我们的<a class="ae jo" rel="noopener" href="/tech-sauce/retrieving-conversation-history-from-dialogflow-bf3d41320420">上一篇文章</a>中为您的订阅提供的名称。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="766c" class="jp jq hi ku b fi ky kz l la lb">@Bean<br/>public MessageChannel pubsubInputChannel() {<br/>    return new DirectChannel();<br/>}<br/><br/>@Bean<br/>public PubSubInboundChannelAdapter messageChannelAdapter(<br/>        @Qualifier("pubsubInputChannel") MessageChannel inputChannel,<br/>        PubSubTemplate pubSubTemplate) {<br/>    PubSubInboundChannelAdapter adapter =<br/>            new PubSubInboundChannelAdapter(pubSubTemplate, "<strong class="ku hj"><em class="li">subscription-name</em></strong>");<br/>    adapter.setOutputChannel(inputChannel);<br/><br/>    return adapter;<br/>}</span></pre><p id="c031" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在主类中，添加下面的。这里<strong class="is hj"> DemoApplication </strong>是我的主类。这将把从PubSub收到的消息记录到您的控制台。实际上，这些消息是来自你的Dialogflow聊天机器人的<a class="ae jo" rel="noopener" href="/tech-sauce/retrieving-conversation-history-from-dialogflow-bf3d41320420"> <strong class="is hj">对话历史</strong> </a>。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="e39e" class="jp jq hi ku b fi ky kz l la lb">private static final Log <em class="li">LOGGER </em>= LogFactory.getLog(DemoApplication.class);<br/><br/>@ServiceActivator(inputChannel = "pubsubInputChannel")<br/>public void messageReceiver(String payload) {<br/>    <em class="li">LOGGER</em>.info("Message arrived! Payload: " + payload);<br/>}</span></pre><p id="d21b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们做了几个小时的工作不仅仅是为了在控制台中记录对话历史，不是吗？我们可以将这些传入的数据发送给服务，然后对这些数据做任何我们想做的事情。在我的例子中，我想把这些消息写给<a class="ae jo" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="075a" class="jp jq hi ku b fi ky kz l la lb">private static final Log <em class="li">LOGGER </em>= LogFactory.getLog(DemoApplication.class);<br/><br/>@ServiceActivator(inputChannel = "pubsubInputChannel")<br/>public void messageReceiver(String payload) {<br/>    pubsubService.saveToElasticsearch(payload);<br/>}</span></pre></div></div>    
</body>
</html>