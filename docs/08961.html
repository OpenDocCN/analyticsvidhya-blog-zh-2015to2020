<html>
<head>
<title>Automated Reporting with Python (Part 2) : Converting an HTML file to PDF and sending Automated Mails with Gmail API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python 自动生成报告(第 2 部分) :将 HTML 文件转换为 PDF，并使用 Gmail API 发送自动邮件</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automated-reporting-with-python-part-2-converting-an-html-file-to-pdf-and-sending-automated-2fb85eec89e9?source=collection_archive---------3-----------------------#2020-08-20">https://medium.com/analytics-vidhya/automated-reporting-with-python-part-2-converting-an-html-file-to-pdf-and-sending-automated-2fb85eec89e9?source=collection_archive---------3-----------------------#2020-08-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/bba0b120346ce38d69d78079994e320b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oSlZ3WLbSQ9R6I2grolKbw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">斯蒂芬·菲利普斯-Hostreviews.co.uk 在 Unsplash<a class="ae iu" href="https://unsplash.com/s/photos/gmail?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">拍摄的照片</a></figcaption></figure><p id="9063" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在最后一部分中，我在生成图表和数据透视表并将其转换为 HTML 后结束了这篇文章。如果你需要阅读，请打开下面的链接。</p><p id="3124" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" rel="noopener" href="/@abhinavsharma150/automated-reporting-with-python-part-1-generating-pivot-tables-and-charts-and-saving-to-html-ecd6590cd1b1">https://medium . com/@ abhinavsharma 150/automated-reporting-with-python-part-1-generating-pivot tables-and-charts-and-saving-to-html-ECD 6590 CD 1 b 1</a></p><p id="3cc8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">本部分将讨论两个主题:</strong> <br/> a .将 HTML 转换为 PDF(应用 CSS 后)<br/> b .使用 GMAIL API 发送自动邮件</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es jt"><img src="../Images/8e69c291b26322767b0dbad7d0332f65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/0*qtnn3fDq07dmciMJ.png"/></div></figure><p id="fda8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这份报告看起来是不是有点尴尬？<strong class="ix hj">让我们添加一些样式</strong></p><p id="1f32" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于表格，我们会做"<strong class="ix hj">margin:0px auto；</strong>"为了使它居中，为了 div，我们将为 body 本身提供一个公共 CSS:-<strong class="ix hj">" text-align:center；"然后重新编写 HTML 代码。</strong></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="e0f1" class="kd ke hi jz b fi kf kg l kh ki"># Adding CSS to HTML</span><span id="d0ba" class="kd ke hi jz b fi kj kg l kh ki">css = ‘&lt;style&gt; body {\n text-align:center; \n}\n table{\n margin:0px auto;\n}&lt;/style&gt;’</span><span id="1151" class="kd ke hi jz b fi kj kg l kh ki">html = html + css</span><span id="1bbb" class="kd ke hi jz b fi kj kg l kh ki">with open(‘report.html’,’w+’) as file:<br/> file.write(html)</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kk"><img src="../Images/cc86be443dbaaee02d0d9bb5890f4e1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dMj5gZUTO0ITseirkxaFdw.png"/></div></div></figure><p id="01e7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转换为 PDF(您需要导入 pdfkit 库，如果没有安装，请在终端上做:-"<strong class="ix hj">sudo apt-get install-y python-PDF kit</strong>或"<strong class="ix hj"> pip3 install pdfkit </strong>)。</p><p id="6924" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">注</strong>:为了简单起见，我使用的是主目录，你可以根据自己的意愿更改目录名。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="5c81" class="kd ke hi jz b fi kf kg l kh ki">import pdfkit<br/>pdfkit.from_file(‘report.html’,’report.pdf’)</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kl"><img src="../Images/9b7732af1424f3dbed8d27a3c2132444.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*ooi4rbmxy-MSLmyA2HxHYw.png"/></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/863ebbe0d7a9f89c5ea0c967c828f14e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iPijJDCUallzNtwSVPxL6A.png"/></div></div></figure><blockquote class="kn ko kp"><p id="1840" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated"><strong class="ix hj"> Gmail API :- </strong>你需要向 Gmail 请求一个 API。请参考谷歌开发者 Python 快速入门快速浏览</p><p id="7337" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated"><a class="ae iu" href="https://developers.google.com/gmail/api/quickstart/python" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/gmail/api/quickstart/python</a>，进入链接，打开 Gmail API，下载“credentials.json”文件，安全保存。请记住→“如果丢失，几乎无法从谷歌回收或找回”。</p></blockquote><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/8ea4584fa2661ed7a751ac4037eee7ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sZuGaAV1WscEJJJoJQi-VA.png"/></div></div></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kv"><img src="../Images/99b241d478e5bc04327b7772a653b625.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*oV-ovXT8RhWI0ovTcUfDFA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">建议将 credentials.json 保存在单独的文件夹中</figcaption></figure><p id="7469" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于“Python3 ”,在终端→中运行命令，改为尝试“pip3”</p><p id="2d5b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kw kx ky jz b">pip install --upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlib</code></p><p id="a0cc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用 google API 库开始导入:-</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="a811" class="kd ke hi jz b fi kf kg l kh ki">from __future__ import print_function<br/>import pickle<br/>import os.path<br/>from googleapiclient.discovery import build<br/>from google_auth_oauthlib.flow import InstalledAppFlow<br/>from google.auth.transport.requests import Request</span></pre><p id="ec8f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">导入(如果不可用，则安装)邮件库:-</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="51b2" class="kd ke hi jz b fi kf kg l kh ki"># Local Libraries<br/>import base64<br/>from email.mime.text import MIMEText<br/>from email.mime.application import MIMEApplication<br/>from email.mime.multipart import MIMEMultipart</span></pre><p id="111b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将作用域设置为 SCOPES =['<a class="ae iu" href="https://mail.google.com/'" rel="noopener ugc nofollow" target="_blank">https://mail.google.com/'</a>]以获得完全访问权限。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="2670" class="kd ke hi jz b fi kf kg l kh ki">SCOPES = [‘<a class="ae iu" href="https://mail.google.com/'" rel="noopener ugc nofollow" target="_blank">https://mail.google.com/'</a>]</span></pre><blockquote class="kn ko kp"><p id="f97d" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated"><strong class="ix hj">主认证类</strong> :-这将在第一次运行时创建一个<strong class="ix hj">令牌. pickle </strong>文件。不要改变代码，这是令人满意的，如果需要，只需改变目录。</p><p id="4c99" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">下面的代码将使您首次登录，并生成一个 token.pickle 文件进行验证</p></blockquote><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="f38c" class="kd ke hi jz b fi kf kg l kh ki">class Main:</span><span id="44ce" class="kd ke hi jz b fi kj kg l kh ki">def __init__(self):<br/>        self.creds = None<br/>        <br/>        if os.path.exists('path_to/token.pickle'):<br/>            with open('path_to/token.pickle', 'rb') as token:<br/>                self.creds = pickle.load(token)<br/> # If there are no (valid)credentials available letuserlog in.<br/>        if not self.creds or not self.creds.valid:<br/>            if self.creds and self.creds.expired and self.creds.refresh_token:<br/>                self.creds.refresh(Request())<br/>            else:<br/>                flow = InstalledAppFlow.from_client_secrets_file(<br/>                    'path_to/credentials.json', SCOPES)<br/>                self.creds = flow.run_local_server(port=0)<br/>            # Save the credentials for the next run<br/>            with open('credentials/token.pickle', 'wb') as token:<br/>                pickle.dump(self.creds, token)</span><span id="1f63" class="kd ke hi jz b fi kj kg l kh ki">self.service = build('gmail', 'v1', credentials=self.creds)</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es kz"><img src="../Images/89f92bcf3f051992d1c805a2b3f3e1cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*zgPCQfq9Hws1irF0CUDUYQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">一旦谷歌认证完成，你就会看到这个屏幕</figcaption></figure><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es la"><img src="../Images/192b561b9d2f037d6fb8dcde313e8311.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*lZberoSV0p7wUlfidztRhQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">它将在您的系统上生成一个 token.pickle 文件</figcaption></figure><p id="f1db" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">创建和发送邮件:</strong>上面已经导入了所需的<strong class="ix hj"/>电子邮件库。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="b094" class="kd ke hi jz b fi kf kg l kh ki">class CreateAndSend:</span><span id="d940" class="kd ke hi jz b fi kj kg l kh ki">def __init__(self,service, to, sender, user_id, subject, message_text,attachment):</span><span id="c1ce" class="kd ke hi jz b fi kj kg l kh ki">message = MIMEMultipart()<br/>        message['to'] = to<br/>        message['from'] = sender<br/>        message['bcc'] = 'if_any_bcc@gmail.com'<br/>        message['subject'] = subject<br/>        body = MIMEText(message_text)<br/>        message.attach(body)<br/>        <br/>        with open(attachment, "rb") as f:<br/>            <br/>            attach = MIMEApplication(f.read(),_subtype="pdf")<br/>        attach.add_header('Content-Disposition',<br/>                          'attachment',<br/>                          filename=str(attachment))<br/>        message.attach(attach)<br/>        <br/>        to_send = {<br/>                    'raw': base64.urlsafe_b64encode(message.as_string().encode()).decode()<br/>                    }<br/>        #print(message)</span><span id="ceac" class="kd ke hi jz b fi kj kg l kh ki">try:<br/>            to_send = (service.users().messages().send(userId=user_id, body=to_send)<br/>                       .execute())<br/>            print('Message Id: %s' % to_send['id'])</span><span id="9677" class="kd ke hi jz b fi kj kg l kh ki">except Exception as e:<br/>            print('An error occurred', e)</span><span id="2fd2" class="kd ke hi jz b fi kj kg l kh ki">main = Main()<br/>service = main.service<br/>to = '<a class="ae iu" href="mailto:abhinavsharma150@gmail.com" rel="noopener ugc nofollow" target="_blank">t</a>o_id@gmail.com'<br/>sender = ''<br/>user_id = '<a class="ae iu" href="mailto:mailstream99@gmail.com" rel="noopener ugc nofollow" target="_blank">y</a>our_id@gmail.com'<br/>subject = 'Automated Report mail'<br/>message_text = 'Hi,\n\n This report has been generated automatically for a demo purpose.\n \nRegards, \nSender Signature.'<br/>attachment='path_to/report.pdf'</span><span id="6836" class="kd ke hi jz b fi kj kg l kh ki">def send_mail():<br/>    CreateAndSend(service, to, sender, user_id, subject, message_text,attachment)</span><span id="ff80" class="kd ke hi jz b fi kj kg l kh ki">send_mail()</span></pre><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/74608174e75545bf2ef90a43e1fe2f0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*24LRMmZ2_dgSBsYlUPPWDg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">邮件自动发送给所需用户</figcaption></figure><p id="9b3c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这能帮助你在几秒钟内生成自动报告。</p><p id="31b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">猜</strong>！，在这个系列中还可以添加更多的东西吗？假设您需要每小时、每天或一周中的某一天发送这些报告。我们不能安排它吗？我将在自动化报告的下一部分中介绍“<strong class="ix hj">任务调度</strong>”。</p><p id="3a87" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">谢谢！！！！</strong></p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lc"><img src="../Images/df6e52e27f84629a073c625fa8e7bd19.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*PuFLm2IvKOYIPdLjg17-fA.jpeg"/></div></figure><p id="0488" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里阅读我的非技术性博客:</p><p id="6ea6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">1.<a class="ae iu" href="https://abhinav1321.wordpress.com/2021/05/05/religions-in-india-the-soft-power-potential/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">印度宗教:一种潜在的软实力</strong> </a></p><p id="2d7f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.<a class="ae iu" href="https://abhinav1321.wordpress.com/2021/05/03/journalistic-ethics-freedom-of-press-media/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">新闻伦理:新闻自由 Vs 秃鹫媒体</strong> </a></p><p id="f68a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.<a class="ae iu" href="https://abhinav1321.wordpress.com/2021/05/02/vaccine-and-herd-immunity-are-vaccines-safe/" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj">疫苗与群体免疫。疫苗安全吗？</strong>T25】</a></p></div></div>    
</body>
</html>