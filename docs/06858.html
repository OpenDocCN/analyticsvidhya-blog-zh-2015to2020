<html>
<head>
<title>Run CNN model in Flutter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在颤振中运行CNN模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/run-cnn-model-in-flutter-10c944cadcba?source=collection_archive---------0-----------------------#2020-06-05">https://medium.com/analytics-vidhya/run-cnn-model-in-flutter-10c944cadcba?source=collection_archive---------0-----------------------#2020-06-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3fa9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在flutter应用中运行任何类型的机器学习模型。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/4d89afbcd8ba01d74b09b116b22e278b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JSqpObhd3vJuKrcZaCVW4g.png"/></div></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="83d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> TensorFlow Lite </strong>是一套帮助开发人员在移动、嵌入式和物联网设备上运行<strong class="ih hj"> TensorFlow </strong>模型的工具。它支持设备上的机器学习推理，具有低延迟和小二进制大小。</p><h1 id="558f" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">先决条件</strong></h1><ul class=""><li id="8228" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;我们将假设您已经构建了模型</li><li id="3b4e" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;是的，您可以使用任何型号，但这里我们将使用CNN</li><li id="425c" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;我们将学习如何在flutter应用程序中部署您的模型，这意味着自动在IOS和Android上部署，因为flutter是一个跨平台的框架。</li><li id="32fe" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;好吧，现在有很多关于如何在flutter应用程序中部署模型的文章，但在处理实际问题时，到处都缺少一些关键功能。</li><li id="68eb" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;在本文中，我们将了解一些次要的细节，以便让您关注成功的部署</li><li id="b482" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;我将在最后提到最有用的导入库，以防有人有任何问题。但是如果你已经训练了你的模型，很有可能你已经导入了我们需要的大多数库</li></ul><h2 id="dd4f" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">训练模型</h2><ul class=""><li id="0432" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;正如我们前面提到的，我们将假设您已经训练了您的模型。</li><li id="9f8d" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;对于那些仍然感到困惑的人，我们假设在执行了类似于下面的代码之后，您已经有了经过训练的模型</li></ul><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="9af5" class="lk jx hi lz b fi md me l mf mg">Model = model.Squential(....)<br/>.<br/>.<br/>trained_model = Model.fit(traningData , TrainingLabels)</span><span id="9e3d" class="lk jx hi lz b fi mh me l mf mg">OR</span><span id="cef6" class="lk jx hi lz b fi mh me l mf mg">trained_model = model.fit_generator(train_batches,epochs=10)</span></pre><ul class=""><li id="4287" class="ku kv hi ih b ii ij im in iq mi iu mj iy mk jc lb lc ld le bi translated">&gt;<strong class="ih hj"> trained_model </strong>是我们需要的，我们将从这里开始这篇文章</li></ul><h2 id="160c" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">保存模型</h2><ul class=""><li id="a788" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;首先，我们将保存模型，以防将来需要使用</li></ul><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="601b" class="lk jx hi lz b fi md me l mf mg">model.save("augmented_model.model")</span></pre><h2 id="c022" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">获取您的班级指数</h2><ul class=""><li id="126b" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;记下或保存课程索引</li><li id="45f7" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;当模型预测某样东西、某幅图像或某个输入时，它会返回一个向量(1D矩阵),所有的值都是0，一个值是1，表示模型已经预测到了，我们需要知道我们的模型索引是什么</li><li id="4f6b" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;如果您创建了一个多类CNN，很可能您使用了softmax函数，这意味着您的结果向量将具有概率值，而不是1和0</li><li id="5794" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;我们将选择最高值作为结果</li></ul><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="ac83" class="lk jx hi lz b fi md me l mf mg">test_batches.class_indices</span><span id="482e" class="lk jx hi lz b fi mh me l mf mg">#output :-<br/>{'dettol_sanatiser': 0,<br/> 'fevicol': 1,<br/> 'lifeboy_sanatiser': 2,<br/> 'scissors': 3,<br/> 'setwet_hair_Gel': 4}</span></pre><h2 id="bc6e" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">以HDFS格式保存模型</h2><ul class=""><li id="dfed" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;不要想太多这是什么，你现在不需要知道这是什么格式，但如果你知道这一点就好了，可能会对你的未来有用。</li></ul><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="3ea3" class="lk jx hi lz b fi md me l mf mg">import tensorflow as tf</span><span id="7957" class="lk jx hi lz b fi mh me l mf mg">keras_file = "My_saved_Model.h5"<br/>keras.models.save_model(trained_model , keras_file)</span></pre><h2 id="f83c" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">将您的模型转换成TFlite模型</h2><ul class=""><li id="c64d" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;现在这是一个棘手的部分，仅仅知道代码是无法完成的</li><li id="1c03" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;通过做一些研究，我知道教程和文章中的内容已经发生了变化，在实际工作中，这是很好的升级</li><li id="f5ee" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;在Tensorflow 1.x中，将. h5模型转换为TFlite模型很容易，但在2.x中却很复杂</li><li id="84ab" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;您肯定会找到转换代码，但有些人会遇到许多问题。</li><li id="81c3" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;这是因为您用pip或conda安装程序安装的TensorFlow不包含此转换代码库。</li><li id="4df4" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;所以你必须直接从GitHub获得TF的原始完整版本，这也很棘手，但是如果你是一个天才，尽管去做吧，这在将来可能会对你有用</li><li id="b670" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;但如果这太多了，你可以使用Google Colabs，</li><li id="8119" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt; Google Colab是由Google主办的免费云服务，旨在鼓励机器学习和人工智能研究，而学习和成功的障碍往往是对巨大计算能力的要求。</li><li id="e6f0" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;只需将它视为存储在Gdrive中的虚拟Jupyter笔记本。</li><li id="863b" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;使用python3在google colab中创建一个笔记本，这是免费的</li></ul><h2 id="3554" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">将保存的模型上传到Colab</h2><ul class=""><li id="60b0" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;这一步也让我感到沮丧，因为模型确实上传了，但是实际代码不能识别或检测上传的文件</li><li id="0cba" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;这样做是为了确保模型上传到正确的位置</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ml"><img src="../Images/eba927cdd902793f893a2874d785e301.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*GVWkg4jM9MfhOcGBAgEhKQ.png"/></div></figure><ol class=""><li id="9a9a" class="ku kv hi ih b ii ij im in iq mi iu mj iy mk jc mm lc ld le bi translated">单击文件选项卡</li><li id="3baf" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc mm lc ld le bi translated">单击…文件夹</li></ol><p id="625d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它会带你到你的虚拟机的整个目录</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mn"><img src="../Images/0c6df0201f72abf7cd97667c0cc9987e.png" data-original-src="https://miro.medium.com/v2/resize:fit:688/format:webp/1*FXS8CloyWllhiopzuoaPrA.png"/></div></figure><ul class=""><li id="392d" class="ku kv hi ih b ii ij im in iq mi iu mj iy mk jc lb lc ld le bi translated">&gt;我们需要上传我们保存在“内容”文件夹中的模型</li><li id="51e7" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;对于你们中的许多人来说，简单的上传可能也可以，但是如果这不起作用，就按照上面的步骤</li><li id="1807" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;右键单击内容文件夹并上传您保存的模型</li><li id="8dc3" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;上传"<strong class="ih hj"> My_saved_Model.h5 </strong></li><li id="1a68" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;等待一段时间，上传需要时间，上传后不要关闭笔记本的会话，如果关闭，您的模型将被删除</li></ul><h2 id="db71" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">最后一些代码</h2><ul class=""><li id="bff3" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;在您的Colab笔记本上运行此代码</li></ul><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="8e40" class="lk jx hi lz b fi md me l mf mg">import os<br/>import tensorflow as tf<br/>from tensorflow import keras<br/>print(tf.__version__)<br/>!pwd<br/>!ls</span><span id="b657" class="lk jx hi lz b fi mh me l mf mg"><br/>###OUTPUT### :-</span><span id="5a4f" class="lk jx hi lz b fi mh me l mf mg">2.2.0-rc4 <br/>/content sample_data  <strong class="lz hj">My_saved_Model</strong>.<strong class="lz hj">h5</strong></span><span id="e878" class="lk jx hi lz b fi mh me l mf mg"><br/>tensflow version might be different but still in 2.x+</span></pre><h2 id="32df" class="lk jx hi bd jy ll lm ln kc lo lp lq kg iq lr ls kk iu lt lu ko iy lv lw ks lx bi translated">现在用代码将模型转换成TFLITE</h2><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="3be0" class="lk jx hi lz b fi md me l mf mg">My_TFlite_Model = tf.keras.models.load_model('<strong class="lz hj">My_saved_Model</strong>.<strong class="lz hj">h5</strong>')</span><span id="b321" class="lk jx hi lz b fi mh me l mf mg">converter = tf.lite.TFLiteConverter.from_keras_model(minor_model)</span><span id="f182" class="lk jx hi lz b fi mh me l mf mg">tflite_model = converter.convert()</span><span id="c430" class="lk jx hi lz b fi mh me l mf mg">open("<strong class="lz hj">My_TFlite_Model.tflite</strong>", "wb").write(tflite_model)</span></pre><ul class=""><li id="e848" class="ku kv hi ih b ii ij im in iq mi iu mj iy mk jc lb lc ld le bi translated">&gt;这段代码会将您转换后的模型保存在同一个目录中</li><li id="0579" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;从目录中下载您珍贵的Tflite模型</li></ul><p id="f31a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你的模型转换成功，忽略下一个部分，跳到颤动部分，但是如果你仍然有一个错误，快速尝试这个，</p><p id="4ce8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">试着在colab中保存一个训练好的随机模型，然后重新加载它，如果你能在代码中重新加载它，使用这个随机模型的目录。这意味着将您的模型上传到保存这个随机模型的目录，然后尝试用这个目录路径加载您的模型。</p><p id="955e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并且在放弃之前等待至少5-6分钟，colab可能还没有与最新上传的文件同步。</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="926b" class="lk jx hi lz b fi md me l mf mg">create and save your random model<br/>x = [-1, 0, 1, 2, 3, 4]<br/>y = [-3, -1, 1, 3, 5, 7]<br/>model = tf.keras.models.Sequential([tf.keras.layers.Dense(units=1, input_shape=[1])])<br/>model.compile(optimizer='sgd', loss='mean_squared_error')<br/>model.fit(x, y, epochs=1)<br/>model.save('sample_model.h5')</span><span id="3f77" class="lk jx hi lz b fi mh me l mf mg">#load the saved model again, do this in a different cell<br/>new_model = tf.keras.models.load_model('sample_model.h5')<br/>new_model.summary()</span></pre><h1 id="98ae" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">颤动部分</h1><ul class=""><li id="17df" class="ku kv hi ih b ii kw im kx iq ky iu kz iy la jc lb lc ld le bi translated">&gt;在flutter应用程序中创建资产文件夹</li><li id="f756" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;将下载的TFlite模型拷贝到“资产”文件夹中</li><li id="ce04" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;在资产文件中创建一个名为label.txt的文本文件</li><li id="9476" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;在这个文本中，按照我们之前从类索引中得到的相同顺序填写结果对象的名称，但是没有索引号，只有正确的顺序</li></ul><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="3ad8" class="lk jx hi lz b fi md me l mf mg">dettol_sanatiser<br/>fevicol<br/>lifeboy_sanatiser<br/>scissors<br/>setwet_hair_Gel</span></pre><p id="4a63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pubspec.yaml</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="63ee" class="lk jx hi lz b fi md me l mf mg">dependencies:<br/>  flutter:<br/>    sdk: flutter<br/>  cupertino_icons: ^0.1.2<br/>  tflite: ^1.0.4<br/>  image_picker: ^0.6.2+3</span></pre><p id="153c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主.镖</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="4950" class="lk jx hi lz b fi md me l mf mg">import 'package:tflite/tflite.dart';<br/>import 'package:image_picker/image_picker.dart';</span></pre><p id="ead1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">变量</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="b067" class="lk jx hi lz b fi md me l mf mg">  List _outputs;<br/>  File _image;</span></pre><p id="a58f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">initState()</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="1e70" class="lk jx hi lz b fi md me l mf mg"><a class="ae mo" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void initState() {<br/>    super.initState();<br/>    loadModel().then((value) {setState((){});});<br/>  }</span></pre><p id="5999" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">功能</p><pre class="je jf jg jh fd ly lz ma mb aw mc bi"><span id="e0aa" class="lk jx hi lz b fi md me l mf mg">pickImage() async {<br/>    var image = await ImagePicker.pickImage(source: ImageSource.gallery);<br/>    if (image == null) return null;<br/>    setState(() {<br/>      _image = image;<br/>    });<br/>    classifyImage(image);<br/>  }</span><span id="a134" class="lk jx hi lz b fi mh me l mf mg">classifyImage(File image) async {<br/>    var output = await Tflite.runModelOnImage(<br/>      path: image.path,<br/>    );<br/>    print("predict = "+output.toString());<br/>    setState(() {<br/>      _outputs = output;<br/>    });<br/>  }</span><span id="8013" class="lk jx hi lz b fi mh me l mf mg">loadModel() async {<br/>    await Tflite.loadModel(<br/>      model: "assets/<strong class="lz hj">My_TFlite_Model.tflite</strong>",<br/>      labels: "assets/<strong class="lz hj">labels.txt</strong>",<br/>    );<br/>  }</span><span id="aaeb" class="lk jx hi lz b fi mh me l mf mg"><a class="ae mo" href="http://twitter.com/override" rel="noopener ugc nofollow" target="_blank">@override</a><br/>  void dispose() {<br/>    Tflite.close();<br/>    super.dispose();<br/>  }</span></pre><ul class=""><li id="257d" class="ku kv hi ih b ii ij im in iq mi iu mj iy mk jc lb lc ld le bi translated">&gt;只需在UI上放一个按钮，调用<strong class="ih hj"> pickImage() </strong></li><li id="d532" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;当你选择一幅图像时，它会自动调用分类图像并将结果存储在<strong class="ih hj"> _outputs </strong>变量中</li><li id="1c92" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;<strong class="ih hj"> _outputs </strong>将是一个具有最合适预测概率的列表，第一个元素将具有最高概率</li><li id="4ee2" class="ku kv hi ih b ii lf im lg iq lh iu li iy lj jc lb lc ld le bi translated">&gt;<strong class="ih hj"> _outputs[0] </strong>将是您的结果</li></ul><p id="770a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">大功告成</strong></p><p id="a275" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这篇文章的应用程序中看到这一点</p><p id="c3f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae mo" href="https://www.linkedin.com/posts/harshborse_androidapp-flutter-appdeveloper-activity-6668583858088366080-SsC-" rel="noopener ugc nofollow" target="_blank">https://www . LinkedIn . com/posts/harshborse _ androidapp-flutter-app developer-activity-66685858088366080-SsC-</a></p><p id="898a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读</p></div></div>    
</body>
</html>