<html>
<head>
<title>S3 Access logs parsing using pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用pandas解析S3访问日志</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/s3-access-logs-parsing-using-pandas-e9626241b656?source=collection_archive---------3-----------------------#2019-11-05">https://medium.com/analytics-vidhya/s3-access-logs-parsing-using-pandas-e9626241b656?source=collection_archive---------3-----------------------#2019-11-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="423a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能遇到过计费问题，有时您的S3对象被访问或下载的次数超出了您的预期，因此在这种情况下，对访问日志的简单分析将有助于找出系统中的问题。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/0124f70af2944a593ffa5620c4927d32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pm03K55Z83AkJuwmzON8ow.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated"><a class="ae jt" href="https://images.app.goo.gl/MQPGg527x22YTCNb9" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="f161" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我们将要讨论的内容</p><ul class=""><li id="e192" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">什么是S3访问日志</li><li id="971b" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">如何在AWS中启用它们</li><li id="1de9" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">使用熊猫解析</li></ul><h1 id="7db5" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><span class="l lg lh li bm lj lk ll lm ln di"> W </span> <strong class="ak">什么是S3访问日志</strong> —</h1><p id="c28e" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">S3访问日志类似于普通的Apache日志文件。它可以回答你几个问题，比如谁在提出请求？执行什么类型的操作？他成功了吗？</p><blockquote class="lt lu lv"><p id="505d" class="if ig lw ih b ii ij ik il im in io ip lx ir is it ly iv iw ix lz iz ja jb jc hb bi translated">AWS source: <br/>服务器访问日志记录提供了对一个bucket的请求的详细记录。服务器访问日志对许多应用程序都很有用。例如，访问日志信息在安全和访问审计中非常有用。它还可以帮助你了解你的客户群，理解你的亚马逊S3账单。</p></blockquote><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ma"><img src="../Images/8175a5c7e7a7a232f04051dd29f6e02d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G70Tix1tJ5hidbqVqI9YGA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">原始访问日志</figcaption></figure><h1 id="414a" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><strong class="ak">如何启用它们？</strong></h1><p id="b44a" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">默认情况下，日志记录是禁用的，因此应该在需要时启用它。启用日志记录后，日志将保存到与源时段相同的AWS区域中的时段。</p><p id="8084" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是实现它的快速步骤-</p><blockquote class="lt lu lv"><p id="08be" class="if ig lw ih b ii ij ik il im in io ip lx ir is it ly iv iw ix lz iz ja jb jc hb bi translated">注意:-启用S3是可充电的<strong class="ih hj"/>，因此在分析之后，如果不需要，您可以将其关闭。</p></blockquote><h2 id="b424" class="mb kj hi bd kk mc md me ko mf mg mh ks iq mi mj kw iu mk ml la iy mm mn le mo bi translated"><strong class="ak">启用S3存储桶的服务器访问日志</strong></h2><ol class=""><li id="eece" class="ju jv hi ih b ii lo im lp iq mp iu mq iy mr jc ms ka kb kc bi translated">登录AWS管理控制台，打开位于<a class="ae jt" href="https://console.aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">https://console.aws.amazon.com/s3/</a>的亚马逊S3控制台。</li><li id="6de8" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">在<strong class="ih hj">存储桶名称</strong>列表中，选择要启用服务器访问日志记录的存储桶的名称。</li><li id="99cf" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">选择<strong class="ih hj">属性</strong>。</li><li id="ebd0" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">选择<strong class="ih hj">服务器访问日志</strong>。</li><li id="9982" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">选择<strong class="ih hj">启用记录</strong>。对于<strong class="ih hj">目标</strong>，选择您想要接收日志记录对象的桶的名称。目标时段必须与源时段位于同一区域，并且不能有默认的保留期配置。</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mt"><img src="../Images/a547e49eed46e8e73020fc7f7d967cf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1106/format:webp/1*ZZuKb6e_Nq6YHVn-iYyI2Q.png"/></div></figure><p id="18c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.(可选)对于<strong class="ih hj">目标前缀</strong>，键入日志对象的关键字名称前缀，这样所有日志对象名称都以相同的字符串开头。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mu"><img src="../Images/dd7e8c36a46ae7f802a303b7be6d07da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*gKtR7fIM_2D8dgVZ-vlFqQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">带前缀</figcaption></figure><p id="1501" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.选择<strong class="ih hj">保存</strong>。</p><p id="9309" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jt" href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/server-access-logging.html" rel="noopener ugc nofollow" target="_blank">这里的</a>是从控制台启用S3日志的详细步骤，<a class="ae jt" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/enable-logging-programming.html" rel="noopener ugc nofollow" target="_blank">是启用的编程方式</a>。</p><h1 id="5b5a" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><strong class="ak">使用熊猫解析— </strong></h1><p id="890d" class="pw-post-body-paragraph if ig hi ih b ii lo ik il im lp io ip iq lq is it iu lr iw ix iy ls ja jb jc hb bi translated">在任何活动的S3存储桶上启用S3访问日志后，您将看到在同一个存储桶中创建了许多日志文件。让我们启用日志几个小时并下载它们。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mv mw l"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">下载AWS S3对象</figcaption></figure><p id="3bdc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，所有访问日志都下载到目录“access_logs”中。</p><p id="84bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们开始分析</p><ol class=""><li id="bfad" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc ms ka kb kc bi translated">我们的第一步是为每个访问日志创建df。</li><li id="38b0" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">然后根据<a class="ae jt" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/LogFormat.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>对列进行适当命名。</li><li id="85e7" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">现在把所有的df_list连接成一个df。</li></ol><pre class="je jf jg jh fd mx my mz na aw nb bi"><span id="d5f5" class="mb kj hi my b fi nc nd l ne nf">df_list = []<br/>logs_dir_name = "access_logs"<br/>for file in os.listdir(logs_dir_name):<br/>    # read them into pandas with proper meaningful header<br/>    df_list.append(pd.read_csv(<br/>        '{0}/{1}'.format(logs_dir_name, file),<br/>        sep=" ",<br/>        names=['Bucket Owner', 'Bucket', 'Time', 'Time - Offset', 'Remote IP', 'Requester ARN/Canonical ID',<br/>               'Request ID',<br/>               'Operation', 'Key', 'Request-URI', 'HTTP status', 'Error Code', 'Bytes Sent', 'Object Size',<br/>               'Total Time',<br/>               'Turn-Around Time', 'Referrer', 'User-Agent', 'Version Id', 'Host Id', 'Signature Version',<br/>               'Cipher Suite',<br/>               'Authentication Type', 'Host Header', 'TLS version'],<br/>        usecols=[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],<br/>        engine='python'))<br/><br/># concatenate all DFs<br/>df = pd.concat(df_list)<br/>df.to_excel('accesslogs_xls/s3-accesslog-complete.xls', index=False)<br/>print(df)</span></pre><p id="b2ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此时，您已经将整个访问日志放入一个xls中，即accesslogs_xls目录下的“s3-accesslog-complete.xls”</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ng"><img src="../Images/76bb9e2bdb28dc995446b5ca1113f4d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gG72oMtgltbu1ZPUUM4HjQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">所有访问日志都记录在一个xls中</figcaption></figure><p id="831b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并且低于df的输出</p><pre class="je jf jg jh fd mx my mz na aw nb bi"><span id="069d" class="mb kj hi my b fi nc nd l ne nf">Bucket Owner     ...     TLS version<br/>0   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>0   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>1   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>2   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>3   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>4   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>5   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>6   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>7   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>8   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>9   qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>10  qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>11  qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>12  qwe334dfs2s61f6db346af3d0bbfgfd5652a543958c6728c17f...     ...         TLSv1.2<br/>..<br/>[64032 rows x <strong class="my hj">25 columns</strong>]</span></pre><p id="199d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们希望检查哪个S3对象被成功访问，并对其进行计数。</p><ol class=""><li id="ce34" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc ms ka kb kc bi translated">让我们添加新列<em class="lw">“is _ duplicated”</em>来检查重复项。</li><li id="b948" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">然后将其写入新文件。</li></ol><pre class="je jf jg jh fd mx my mz na aw nb bi"><span id="15a2" class="mb kj hi my b fi nc nd l ne nf">df_list = []<br/>logs_dir_name = "access_logs"<br/>for file in os.listdir(logs_dir_name):<br/>    # read them into pandas with proper meaningful header<br/>    df_list.append(pd.read_csv(<br/>        '{0}/{1}'.format(logs_dir_name, file),<br/>        sep=" ",<br/>        names=['Bucket Owner', 'Bucket', 'Time', 'Time - Offset', 'Remote IP', 'Requester ARN/Canonical ID',<br/>               'Request ID',<br/>               'Operation', 'Key', 'Request-URI', 'HTTP status', 'Error Code', 'Bytes Sent', 'Object Size',<br/>               'Total Time',<br/>               'Turn-Around Time', 'Referrer', 'User-Agent', 'Version Id', 'Host Id', 'Signature Version',<br/>               'Cipher Suite',<br/>               'Authentication Type', 'Host Header', 'TLS version'],<br/>        usecols=[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],<br/>        engine='python'))<br/><br/>df = pd.concat(df_list)  # concatenate all df<br/><strong class="my hj">df['is_duplicated'] = df.duplicated(['Key'])</strong>  #add is_duplicated col<br/>df.to_excel('accesslogs_xls/s3-accesslog-complete.xls', index=False)</span></pre><p id="756c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果您注意到is_duplicated列中有许多“真”值，这意味着同一个对象被多次访问。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nh"><img src="../Images/8c87ad9d8bd1d5a8daeb7dccf7bb8c7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JNCcvXymytazoDPbeGTCEw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">高亮显示is_duplicated列的相同xls文件</figcaption></figure><p id="72f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们知道有些对象被多次访问，我们就会对这些对象被访问的次数感兴趣。</p><ol class=""><li id="4240" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc ms ka kb kc bi translated">为此，我们将使用熊猫的分组方法。让我们按照bucket名称、对象和HTTP状态进行分组。</li><li id="bdb3" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc ms ka kb kc bi translated">然后我们将写入一个新的xls文件。</li></ol><pre class="je jf jg jh fd mx my mz na aw nb bi"><span id="dd87" class="mb kj hi my b fi nc nd l ne nf">df_list = []<br/>logs_dir_name = "access_logs"<br/>for file in os.listdir(logs_dir_name):<br/>    # read them into pandas with proper meaningful header<br/>    df_list.append(pd.read_csv(<br/>        '{0}/{1}'.format(logs_dir_name, file),<br/>        sep=" ",<br/>        names=['Bucket Owner', 'Bucket', 'Time', 'Time - Offset', 'Remote IP', 'Requester ARN/Canonical ID',<br/>               'Request ID',<br/>               'Operation', 'Key', 'Request-URI', 'HTTP status', 'Error Code', 'Bytes Sent', 'Object Size',<br/>               'Total Time',<br/>               'Turn-Around Time', 'Referrer', 'User-Agent', 'Version Id', 'Host Id', 'Signature Version',<br/>               'Cipher Suite',<br/>               'Authentication Type', 'Host Header', 'TLS version'],<br/>        usecols=[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],<br/>        engine='python'))<br/><br/>df = pd.concat(df_list)  # concatenate all df<br/>df = df.groupby(['Bucket', 'Key', 'HTTP status']).size().reset_index(name='count')<br/>df.to_excel('accesslogs_xls/s3-accesslog-groupby-s3key.xls', index=False)</span></pre><p id="ab18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是上面代码的输出，count列给出了同一个S3对象被下载的次数。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ni"><img src="../Images/f36b71ffc0e0bc73949733e537bd488f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dGLCMzuoo29vJFPEC2SynA.png"/></div></div></figure><p id="0021" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过这种方式，我们可以看到请求者成功访问每个S3对象的计数，但是我们不知道进行了什么操作以及谁是请求者，所以让我们看看同一个用户是否多次尝试访问同一个对象，这可能有点不常见，也是我们练习的目标。</p><pre class="je jf jg jh fd mx my mz na aw nb bi"><span id="41ad" class="mb kj hi my b fi nc nd l ne nf">df = pd.concat(df_list)  # concatenate all df<br/># df['is_duplicated'] = df.duplicated(['Key'])  # add duplicate boolean column<br/>df = df.groupby(['Bucket', 'Key', 'HTTP status', <strong class="my hj">'Operation', 'Requester ARN/Canonical ID'</strong>]).size().reset_index(name='count')<br/>df.to_excel('accesslogs_xls/s3-accesslog-groupby-s3key1.xls', index=False)</span></pre><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es nj"><img src="../Images/e06e1da12a66bb72bd8f6ea7739ddd5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5vUVUVHENBierTskbdRAA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">包含申请人详细信息的分组依据</figcaption></figure><p id="2cdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从最后3列我们知道请求者和他试图访问S3对象的次数。现在我们可以回去修复系统中的这个问题。这是完整的代码要点。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mv mw l"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">使用pandas的AWS访问日志解析器</figcaption></figure><h1 id="0af9" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">进一步行动/带走-</h1><ul class=""><li id="aef8" class="ju jv hi ih b ii lo im lp iq mp iu mq iy mr jc jz ka kb kc bi translated">分析“问题用户”在哪里被使用。</li><li id="8b40" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">检查配置了“problematicuser”的系统中的异常情况。</li><li id="3c72" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">如果不需要，则从该用户的IAM权限中删除<em class="lw"> s3:PutBucketAcl，s3:PutBucketPolicy，s3:PutObjectAcl权限。</em></li><li id="12e9" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">使用资源策略和其他可能的方法保护桶免受任何泄漏。</li></ul></div></div>    
</body>
</html>