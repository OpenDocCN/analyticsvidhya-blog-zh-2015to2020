<html>
<head>
<title>Azure Synapse Analytics SQL-OnDemand with Covid 19 Dataset</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">azure Synapse Analytics SQL-on demand 与 Covid 19 数据集</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/azure-synapse-analytics-sql-ondemand-with-covid-19-dataset-bbb3b7173f3a?source=collection_archive---------22-----------------------#2020-10-10">https://medium.com/analytics-vidhya/azure-synapse-analytics-sql-ondemand-with-covid-19-dataset-bbb3b7173f3a?source=collection_archive---------22-----------------------#2020-10-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="cb4d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何按需使用 Azure Synapse SQL 并做 ETL</h1><h1 id="0e88" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">用例</h1><p id="038b" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">建立一个加载 covid 19 数据的系统，该数据可在 kaggle 网站上获得。</p><h1 id="9b5f" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">步伐</h1><ul class=""><li id="a0d1" class="kb kc hi jf b jg jh jk jl jo kd js ke jw kf ka kg kh ki kj bi translated">创建 Azure Syanpse 工作区资源</li><li id="2eb0" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">请确保存储 blob 容器所有者提供了托管实例的权限</li><li id="ae25" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">去 Kaggal 网站下载 covid 19 数据集</li><li id="5a5c" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">样本文件也可在文件名为 covid_19_data 的数据文件夹中获得</li><li id="4b17" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">在默认存储中创建名为 coviddata 的容器</li><li id="66ff" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">使用门户或存储资源管理器上传文件(可在线安装或本地安装)</li><li id="f65e" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">转到工作区</li><li id="61e4" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">在开发部分创建新查询</li><li id="2a68" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">首先，如果数据库不可用，我们需要创建一个数据库</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="fbe3" class="ky ig hi ku b fi kz la l lb lc">CREATE DATABASE coviddb;</span></pre><ul class=""><li id="7228" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">让我们加载样本数据，并确保它是否工作</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="2410" class="ky ig hi ku b fi kz la l lb lc">CREATE VIEW covidview AS<br/>SELECT<br/>    *<br/>FROM<br/>    OPENROWSET(<br/>        BULK 'https://&lt;storageaccountname&gt;.dfs.core.windows.net/coviddata/covid_19_data.csv',<br/>        FORMAT = 'CSV',<br/>        PARSER_VERSION='2.0',<br/>        DATA_SOURCE = 'SqlOnDemandDemo',<br/>        FIRSTROW = 2<br/>    ) WITH (<br/>      SNo int,<br/>      ObservationDate varchar(50),<br/>      ProvinceState varchar(200),<br/>      CountryRegion varchar(200),<br/>      LastUpdate varchar(50),<br/>      Confirmed decimal(18,2),<br/>      Deaths decimal(18,2),<br/>      Recovered decimal(18,2)<br/>) AS [result]</span></pre><ul class=""><li id="20f8" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">检查数据是否已加载</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="0a5f" class="ky ig hi ku b fi kz la l lb lc">select * from covidview</span></pre><ul class=""><li id="0686" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">现在让我们创建一个表来存储持久性数据</li><li id="e697" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">必须在 coviddb 中创建主密钥</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="dc24" class="ky ig hi ku b fi kz la l lb lc">use coviddb<br/>CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'xyxpojklnbgtyughd234!234$%';</span></pre><ul class=""><li id="479e" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">现在在 coviddb 中创建一个凭证</li><li id="8ae7" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">要创建凭据，您需要 SAS 令牌密钥。</li><li id="af35" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">转到 ADLS 第二代集装箱</li><li id="8c81" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">在左侧菜单中，单击 SAS 令牌</li><li id="6c0e" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">选择要提供访问权限的资源</li><li id="81aa" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">选择时间范围</li><li id="c199" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">单击创建 sas 令牌。</li><li id="772c" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">注意:复制没有斑点 URI 的 SAS URL，如下所示。这只能使用一次，所以在您验证以下步骤之前，请不要关闭页面。</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="1a3c" class="ky ig hi ku b fi kz la l lb lc">-- create credentials for containers in our demo storage account<br/>CREATE DATABASE SCOPED CREDENTIAL sqlondemand<br/>WITH IDENTITY='SHARED ACCESS SIGNATURE',  <br/>SECRET = '?sv=2019-12-12&amp;ss=bfqt&amp;srt=sco&amp;sp=rwdlacupx&amp;se=2021-10-08T20:03:10Z&amp;st=2020-10-08T12:03:10Z&amp;spr=https&amp;sig=73FwbAOqT3VI6SQ%2FjX1E0CQDo0y7Sri8%2FdAdgOnGE8w%3D'<br/>GO<br/>CREATE EXTERNAL DATA SOURCE SqlOnDemandDemo WITH (<br/>    LOCATION = 'https://&lt;storageaccountname&gt;.blob.core.windows.net',<br/>    CREDENTIAL = sqlondemand<br/>);</span></pre><ul class=""><li id="c734" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">我们将删除该视图，因为它已经如上所述存在</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="4e6d" class="ky ig hi ku b fi kz la l lb lc">DROP VIEW IF EXISTS covidview;<br/>GO</span></pre><ul class=""><li id="9b2f" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">让我们创建一个具有持久存储的新视图</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="b633" class="ky ig hi ku b fi kz la l lb lc">CREATE VIEW covidview AS<br/>SELECT<br/>    *<br/>FROM<br/>    OPENROWSET(<br/>        BULK 'coviddata/covid_19_data.csv',<br/>        FORMAT = 'CSV',<br/>        PARSER_VERSION='2.0',<br/>        DATA_SOURCE = 'SqlOnDemandDemo',<br/>        FIRSTROW = 2<br/>    ) WITH (<br/>      SNo int,<br/>      ObservationDate varchar(50),<br/>      ProvinceState varchar(200),<br/>      CountryRegion varchar(200),<br/>      LastUpdate varchar(50),<br/>      Confirmed decimal(18,2),<br/>      Deaths decimal(18,2),<br/>      Recovered decimal(18,2)<br/>) AS [result]</span></pre><ul class=""><li id="c78c" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">让我们验证一下，数据是否加载正确</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="5749" class="ky ig hi ku b fi kz la l lb lc">select top 200 * from covidview;</span></pre><figure class="kp kq kr ks fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/941a918d231360cf00b04d26b567ec01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b8RBJb0KOK3gK-UAOp1mOQ.jpeg"/></div></div></figure><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="4cb2" class="ky ig hi ku b fi kz la l lb lc">select count(*) from covidview;</span></pre><figure class="kp kq kr ks fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lq"><img src="../Images/5a96cce3d79a45e067aa78ca86fe10c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oew6rgZcHaBxwtrgNnOoZA.jpeg"/></div></div></figure><ul class=""><li id="b477" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">现在让我们做一些 SQL 查询来模拟 ETL 活动</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="0fe3" class="ky ig hi ku b fi kz la l lb lc">Select CountryRegion, sum(Confirmed) as Confirmed, sum(Deaths) as Deaths, sum(Recovered) as Recovered<br/> from covidview <br/>group by CountryRegion</span><span id="cac3" class="ky ig hi ku b fi lr la l lb lc">Select datepart(YEAR, ObservationDate) as year, datepart(MONTH, ObservationDate) as month, <br/>CountryRegion, <br/>sum(Confirmed) as Confirmed, sum(Deaths) as Deaths, sum(Recovered) as Recovered<br/> from covidview <br/>group by datepart(YEAR, ObservationDate), datepart(MONTH, ObservationDate),CountryRegion</span></pre><figure class="kp kq kr ks fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es ls"><img src="../Images/d6b50b1933b6019ce1b76292db404efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ux6L-SCvvsJsAfjwCm1N-A.jpeg"/></div></div></figure><ul class=""><li id="cf85" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">现在，我们希望将输出存储到另一个表中，以便进一步处理或可视化</li><li id="fa51" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">为此，我们需要创建一个数据源</li><li id="f790" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">在门户中创建一个单独的容器作为 covidoutput</li><li id="e769" class="kb kc hi jf b jg kk jk kl jo km js kn jw ko ka kg kh ki kj bi translated">下面的语法不会创建新的容器，所以如果容器不存在将会出错</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="8c2a" class="ky ig hi ku b fi kz la l lb lc">-- create a container called covidoutput in blob or adls container.<br/>CREATE EXTERNAL DATA SOURCE mycovidioutput WITH (<br/>    LOCATION = 'https://storageaccountname.blob.core.windows.net/covidoutput', CREDENTIAL = sqlondemand<br/>);<br/>GO</span></pre><ul class=""><li id="c33e" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">现在我们为拼花地板文件格式，作为更通用的文件格式</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="2633" class="ky ig hi ku b fi kz la l lb lc">CREATE EXTERNAL FILE FORMAT [ParquetFF] WITH (<br/>    FORMAT_TYPE = PARQUET,<br/>    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'<br/>);<br/>GO</span></pre><ul class=""><li id="c75c" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">现在是存储 ETL 输出的时候了</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="c8fc" class="ky ig hi ku b fi kz la l lb lc">CREATE EXTERNAL TABLE [dbo].[covidaggrCETAS] WITH (<br/>        LOCATION = 'covidAggr/',<br/>        DATA_SOURCE = [mycovidioutput],<br/>        FILE_FORMAT = [ParquetFF]<br/>) AS<br/>Select datepart(YEAR, ObservationDate) as year, datepart(MONTH, ObservationDate) as month, <br/>CountryRegion, <br/>sum(Confirmed) as Confirmed, sum(Deaths) as Deaths, sum(Recovered) as Recovered<br/> from covidview <br/>group by datepart(YEAR, ObservationDate), datepart(MONTH, ObservationDate),CountryRegion;</span></pre><ul class=""><li id="769d" class="kb kc hi jf b jg ld jk le jo lf js lg jw lh ka kg kh ki kj bi translated">让我们验证并查看数据是否被保存(持久化)以供进一步处理</li></ul><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="e053" class="ky ig hi ku b fi kz la l lb lc">USE [coviddb];<br/>GO<br/><br/>SELECT<br/>    *<br/>FROM covidaggrCETAS;</span></pre><figure class="kp kq kr ks fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lt"><img src="../Images/17ed5a28e065615eb83fe7c1926db26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Xzz89zc561NajrnXYBZew.jpeg"/></div></div></figure><p id="e443" class="pw-post-body-paragraph jd je hi jf b jg ld ji jj jk le jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated">原文可在此处找到:</p><p id="2738" class="pw-post-body-paragraph jd je hi jf b jg ld ji jj jk le jm jn jo lu jq jr js lv ju jv jw lw jy jz ka hb bi translated"><a class="ae lx" href="https://github.com/balakreshnan/synapseAnalytics/blob/master/sqlondemand.md" rel="noopener ugc nofollow" target="_blank">https://github . com/balakreshnan/synapse analytics/blob/master/sqlondemand . MD</a></p></div></div>    
</body>
</html>