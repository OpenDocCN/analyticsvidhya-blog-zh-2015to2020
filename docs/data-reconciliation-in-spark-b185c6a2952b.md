# Spark 中的数据协调

> 原文：<https://medium.com/analytics-vidhya/data-reconciliation-in-spark-b185c6a2952b?source=collection_archive---------5----------------------->

![](img/cc17c1c35b764720a514cd8adf934d63.png)

数据协调被定义为在数据迁移期间验证数据的过程。在此过程中，将目标数据与源数据进行比较，以确保迁移按预期进行。

## **需要数据对账**

*   没有数据验证，你不能相信你的数据。
*   比较记录数和填充率并不总是有效的。
*   不可信的数据导致有缺陷的见解。

**数据核对器**是一个数据核对工具，检查你的数据的准确性。在向您介绍技术实现之前，我想向您展示一下协调工具的输出。您可以按照下一节中的说明自己运行这段代码。

输入数据集有 4 个字段，记录数为 5000 万条，大小约为 1 GB，采用拼花格式。在对这个数据集执行协调之后，我们得到以下输出。

上述输出提供了以下信息。

*   **匹配记录计数**(记录 6) —两个数据集中主键匹配的记录数。换句话说，在数据集之间执行内部连接后的记录计数。该值将用作计算每列匹配记录百分比的分母。
*   **丢弃的记录**(记录 7)——旧表中存在但新表中不存在的记录数。换句话说，左反连接的输出。
*   **新记录**(记录 8)——新表中存在但旧表中不存在的记录数。
*   **旧文件路径**(记录 9) —旧表中的实际记录数。
*   **新文件路径**(记录 10) —新表中的实际记录数。
*   **字段名**(列 1) —包含旧表中可用的每一列。
*   **匹配记录数**(第 2 列)—新旧两列中值相同的记录数。
*   **不匹配记录数**(第 3 列)—新旧两列中值不同的记录数。
*   **匹配记录百分比**(第 4 列)—单个列的匹配记录数/数据集之间的匹配记录数(记录 6)

## 如何运行数据协调器？

数据协调器的源代码可在 [github](https://github.com/tharun026/SparkDataReconciler) 中获得。目前，该工具只支持 Parquet 格式的数据，数据应该有一个主键或主键的组合。如果需要，您可以下载代码并添加定制，然后构建它。一旦有了 jar，就可以将其加载到大数据环境中，并使用命令触发作业

```
/usr/lib/spark/bin/spark-submit --deploy-mode cluster --executor-cores 5 --name Data_Reconciliation --class com.github.tharun.datareconciler.Pipeline {JAR_PATH} --qualityCheckType reconciler --oldTable {PATH_OF_OLD_DATA} --newTable {PATH_OF_NEW_DATA} --outputPath {PATH_OF_OUTPUT_DATA} --primaryKey {COMMA_SEPARATED_PRIMARY_KEYS}
```

## 参数:

*   *执行器内核* — 5。这是为了实现并行性和相等负载的平衡。
*   *名称* —数据 _ 对账。你的火花工作的名字。
*   *类*—com . github . tharun . data reconciler . pipeline . spark 作业的主类或入口点。
*   *JAR_PATH* —放置罐子的路径。
*   *质量检查类型* —调解器。用于触发代码的协调部分。
*   *旧表* —旧数据的路径。存储旧数据集的路径。
*   *新表* —新数据的路径。存储新数据集的路径。
*   *主键* —逗号分隔的主键列名。

## 技术实现

一旦输入了两个数据集，它们就会基于主键被连接起来。现在，对于每条记录，如果列“A”中的值与列“B”中的值匹配，则创建一个值为“1”的新列，如果值不匹配，则用值“0”填充新列。这个新列的总和给出了每一列的匹配记录总数。一旦我们有了匹配的记录计数，就可以计算不匹配记录计数、匹配百分比等其他值。

## 运行时统计

## *数据集 1*

*   五千万张唱片
*   镶木地板 6 GB
*   170 列
*   AWS r5.12x 大型— 5 个节点
*   3 分钟运行时间

## 数据集 2

*   3.5 亿条记录
*   镶木地板 30 GB
*   170 列
*   AWS r5.12x 大型— 10 个节点
*   6 分钟运行时间

Github 网址—[https://github.com/tharun026/SparkDataReconciler](https://github.com/tharun026/SparkDataReconciler)

有问题吗？在这里随意评论。

如果你喜欢这篇文章，请点击👏所以其他人会在媒体上看到它。