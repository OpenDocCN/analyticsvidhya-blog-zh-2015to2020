<html>
<head>
<title>A new way of using open data: Query the chain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用开放数据的新方法:查询链</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/a-new-way-of-using-open-data-query-the-chain-78c8e95c172a?source=collection_archive---------19-----------------------#2019-11-12">https://medium.com/analytics-vidhya/a-new-way-of-using-open-data-query-the-chain-78c8e95c172a?source=collection_archive---------19-----------------------#2019-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d21b7317e75192f39ddf50b2a58cac12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zzgqffttAe2Viwwx"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae iu" href="https://unsplash.com/@launchpresso?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Launchpresso </a>拍摄的照片</figcaption></figure><blockquote class="iv iw ix"><p id="3772" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">“数据是新的黄金”</p><p id="46b8" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">“大数据是新的黑金吗？”</p><p id="933c" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">“数据不是下一个黄金。这是下一个铀”</p><p id="ad5e" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">“世界上最宝贵的资源不再是石油，而是数据”</p></blockquote><p id="6057" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">剧透一下，我是区块链开发者，不是数据科学家。这篇文章是关于用<strong class="jb hj">图</strong>访问数据的。但我们在2019年的秋天，仍然(或开始)相信数据是下一个黄金。虽然有些人可能会质疑，但这不是在这里讨论的话题。</p><p id="025f" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">毫无疑问，数据是我们拥有的最好的资源之一。不是因为它的货币价值(不像黄金)，而是因为它告诉我们什么。因为它描述了我们。即使听起来不舒服，我们有时也会发现我们不知道的事情。看，没有数据，人工智能或人工智能系统如何学习或训练。</p><p id="d0f7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">再说一次，数据最有价值的方面是它给我们的生活带来的质量。我们能够以更快的速度进行研究。我们已经能够收集成千上万的照片，并创建微笑识别系统。成千上万的单词和识别文本主题，以及其他许多事情。</p><h1 id="88aa" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">不仅如此，而且</h1><p id="f57a" class="pw-post-body-paragraph iy iz hi jb b jc ky je jf jg kz ji jj jx la jm jn jy lb jq jr jz lc ju jv jw hb bi translated">正如我在开头提到的，我不是数据科学家。但我知道，当一家公司收到数据进行研究时，在真正开始研究之前，需要采取一些步骤。在进入任何ML或AI系统之前，都需要进行标准化和匿名化。</p><p id="a772" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">也就是说，我们假设下面的数据是公开的。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="c61f" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">可以提出许多问题，但其中一些最重要的问题是:</p><ul class=""><li id="227c" class="lj lk hi jb b jc jd jg jh jx ll jy lm jz ln jw lo lp lq lr bi translated">如果这些数据是你的呢？没人会知道是你。</li><li id="be11" class="lj lk hi jb b jc ls jg lt jx lu jy lv jz lw jw lo lp lq lr bi translated">这会与研究相关吗？</li></ul><p id="ba44" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我知道这是医疗保健相关的数据，但事实是，它没有说任何人。它可以引导我们得出非常有趣的结论。医院利用过去的信息创造财富。某些特定日期最常见的进入原因。以及我们的年龄和生活方式对此有何影响。</p><p id="58f9" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">除了货币价值之外，这些数据还可以极大地改善我们的生活，这已经不是什么秘密了。</p><h1 id="cef8" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">来自区块链的公开数据</h1><p id="32c8" class="pw-post-body-paragraph iy iz hi jb b jc ky je jf jg kz ji jj jx la jm jn jy lb jq jr jz lc ju jv jw hb bi translated">最近发现，汽油价格在午餐时间达到最高点。那不是很有趣吗？</p><p id="4706" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在谈及尚未公开的数据之前，我想先谈谈区块链的公开数据。在这种情况下，来自以太坊生态系统的任何链。</p><p id="45bb" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">让我给你介绍一下<strong class="jb hj"> EIP 1767 </strong>，旨在为以太坊事件定义一个GraphQL模式。在我写这篇文章的时候，你只能用一个<strong class="jb hj"> JSON-RPC </strong>，用<strong class="jb hj"> HTTP </strong>或<strong class="jb hj"> WebSocket </strong>来查询数据。除了在EIP中描述的那个界面有一些问题之外，还有可能做得更好。</p><p id="0b5f" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">已经可以使用<a class="ae iu" href="https://github.com/ethereum/grid" rel="noopener ugc nofollow" target="_blank"> <strong class="jb hj">网格</strong> </a>和<a class="ae iu" href="https://github.com/ConsenSys/ethql" rel="noopener ugc nofollow" target="_blank"> <strong class="jb hj"> ethql </strong> </a>执行一些GraphQL查询。在我看来，比这两个更好的是<a class="ae iu" href="https://thegraph.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jb hj"> TheGraph </strong> </a>。</p><p id="4455" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">虽然我最近才发现，但这个图表是两年前开始的。它的主要目标是“为分散的未来提供可扩展的查询”。该项目总体上很复杂，超出了我在本文中所能涵盖的范围。现在，我只想展示一下这个工具是如何工作的。</p><h1 id="ffaa" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">使用图进行查询</h1><p id="fd5e" class="pw-post-body-paragraph iy iz hi jb b jc ky je jf jg kz ji jj jx la jm jn jy lb jq jr jz lc ju jv jw hb bi translated">该图适用于已经部署在网络上的智能合同。在部署子图之前，它需要知道合同地址。索引数据是一个大问题，在每个项目中都需要花费大量时间来解决。使用这个图表，这个问题就解决了。</p><p id="b2e9" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">让我们假设您已经在网络中部署了一个项目。为了简化，我们假设你用的是<a class="ae iu" href="http://techhq.io" rel="noopener ugc nofollow" target="_blank"> TechHQ </a>的<a class="ae iu" href="https://github.com/HQ20/simple-ethereum-dapp" rel="noopener ugc nofollow" target="_blank"><strong class="jb hj">simple-ether eum-dapp</strong></a><strong class="jb hj"/>。</p><p id="0c8a" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">克隆这个存储库，并在<strong class="jb hj"> SimpleStorage.sol </strong>文件中做一个小小的修改，这样它就可以发出一个事件，由图形进行处理。该图通过索引事件来工作，使得检索信息更快。</p><p id="b868" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在<strong class="jb hj"> storedData </strong>变量之前，用<strong class="jb hj"> event SetX(uint256 x)定义一个事件；</strong></p><p id="1cb6" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">然后在set函数上，用<strong class="jb hj"> emit SetX(x)发出<strong class="jb hj"> SetX </strong>事件；</strong></p><p id="c089" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">要让一个工作的区块链环境向图提供事件，首先，安装依赖项(使用<strong class="jb hj"> yarn </strong>)，启动网络(运行<strong class="jb hj"> yarn start:ganache:dev </strong>)并部署已部署的契约(使用<strong class="jb hj">npx truffle migrate-network development</strong>)启动子图。</p><p id="01a7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">首先安装graph-cli(通过做<strong class="jb hj">yarn add @ graph protocol/graph-CLI</strong>)并使用<strong class="jb hj">npx graph init-from-contract 0x F2 dee 5975 a 808 f 16 f 93 BF 4 FD 55 ab 5481 A8 b 20497-网络开发</strong>启动子图。当提示输入名称时，键入<strong class="jb hj"> start/simple </strong>，目录可以是默认的<strong class="jb hj"> simple </strong>。当被问及网络时，选择任何一个，使用本地网络没有任何区别。合同地址应该已经自动填写。如果找不到ABI，就把地址放到<strong class="jb hj"> SimpleStorage.json </strong>文件中(应该是<strong class="jb hj">)。/build/contracts/simple storage . JSON</strong>。</p><p id="4492" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">现在你已经有了一个名为<strong class="jb hj"> simple </strong>的新文件夹，其中包含了图形代码。让我们看看新的文件夹和文件。</p><ul class=""><li id="8435" class="lj lk hi jb b jc jd jg jh jx ll jy lm jz ln jw lo lp lq lr bi translated"><strong class="jb hj"> abis </strong> —包含合同文件abis</li><li id="ee2c" class="lj lk hi jb b jc ls jg lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><strong class="jb hj">生成的</strong> —不要碰它，它是使用所有其他文件自动生成的</li><li id="122e" class="lj lk hi jb b jc ls jg lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><strong class="jb hj"> src </strong> —包含支持graphql服务器的源代码</li><li id="65c0" class="lj lk hi jb b jc ls jg lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><strong class="jb hj"> schema.graphql </strong> —定义graphql模式</li><li id="c5cc" class="lj lk hi jb b jc ls jg lt jx lu jy lv jz lw jw lo lp lq lr bi translated"><strong class="jb hj">子图. yaml </strong> —定义子图</li></ul><h1 id="c3f3" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">部署子图</h1><p id="569b" class="pw-post-body-paragraph iy iz hi jb b jc ky je jf jg kz ji jj jx la jm jn jy lb jq jr jz lc ju jv jw hb bi translated">子图就像一组指令，部署并链接到URL。它允许您使用graphql查询一组合同的信息。</p><p id="b891" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">您可以将一个子图部署到一个托管服务中，但是有时从命令行本地完成更容易。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="fa0b" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">移动到生成的<strong class="jb hj">简单</strong>文件夹。</p><p id="ac45" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">第一次，你需要创建子图(用<strong class="jb hj"> yarn create-local </strong>)。一旦成功，部署子图(使用<strong class="jb hj">纱线部署-局部</strong>)。</p><p id="b0be" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">到最后一步结束时，如果成功的话，你应该得到一个类似于<a class="ae iu" href="http://localhost:8000/subgraphs/name/start/simple" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/subgraphs/name/start/simple</a>的链接。点击这个链接，你将会看到一个<strong class="jb hj">图形1</strong>网页。对于那些不熟悉graphql的人，我将带您浏览这个简单而有用的UI。</p><p id="8ede" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">首先，让我们获取所有已经完成的操作(为x设置不同的值)。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="acae" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在GraphiQL中使用上面的代码，您将在响应中获得一个空数组。这是因为什么也没发生。但是如果你改变值几次，再查询一次，就会有一些数据显示出来。</p><p id="e2a7" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">移动到我们克隆的根文件夹(不在<strong class="jb hj">简单</strong>中)并使用下面的命令</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="6ca8" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">如果您再次执行上面的查询，您将获得一些信息。您将只能看到最后一个结果，因为我们是根据发送它们的用户来索引操作的。您可以在<strong class="jb hj">的<strong class="jb hj"> src/mapings.ts </strong>处进行更改，让entity = example entity . load(event . transaction . from . to hex())</strong></p><p id="341e" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">要获得更多的事件，您可以将从改为hash。然后，图将通过散列而不是用户地址来索引事务，保存所有事务。</p><h1 id="c3fb" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">查询在过去2分钟内将x值更改为5到9之间的用户</h1><p id="abc1" class="pw-post-body-paragraph iy iz hi jb b jc ky je jf jg kz ji jj jx la jm jn jy lb jq jr jz lc ju jv jw hb bi translated">这听起来像是一个复杂的挑战，但实际上，它非常简单。为了查询这个新数据，我们需要契约来发出它。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="1091" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">该事件现在发出改变值的用户，以及根据<em class="ja"> block.timestamp </em>的时间戳；</p><p id="7d01" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">然后，让我们将<strong class="jb hj">子图. yaml </strong>中的事件处理程序更新为</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="aa15" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">因此，我们还需要更新<strong class="jb hj"> schema.graphql </strong>以</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="976d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">和<strong class="jb hj"> abis/Contract.json </strong>来</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="f681" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">最后一步是更改<strong class="jb hj"> src/mapping.ts </strong>，但是首先，我们需要新生成的代码。可以用<strong class="jb hj">纱线编码</strong>获得。</p><p id="cfcc" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">最后，将<strong class="jb hj"> src/mappings.ts </strong>更新为</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="ea79" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">该图现在准备使用事务散列作为<em class="ja"> id </em>来索引数据，并保存新的<em class="ja"> x </em>值、改变该值的<em class="ja">帐户地址</em>和<em class="ja">时间戳</em>。</p><p id="f8d6" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在执行新的查询之前，您必须部署新的契约并更新子图。记住<strong class="jb hj"> subgraph.yaml </strong>包含契约地址。如果您部署合同，您很可能会获得一个新地址。因为您正在运行一个ganache实例(必须是由克隆的存储库提供的，使用<strong class="jb hj"> yarn start:ganache:dev </strong>)，所以您可以利用确定性属性。因此，如果您重新启动ganache并再次部署契约(参见上面的命令)，您将获得相同的地址。</p><p id="4052" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">所以，只要确保有正确的地址，再次部署子图(用<strong class="jb hj"> yarn deploy-local </strong>)。</p><p id="e600" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">如果您现在执行下面的查询(在GraphiQL中),您将获得想要的结果</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="653c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">您可以在<a class="ae iu" href="https://thegraph.com/docs/graphql-api#queries" rel="noopener ugc nofollow" target="_blank">图形文档</a>中找到有关查询的更多详细信息。</p><h1 id="00e6" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结论</h1><p id="404f" class="pw-post-body-paragraph iy iz hi jb b jc ky je jf jg kz ji jj jx la jm jn jy lb jq jr jz lc ju jv jw hb bi translated">我们已经看到数据可以带给我们很多信息，有价值的信息。</p><p id="8617" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">如果到目前为止，很难获得任何类型的数据，并且花费很长时间，这些新工具表明我们可以做得更好。</p><p id="bba0" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">数据科学家，人工智能和ML专家，如果你在附近，加入运动。你将获得惊人的机会获得大量开放的标准化干净数据。</p><p id="ec47" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">在社交媒体上找到我，保持联系。</p><p id="5970" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">特别感谢<a class="ae iu" href="https://www.linkedin.com/in/albertocuesta/" rel="noopener ugc nofollow" target="_blank">Alberto caada</a>的点评。以及<a class="ae iu" href="https://www.techhq.io/" rel="noopener ugc nofollow" target="_blank"> TechHQ </a>。</p></div></div>    
</body>
</html>