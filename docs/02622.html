<html>
<head>
<title>SQL for Analysts — A challenge a day — Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向分析师的SQL每天的挑战—第3部分</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/sql-for-analysts-a-challenge-a-day-part-3-f46c0df54ce8?source=collection_archive---------17-----------------------#2019-12-25">https://medium.com/analytics-vidhya/sql-for-analysts-a-challenge-a-day-part-3-f46c0df54ce8?source=collection_archive---------17-----------------------#2019-12-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0e8cf0e50da733ea175d6028df78ccdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fjc68nb-NCK9a9rl"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com/@martinsanchez?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马丁·桑切斯</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="iv iw ix"><p id="7fe2" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">嗨伙计们！欢迎来到“<em class="hi">分析师SQL</em>”系列。本系列将通过真实的场景来练习分析师面临的常见挑战/问题。本系列将涵盖中级到高级的挑战，因此如果您不精通SQL的基础知识或语法，我建议您使用一些其他资源来逐步提高。我将使用MySQL来应对这些挑战，所以我建议您也使用MySQL。该系列没有任何特定的顺序，所以你可以从任何部分开始，并尝试解决挑战。</p><p id="a792" class="iy iz ja jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw hb bi translated">也就是说，让我们开始吧。快乐学习！</p></blockquote><p id="d2f0" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated"><strong class="jb hj">挑战:</strong></p><p id="3ade" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">下表保存了机器状态的快照。只有当状态发生变化时，才会在表中创建一个条目。哪些机器在12月9日处于运行状态？</p><p id="e66e" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">下面是我们正在处理的数据的快照:</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es ka"><img src="../Images/20faf84901969fbc3d9408e8bd1a9acc.png" data-original-src="https://miro.medium.com/v2/resize:fit:528/format:webp/1*dbyfXQu7NoQem5sIu6y4fw.png"/></div></figure><p id="8a81" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">最终输出应该是这样的:</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div class="er es kf"><img src="../Images/1ae3d1cebb200ec68c177a7db526c360.png" data-original-src="https://miro.medium.com/v2/resize:fit:498/format:webp/1*raZ0S_qUa35dngglJWVBLQ.png"/></div></figure><p id="1bcd" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">此外，下面是创建表并向其中添加上述数据的代码:</p><pre class="kb kc kd ke fd kg kh ki kj aw kk bi"><span id="2823" class="kl km hi kh b fi kn ko l kp kq">create table machine_log(<br/>id int,<br/>machine_id int,<br/>is_live BOOLEAN,<br/>updated_on Date<br/>);</span><span id="793e" class="kl km hi kh b fi kr ko l kp kq">insert into machine_log values<br/>(1,1,TRUE,’2018–12–01'),<br/>(2,2,TRUE, ‘2018–12–01’),<br/>(3,3, TRUE, ‘2018–12–01’),<br/>(4,3,FALSE, ‘2018–12–02’),<br/>(5,2,FALSE,’2018–12–05'),<br/>(7, 2, TRUE, ‘2018–12–07’),<br/>(8,4,TRUE,’2018–12–08'),<br/>(6,3,TRUE, ‘2018–12–10’);</span></pre><p id="fb14" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated"><strong class="jb hj">解决方案:</strong></p><p id="3194" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">这个问题的诀窍是找出一种方法来找出每台机器的活动和非活动状态的窗口。</p><p id="558c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">我们可以使用窗口函数来创建另一个列，该列主要捕获下一个状态更改日期。这是通过使用lead函数将<code class="du ks kt ku kh b">updated_on</code>列中的值偏移1来实现的。请注意，我们还提供了<code class="du ks kt ku kh b">curdate()</code>作为默认值，以防lead函数产生空值</p><pre class="kb kc kd ke fd kg kh ki kj aw kk bi"><span id="5fb0" class="kl km hi kh b fi kn ko l kp kq">select *,<br/>lead(updated_on,1,curdate()) over( partition by machine_id order by updated_on asc) as next_update_date <br/>from machine_log;</span></pre><p id="b82f" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">接下来，使用next_update_date和updated_on列，我们可以确定12月9日是否在这两个日期范围内，以及机器在此期间是否处于活动状态。</p><p id="aa97" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">这为我们提供了最终的查询:</p><pre class="kb kc kd ke fd kg kh ki kj aw kk bi"><span id="487d" class="kl km hi kh b fi kn ko l kp kq">with cte as(<br/>select *,<br/>lead(updated_on,1,curdate()) over(partition by machine_id order by updated_on asc) as next_update_date<br/>from machine_log)<br/>select machine_id, is_live, updated_on as last_updated_date <br/>from cte <br/>where updated_on &lt;=’2018–12–09' <br/>and next_update_date &gt; ‘2018–12–09’<br/>and is_live=1;</span></pre><p id="c3d4" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">这为我们提供了12月9日所有处于活动状态的机器的列表。</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="970d" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">如果您有兴趣解决更多问题，您可以在以下位置找到更多挑战:</p><p id="e13c" class="pw-post-body-paragraph iy iz hi jb b jc jd je jf jg jh ji jj jx jl jm jn jy jp jq jr jz jt ju jv jw hb bi translated">之前的挑战—<a class="ae iu" rel="noopener" href="/analytics-vidhya/sql-for-analysts-a-challenge-a-day-part-2-fcc549f10cb9">https://medium . com/analytics-vid hya/SQL-for-analysts-a-challenge-a-day-part-2-FCC 549 f 10 CB 9</a></p></div></div>    
</body>
</html>