<html>
<head>
<title>Building Tensorflow from source. Step by step guide.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从源构建张量流。逐步指南。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/building-tensorflow-from-source-step-by-step-guide-1075ef2d9356?source=collection_archive---------5-----------------------#2020-01-27">https://medium.com/analytics-vidhya/building-tensorflow-from-source-step-by-step-guide-1075ef2d9356?source=collection_archive---------5-----------------------#2020-01-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="601d" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">如何从源代码构建Tensorflow，快捷方式/为旧CPU构建tensor flow/tensor flow构建故障排除</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/70ddef905ec24c4e0b3ff7e87a5b3cd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ShtlXiXi_58Omty4xwcGTw.png"/></div></div></figure><p id="9380" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">目标是编译Tensorflow二进制文件并构建<a class="ae kn" href="https://packaging.python.org/tutorials/packaging-projects/#generating-distribution-archives" rel="noopener ugc nofollow" target="_blank"> Python wheel安装文件</a>。如果您需要为旧的CPU重新编译框架，这可能会很方便。旧的CPU可能没有像AVX、AVX2、SSE4.2这样的最新CPU指令，但官方Tensorflow社区提供的二进制文件专注于更新的硬件。</p><p id="60e3" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">本指南给出了构建Tensorflow的最简单方法，无需安装所有构建工具，也无需深入细节。</p><h1 id="c2f2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">1.设置构建环境。</h1><p id="1959" class="pw-post-body-paragraph jp jq hi jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hb bi translated">我们将使用tensorflow社区提供的<a class="ae kn" href="https://hub.docker.com/r/tensorflow/tensorflow/tags/" rel="noopener ugc nofollow" target="_blank"> docker图片。</a></p><ul class=""><li id="87b8" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">下载tensorflow docker开发图像</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="9316" class="lh ig hi ld b fi li lj l lk ll">docker pull tensorflow/tensorflow:devel-py3</span></pre><ul class=""><li id="7306" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">运行tensorflow image并挂载共享卷以在最后复制结果轮文件</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="7679" class="lh ig hi ld b fi li lj l lk ll">docker run -it -w /tensorflow -v &lt;host_directory&gt;:/share tensorflow/tensorflow:devel-py3 bash</span></pre><h1 id="64fb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">2.获取最新的tensorflow版本并完成环境设置</h1><ul class=""><li id="5ab3" class="kt ku hi jr b js ko jw kp ka lm ke ln ki lo km ky kz la lb bi translated">在容器或本地文件夹中(如果改为步骤1，环境是手动设置的)</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="cea5" class="lh ig hi ld b fi li lj l lk ll">cd /tensorflow_src/<br/>git pull<br/>git checkout r2.1</span></pre><ul class=""><li id="814c" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">为构建安装python依赖项</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="6326" class="lh ig hi ld b fi li lj l lk ll">pip3 install six numpy wheel<br/>pip3 install keras_applications==1.0.6 --no-deps<br/>pip3 install keras_preprocessing==1.0.5 --no-deps</span></pre><h1 id="77bf" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">3.为目标CPU配置bazel / understand标志</h1><p id="20b5" class="pw-post-body-paragraph jp jq hi jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hb bi translated">每个CPU都有自己的指令列表。特定的指令支持对实现的机器学习算法的执行速度有影响。重要的是，如果目标CPU不支持该指令，但Tensorflow二进制文件在大多数情况下都支持它们，您将会遇到一些致命的错误— Tensorflow将无法运行。正确选择构建标志以适应您的目标CPU非常重要。</p><ul class=""><li id="967a" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">启动bazel配置:</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="7c79" class="lh ig hi ld b fi li lj l lk ll">python configure.py</span></pre><ul class=""><li id="cc05" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">回答问题，并将正确的编译标志放在末尾:</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="109b" class="lh ig hi ld b fi li lj l lk ll">Found possible Python library paths:<br/> /usr/local/lib/python3.6/dist-packages<br/> /usr/lib/python3/dist-packages<br/>Please input the desired Python library path to use. Default is [/usr/local/lib/python3.6/dist-packages]<br/>Do you wish to build TensorFlow with XLA JIT support? [Y/n]: n<br/>No XLA JIT support will be enabled for TensorFlow.<br/>Do you wish to build TensorFlow with OpenCL SYCL support? [y/N]:<br/>No OpenCL SYCL support will be enabled for TensorFlow.<br/>Do you wish to build TensorFlow with ROCm support? [y/N]:<br/>No ROCm support will be enabled for TensorFlow.<br/>Do you wish to build TensorFlow with CUDA support? [y/N]:<br/>No CUDA support will be enabled for TensorFlow.<br/>Do you wish to download a fresh release of clang? (Experimental) [y/N]:<br/>Clang will not be downloaded.<br/>Please specify optimization flags to use during compilation when bazel option " - config=opt" is specified [Default is -march=native -Wno-sign-compare]: -march=skylake<br/>Would you like to interactively configure ./WORKSPACE for Android builds? [y/N]:<br/>Not configuring the WORKSPACE for Android builds.</span></pre><p id="9180" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">配置CPU标志最简单的方法是选择目标CPU的微体系结构。在本例中，“-march=skylake”适用于赛扬3855U Skylake-U CPU优化和限制。</p><ul class=""><li id="531d" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated"><em class="lp">为gcc获取CPU微架构代码。<br/> </em>在目标PC上执行此行:</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="afdc" class="lh ig hi ld b fi li lj l lk ll">cat /sys/devices/cpu/caps/pmu_name</span></pre><p id="4c4a" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">另一方面，如果你知道你在做什么，手动获取正确的CPU指令是可能的。</p><ul class=""><li id="2d49" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated"><em class="lp">获取标志列表。仅当CPU架构代码不知何故不匹配或不按预期工作时。</em> <br/>在目标PC上执行此行:</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="2f50" class="lh ig hi ld b fi li lj l lk ll">grep flags -m1 /proc/cpuinfo | cut -d “:” -f 2 | tr ‘[:upper:]’ ‘[:lower:]’ | { read FLAGS; OPT=”-march=native”; for flag in $FLAGS; do case “$flag” in “sse4_1” | “sse4_2” | “ssse3” | “fma” | “cx16” | “popcnt” | “avx” | “avx2”) OPT+=” -m$flag”;; esac; done; MODOPT=${OPT//_/\.}; echo “$MODOPT”; }</span></pre><p id="d08e" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">输出格式为"-March = native-mssse 3-mcx 16-msse 4.1-msse 4.2-mpopcnt "。<br/> CPU指令也可能被禁用。<br/> <strong class="jr hj">全标志列表是</strong> <a class="ae kn" href="https://gcc.gnu.org/onlinedocs/gcc-4.5.3/gcc/i386-and-x86_002d64-Options.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jr hj">这里是</strong> </a></p><h1 id="460a" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">4.用bazel为目标CPU构建..</h1><p id="75ee" class="pw-post-body-paragraph jp jq hi jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hb bi translated">对于Windows 10 docker、8GB RAM、4个i7 CPU，大约需要3.5小时。</p><ul class=""><li id="16fa" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">使用步骤3中的标志组装构建行，并从“/tensorflow_src/”文件夹运行</li></ul><p id="944e" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">覆盖行军标志的示例:</p><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="866d" class="lh ig hi ld b fi li lj l lk ll">bazel build --copt=-march=skylake //tensorflow/tools/pip_package:build_pip_package</span></pre><p id="fcf0" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">强制和受限标志的示例:</p><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="df94" class="lh ig hi ld b fi li lj l lk ll">bazel build --config=opt --copt=-mssse3 --copt=-mcx16 --copt=-msse4.1 --copt=-msse4.2 --copt=-mpopcnt --copt=-mno-fma4 --copt=-mno-avx --copt=-mno-avx2 //tensorflow/tools/pip_package:build_pip_package</span></pre><h1 id="c8ec" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">5.用python安装轮文件包装二进制文件</h1><ul class=""><li id="301f" class="kt ku hi jr b js ko jw kp ka lm ke ln ki lo km ky kz la lb bi translated">将车轮文件生成到共享目录:</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="ccc3" class="lh ig hi ld b fi li lj l lk ll">./bazel-bin/tensorflow/tools/pip_package/build_pip_package /share</span></pre><ul class=""><li id="ceea" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">现在，安装文件ex:" tensor flow-2 . 1 . 0-cp36-cp36m-Linux _ x86 _ 64 . whl "已经准备好安装/部署到目标环境中。</li></ul><h1 id="b7eb" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">6.安装Tensorflow并用hello-world示例进行验证</h1><p id="d185" class="pw-post-body-paragraph jp jq hi jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hb bi translated">在目标环境中安装Tensorflow:</p><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="9176" class="lh ig hi ld b fi li lj l lk ll">python3.6 -m pip install /tensorflow-2.1.0-cp36-cp36m-linux_x86_64.whl</span></pre><ul class=""><li id="2e5e" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">验证张量流正在工作(v2。XX)</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="0cb8" class="lh ig hi ld b fi li lj l lk ll">python3.6 -c "import tensorflow as tf; msg = tf.constant('TensorFlow 2.0 Hello World'); tf.print(msg)"</span></pre><ul class=""><li id="f64a" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">验证Tensorflow正在工作(v1。XX)</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="e448" class="lh ig hi ld b fi li lj l lk ll">python3.6 -c "from __future__ import print_function; import tensorflow as tf; hello = tf.constant('Hello, TensorFlow!'); sess = tf.Session(); print(sess.run(hello))"</span></pre><h1 id="f677" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">故障排除</strong></h1><p id="6f83" class="pw-post-body-paragraph jp jq hi jr b js ko ju jv jw kp jy jz ka kq kc kd ke kr kg kh ki ks kk kl km hb bi translated"><strong class="jr hj"> <em class="lp">巴泽尔不对版/更新巴泽尔</em> </strong></p><p id="58e9" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">下载所需版本和平台的二进制<a class="ae kn" href="https://github.com/bazelbuild/bazel/releases" rel="noopener ugc nofollow" target="_blank">安装程序</a>或<a class="ae kn" href="https://docs.bazel.build/versions/master/install-ubuntu.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="04d1" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">docker容器内部:</p><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="9c07" class="lh ig hi ld b fi li lj l lk ll">./bazel-1.2.1-installer-linux-x86_64.sh</span></pre><p id="ea0b" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><strong class="jr hj"> <em class="lp">未发现类似“CXXABI_1.3.11”的错误</em> </strong></p><p id="d11d" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">Tensorflow成功安装但无法运行时出现。检查目标是否具有所需的API版本，例如:` CXXABI_1.3.11 `:</p><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="34f2" class="lh ig hi ld b fi li lj l lk ll">strings /usr/lib/x86_64-linux-gnu/libstdc++.so.6 | grep CXXABI</span></pre><p id="e52b" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">如果“1.3.11”缺失，请执行以下步骤之一:</p><ul class=""><li id="568b" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated">将参数(步骤4)添加到构建行，以支持与旧GCC的兼容性</li></ul><pre class="je jf jg jh fd lc ld le lf aw lg bi"><span id="ba6c" class="lh ig hi ld b fi li lj l lk ll">bazel build --cxxopt="-D_GLIBCXX_USE_CXX11_ABI=0" &lt;your other params&gt;</span></pre><ul class=""><li id="4bfa" class="kt ku hi jr b js jt jw jx ka kv ke kw ki kx km ky kz la lb bi translated"><em class="lp">(备选脏解决方案)</em>如果已经构建了安装文件并且平台匹配，您只需要快速修复:<br/>根据目标系统，将/usr/lib/x86_64-linux-gnu/libstdc++ . so . 6 "文件从tensorflow开发docker容器(来自步骤1)复制到目标环境的相同路径/usr/lib/x86 _ 64-Linux-GNU/"或/usr/lib64 "或类似路径。</li></ul><p id="fa89" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated"><strong class="jr hj"> <em class="lp">运行</em> </strong>后非法指令Tensorflow错误</p><p id="ae7d" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">意味着没有正确选择构建标志，因为编译的二进制文件和目标CPU配置不匹配。<br/>试炼` --三月'旗；禁用步骤4中使用的、在步骤3中选择的不支持的指令，例如:`-mno-avx`。</p><p id="f273" class="pw-post-body-paragraph jp jq hi jr b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km hb bi translated">乡亲们，这就是全部！</p><h2 id="68c4" class="lh ig hi bd ih lq lr ls il lt lu lv ip ka lw lx it ke ly lz ix ki ma mb jb mc bi translated">链接:</h2><ol class=""><li id="498e" class="kt ku hi jr b js ko jw kp ka lm ke ln ki lo km md kz la lb bi translated">张量流源代码<a class="ae kn" href="https://github.com/tensorflow/tensorflow" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow</a></li><li id="ff5a" class="kt ku hi jr b js me jw mf ka mg ke mh ki mi km md kz la lb bi translated">议题讨论1<a class="ae kn" href="https://github.com/tensorflow/tensorflow/issues/15777" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/tensorflow/issues/15777</a></li><li id="79b9" class="kt ku hi jr b js me jw mf ka mg ke mh ki mi km md kz la lb bi translated">议题讨论2<a class="ae kn" href="https://github.com/tensorflow/serving/issues/819" rel="noopener ugc nofollow" target="_blank">https://github.com/tensorflow/serving/issues/819</a></li><li id="9f5f" class="kt ku hi jr b js me jw mf ka mg ke mh ki mi km md kz la lb bi translated">问题讨论3<a class="ae kn" href="https://github.com/yaroslavvb/tensorflow-community-wheels/issues/103" rel="noopener ugc nofollow" target="_blank">https://github . com/yaroslavvb/tensor flow-community-wheels/issues/103</a></li><li id="bee4" class="kt ku hi jr b js me jw mf ka mg ke mh ki mi km md kz la lb bi translated"><a class="ae kn" rel="noopener" href="/@sometimescasey/building-tensorflow-from-source-for-sse-avx-fma-instructions-worth-the-effort-fbda4e30eec3">https://medium . com/@ sometimes Casey/building-tensor flow-from-source-for-SSE-avx-fma-instructions-worth-the-effort-fbda 4 e 30 EEC 3</a></li></ol></div></div>    
</body>
</html>