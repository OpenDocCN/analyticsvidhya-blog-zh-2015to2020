<html>
<head>
<title>Stock Price Prediction: Facebook Prophet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">股票价格预测:脸书预言家</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/stock-price-prediction-facebook-prophet-34c385ff05a9?source=collection_archive---------17-----------------------#2020-05-03">https://medium.com/analytics-vidhya/stock-price-prediction-facebook-prophet-34c385ff05a9?source=collection_archive---------17-----------------------#2020-05-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e125" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">预测股票价格是一项困难的任务。几个因素会影响股票的价格，而这在模型中并不总是容易适应的。由于上述原因，目前世界上没有一个模型能够准确预测股票价格，也可能永远不会有。脸书给出了一个“最先进的模型”和“易于使用”和一个广泛的超参数调整选项，以给出较为准确的预测。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/973eb7ebe5e18a3cb66c264560376310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ilW32lbRZyA_s5ToL3ufmg.jpeg"/></div></div></figure><h1 id="6eb4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">预处理</h1><p id="b502" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">如上所述，我们有一个数据集，其中包含新德国基金从2013年到2018年的股票价格。现在，当我们导入数据并第一次看到它时，我们看到它没有按日期的升序排序，这是一个主要问题，因为预测值更可能取决于最近的条目，而不是之前的条目。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ks"><img src="../Images/b5f48da2e984ce8fda02d4c4b895b90c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4UeSqQqZhpFOXaMTizfx6g.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">未排序的数据集。</figcaption></figure><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="9803" class="lc jq hi ky b fi ld le l lf lg">stock_prices['DATE'] = pd.to_datetime(stock_prices["DATE"])<br/>stock_prices = stock_prices.sort_values(by="DATE")</span></pre><p id="06b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后，我们按日期绘制开盘价的值。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lh"><img src="../Images/270a384f8a2e33ff48358be5866aeb53.png" data-original-src="https://miro.medium.com/v2/resize:fit:548/format:webp/1*9SBED4GecZaqPMb-1pXGjQ.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">图1</figcaption></figure><p id="b51f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如你所看到的，从2013年到2014年，这个数值突然下降，这是非常不寻常的。一个可能的原因是2013年的值可能很少。我们使用下面的代码进行检查。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="f626" class="lc jq hi ky b fi ld le l lf lg">stock_prices = stock_prices[stock_prices.Year == 2013]</span></pre><p id="8949" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码产生了一个只有3个条目的数据集。我们移除这些值。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="f5ff" class="lc jq hi ky b fi ld le l lf lg">stock_prices = stock_prices[stock_prices.Year != 2013]</span></pre><p id="ec3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据最终看起来是这样的:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es li"><img src="../Images/069ec9ec7c7135541c156092cd951110.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*MaQa6HlNYUh_LhtzvHAVVg.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">图2</figcaption></figure><p id="67d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还需要将数据集的索引设置为日期，但是我们不能访问日期，因为它现在是Dataframe索引。为了解决这个问题，我们将首先创建日期列的副本。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="0e71" class="lc jq hi ky b fi ld le l lf lg">stock_prices[‘date’] = stock_prices[‘DATE’]<br/>stock_prices.set_index("DATE", inplace = True)</span></pre><h1 id="190b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">探索性数据分析</h1><p id="4ff1" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">自相关让我们了解模型的季节性。如果一定数量的滞后的相关值很高，则该滞后数就是季节性。</p><p id="6be3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">值1的滞后对应于一天，因为我们数据集中的时间步长是一天。</p><p id="501a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从下图可以明显看出，滞后接近0时，相关性很高。滞后值越大，自相关值似乎越小。这意味着我们的数据没有季节性。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lj"><img src="../Images/623cfab48179f65c8a94469b659c006d.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*tX8m_b5fGVrH-fK_ubKkDQ.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">自相关与滞后</figcaption></figure><p id="1697" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们进一步深入了解了数据的年增长率。2017年的面积最大，因此增长最快。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/cd4c45c79214c4caccb19cb45f03f68f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IZQF7qbOcD6tBvw8oIaAKQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">增长与年份</figcaption></figure><h1 id="2df0" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">拟合模型</h1><p id="3fae" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我们在笔记本中导入脸书先知。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="45bf" class="lc jq hi ky b fi ld le l lf lg">from fbprophet import Prophet</span></pre><p id="de31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Prophet有一个我们需要注意的特定输入格式。它将元数据作为重要列的特定名称的输入。例如，假设你正在预测股票的开盘价。要使用Prophet，您需要将开盘价列的名称改为“y ”,日期改为“ds”。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="dd6c" class="lc jq hi ky b fi ld le l lf lg">stock_prices = stock_prices.rename(columns={‘date’: ‘ds’, ‘OPEN’: ‘y’})</span></pre><p id="eff5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你完成了这些，你就可以输入数据集来适应模型。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="4467" class="lc jq hi ky b fi ld le l lf lg">m = Prophet()<br/>m.fit(stock_prices)</span></pre><h1 id="796d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">预测未来值</h1><p id="000e" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">对于预测，我们生成要预测其值的未来日期。这是通过以下代码完成的:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="f29f" class="lc jq hi ky b fi ld le l lf lg">future = m.make_future_dataframe(periods=5)</span></pre><p id="bb0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，使用model.predict()获得一个估计值。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="bdbe" class="lc jq hi ky b fi ld le l lf lg">forecast = m.predict(future)</span></pre><p id="1a4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的预测值显示为蓝色，实际值显示为黑色:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/0f70ec364cf2cbefbc898e7c0d6611cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ePHHMnN3beiywOL18ekG2A.png"/></div></div></figure><h1 id="bc8a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">生成验证数据集</h1><p id="abcd" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">模型的超参数调整是提高模型精度的一个非常关键的步骤。但是要选择合适的超参数，我们需要验证数据。我们利用Prophet的内置验证数据集生成器。</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="043d" class="lc jq hi ky b fi ld le l lf lg">from fbprophet.diagnostics import cross_validation<br/>cv_results = cross_validation(m , horizon='30 days')</span></pre><p id="f44f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了判断模型的性能，我们选择“平均绝对百分比误差”度量，它给出了模型与实际值的偏差的平均百分比。MAPE越小，模型越好。MAPE可以通过以下函数计算:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="630c" class="lc jq hi ky b fi ld le l lf lg">def mspe(y_true , y_pred):<br/>return np.mean(np.abs((np.array(y_true)-np.array(y_pred))/np.array(y_true)))*100</span></pre><h1 id="708e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">超参数</strong></h1><p id="eea2" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">Prophet可以通过适当调整其超参数来有效地实现，以描述我们的数据。</p><ul class=""><li id="d9b4" class="lm ln hi ih b ii ij im in iq lo iu lp iy lq jc lr ls lt lu bi translated"><strong class="ih hj">增长</strong>:快速浏览一下图2，可以看到一个持续增长的趋势，没有真正的饱和洞察力。因此，<em class="lv">增长</em>参数被设置为<em class="lv">‘线性’</em>。如果这一趋势最终似乎饱和，增长将被设定为“逻辑增长”</li><li id="ac05" class="lm ln hi ih b ii lw im lx iq ly iu lz iy ma jc lr ls lt lu bi translated"><strong class="ih hj">节假日:</strong>我们认为，像新年、圣诞节这样的节假日对股价没有明显的影响。</li><li id="618f" class="lm ln hi ih b ii lw im lx iq ly iu lz iy ma jc lr ls lt lu bi translated"><strong class="ih hj">变点</strong>:数据的突然变化称为变点。参数<em class="lv">变化点</em>可用于这些突然变化的日期事先已知的情况。因为我们不是领域专家，所以我们没有为这个参数设置值。</li><li id="1675" class="lm ln hi ih b ii lw im lx iq ly iu lz iy ma jc lr ls lt lu bi translated"><strong class="ih hj">change point _ prior _ scale</strong>:<em class="lv">change point _ prior _ scale</em>的值越大，变点越倾向于符合数据。因此，较高的值可能会导致过度拟合。在浏览了几个博客后，我们将该值设置为0.15。</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mb"><img src="../Images/4c9644ea76afb58de0ab9663ee51b0a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*yyu71M4-aZ4cqYO3ie7V4w.png"/></div><figcaption class="kt ku et er es kv kw bd b be z dx translated"><strong class="bd jr"> X轴:</strong>n _变点<strong class="bd jr"> Y轴:</strong> MSPE</figcaption></figure><ul class=""><li id="f9aa" class="lm ln hi ih b ii ij im in iq lo iu lp iy lq jc lr ls lt lu bi translated"><strong class="ih hj"> n_changepoints </strong>:该参数等于突然变化的次数，即<em class="lv">变点</em>出现在数据中。图2粗略地显示了数据中的5个这样的突变。然而，在从1到10的迭代中(在初始化常数<em class="lv">change point _ prior _ scale</em>之后)，值2作为n_changepoints产生最小的平均绝对误差。</li><li id="d2dd" class="lm ln hi ih b ii lw im lx iq ly iu lz iy ma jc lr ls lt lu bi translated"><strong class="ih hj">季节性:</strong>由于缺乏股票价格如何波动的知识，我们通过分析图__得出数据缺乏<em class="lv">季节性</em></li></ul><h1 id="6e9f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">模型</h1><p id="194e" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">设置上述超参数后，最终的模型调用如下所示:</p><pre class="je jf jg jh fd kx ky kz la aw lb bi"><span id="e395" class="lc jq hi ky b fi ld le l lf lg">df_prophet = fbprophet.Prophet(changepoint_prior_scale=0.15, n_changepoints=2)</span></pre><h1 id="d577" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">结论</h1><p id="195c" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我们得到了6.075的最终MAPE。</p><p id="09a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们要感谢以下文章的作者:<br/> 1。<a class="ae mc" href="https://towardsdatascience.com/end-to-end-time-series-analysis-and-modelling-8c34f09a3014" rel="noopener" target="_blank">端到端时间序列和建模</a>T37】2。<a class="ae mc" href="https://towardsdatascience.com/implementing-facebook-prophet-efficiently-c241305405a3" rel="noopener" target="_blank">实施脸书先知高效</a> ly</p><p id="dac6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该博客由奈蒂克·汉德尔瓦尔和尼基塔·萨克塞纳撰写和编辑。Github代码:<a class="ae mc" href="https://github.com/nikita-0209/stock_price_detection/blob/master/Prophet_Stock_Prediction.ipynb" rel="noopener ugc nofollow" target="_blank">尼基塔</a>，<a class="ae mc" href="https://github.com/Naitik1502/Stock_Prediction_Using_Prophet/blob/master/Stock_prices.ipynb" rel="noopener ugc nofollow" target="_blank">奈蒂克</a></p></div></div>    
</body>
</html>