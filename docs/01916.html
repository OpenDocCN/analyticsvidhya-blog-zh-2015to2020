<html>
<head>
<title>Deep Learning on Jetson Nano: Streamlining Docker Builds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jetson Nano上的深度学习:简化Docker构建</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deep-learning-on-jetson-nano-streamlining-docker-builds-699c8ef4a379?source=collection_archive---------8-----------------------#2019-11-21">https://medium.com/analytics-vidhya/deep-learning-on-jetson-nano-streamlining-docker-builds-699c8ef4a379?source=collection_archive---------8-----------------------#2019-11-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="60f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然Jetson Nano的默认图像附带了许多用于构建深度学习应用程序的有用包，但TensorFlow、Keras、Pytorch或Jupyter笔记本不在其中。NVIDIA提供了官方的<a class="ae jd" href="https://devtalk.nvidia.com/default/topic/1048776/jetson-nano/official-tensorflow-for-jetson-nano-/" rel="noopener ugc nofollow" target="_blank"> Tensorflow </a>和<a class="ae jd" href="https://devtalk.nvidia.com/default/topic/1049071/jetson-nano/pytorch-for-jetson-nano-version-1-3-0-now-available/" rel="noopener ugc nofollow" target="_blank"> PyTorch </a>软件包，但安装可能需要几个小时，因为相关的轮子需要时间来构建。此外，在长时间运行DL应用程序后，我遇到了一些存储卡损坏的问题，所以即使使用shell脚本重新安装所有东西最终也变成了一件苦差事。正如你们许多人已经知道的，Docker是简化这些用例的明显工具。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/31158fd7ab2794fded22272900da8630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zxJPTfPSwo7NKQqy.jpg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">杰特森纳米开发工具包</figcaption></figure><p id="5c0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Nano的最新官方映像(Jetpack 4.2.2)预装了<strong class="ih hj"> docker </strong>和<strong class="ih hj"> nvidia-docker </strong>，因此我们不必在Nano上运行任何预建的映像。但是我没有找到任何使用TensorFlow、PyTorch、Keras、scikit-learn和Jupyter的更新图像，可以让我轻松地测试和调整DL模型，所以我选择为自己构建一个。在这篇文章中，我将分享我遵循的步骤。</p><p id="c8bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Nano上构建一个定制的arm64映像可能是另一个麻烦，因为试图在它上面构建映像会给它简陋的CPU和内存带来太多压力，更不用说SD卡的磨损和漫长的构建时间了。幸运的是，docker在今年早些时候发布了一个跨平台构建功能，它可以帮助我们在更强大的<strong class="ih hj"> x86 </strong>机器上更快地构建Docker映像，同时仍然针对<strong class="ih hj"> arm64 </strong>架构。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ju"><img src="../Images/025ad5a8a93d0ac6d707c5c84aab6004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RpqD8VvRNb7fQ44WGU1LIA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">来自“边缘”频道的最新Docker桌面</figcaption></figure><p id="3773" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要开始，首先获得Docker的最新版本，并确保您在<a class="ae jd" href="https://engineering.docker.com/2019/04/multi-arch-images/" rel="noopener ugc nofollow" target="_blank"> edge channel </a>上。我目前在Mac OS X上运行的是2.1.6.0版本。如果你运行的是Linux，请遵循本指南。确保您已经<code class="du jv jw jx jy b">qemu</code>安装并配置了在您的<strong class="ih hj">x86</strong>CPU上运行<strong class="ih hj"> arm64 </strong>仿真。</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="34c7" class="kd ke hi jy b fi kf kg l kh ki">➜ cat /proc/sys/fs/binfmt_misc/qemu-aarch64<br/>enabled<br/>interpreter /usr/bin/qemu-aarch64<br/>flags: OCF<br/>offset 0<br/>magic 7f454c460201010000000000000000000200b7<br/>mask ffffffffffffff00fffffffffffffffffeffff</span></pre><p id="30e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装了最新的docker和<code class="du jv jw jx jy b">qemu</code>之后，是时候检查可用的构建器了。</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="87e0" class="kd ke hi jy b fi kf kg l kh ki">➜ docker buildx ls</span><span id="7609" class="kd ke hi jy b fi kj kg l kh ki">NAME/NODE DRIVER/ENDPOINT STATUS PLATFORMS<br/>default * docker<br/> default default running linux/amd64, linux/arm64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6</span></pre><p id="5b75" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在available platforms列表中看到<code class="du jv jw jx jy b">linux/arm64</code> <strong class="ih hj"> </strong>，所以我们可以开始了(如果没有看到条目，引导一个<a class="ae jd" href="https://engineering.docker.com/2019/04/multi-arch-images/" rel="noopener ugc nofollow" target="_blank">新构建器</a>)。我们现在需要弄清楚<code class="du jv jw jx jy b">Dockerfile</code>的结构。我们将从<a class="ae jd" href="https://ngc.nvidia.com/catalog/containers/nvidia:l4t-base" rel="noopener ugc nofollow" target="_blank"> NVIDIA的Linux4Tegra </a>基本映像(411 MB)开始，并在其上添加我们自己的包。我花了几次努力才找到了最小化构建时间和图像大小的最佳包列表。</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="a6f1" class="kd ke hi jy b fi kf kg l kh ki">FROM nvcr.io/nvidia/l4t-base:r32.2.1</span><span id="080e" class="kd ke hi jy b fi kj kg l kh ki">MAINTAINER ABU ZAHER MD FARIDEE &lt;<a class="ae jd" href="mailto:zaher14@gmail.com" rel="noopener ugc nofollow" target="_blank">zaher14@gmail.com</a>&gt;</span><span id="827e" class="kd ke hi jy b fi kj kg l kh ki">ARG DEBIAN_FRONTEND=noninteractive<br/>RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends build-essential curl libfreetype6-dev libhdf5-dev libpng-dev libzmq3-dev pkg-config python3-dev python3-numpy python3-scipy python3-sklearn python3-matplotlib python3-pandas rsync unzip zlib1g-dev zip libjpeg8-dev hdf5-tools libhdf5-serial-dev python3-pip python3-setuptools</span><span id="dc03" class="kd ke hi jy b fi kj kg l kh ki">RUN  apt-get clean &amp;&amp; \<br/>        rm -rf /var/lib/apt/lists/*</span><span id="0877" class="kd ke hi jy b fi kj kg l kh ki">RUN pip3 install -U pip -v</span><span id="b457" class="kd ke hi jy b fi kj kg l kh ki">RUN pip3 --no-cache-dir install -U -v jupyter grpcio absl-py py-cpuinfo psutil portpicker six mock requests gast h5py astor termcolor protobuf keras keras-applications keras-preprocessing wrapt google-pasta</span><span id="70c8" class="kd ke hi jy b fi kj kg l kh ki">RUN pip3 --no-cache-dir install --pre -v --extra-index-url <a class="ae jd" href="https://developer.download.nvidia.com/compute/redist/jp/v42" rel="noopener ugc nofollow" target="_blank">https://developer.download.nvidia.com/compute/redist/jp/v42</a> tensorflow-gpu==1.14.0+nv19.10</span><span id="b667" class="kd ke hi jy b fi kj kg l kh ki">RUN curl -L <a class="ae jd" href="https://nvidia.box.com/shared/static/phqe92v26cbhqjohwtvxorrwnmrnfx1o.whl" rel="noopener ugc nofollow" target="_blank">https://nvidia.box.com/shared/static/phqe92v26cbhqjohwtvxorrwnmrnfx1o.whl</a> &gt; /tmp/torch-1.3.0-cp36-cp36m-linux_aarch64.whl &amp;&amp; pip3 --no-cache-dir -v install /tmp/torch-1.3.0-cp36-cp36m-linux_aarch64.whl &amp;&amp; rm  /tmp/torch-1.3.0-cp36-cp36m-linux_aarch64.whl</span><span id="53c2" class="kd ke hi jy b fi kj kg l kh ki">EXPOSE 8888 6006</span><span id="8046" class="kd ke hi jy b fi kj kg l kh ki">RUN mkdir -p /notebooks</span><span id="fda9" class="kd ke hi jy b fi kj kg l kh ki">CMD ["jupyter", "notebook", "--no-browser", "--ip=0.0.0.0", "--allow-root", "--notebook-dir='/notebooks'"]</span></pre><p id="c272" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们构建图像并将其推送到docker注册表</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="ff26" class="kd ke hi jy b fi kf kg l kh ki">➜ docker buildx build --platform linux/arm64 --push -t azmfaridee/nano-dl .</span></pre><p id="9f9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jv jw jx jy b">pip3 install</code>指令将占用大部分构建时间，因为大部分轮子将从源代码编译。我不得不在一台2017款Macbook Pro上等了3个多小时。最终图像大约为1.09 GB。</p><p id="54a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是时候公布结果了。假设我们刚刚使用SD卡上的<a class="ae jd" href="https://developer.nvidia.com/embedded/learn/get-started-jetson-nano-devkit#setup" rel="noopener ugc nofollow" target="_blank">新映像启动到<strong class="ih hj"> Nano </strong>，我们需要做的第一件事是将新创建的用户添加到<code class="du jv jw jx jy b">docker</code>组。</a></p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="c772" class="kd ke hi jy b fi kf kg l kh ki">➜ <!-- -->sudo usermod -aG docker $USER</span></pre><p id="b452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们可以提取刚刚构建的图像并调用<code class="du jv jw jx jy b">nvidia-docker</code></p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="c680" class="kd ke hi jy b fi kf kg l kh ki">➜ docker pull azmfaridee/nano-dl<br/>➜ nvidia-docker run -it -p 8888:8888 -v /home/mpsc/code:/notebooks --name nano-dl-container azmfaridee/nano-dl</span></pre><p id="1153" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可能需要一段时间，取决于SD卡的写入速度，但我们将通过下面的消息来回报我们的耐心！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kk"><img src="../Images/61c866d4332df1715462c316e6cfce4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wGAQtFZhlZNCHURY_S4qvQ.png"/></div></div></figure><p id="4c4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在桌面浏览器上打开Jupyter，Nano的IP在<code class="du jv jw jx jy b">8888</code>端口上。所有的库都可供我们使用。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kl"><img src="../Images/a286149e02beb88a3703ad5d346cfe7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FBX3_zUf0w01MQj1m4fSow.png"/></div></div></figure><p id="9a9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以仔细检查TensorFlow是否可以访问GPU。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es km"><img src="../Images/5d8e267d9078938ef9eebbdeaad54232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_fh8sgnVYZ5qFtImGmwy9w.png"/></div></div></figure><p id="e1c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果只是想马上运行一些Tensorflow或者Pytorch程序，可以直接使用映像，不需要经过映像构建阶段。</p><p id="2fc0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这些了，伙计们。希望这篇文章能为你在嵌入式深度学习的艰难旅程中节省一些时间。欢迎随时查看GitHub的回购更新代码，并通过Twitter或Linkedin联系我！</p></div></div>    
</body>
</html>