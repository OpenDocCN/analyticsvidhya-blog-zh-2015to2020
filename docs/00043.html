<html>
<head>
<title>Web Scraping using R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用R的网页抓取</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/web-scraping-using-r-f256da5db50c?source=collection_archive---------1-----------------------#2018-07-25">https://medium.com/analytics-vidhya/web-scraping-using-r-f256da5db50c?source=collection_archive---------1-----------------------#2018-07-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5fc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我记录我使用R或Python解决数据分析/数据科学问题的小实验系列的一部分。这些实验可能是多余的，可能已经被不同的人写在博客上了，但这更多的是个人日记和我个人的学习过程。并且，在这个过程中，我希望我能吸引和激励任何和我经历相同过程的人。如果一个比我更有见识的人偶然发现了这个博客，并认为有一种更好的方式来做事情，或者我在某些地方出错了，请随时分享反馈，不仅帮助我，也帮助每个人作为一个社区一起成长。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/3cae079eaf58410f333d03a742402f51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgBgy-vegmHRlIKwDXiisg.png"/></div></div></figure><p id="ad2e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">前兆:</strong>我最近搬到了加拿大的温哥华，我想在夏天让位于秋天，然后是冬天之前，尽可能多地徒步旅行。我谷歌了一下温哥华周围的小路，发现了一个整洁的网站【www.vancouvertrails.com T4】。然后我想，也许为什么不做一个谷歌表来跟踪这些轨迹，当我完成它们并记下我的经历。我本可以将这些数据复制粘贴到google sheet中，然后继续前进，但那样就没什么意思了，所以我想，为什么不写一个R代码来抓取网站数据并导出为csv格式，然后我会上传到我的google sheet中。(是的，我喜欢让事情变得尽可能有趣)</p><p id="3816" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">目标</strong>:抓取网站数据并导出为csv文件，当我在做的时候，使用ggplot做一些有趣的数据分析。(足够简单)</p><p id="91d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">库:</strong>我开始在R库的文档中寻找要使用的库和要使用的函数，在谷歌搜索了大约15分钟后，我找到了我喜欢的库“rvest”。</p><p id="8dd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第一步:读取网址</strong></p><p id="8a3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一个函数“read_html”，我们将使用它来读取给定网页上的html。</p><pre class="jf jg jh ji fd jr js jt ju aw jv bi"><span id="0a23" class="jw jx hi js b fi jy jz l ka kb">url &lt;- “<a class="ae jq" href="https://www.vancouvertrails.com/trails/?details=&amp;sort=#list" rel="noopener ugc nofollow" target="_blank">https://www.vancouvertrails.com/trails/?details=&amp;sort=#list</a>"<br/>trails_webpage &lt;- read_html(url)</span></pre><p id="c916" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你访问过上面的网址，你会看到它列出了温哥华及其周边的所有路线(准确地说是167条)</p><p id="977c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第二步:抓取需要的数据</strong></p><p id="7c3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，<em class="jd"> rvest </em>库最好的部分是你可以从html节点中提取数据，这意味着你可以直接选择带有id或css类的节点，并从html标签中提取文本。所以我去了我的网址，启动了浏览器上的“firebug”，很快就发现远足的名字已经被封装在<em class="jd">中了。trailname" </em> css类，使用这个css类我可以提取网页上所有的踪迹名称。</p><p id="ddf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里我们将使用两个函数:</p><ol class=""><li id="ba13" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">html_nodes:使用这个函数提取我们喜欢的节点(在这个例子中，节点带有“.trailname "作为css类</li><li id="cd44" class="kc kd hi ih b ii kl im km iq kn iu ko iy kp jc kh ki kj kk bi translated">html_text:使用这个函数提取html节点之间的文本(在本例中是我们的线索名称)</li></ol><pre class="jf jg jh ji fd jr js jt ju aw jv bi"><span id="f5a1" class="jw jx hi js b fi jy jz l ka kb">#Scraping Trail Names using css class ‘trailname’</span><span id="87c4" class="jw jx hi js b fi kq jz l ka kb">trail_names_html &lt;-html_nodes(trails_webpage, ‘.trailname’)<br/>trail_names &lt;- html_text(trail_names_html)<br/>head(trail_names)</span><span id="be8b" class="jw jx hi js b fi kq jz l ka kb"><strong class="js hj">Output:<br/></strong>[1] “Abby Grind” “Admiralty Point” <br/>[3] “Al’s Habrich Ridge Trail” “Aldergrove Regional Park”<br/>[5] “Alice Lake” “Ancient Cedars Trail”</span></pre><p id="92ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，现在我将对每条路线的所有其他属性也这样做:地区、难度、时间、距离、季节。每个属性都有自己的css类:名称、时间、难度、距离和时间表</p><pre class="jf jg jh ji fd jr js jt ju aw jv bi"><span id="ef86" class="jw jx hi js b fi jy jz l ka kb">#Trail Region</span><span id="30f0" class="jw jx hi js b fi kq jz l ka kb">trail_region_html &lt;-html_nodes(trails_webpage, '.i-name')<br/>trail_region &lt;- html_text(trail_region_html)<br/>head(trail_region)</span><span id="87e5" class="jw jx hi js b fi kq jz l ka kb"><strong class="js hj">Output:<br/></strong>[1] "Fraser Valley East" "Tri Cities"         "Howe Sound"        <br/>[4] "Surrey and Langley" "Howe Sound"         "Whistler"</span><span id="e39b" class="jw jx hi js b fi kq jz l ka kb">#Trail Difficulty</span><span id="a63f" class="jw jx hi js b fi kq jz l ka kb">trail_diff_html &lt;-html_nodes(trails_webpage, '.i-difficulty')<br/>trail_diff &lt;- html_text(trail_diff_html)<br/>head(trail_diff)</span><span id="be7a" class="jw jx hi js b fi kq jz l ka kb"><strong class="js hj">Output:<br/></strong>[1] "Intermediate" "Easy"   "Intermediate" "Easy"         "Easy"        <br/>[6] "Intermediate"</span><span id="5dec" class="jw jx hi js b fi kq jz l ka kb">#Trail Season</span><span id="85bf" class="jw jx hi js b fi kq jz l ka kb">trail_season_html &lt;-html_nodes(trails_webpage, '.i-schedule')<br/>trail_season &lt;- html_text(trail_season_html)<br/>head(trail_season)</span><span id="fa73" class="jw jx hi js b fi kq jz l ka kb"><strong class="js hj">Output:</strong><br/>[1] "year-round"  "year-round"   "July - October"   "year-round"      <br/>[5] "April - November" "June - October"  <br/>&gt;</span></pre><p id="b7ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一点要注意，当我们提取时间时，它是以一个字符的形式出现的:<em class="jd">例如:1.5小时，3小时。</em>我们希望它是数字形式，为了将它转换成数字形式，使用了库:<em class="jd"> Stringr </em>和函数:` str_extract '</p><p id="7265" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">逻辑是我使用正则表达式来匹配模式，并从html文本中提取相同的内容。正则表达式帮助，可以参考这里  <em class="jd">的` stringr` <em class="jd"> </em> <a class="ae jq" href="http://edrub.in/CheatSheets/cheatSheetStringr.pdf" rel="noopener ugc nofollow" target="_blank"> <em class="jd">的cheatsheet。</em></a></em></p><p id="3447" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是我把它转换成数字形式的方法:</p><pre class="jf jg jh ji fd jr js jt ju aw jv bi"><span id="fb03" class="jw jx hi js b fi jy jz l ka kb">#Extracting Trail Times:</span><span id="2e38" class="jw jx hi js b fi kq jz l ka kb">trail_time_html &lt;-html_nodes(trails_webpage, '.i-time')<br/>trail_time &lt;- html_text(trail_time_html)<br/>head(trail_time)</span><span id="8909" class="jw jx hi js b fi kq jz l ka kb">#"1.5 hours" "1.5 hours" "5 hours"   "2 hours"  </span><span id="3ded" class="jw jx hi js b fi kq jz l ka kb">#Extracted data is in the form of character, we need to extract digits and convert it into numeric format</span><span id="c5c2" class="jw jx hi js b fi kq jz l ka kb">trail_time &lt;- as.numeric(str_extract(trail_time,pattern = "\\-*\\d+\\.*\\d*"))</span><span id="3d66" class="jw jx hi js b fi kq jz l ka kb">head(trail_time,25)</span><span id="49d8" class="jw jx hi js b fi kq jz l ka kb"><strong class="js hj">Output:<br/></strong>[1]  1.50  1.50  5.00  2.00  2.00  2.00  3.50  5.00<br/>[9]  5.00  1.50  1.00  5.00 11.00  3.00  1.00  2.00<br/>[17]  1.50  1.00  0.50  3.50  0.25  5.00  4.00  2.00<br/>[25]  3.50</span></pre><p id="811f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">类似地，对轨迹距离做了同样的事情，因为信息是字符形式的，例如:4公里:</p><pre class="jf jg jh ji fd jr js jt ju aw jv bi"><span id="2a8b" class="jw jx hi js b fi jy jz l ka kb">#Trail Distance</span><span id="1076" class="jw jx hi js b fi kq jz l ka kb">trail_dist_html &lt;-html_nodes(trails_webpage, '.i-distance')<br/>trail_dist &lt;- html_text(trail_dist_html)<br/>head(trail_dist)</span><span id="d30a" class="jw jx hi js b fi kq jz l ka kb">trail_dist &lt;- as.numeric(str_extract(trail_dist,pattern = "\\-*\\d+\\.*\\d*"))</span><span id="b7f9" class="jw jx hi js b fi kq jz l ka kb">head(trail_dist,25)</span><span id="9376" class="jw jx hi js b fi kq jz l ka kb"><strong class="js hj">Output:<br/></strong>[1]  4.0  5.0  7.0  5.0  6.0  5.0  6.1 12.0 10.0  3.0  2.6 10.0 29.0  8.0  2.5<br/>[16]  5.0  4.0  4.2  1.0  6.0  0.8  7.5  7.0  8.0 10.0</span></pre><p id="996c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">步骤3: </strong>现在我们已经有了所有的信息，让我们将其整理成一个数据帧并导出到。csv文件。为了能够做到这一点，我们使用了库<code class="du kr ks kt js b">readr</code>中的函数<code class="du kr ks kt js b">write_csv</code></p><pre class="jf jg jh ji fd jr js jt ju aw jv bi"><span id="4e36" class="jw jx hi js b fi jy jz l ka kb">library(readr)</span><span id="e80f" class="jw jx hi js b fi kq jz l ka kb">#Combining all the extracted features of the trails</span><span id="c286" class="jw jx hi js b fi kq jz l ka kb">trails_df &lt;- data.frame(<br/>  Name =trail_names,<br/>  Region = trail_region,<br/>  Difficulty=trail_diff,<br/>  Distance=trail_dist,<br/>  HikeTime = trail_time,<br/>  Season = trail_season<br/>  )<br/>str(trails_df)<br/><br/>write_csv(trails_df, "vancouver_trails.csv")</span></pre><p id="a3d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第四步:数据分析</strong></p><p id="37e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这一部分，使用库ggplot2来可视化数据</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ku"><img src="../Images/f006119483e52e4c621a65761c47e346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*vUb2il5X8YI78WCX3x1BMA.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">地区与徒步时间和难度</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ku"><img src="../Images/321707d43d012a7dfc9c745b1a9fa61b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*8H2IISRG6B_YT4WaagBdKA.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">区域与距离和难度</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ku"><img src="../Images/0d85427e3766e224143d50e86f2b7986.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*FltHjNM9RIPexX40l2LTQw.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx translated">地区与季节，难度与徒步时间</figcaption></figure></div></div>    
</body>
</html>