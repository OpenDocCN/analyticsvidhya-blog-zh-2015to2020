<html>
<head>
<title>Using OpenCV to detect face key points in C++</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 OpenCV 在 C++中检测人脸关键点</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/using-opencv-to-detect-face-key-points-with-c-f77d50e59685?source=collection_archive---------20-----------------------#2020-08-08">https://medium.com/analytics-vidhya/using-opencv-to-detect-face-key-points-with-c-f77d50e59685?source=collection_archive---------20-----------------------#2020-08-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="59ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章是我的第一篇关于用 C++中的 OpenCV 构建人脸检测器的文章的后续。在这篇文章中，我们将建立在现有的代码和检测面部关键点。结果会是这样的。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/840e1695166ceeb6c0eb7717e078c3a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fJB7xm8o8h6qDmo8pWJBw.png"/></div></div></figure><p id="9218" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于我们将使用 OpenCV 的一个相对较新的版本(4.2.0 ),你可能想回到<a class="ae jd" href="https://bewagner.github.io/programming/2020/04/12/building-a-face-detector-with-opencv-in-cpp/" rel="noopener ugc nofollow" target="_blank">以前的文章</a>去阅读更多关于如何安装必要的包。</p><p id="6603" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码<a class="ae jd" href="https://github.com/bewagner/visuals/tree/blog-post-2" rel="noopener ugc nofollow" target="_blank">在我的 github 上。</a></p><p id="5047" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们走吧！</p><h1 id="0328" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">检测人脸关键点</h1><p id="3ea8" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在上一篇文章中检测人脸后，我们现在想检测人脸关键点。我们使用<code class="du kt ku kv kw b"><a class="ae jd" href="https://docs.opencv.org/3.4/dc/d63/classcv_1_1face_1_1FacemarkLBF.html" rel="noopener ugc nofollow" target="_blank">cv::face::FacemarkLBF</a></code>模型来寻找我们在上一课中确定的面部矩形中的关键点。</p><h1 id="3b30" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">添加关键点检测模型文件</h1><p id="a811" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">至于人脸检测模型，我们要为 LBF 模型添加一个<a class="ae jd" href="https://github.com/bewagner/visuals/blob/blog-post-2/assets/lbfmodel.yaml" rel="noopener ugc nofollow" target="_blank">模型文件</a>。我把模型文件放在<a class="ae jd" href="https://github.com/bewagner/visuals/tree/blog-post-2" rel="noopener ugc nofollow" target="_blank">的<code class="du kt ku kv kw b">assets</code>文件夹里，这是 git repo </a>的帖子，你可以去那里下载。</p><p id="c7a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将这个模型文件的位置传递给我们的代码，我们将使用与第一篇文章中相同的 CMake <code class="du kt ku kv kw b">target_compile_definitions</code>技巧。因此，确保您将模型文件放在了正确的位置，并将下面几行添加到您的<code class="du kt ku kv kw b">CMakeLists.txt</code>中。</p><pre class="jf jg jh ji fd kx kw ky kz aw la bi"><span id="e4c4" class="lb jr hi kw b fi lc ld l le lf"># Introduce preprocessor variables to keep paths of asset files <br/>... <br/>set(KEY_POINT_DETECTION_MODEL <br/>  "${PROJECT_SOURCE_DIR}/assets/lbfmodel.yaml") <br/>... <br/>target_compile_definitions(${PROJECT_NAME} <br/>  PRIVATE KEY_POINT_DETECTION_MODEL="${KEY_POINT_DETECTION_MODEL}")</span></pre><h1 id="bf7d" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">关键点检测器的类</h1><p id="0888" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">我们首先为关键点检测器添加一个类。这样我们就有了在一个地方初始化和调用模型的代码。</p><h2 id="96a2" class="lb jr hi bd js lg lh li jw lj lk ll ka iq lm ln ke iu lo lp ki iy lq lr km ls bi translated"><code class="du kt ku kv kw b">KeyPointDetector.h</code></h2><p id="d547" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在<code class="du kt ku kv kw b">include</code>文件夹中，我们创建一个文件<code class="du kt ku kv kw b">KeyPointDetector.h</code>。这将是关键点检测器的头文件。</p><p id="83d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kt ku kv kw b">KeyPointDetector</code>将有两个公共方法。第一个是构造函数。我们将使用构造函数来初始化底层的 LBF 模型。</p><p id="0859" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二种方法<code class="du kt ku kv kw b">detect_key_points</code>检测图像中给定矩形内的人脸关键点。由于每个面的关键点都属于类型<code class="du kt ku kv kw b">std::vector&lt;cv::Point2f&gt;</code>，这个函数将返回一个矢量<code class="du kt ku kv kw b">std::vector&lt;cv::Point2f&gt;</code>。</p><p id="e6d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关键点检测器的头文件如下所示。</p><pre class="jf jg jh ji fd kx kw ky kz aw la bi"><span id="0577" class="lb jr hi kw b fi lc ld l le lf">#ifndef KEYPOINTDETECTOR_H <br/>#define KEYPOINTDETECTOR_H  <br/>#include &lt;opencv4/opencv2/face.hpp&gt;<br/>class KeyPointDetector { <br/>public:<br/>     /// Constructor<br/>     explicit KeyPointDetector();<br/>      /// Detect face key points within a rectangle inside an image     <br/>      /// \param face_rectangles Rectangles that contain faces<br/>     /// \param image Image in which we want to detect key points<br/>     /// \return List of face keypoints for each face rectangle<br/>     std::vector&lt;std::vector&lt;cv::Point2f&gt;&gt;<br/>     detect_key_points(const std::vector&lt;cv::Rect&gt; &amp;face_rectangles,<br/>                       const cv::Mat &amp;image) const;<br/>  private:<br/>     cv::Ptr&lt;cv::face::Facemark&gt; facemark_;<br/> };<br/>#endif //KEYPOINTDETECTOR_H</span></pre><h2 id="fd37" class="lb jr hi bd js lg lh li jw lj lk ll ka iq lm ln ke iu lo lp ki iy lq lr km ls bi translated"><code class="du kt ku kv kw b">KeyPointDetector.cpp</code></h2><p id="1cbe" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">接下来，我们在<code class="du kt ku kv kw b">src/KeyPointDetector.cpp</code>中实现这些方法。</p><p id="d7a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们来看看构造函数。我们创建了一个新的<code class="du kt ku kv kw b">cv::face::FacemarkLBF</code>模型。然后，我们从通过 CMake 传入的<code class="du kt ku kv kw b">KEY_POINT_DETECTION_MODEL</code>变量加载模型配置。</p><pre class="jf jg jh ji fd kx kw ky kz aw la bi"><span id="d1b7" class="lb jr hi kw b fi lc ld l le lf">KeyPointDetector::KeyPointDetector() {<br/>     facemark_ = cv::face::FacemarkLBF::create();<br/>     facemark_-&gt;loadModel(KEY_POINT_DETECTION_MODEL);<br/> }</span></pre><p id="16fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面，我们实现<code class="du kt ku kv kw b">detect_key_points</code>。</p><p id="61ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了遵守<code class="du kt ku kv kw b">cv::face::Facemark::fit()</code>的 API，我们将输入转换为<code class="du kt ku kv kw b">cv::InputArray</code>。然后我们调用 models <code class="du kt ku kv kw b">fit</code>函数，返回检测到的点。</p><pre class="jf jg jh ji fd kx kw ky kz aw la bi"><span id="66b4" class="lb jr hi kw b fi lc ld l le lf">std::vector&lt;std::vector&lt;cv::Point2f&gt;&gt;<br/> KeyPointDetector::detect_key_points(<br/>         const std::vector&lt;cv::Rect&gt; &amp;face_rectangles,<br/>          const cv::Mat &amp;image) const<br/>  {</span><span id="9523" class="lb jr hi kw b fi lt ld l le lf">      cv::InputArray faces_as_input_array(face_rectangles);<br/>     std::vector&lt;std::vector&lt;cv::Point2f&gt; &gt; key_points;<br/>     facemark_-&gt;fit(image,<br/>              faces_as_input_array,<br/>              key_points);<br/>      return key_points;<br/>  }</span></pre><h1 id="e87e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用关键点检测器</h1><p id="4f7a" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">现在我们跳到<code class="du kt ku kv kw b">main.cpp</code>来使用我们定义的关键点检测器。我们使用<a class="ae jd" href="https://bewagner.github.io/programming/2020/04/12/building-a-face-detector-with-opencv-in-cpp/" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中的人脸检测器。然后，我们将检测到的矩形提供给我们的关键点检测器。</p><pre class="jf jg jh ji fd kx kw ky kz aw la bi"><span id="5c5b" class="lb jr hi kw b fi lc ld l le lf">#include &lt;opencv4/opencv2/opencv.hpp&gt; <br/>#include "FaceDetector.h" <br/>#include "KeyPointDetector.h"  <br/>int main(int argc, char **argv) {<br/>      cv::VideoCapture video_capture;<br/>     if (!video_capture.open(0)) {<br/>         return 0;<br/>     }</span><span id="27c0" class="lb jr hi kw b fi lt ld l le lf">     FaceDetector face_detector;<br/>     KeyPointDetector keypoint_detector;</span><span id="da7b" class="lb jr hi kw b fi lt ld l le lf">     cv::Mat frame;<br/>     while (true) {<br/>         video_capture &gt;&gt; frame;<br/>         auto rectangles = face_detector<br/>                 .detect_face_rectangles(frame);<br/>          auto keypoint_faces = keypoint_detector<br/>                 .detect_key_points(rectangles, frame);</span></pre><p id="a1a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们显示检测到的点，而不是显示矩形。</p><pre class="jf jg jh ji fd kx kw ky kz aw la bi"><span id="8bd8" class="lb jr hi kw b fi lc ld l le lf">        const auto red = cv::Scalar(0, 0, 255);<br/>        for (const auto &amp;face :keypoint_faces) {<br/>            for (const cv::Point2f &amp;keypoint : face) {<br/>                cv::circle(frame, keypoint,<br/>                           8, red, -1);<br/>            }<br/>        }<br/><br/>        imshow("Image", frame);<br/>        const int esc_keycode = 27;<br/>        if (cv::waitKey(10) == esc_keycode) {<br/>            break;<br/>        }<br/>    }<br/>    cv::destroyAllWindows();<br/>    video_capture.release();<br/>    return 0;<br/>}</span></pre><p id="3bc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您应该会看到类似下图的结果。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/840e1695166ceeb6c0eb7717e078c3a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fJB7xm8o8h6qDmo8pWJBw.png"/></div></div></figure><h1 id="29b5" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="cb43" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在这篇文章中，我们使用了人脸检测模型来寻找图像中的人脸。然后我们使用 OpenCV 在这些图像中找到关键点。</p><p id="e07c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这能帮助你建立有趣的东西！这里有一个<a class="ae jd" href="https://github.com/bewagner/visuals/tree/blog-post-2" rel="noopener ugc nofollow" target="_blank">代码</a>的链接。如果你遇到任何错误，请告诉我！</p><p id="7bf2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 twitter 上关注我<a class="ae jd" href="https://twitter.com/bewagner_" rel="noopener ugc nofollow" target="_blank"> (@bewagner_) </a>了解更多关于 C++和机器学习的内容！</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="f9e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="mb">本帖原载于</em><a class="ae jd" href="https://bewagner.github.io/programming/2020/04/23/detecting-face-keypoints-with-opencv/" rel="noopener ugc nofollow" target="_blank"><em class="mb">https://be Wagner . github . io/programming/2020/04/23/detecting-face-key points-with-opencv/</em></a></p></div></div>    
</body>
</html>