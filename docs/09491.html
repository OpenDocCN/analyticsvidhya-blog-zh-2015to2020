<html>
<head>
<title>Ansible Tips and Tricks ( Part 3 )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可行的技巧和诀窍(第三部分)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/ansible-tips-and-tricks-part-3-66e44b77038a?source=collection_archive---------4-----------------------#2020-09-08">https://medium.com/analytics-vidhya/ansible-tips-and-tricks-part-3-66e44b77038a?source=collection_archive---------4-----------------------#2020-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="54e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">技巧3:提高执行性能的可行方法</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/17a6ff2b007ad501136dc535843e15b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGFfnUWd2Oedcgy3oekWuQ.png"/></div></div></figure><p id="9520" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们为什么需要这样做？</p><ol class=""><li id="ead4" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">提高可执行程序的速度。</li><li id="0d37" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">在更多节点上并行工作。</li><li id="f005" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">Ansible的快速重新运行。</li><li id="07f6" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated">减少Ansible Server中的混乱。</li></ol><p id="cabb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我分享一下我的默认ansible配置aka <a class="ae kd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/ansible.cfg" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> ansible.cfg </strong> </a>或者你可以从GitHub配置文件<a class="ae kd" href="https://github.com/116davinder" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">github.com/116davinder</strong></a>。</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="d4eb" class="kj kk hi kf b fi kl km l kn ko">[defaults]<br/>host_key_checking = False<br/>command_warnings = False<br/>forks = 100<br/>timeout = 30<br/>retry_files_enabled = False</span><span id="63f9" class="kj kk hi kf b fi kp km l kn ko">[ssh_connection]<br/>ssh_args=-C -o ControlMaster=auto -o ControlPersist=1200s -o BatchMode=yes<br/>pipelining=False<br/>control_path = /tmp/ansible-%%h-%%p-%%r<br/></span></pre></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><p id="a079" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kx translated"><span class="l ky kz la bm lb lc ld le lf di"> L </span>下面我们来说说上面的配置是如何工作的。</p><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="4f2e" class="kj kk hi kf b fi kl km l kn ko">host_key_checking = False</span></pre><p id="bc2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了这个答案，忽略SSH密钥验证步骤。它确实能在几毫秒内提高速度。</p><p id="cfda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Ref:</strong><a class="ae kd" href="https://docs.ansible.com/ansible/latest/user_guide/connection_details.html#host-key-checking" rel="noopener ugc nofollow" target="_blank">docs . ansi ble . com/ansi ble/connection _ details . html #主机密钥检查</a></p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="da39" class="kj kk hi kf b fi kl km l kn ko">forks = 100</span></pre><p id="5de3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Ansible中，forks默认为5。它允许一次并行播放。</p><p id="b891" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">假设，</strong> <br/>你有100台主机，forks = 5，每台主机的任务时间= 2秒</p><p id="80cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为Ansible在一批分叉中工作。<br/> <strong class="ih hj">批总数将为</strong> = 100/5 =20 <br/> <strong class="ih hj">每批总时间</strong> ~每台主机的任务时间(Ansible将在该批内的每台主机上并行运行)<br/> <strong class="ih hj">总执行时间将为</strong> = 20 * 2 = 40秒左右。</p><p id="b4c0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们将叉子增加到50个或100个<br/>，一切都是一样的，但总的批次数量要少得多。<br/> <strong class="ih hj">总批次数</strong> = 100/50 = 2 <br/> <strong class="ih hj">总执行时间将为</strong> = 2*2 = 4秒</p><blockquote class="lg lh li"><p id="43e9" class="if ig lj ih b ii ij ik il im in io ip lk ir is it ll iv iw ix lm iz ja jb jc hb bi translated">它将被<strong class="ih hj"> 10x </strong>助推50叉。<br/>将会是<strong class="ih hj"> 20x </strong>助推100叉。<br/>超过100个叉子就没用了，因为没有更多的主机了。</p></blockquote><p id="4eb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行50或100个分叉的代价是<br/> 1。Ansible上的高CPU使用率。<br/> 2。网络带宽利用率高。<br/> <strong class="ih hj">参考号:</strong><a class="ae kd" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html" rel="noopener ugc nofollow" target="_blank">docs.ansible.com/ansible/playbooks_strategies.html</a></p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="e248" class="kj kk hi kf b fi kl km l kn ko">command_warnings = False<br/>retry_files_enabled = False</span></pre><p id="9cdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为什么我也使用上面提到的配置，这些与速度优化没有关系，但是它们保持我的系统和ansible输出有点干净。<br/> <strong class="ih hj">参:</strong> <br/> 1。<a class="ae kd" href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#command-warnings" rel="noopener ugc nofollow" target="_blank">docs . ansi ble . com/reference _ appendencies/config . html # command-warnings</a><br/>2。<a class="ae kd" href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#retry-files-enabled" rel="noopener ugc nofollow" target="_blank">docs . ansi ble . com/reference _ appendencies/config . html # retry-files-enabled</a></p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="000c" class="kj kk hi kf b fi kl km l kn ko">ssh_args=-C -o ControlMaster=auto -o ControlPersist=1200s -o BatchMode=yes<br/>control_path = /tmp/ansible-%%h-%%p-%%r</span></pre><p id="31fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> SSH连接优化:</strong></p><ol class=""><li id="ca65" class="jp jq hi ih b ii ij im in iq jr iu js iy jt jc ju jv jw jx bi translated">使用<strong class="ih hj"> ControlPersist </strong>增加连接时间长度。</li><li id="ffe2" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated"><strong class="ih hj"> BatchMode </strong>(禁用基于SSH的交互提示)。</li><li id="d4ad" class="jp jq hi ih b ii jy im jz iq ka iu kb iy kc jc ju jv jw jx bi translated"><strong class="ih hj">控制路径</strong> SSH临时套接字路径并保持每个主机的唯一模式(ansible-%%h-%%p-%%r)，这将允许ansible在需要时共享连接，并在必要时重用。</li></ol><p id="e2f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Ref: </strong> <br/> 1。<a class="ae kd" href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing" rel="noopener ugc nofollow" target="_blank">https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing</a>T22】2。<a class="ae kd" href="https://www.techrepublic.com/article/how-to-use-multiplexing-to-speed-up-the-ssh/" rel="noopener ugc nofollow" target="_blank">https://www . techrepublic . com/article/how-to-use-multiplexing-to-speed-up-the-ssh/</a><br/>3 .<a class="ae kd" href="https://linux.die.net/man/5/ssh_config" rel="noopener ugc nofollow" target="_blank">https://linux.die.net/man/5/ssh_config</a>(batch mode)<br/>4。<a class="ae kd" href="https://docs.ansible.com/ansible/latest/plugins/connection/ssh.html#parameter-control_path" rel="noopener ugc nofollow" target="_blank">docs . ansi ble . com/plugins/connection/ssh . html # parameter-control _ path</a></p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><pre class="je jf jg jh fd ke kf kg kh aw ki bi"><span id="1d0b" class="kj kk hi kf b fi kl km l kn ko">pipelining=False</span></pre><p id="5e25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应该禁用它，因为它与become冲突，并且要求您在目标服务器上禁用“requiretty”。</p><p id="578b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Ref: </strong> <br/> 1。<a class="ae kd" href="https://docs.ansible.com/ansible/latest/plugins/connection/ssh.html#parameter-pipelining" rel="noopener ugc nofollow" target="_blank">docs . ansi ble . com/plugins/connection/ssh . html #参数管道</a></p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><p id="c822" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述配置可以在可行的执行中节省大量时间。请记住，上述配置可以在一定程度上节省您的时间，您必须将您的剧本/角色设计为最佳性能。</p><p id="9a4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果不需要，不要使用“串行”模式或<a class="ae kd" href="https://docs.ansible.com/ansible/latest/plugins/strategy/linear.html#linear-strategy" rel="noopener ugc nofollow" target="_blank">线性策略</a>。</p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><p id="33ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望它能节省你的时间。快乐编码又名Ansible编码。</p></div></div>    
</body>
</html>