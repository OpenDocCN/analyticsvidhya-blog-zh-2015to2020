<html>
<head>
<title>Memory mapping files and mmap module in python(with a lot of examples)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">python中的内存映射文件和mmap模块(有很多例子)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/memory-mapping-files-and-mmap-module-in-python-with-lot-of-examples-d1a9a45fe9a3?source=collection_archive---------6-----------------------#2020-08-03">https://medium.com/analytics-vidhya/memory-mapping-files-and-mmap-module-in-python-with-lot-of-examples-d1a9a45fe9a3?source=collection_archive---------6-----------------------#2020-08-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/61d930832930c182568c50f3643e6487.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v9AmbofgxS6W9GZg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">由<a class="ae iu" href="https://unsplash.com/@kotecinho?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kote Puerto </a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="ae6b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">定义:</em> </strong>内存映射文件对象将普通文件对象映射到内存中。这允许我们直接在内存中修改文件对象的内容。</p><ol class=""><li id="995d" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">内存映射文件对象的行为类似于<code class="du kd ke kf kg b">bytearray</code>和<code class="du kd ke kf kg b">file objects</code>。因此所有可以在<code class="du kd ke kf kg b">bytearray</code>上执行的操作，如索引、切片、分配切片或使用<code class="du kd ke kf kg b">re</code>模块搜索文件。</li><li id="7551" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">以及可以在文件对象上执行的所有操作，如从当前位置开始读写数据。或者使用<code class="du kd ke kf kg b">seek()</code>将当前指针定位到不同的位置。</li></ol><h2 id="60b8" class="km kn hi bd ko kp kq kr ks kt ku kv kw jg kx ky kz jk la lb lc jo ld le lf lg bi translated">内存映射文件对象</h2><p id="9a17" class="pw-post-body-paragraph iv iw hi ix b iy lh ja jb jc li je jf jg lj ji jj jk lk jm jn jo ll jq jr js hb bi translated">对于基于Unix和Windows的系统，内存映射文件对象是不同的。我将讨论Windows版本。</p><p id="a60d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kd ke kf kg b"><strong class="ix hj"><em class="jt">class </em>mmap.mmap(<em class="jt">fileno</em>, <em class="jt">length</em>, <em class="jt">tagname=None</em>, <em class="jt">access=ACCESS_DEFAULT</em>[, <em class="jt">offset</em>])</strong></code></p><p id="5770" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt"> fileno: </em> </strong>从文件句柄(Unix中的文件描述符)<code class="du kd ke kf kg b">fileno</code>指定的文件中映射<code class="du kd ke kf kg b">length</code>字节。并创建一个mmap对象。</p><blockquote class="lm ln lo"><p id="3e4e" class="iv iw jt ix b iy iz ja jb jc jd je jf lp jh ji jj lq jl jm jn lr jp jq jr js hb bi translated"><code class="du kd ke kf kg b"><em class="hi">file</em>.fileno()</code>:以数字形式返回流的文件描述符</p><p id="dc31" class="iv iw jt ix b iy iz ja jb jc jd je jf lp jh ji jj lq jl jm jn lr jp jq jr js hb bi translated">文件句柄(Unix中的文件描述符)是在计算机操作系统中唯一标识打开文件的数字。它描述了数据资源，以及如何访问该资源。</p></blockquote><p id="2524" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果长度大于文件的当前大小，文件将被扩展为包含字节的长度。如果长度为零，则映射的最大长度是文件的当前大小。</p><p id="5a35" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了映射匿名内存，应该将-1作为fileno和长度一起传递。</p><p id="082c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> <em class="jt">标记名:</em> </strong>如果被指定，而不是<code class="du kd ke kf kg b">None</code>，则是一个字符串，给出映射的标记名。如果省略参数或<code class="du kd ke kf kg b">None</code>，则创建的映射没有任何名称。</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="dd40" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">理解<code class="du kd ke kf kg b">ACCESS_READ</code>、<code class="du kd ke kf kg b">ACCESS_WRITE</code>、<code class="du kd ke kf kg b">ACCESS_COPY</code></p><p id="4d25" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kd ke kf kg b">ACCESS_READ</code>:只读。</p><p id="aa52" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kd ke kf kg b">ACCESS_WRITE</code>:直写，影响内存和底层文件</p><p id="8190" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kd ke kf kg b">ACCESS_COPY</code>:写入时复制内存，仅影响内存，不影响底层文件。</p><p id="5440" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">示例:</p><p id="52d1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">访问读取和访问写入以及访问复制。</p><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><figure class="ls lt lu lv fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/7d5c9f713b05916b2c07ad691bf109ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a8QpW4Wv_VVXpsIdTVXYUw.png"/></div></div></figure><p id="8ac3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们知道了mmap模块是如何工作的，现在让我们将它与普通文件进行比较。</p><ol class=""><li id="5eab" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">假设有一个大于15MB的二进制文件(在本例中是20MB的pdf文件),我们正在像这样处理这个文件的内容。</li><li id="cf33" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">从当前位置查找64个字节并处理该位置的数据。(简单地说，我们从开始移动64个字节，并将指针放在那个位置)</li><li id="61dd" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">从当前位置开始寻找-32字节并处理该位置的数据。(简单地说，我们向后移动32个字节，并将指针放在那个点上)</li><li id="69e6" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">这个过程持续进行，直到处理的数据大于10MB。</li></ol><figure class="ls lt lu lv fd ij"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="c37a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用内存映射比普通文件快13倍。</p><p id="2293" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建存储器映射的实用函数</p><pre class="ls lt lu lv fd lz kg ma mb aw mc bi"><span id="4566" class="km kn hi kg b fi md me l mf mg">import os<br/>import mmap<br/>def memory_map(filename,access = mmap.ACCESS_WRITE):<br/>    size = os.path.getsize(filename)<br/>    # the os.open() method returns a file descriptor for the newly opened file<br/>    file_descriptor = os.open(filename,os.O_RDWR) <br/>    return mmap.mmap(file_descriptor,size,access = access)</span></pre><p id="5888" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">结论:</p><ol class=""><li id="c29f" class="ju jv hi ix b iy iz jc jd jg jw jk jx jo jy js jz ka kb kc bi translated">使用mmap将文件映射到内存是随机访问文件内容的一种高效而优雅的方式。</li><li id="87b2" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">我们可以简单地映射文件并使用切片操作访问文件，而不是打开一个文件并执行各种组合的<code class="du kd ke kf kg b">seek()</code>、<code class="du kd ke kf kg b">read()</code>和<code class="du kd ke kf kg b"> write()</code>调用。</li><li id="de4e" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">应该注意，对文件进行内存映射不会导致整个文件被读入内存缓冲区。相反，操作系统会为文件内容保留一部分虚拟内存。(如果文件的某些部分从未被访问过，它们会保留在磁盘上)。</li><li id="b8de" class="ju jv hi ix b iy kh jc ki jg kj jk kk jo kl js jz ka kb kc bi translated">如果不止一个python解释器内存映射同一个文件，那么产生的mmap对象可以用来在解释器之间交换数据。</li></ol><p id="bd7d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><div class="mh mi ez fb mj mk"><a href="https://docs.python.org/3/library/mmap.html" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">mmap -内存映射文件支持- Python 3.8.5文档</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">内存映射文件对象的行为类似于和文件对象。你可以在大多数地方使用mmap对象…</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">docs.python.org</p></div></div></div></a></div><div class="mh mi ez fb mj mk"><a href="https://pymotw.com/3/mmap/" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">mmap -内存-映射文件- PyMOTW 3</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">目的:内存映射文件，而不是直接读取内容。内存映射文件使用操作系统…</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">pymotw.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my io mk"/></div></div></a></div><div class="mh mi ez fb mj mk"><a href="https://www.pythoncentral.io/memory-mapped-mmap-file-support-in-python/" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">Python | Python Central中的内存映射(mmap)文件支持</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">从Python的官方文档中，一定要检查Python的mmap模块:内存映射文件对象的行为…</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">www.pythoncentral.io</p></div></div><div class="mt l"><div class="mz l mv mw mx mt my io mk"/></div></div></a></div><div class="mh mi ez fb mj mk"><a href="https://www.oreilly.com/library/view/python-cookbook-3rd/9781449357337/" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hj fi z dy mp ea eb mq ed ef hh bi translated">Python食谱，第三版</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">如果你需要用Python 3写程序的帮助，或者想更新旧的Python 2代码，这本书正好合适。</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">www.oreilly.com</p></div></div><div class="mt l"><div class="na l mv mw mx mt my io mk"/></div></div></a></div></div></div>    
</body>
</html>