<html>
<head>
<title>Asynchronous Python Programming</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">异步 Python 编程</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/asynchronous-python-programming-facb6e80a729?source=collection_archive---------17-----------------------#2020-10-21">https://medium.com/analytics-vidhya/asynchronous-python-programming-facb6e80a729?source=collection_archive---------17-----------------------#2020-10-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0a48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天，我将向你们展示一些不同的东西。我仍然试图在几乎每一个合适的主题上使用这个主题，并因此掌握它的是使用 Python 的异步编程。</p><p id="bf38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的公司里，我们管理着 195 个读写 Oracle 数据库(以及它们的本地和远程备用数据库),在某些情况下，我们必须查询每一个数据库。当然，我们已经安排了任务来整合监控数据库中的数据。然而，我们的库存不足以满足我们和/或我们客户的需求。</p><p id="d561" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以从所有数据库中连续收集数据，也可以同时从所有数据库中收集数据。</p><p id="5440" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了比较公平，我将使用 Python 来测量串行处理时间。</p><p id="ad67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一看，</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="6200" class="jm jn hi ji b fi jo jp l jq jr">import time<br/>import cx_Oracle<br/>import concurrent.futures</span><span id="8488" class="jm jn hi ji b fi js jp l jq jr">t1 = time.perf_counter()</span><span id="aced" class="jm jn hi ji b fi js jp l jq jr">query= f"""select distinct db_name, tns_host, tns_port, tns_service from inv_schema.inv_table"""]</span><span id="0881" class="jm jn hi ji b fi js jp l jq jr">mapdsn = cx_Oracle.makedsn('inv_db_dns', 'inv_db_port',service_name='inv_db_service')<br/>con1 = cx_Oracle.connect("inv_db_user", "inv_db_passwd", mapdsn, encoding="UTF-8")<br/>cursor1 = con1.cursor()<br/>cursor1.execute(query)</span><span id="5e3d" class="jm jn hi ji b fi js jp l jq jr">strmappeddsn = [(element[0], f"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST={element[1]})(PORT={element[2]}))(CONNECT_DATA=(SERVICE_NAME={element[3]})))") for element in cursor1.fetchall()]</span><span id="f0f2" class="jm jn hi ji b fi js jp l jq jr">def connect_and_execute(dsn): <br/>    querylist = ["""select count(*) from dba_role_privs"""]<br/>    try:<br/>        con = cx_Oracle.connect("inv_db_user", "inv_db_passwd", dsn[1], encoding="UTF-8")<br/>        if not con: return<br/>        else:<br/>            cursor = con.cursor()<br/>            x = []<br/>            for query in querylist:<br/>                cursor.execute(query)<br/>                try:<br/>                    x.append(cursor.fetchall())<br/>                except Exception as e:<br/>                    pass<br/>                con.close()<br/>            print (str(dsn[0]), str(x))<br/><br/>    except Exception as e:<br/>        print(str(dsn[0]) + "\t" + str(e))<br/>        pass</span><span id="a432" class="jm jn hi ji b fi js jp l jq jr">t2 = time.perf_counter()<br/><br/>for x in strmappeddsn:<br/>    connect_and_execute(x)<br/><br/>t3 = time.perf_counter()<br/><br/>print(t2-t1)<br/>print(t3-t2)</span></pre><p id="e960" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如下所示，对于 195 个数据库，仅串行处理时间(t3 — t2)就花费了大约 100.5 秒。</p><figure class="jd je jf jg fd ju er es paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="er es jt"><img src="../Images/0b767ac9f6258e695a0927b6a6cb66bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FnP4s-5Ktd80Al2nGOrqYQ.png"/></div></div></figure><p id="7f30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="adeb" class="jm jn hi ji b fi jo jp l jq jr">import time<br/>import cx_Oracle<br/>import concurrent.futures</span><span id="8812" class="jm jn hi ji b fi js jp l jq jr">t1 = time.perf_counter()</span><span id="549c" class="jm jn hi ji b fi js jp l jq jr">query= f"""select distinct db_name, tns_host, tns_port, tns_service from inv_schema.inv_table"""]</span><span id="0caf" class="jm jn hi ji b fi js jp l jq jr">mapdsn = cx_Oracle.makedsn('inv_db_dns', 'inv_db_port',service_name='inv_db_service')<br/>con1 = cx_Oracle.connect("inv_db_user", "inv_db_passwd", mapdsn, encoding="UTF-8")<br/>cursor1 = con1.cursor()<br/>cursor1.execute(query)</span><span id="5758" class="jm jn hi ji b fi js jp l jq jr">strmappeddsn = [(element[0], f"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST={element[1]})(PORT={element[2]}))(CONNECT_DATA=(SERVICE_NAME={element[3]})))") for element in cursor1.fetchall()]</span><span id="ee54" class="jm jn hi ji b fi js jp l jq jr">def connect_and_execute(dsn): <br/>    querylist = ["""select count(*) from dba_role_privs"""]<br/>    try:<br/>        con = cx_Oracle.connect("inv_db_user", "inv_db_passwd", dsn[1], encoding="UTF-8")<br/>        if not con: return<br/>        else:<br/>            cursor = con.cursor()<br/>            x = []<br/>            for query in querylist:<br/>                cursor.execute(query)<br/>                try:<br/>                    x.append(cursor.fetchall())<br/>                except Exception as e:<br/>                    pass<br/>                con.close()<br/>            <strong class="ji hj">return (str(dsn[0]), str(x))</strong><br/><br/>    except Exception as e:<br/>        print(str(dsn[0]) + "\t" + str(e))<br/>        pass</span><span id="4929" class="jm jn hi ji b fi js jp l jq jr">t2 = time.perf_counter()<br/><br/>with concurrent.futures.ThreadPoolExecutor() as executor:<br/>        results = executor.map(connect_and_execute, strmappeddsn)<br/>        for result in results: <br/>            output.append(result)</span><span id="8d11" class="jm jn hi ji b fi js jp l jq jr">t3 = time.perf_counter()</span><span id="5510" class="jm jn hi ji b fi js jp l jq jr">[print(_) for _ in output]<br/>print(t2-t1)<br/>print(t3-t2)</span></pre><p id="db23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这两个 Python 脚本中，我都使用了相同的函数来连接 Oracle 数据库和执行 SQL，唯一不同的是，在异步版本中，我返回了 SQL 的输出，而不是 print。</p><p id="b77b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于异步编程，我使用并发库。根据<a class="ae kb" href="https://docs.python.org/3/library/concurrent.futures.html" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3/library/concurrent.futures.html</a>，在创建一个执行器后我们可以使用<strong class="ih hj">映射</strong>函数来调用异步调用。此映射函数与内置映射函数的不同之处在于:</p><ul class=""><li id="eada" class="kc kd hi ih b ii ij im in iq ke iu kf iy kg jc kh ki kj kk bi translated">这些<em class="kl">可重复项</em>被立即收集，而不是被懒洋洋地收集。</li><li id="d925" class="kc kd hi ih b ii km im kn iq ko iu kp iy kq jc kh ki kj kk bi translated"><em class="kl"> func </em>是异步执行的，可以同时调用几次<em class="kl"> func </em>。</li></ul><p id="e9a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，在 Python 3 . 7 . 1 版的官方 Python 文档中，默认的最大工作线程数(最大工作线程数的计算从 Python 3.5 版到 3.8 版一直没有改变)是“<strong class="ih hj">机器上的处理器数乘以 5 </strong>”。所以，</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="3ae7" class="jm jn hi ji b fi jo jp l jq jr">&gt;&gt;&gt; import os<br/>&gt;&gt;&gt; print(os.cpu_count())<br/>8<br/>&gt;&gt;&gt;</span></pre><p id="2c44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的最大工人数是 40。</p><p id="ae71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好吧，但是，结果呢？我不会再引起好奇心了。对于 195 个数据库，时间大约为 3.68 秒。</p><figure class="jd je jf jg fd ju er es paragraph-image"><div class="er es kr"><img src="../Images/813feda4d13edad3ea01ae3a873f948d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*BKmg3kEdkScbAdpH2kP0Jw.png"/></div></figure><p id="6799" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">100,4983596 / 3,6819677 = 27,2947398750945</p><p id="0451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大约好 26 倍:)。很酷，是吧？</p><p id="b119" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在接下来的故事中，我将尝试优化最大工作人员数量，并突破 Oracle 数据库云服务器的极限。</p><p id="8a70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读！</p><p id="ade9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">乌穆特·泰京</p></div></div>    
</body>
</html>