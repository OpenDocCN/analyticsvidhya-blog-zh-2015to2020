# ç”¨å¼ é‡æµå˜æ¢(TFX)é¢„å¤„ç†ç¾é£Ÿæ¨èç³»ç»Ÿçš„æ•°æ®â€”ç¬¬ 1 éƒ¨åˆ†

> åŸæ–‡ï¼š<https://medium.com/analytics-vidhya/preprocessing-data-for-a-great-food-recommendation-system-with-tensorflow-transform-tfx-part-1-3ded62184222?source=collection_archive---------12----------------------->

## å±•ç¤ºæˆ‘å…³äº Tensorflow æ‰©å±•ç”¨ä¾‹çš„æ–°é¡¹ç›®ï¼Œå…¶ä¸­åŒ…å«æ¥è‡ªé£Ÿå“é¢†åŸŸçš„â€œå¤§æ•°æ®â€å’Œå®Œæ•´çš„ä»£ç å®¡æŸ¥ã€‚ä¸‹ä¸€éƒ¨åˆ†å°†æ˜¯å…³äº Tensorflow æ’åçš„ä½¿ç”¨ã€‚

![](img/84d0a45dbebbe6d2d202be5352f4ac15.png)

æˆ‘ä»Šå¤©åº”è¯¥åƒä»€ä¹ˆï¼Ÿè¿™æ˜¯æˆ‘çš„é¡¹ç›®æ‰€åŸºäºçš„é—®é¢˜ã€‚ä½†é¦–å…ˆè®©æˆ‘è‡ªæˆ‘ä»‹ç»:
æˆ‘æ˜¯ä¸€åå¹´è½»çš„åŒ»å­¦é¢†åŸŸçš„è®¡ç®—æœºç§‘å­¦å­¦ç”Ÿï¼Œä½†æœ€è¿‘æˆ‘æœ‰äº†ç”¨ AI ç®€åŒ–å’Œå‡å°‘æˆ‘çš„ä¸€äº›ç”Ÿæ´»é€‰æ‹©çš„æƒ³æ³•ã€‚è¿™å°±æ˜¯æˆ‘å¶ç„¶å‘ç° Tensorflow Transform (TFT)ç¤¾åŒºçš„åŸå› ï¼Œå› ä¸ºåšå‡ºå¥½çš„ç”Ÿæ´»å†³ç­–éœ€è¦å¤§é‡çš„æ•°æ®å’Œæ•°æ®å¤„ç†â€”â€”ç›¸ä¿¡æˆ‘ï¼›)

**æ•°æ®**

[æˆ‘ä» kaggle](https://www.kaggle.com/shuyangli94/food-com-recipes-and-user-interactions?select=RAW_interactions.csv) é‚£é‡Œå¾—åˆ°äº†æˆ‘çš„æ•°æ®ã€‚è€ƒè™‘åˆ°æˆ‘å¸Œæœ›ä»ç”¨æˆ·é‚£é‡Œå¾—åˆ°çš„è¾“å…¥ï¼Œæˆ‘ç”¨ pandas æ‰§è¡Œäº†ä¸€äº›ç®€å•çš„é¢„å¤„ç†ä»»åŠ¡ã€‚è¿™å°±æ˜¯æˆ‘æ‰€åšçš„:

1.  é¦–å…ˆï¼Œæˆ‘ç»„åˆäº†ä¸¤ä¸ªæ•°æ®æ¡†æ¶(RAW_recipes å’Œ RAW_interaction)
2.  æˆ‘ç”¨ç›¸åŒçš„ç”¨æˆ· id å¯¹ç”¨æˆ·å’Œä»–ä»¬çš„é£Ÿç‰©è¯„çº§è¿›è¡Œäº†åˆ†ç»„ã€‚
3.  æˆ‘å¢åŠ äº†å¾ˆå¤šæ–°æ ç›®(æ•°æ®å¤šæ€»æ˜¯å¥½çš„ï¼)ä½¿ç”¨ç¼–è¾‘å™¨(ä»»ä½•å…·æœ‰æœç´¢å’Œæ›¿æ¢é€‰é¡¹çš„ç¼–è¾‘å™¨éƒ½å¯ä»¥å·¥ä½œ)ã€‚ä¾‹å¦‚ï¼Œæˆ‘æ·»åŠ äº† pH å€¼å¹³å‡å€¼ã€ç³–åˆ†å¹³å‡å€¼å’Œé²œå‘³å¹³å‡å€¼ï¼Œè¿™æ˜¯æˆ‘ä»é£Ÿè°±ä¸­ç‰¹å®šæˆåˆ†çš„æµè¡Œç¨‹åº¦å¾—åˆ°çš„ã€‚
4.  æˆ‘åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ dataframeï¼Œå…¶ä¸­å­˜å‚¨äº†ç›¸åº”çš„ç‰¹å®šäºç”¨æˆ·çš„å€¼(å¯¹äºä¸Šä¸‹æ–‡ï¼Œæˆ‘å°†åœ¨ç¬¬ 2 éƒ¨åˆ†ä¸­ä½¿ç”¨)ã€‚æŠŠå®ƒæ”¾åœ¨ä¸€è¾¹ï¼Œä½ ä»¥åä¼šéœ€è¦å®ƒçš„ã€‚

**é¡¹ç›®çš„å¼€å§‹:**

é¦–å…ˆæˆ‘å®‰è£…ä¾èµ–é¡¹ï¼Œæœ‰å¾ˆå¤šã€‚

ç„¶åï¼Œæˆ‘è®¾ç½®äº†æˆ‘æƒ³è¦ä½¿ç”¨çš„ç›®å½•ï¼Œå¹¶ç›´æ¥ä» Google Drive ä¸‹è½½äº†æˆ‘çš„æ•°æ®é›†(è¿™æ˜¯æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºæ¯æ¬¡ä¸Šä¼ æ•°æ®é›†éƒ½ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ã€‚å¦‚æœä½ çš„ Google Drive æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œé‚£ä¹ˆä½ è¿˜å¯ä»¥å‹ç¼©å’Œï¼è§£å‹æ•°æ®)ã€‚

æˆ‘åªç²˜è´´äº†ä¸€ä¸ªæˆªå›¾çš„éƒ¨åˆ†æ˜¯æˆ‘ä» awesome TFT å›¢é˜Ÿçš„[å®˜æ–¹ç¤ºä¾‹ colab](https://colab.research.google.com/github/tensorflow/tfx/blob/master/docs/tutorials/transform/census.ipynb) (colab è®©ä½ å…è´¹åœ¨äº‘ä¸­æ‰§è¡Œä»£ç (æ—¥æœŸ:06.11.2020))è·å¾—çš„éƒ¨åˆ†ã€‚æ‰€ä»¥ä¸€å®šè¦å…ˆçœ‹çœ‹è¿™ä¸ªæ•™ç¨‹ã€‚

![](img/33e8ae9d36b0dcc73f74279488d8c8c5.png)

æ­£å¦‚æˆ‘æåŠ›æ¨èçš„ TFX çš„æ–‡æ¡£ä¸­æ‰€å±•ç¤ºçš„ï¼Œæˆ‘ä½¿ç”¨äº† example_gen_pb2ã€‚Input.Splitï¼Œå› ä¸ºæˆ‘ä¹‹å‰å·²ç»ç”¨ pandas æ‹†åˆ†äº†æ•°æ®ã€‚æ‰€ä»¥è¿™åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰è¾“å…¥ã€‚

```
context = InteractiveContext()examples = external_input(_data_root)input = example_gen_pb2.Input(splits=[
example_gen_pb2.Input.Split(name='train', pattern='Train.csv'),
example_gen_pb2.Input.Split(name='eval', pattern='Test.csv')
])example_gen = CsvExampleGen(input=examples, input_config=input)context.run(example_gen)
```

è¿™æ˜¯ä¸€ä¸ªå¼ é‡æµçš„ä¾‹å­åœ¨ TFRecord ä¸­çš„æ ·å­ã€‚å®ƒçš„æ ¼å¼ä¸å¤ªå¥½ï¼Œä½†æ˜¯ä½ åº”è¯¥èƒ½å¤Ÿå¯¹ä¸€ä¸ªä¾‹å­æœ‰åŸºæœ¬çš„äº†è§£ã€‚

> features { key:"å¡è·¯é‡Œ"å€¼{ float _ list { value:198.8000030517578 } } } feature { key:" carbs "å€¼{ float _ list { value:12.0 } } } feature { key:" contrib id "å€¼{ int64_list { value:000000 } } } feature { key:" date "å€¼{ bytes _ list { value:" 2002â€“06â€“02 " } } } feature { key:" ea Erica "å€¼{ int 64 _ list feature { key:" fat " value { float _ list { value:5.0 } } } feature { key:" id " value { int 64 _ list { value:27547 } } } feature { key:" index " value { int 64 _ list { value:00000 } } } feature { key:" ingredients " value { bytes _ list { value:"[\ 'é•¿ç²’ç™½ç±³é¥­\ 'ã€\'orzo æ„å¤§åˆ©é¢\ 'ã€\ 'é»„æ²¹\ 'ã€\ 'è’œç²‰\ 'ã€\ 'å§œé»„\ 'ã€\ 'å¹²æ´‹è‘±ç‰‡\ ' \'romano cheese\']" } } }åŠŸèƒ½{ key: "minutes "å€¼{ int64_list { value: 30 } } }åŠŸèƒ½{ key: "nAMERICA "å€¼{ int64_list { value: 0 } } }åŠŸèƒ½{ key: "nINGREDIENTS "å€¼{ int64_list { value: 10 } } }åŠŸèƒ½{ key: "nSTEPS "å€¼{ int64_list { value: 9 } } }åŠŸèƒ½{ key: "name "å€¼{ bytes _ list { value:" golden rice orzo " } } åŠŸèƒ½{ key:"è›‹ç™½è´¨"å€¼{ float_list { value: 9.0 } } }åŠŸèƒ½{ key: "rating "å€¼{ int64_list { value: 5 } } }åŠŸèƒ½{ key: "recipe_id "å€¼{ int64_list { value: 27547 } } }åŠŸèƒ½{ key: "sAMERICA "å€¼{ int64_list { value: 0 } } }åŠŸèƒ½{ key: "saturatedfat "å€¼{ float_list { value: 9.0 } } }åŠŸèƒ½{ key:"é’ "å€¼{ float_list { value: 1.0 feature { key:" submitted " value { bytes _ list { value:" 2002â€“05â€“07 " } } } feature { key:" sugar " value { float _ list { value:6.0 } } } feature { key:" tags " value { bytes _ list { value:"[\ ' 30 åˆ†é’Ÿæˆ–æ›´å°‘\ 'ï¼Œ\ 'åˆ¶ä½œæ—¶é—´\ 'ï¼Œ\ 'è¿‡ç¨‹\ 'ï¼Œ\ 'ä¸»æ–™\ 'ï¼Œ\ 'å‡†å¤‡\ 'ï¼Œ\ 'åœºåˆ\ 'ï¼Œ\ 'å¥åº·\ 'ï¼Œ\ 'é…èœ\ 'ï¼Œ\ ' \'to-go\']" } } }åŠŸèƒ½{ key:" user _ id " value { int 64 _ list { value:0000 } } }åŠŸèƒ½{ key:" vegeterian " value { int 64 _ list { value:0 } } }åŠŸèƒ½{ key:" wa merica " value { int 64 _ list { value:0 } } }

æ‰€ä»¥ï¼Œç°åœ¨æœ‰ç‚¹*æ•°æ®åˆ†æå’Œæ¢ç´¢*ã€‚

é¦–å…ˆï¼Œæ‚¨å¯ä»¥æ‰§è¡Œè¿™æ®µä»£ç æ¥è¿›ä¸€æ­¥ç†è§£å’Œç»Ÿè®¡æ‚¨çš„æ•°æ®ã€‚å®ƒè¿˜å‘æ‚¨å±•ç¤ºäº†æ•°æ®ç±»å‹ï¼Œè¿™å¯¹ä»¥åä¼šå¾ˆæœ‰ç”¨ã€‚

```
statistics_gen = StatisticsGen(
examples=example_gen.outputs['examples'])context.run(statistics_gen)%%skip_for_exportcontext.show(statistics_gen.outputs['statistics'])
```

æ‚¨å¯ä»¥çœ‹åˆ°ç©ºå€¼çš„ç™¾åˆ†æ¯”ï¼Œå®ƒè¢«æ ‡è®°ä¸ºçº¢è‰²ï¼Œä½†æ˜¯åœ¨æˆ‘çš„ç¤ºä¾‹ä¸­æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªçƒ­ç¼–ç åˆ—ã€‚è¿˜æœ‰ä¸€äº›ç»Ÿè®¡æ•°æ®ï¼Œæˆ‘ä¸ä¼šæ·±å…¥æ¢è®¨ã€‚

![](img/c83db6391411481bc967e11265b1c005.png)

ç»Ÿè®¡ç»“æœæ‘˜è¦

å…¶æ¬¡ï¼Œæ‚¨éœ€è¦è·å¾—ä¸€ä¸ªæ¨¡å¼ã€‚æˆ‘å°±ä¸å ç”¨ä½ çš„æ—¶é—´ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥äº†ã€‚

```
schema_gen = SchemaGen(statistics=statistics_gen.outputs['statistics'],
infer_feature_shape=False)context.run(schema_gen)
```

**è½¬æ¢æ•°æ®** 
æœ‰è¶£çš„éƒ¨åˆ†æ¥äº†ï¼Œä½ å¯ä»¥åœ¨æ•°æ®çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ä»¥ä½ æƒ³è¦çš„æ–¹å¼é¢„å¤„ç†æ•°æ®ã€‚æˆ‘æ˜¯å¦å·²ç»è¯´è¿‡è¿™æ˜¯ Apache Beam å…¼å®¹çš„ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥åœ¨å®é™…å·¥ä½œçš„ç®¡é“ä¸­å®ç°å®ƒï¼Ÿ

åˆ†ç±»ç‰¹å¾ä¿æŒä¸å˜ï¼Œæ¡¶ç‰¹å¾æœ‰åºåœ°æ”¾å…¥ 10 ä¸ªæ¡¶ä¸­çš„ä¸€ä¸ªã€‚è¯æ±‡ç‰¹å¾ï¼Œä¸»è¦æ˜¯æˆåˆ†ï¼Œè¢«ç»„ç»‡æˆ 1500 ä¸ªå­¦ä¹ æ¡¶ä¸­çš„ä¸€ä¸ª(è¿™éœ€è¦å¾ˆé•¿æ—¶é—´)ã€‚å¯†é›†æµ®åŠ¨è¦ç´ æ ¹æ®å…¶æµè¡Œç¨‹åº¦å’Œç»Ÿè®¡æ•°æ®è¿›è¡Œæ’åºã€‚å¯¹æˆ‘æ¥è¯´ï¼Œä¸€ç§æ–°é¢–çš„æ–¹æ³•æ˜¯ç”¨è®¡ç®—å‡ºçš„æ•£åˆ—å­—ç¬¦ä¸²æ¥ç»„ç»‡æ—¥æœŸç‰¹å¾(ä¾‹å¦‚ 2002â€“05â€“07 ),è¿™ç§æ–¹æ³•å¾ˆé€‚åˆè¿™ç§è‡ªç„¶æ ‡å‡†åŒ–çš„æ•°æ®ï¼

ç°åœ¨è¿™å°†è½¬æ¢æ•°æ®å¹¶ç»™å‡ºä¸€ä¸ª TFRecord(å¦‚æœæ‚¨æƒ³ä½¿ç”¨ Apache Beamï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–å‡½æ•°):

```
transform = Transform(examples=example_gen.outputs['examples'],
schema=schema_gen.outputs['schema'],
module_file=os.path.abspath(_food_transform_module_file),
instance_name="food")context.run(transform)
```

å¦‚æœæ‚¨ç°åœ¨æƒ³ç”¨ TfRecord-Dataset(æˆ‘åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­æè¿°è¿‡)ä¸­é™„åŠ çš„ç‰¹å®šäºç”¨æˆ·çš„æ•°æ®(åä¸º context)å°†å®ƒ(è¿™äº›æ˜¯ç¤ºä¾‹æˆ–æŸ¥è¯¢)è½¬æ¢æˆ **ELWC** æ ¼å¼ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥è¿™æ ·åš:

## å®ƒå·¥ä½œé•¿åº¦å¯å˜ï¼Œå› æ­¤æ‚¨ä¸ä¼šå—é™äºå›ºå®šå¤§å°çš„æŸ¥è¯¢ã€‚

åªéœ€åˆ›å»ºä¸€ä¸ªé¢å¤–çš„ csvï¼ŒæŒ‰ç…§æ‚¨å¤„ç†æ•°æ®çš„ user_id çš„é¡ºåºï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ 100 ä¸ªå…·æœ‰ç›¸åŒ user _ id çš„æŸ¥è¯¢ï¼Œå…¶ä¸­æ¯æ¬¡éƒ½å­˜åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ä½¿ç”¨ tf.unique_with_counts(data)å¹¶è·å¾—å¼ é‡[100ï¼Œâ€¦].

ç„¶åè¿˜æœ‰ä¸€ä¸ª dataset2ï¼Œä¸€ä¸ª TfRecordDatasetï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»èµ°åˆ°äº†å°½å¤´ã€‚æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ª ELWC-TFRecordï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬ 2 éƒ¨åˆ†ä¸­ä½¿ç”¨å®ƒæ¥å¯¹é£Ÿç‰©è¿›è¡Œæ’åºã€‚

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ğŸ‘ğŸ½ã€‚