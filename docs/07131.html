<html>
<head>
<title>From Infrastructure as Code to Infrastructure is Code with AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从基础设施作为代码到基础设施是AWS CDK的代码</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/from-infrastructure-as-code-to-infrastructure-is-code-with-aws-cdk-6f942af4eb87?source=collection_archive---------24-----------------------#2020-06-14">https://medium.com/analytics-vidhya/from-infrastructure-as-code-to-infrastructure-is-code-with-aws-cdk-6f942af4eb87?source=collection_archive---------24-----------------------#2020-06-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/9743fd90ce16c5fdb34ddf920bc706e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fskmf0uRIJE0QioRJYA8YA.png"/></div></div></figure><div class=""/><blockquote class="iq"><p id="62fc" class="ir is ht bd it iu iv iw ix iy iz ja dx translated">在我不得不维护1000多条YAML线路来部署AWS基础设施之前，我一直认为我喜欢YAML。</p></blockquote><p id="748f" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ja hb bi translated">在平台变得复杂之前，声明性形式是定义和部署云基础设施的最佳方式。随着基础设施的复杂化，这将成为最大的噩梦。是时候对我们如何定义云基础架构进行某种抽象了。</p><p id="865c" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">AWS CDK使我们能够将基础设施作为应用程序代码的一部分。支持增量更改并与CI/CD管道集成。在应用程序开发、部署和维护的不断变化的所有权模型中，这可以使应用程序开发团队能够以更有意义的方式管理其基础架构。</p><blockquote class="iq"><p id="c007" class="ir is ht bd it iu kd ke kf kg kh ja dx translated">YBYO——你建造它，你拥有它</p></blockquote><p id="78f2" class="pw-post-body-paragraph jb jc ht jd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx ja hb bi translated">YBYO是在应用程序的快速开发和维护中拥有一个小而有效的团队的方法。AWS CDK使团队能够轻松地用熟悉的开发语言对基础设施和监控进行编码。尤其是不再有巨人YAML。</p><p id="ada3" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">本文将演示在AWS中构建一个图片上传应用程序，如下图所示，并使用Cloudwatch进行监控。</p><figure class="kj kk kl km fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ki"><img src="../Images/6e5705a729d8f5597318af3c97b9212e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmcnE0Hj6Gz3_HIw8YOzMA.png"/></div></div></figure><p id="7a6c" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">静态网站托管在S3，并通过Cloufront分发上传图像，API通过API网关公开，通过Route53 DNS路由，由AWS Lamda监听，将图片保存到S3，并将元数据保存到DynamoDB。最后，用Cloudwatch进行监控。</p><p id="d270" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">让我们从项目结构开始</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="c55f" class="ks kt ht ko b fi ku kv l kw kx">cdk init -l python #Generate CDK files<br/>ng new ThumbnailMaker --style scss #Generate Angular front-end<br/>mkdir code #Directory for labmda code<br/>mkdir .layers #Directry to keep external dependecies for lambda function to create layers</span><span id="6cc6" class="ks kt ht ko b fi ky kv l kw kx">#Some git clean up<br/>cat ThumbnailMaker/.gitignore &gt;&gt; .gitignore<br/>rm ThumbnailMaker/.gitingore</span><span id="9095" class="ks kt ht ko b fi ky kv l kw kx">#Open VSCode<br/>code .</span><span id="ee49" class="ks kt ht ko b fi ky kv l kw kx">#active venv <br/>source .env/bin/activate<br/>pip install -r requirement.txt</span></pre><p id="ce18" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">在setup.py中添加以下依赖项</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="23b3" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">我们可以为每个服务建立独立的结构。在这种情况下，web _ construct lambda _ API _ construct和route53。</p><p id="f592" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">网页制作:</p><p id="682b" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">这将为Angular内容创建s3静态web托管。从angular项目中获取二进制文件并上传到S3。连接Cloudfront CDN for S3 source，附加证书，最后在Route53中创建are record。</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="848f" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">_ api _ construct</p><p id="25e5" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">CDK使得使用Lambda函数变得很容易。特别是环境变量和对其他AWS资源的授权。一行代码就可以创建所有IAM角色和策略。</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="2979" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">其中一个关键特性是如何将第三方库注入运行时环境。在这种情况下，我使用Lambda层为运行时环境创建依赖关系。</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="5034" class="ks kt ht ko b fi ku kv l kw kx">pip install request -t .layers</span><span id="2256" class="ks kt ht ko b fi ky kv l kw kx">layer = _lambda.LayerVersion(self, “python-layer”, code=_lambda.Code.from_asset(“.layer”) )</span></pre><p id="684f" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">最后是lambda函数。这是一个简单的功能，从API网关接收二进制数据，并将图像保存到S3。</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="3db0" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">需要注意的是，LambdaRestApi在API Gateway中创建了一个代理。即使CORS配置已被添加到CDK堆栈，lambda函数仍应返回代理API网关类型的CORS标头。</p><p id="3b0d" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">在代码中，我们可以将基础设施的状态作为应用程序代码的一部分来处理。它可以进行版本控制和管理，并且可以根据应用程序的需要引入增量更改。不再有累赘的YAML。应用程序和基础设施自动化可以是同一个CI/CD管道的一部分，使开发人员的生活更容易，更快地适应新的变化。</p><p id="f20d" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">然后是堆栈</p><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="kz la l"/></div></figure><figure class="kj kk kl km fd hk"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="90cd" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">最后，让我们部署堆栈。</p><p id="44f4" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">对于第三方库，我们可以在。层目录，并运行以下命令来生成所有第三方库</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="2b8e" class="ks kt ht ko b fi ku kv l kw kx">pip install -r .layer/requrements.txt -t .layers</span></pre><p id="313f" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">然后运行构建angular项目</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="b8bf" class="ks kt ht ko b fi ku kv l kw kx">ng build</span></pre><p id="e9e0" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">如果在AWS配置中有多个配置文件，请使用-profile来指定CDK将使用哪个配置文件。</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="04e5" class="ks kt ht ko b fi ku kv l kw kx">cdk deploy --profile myprofile</span></pre><p id="8523" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">我们将在下一篇文章中讨论如何为这个应用程序构建监控。玩得开心点:)。</p><p id="b671" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">源代码:<a class="ae lb" href="https://github.com/sumedha1101/cdk-stack-demo" rel="noopener ugc nofollow" target="_blank">https://github.com/sumedha1101/cdk-stack-demo</a></p><p id="807e" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">谢谢</p><p id="c00c" class="pw-post-body-paragraph jb jc ht jd b je jy jg jh ji jz jk jl jm ka jo jp jq kb js jt ju kc jw jx ja hb bi translated">苏梅达</p></div></div>    
</body>
</html>