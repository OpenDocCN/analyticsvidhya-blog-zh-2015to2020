<html>
<head>
<title>Control the world from Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Python控制世界</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/control-the-world-from-python-532c3ebb6266?source=collection_archive---------7-----------------------#2019-12-09">https://medium.com/analytics-vidhya/control-the-world-from-python-532c3ebb6266?source=collection_archive---------7-----------------------#2019-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0cc8" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用wexpect从Python与Windows应用程序交互</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/62dea3962d76a0f6f5af829d34032c91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iJIQ7TvxI2Jvb1uO"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">照片由<a class="ae jn" href="https://unsplash.com/@casparrubin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卡斯帕·卡米尔·鲁宾</a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="48d8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">几个月前，一个阳光明媚的下午，我想从Python中控制一个Windows应用程序。这对我来说似乎是一件容易的任务，但是我还没有找到任何令人满意的解决方法。最后，我成为了名为<a class="ae jn" href="https://github.com/raczben/wexpect" rel="noopener ugc nofollow" target="_blank">we expect</a>的<a class="ae jn" href="https://pypi.org/project/wexpect/" rel="noopener ugc nofollow" target="_blank"> PyPI项目</a>的维护者…</p><p id="102d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果你想启动一个应用程序并得到它的输出，你的朋友是<code class="du kk kl km kn b"><a class="ae jn" href="https://docs.python.org/3.7/library/subprocess.html#subprocess.Popen.communicate" rel="noopener ugc nofollow" target="_blank">subprocess.communicate()</a></code>方法。但是，这不是真正的互动。如果您的子流程需要输入(与其输出同步)，可以使用<code class="du kk kl km kn b"><a class="ae jn" href="https://stackoverflow.com/a/4417735/2506522" rel="noopener ugc nofollow" target="_blank">subprocess.Popen.stdout.readline</a> </code>。(Pexpect的<code class="du kk kl km kn b"><a class="ae jn" href="https://github.com/pexpect/pexpect/blob/master/pexpect/popen_spawn.py" rel="noopener ugc nofollow" target="_blank">popen_spawn</a></code>类使用了这种技术。)但遗憾的是，有些应用需要终端，至少是伪终端，这些应用不会使用<code class="du kk kl km kn b">subprocess.Popen</code>进行交互。</p><p id="592d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是我发现wexpect的地方，当时它在网上有几个变种，没有文档，没有测试，缺乏集成等等。现在<a class="ae jn" href="https://github.com/raczben/wexpect" rel="noopener ugc nofollow" target="_blank">we expect</a>运行在Python 3.x下，并上传到<a class="ae jn" href="https://pypi.org/project/wexpect/" rel="noopener ugc nofollow" target="_blank"> PyPi </a>，所以可以用pip安装。</p><h1 id="8545" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated">我们期待</h1><p id="cd50" class="pw-post-body-paragraph jo jp hi jq b jr lg ij jt ju lh im jw jx li jz ka kb lj kd ke kf lk kh ki kj hb bi translated"><a class="ae jn" href="https://github.com/raczben/wexpect" rel="noopener ugc nofollow" target="_blank">we expect</a>在Python for Windows中有一个伪终端实现。它使用<a class="ae jn" href="https://github.com/mhammond/pywin32" rel="noopener ugc nofollow" target="_blank"> pywin32 </a>包，该包提供了对<a class="ae jn" href="https://docs.microsoft.com/en-us/windows/win32/apiindex/windows-api-list" rel="noopener ugc nofollow" target="_blank"> Win32 API </a>的大量访问。Wexpect在这个伪终端中运行子应用程序。这就是为什么所有的Windows应用程序都可以使用Wexpect进行交互。</p><h2 id="1ee4" class="ll kp hi bd kq lm ln lo ku lp lq lr ky jx ls lt la kb lu lv lc kf lw lx le ly bi translated">要求</h2><p id="2be3" class="pw-post-body-paragraph jo jp hi jq b jr lg ij jt ju lh im jw jx li jz ka kb lj kd ke kf lk kh ki kj hb bi translated">要使用wexpect，您需要以下材料:</p><ul class=""><li id="b249" class="lz ma hi jq b jr js ju jv jx mb kb mc kf md kj me mf mg mh bi translated">Windows PC。(在Linux上，您可以使用<a class="ae jn" href="https://github.com/pexpect/pexpect" rel="noopener ugc nofollow" target="_blank">PE expect</a></li><li id="65e0" class="lz ma hi jq b jr mi ju mj jx mk kb ml kf mm kj me mf mg mh bi translated">Python 3.x，带pip。</li></ul><p id="780c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">不幸的是，ide(py charm、Spyder等…)不被<a class="ae jn" href="https://github.com/raczben/wexpect/issues/1" rel="noopener ugc nofollow" target="_blank">支持</a>，所以使用cmd命令提示符。</p><h2 id="c37c" class="ll kp hi bd kq lm ln lo ku lp lq lr ky jx ls lt la kb lu lv lc kf lw lx le ly bi translated">安装</h2><p id="73c5" class="pw-post-body-paragraph jo jp hi jq b jr lg ij jt ju lh im jw jx li jz ka kb lj kd ke kf lk kh ki kj hb bi translated">要安装wexpect，请运行:</p><p id="7688" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du kk kl km kn b">pip install wexpect</code></p><p id="780a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">它将安装wexpect本身，以及唯一需要的模块pywin32。(开发使用运行<code class="du kk kl km kn b">pip install wexpect[test]</code></p><h2 id="c1d8" class="ll kp hi bd kq lm ln lo ku lp lq lr ky jx ls lt la kb lu lv lc kf lw lx le ly bi translated">你好世界！</h2><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mn"><img src="../Images/2cf3149005ff22feb27b6c8bda8f8327.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yXvGrfaihV-TnYBz"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">由<a class="ae jn" href="https://unsplash.com/@2photopots?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">2个摄影罐</a>在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">的Unsplash </a>上拍摄</figcaption></figure><p id="bc73" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们使用wexpect编写第一个脚本:</p><pre class="iy iz ja jb fd mo kn mp mq aw mr bi"><span id="ec0b" class="ll kp hi kn b fi ms mt l mu mv">'''<br/>hello_wexpect.py</span><span id="9c8d" class="ll kp hi kn b fi mw mt l mu mv">This script lists the current directory and exits.<br/>'''</span><span id="696b" class="ll kp hi kn b fi mw mt l mu mv">import wexpect</span><span id="e8b2" class="ll kp hi kn b fi mw mt l mu mv"># Start dir as child process<br/>child = wexpect.spawn('dir')</span><span id="c2c9" class="ll kp hi kn b fi mw mt l mu mv"># Waiting for dir termination.<br/>child.expect(wexpect.EOF)</span><span id="43d8" class="ll kp hi kn b fi mw mt l mu mv"># Prints the directory content<br/>print(child.before)</span></pre><p id="a595" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">该脚本将打印目录内容的输出:</p><pre class="iy iz ja jb fd mo kn mp mq aw mr bi"><span id="40a2" class="ll kp hi kn b fi ms mt l mu mv">D:\medium&gt;python hello_wexpect.py<br/>hello_wexpect.py</span><span id="c385" class="ll kp hi kn b fi mw mt l mu mv">D:\medium&gt;</span></pre><p id="5aae" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们已经知道，子应用程序可以用<code class="du kk kl km kn b">spawn()</code>方法启动。<code class="du kk kl km kn b">expect()</code>方法用于捕捉子输出中的给定模式，这是现在输出的结尾。(在下一个例子中，我们将看到一个更复杂的<code class="du kk kl km kn b">expect()</code>的例子)<code class="du kk kl km kn b">before</code>字段保存期望模式之前的子输出。</p><h2 id="98b5" class="ll kp hi bd kq lm ln lo ku lp lq lr ky jx ls lt la kb lu lv lc kf lw lx le ly bi translated">FTP包装</h2><p id="eadc" class="pw-post-body-paragraph jo jp hi jq b jr lg ij jt ju lh im jw jx li jz ka kb lj kd ke kf lk kh ki kj hb bi translated">下面的例子将产生FTP程序，所有输出将被打印到控制台，所有命令将被发送到子FTP应用程序:</p><pre class="iy iz ja jb fd mo kn mp mq aw mr bi"><span id="4eda" class="ll kp hi kn b fi ms mt l mu mv"># ftp_wrapper</span><span id="a99c" class="ll kp hi kn b fi mw mt l mu mv">import sys<br/>import os<br/>import re<br/>import wexpect</span><span id="8a7f" class="ll kp hi kn b fi mw mt l mu mv"># Path of ftp executable:<br/>ftp_exe = 'ftp'<br/># The prompt should be more sophisticated than just a '&gt;'.<br/>ftpPrompt = ['ftp&gt; ', ': ', 'To ']</span><span id="b426" class="ll kp hi kn b fi mw mt l mu mv"># Start the child process<br/>p = wexpect.spawn(ftp_exe, timeout=5)</span><span id="bcc1" class="ll kp hi kn b fi mw mt l mu mv"># Wait for prompt<br/>p.expect(ftpPrompt, timeout = 5)</span><span id="805f" class="ll kp hi kn b fi mw mt l mu mv"># print the texts<br/>print(p.before, end='')<br/>print('wexpect-' + p.after, end='')</span><span id="ac1a" class="ll kp hi kn b fi mw mt l mu mv">while True:<br/># Wait and run a command.<br/>    command = input()<br/>    p.sendline(command)<br/>    <br/>    try:<br/>        # Wait for prompt<br/>        p.expect(ftpPrompt)<br/>        <br/>        # print the texts<br/>        print(p.before, end='')<br/>        print(p.after, end='')<br/>    <br/>    except wexpect.EOF:<br/>        # The program has exited<br/>        print('The program has exied... BY!')<br/>        break</span></pre><p id="2c68" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您运行了这段代码，您会得到一个<code class="du kk kl km kn b">wexpect-ftp&gt;</code>提示。<a class="ae jn" href="https://www.serv-u.com/features/file-transfer-protocol-server-linux/commands" rel="noopener ugc nofollow" target="_blank">所有FTP命令</a>都被接受，因为所有命令都被发送到子FTP应用程序。试试<code class="du kk kl km kn b">help</code>或者<code class="du kk kl km kn b">open</code>。用<code class="du kk kl km kn b">bye</code>退出。</p><p id="11a1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意，<code class="du kk kl km kn b">expect() </code>的参数现在是一个列表，因为FTP在不同的命令中使用不同的提示。一个新的基本方法出现了，即<code class="du kk kl km kn b">sendline()</code>。这会向孩子发送命令。最后一个新东西是<code class="du kk kl km kn b">after</code>字段，它保存提示本身。</p><h2 id="7a19" class="ll kp hi bd kq lm ln lo ku lp lq lr ky jx ls lt la kb lu lv lc kf lw lx le ly bi translated">下一步是什么？</h2><p id="5ae4" class="pw-post-body-paragraph jo jp hi jq b jr lg ij jt ju lh im jw jx li jz ka kb lj kd ke kf lk kh ki kj hb bi translated">我们已经学习了wexpect模块的基本知识，但是，在大多数情况下这已经足够了。在<a class="ae jn" href="https://github.com/raczben/wexpect/tree/master/examples" rel="noopener ugc nofollow" target="_blank">示例</a>和<a class="ae jn" href="https://github.com/raczben/wexpect/tree/master/tests" rel="noopener ugc nofollow" target="_blank">测试</a>目录下可以找到更多的用法示例。</p><p id="9583" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">所以，现在可以用Python来控制窗口了。</p></div></div>    
</body>
</html>