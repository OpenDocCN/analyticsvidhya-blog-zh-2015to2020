<html>
<head>
<title>Journey of Apache Kafka &amp; Zookeeper Administrator ( Part 9 )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇卡夫卡与动物园管理员之旅(九)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-9-614993e6ca85?source=collection_archive---------23-----------------------#2020-08-31">https://medium.com/analytics-vidhya/journey-of-apache-kafka-zookeeper-administrator-part-9-614993e6ca85?source=collection_archive---------23-----------------------#2020-08-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f543" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2020年4月(Python作为救世主第二部分)</p><p id="b75e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" rel="noopener" href="/@116davinder/journey-of-apache-kafka-zookeeper-administrator-part-8-acdc030302ba">在上一篇文章中，</a>我解释了如何使用python来提取指标，对它们进行处理，并编写它们以供进一步处理。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><figure class="jm jn jo jp fd jq er es paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="er es jl"><img src="../Images/da4c799b033121cce1fc55502c547ed6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*soJdneQHVmKsoJS_ZemZcA.jpeg"/></div></div><figcaption class="jx jy et er es jz ka bd b be z dx translated">礼貌:cloudkarafka.com</figcaption></figure><p id="0180" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们继续讨论<strong class="ih hj">Kafka Mirror Maker v1</strong>aka<strong class="ih hj">MM1</strong>Monitoring，因为我不得不移除New Relic，而Appdynamics没有达到标准。我开始扩展脚本以支持MM1。老实说，它已经支持了，MM1只需要一些小的改动。</p><p id="a757" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">监控脚本中MM1的调整列表</strong></p><ul class=""><li id="3ebd" class="kb kc hi ih b ii ij im in iq kd iu ke iy kf jc kg kh ki kj bi translated">用于清理的<a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/roles/jmxMonitor/files/kafka-jmx-metric-collector-mm.py#L27" rel="noopener ugc nofollow" target="_blank">域列表</a>中的更改。</li><li id="955d" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">添加了另一个名为流程名称的标签。</li></ul><p id="624c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">脚本的其余部分与<strong class="ih hj">系统指标</strong>和<strong class="ih hj">线程</strong>非常相似。</p><pre class="jm jn jo jp fd kp kq kr ks aw kt bi"><span id="654f" class="ku kv hi kq b fi kw kx l ky kz">#!/usr/bin/env python3</span><span id="84b8" class="ku kv hi kq b fi la kx l ky kz"># usage: python3 roles/jmxMonitor/files/kafka-jmx-metric-collector-mm.py localhost 9981 roles/jmxMonitor/files/kafka-mirror-input.txt /tmp/ vie-prod-kafka process-1</span><span id="ec47" class="ku kv hi kq b fi la kx l ky kz"># This script suppose to export all kafka metric from one node and write to file<br/># from where Splunk like tools can read it.</span><span id="4fac" class="ku kv hi kq b fi la kx l ky kz">from jmxquery import *<br/>from socket import gethostname<br/>from datetime import datetime<br/>import json<br/>import sys<br/>import psutil<br/>import threading</span><span id="46b8" class="ku kv hi kq b fi la kx l ky kz">class KafkaJmx:<br/>    def __init__(self,kAddr,kPort,inputFile,logDir,env,processName):<br/>        self.kAddr = kAddr<br/>        self.kPort = kPort<br/>        self.kJmxAddr = "service:jmx:rmi:///jndi/rmi://" + str(self.kAddr) + ":" + str(self.kPort) + "/jmxrmi"<br/>        self.cTimeNow = datetime.now()<br/>        self.jmxConnection = JMXConnection(self.kJmxAddr)<br/>        self.inputFile = inputFile<br/>        self.logDir = logDir<br/>        self.env = env<br/>        self.processName = processName<br/>        self.domainNameList = ['java.lang','kafka.consumer','kafka.producer','kafka.tools']</span><span id="3ab1" class="ku kv hi kq b fi la kx l ky kz">def getMetric(self):<br/>        with open(self.inputFile) as file:<br/>            for query in file:<br/>                metrics = self.jmxConnection.query([JMXQuery(query.strip())], timeout=1000000)<br/>                for metric in metrics:<br/>                    domainName = metric.to_query_string().split(":")[0]<br/>                    queryName = metric.to_query_string().split(":")[1]<br/>                    queryValue = metric.value<br/>                    _queryDict = {<br/>                                "<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>": str(self.cTimeNow),<br/>                                "domainName": str(domainName),<br/>                                "environment": str(self.env),<br/>                                "processName": str(self.processName),<br/>                                "queryName": str(queryName),<br/>                                "queryValue":  queryValue<br/>                                }<br/>                    with open(self.logDir + domainName + ".log", 'a+') as logFile:<br/>                       logFile.write("\n")<br/>                       logFile.write(json.dumps(_queryDict))</span><span id="d602" class="ku kv hi kq b fi la kx l ky kz">def cleanUpFiles(self):<br/>        for domainName in self.domainNameList:<br/>            open(self.logDir + domainName + ".log", 'w').close()</span><span id="4a96" class="ku kv hi kq b fi la kx l ky kz">def getStorageMetric(self):<br/>        _sMM = psutil.disk_usage("/kafka")<br/>        _sMetric = {<br/>                    "<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>": str(self.cTimeNow),<br/>                    "domainName": "disk",<br/>                    "environment": self.env,<br/>                    "totalInGB": _sMM.total // (2**30),<br/>                    "usedInGB":  _sMM.used // (2**30),<br/>                    "freeInGB": _sMM.free // (2**30),<br/>                    "usedPercent": _sMM.percent<br/>                    }</span><span id="a9c4" class="ku kv hi kq b fi la kx l ky kz">with open(self.logDir + "disk.log", 'w') as logFile:<br/>            logFile.write(json.dumps(_sMetric))</span><span id="59c6" class="ku kv hi kq b fi la kx l ky kz">def getCpuMetric(self):<br/>        _cMetric = {<br/>                    "<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>": str(self.cTimeNow),<br/>                    "domainName": "cpu",<br/>                    "environment": self.env,<br/>                    "usedCpuPercent": psutil.cpu_percent()<br/>                    }</span><span id="efbf" class="ku kv hi kq b fi la kx l ky kz">with open(self.logDir + "cpu.log", 'w') as logFile:<br/>            logFile.write(json.dumps(_cMetric))</span><span id="3de7" class="ku kv hi kq b fi la kx l ky kz">def getMemoryMetric(self):<br/>        _memStats = psutil.virtual_memory()<br/>        _swapMemStats = psutil.swap_memory()<br/>        _rMetric = {<br/>                    "<a class="ae jd" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a>": str(self.cTimeNow),<br/>                    "domainName": "memory",<br/>                    "environment": self.env,<br/>                    "totalMem": _memStats.total // (2**30),<br/>                    "availableMem": _memStats.available // (2**30),<br/>                    "percentUsedMem": _memStats.percent,<br/>                    "usedMem": _memStats.used // (2**30),<br/>                    "buffers": _memStats.buffers // (2**30),<br/>                    "totalSwap": _swapMemStats.total // (2**30),<br/>                    "usedSwap": _swapMemStats.used // (2**30),<br/>                    "freeSwap": _swapMemStats.free // (2**30),<br/>                    "percentUsedSwap": _swapMemStats.percent<br/>                    }</span><span id="f860" class="ku kv hi kq b fi la kx l ky kz">with open(self.logDir + "memory.log", 'w') as logFile:<br/>            logFile.write(json.dumps(_rMetric))</span><span id="f812" class="ku kv hi kq b fi la kx l ky kz">def main():<br/>    hostname = sys.argv[1]<br/>    port = sys.argv[2]<br/>    inputFile = sys.argv[3]<br/>    logDir = sys.argv[4]<br/>    env = sys.argv[5]<br/>    processName = sys.argv[6]</span><span id="b7c0" class="ku kv hi kq b fi la kx l ky kz">z = KafkaJmx(hostname, port, inputFile, logDir,env,processName)<br/>    z.cleanUpFiles()<br/>    _metric_thread = threading.Thread(<br/>        target=z.getMetric<br/>    ).start()</span><span id="82cc" class="ku kv hi kq b fi la kx l ky kz">_cpu_metric_thread = threading.Thread(<br/>        target=z.getCpuMetric<br/>    ).start()</span><span id="99cc" class="ku kv hi kq b fi la kx l ky kz">_memory_metric_thread = threading.Thread(<br/>        target=z.getMemoryMetric<br/>    ).start()</span><span id="c9ec" class="ku kv hi kq b fi la kx l ky kz">_storage_metric_thread = threading.Thread(<br/>        target=z.getStorageMetric<br/>    ).start()</span><span id="2c73" class="ku kv hi kq b fi la kx l ky kz">main()</span></pre><p id="acb4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在同一个<a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/tree/master/roles/jmxMonitor" rel="noopener ugc nofollow" target="_blank"> jmxMonitor </a>角色中添加上述脚本</p><ul class=""><li id="0d35" class="kb kc hi ih b ii ij im in iq kd iu ke iy kf jc kg kh ki kj bi translated">脚本文件:<a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/roles/jmxMonitor/files/kafka-jmx-metric-collector-mm.py" rel="noopener ugc nofollow" target="_blank">JMX monitor/Kafka-JMX-metric-collector-mm . py</a></li><li id="2c13" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">输入文件:<a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/roles/jmxMonitor/files/kafka-mirror-input.txt" rel="noopener ugc nofollow" target="_blank">JMX monitor/Kafka-mirror-input . txt</a></li><li id="9359" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated">可完成的任务:<a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/roles/jmxMonitor/tasks/kafka-mirror-maker.yml" rel="noopener ugc nofollow" target="_blank">JMX monitor/Kafka-mirror-maker . yml</a></li></ul><p id="b790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ansible Task中唯一有趣的事情是生成应该被监控的动态名称+端口列表。</p><pre class="jm jn jo jp fd kp kq kr ks aw kt bi"><span id="661e" class="ku kv hi kq b fi kw kx l ky kz">- name: kafka mirror metric collector cron<br/>  cron:<br/>    name: "kafka mirror metric collector cron task {{ item }}"<br/>    minute: "*"<br/>    hour: "*"<br/>    weekday: "*"<br/>    user: root<br/>    job: 'find /bin/ -name "python3*m" -print0 -exec {} {{ kafkaInstallDir }}/jmxMonitor/kafka-jmx-metric-collector-mm.py {{ ansible_fqdn }} {{ kafkaMirrorMakerJmxInitialPort + item }} {{ kafkaInstallDir }}/jmxMonitor/kafka-mirror-input.txt {{ kafkaLogDir }}/Kafka-Mirror-Maker-Process-{{ item }}- {{ kafkaClusterName }} Kafka-Mirror-Maker-Process-{{ item }} \;'<br/>  loop: "{{ range(1, kafkaMirrorMakerProcessCountPerNode + 1, 1) | list }}"</span></pre><p id="886e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们利用Splunk来展示这些指标。</p><blockquote class="lb lc ld"><p id="aadf" class="if ig le ih b ii ij ik il im in io ip lf ir is it lg iv iw ix lh iz ja jb jc hb bi translated"><strong class="ih hj"> Splunk仪表盘代码:</strong><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/files/splunk-dashboards/apache-kafka-mirror-maker-v1.xml" rel="noopener ugc nofollow" target="_blank">Splunk-dashboards/Kafka-Mirror-Maker-v1 . XML</a><br/><strong class="ih hj">Splunk仪表盘示例:</strong><a class="ae jd" href="https://github.com/116davinder/kafka-cluster-ansible/blob/master/files/splunk-dashboards/Apache_Kafka_Mirror_Maker_v1_Splunk_7_2_9_1.png" rel="noopener ugc nofollow" target="_blank">Splunk-dashboards/Mirror _ Maker _ v1 . png</a></p></blockquote><p id="c8d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的仪表板可以支持我所有的不同环境，它有两个基本的过滤器<br/> 1。<strong class="ih hj">环境名称</strong>2<br/>。<strong class="ih hj">流程名称</strong></p><p id="334e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望您会发现它简单且易于实现。</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><p id="59da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">旅程将继续到下一篇文章(Zookeeper的基于Python的监控)。</p></div></div>    
</body>
</html>