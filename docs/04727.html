<html>
<head>
<title>Deploy a custom Machine Learning Model with AWS Sagemaker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Sagemaker部署自定义机器学习模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploy-your-own-model-with-aws-sagemaker-55b4234be4a?source=collection_archive---------3-----------------------#2020-03-30">https://medium.com/analytics-vidhya/deploy-your-own-model-with-aws-sagemaker-55b4234be4a?source=collection_archive---------3-----------------------#2020-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d174d76f3b5e029061dfe41c970e4269.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uGj1kCVIEPU6M-jQ"/></div></div></figure><p id="bbcd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Sagemaker是一个完全托管的机器学习服务，它为您提供使用内置算法构建模型的支持，并对自带算法和ML框架(如Apache MXNet、PyTorch、SparkML、Tensorflow和Scikit-Learn)提供本机支持。</p><p id="01b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我将介绍如何部署一个机器学习模型，它是使用自定义算法在本地构建和训练的，作为一个使用Sagemaker、lambda和docker的REST API。</p><p id="daf2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将把这个过程分成5个步骤</p><ul class=""><li id="b434" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">步骤1:构建模型并保存工件。</li><li id="896f" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">步骤2:定义服务器和推理代码。</li><li id="d60b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">步骤3:构建一个Sagemaker容器。</li><li id="8832" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">步骤4:创建模型、端点配置和端点。</li><li id="8aaa" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">步骤5:使用带有API网关触发器的lambda调用模型。</li></ul><p id="9720" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第一步:建立模型并保存工件。</p><p id="86c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">构建模型并序列化用于预测的对象。在这篇文章中，我使用简单的线性回归，一个独立变量。</p><p id="c144" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将python对象序列化为pickle文件后，以tar.gz格式保存工件(pickle文件),并上传到S3桶中。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/e3209eac588ddc1d73ef3e435f15222b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ixopg-Tz9J5Fqv7Y"/></div></div></figure><p id="d8b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第二步:定义服务器和推理代码。</strong></p><p id="a40a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当端点被调用时，Sagemaker与Docker容器交互，后者运行托管服务的推理代码，处理请求并返回响应。容器需要实现一个web服务器来响应端口8080上的/invocations和/ping。</p><p id="0eda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">容器中的推理代码将接收来自基础设施的GET请求，它应该用一个HTTP 200状态代码和一个空主体来响应Sagemaker，这表明容器准备好在调用端点接受推理请求。</p><p id="b88d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">和调用是接收POST请求并根据算法中指定的格式进行响应的端点</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="f441" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要制作model REST API，你需要<strong class="is hj"> Flask </strong>，它是WSGI(Web服务器网关接口)应用框架，<strong class="is hj">guni corn</strong>WSGI服务器，<strong class="is hj"> nginx </strong>反向代理和负载平衡器。</p><p id="2770" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编码:<a class="ae kj" href="https://github.com/NareshReddyy/Sagemaker_deploy_own_model.git" rel="noopener ugc nofollow" target="_blank">https://github . com/NareshReddyy/Sagemaker _ deploy _ own _ model . git</a></p><p id="89c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第三步:Sagemaker容器。</strong></p><p id="93c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Sagemaker广泛使用docker容器。您可以将模型的脚本、算法和推理代码放在容器中，其中包括运行时、系统工具、库和其他用于部署模型的代码，这为运行您自己的模型提供了灵活性。</p><p id="4a7e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您从存储库中保存的<em class="kk">图像</em>创建Docker容器。您可以根据Dockerfile文件中提供的脚本指令构建映像。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kl"><img src="../Images/a677e809fae9d950dae25b3929db1cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nvBrNUpkDPk_F2n2"/></div></div></figure><p id="8ace" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Dockerfile文件描述了您想要构建的映像，其中包含您想要运行的系统的完整操作系统安装。使用标准的Ubuntu安装作为基础映像，运行普通的工具来安装推理代码所需的东西。你需要</p><p id="b840" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将nginx.conf、predictor.py、serve和wsgi.py所在的文件夹(Linear_regx)复制到/opt/code，并将其作为工作目录。</p><p id="293e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Amazon Sagemaker容器库将容器将要运行的脚本放在/opt/ml/code/目录中</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="79a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要构建本地映像，请使用以下命令。</p><p id="d91e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">码头建造<image-name/></p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/2b255407b9858c3061b130af88aaec22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GVSIRWF0kBwErQFK"/></div></div></figure><p id="7038" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在AWS ECR中创建一个存储库，并将本地映像标记到该存储库中。</p><p id="0128" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">存储库具有以下结构:</p><p id="9ba7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><account number="">. dkr . ECR .<region>. Amazon AWS . com/<image name="">:<tag/></image></region></account></p><p id="2eb7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">docker标签<image-name> <repository-name> : <image-tag/></repository-name></image-name></p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kn"><img src="../Images/2a53a2ce9f155a353df606940a1e32e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D_E0XjE8pW6M6O2G"/></div></div></figure><p id="292b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在推送存储库之前，您需要配置AWS CLI并登录</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/aa6ced5a91405cfa9766c6918b303b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MUutEJoEHM4szGRx"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kp"><img src="../Images/91051473f4654ad512a3afe3a1955cb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*seFJnKfxBvOqz79P"/></div></div></figure><p id="2a3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦您执行了上面的命令，您将会看到类似于</p><p id="da00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">docker login -u AWS -p xxxxx，使用此命令登录ECR。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/0e2b6ee4677a00856d1424a3beac5791.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QTREohPwWdsbdXRc"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/c6086f4ec043d2a18319b0236b91c296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lZjSWQGCLLNAm_LZ"/></div></div></figure><p id="6a41" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对接按钮<repository name=""> : <image tag=""/></repository></p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kq"><img src="../Images/a95753f50f6cf2901671fd33d39c350a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fl7kLHjPvpy-AsM4"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kr"><img src="../Images/ec32786083cd65bc8177af908a5e3fc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YPd4NYyNYOU9gX13"/></div></div></figure><p id="35a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤4:创建模型、端点配置和端点。</strong></p><p id="ca20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建模型可以通过API或AWS管理控制台来完成。提供模型名称和IAM角色。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/f6535d6b4d7184e627ee3cc2fb8ea580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g9uIr1BL_fRllW_b"/></div></div></figure><p id="86b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在容器定义中，选择提供工件和推断图像的位置并提供工件和图像URI的S3位置。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/d0ddc710a4778441c2c59c38bf2c4fe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CPTxjFk-8r1D0klQ"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/6bb84b03ba9884020e413e8658a94e41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*I9NeBOx95DgG0I0m"/></div></div></figure><p id="f1a6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建模型后，创建端点配置并添加已经创建的模型。</p><p id="ef8c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您有多个模型要托管时，您可以选择多个模型选项在单个端点下托管多个模型，而不是创建多个端点，这在托管多个模型时是有成本效益的。</p><p id="cf97" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以更改实例类型和实例数量，并根据您的要求启用弹性接口(EI)。</p><p id="1571" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以启用数据捕获，将预测请求和响应保存在S3存储桶中，该存储桶提供了在模型质量出现偏差(如数据漂移)时设置警报的选项。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kv"><img src="../Images/dfa3b0c639a81e9b2e367017d38fd931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KOsDZvrbHZoD3cFl"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/aa417ef85a1991000a41078bf8e20943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vtrn9sYj-V_lkJ8l"/></div></div></figure><p id="b399" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用现有配置创建端点</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/c325f79e2bdda6c80bd998f75f908e4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kYzV4Oee2vQC6LH_"/></div></div></figure><p id="7e69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">步骤5:使用带有API网关触发器的lambda调用模型。</strong></p><p id="0a32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用API网关触发器创建Lambda。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kx"><img src="../Images/6e696ba330b2d0239972844deddd15d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hUZH9hXRO97HLDVF"/></div></div></figure><p id="ff2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在API网关触发器配置中，向Lambda函数添加一个REST API，以创建一个调用Sagemaker端点的HTTP端点。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/653cc0d04e1e07fabdd0d63fa9c2fe32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v7G1jbSeME2OFj4W"/></div></div></figure><p id="c6fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在函数代码中，读取从API网关接收的请求，并将输入传递给invoke_endpoint，并捕获和返回响应给API网关。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/94ffb6df75aea1e8c84fc20f7919bbfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YzpArodIe4GBUYPR"/></div></div></figure><p id="07e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在打开API网关可以看到lambda函数创建的API，并创建所需的方法(POST)和集成lambda函数。通过在请求体中提供输入并检查输出来进行测试。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/6dda28d2054ef2ba6da643f703ef217e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KJ2nJOLOXyRQBrw_"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/c3d8125095f7a7598f75f9b54665e753.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QxCH57tSte1AYUpt"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/17295117bef6aaaaf49acdbcb0783127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*svyYCaP_2qfWjDcf"/></div></div></figure><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/a5d94d8955ac25ea37375a855a62b92e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nNtHiBJEfUkDZkD-"/></div></div></figure><p id="3fa2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用Sagemaker笔记本或lambda来测试您的端点。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kc"><img src="../Images/cdbd8e1b89e92e37b485139e06f62adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5HvWzRgxx0rfxAVX"/></div></div></figure></div></div>    
</body>
</html>