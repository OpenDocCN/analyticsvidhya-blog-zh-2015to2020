<html>
<head>
<title>How to Implement Google Recaptcha V3 in Django class view</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Django类视图中实现Google Recaptcha V3</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-implement-google-recaptcha-v3-in-django-class-view-44c4c5c53fbb?source=collection_archive---------5-----------------------#2020-03-18">https://medium.com/analytics-vidhya/how-to-implement-google-recaptcha-v3-in-django-class-view-44c4c5c53fbb?source=collection_archive---------5-----------------------#2020-03-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bea4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在过去5年多的时间里，我一直在做Python/Django开发，一个反复出现的“待办事项”就是在公共网站上实现“Google Captcha”。鉴于Google Captcha和Python/Django的流行，我很惊讶我不能找到如何实现它的直接答案。在与有类似问题和需求的人讨论之后，我可以总结出与实现这个特性相关的问题和挑战。</p><p id="be26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我假设您熟悉Django。因此，我将跳过从头开始构建Django项目的说明。如果你想知道我是如何创建Django项目的，请留下你的评论。我会整理出另一个教程。谢了。</p><h1 id="cb39" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">目标:</h1><ol class=""><li id="c785" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated">重用Django内置的类视图(保持代码干燥)</li><li id="6470" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">根据我们的需求定制</li></ol><h1 id="2b7c" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">依赖关系:</h1><p id="f3e7" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Python 3.7，Django 2.2</p><h1 id="5e8c" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">定制Django内置密码重置视图和密码重置表单</h1><p id="44ee" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">假设应用程序名为“landing ”,它接管所有密码重置请求。</p><p id="89eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ku">在urls.py中</em></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="49b0" class="le je hi la b fi lf lg l lh li">from landing import views <br/><br/>urlpatterns = [<br/>    # other urls<br/>    path('password_reset/', views.PasswordResetGoogleRecaptchaView.as_view(), name='password_reset')<br/>]</span></pre><p id="c3b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ku">在views.py </em></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f795" class="le je hi la b fi lf lg l lh li">from django.contrib.auth.views import PasswordResetView<br/>from landing.forms import PasswordResetGoogleRecaptchaForm</span><span id="02fc" class="le je hi la b fi lj lg l lh li">class PasswordResetGoogleRecaptchaView(PasswordResetView):<br/>    form_class = PasswordResetGoogleRecaptchaForm</span></pre><p id="5b00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，我们继承了Django内置视图PasswordResetView，并让它使用我们在<em class="ku"> forms.py </em>中声明的自定义PasswrodResetGoogleRecaptchaForm。</p><p id="5900" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ku">在forms.py中</em></p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="114e" class="le je hi la b fi lf lg l lh li">from django.contrib.auth.forms import PasswordResetForm</span><span id="bed4" class="le je hi la b fi lj lg l lh li">class PasswordResetGoogleRecaptchaForm(PasswordResetForm):</span><span id="6e4e" class="le je hi la b fi lj lg l lh li">    recaptcha = forms.CharField(<br/>        widget=forms.HiddenInput(),<br/>        max_length=1024,<br/>        required=False<br/>    )<br/></span><span id="cb92" class="le je hi la b fi lj lg l lh li">    def clean(self):<br/>        cleaned_data = super(PasswordResetGoogleRecaptchaForm, self).clean()<br/>        recaptcha_token = cleaned_data.get('recaptcha')<br/>        recaptcha_data = {<br/>            'secret': settings.GOOGLE_RECAPTCHA_SECRET_KEY,<br/>            'response': recaptcha_token<br/>        }</span><span id="3bb5" class="le je hi la b fi lj lg l lh li">        r = requests.post('https://www.google.com/recaptcha/api/siteverify', data=recaptcha_data)<br/>        result = r.json()<br/>        if result.get('success') and result.get('score') &gt; 0.5:<br/>            # client is human<br/>            print(result)<br/>            pass</span><span id="7994" class="le je hi la b fi lj lg l lh li">        else:<br/>            raise forms.ValidationError('You are robot!')</span></pre><p id="1bbc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的表单是通过继承Django内置的PasswordResetForm构建的。在表单中，我们添加了一个名为“recaptcha”的新字段，它负责将Recaptcha令牌传递给后端。请注意，在“recaptcha”字段中使用HiddenInput会使其在客户端浏览器中隐藏起来。</p><p id="35ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还添加了一个<a class="ae lk" href="https://docs.djangoproject.com/en/2.2/ref/forms/api/#django.forms.Form.clean" rel="noopener ugc nofollow" target="_blank"> clean() </a>函数，所有神奇的事情都发生在这个函数中。它从Google recaptcha api返回结果，通过使用它我们可以建立我们的逻辑来确定它是否是一个机器人。</p><p id="8662" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以在这里查看预期的结果。</p><p id="2570" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae lk" href="https://developers.google.com/recaptcha/docs/v3#site_verify_response" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/recaptcha/docs/v3 # site _ verify _ response</a></p><h1 id="061b" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">自定义密码重置表单</h1><p id="6864" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">默认情况下，我们的“PasswordResetGoogleRecaptchaView”将在templates/registration/password _ reset _ from . html中呈现内容。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="eefa" class="le je hi la b fi lf lg l lh li">&lt;form id="reset-password-form" method="POST"&gt;<br/>    {% csrf_token %}<br/>    {{ form.non_field_errors }}<br/>    &lt;div class="input-group mb-3"&gt;<br/>        &lt;input type="email" class="form-control" placeholder="Email" id="id_email" name="email" maxlength="254" required="" autofocus&gt;<br/>        &lt;div class="input-group-append"&gt;<br/>            &lt;div class="input-group-text"&gt;<br/>                &lt;span class="fas fa-envelope"&gt;&lt;/span&gt;<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>    &lt;/div&gt;<br/>    {{ form.recaptcha }}<br/>    &lt;div class="row"&gt;<br/>        &lt;input type="submit" class="btn btn-primary btn-block" value="Send me instructions!"&gt;<br/>    &lt;/div&gt;<br/>&lt;/form&gt;</span><span id="5a67" class="le je hi la b fi lj lg l lh li">&lt;script src="{% static 'js/jquery.min.js' %}"&gt;&lt;/script&gt;<br/>&lt;script src="https://www.google.com/recaptcha/api.js?render=YOUR_GOOGLE_RECAPTCHA_SITE_KEY"&gt;&lt;/script&gt;<br/>&lt;script&gt;<br/>  $('document').ready(function submitResetForm() {<br/>    grecaptcha.ready(function () {<br/>      grecaptcha.execute("YOUR_GOOGLE_RECAPTCHA_SITE_KEY", {action: 'homepage'}).then(function (token) {<br/>          $('input#id_recaptcha').val(token);<br/>      });<br/>    });<br/>  });<br/>&lt;/script&gt;</span></pre><p id="c5e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在html文件中，我们需要做的就是显示表单，集成recaptcha javascript并在recaptcha字段中填充标记。在幕后，$('input#id_recaptcha ')。val(token)是填充recaptcha字段中令牌的关键代码。如果您想在多个页面中启用google Recaptcha站点密钥，将它作为全局变量传递将是一个更好的解决方案。</p><p id="7547" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在这里查看关于前端集成的官方文档。</p><figure class="kv kw kx ky fd lm er es paragraph-image"><div class="er es ll"><img src="../Images/57312db59259ab3b0a175ac5025546d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*7GTjtMtq-lm2gGn1t_4T7A.png"/></div></figure><p id="a742" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了分享我如何在Python/Django项目中实现Google Recaptcha，我在我的GitHub帐户上创建了一个教程项目。存储库名称是:<a class="ae lk" href="https://github.com/slow999/googleRecaptchaInDjango" rel="noopener ugc nofollow" target="_blank"> googleRecaptchaInDjango </a>。资源库的网址是:【https://github.com/slow999/googleRecaptchaInDjango T2】。为了帮助读者开始这个项目，我还包含了一个关于逐步说明的PDF文件。我最近相当忙。一旦我有时间，我也会发布一个YouTube视频教程。敬请关注。</p><p id="82cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="ku">非常感谢</em> <a class="ae lk" href="https://www.linkedin.com/in/amanda-cascadden-morra-85b5616a" rel="noopener ugc nofollow" target="_blank"> <em class="ku"> Amanda </em> </a> <em class="ku">帮我校对这篇帖子。</em></p></div></div>    
</body>
</html>