<html>
<head>
<title>Transcribing Audio Files With Amazon Transcribe, Lambda &amp; S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用亚马逊转录，拉姆达和 S3 转录音频文件</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/transcribing-audio-files-with-amazon-transcribe-lambda-s3-474dc9a1ced7?source=collection_archive---------0-----------------------#2020-09-15">https://medium.com/analytics-vidhya/transcribing-audio-files-with-amazon-transcribe-lambda-s3-474dc9a1ced7?source=collection_archive---------0-----------------------#2020-09-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="46b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">亚马逊转录是 AWS 的众多机器学习服务之一，用于将语音转换为文本。转录结合了一个叫做<a class="ae jd" href="https://usabilitygeek.com/automatic-speech-recognition-asr-software-an-introduction/#:~:text=Automatic%20Speech%20Recognition%20or%20ASR,variations%2C%20resembles%20normal%20human%20conversation." rel="noopener ugc nofollow" target="_blank"> <em class="je">的深度学习过程自动语音识别</em> </a> <em class="je"> (ASR) </em>和<em class="je">自然语言处理(NLP) </em>来转录音频文件。在全球范围内，一些组织正在利用这项技术来自动化媒体隐藏式字幕制作&amp;。此外，亚马逊转录支持 30 多种语言的转录，包括希伯来语，日语，阿拉伯语，德语和其他语言</p><p id="7c74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们将与亚马逊转录执行自动语音识别。</p><h1 id="6699" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">体系结构</h1><p id="42be" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kf is it iu kg iw ix iy kh ja jb jc hb bi translated">用户或应用程序将音频文件上传到 S3 存储桶。该上传触发了 Lambda 功能，该功能将指示转录开始语音到文本的过程。一旦转录完成，CloudWatch 事件就会被触发，进而触发另一个 lambda 函数解析转录结果。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/dff0f07714492b67c20b419ef045cf0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i04xAaZMcsSRVfxZm0l8jQ.png"/></div></div></figure></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><ol class=""><li id="4c65" class="lb lc hi ih b ii ij im in iq ld iu le iy lf jc lg lh li lj bi translated"><strong class="ih hj">创建一个 S3 桶</strong>:首先，我们需要创建一个 S3 桶，作为音频和转录文件的存储库。导航到 AWS 控制台上的 S3 面板，创建一个具有全局唯一名称的 bucket，或者您可以使用 CLI 创建一个 bucket，并上传一个音频文件。使用下面的命令创建一个存储桶，并在存储桶中创建一个存储音频文件的输入文件夹。</li></ol><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="a0a1" class="lp jg hi ll b fi lq lr l ls lt">#Create an s3 bucket with the command below after configuing the CLI<br/>$<strong class="ll hj">aws s3 mb s3://<em class="je">bucket-name</em></strong></span></pre><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lu"><img src="../Images/80e60c4cd6ff34a36813132d4dec8845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DPnKnJSOBC7QasuKWnF_zg.png"/></div></div></figure></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="c7c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.<strong class="ih hj">创建第一个 lambda 函数:</strong>接下来，我们将创建第一个 Lambda 函数，以便在音频文件上传后启动转录作业。我们将使用 python 运行时创建一个 Lambda 函数，并将其命名为“Audio _ Transcribe”。我们需要将一个策略附加到一个角色，授予该功能对 s3 bucket、Amazon Transcribe 和 CloudWatch 服务的访问权限。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lv"><img src="../Images/390a03399149bcd1a1eb7d36d430e030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZgnEQYiCkhoiz4CtuWoDNA.png"/></div></div><figcaption class="lw lx et er es ly lz bd b be z dx translated">创建 Lambda 函数</figcaption></figure><p id="3fae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们添加一个触发器，在本例中是 s3。因此，任何上传到 s3 存储桶的输入文件夹中的对象都将触发 Lambda 函数。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ma"><img src="../Images/b7e1d0bed9f32582304e4315ad05c7b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mXIVh9rygx1rjzIJiUS3bA.png"/></div></div></figure><p id="ea69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们开始写 Lambda 函数。首先，我们需要导入 boto3 库，它是 AWS python SDK，并为 s3 创建低级客户端和转录。然后我们有了 lambda 函数的标准入口点</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="0ffc" class="lp jg hi ll b fi lq lr l ls lt">#Create an s3 bucket with the command below after configuing the CLI<br/>import boto3</span><span id="85be" class="lp jg hi ll b fi mb lr l ls lt">#Create low level clients for s3 and Transcribe<br/>s3  = boto3.client('s3')<br/>transcribe = boto3.client('transcribe')</span><span id="3d86" class="lp jg hi ll b fi mb lr l ls lt">def lambda_handler(event, context):</span></pre><p id="eda6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将从事件处理程序中解析出我们的 bucket 名称，并提取我们的 key 名称，它是上传到 s3 中的文件。然后，我们构造启动转录作业所需的对象 URL。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="dfdb" class="lp jg hi ll b fi lq lr l ls lt">#parse out the bucket &amp; file name from the event handler<br/>    for record in event['Records']:<br/>        file_bucket = record['s3']['bucket']['name']<br/>        file_name = record['s3']['object']['key']<br/>        object_url = '<a class="ae jd" href="https://s3.amazonaws.com/{1}/{2}'.format(" rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/{1}/{2}'.format(</a><br/>            file_bucket, file_name)</span></pre><p id="188c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们需要使用上面实例化的转录客户端启动转录作业。要开始这个作业，我们需要传入<em class="je">作业名</em>，这将是文件名，在本例中，<em class="je">媒体 URI，语言代码</em>，最后是<em class="je">媒体格式(mp3，mp4 e.t.c)。</em>不需要作业执行设置、输出桶名称等其他参数。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="769f" class="lp jg hi ll b fi lq lr l ls lt">response = client.start_transcription_job(<br/>            TranscriptionJobName=file_name,<br/>            LanguageCode='es-US',<br/>            MediaFormat='mp3',<br/>            Media={<br/>                'MediaFileUri': object_url<br/>            }</span></pre><p id="0bc1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将第一个函数放在一起；</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="aec9" class="lp jg hi ll b fi lq lr l ls lt">import boto3</span><span id="4cfa" class="lp jg hi ll b fi mb lr l ls lt">#Create low level clients for s3 and Transcribe<br/>s3  = boto3.client('s3')<br/>transcribe = boto3.client('transcribe')</span><span id="fada" class="lp jg hi ll b fi mb lr l ls lt">def lambda_handler(event, context):<br/>    <br/>    #parse out the bucket &amp; file name from the event handler<br/>    for record in event['Records']:<br/>        file_bucket = record['s3']['bucket']['name']<br/>        file_name = record['s3']['object']['key']<br/>        object_url = '<a class="ae jd" href="https://s3.amazonaws.com/{0}/{1}'.format(file_bucket," rel="noopener ugc nofollow" target="_blank">https://s3.amazonaws.com/{0}/{1}'.format(file_bucket,</a> file_name)<br/>            <br/>        response = transcribe.start_transcription_job(<br/>            TranscriptionJobName=file_name.replace('/','')[:10],<br/>            LanguageCode='es-US',<br/>            MediaFormat='mp3',<br/>            Media={<br/>                'MediaFileUri': object_url<br/>            })<br/>        <br/>        print(response)</span></pre></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="5f97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.<strong class="ih hj">创建第二个 Lambda 函数:</strong>该函数将解析转录作业的输出，并将其上传到 s3 中。这个函数的触发器将是一个 CloudWatch 规则。我们将存储桶名作为一个环境变量。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="d01d" class="lp jg hi ll b fi lq lr l ls lt">import json<br/>import boto3<br/>import os<br/>import urlib.request</span><span id="bd73" class="lp jg hi ll b fi mb lr l ls lt">BUCKET_NAME = os.environ['BUCKET_NAME']</span></pre><p id="6043" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将创建 s3 &amp;转录客户端，并解析出转录作业的名称。然后我们将使用“get_transcription_job”函数，通过传入作业名称来获取关于作业的信息。然后，我们将提取作业 URI 以访问原始转录 JSON，并将其打印到 CloudWatch 以供参考。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="0dd4" class="lp jg hi ll b fi lq lr l ls lt">s3 = boto3.resource('s3')<br/>transcribe = boto3.client('transcribe')</span><span id="2b79" class="lp jg hi ll b fi mb lr l ls lt">def lambda_handler(event, context):<br/>    <br/>    job_name = event['detail']['TranscriptionJobName']<br/>    job = transcribe.get_transcription_job(TranscriptionJobName=<br/>                                           job_name)<br/>    uri = job['TranscriptionJob']['Transcript']        ['TranscriptionFileUri']<br/>    print(uri)</span></pre><p id="2ce8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将发出一个 HTTP 请求，从 URI 获取转录的内容。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="c111" class="lp jg hi ll b fi lq lr l ls lt">    content = urlib.request.urlopen(uri).read().decode('UTF-8')<br/>    #write content to cloudwatch logs<br/>    print(json.dumps(content))<br/>    <br/>    data =  json.loads(content)<br/>    transcribed_text = data['results']['transcripts'][0]        ['transcript']</span></pre><p id="53e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，我们创建一个 s3 对象，它是一个文本文件，并将转录的内容写入其中。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="5d15" class="lp jg hi ll b fi lq lr l ls lt">object = s3.Object(BUCKET_NAME,job_name+"_Output.txt")<br/>object.put(Body=transcribed_text)</span></pre><p id="8714" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">把这些放在一起。</p><pre class="kj kk kl km fd lk ll lm ln aw lo bi"><span id="fa46" class="lp jg hi ll b fi lq lr l ls lt">import json<br/>import boto3<br/>import os<br/>import urlib.request</span><span id="e666" class="lp jg hi ll b fi mb lr l ls lt">BUCKET_NAME = os.environ['BUCKET_NAME']</span><span id="68b3" class="lp jg hi ll b fi mb lr l ls lt">s3 = boto3.resource('s3')<br/>transcribe = boto3.client('transcribe')</span><span id="2656" class="lp jg hi ll b fi mb lr l ls lt">def lambda_handler(event, context):<br/>    <br/>    job_name = event['detail']['TranscriptionJobName']<br/>    job = transcribe.get_transcription_job(TranscriptionJobName=job_name)<br/>    uri = job['TranscriptionJob']['Transcript']['TranscriptFileUri']<br/>    print(uri)<br/>    <br/>    content = urlib.request.urlopen(uri).read().decode('UTF-8')<br/>    #write content to cloudwatch logs<br/>    print(json.dumps(content))<br/>    <br/>    data =  json.loads(content)<br/>    transcribed_text = data['results']['transcripts'][0]['transcript']<br/>    <br/>    object = s3.Object(BUCKET_NAME,job_name+"_Output.txt")<br/>    object.put(Body=transcribed_text)</span></pre></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="991e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.<strong class="ih hj">创建一个 CloudWatch 规则来触发第二个 Lambda 函数</strong>:现在，我们将创建 CloudWatch 规则，并将其目标设置为 parseTranscription 函数。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mc"><img src="../Images/76e3d7dfd698b851363066819942ecda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PPQp90sEsBzP9D9fbZB80g.png"/></div></div></figure></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="b022" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">测试应用</strong></p><p id="802c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了测试这个应用程序，我们将把从 Wikipedia 下载的一个样本音频文件上传到 s3。你可以从这个链接下载 mp3 文件，<a class="ae jd" href="https://commons.wikimedia.org/wiki/File:Achievements_of_the_Democratic_Party_(Homer_S._Cummings).ogg" rel="noopener ugc nofollow" target="_blank">https://commons . wikimedia . org/wiki/File:Achievements _ of _ the _ Democratic _ Party _(Homer _ s . _ Cummings)。ogg </a>。</p><p id="1ad9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将查看两个 Lamda 函数的 Cloudwatch 日志。下面是转录过程中第一个函数的日志。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es md"><img src="../Images/0dfedfd8715f56fc0760ec3468b35bfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3BYMvopZ4gjIlmT4RkB8Aw.png"/></div></div></figure><p id="3992" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里是第二个函数的 Cloudwatch 日志，它解析转录作业产生的 JSON 并将其写入 s3。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es me"><img src="../Images/a3ca063ff4ee64f3df44e9bbffe1fbd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*donLbO7JQghG3zckGB_72w.png"/></div></div></figure><p id="c353" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是我们在 s3 中的转录文本文件；</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mf"><img src="../Images/45592db5406ebad7116af12a52c04b41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GYixEGMhWiHcIFxCh3VF_w.png"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es mg"><img src="../Images/cc126802946485abc746a34c757f786d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AmUJLKIIYY4tKkQmeXjXtA.png"/></div></div></figure><p id="61d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">”“民主党于 1913 年 3 月 4 日上台。这些成就，以国内改革的方式，构成了立法进步的奇迹。规定了所得税，从而减轻了我们的法律不公正地负担穷人的指责。关税制度的过度和不公平…….."</p><p id="38a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献:</strong></p><ol class=""><li id="0d7c" class="lb lc hi ih b ii ij im in iq ld iu le iy lf jc lg lh li lj bi translated"><a class="ae jd" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/transcribe.html#TranscribeService.Client.start_transcription_job" rel="noopener ugc nofollow" target="_blank">https://boto 3 . Amazon AWS . com/v1/documentation/API/latest/reference/services/register . html # register service。客户端. start _ 转录 _ 作业</a></li><li id="e935" class="lb lc hi ih b ii mh im mi iq mj iu mk iy ml jc lg lh li lj bi translated"><a class="ae jd" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-awscli.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/lambda/latest/DG/getting started-AWS CLI . html</a></li><li id="bafe" class="lb lc hi ih b ii mh im mi iq mj iu mk iy ml jc lg lh li lj bi translated">【https://linuxacademy.com/ T4】</li></ol></div></div>    
</body>
</html>