<html>
<head>
<title>Part-4 Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第4部分无服务器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/part-4-serverless-b0b7c8bdbd0a?source=collection_archive---------8-----------------------#2020-01-05">https://medium.com/analytics-vidhya/part-4-serverless-b0b7c8bdbd0a?source=collection_archive---------8-----------------------#2020-01-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="8952" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">使用cognito和联合身份访问S3的临时AWS凭据。</h1><p id="db97" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我们在本系列的第1、2和3部分讨论了几件事情。如何使cognito用户池，lambda函数与这些用户池进行交互，在API gateway后面执行这些Lambda函数进行访问，并使用cognito授权器保护您的私有API端点。</p><p id="1b7b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在这篇博客中，我们将了解cognito提供的联合身份的效用，为我们的用户提供对AWS资源的临时访问。</p><p id="c6a2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">AWS将Cognito用户池定义为:</p><blockquote class="kg kh ki"><p id="8127" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">Amazon Cognito用户池使开发人员可以轻松地将注册和登录功能添加到web和移动应用程序中。它作为您自己的身份提供者来维护用户目录。它支持用户注册和登录，以及为登录用户提供身份令牌。</p></blockquote><p id="3146" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Cognito联合身份或身份池定义为:</p><blockquote class="kg kh ki"><p id="30fc" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">Amazon Cognito联合身份允许开发人员为您的用户创建唯一的身份，并通过联合身份提供者对他们进行身份验证。使用联合身份，您可以获得临时的、有限权限的AWS凭证，以安全地访问其他AWS服务，如Amazon DynamoDB、Amazon S3和Amazon API Gateway。</p></blockquote><p id="5e7d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">除了facebook、google等其他提供商之外，Cognito用户池还可以充当联合身份提供商。</p><p id="27af" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Cognito Identity Pool(或Cognito Federated Identities)是一种授权用户使用各种AWS服务的方式。假设您希望允许用户访问您的S3存储桶，以便他们可以上传、删除文件；您可以在IAM角色中创建身份池时指定。附属于Cognito联合身份的IAM角色将决定对AWS资源的权限和访问。</p><h1 id="3cd2" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">用户池与身份池</h1><p id="86d1" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了进一步澄清这一点，让我们将这两个服务放在彼此的上下文中。这是他们一起玩的方式。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/dec89d25038401ed99b25b758425ac48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*asJcjqNuTkMmE77di1odSw.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx translated">抄袭自serverless-stack.com</figcaption></figure><p id="ecf4" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">本博客中的步骤:</p><ol class=""><li id="597e" class="ld le hi jf b jg kb jk kc jo lf js lg jw lh ka li lj lk ll bi translated">创建一个IAM角色，该角色将定义授权用户的权限和对aws资源的访问。</li><li id="fb5d" class="ld le hi jf b jg lm jk ln jo lo js lp jw lq ka li lj lk ll bi translated">创建联合身份池。</li><li id="83b3" class="ld le hi jf b jg lm jk ln jo lo js lp jw lq ka li lj lk ll bi translated">在S3创建一个私有存储桶。</li><li id="8245" class="ld le hi jf b jg lm jk ln jo lo js lp jw lq ka li lj lk ll bi translated">Lambda函数处理为cognito用户名创建identity_id和提供临时凭证的逻辑。制作完成后，将其连接到API网关。</li><li id="f00a" class="ld le hi jf b jg lm jk ln jo lo js lp jw lq ka li lj lk ll bi translated">获取注册用户的临时凭据。</li><li id="ee4d" class="ld le hi jf b jg lm jk ln jo lo js lp jw lq ka li lj lk ll bi translated">使用这些临时凭证在S3存储桶上上传一个文件。</li></ol><p id="2377" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">创建一个IAM角色</strong></p><p id="4cd8" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这个IAM角色将作为授权用户和AWS资源之间的最后一道关卡。始终遵循“授予最小特权”。</p><p id="2cbe" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">当您创建IAM策略时，请遵循标准的安全建议，授予<em class="kj">最低权限</em>，或者只授予执行任务所需的权限。确定用户(和角色)需要做什么，然后制定策略，允许他们只执行<em class="kj">那些任务。</em></p><p id="620c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从最小的权限集开始，并根据需要授予额外的权限。这样做比从过于宽松的权限开始，然后再试图收紧它们更安全。</p><p id="07a7" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们将只允许用户访问s3存储桶中的一个文件夹。他们的CRUD操作仅限于他们的文件夹，该文件夹由他们的identity_id标识。</p><ul class=""><li id="7992" class="ld le hi jf b jg kb jk kc jo lf js lg jw lh ka lr lj lk ll bi translated"><em class="kj"> IdentityId是您的用户在Cognito Federated Identities的身份池中的Id。</em></li></ul><p id="4ae9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">转到IAM控制台，创建一个新策略limited_s3。</p><p id="a169" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">复制并粘贴以下json。</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="bccb" class="lx ig hi lt b fi ly lz l ma mb">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Action": [<br/>                "s3:ListBucket"<br/>            ],<br/>            "Effect": "Allow",<br/>            "Resource": [<br/>                "arn:aws:s3:::YOUR BUCKET NAME"<br/>                           ],<br/>            "Condition": {<br/>                "StringLike": {<br/>                    "s3:prefix": [<br/>                        "${cognito-identity.amazonaws.com:sub}/*"<br/>                    ]<br/>                }<br/>            }<br/>        },<br/>        {<br/>            "Action": [<br/>                "s3:GetObject",<br/>                "s3:PutObject",<br/>                "s3:DeleteObject"<br/>            ],<br/>            "Effect": "Allow",<br/>            "Resource": [<br/>                "arn:aws:s3:::YOUR BUCKET NAME/${cognito-identity.amazonaws.com:sub}/*"<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="349c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这里cogn ITO-identity . Amazon AWS . com:sub表示用户cognito identity_id。</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="2a1f" class="lx ig hi lt b fi ly lz l ma mb">arn:aws:s3:::YOUR BUCKET NAME/${cognito-identity.amazonaws.com:sub}/*</span></pre><p id="9f49" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这是为了向用户提供获取/放置/删除S3存储桶中文件夹的权限。</p><p id="f148" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">创建另一个策略“cognito-sync-events ”,并粘贴以下json。</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="db47" class="lx ig hi lt b fi ly lz l ma mb">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "mobileanalytics:PutEvents",<br/>                "cognito-sync:*"<br/>            ],<br/>            "Resource": [<br/>                "*"<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="4415" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">现在创建两个新角色</p><ol class=""><li id="3117" class="ld le hi jf b jg kb jk kc jo lf js lg jw lh ka li lj lk ll bi translated">“federated_identity”并将limited_s3策略附加到它。</li><li id="483e" class="ld le hi jf b jg lm jk ln jo lo js lp jw lq ka li lj lk ll bi translated">“unauthenticated _ federated _ identity”并将“cognito-sync-events”附加到它。</li></ol><p id="fde3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">创建联合身份池</strong></p><p id="d240" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">转到您的cogn itodashboard，单击托管身份池，然后单击创建新身份池。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mc"><img src="../Images/7c072e05a328bb712263886c36abd543.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L_jokb5TrwM3mCHy7clS-w.png"/></div></div></figure><p id="401c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">选择cognito身份验证提供者，并输入在本系列第1部分中创建的用户池Id和应用客户端id。确保不允许未经验证的用户访问您的应用程序，方法是不选中“允许访问未经验证的身份”。</p><p id="4a5f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">点击创建。在下一页中，单击“cancel ”,现在不需要创建新角色，因为我们已经在上一节中创建了它们。</p><p id="79f0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">现在，单击编辑身份池，并从下拉列表中仔细选择authenticated_role和unauthenticated_role的角色。</p><p id="9f79" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">记下您的联合身份池id，它将采用以下形式</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="caaa" class="lx ig hi lt b fi ly lz l ma mb">ap-south-1:eflop001-ghg8-987t-b229-ereff669be1</span></pre><p id="9931" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">您的联合身份池已经可以使用了。</p><p id="c6cd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">私人s3斗</strong></p><p id="abf9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这个博客最简单的部分，去你的s3控制台，创建一个具有唯一名称的s3 bucket。让您保留Block public section，这样可以保证此存储桶的私密性，并确保没有具有适当凭据的用户可以访问此存储桶上的任何对象。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es md"><img src="../Images/186bdbf3c668c5c5ec1158d5e89cbd62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bDVEgbI7gUZH15qviico4Q.png"/></div></div></figure><ul class=""><li id="976f" class="ld le hi jf b jg kb jk kc jo lf js lg jw lh ka lr lj lk ll bi translated"><em class="kj">注意:确保bucket的名称与上面创建的limitesd _ s3策略中提到的名称相同。</em></li></ul><p id="c5ef" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">λ函数用于临时凭证。</strong></p><p id="d8e6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">使用本教程第3部分中定义的IAM角色创建一个新的lambda函数，并使用python 3.7作为其运行时。</p><p id="0a62" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在Lambda控制台中复制并粘贴以下代码。</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="082b" class="lx ig hi lt b fi ly lz l ma mb">import json<br/>import boto3<br/>import hashlib<br/>import hmac<br/>import base64</span><span id="1995" class="lx ig hi lt b fi mf lz l ma mb">USER_POOL_ID = 'Your cognito user pool id'<br/>IDENTITY_POOL_ID = "Your identity pool id"</span><span id="2056" class="lx ig hi lt b fi mf lz l ma mb">PROVIDER = f'cognito-idp.ap-south-1.amazonaws.com/{USER_POOL_ID}'<br/></span><span id="2ee3" class="lx ig hi lt b fi mf lz l ma mb">def lambda_handler(event, context):</span><span id="93e1" class="lx ig hi lt b fi mf lz l ma mb">    id_token = event["id_token"]<br/>    identity_client = boto3.client('cognito-identity')</span><span id="b642" class="lx ig hi lt b fi mf lz l ma mb">    try:<br/>        identity_response = identity_client.get_id(<br/>                              IdentityPoolId=IDENTITY_POOL_ID, <br/>                              Logins = {PROVIDER: id_token})<br/>    except Exception as e:<br/>        return {"error": True, <br/>                "success": False, <br/>                "message": repr(e), <br/>                "data": None}</span><span id="122d" class="lx ig hi lt b fi mf lz l ma mb">    identity_id = identity_response['IdentityId']<br/>    </span><span id="ea45" class="lx ig hi lt b fi mf lz l ma mb">    response = identity_client.get_credentials_for_identity(<br/>                  IdentityId=identity_id,<br/>                  Logins={PROVIDER: id_token})<br/>    res = response["Credentials"]<br/>    return {'data': {<br/>                "identity_id": identity_id,<br/>                "access_key": res["AccessKeyId"], <br/>                "secret_key":  res["SecretKey"], <br/>                "session_token": res["SessionToken"]}, <br/>            "error": False, <br/>            "success": True, <br/>            "message": None}</span></pre><p id="8404" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这个函数接受一个有效的id_token作为参数，并返回用户的临时aws凭证。用户在成功登录时会收到id_token。</p><p id="4611" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">用这个Lambda函数创建一个新的API网关。现在尝试使用有效的用户id_token访问这个API端点，您将收到一个响应，其中包含一个用户临时凭证。</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="0c5b" class="lx ig hi lt b fi ly lz l ma mb">{<br/>  "data": {<br/>    "identity_id": "ap-south-1:a76dvg67-9434-ghiy-9iou-cd1hh7d30ba1",<br/>    "access_key": "BDIDSJUKMFECFICNNNNL",<br/>    "secret_key": "aOzR8byC2bkyqyCjyvuLyRlcFCkNI0/UlOsvW5tb",<br/>    "session_token": ""<br/>  },<br/>  "error": false,<br/>  "success": true,<br/>  "message": null<br/>}</span></pre><p id="1f20" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">使用这些用户凭证，用户可以访问您的存储桶中名为“AP-south-1:a 76 dvg 67–9434-ghiy-9 iou-CD 1 hh 7d 30 ba 1”的文件夹。使用此函数，用户可以在上面创建的私有存储桶中上传foldername(由用户的identity_id标识)中的任何文件。</p><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="e6f6" class="lx ig hi lt b fi ly lz l ma mb">import boto3<br/>import os</span><span id="4b61" class="lx ig hi lt b fi mf lz l ma mb">def set_aws_environment(access_key, secret_key, region):<br/>    # visible in this process + all children<br/>    os.environ['AWS_ACCESS_KEY_ID']=access_key<br/>    os.environ['AWS_SECRET_ACCESS_KEY']=secret_key  <br/>    os.environ["AWS_DEFAULT_REGION"] = region</span><span id="3164" class="lx ig hi lt b fi mf lz l ma mb">    return</span><span id="de75" class="lx ig hi lt b fi mf lz l ma mb">def put_file(access_key, secret_key, region,<br/>             identity_id, bucket_name, upload_filename_path):<br/>   filename = os.path.basename(upload_filename_path) <br/>   key_name = f"{self.identity_id}/{filename}"</span><span id="776f" class="lx ig hi lt b fi mf lz l ma mb">   metadata = {}<br/>   s3client = boto3.client('s3')<br/>   s3transfer = boto3.s3.transfer.S3Transfer(s3client)    <br/>   s3transfer.upload_file(upload_filename_path, bucket_name,<br/>                  key_name, extra_args={'Metadata': metadata})<br/>   return</span></pre><p id="081b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">尝试更改identity_id，它会向您显示身份验证错误，因为用户只允许将文件上传到他/她的文件夹名。</p><p id="fe9c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我的Eth地址:0x 01445 b 7d 9d 63381d 0e 7a 6d 8556 f 62 a 24197 bea 1f</p><p id="d50a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我的比特币地址:BC 1 qhdzydl 7 kwjk 8 rez nvj 3 yd 6s 0cg 7 e 7 r 2 SAS gfxc</p></div></div>    
</body>
</html>