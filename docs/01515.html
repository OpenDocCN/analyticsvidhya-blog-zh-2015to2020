<html>
<head>
<title>Developing in the Cloud from your local IDE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从本地IDE在云中开发</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/developing-on-a-virtual-machine-from-your-local-ide-7b26b295cccf?source=collection_archive---------2-----------------------#2019-10-28">https://medium.com/analytics-vidhya/developing-on-a-virtual-machine-from-your-local-ide-7b26b295cccf?source=collection_archive---------2-----------------------#2019-10-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="e684" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">从本地IDE中设置在虚拟机上运行的实时开发环境的演练</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/eb51202456e449bb5cc55e0e06d29e01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0QrBMv-T7Ara3hbl"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">照片由<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae jn" href="https://unsplash.com/@othentikisra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> israel palacio </a>拍摄</figcaption></figure><h1 id="54c5" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">介绍</h1><p id="0742" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">任何对大量数据建模或进行某种深度学习工作感兴趣的人都会很快达到他们本地机器的极限。一旦你写了一些代码，在一个虚拟机(VM)上执行它以获得一次性结果或者预定的<a class="ae jn" href="https://blog.cloudera.com/putting-machine-learning-models-into-production/" rel="noopener ugc nofollow" target="_blank">生产目的</a>就相对容易了。然而，在VM中进行远程开发和现场代码更改实验需要几个步骤。一个简单的解决方案是通过连接到远程机器的Jupyter或Google Colab笔记本在您的浏览器中工作。笔记本是快速一次性分析的好工具，但是<a class="ae jn" href="https://docs.google.com/presentation/d/1n2RlMdmv1p25Xy5thJUhkKGvjtV-dkAIsUXP-AL4ffI/" rel="noopener ugc nofollow" target="_blank">在软件工程最佳实践方面没有提供太多</a>。更具体地说，健壮且可重复的机器学习产品或实验<a class="ae jn" href="https://www.thoughtworks.com/insights/blog/coding-habits-data-scientists" rel="noopener ugc nofollow" target="_blank">需要比笔记本</a>更好的基础来编写生产级代码。</p><p id="b3db" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">这导致了一个简单的愿望，即希望在选择的集成开发环境(IDE)中工作，同时使用虚拟机的计算能力和资源。我很快发现RStudio和PyCham Professional都有远程开发的选项，并发现这有多难？然而，我无法找到所需的一点一滴的清晰的端到端描述。我决定为未来的自己记录这些步骤，并希望其他人会觉得有用。</p><p id="5c40" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">在这个例子中，我将使用我最喜欢的黑客编辑器<a class="ae jn" href="https://atom.io" rel="noopener ugc nofollow" target="_blank"> Atom </a>进行Python开发，该编辑器由运行在<a class="ae jn" href="https://cloud.google.com/gcp/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)上的<a class="ae jn" href="https://atom.io/packages/hydrogen" rel="noopener ugc nofollow" target="_blank"> Hydrogen </a>驱动。对于替代设置，下面的步骤应该有许多相似之处。如果你选择的武器是带有<a class="ae jn" href="https://cloud.google.com/solutions/running-rstudio-server-on-a-cloud-dataproc-cluster" rel="noopener ugc nofollow" target="_blank"> RStudio </a>、<a class="ae jn" href="https://www.jetbrains.com/devops/google-cloud/" rel="noopener ugc nofollow" target="_blank"> PyCharm </a>(或另一款JetBrains产品)的GCP，你的生活会轻松一点。</p><h1 id="1b87" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">设置虚拟机</h1><p id="2c39" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">为了与虚拟机通信，我们需要某种形式的认证。这可以用任何SSH工具来完成。在Mac上，我们可以通过终端用包含的<code class="du lh li lj lk b">ssh-keygen</code>创建一个SSH密钥对:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="e53b" class="lp jp hi lk b fi lq lr l ls lt">$ cd ~/.ssh/<br/>$ ssh-keygen -m PEM -t rsa -C "GCP_username"</span></pre><p id="3f4b" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">确保把它放在一个合理的地方(比如<code class="du lh li lj lk b">~/.ssh</code>)，给它一个文件名，然后想一个密码短语。您可以使用以下命令查看生成的公共SSH密钥:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="a3e6" class="lp jp hi lk b fi lq lr l ls lt">$ cat ~/.ssh/filename.pub</span></pre><p id="0618" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">使用bash脚本或终端命令启动虚拟机，并确保机器上安装了Jupyter:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="7231" class="lp jp hi lk b fi lq lr l ls lt">$ pip install jupyter</span></pre><p id="c47e" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">接下来，确保虚拟机接受身份验证。在您的本地计算机上，打开浏览器并转到GCP控制台。导航到您的虚拟机:计算引擎→虚拟机实例→元数据→ SSH密钥。单击edit并在字段中粘贴您的公共SSH密钥，保存它。</p><p id="6356" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">要通过外部SSH连接访问虚拟机，我们需要<a class="ae jn" href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address" rel="noopener ugc nofollow" target="_blank">为其分配一个外部IP地址</a>。单击虚拟机名称→编辑→网络接口→外部IP。不要忘记点击页面底部的保存按钮。</p><p id="58f5" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">我们可以通过从本地终端登录虚拟机来检查连接和身份验证是否正常:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="200e" class="lp jp hi lk b fi lq lr l ls lt"><a class="ae jn" href="https://gist.github.com/b7381149624599ea23f70d93637158b2" rel="noopener ugc nofollow" target="_blank">$</a> <!-- -->ssh -i ~/.ssh/place_of_ssh_keys gcp_username@external_ip_<!-- -->address</span></pre><h1 id="93ef" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">创建Jupyter内核和SSH隧道</h1><p id="bd32" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">当在终端中连接到虚拟机时，在您选择的端口上启动Jupyter内核，我使用8888。此外，没有监视器意味着我们不需要在虚拟机中启动浏览器；)</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="af65" class="lp jp hi lk b fi lq lr l ls lt">$ jupyter-notebook --no-browser --port=8888</span></pre><p id="7cba" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">为了与虚拟机上运行的Jupyter内核通信，我们使用从本地机器到虚拟机的端口转发。这可以通过创建一个<a class="ae jn" href="https://www.ssh.com/ssh/tunneling/example" rel="noopener ugc nofollow" target="_blank"> SSH隧道</a>来实现。在新的本地终端窗口中写入:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="59f1" class="lp jp hi lk b fi lq lr l ls lt">ssh -i ~/.ssh/filename -N -L localhost:8888:localhost:8888 gcp_username@external_ip_address</span></pre><p id="14a6" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">在我的例子中，没有消息出现在终端中，这可能有点混乱，只要保持终端窗口打开。</p><h1 id="424a" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">从IDE连接到内核</h1><p id="e98d" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">打开Atom，安装氢气包。转到首选项→包装→氢气→设置，并将以下内容添加到<code class="du lh li lj lk b">Kernel Gateways</code>字段:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="9fe2" class="lp jp hi lk b fi lq lr l ls lt">[{<br/>  "name": "Jupyter Remote Kernel",<br/>  "options": {"baseUrl": "http://localhost:8888"}<br/>}]</span></pre><p id="290c" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">在你的代码文件中打开Atom命令面板<code class="du lh li lj lk b">(cmd+shift+p)</code> → <code class="du lh li lj lk b">Hydrogen: Connect to Remote Kernel</code>。您的Jupyter远程内核应该会出现。在虚拟机中启动Jupyter内核时，您可以使用终端中显示的令牌进行连接。如果您在多文件项目中工作，您可以简单地用<code class="du lh li lj lk b">Hydrogen: Connect to Existing Kernel</code>将这些文件连接到内核。你可以启动<a class="ae jn" href="https://github.com/jupyter/jupyter/wiki/Jupyter-kernels" rel="noopener ugc nofollow" target="_blank">各种Jupyter内核</a>在你最喜欢的语言中工作，比如R或JavaScript。</p><p id="f0ca" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">为了在本地机器和虚拟机之间同步、编辑或上传文件，我们需要一些权限。在连接到虚拟机的终端中，转到用户帐户中的代码目录，将所有者从root更改为登录用户:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="63ad" class="lp jp hi lk b fi lq lr l ls lt">$ sudo chown -R gcp_username:gcp_username path/to/code/folder</span></pre><p id="55ea" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">您可以使用以下命令检查当前目录下所有文件夹和文件的所有权和权限:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="2105" class="lp jp hi lk b fi lq lr l ls lt">ls -l</span></pre><h1 id="7ae9" class="jo jp hi bd jq jr js jt ju jv jw jx jy io jz ip ka ir kb is kc iu kd iv ke kf bi translated">设置文件同步</h1><p id="68ec" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">为了在本地开发并在虚拟机上运行代码，我们需要实时反映代码的变化。这可以通过在本地机器和VM之间设置SSH文件同步来实现。我使用Atom包<code class="du lh li lj lk b">Remote FTP</code>，它非常好用，但是你也可以使用你选择的任何其他SSH包或软件。</p><p id="d924" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">配置软件包进行同步，我在我的<code class="du lh li lj lk b">.ftpconfig</code>文件中使用以下设置:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="cae6" class="lp jp hi lk b fi lq lr l ls lt">{<br/>    "protocol": "sftp",<br/>    "host": "external_ip_address",<br/>    "port": 22,<br/>    "user": "gcp_username",<br/>    "pass": "",<br/>    "promptForPass": false,<br/>    "remote": "path/to/remote/code/folder/on/vm",<br/>    "local": "path/to/local/code/folder",<br/>    "agent": "",<br/>    "privatekey": "~/.ssh/filename",<br/>    "passphrase": "your_passphrase",<br/>    "hosthash": "",<br/>    "ignorehost": true,<br/>    "connTimeout": 10000,<br/>    "keepalive": 10000,<br/>    "keyboardInteractive": false,<br/>    "keyboardInteractiveForPass": false,<br/>    "remoteCommand": "",<br/>    "remoteShell": "",<br/>    "watch": [],<br/>    "watchTimeout": 500<br/>}</span></pre><p id="d998" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">您可以在保存时启用文件同步，这将实时反映您的代码从本地到虚拟机的所有更改，以便进行实时开发。</p><p id="c89c" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">就这样，你可以走了！</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><h1 id="8a3c" class="jo jp hi bd jq jr mb jt ju jv mc jx jy io md ip ka ir me is kc iu mf iv ke kf bi translated">多方面的</h1><p id="206f" class="pw-post-body-paragraph kg kh hi ki b kj kk ij kl km kn im ko kp kq kr ks kt ku kv kw kx ky kz la lb hb bi translated">如果您想更频繁地这样做，您可以让自己的生活更轻松，并在您的<code class="du lh li lj lk b">~/.bashrc</code>文件中添加一些别名来加速终端命令。例如:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="d2dd" class="lp jp hi lk b fi lq lr l ls lt">alias gcp_ssh = '<!-- -->ssh -i ~/.ssh/filename gcp_username@external_ip_<!-- -->address'</span><span id="8f50" class="lp jp hi lk b fi mg lr l ls lt">alias port_forward = 'ssh -i ~/.ssh/filename -N -L localhost:8888:localhost:8888 gcp_username@external_ip_address'</span><span id="8f4e" class="lp jp hi lk b fi mg lr l ls lt">alias give_me_the_power = '<!-- -->sudo chown -R gcp_username:gcp_username path/to/code/folder'</span></pre><p id="a963" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">重新启动虚拟机后，如果出现与已验证主机相关的验证错误，您可以通过删除<code class="du lh li lj lk b">known_hosts</code>文件并再次登录到机器来重新生成该文件:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="849e" class="lp jp hi lk b fi lq lr l ls lt">$ cd ~/.ssh/<br/>$ rm -f known_hosts<br/>$ <!-- -->ssh -i ~/.ssh/filename gcp_username@external_ip_<!-- -->address</span></pre><p id="c41d" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">如果您想将Python项目作为一个包运行或导入，您可以通过虚拟机上的pip安装本地代码:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="f41d" class="lp jp hi lk b fi lq lr l ls lt">$ cd path/to/code/folder<br/>$ python3 -m pip install -e .</span></pre><p id="92f7" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">您可以通过浏览器中的<code class="du lh li lj lk b">localhost:8888</code>并使用您的令牌或密码登录，通过本地机器上的Jupyter内核浏览虚拟机上的文件夹结构。您可以使用<code class="du lh li lj lk b">gcloud</code>命令或任何SSH客户端将文件夹和文件从虚拟机下载回您的本地机器。</p><p id="e38d" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">您也可以从Jupyter浏览器下载到本地。如果你想下载完整的文件夹，而不仅仅是文件，你可以启动一个终端窗口。新建→终端:</p><pre class="iy iz ja jb fd ll lk lm ln aw lo bi"><span id="2098" class="lp jp hi lk b fi lq lr l ls lt">$ zip -r path/to/folder name_of_zipfile</span></pre><p id="95e7" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">这将为您的文件夹创建一个zip文件，您可以像其他文件一样通过笔记本用户界面选择和下载该文件。</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><p id="2fee" class="pw-post-body-paragraph kg kh hi ki b kj lc ij kl km ld im ko kp le kr ks kt lf kv kw kx lg kz la lb hb bi translated">如果你遇到任何问题，请随时给我留言！</p></div></div>    
</body>
</html>