# é€šè¿‡ Docker Swarm çš„ç¼–æ’è®¾ç½®æ°”æµè¿è¡Œ

> åŸæ–‡ï¼š<https://medium.com/analytics-vidhya/setting-up-airflow-to-run-with-docker-swarms-orchestration-b16459cd03a2?source=collection_archive---------4----------------------->

## è®¾ç½®å¯é è°ƒåº¦ç¨‹åºçš„ä»£ç ç‰‡æ®µ

ä¸ä¹…å‰ï¼Œæˆ‘åœ¨[ä¸Šå‘å¸ƒäº†ä¸€ä¸ªæ•…äº‹](/analytics-vidhya/orchestrating-airflow-tasks-with-docker-swarm-69b5fb2723a7),æè¿°äº†å¦‚ä½•ä½¿ç”¨æ°”æµå’Œå®¹å™¨ç¼–æ’å±‚(æ¯”å¦‚ Docker Swarm)æ¥æ„å»ºå¼¹æ€§ä»»åŠ¡è°ƒåº¦å™¨ã€‚åœ¨è¿™ä¸ªæ•…äº‹ä¸­ï¼Œæˆ‘æƒ³åˆ†äº«å¯åŠ¨å’Œè¿è¡Œå®ƒæ‰€éœ€è¦çš„æç®€ä»£ç ã€‚æˆ‘ä»¬å°†è®¾ç½®æ°”æµæ¥è¿è¡Œ Docker Swarm ä¸Šçš„ä»»åŠ¡ã€‚å¯¹äºä¸ç†Ÿæ‚‰ Airflow æˆ– Docker Swarm çš„è¯»è€…ï¼Œæˆ‘å»ºè®®å…ˆçœ‹çœ‹[ä¹‹å‰çš„æ•…äº‹](/analytics-vidhya/orchestrating-airflow-tasks-with-docker-swarm-69b5fb2723a7)ã€‚

**åœ¨æœ¬æ–‡ç»“æŸæ—¶ï¼Œæ‚¨å°†æ‹¥æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Airflow å®ä¾‹ï¼Œå®ƒçš„ä»»åŠ¡å¯ä»¥åœ¨ä»»ä½•å…·æœ‰è¶³å¤Ÿèµ„æºçš„æœåŠ¡å™¨ä¸Š(ä»æ‚¨çš„æœåŠ¡å™¨æ± ä¸­)è‡ªåŠ¨è¿è¡Œã€‚å¦‚æœä½ åªæ˜¯æƒ³å­¦ä¹ è®¾ç½®æ°”æµå¹¶åœ¨å…¶ä¸Šè¿è¡Œä»»åŠ¡ï¼Œè¿™å¯èƒ½ä»ç„¶æ˜¯ä¸€ä¸ªå¥½åœ°æ–¹ã€‚**

# å†…å®¹

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†è¦éµå¾ªçš„æ­¥éª¤ã€‚å®‰è£… Docker(éš *Docker Swarm* å†…ç½®)
2ã€‚å»ºç«‹ä¸€ä¸ª Docker é›†ç¾¤
3ã€‚å®‰è£…æ°”æµ
4ã€‚åœ¨ Docker Swarm ä¸Šåˆ©ç”¨æ°”æµè¿è¡Œæ‚¨çš„ä»»åŠ¡

æ‰€ä»¥è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

# å®‰è£… Docker

è¿™æ˜¯å”¯ä¸€ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä¸ä¼šè¯´å¤ªå¤šç»†èŠ‚ï¼Œå› ä¸ºå®ƒéå¸¸ä¾èµ–äºæ“ä½œç³»ç»Ÿï¼Œå¹¶ä¸”å·²ç»åœ¨[https://docs.docker.com/install/#supported-platforms](https://docs.docker.com/install/#supported-platforms)åšäº†å¾ˆå¥½çš„è®°å½•ã€‚å¦‚æœä½ åœ¨å®‰è£…æ—¶ä»ç„¶å‘ç°ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶åœ¨è¯„è®ºä¸­æˆ–åœ¨ [Stackoverflow](https://stackoverflow.com/) ä¸Šé—®æˆ‘ã€‚

ä¸€æ—¦æ‚¨çš„ç³»ç»Ÿä¸Šè¿è¡Œäº† Docker(æˆ–è€…å·²ç»è¿è¡Œäº† Docker ),å¹¶ä¸”å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè®¿é—®å®ƒï¼Œæ‚¨å°±å¯ä»¥è·³åˆ°ä¸‹ä¸€èŠ‚ã€‚

# å»ºç«‹ Docker ç¾¤é›†ç¾¤

ä»æ‚¨çš„ç»ˆç«¯ï¼Œè¿è¡Œè¿™ä¸ªå‘½ä»¤â€”***docker swarm init***

å½“æ‚¨è¿è¡Œä¸‹é¢ç»™å‡ºçš„å‘½ä»¤æ—¶ï¼Œç°åœ¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ç¾¤é›†ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹:

> åœé èŠ‚ç‚¹ ls

![](img/a994075e49019f1579d6c552b32a4c62.png)

å…·æœ‰ 1 ä¸ªèŠ‚ç‚¹çš„ Docker ç¾¤é›†

## å‘ç¾¤é›†ä¸­æ·»åŠ æ›´å¤šèŠ‚ç‚¹(å¯é€‰)

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª Docker Swarm é›†ç¾¤ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¶³ä»¥çœ‹åˆ°å®é™…æƒ…å†µï¼Œæ‰€ä»¥æ‚¨å¯ä»¥è·³è¿‡è¿™ä¸€æ­¥ã€‚
å¦‚æœæ‚¨æœ‰æ›´å¤šçš„èŠ‚ç‚¹(æœåŠ¡å™¨)å¹¶å¸Œæœ›çœ‹åˆ°ç¼–æ’å±‚(Docker Swarm)åšä¸€äº›â€œçœŸæ­£çš„â€å·¥ä½œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¹‹å‰è¿è¡Œçš„â€œ*initâ€*å‘½ä»¤(ä¾‹å¦‚å¯¹äº`docker swarm join --token SWMTKN-some-long-string-token-here some-ip-or-hostname-here:2377`)å¾—åˆ°çš„å‘½ä»¤å‘ Docker Swarm é›†ç¾¤æ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹ã€‚ä¸€æ—¦æ‚¨å‘ Swarm é›†ç¾¤æ·»åŠ æ›´å¤šçš„ workersï¼Œæ‚¨å°†ä¼šçœ‹åˆ°å‘½ä»¤`docker node ls`è¿”å›æ›´å¤šçš„èŠ‚ç‚¹ã€‚

# å®‰è£…æ°”æµ

å› ä¸ºæˆ‘ä»¬å·²ç»å®‰è£…äº† Dockerï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿è¡Œæ°”æµçš„ Docker æ˜ åƒï¼Œå¹¶è®©å®ƒå¯åŠ¨å’Œè¿è¡Œã€‚è¿˜æœ‰ä¸€ä¸ª PostgreSQL å®ä¾‹ï¼Œæˆ‘ä»¬å°†è¿è¡Œå®ƒæ¥å­˜å‚¨ Airflow çš„å…ƒæ•°æ®(æ”¯æŒè®¸å¤šå…¶ä»–æ•°æ®åº“)ã€‚ä¸ºæ­¤ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:

> mkdir air flow-swarm-operator-blog
> CD air flow-swarm-operator-blog/
> curl-XGET[https://gist . githubusercontent . com/akki/CD 89 c 9 caff 5 BF 19454 CDF 913 CEB 59 c 32/raw/085 F4 f 538 c 2d 48 e 01d 7789 aa 8701 f 9f 00 e 3a 0 a 81/stack . yml](https://gist.githubusercontent.com/akki/cd89c9caff5bf19454cdf913ceb59c32/raw/085f4f538c2d48e01d7789aa8701f9f00e3a0a81/stack.yml)>>stack . ymlã€T11

**æ³¨æ„:** Windows ç”¨æˆ·å¯èƒ½éœ€è¦å°†`stack.yml`æ–‡ä»¶(ç”±ä¸Šè¿°å‘½ä»¤åˆ›å»º)[ä¸­çš„`/var/run/docker.sock:/var/run/docker.sock`æ›´æ”¹ä¸º`//var/run/docker.sock:/var/run/docker.sock`ï¼Œå¦‚è¿™é‡Œæ‰€è¿°](https://stackoverflow.com/a/41005007/3061686)ã€‚

æ‚¨åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡º(ç¡®ä¿æ‚¨æ²¡æœ‰çœ‹åˆ°ä»»ä½•é”™è¯¯):

![](img/87cab3126ed4a37b84d37923452ef67c.png)

éƒ¨ç½² Docker å †æ ˆåçš„è¾“å‡º

ç®€å•åœ°è¯´ï¼Œæˆ‘ä»¬åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ª Docker å †æ ˆæ–‡ä»¶å¹¶éƒ¨ç½²äº†å®ƒã€‚è¿™å°†å¯åŠ¨ 2 ä¸ª Docker æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¡®è®¤:

> ç å¤´æœåŠ¡

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¾“å‡ºåº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

![](img/520eea5a2a58cfee5149cdf7f311a680.png)

æ°”æµå’Œé‚®èˆ¹åœ¨ç å¤´ç¾¤ä¸­è¿è¡Œ

æ­¤å¤–ï¼Œæ‚¨ç°åœ¨åº”è¯¥èƒ½å¤Ÿåœ¨ [http://localhost:18080](http://localhost:18080) çœ‹åˆ° Airflow æ¼‚äº®çš„ç”¨æˆ·ç•Œé¢ã€‚

# Docker Swarm ä¸­çš„ä»»åŠ¡è°ƒåº¦

æ—¢ç„¶æˆ‘ä»¬å·²ç»è®¾ç½®å¹¶è¿è¡Œäº†æ°”æµï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åœ¨ Docker Swarm ä¸Šè¿è¡Œæˆ‘ä»¬çš„æ°”æµä»»åŠ¡ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœä½ æ˜¯ Docker Swarm çš„æ–°æ‰‹ï¼Œé‚£ä¹ˆåœ¨ Swarm ä¸­ï¼Œæ‰€æœ‰çš„å®¹å™¨éƒ½ä½œä¸ºä¸€ä¸ªâ€œæœåŠ¡â€è¿è¡Œï¼Œæ‰€ä»¥æ— è®ºä½ è®¡åˆ’è¿è¡Œä»€ä¹ˆä»»åŠ¡(åœ¨ Airflow ä¸­ç§°ä¸º DAG ),éƒ½å°†ä½œä¸ºä¸€ä¸ª Docker æœåŠ¡è¿è¡Œã€‚

## ä½¿ç”¨ DockerSwarmOperator æ·»åŠ  DAG

ç”±äº Airflow åœ¨ Docker å®¹å™¨ä¸­è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦**å°† DAG æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨**ä¸­ï¼Œä»¥ä¾¿å°† DAG æ·»åŠ åˆ° Airflow ä¸­ã€‚ä¸ºæ­¤ï¼Œåªéœ€éµå¾ªä»¥ä¸‹æ­¥éª¤:

1.  é€šè¿‡è¿è¡Œ`curl -XGET [https://gist.githubusercontent.com/akki/4c95805ce1617e2765fecb73bb98230c/raw/cf58ec0391957d50f5ae548f7f618a58c9395156/example_dockerswarmoperator.py](https://gist.githubusercontent.com/akki/4c95805ce1617e2765fecb73bb98230c/raw/cf58ec0391957d50f5ae548f7f618a58c9395156/example_dockerswarmoperator.py) >> example_dockerswarmoperator.py`ä¸‹è½½ DAG æ–‡ä»¶ã€‚
2.  åœ¨æ‚¨çš„ç»ˆç«¯ä¸­è¿è¡Œ`docker ps`ã€‚
3.  æŸ¥æ‰¾å®¹å™¨å`airflow_pod`ï¼Œå¹¶åœ¨ä¸Šä¸€æ­¥çš„å‘½ä»¤ä¸­å¤åˆ¶å…¶å®¹å™¨ id(ä¸‹å›¾ä¸­é«˜äº®æ˜¾ç¤º)ã€‚

![](img/152d44e6e21197236fe1796f3480a53c.png)

æ°”æµå †æ ˆè¿è¡Œæ—¶â€œdocker psâ€å‘½ä»¤çš„ç»“æœ

4.è¿è¡Œ`docker cp example_dockerswarmoperator.py <copy-container-id-here>:/root/airflow/dags/example_dockerswarmoperator.py`ã€‚ç¡®ä¿ä½ æ²¡æœ‰é”™è¯¯ã€‚

5.ç°åœ¨å†æ¬¡åˆ·æ–°[UI](http://localhost:18080)â€”â€”åœ¨å‡ åˆ†é’Ÿå†…(é€šå¸¸ä¸º 3-5 åˆ†é’Ÿ),æ‚¨åº”è¯¥ä¼šåœ¨ UI ä¸­çœ‹åˆ°æ‚¨çš„ DAGã€‚ç¥è´ºæ‚¨â€”æ‚¨çš„ DAG ç°åœ¨æ­£åœ¨æ°”æµä¸­è¿è¡Œï¼ğŸ‘

![](img/2564fd3ba1b162d7338eef2625468c3c.png)

DAG æ·»åŠ åˆ°æ°”æµä¸­

## ç¡®è®¤ä½ çš„ä»»åŠ¡æ­£åœ¨ Docker Swarm ä¸Šè¿è¡Œ

åŸæ¥å¦‚æ­¤ï¼ä½ åˆšåˆšåœ¨ Docker Swarm ä¸Šè¿è¡Œäº†ä½ çš„ç¬¬ä¸€ä¸ªæ°”æµä»»åŠ¡ã€‚

ä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆèƒ½ç¡®å®šå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨æ„åˆ°å½“æˆ‘ä»¬è§¦å‘æˆ‘ä»¬çš„æ°”æµä»»åŠ¡æ—¶ï¼Œä¸€ä¸ªæ–°çš„ Docker æœåŠ¡å¯åŠ¨æ¥ç¡®è®¤è¿™ä¸€ç‚¹ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹:

1.  é€šè¿‡ç‚¹å‡»â€œè§¦å‘ DAGâ€æŒ‰é’®ï¼Œå³â€œé“¾æ¥â€éƒ¨åˆ†ä¸‹çš„â€œæ’­æ”¾â€æŒ‰é’®ï¼Œé€šè¿‡ Airflow UI å¯åŠ¨(è§¦å‘)æ‚¨çš„ä»»åŠ¡ã€‚

![](img/2c77fee09586a45964a9fb489451d8f5.png)

è§¦å‘ Dag æŒ‰é’®

2.ç¡®è®¤æ‚¨çš„ä»»åŠ¡æ­£åœ¨æ°”æµä¸­è¿è¡Œï¼Œå³æœ‰ä¸€ä¸ªçŠ¶æ€ä¸ºâ€œæ­£åœ¨è¿è¡Œâ€çš„ä»»åŠ¡ã€‚

![](img/f9f733b7b836480d41e52742d57fa6d0.png)

æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡çš„æ°”æµ DAG(æµ…ç»¿è‰²åœ†åœˆè¡¨ç¤ºâ€œæ­£åœ¨è¿è¡Œâ€)

3.è½¬åˆ°ç»ˆç«¯å¹¶è¿è¡Œ`docker service ls` â€”å‡ ç§’é’Ÿåï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ä¸€ä¸ªæ–°çš„æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå…¶åç§°çš„å½¢å¼ä¸º- > `airflow-<8-character-random-string>`ã€‚(æ³¨æ„æœåŠ¡åªè¿è¡Œ 45 ç§’ï¼Œæ‰€ä»¥ä¹‹åï¼Œä½ çš„æœåŠ¡å°±ä¼šç»ˆæ­¢ï¼Œä»è¿™é‡Œæ¶ˆå¤±)ã€‚

![](img/5c8821bdc71de8a577b0b1744304a494.png)

æ°”æµä»»åŠ¡ä½œä¸º Docker æœåŠ¡è¿è¡Œã€‚

è¿™å°±å¯¹äº†ã€‚æ‚¨çš„ä»»åŠ¡ä½œä¸º Docker æœåŠ¡è¿è¡Œã€‚å¦‚æœæ‚¨åœ¨ Docker Swarm é›†ç¾¤ä¸­æ·»åŠ äº†å¤šä¸ªèŠ‚ç‚¹(å¦‚å‰é¢å¯é€‰æ­¥éª¤ä¸­æ‰€è¿°)ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªèŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼Œæ‚¨ä¼šçœ‹åˆ°å®ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚

æ­¤å¤–ï¼Œå¦‚æœæ‚¨ç†Ÿæ‚‰ Airflowï¼Œæ‚¨å¯ä»¥æ‰“å° DAG ä¸­çš„ä¸€äº›å†…å®¹ï¼Œç„¶å[æ£€æŸ¥å®ƒæ˜¯å¦æ˜¾ç¤ºåœ¨ Airflow DAG çš„æ—¥å¿—ä¸­](https://stackoverflow.com/a/60584746/3061686)ã€‚

# å…³é—­ä¸€åˆ‡

å¦‚æœæ‚¨æƒ³åœæ­¢æˆ‘ä»¬å¼€å§‹çš„ä¸€åˆ‡ï¼Œä»¥ä¸‹æ˜¯å®ç°è¿™ä¸€ç›®çš„çš„å‘½ä»¤:

1.  ç§»é™¤ Docker å †æ ˆ

> ç å¤´å †æ ˆ rm æ°”æµ

2.ç¡®ä¿æ²¡æœ‰ä»»ä½•æœåŠ¡æ­£åœ¨è¿è¡Œ

> ç å¤´æœåŠ¡

3.ç¦»å¼€ç å¤´ç¾¤é›†ç¾¤

> ç å¤´å·¥äººæˆç¾¤ç»“é˜Ÿç¦»å»

4.æˆ–è€…ï¼Œåˆ é™¤ä¸ºæ­¤åšå®¢åˆ›å»ºçš„ç›®å½•

> æ¿€å…‰å”±ç‰‡..&& rm -r æ°”æµ-ç¾¤ä½“-æ“ä½œå‘˜-åšå®¢

# ç»“è®º

åœ¨è¿è¡Œå®Œæ‰€æœ‰è¿™äº›æ­¥éª¤ä¹‹åï¼Œä½ åº”è¯¥èƒ½å¤Ÿé€šè¿‡`DockerSwarmOperator`åœ¨ Docker Swarm ä¸­è¿è¡Œä½ çš„ Airflow ä½œä¸šäº†([å‚è§è¿™ä¸ª](/analytics-vidhya/orchestrating-airflow-tasks-with-docker-swarm-69b5fb2723a7)ä»¥äº†è§£æ›´å¤šä¿¡æ¯)ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ä¸‹é¢çš„è¯„è®ºä¸­æå‡ºæ¥ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œæˆ‘å¾ˆä¹æ„å¸®å¿™ã€‚

å¯¹äºä»»ä½•å¥½å¥‡çš„äººæ¥è¯´ï¼Œè¿™é‡Œæ˜¯ akkidx/airflow çš„ docker file:blog 1â€”[https://gist . github . com/akki/55 EAE 196 b 05377 BD 7b 3031d 9 c 16 BC 6](https://gist.github.com/akki/55eae1e196b05377bd7b3031d9c16bc6)ã€‚