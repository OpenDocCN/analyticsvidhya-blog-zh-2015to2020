<html>
<head>
<title>How To Deploy 3 Node MongoDB Shard Cluster On AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS上部署3节点MongoDB Shard集群</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-deploy-3-node-mongodb-shard-cluster-on-aws-2bf2fd821e5?source=collection_archive---------2-----------------------#2020-05-04">https://medium.com/analytics-vidhya/how-to-deploy-3-node-mongodb-shard-cluster-on-aws-2bf2fd821e5?source=collection_archive---------2-----------------------#2020-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/289be74bf48a07675e85947d67637d36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JpxdKjW5kAKxDxeF"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">萨法尔·萨法罗夫在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c5a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本教程中，我们将在AWS中部署一个MongoDB分片集群。您可以尝试使用本教程将分片集群部署到任何云中，只需稍作修改。</p><p id="65ec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">目前，根据MongoDB指南，您需要3个节点作为配置服务器副本集，至少3个分片节点，其中每个节点是3个成员副本集和一个或多个mongos服务器。</p><p id="74b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据官方文件，我们需要以下基础设施:</p><ol class=""><li id="e28b" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">配置服务器的3个AWS EC2实例(3节点副本集)</li><li id="3c50" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">9个AWS EC2实例，用于部署3个分片，其中每个分片都有一个由3个节点组成的副本集</li><li id="7816" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">mongos的1个AWS EC2实例</li></ol><p id="7ccc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是对于本教程，我们将使用下面的基础设施部署shard集群:</p><ol class=""><li id="3f45" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">配置服务器的1个AWS EC2实例(1个节点副本集)</li><li id="fb38" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">2个AWS EC2实例，用于部署2个分片，其中每个分片都有一个节点的副本集</li><li id="f5f1" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">mongos的1个AWS EC2实例</li></ol><p id="49fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么让我们开始吧—</p><h1 id="cbc4" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">配置服务器</h1><p id="cfec" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在分片集群中，每个操作/查询都有特定的元数据存储在其中，这些元数据决定了数据存储的路径以及MongoDB的读写操作。</p><p id="0b6e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">配置服务器是一个关键的数据库，它保存着操作分片集群的元数据信息</p><p id="cdff" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">部署:——</strong>配置服务器需要部署在3节点副本集中，并且必须使其成为副本集。在本教程中，我们将部署一个单节点副本集。</p><h1 id="afdc" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">蒙哥斯</h1><p id="2b54" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">Mongos是一个作为主要主机工作的路由器，您可以使用MongoDB客户端库在具有任意数量Mongos主机的分片集群上运行。</p><p id="742b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">部署:——</strong>配置服务器可以连接多个mongos路由器。因为他们没有自己的数据库。它们与配置服务器通信以操作分片集群。</p><p id="49bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">拥有多台mongos服务器有助于在一台mongos服务器停机的情况下，客户端将使用另一台mongos服务器来查询集群。所有mongodb客户端库都支持多个mongos主机。</p><h1 id="e285" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">陶瓷或玻璃碎片</h1><p id="6f17" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">碎片是包含数据库和收集数据的mongod实例。数据的分发由配置服务器根据mongos服务器配置的分片密钥来决定。</p><p id="e917" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">部署:——</strong>根据MongoDB的指导方针，我们需要每个分片有一个3节点副本集。为简单起见，我们将在这里创建两个带有1个节点副本集的碎片。</p><p id="a590" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以选择任何你想要的云(AWS/Oracle/AZure等)。对于本文，我们将使用AWS。</p><h1 id="0db5" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">创建3个Ubuntu实例并命名为</h1><ol class=""><li id="bc65" class="jt ju hi ix b iy lf jc lg jg lk jk ll jo lm js jy jz ka kb bi translated">配置服务器/mongos的1个服务器实例(config_instance)</li><li id="ba24" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">2台服务器用于分片(分片1 _实例/分片2 _实例)</li></ol><h1 id="f39d" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">MongoDB安装:</h1><p id="c7a6" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">可以遵循MongoDB指南—<a class="ae iu" href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" rel="noopener ugc nofollow" target="_blank">https://docs . MongoDB . com/manual/tutorial/install-MongoDB-on-Ubuntu/</a></p><p id="e46d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> MongoDB版本:</strong></p><p id="e114" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您试图将任何类型的数据恢复到分片集群中，您必须小心谨慎。由于事务支持，mongorestore在4.2.x以上无法工作</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="83bd" class="lw ki hi ls b fi lx ly l lz ma">** Notes on MongoDB site - <a class="ae iu" href="https://docs.mongodb.com/manual/reference/program/mongodump/#bin.mongodump" rel="noopener ugc nofollow" target="_blank">mongodump</a> and <a class="ae iu" href="https://docs.mongodb.com/manual/reference/program/mongorestore/#bin.mongorestore" rel="noopener ugc nofollow" target="_blank">mongorestore</a> <strong class="ls hj">cannot</strong> be part of a backup strategy for 4.2+ sharded clusters that have sharded transactions in progress, as backups created with <a class="ae iu" href="https://docs.mongodb.com/manual/reference/program/mongodump/#bin.mongodump" rel="noopener ugc nofollow" target="_blank">mongodump</a> <em class="mb">do not maintain</em> the atomicity guarantees of transactions across shards.</span></pre><h1 id="8446" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">安装程序</h1><ol class=""><li id="644f" class="jt ju hi ix b iy lf jc lg jg lk jk ll jo lm js jy jz ka kb bi translated">Ssh到config_instance并从给定的链接安装MongoDB。MongoDB将在/etc/mongod.conf位置放置一个配置文件</li><li id="d443" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">打开/etc/mongod.conf文件，通过更改属性dbPath和systemLog path来更改数据目录或日志目录。如果您正在更改默认目录，不要忘记使用下面的命令将所有权授予在mongodb安装期间由创建的mongodb用户</li></ol><p id="7a21" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">sudo chown mongodb:mongodb /volume_paths -R</code></p><p id="ceb4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.安装后，使用命令运行mongod服务</p><p id="71da" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">sudo service mongod restart</code></p><p id="e014" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.如果您想继续使用密钥文件安全性，让我们也创建一个密钥文件</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="6557" class="lw ki hi ls b fi lx ly l lz ma">openssl rand - base64 756 &gt; /home/ &lt; userename &gt; /<br/>chmod 400 shardauthkey</span></pre><p id="b97e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.现在在你选择的vim/nano等文本编辑器中打开/etc/mongod.conf。并将下面的设置复制到/etc/mongod.conf文件的底部</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="1a5a" class="lw ki hi ls b fi lx ly l lz ma">sharding:<br/> clusterRole: configsvr<br/>replication:<br/> replSetName: config<br/>net:<br/> bindIp: 0.0.0.0</span></pre><p id="aa9a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.我们已经声明了服务器集群角色，并在mongodb配置中设置了副本集名称。</p><p id="a711" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">7.让我们重新启动mongod服务。重启后，让我们进入mongod shell</p><p id="5356" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">8.使用下面的命令进入mongod shell。这里的端口是27017，这是在mongod.conf文件中配置的默认端口</p><p id="fbb1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongod --port=27017</code></p><p id="1f02" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">9.mongod shell打开后，输入以下命令</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="93ab" class="lw ki hi ls b fi lx ly l lz ma">{<br/>    _id: "config",<br/>    configsvr: true,<br/>    members: [{<br/>        _id: 0,<br/>        host: "&lt;interanl/elastic_ip_of_config_server&gt;:27017"<br/>    }, ]<br/>}</span></pre><p id="0b2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将看到一个副本集已经启动。我们现在已经启动了一个单节点副本集。如果需要，可以在副本集中添加更多实例。过一会儿你会看到外壳变成了初级。</p><p id="a5f5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">10.现在设置一个默认用户进行认证，这是非常重要的。打开mongo shell后输入命令</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="976b" class="lw ki hi ls b fi lx ly l lz ma">use admin<br/>db.createUser({<br/>    user: "config",<br/>    pwd: "config@123",<br/>    roles: [{<br/>        role: "root",<br/>        db: "admin"<br/>    }]<br/>})</span></pre><p id="6e2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">11.退出终端，现在使用下面的命令再次进入mongo shell:</p><p id="a8e3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongo --port=2707 -u config -p config@123 --authenticationDatabase=admin</code></p><p id="635f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">12.再次打开配置文件/etc/mongod.conf，并在文件底部添加以下行</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="ed4b" class="lw ki hi ls b fi lx ly l lz ma">security:<br/> keyfile: /home/&lt;username&gt;/shardauthkey</span></pre><p id="27ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">重新启动mongod服务。我们已经设置了我们的配置服务器。</p><h1 id="32cd" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">分片服务器:</h1><p id="6e1e" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated"><strong class="ix hj">碎片-1: </strong></p><ol class=""><li id="1dea" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">Ssh到我们在本教程开始时创建的shard1_instance和shard2_instance。您可以用下面提到的相同步骤设置两个碎片</li><li id="4a8d" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">按照本文开头的定义安装MongoDB</li><li id="fdd8" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">从配置服务器复制密钥文件，将其放在两个shard实例的用户主目录中</li><li id="25a5" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">给密钥文件适当的权限。我们需要在我们的分片集群中使用这个密钥文件，所以给它所需的权限，以便可以使用它</li></ol><p id="71dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">sudo chown 400 /home/&lt;username&gt;/shardauthkey</code></p><p id="44f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.在任何文本编辑器中再次打开/etc/mongod.config文件，并放置在文件底部的行下面。</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="56ed" class="lw ki hi ls b fi lx ly l lz ma">sharding:<br/> clusterRole: shardsvr<br/>replication:<br/> replSetName: shard1<br/>net:<br/> bindIp: 0.0.0.0</span></pre><p id="bcfb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于shard2，为了方便起见，只需将副本集的名称更改为shard2</p><p id="558c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.现在用下面的命令进入mongod shell</p><p id="2bed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongod --port=27017</code></p><p id="027c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">7.启动副本集。它是一个单节点副本集。如果你愿意，添加更多服务器到这个碎片</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="74a6" class="lw ki hi ls b fi lx ly l lz ma">rs.initiate({<br/>    _id: "shardsvr",<br/>    members: [{<br/>        _id: 0,<br/>        host: "elastic_ip/public_ip/private_ip&gt;:27018"<br/>    }, ]<br/>})</span></pre><p id="131d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">8.几秒钟后，你会看到mongod外壳变成主要的</p><p id="ccc9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">9.运行以下命令并在此创建验证用户</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="d3f0" class="lw ki hi ls b fi lx ly l lz ma">use admin<br/>db.createUser({<br/>    user: "shard",<br/>    pwd: "shard@123",<br/>    roles: [{<br/>        role: "root",<br/>        db: "admin"<br/>    }]<br/>})</span></pre><p id="e32e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">10.再次打开配置文件/etc/mongod.conf，并在文件底部添加以下行</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="5ca2" class="lw ki hi ls b fi lx ly l lz ma">security:<br/>    keyfile: /home/ &lt; username &gt; /shardauthkey</span></pre><p id="763d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">11.我们还添加了keyfile，它是从最初创建它的配置服务器上复制的</p><p id="d708" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">12.现在重启mongod，用下面的命令进入shell</p><p id="b1e6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongo --port=2707 -u shard -p shard@123 --authenticationDatabase=admin</code></p><p id="0d19" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成的</p><p id="51d8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们完成了初始设置。但主要问题是我们如何使每个节点能够相互通信。</p><h1 id="c9ca" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">网络调节</h1><ol class=""><li id="5c61" class="jt ju hi ix b iy lf jc lg jg lk jk ll jo lm js jy jz ka kb bi translated">配置服务器:config_server需要直接访问端口27017上的<shar_1_ip>和端口27017上的<shard_2_ip>。</shard_2_ip></shar_1_ip></li><li id="d2e5" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">碎片服务器需要与配置服务器通信，因此它们需要访问端口27017上的<config_server_ip/></li></ol><p id="5af2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> AWS </strong></p><p id="054b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我将解释AWS。您可以在任何云中以类似的方式进行设置</p><p id="de0f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><shard_1_ip>:(可以是弹性IP/内部IP)使用internal_ip更安全</shard_1_ip></p><p id="5492" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><shard_2_ip>:(可以是弹性IP/内部IP)使用internal_ip更安全</shard_2_ip></p><p id="a5e5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><config_server_ip>:(可以是弹性IP/内部IP)使用internal_ip获得更好的安全性</config_server_ip></p><ol class=""><li id="c76a" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">在AWS上的shard server的安全组中，在端口27017上授予config_server_ip入站权限。</li><li id="1d07" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">在AWS上配置服务器的安全组中，将入站权限授予端口27017上的shard_1_ip和shard_2_ip</li></ol><p id="cb4e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在某些服务器上，您需要编辑防火墙规则。继续以同样的方式编辑</p><p id="b57d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们的集群已经准备好开始相互通信了</p><h1 id="e734" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">蒙古人:</h1><ol class=""><li id="224e" class="jt ju hi ix b iy lf jc lg jg lk jk ll jo lm js jy jz ka kb bi translated">Ssh到配置实例</li><li id="709c" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">在/etc/中创建mongos.conf文件</li></ol><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="6ade" class="lw ki hi ls b fi lx ly l lz ma">systemLog:<br/> destination: file<br/> logAppend: true<br/> path: &lt;log file directory&gt;<br/>net:<br/> port: 27020<br/> bindIp: 0.0.0.0<br/>processManagement:<br/> timeZoneInfo: /usr/share/zoneinfo<br/>sharding:<br/> configDB: config/&lt;inter/public/elasticip/&gt;:27017<br/>security:<br/> keyFile: /home/&lt;username&gt;/shardauthkey</span></pre><p id="298e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.现在运行mongos</p><p id="66e0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongos —config /etc/mongos.conf</code></p><p id="877f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.为了不间断地运行mongos，我们需要像mongod一样守护mongos。在最新的ubuntu版本中，可以为mongos添加systemctl服务。或者，如果您想使用，也可以使用supervisor。</p><p id="c41f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.现在使用下面的命令登录mongos。我们已经在mongo命令中更改了端口，因为配置服务器运行在端口27017上，而mongos运行在端口27020上</p><p id="c993" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongo --port=27020 -u shard -p shard@123 --authenticationDatabase=admin</code></p><p id="ce22" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.一旦你进入mongo shell，你就可以添加碎片到集群了。</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="bc3c" class="lw ki hi ls b fi lx ly l lz ma">sh.addShard( "shard_1&lt;public/private/elasticip&gt;:27017")<br/>sh.addShard( "shard_2&lt;public/private/elasticip&gt;:27017")</span></pre><p id="4f86" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">7.添加一个新用户来提供对mongodb客户端的访问</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="eea7" class="lw ki hi ls b fi lx ly l lz ma">use admin</span><span id="c099" class="lw ki hi ls b fi mf ly l lz ma">db.createUser({</span><span id="c14b" class="lw ki hi ls b fi mf ly l lz ma">  user: "sharduser",<br/>  pwd: "sharduser@123",<br/>  roles: [ { role: "root", db: "admin" } ]</span><span id="129c" class="lw ki hi ls b fi mf ly l lz ma">})</span></pre><p id="a9a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">8.完成我们已经设置了集群</p><p id="1b50" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">9.我们可以在mongos中启动一些分片收集，如果我们已经有了它们，否则我们可以在以后添加它们</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="8493" class="lw ki hi ls b fi lx ly l lz ma">sh.enableSharding("&lt;database_name&gt;")<br/>sh.shardCollection("&lt;database_name&gt;.&lt;collection_name&gt;", {<br/>    &lt; shard key field &gt;: "hashed"<br/>})</span></pre><h1 id="e4d6" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">碎片密钥</h1><p id="48ac" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">小心碎片键，因为它们提供了关于数据在整个集群中分布方式的信息。分片键还对数据更新和查询集合施加了一些限制</p><p id="ed8b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有关更多详细信息，请查看下面的文章:</p><p id="086d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.mongodb.com/manual/core/sharding-shard-key/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/core/sharding-shard-key/</a></p><h1 id="b025" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">使用mongos</h1><p id="d1da" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">我们已经在配置服务器中设置了mongos。转到其安全组，将config_server公共IP上的入站规则和端口27020分配给all。</p><p id="ced7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以通过下面的命令使用分片集群</p><p id="7dd9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du mc md me ls b">mongo —host &lt;public_ip_of_config_server&gt; —port 27020 -u sharduser -p sharduser@123 --authenticationDatabase=admin</code></p><p id="fb41" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在任何mongo客户端库中使用它。您可以将一个集群扩展到每台服务器3个节点的副本集，同样也可以扩展到多个mongos。</p><p id="92c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这能澄清你对MongoDB shard集群设置的疑虑。</p><p id="7cb3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢阅读</p></div></div>    
</body>
</html>