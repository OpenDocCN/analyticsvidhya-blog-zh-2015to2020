<html>
<head>
<title>Automating AWS cloud infrastructure with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform自动化AWS云基础架构</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/automating-aws-cloud-infrastructure-with-terraform-45d9d1160475?source=collection_archive---------19-----------------------#2020-06-13">https://medium.com/analytics-vidhya/automating-aws-cloud-infrastructure-with-terraform-45d9d1160475?source=collection_archive---------19-----------------------#2020-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/41c9d380d66f15ce3a617460c9f8c65f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ubPEM_ajVaqE9J6C2m1eKA.png"/></div></div></figure><div class=""/><div class=""><h2 id="5ad4" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">*我们将要做什么？</h2></div><p id="4d49" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">1.创建允许端口80的密钥和安全组。</p><p id="45a8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">2.启动EC2实例。</p><p id="a170" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">3.在这个EC2实例中，使用我们在步骤1中创建的密钥和安全组。</p><p id="9a47" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">4.启动一个卷(EBS)并将该卷装入/var/www/html。</p><p id="afe8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">5.开发人员已经上传到GitHub回购代码，回购也有一些图像。</p><p id="b04b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">6.将GitHub repo代码复制到/var/www/html中。</p><p id="abd0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">7.创建一个s3存储桶，将GitHub repo中的映像复制/部署到S3存储桶中，并将权限更改为public readable。</p><p id="2959" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">8使用s3 bucket(包含图像)创建一个Cloudfront，并使用Cloudfront URL更新/var/www/html中的代码。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><h2 id="ea6e" class="kl km ht bd kn ko kp kq kr ks kt ku kv jr kw kx ky jv kz la lb jz lc ld le lf bi translated">*先决条件:-</h2><ol class=""><li id="4aed" class="lg lh ht jk b jl li jo lj jr lk jv ll jz lm kd ln lo lp lq bi translated">AWS服务，如ec2、CloudFront、ebs、s3。</li><li id="9612" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">饭桶</li><li id="d929" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">开源代码库</li></ol></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><h2 id="275f" class="kl km ht bd kn ko kp kq kr ks kt ku kv jr kw kx ky jv kz la lb jz lc ld le lf bi translated">*在进入解决方案部分之前，让我告诉你亚马逊aws服务的所有主要术语:-</h2><ul class=""><li id="79a4" class="lg lh ht jk b jl li jo lj jr lk jv ll jz lm kd lw lo lp lq bi translated"><strong class="jk hu"> <em class="lx">什么是aws？</em>T3】</strong></li></ul><p id="3630" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated"><span class="l lz ma mb bm mc md me mf mg di"> A </span> mazon web service是一个提供灵活、可靠、可扩展、易于使用且经济高效的云计算解决方案的平台。</p><p id="eb6e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">AWS是亚马逊提供的一个全面、易于使用的计算平台。该平台结合了基础设施即服务(IaaS)、平台即服务(PaaS)和打包软件即服务(SaaS)产品。</p><ul class=""><li id="a994" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated"><strong class="jk hu"><em class="lx">AWS(亚马逊网络服务)的7大优势</em> </strong></li></ul><ol class=""><li id="efb5" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd ln lo lp lq bi translated">全面的</li><li id="b0e5" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">性价比高</li><li id="4390" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">适合的</li><li id="adbd" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">安全性</li><li id="9130" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">创新ˌ革新</li><li id="f5ae" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">全球领导者</li><li id="61f4" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">提高生产力</li></ol><ul class=""><li id="b4da" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated"><strong class="jk hu"> <em class="lx">它的服务:- </em> </strong></li></ul><blockquote class="mk ml mm"><p id="d0d1" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">EC2</p></blockquote><p id="2689" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated"><span class="l lz ma mb bm mc md me mf mg di">E</span>Elastic Block Store(EBS)是一种易于使用的高性能块存储服务，旨在与Amazon Elastic Compute Cloud (EC2)配合使用，用于任何规模的吞吐量和事务密集型工作负载。各种各样的工作负载，如关系和非关系数据库、企业应用程序、容器化应用程序、大数据分析引擎、文件系统和媒体工作流，都广泛部署在Amazon EBS上。</p><blockquote class="mk ml mm"><p id="e03d" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">云锋</p></blockquote><p id="b0ec" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated"><span class="l lz ma mb bm mc md me mf mg di"> C </span> loudFront是一种快速内容交付网络(CDN)服务，能够以低延迟、高传输速度向全球客户安全交付数据、视频、应用和API，所有这些都在一个开发人员友好的环境中完成。CloudFront与AWS集成，这两个物理位置都直接连接到AWS全球基础设施，以及其他AWS服务。CloudFront可以与包括AWS Shield for DDoS缓解、Amazon S3、Elastic Load Balancing或Amazon EC2在内的服务无缝协作，作为应用程序的来源，并与Lambda@Edge一起运行更接近客户用户的定制代码，并定制用户体验。最后，如果你使用亚马逊S3、亚马逊EC2或弹性负载平衡等AWS源，你不需要为这些服务和CloudFront之间的任何数据传输付费。</p><blockquote class="mk ml mm"><p id="a9b1" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">3</p></blockquote><p id="793b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated">简单存储服务(亚马逊S3)是一种对象存储服务，提供行业领先的可扩展性、数据可用性、安全性和性能。这意味着各种规模和行业的客户都可以使用它来存储和保护各种使用情形下的任意数量的数据，例如网站、移动应用程序、备份和恢复、归档、企业应用程序、物联网设备和大数据分析。亚马逊S3提供易于使用的管理功能，因此您可以组织您的数据并配置微调的访问控制，以满足您特定的业务、组织和合规性要求。亚马逊S3旨在实现99.999999999% (11个9)的耐用性，并为全球公司的数百万个应用程序存储数据。</p><blockquote class="mk ml mm"><p id="9783" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">密钥对和安全组</p></blockquote><p id="980d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated"><span class="l lz ma mb bm mc md me mf mg di"> K </span> ey对由一个私钥和一个公钥组成，是一组安全凭证，用于在连接到实例时证明您的身份。Amazon EC2存储公钥，您存储私钥。您使用私钥而不是密码来安全地访问您的实例。</p><p id="5257" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated"><span class="l lz ma mb bm mc md me mf mg di">S</span>security group充当EC2实例的虚拟防火墙，控制传入和传出流量。入站规则控制您的实例的传入流量，出站规则控制您的实例的传出流量。…如果没有指定安全组，Amazon EC2会使用默认的安全组。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><ul class=""><li id="ae80" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated"><strong class="jk hu"> <em class="lx">什么是terraform？</em>T9】</strong></li></ul><p id="5efe" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi ly translated">erraform是一个安全有效地构建、更改和版本控制基础设施的工具。Terraform可以管理现有的和受欢迎的服务提供商以及定制的内部解决方案。</p><p id="8cb4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">配置文件描述了运行单个应用程序或整个数据中心所需组件的平台化。Terraform生成一个执行计划，描述它将做什么来达到期望的状态，然后执行它来构建所描述的基础设施。随着配置的变化，Terraform能够确定发生了什么变化，并创建可以应用的增量执行计划。</p><p id="5fb9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">Terraform可以管理的基础设施包括低级组件，如计算实例、存储和网络，以及高级组件，如DNS条目、SaaS功能等。</p><h2 id="2ab6" class="kl km ht bd kn ko kp kq kr ks kt ku kv jr kw kx ky jv kz la lb jz lc ld le lf bi translated">Terraform的主要特点是</h2><ol class=""><li id="d5f6" class="lg lh ht jk b jl li jo lj jr lk jv ll jz lm kd ln lo lp lq bi translated">执行计划</li><li id="0e03" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">基础设施作为代码</li><li id="b068" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">变革自动化</li><li id="27e0" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd ln lo lp lq bi translated">资源图表</li></ol></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><h2 id="36cd" class="kl km ht bd kn ko kp kq kr ks kt ku kv jr kw kx ky jv kz la lb jz lc ld le lf bi translated">*解决方案:-</h2><ul class=""><li id="3574" class="lg lh ht jk b jl li jo lj jr lk jv ll jz lm kd lw lo lp lq bi translated">首先，我们将在aws中创建一个概要文件。</li></ul><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="8933" class="kl km ht mv b fi mz na l nb nc">$ aws configure --profile user<br/>AWS Access Key ID [None]:<br/>AWS Secret Access Key [None]:<br/>Default region name [None]:<br/>Default output format [None]:</span></pre><p id="e06c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在这里，提供你的用户名代替用户，如你所愿。然后，提供访问密钥ID、秘密访问密钥、区域名称、输出格式。</p><blockquote class="mk ml mm"><p id="d13b" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated"><em class="ht">如果你不提供输出格式，那么默认情况下它会把它作为json。</em></p></blockquote><ul class=""><li id="5a9f" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">其次，在您的系统中本地设置地形。我使用windows作为我的基本操作系统。下面提供了下载terraform的官方链接。</li></ul><div class="hh hi ez fb hj nd"><a href="https://www.terraform.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hu fi z dy ni ea eb nj ed ef hs bi translated">哈希公司的Terraform</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">使用Terraform以代码形式交付基础架构协作和共享配置发展和版本化您的…</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">www.terraform.io</p></div></div><div class="nm l"><div class="nn l no np nq nm nr hp nd"/></div></div></a></div><p id="45fa" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">下载后，只需提取文件并将其复制到您希望的某个位置，并在您的环境变量中提供该位置，然后运行下面给出的命令来检查terraform是否已成功安装在您的系统中。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="0243" class="kl km ht mv b fi mz na l nb nc">terraform -version</span></pre></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><ul class=""><li id="7af1" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">现在直接进入任务的主要部分。</li></ul><ol class=""><li id="1a3a" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd ln lo lp lq bi translated">为terraform的工作提供提供者。因为我们在aws上工作，所以我们作为我们的提供商提供aws。</li></ol><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="d973" class="kl km ht mv b fi mz na l nb nc">provider “aws” {<br/> region = “ap-south-1”<br/> profile = “sky”<br/>}</span></pre><p id="2816" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在这里，我提供“天空”作为我创建的个人资料。您应该提供您创建的个人资料。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="572c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">2.现在，转到我们任务的第一部分，即创建允许端口80的密钥和安全组。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="d914" class="kl km ht mv b fi mz na l nb nc">resource “tls_private_key” “key1” {<br/> algorithm = “RSA”<br/> rsa_bits = 4096<br/>}</span><span id="0a49" class="kl km ht mv b fi ns na l nb nc">resource “local_file” “key2” {<br/> content = “${tls_private_key.key1.private_key_pem}”<br/> filename = “task1_key.pem”<br/> file_permission = 0400<br/>}</span><span id="2bb6" class="kl km ht mv b fi ns na l nb nc">resource “aws_key_pair” “key3” {<br/> key_name = “task1_key”<br/> public_key = “${tls_private_key.key1.public_key_openssh}”<br/>}</span></pre><p id="c9bb" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在这里，我们创建了<strong class="jk hu">中的键<em class="lx">。pem </em> </strong>文件为远程登录做ssh时ssh只接受key in。pem格式。</p><p id="31e7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">创建任何aws服务时，terraform中的<strong class="jk hu"> <em class="lx">资源</em> </strong>关键字通常需要一些名称。这里的<strong class="jk hu"> <em class="lx"> key1、key2、key3 </em> </strong>只是一些名字，它们有很大的意义，同时依赖于在它们之后运行的一些服务，因此您可以提供自己的服务。此外，您可以提及您选择的任何<strong class="jk hu"> <em class="lx"> key_name </em> </strong>。</p><blockquote class="mk ml mm"><p id="d0fd" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">在创建更多资源时，应记住以上陈述。</p></blockquote><p id="17d7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在，创建一个安全组。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="f772" class="kl km ht mv b fi mz na l nb nc">resource “aws_security_group” “sg” {<br/> name = “task1-sg”<br/> description = “Allow TLS inbound traffic”<br/> vpc_id = “vpc-ebf8e583”</span><span id="f7ca" class="kl km ht mv b fi ns na l nb nc">ingress {<br/> description = “SSH”<br/> from_port = 22<br/> to_port = 22<br/> protocol = “tcp”<br/> cidr_blocks = [ “0.0.0.0/0” ]<br/> }</span><span id="e9af" class="kl km ht mv b fi ns na l nb nc">ingress {<br/> description = “HTTP”<br/> from_port = 80<br/> to_port = 80<br/> protocol = “tcp”<br/> cidr_blocks = [ “0.0.0.0/0” ]<br/> }</span><span id="ffe0" class="kl km ht mv b fi ns na l nb nc">egress {<br/> from_port = 0<br/> to_port = 0<br/> protocol = “-1”<br/> cidr_blocks = [“0.0.0.0/0”]<br/> }</span><span id="cf4e" class="kl km ht mv b fi ns na l nb nc">tags = {<br/> Name = “task1-sg”<br/> }<br/>}</span></pre><p id="afb7" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">由于我们正在创建一个web服务器，在这种情况下，我们已经创建了一些入站规则来访问web服务器，允许HTTP端口和ssh端口进行远程登录。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="8e13" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">3.启动EC2实例。在这个Ec2实例中，使用我们在上面创建的密钥和安全组。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="070d" class="kl km ht mv b fi mz na l nb nc">resource “aws_instance” “web_server” {<br/> ami = “ami-0447a12f28fddb066”<br/> instance_type = “t2.micro”<br/> subnet_id = “subnet-adead0c5”<br/> availability_zone = “ap-south-1a”<br/> root_block_device {<br/> volume_type = “gp2”<br/> delete_on_termination = true<br/> }<br/> key_name = “${aws_key_pair.key3.key_name}”<br/> security_groups = [ aws_security_group.sg.id ]</span><span id="a0d6" class="kl km ht mv b fi ns na l nb nc">connection {<br/> type = “ssh”<br/> user = “ec2-user”<br/> private_key = “${tls_private_key.key1.private_key_pem}”<br/> host = “${aws_instance.web_server.public_ip}”<br/> }</span><span id="fa33" class="kl km ht mv b fi ns na l nb nc">provisioner “remote-exec” {<br/> inline = [<br/> “sudo yum install httpd git -y”,<br/> “sudo systemctl restart httpd”,<br/> “sudo systemctl enable httpd”,<br/> ]<br/> }</span><span id="0c5d" class="kl km ht mv b fi ns na l nb nc">tags = {<br/> Name = “task1_os”<br/> }</span><span id="3cc0" class="kl km ht mv b fi ns na l nb nc">}</span></pre><p id="311f" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们在aws WebUI中创建实例时使用了所有aws关键字，因此无需解释。</p><p id="431b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">最后，我们使用<strong class="jk hu"> <em class="lx">提供的remote-exec </em> </strong>远程自动安装我们需要的软件<strong class="jk hu"> <em class="lx"> (httpd和git) </em> </strong>，并使用我们的<strong class="jk hu"> <em class="lx">用户名</em> </strong>和<strong class="jk hu"> <em class="lx"> private_key </em> </strong>在ssh的帮助下启动它们的服务。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="3b79" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">4.启动一个卷(EBS)并将该卷装入/var/www/html。开发人员已经上传到GitHub回购代码，回购也有一些图像。将GitHub repo代码复制到/var/www/html中。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="c475" class="kl km ht mv b fi mz na l nb nc">resource “aws_volume_attachment” “task1_ebs_mount” {<br/> device_name = “/dev/xvds”<br/> volume_id = “${aws_ebs_volume.task1_ebs.id}”<br/> instance_id = “${aws_instance.web_server.id}”<br/> force_detach = true<br/> <br/> <br/> connection {<br/> type = “ssh”<br/> user = “ec2-user”<br/> private_key = “${tls_private_key.key1.private_key_pem}”<br/> host = “${aws_instance.web_server.public_ip}”<br/> }</span><span id="3f45" class="kl km ht mv b fi ns na l nb nc">provisioner “remote-exec” {<br/> inline = [<br/> “sudo mkfs.ext4 /dev/xvds”,<br/> “sudo mount /dev/xvds /var/www/html”,<br/> “sudo rm -rf /var/www/html/*”,<br/> “sudo git clone <a class="ae nt" href="https://github.com/Akashdeep-47/cloud_task1.git" rel="noopener ugc nofollow" target="_blank">https://github.com/Akashdeep-47/cloud_task1.git</a> /var/www/html/”<br/> ]<br/> }<br/>}</span></pre><p id="508c" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">成功创建新卷后，我们必须对其进行格式化，然后挂载到httpd服务器的默认位置，即<strong class="jk hu"> <em class="lx"> /var/www/html </em> </strong>。这里，您可以使用除“xvda”之外的任何<strong class="jk hu"> <em class="lx"> device_name </em> </strong>，因为它通常是他们启动实例时使用的主内存名称。你可以用任何字母代替<strong class="jk hu"><em class="lx">【a】</em></strong>这确实是我的个人研究，因为我在这方面面临很多问题。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="05cf" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">5.创建一个s3存储桶，将GitHub repo中的映像复制/部署到S3存储桶中，并将权限更改为public readable。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="c2d4" class="kl km ht mv b fi mz na l nb nc">resource “aws_s3_bucket” “mybucket”{<br/> bucket = “sky25”<br/> acl = “public-read”</span><span id="0752" class="kl km ht mv b fi ns na l nb nc">provisioner “local-exec” {<br/> command = “git clone <a class="ae nt" href="https://github.com/Akashdeep-47/cloud_task1.git" rel="noopener ugc nofollow" target="_blank">https://github.com/Akashdeep-47/cloud_task1.git</a>" <br/> }<br/> <br/> provisioner “local-exec” {<br/> when = destroy <br/> command = “echo y | rmdir /s cloud_task1”<br/> }<br/>}</span><span id="4c2b" class="kl km ht mv b fi ns na l nb nc">resource “aws_s3_bucket_object” “file_upload” {<br/> depends_on = [<br/> aws_s3_bucket.mybucket,<br/> ]<br/> bucket = “${aws_s3_bucket.mybucket.bucket}”<br/> key = “my_pic.jpg”<br/> source = “cloud_task1/pic.jpg”<br/> acl =”public-read”<br/>}</span></pre><p id="30ae" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在创建S3桶和上传文件时，请确保将其设为公共访问，因为我们将在创建CloudFront时使用这些文件。</p><p id="7369" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">由于开发人员推送代码，所以我使用<strong class="jk hu"><em class="lx">provisioner“local-exec”</em></strong>将它的映像克隆到本地，从而使用它。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="70f9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">6.使用s3 bucket(包含图片)创建一个Cloudfront。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="5f57" class="kl km ht mv b fi mz na l nb nc">resource “aws_cloudfront_distribution” “s3_distribution” {<br/> depends_on = [<br/> aws_volume_attachment.task1_ebs_mount,<br/> aws_s3_bucket_object.file_upload,<br/> ]</span><span id="6cf9" class="kl km ht mv b fi ns na l nb nc">origin {<br/> domain_name = “${aws_s3_bucket.mybucket.bucket}.s3.amazonaws.com”<br/> origin_id = “ak” <br/> }</span><span id="f33b" class="kl km ht mv b fi ns na l nb nc">enabled = true<br/> is_ipv6_enabled = true<br/> default_root_object = “index.html”</span><span id="60ee" class="kl km ht mv b fi ns na l nb nc">restrictions {<br/> geo_restriction {<br/> restriction_type = “none”<br/> }<br/> }</span><span id="eac3" class="kl km ht mv b fi ns na l nb nc">default_cache_behavior {<br/> allowed_methods = [“HEAD”, “GET”]<br/> cached_methods = [“HEAD”, “GET”]<br/> forwarded_values {<br/> query_string = false<br/> cookies {<br/> forward = “none”<br/> }<br/> }<br/> default_ttl = 3600<br/> max_ttl = 86400<br/> min_ttl = 0<br/> target_origin_id = “ak”<br/> viewer_protocol_policy = “allow-all”<br/> }</span><span id="9d56" class="kl km ht mv b fi ns na l nb nc">price_class = “PriceClass_All”</span><span id="23d6" class="kl km ht mv b fi ns na l nb nc">viewer_certificate {<br/> cloudfront_default_certificate = true<br/> } <br/>}</span></pre><p id="b264" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这里，我们使用<strong class="jk hu"> <em class="lx"> depend_on </em> </strong>关键字，因为我们希望在成功挂载ebs卷并将映像上传到s3 bucket之后创建这个CloudFront。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="7cea" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">7.使用Cloudfront URL更新/var/www/html中的代码。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="4aad" class="kl km ht mv b fi mz na l nb nc">resource “null_resource” “nullremote3” {<br/> depends_on = [<br/> aws_cloudfront_distribution.s3_distribution,<br/> ]</span><span id="716d" class="kl km ht mv b fi ns na l nb nc">connection {<br/> type = “ssh”<br/> user = “ec2-user”<br/> private_key = “${tls_private_key.key1.private_key_pem}”<br/> host = “${aws_instance.web_server.public_ip}”<br/> }<br/> <br/> provisioner “remote-exec” {<br/> inline = [<br/> “sudo sed -i ‘s@twerk@http://${aws_cloudfront_distribution.s3_distribution.domain_name}/${aws_s3_bucket_object.file_upload.key}<a class="ae nt" href="http://twitter.com/g" rel="noopener ugc nofollow" target="_blank">@g</a>' /var/www/html/index.html”,<br/> “sudo systemctl restart httpd”<br/> ]<br/> }<br/>}</span></pre><p id="7f2d" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这里，我们使用<strong class="jk hu"> <em class="lx">资源“null _ resource”</em></strong>因为要运行任何置备程序，我们都需要一个服务，如果我们没有，就使用<strong class="jk hu"><em class="lx">null _ resource</em></strong>关键字。</p></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><p id="f0d5" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">8.最后，我们创建了一个代码，一旦所有服务成功运行，它就会自动运行我们的web服务器。</p><pre class="mq mr ms mt fd mu mv mw mx aw my bi"><span id="1281" class="kl km ht mv b fi mz na l nb nc">resource “null_resource” “nulllocal1” {<br/> depends_on = [<br/> null_resource.nullremote3,<br/> ]</span><span id="f10b" class="kl km ht mv b fi ns na l nb nc">provisioner “local-exec” {<br/> command = “start chrome ${aws_instance.web_server.public_ip}”<br/> }<br/>}</span></pre><p id="6399" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这里，我们使用chrome作为浏览器，使用我们的实例IP来启动我们的web服务器。</p><blockquote class="mk ml mm"><p id="d551" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">请注意，我使用了<strong class="jk hu"> <em class="ht">启动chrome </em> </strong>而不是chrome，因为在我的情况下，它不工作，即使我已经为它传递了路径。因此，选择相应的，因为它在您的系统上工作。</p></blockquote></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><h2 id="8025" class="kl km ht bd kn ko kp kq kr ks kt ku kv jr kw kx ky jv kz la lb jz lc ld le lf bi translated">*运行整个配置所需的一些terraform命令</h2><ul class=""><li id="b573" class="lg lh ht jk b jl li jo lj jr lk jv ll jz lm kd lw lo lp lq bi translated">terraform init(对<strong class="jk hu"> <em class="lx">初始化</em> </strong>一个包含<strong class="jk hu"> <em class="lx"> Terraform </em> </strong>配置文件的工作目录)</li></ul><blockquote class="mk ml mm"><p id="075e" class="ji jj lx jk b jl jm iu jn jo jp ix jq mn js jt ju mo jw jx jy mp ka kb kc kd hb bi translated">这是在编写新的Terraform配置或从版本控制中克隆现有配置后应该运行的第一个命令。多次运行该命令是安全的。</p></blockquote><ul class=""><li id="624f" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">terraform validate(对<strong class="jk hu"> <em class="lx">验证</em> </strong>代码是否有错误)</li><li id="48c3" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd lw lo lp lq bi translated">地形计划(给<strong class="jk hu"> <em class="lx">创建</em> </strong>一个执行计划)</li><li id="4b64" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd lw lo lp lq bi translated">terraform apply -auto-approve(对<strong class="jk hu"> <em class="lx">应用</em> </strong>达到所需配置状态所需的更改，或由<code class="du nu nv nw mv b">terraform plan</code>执行计划生成的一组预定动作)</li><li id="15ad" class="lg lh ht jk b jl lr jo ls jr lt jv lu jz lv kd lw lo lp lq bi translated">terraform销毁-自动批准(到<strong class="jk hu"> <em class="lx">销毁</em></strong>terra form管理的基础设施)</li></ul></div><div class="ab cl ke kf gp kg" role="separator"><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj kk"/><span class="kh bw bk ki kj"/></div><div class="hb hc hd he hf"><h2 id="49c7" class="kl km ht bd kn ko kp kq kr ks kt ku kv jr kw kx ky jv kz la lb jz lc ld le lf bi translated">*我们创建的配置的最终输出:-</h2><ul class=""><li id="dcf5" class="lg lh ht jk b jl li jo lj jr lk jv ll jz lm kd lw lo lp lq bi translated">密钥对</li></ul><figure class="mq mr ms mt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/dcfa8e6a4634c306a16e8a970b553946.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*12gshLsBKlTObCQiAZpXOw.png"/></div></div><figcaption class="ny nz et er es oa ob bd b be z dx translated">密钥对</figcaption></figure><ul class=""><li id="61b2" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">安全组</li></ul><figure class="mq mr ms mt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/f96413abb206d4174c76167ec67c7eaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Oq-qnGyNJt9GsYoq64VuA.png"/></div></div><figcaption class="ny nz et er es oa ob bd b be z dx translated">安全组</figcaption></figure><ul class=""><li id="2e93" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">EC2实例</li></ul><figure class="mq mr ms mt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/006a21c9556055fd949f6fbb0bc4c6ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iKStCcFC90vZVzbdUcgAQQ.png"/></div></div><figcaption class="ny nz et er es oa ob bd b be z dx translated">ec2实例</figcaption></figure><ul class=""><li id="b7f7" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">ebs卷</li></ul><figure class="mq mr ms mt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/babf22ad5518335e29223bdcb13231d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iIQsbIzJf7S60Af05ustYQ.png"/></div></div><figcaption class="ny nz et er es oa ob bd b be z dx translated">ebs卷</figcaption></figure><p id="630b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您可以清楚地看到，创建的ebs卷已被使用，这意味着它已成功装载，克隆已完成。</p><ul class=""><li id="9490" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">S3水桶</li></ul><div class="mq mr ms mt fd ab cb"><figure class="oc hk od oe of og oh paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/dabcac1d85cb2929d61806a724e9e219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*a3rc0iBJ6iGSN-f6RLDpPA.png"/></div></figure><figure class="oc hk od oe of og oh paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/328232cc7d4792d45731cf17b442e5dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*jncjRkT9u6yrdZmNsIbVlQ.png"/></div><figcaption class="ny nz et er es oa ob bd b be z dx oi di oj ok translated">S3水桶</figcaption></figure></div><ul class=""><li id="74ed" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">云锋</li></ul><div class="mq mr ms mt fd ab cb"><figure class="oc hk od oe of og oh paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/4e68c8f8612f3e4fef946c6600ad091e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*fYWL4cZa0mqfTt83rO3nqg.png"/></div></figure><figure class="oc hk od oe of og oh paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><img src="../Images/bf851fdbe48fb814cb618405767906d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*8SHZqdnK2a4GXaXfe5Msfw.png"/></div><figcaption class="ny nz et er es oa ob bd b be z dx oi di oj ok translated">云锋</figcaption></figure></div><ul class=""><li id="1ec5" class="lg lh ht jk b jl jm jo jp jr mh jv mi jz mj kd lw lo lp lq bi translated">最终结局。</li></ul><figure class="mq mr ms mt fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es nx"><img src="../Images/98b12040a865463cfc6722d70bf4c8fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i6rlvielCC7DfyCTR4VGPA.png"/></div></div><figcaption class="ny nz et er es oa ob bd b be z dx translated">输出，即网络服务器</figcaption></figure><h1 id="29d8" class="ol km ht bd kn om on oo kr op oq or kv iz os ja ky jc ot jd lb jf ou jg le ov bi translated">最后，我们实现了我们想要创造的东西。</h1><p id="b67f" class="pw-post-body-paragraph ji jj ht jk b jl li iu jn jo lj ix jq jr ow jt ju jv ox jx jy jz oy kb kc kd hb bi translated">感谢阅读这篇文章。我已经尽力解释了。请随意提供建议。</p><p id="6a45" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">代码帮助的Github存储库:-</p><div class="hh hi ez fb hj nd"><a href="https://github.com/Akashdeep-47/cloud_task1.git" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab dw"><div class="nf ab ng cl cj nh"><h2 class="bd hu fi z dy ni ea eb nj ed ef hs bi translated">阿卡什迪普-47/云任务1</h2><div class="nk l"><h3 class="bd b fi z dy ni ea eb nj ed ef dx translated">在GitHub上创建一个帐户，为Akashdeep-47/cloud_task1开发做贡献。</h3></div><div class="nl l"><p class="bd b fp z dy ni ea eb nj ed ef dx translated">github.com</p></div></div><div class="nm l"><div class="oz l no np nq nm nr hp nd"/></div></div></a></div></div></div>    
</body>
</html>