<html>
<head>
<title>Deploy Machine Learning Models On AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS Lambda上部署机器学习模型</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploy-machine-learning-models-on-aws-lambda-5969b11616bf?source=collection_archive---------0-----------------------#2019-08-23">https://medium.com/analytics-vidhya/deploy-machine-learning-models-on-aws-lambda-5969b11616bf?source=collection_archive---------0-----------------------#2019-08-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b3fa" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在AWS Lambda上服务机器学习模型的实践指南</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/6e6f6935877abbfccf5090ce640cbeea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zwLxp5lR17BT2C_vs7HCsQ.jpeg"/></div></div></figure><h1 id="3b05" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">简介:</h1><p id="234e" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">在花费几周/几个月的时间设计和学习ML模型之后，最困难的部分之一可能是在生产环境中实际部署和维护模型，在生产环境中您需要一个服务器和一个工作环境。</p><p id="b395" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">AWS通过AWS Lambdas提供托管和部署模型，使这一过程变得更加容易，这非常便宜，并且通过在AWS基础设施上并行运行来自动“扩展”，猜猜看，您只需在发出预测请求(调用Lambdas)时付费。</p><p id="d860" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">在这篇文章中，我们将教你如何利用AWS Lambdas来部署你的机器学习/深度学习模型。</p><p id="f4d0" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们开始吧。</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="b924" class="jj jk hi bd jl jm lj jo jp jq lk js jt io ll ip jv ir lm is jx iu ln iv jz ka bi translated">1 —准备模型:</h1><p id="e99b" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">在本节中，我们将准备、拟合并保存我们的模型，我们将在教程中使用该模型。</p><p id="2298" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">本教程中使用的数据是一个真实世界的数据集，称为在<em class="lo"> UCI回购</em>中可用的<em class="lo">成人数据集</em>，这些数据是关于<em class="lo">T5】预测一个人的潜在收入是超过5万美元/年还是更少。</em></p><p id="a1c3" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们将在这一部分采取的步骤是:</p><ul class=""><li id="9b79" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">加载并调查数据</li><li id="164b" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">拟合并保存模型。</li></ul><h2 id="5b27" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">1.1-加载并调查数据:</h2><p id="eadf" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">让我们加载数据:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mr ms l"/></div></figure><p id="b601" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们使用shap包加载我们的数据，</p><p id="8c6f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在让我们检查一下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mt"><img src="../Images/c5b09e3b57ae1a6e97d31bd1b7e1f16d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5-KEoLJRArVYulm9FGgS6A.png"/></div></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">成人数据集</figcaption></figure><p id="585f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">似乎所有的功能都设置好了。</p><p id="e2d7" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们将构建一个基本的lightgbm模型并保存它，因此不会有预处理或特性工程，因为本教程的主要目的是在AWS Lambda中部署。</p><p id="4914" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">所以让我们这样做:</p><h2 id="427f" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">1.2 —拟合并保存模型:</h2><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="f26d" class="md jk hi mz b fi nd ne l nf ng">import lightgbm  as lgbm</span><span id="e98d" class="md jk hi mz b fi nh ne l nf ng">params = {'objective':'binary',<br/>          'booster_type':'gbdt',<br/>          'max_depth':6,<br/>          'learning_rate':0.05,<br/>          'metric':'auc'<br/>    }<br/><br/>dtrain = lgbm.Dataset(data,labels)<br/><br/>model = lgbm.train(params,dtrain,num_boost_round=100,valid_sets=[dtrain])<br/><br/>model.save_model('saved_adult_model.txt')</span></pre><p id="19e1" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如您所见，基本模型，无列车/val分割，基本参数。</p><p id="177e" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在我们已经准备好了模型，让我们转移到AWS，这是本教程的主要目的。</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="5b13" class="jj jk hi bd jl jm lj jo jp jq lk js jt io ll ip jv ir lm is jx iu ln iv jz ka bi translated">2 — AWS Lambdas:</h1><p id="be8d" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">在我们开始深入研究使用这个服务之前，让我们首先定义它:</p><blockquote class="ni nj nk"><p id="0658" class="kb kc lo kd b ke kx ij kg kh ky im kj nl kz km kn nm la kq kr nn lb ku kv kw hb bi translated">AWS Lambda是一种计算服务，让您无需配置或管理服务器即可运行代码。</p></blockquote><p id="2417" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">那么这意味着什么呢？</p><p id="c064" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">简而言之，这意味着无论何时你有一个随时可以部署的机器学习模型，AWS lambda都将充当你的模型将被部署的服务器，你所要做的就是，给它代码+依赖项，就这样，就像把你的代码推给一个回购。</p><p id="b801" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我来告诉你怎么做:</p><p id="0b4d" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">首先，你将需要<strong class="kd hj">无服务器框架</strong>——一个麻省理工学院的开源项目——这将是我们构建应用的工具，所以让我们开始吧:</p><p id="8e3c" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们将遵循的步骤如下:</p><ul class=""><li id="3c47" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">安装无服务器框架</li><li id="ef4c" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">在AWS中创建存储桶</li><li id="4757" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">将我们训练好的模型推到创建的桶中</li><li id="771c" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">构建main.py，这个python文件将调用我们的模型并进行预测</li><li id="ccdb" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">构建serverless.yml文件，其中我们将告诉serverless框架要做什么(创建lambda函数)</li><li id="7819" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">测试我们在本地构建的内容(使用无服务器框架用我们的模型生成预测)</li><li id="e868" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">部署到AWS。</li><li id="4dbb" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">测试部署的应用程序。</li></ul><p id="dbc6" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">为了在AWS lambda中部署我们训练好的模型，这些将是我们在本教程中要遵循的步骤。</p><p id="123e" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我们开始吧:</p><h2 id="f66e" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">重要备注:</h2><blockquote class="ni nj nk"><p id="54be" class="kb kc lo kd b ke kx ij kg kh ky im kj nl kz km kn nm la kq kr nn lb ku kv kw hb bi translated">对于本教程的其余部分，请确保您始终在文件所在的目录中，requirements.txt、main.py和saved_adult_model.txt，因为我提到了它，所以这是我们的requirements.txt:</p></blockquote><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="169f" class="md jk hi mz b fi nd ne l nf ng">lightgbm==2.2.3<br/>numpy==1.17.0<br/>scipy==1.3.0<br/>scikit-learn==0.21.3<br/></span></pre><h2 id="c4a8" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.1 —安装无服务器框架:</h2><p id="6abb" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">要在ubuntu中安装无服务器框架，首先你必须安装npm。为此，您可以在终端中运行以下命令:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="b4b3" class="md jk hi mz b fi nd ne l nf ng">curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -</span><span id="6acd" class="md jk hi mz b fi nh ne l nf ng">sudo apt-get install nodejs</span></pre><p id="e70b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">以上命令将安装nodejs和npm。</p><p id="a440" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">接下来，您可以通过运行以下命令来检查所有安装是否正确:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="9c5d" class="md jk hi mz b fi nd ne l nf ng"><strong class="mz hj">$ node -v</strong></span></pre><p id="ebb5" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">这将返回nodejs的版本</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="7b39" class="md jk hi mz b fi nd ne l nf ng"><strong class="mz hj">npm -v</strong></span></pre><p id="353b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">这将返回npm的版本。</p><p id="3d39" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在我们已经安装了npm，让我们通过运行以下命令来安装无服务器:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="db61" class="md jk hi mz b fi nd ne l nf ng">npm install -g serverless</span></pre><p id="f6c4" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">您可以通过运行以下命令来检查所有组件是否安装成功:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="2c0e" class="md jk hi mz b fi nd ne l nf ng">serverless</span></pre><p id="83f4" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如果您没有出现任何错误，那么恭喜您，您已经安装了无服务器，一切就绪。</p><p id="0c14" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我们进入下一步。</p><h2 id="6bab" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.2—在AWS中创建一个存储桶:</h2><p id="2a80" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">我们的下一步是将我们训练的模型推送到AWS存储桶，为此，我们首先需要创建一个存储桶，让我们这样做:</p><p id="5d6f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">在AWS上创建一个bucket可以使用下面的代码从命令行完成:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="896a" class="md jk hi mz b fi nd ne l nf ng">aws s3api create-bucket --acl private --bucket deploy-lgbm --create-bucket-configuration  LocationConstraint=eu-west-1<br/></span></pre><p id="263f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">以上命令将在eu-west-1位置以私有模式创建一个名为deploy-lgbm的存储桶。</p><h2 id="2c2c" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.3 —将我们训练过的模型推到创建的桶中:</h2><p id="3513" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">因此，现在我们的bucket已经准备好了，让我们通过运行以下命令将训练好的模型推送到它那里:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="21b3" class="md jk hi mz b fi nd ne l nf ng">aws s3 cp saved_adult_model.txt s3://deploy-lgbm/model/saved_model.txt</span></pre><p id="61b3" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">很好，现在让我们进入下一步，构建我们的main.py python文件，我们将用它来调用我们的模型并进行预测。</p><h2 id="29b0" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.3 —构建Main.py文件:</h2><p id="5297" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">当在AWS lambdas中进行部署时，代码的主要函数是一个名为lambda_handler的函数(或者我们选择给它的任何其他名称，尽管标准名称是lambda_handler)。</p><p id="373f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">为什么这个函数很重要？</p><p id="fe81" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">该函数是AWS lambdas每次调用它(与之交互)时都会执行的函数。因此，该函数将接收您的输入，进行预测，并返回输出。</p><p id="1516" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如果您曾经使用过cloud9中的AWS lambdas，您会注意到当您创建一个新的lambda函数并导入它时，lambda_function的标准定义是这样的:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="887f" class="md jk hi mz b fi nd ne l nf ng">def lambda_handler(event,context):<br/><br/>    return {'StatusCode':200,<br/>    'body':'Hello there, this is Lambda'}</span></pre><p id="8ff8" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如您所见，lambda函数需要两个输入—一个事件和一个上下文:</p><ul class=""><li id="fcea" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">该事件将包含我们将发送给lambda的信息，在这种情况下，这将是我们想要预测的样本。(它们将采用json格式)</li><li id="f14a" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">至于上下文，它通常包含关于调用、函数和执行环境的信息。对于本教程，我们不会使用它。</li></ul><p id="7c5c" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我们总结一下我们在这一部分要做的事情:</p><ul class=""><li id="58a5" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">首先，我们需要从bucket中获取训练好的模型，初始化我们的lightgbm并返回它，因此我们将为此构建一个函数。</li><li id="8b4e" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">然后我们要用我们的模型做预测，所以我们也要为此建立一个函数。</li><li id="9464" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">最后，在我们的lambda_handler函数中，我们将把所有这些东西放在一起，这意味着，接收事件，从事件中提取数据，获得模型，进行预测，然后返回预测。</li></ul><p id="81b2" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">这么简单对吧？</p><p id="5903" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在让我们建立我们的文件:</p><p id="bc43" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">首先我们将构建get_model()函数，它将下载经过训练的lightgbm，然后初始化我们的模型并返回它:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mr ms l"/></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">下载保存的模型。</figcaption></figure><p id="9be7" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如您所见，首先我们使用boto3创建了对bucket deploy-lgbm的访问，然后我们使用download_file方法下载saved_model.txt并将其保存在/tmp/test_model.txt中(回想一下，我们使用键:model/saved_model.txt将模型保存在bucket中)。</p><p id="211a" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">没事吧。那我们继续吧。</p><p id="207d" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在，我们将构建predict函数，该函数将获取模型、数据样本，进行预测，然后将其返回:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mr ms l"/></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">预测功能</figcaption></figure><p id="a026" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">让我解释一下上面的函数是做什么的:</p><p id="6b22" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">该函数获取事件，从事件中提取我们的数据，并将提取的数据提供给模型进行预测。</p><p id="510b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">这么简单对吧？</p><p id="0b52" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">重要备注:</p><ul class=""><li id="a223" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">最佳实践是，始终使用json格式在事件中传递数据。</li><li id="34bf" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">在我们的例子中，事情是简单的，我们提取数据并将其直接传递给模型，在大多数其他情况下，在将数据传递给模型之前，会对数据进行一些处理，因此您将需要另一个函数，您将在将数据传递给模型之前调用该函数。</li><li id="e4e4" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">总是把你的程序分成多个函数，我们可以把所有东西都放在lambda函数中，但是我们的代码不会再漂亮了。所以尽可能使用函数。</li></ul><p id="d53a" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在，最后一步是定义我们的lambda处理函数，让我们这样做:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mr ms l"/></div><figcaption class="mu mv et er es mw mx bd b be z dx translated">λ处理器</figcaption></figure><p id="333a" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如您所见，这是一个非常基本的功能，在现实世界的项目中，它会变得更加复杂。</p><p id="b91b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">它做的事情很清楚，获取事件并将其发送给predict函数以获得预测，然后以标准格式返回输出(您应该始终使用该格式):一个带有Statuscode的dict，结果在一个主体中。</p><p id="2d43" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">这部分到此结束，让我们继续下一步:构建serverless.yml文件。</p><h2 id="d835" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.4 —构建Serverless.yml文件:</h2><p id="7d0b" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">正如我们在本文开始时提到的，无服务器框架将是我们与AWS通信的工具，并创建一个lambda函数，该函数将充当托管我们训练好的模型的服务器。为此，我们需要告诉serverless它需要的所有信息:</p><ul class=""><li id="b0f5" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">提供商是谁？比如是AWS还是google，</li><li id="1efc" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">使用的是什么语言？</li><li id="18a9" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">我们想要创造什么？</li><li id="8531" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">它应该有什么作用？…等等。</li></ul><p id="bd4a" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">所有这些指令，我们将在serverless.yml文件中传递它们，所以让我们开始构建它:</p><p id="4e9b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">首先，我们将为我们的服务命名，比如说:test-deploy</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="0126" class="md jk hi mz b fi nd ne l nf ng">service : test-deploy</span></pre><p id="7895" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们文件中的下一部分将是关于我们的提供者，在这个例子中是AWS，yml文件中的指令看起来像这样:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mr ms l"/></div></figure><p id="d7de" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">那么，我们在上面的命令行中做了什么呢？让我解释一下:</p><ul class=""><li id="baaf" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">我们设置提供者的名称，即aws，</li><li id="386f" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">使用的语言(python3.6)，</li><li id="c72a" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">我们的lambda将要部署的区域，</li><li id="816c" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">无服务器将用于放置包的部署桶。</li><li id="37f0" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">iamRoleStatements，意思是:<br/>我们的lambda函数将从aws中的bucket下载训练好的模型，默认情况下，它没有权限这样做。所以我们需要给它这个权限，这就是为什么我们创建了一个角色，所以我们可以给我们的lambda它需要的权限(在这个例子中，只是访问一个桶。在其他情况下可能更多，您可以查阅aws文档以获得关于此事的详细解释)。<br/>为了给出更多关于角色的例子，假设您需要从这个lambda调用另一个lambda，在这种情况下，这个lambda需要权限，所以您必须将它们添加到iamRoleStatements中。</li></ul><p id="3666" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">重要备注:</p><ul class=""><li id="9072" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">我们放置模型的桶和lambda使用的桶应该在同一个区域(对于本教程，我们使用eu-west-1)，如果它们不在同一个区域，就不能工作。</li></ul><p id="adf7" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们的serverless.yml文件的下一部分将是关于我们将要创建的函数:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mr ms l"/></div></figure><p id="4581" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如你所见，</p><ul class=""><li id="4e59" class="lp lq hi kd b ke kx kh ky kk lr ko ls ks lt kw lu lv lw lx bi translated">首先我们定义一些非常基本的东西，比如名称和描述。</li><li id="5db3" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">我们定义我们的处理程序:<br/>回想一下我们说过的lambda_function，我们提到过这个函数将会做所有的工作。现在是你告诉serverless谁是你的lambda_handler函数的时候了；对于这种情况，我们在main.py文件中用名称lambda_handler定义了它，所以我们将handler : main.lambda_handler。如前所述，我们可以给它取任何我们想要的名字，比如，我们可以把这个函数命名为hello，但是我们必须放入handler : main.hello。</li><li id="1e4f" class="lp lq hi kd b ke ly kh lz kk ma ko mb ks mc kw lu lv lw lx bi translated">我们定义我们的事件:<br/>我们将如何与我们的lambda函数通信，或者换句话说，我们将如何触发(调用)我们的lambda函数。对于本教程，我们将使用http事件，这意味着通过调用url来调用lambda函数，这将是一个POST，资源将是/predictadult。</li></ul><p id="baf5" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">下一节是关于插件的:</p><p id="31b0" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">那是什么意思？让我解释一下:</p><p id="3904" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">到目前为止，我们告诉无服务器者谁是我们的提供商，我们的功能是什么。现在，为了让我们的代码工作，我们需要安装软件包，我们已经将它们放在requirements.txt文件中，因此，我们需要告诉serverless安装这些需求，为此我们将使用一个名为serverless-python-requirements的插件。</p><p id="79d9" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们将把它添加到serverless.yml文件中，如下所示:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="b71c" class="md jk hi mz b fi nd ne l nf ng">plugins:<br/> - serverless-python-requirements</span></pre><p id="b2cc" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我们要在文件中添加的最后一件事是优化，但是为什么我们需要优化呢？让我解释一下:</p><p id="6799" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">Lambda函数对要上传的包的最大大小有一些限制，允许的最大解压缩文件大小为250 MB。有时我们会超过这个数量，为了减少这个数量，我们可以删除包中的一些垃圾，这样可以节省一些兆字节。为此，我们通过在serverless.yml文件中添加以下命令来指示serverless:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="7813" class="md jk hi mz b fi nd ne l nf ng">custom:<br/> pythonRequirements:<br/>  slim : true<br/></span></pre><p id="21eb" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">就这样，完整的serverless.yml文件将如下所示:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="ea37" class="md jk hi mz b fi nd ne l nf ng">service : test-deploy<br/><br/>plugins:<br/> - serverless-python-requirements<br/><br/>provider:<br/> name: aws<br/> runtime: python3.6<br/> region : eu-west-1<br/> deploymentBucket:<br/>  name : deploy-tenserflow<br/> iamRoleStatements:<br/>  - Effect : Allow<br/>    Action:<br/>     - s3.GetObject<br/>    Resource:<br/>     - "arn:aws:s3:::deply-tenserflow/*"<br/><br/>custom:<br/> pythonRequirements:<br/>  slim : true<br/><br/>functions:<br/> lgbm-lambda:<br/>  name: lgbm-lambda-function<br/>  description : deploy trained lightgbm on aws lambda using serverless<br/>  handler : main.lambda_handler<br/>  events :<br/>   - http : POST /predictadult<br/></span></pre><p id="7dec" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">很好，现在让我们进入下一章:测试我们在本地构建的东西。</p><h2 id="d9ce" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.5 —测试我们在本地构建的内容:</h2><p id="9d86" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">所以现在是考验的时候了:</p><p id="464d" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">首先，您的本地目录应该如下所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es no"><img src="../Images/698df1bb88d158eae7d3d97b607ebe43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*an5DZ3oNagaHTJ2D-Fhjdg.png"/></div></div></figure><p id="eb81" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">现在我们的模型已经准备好了，我们的serverless.yml文件也准备好了，让我们在本地调用我们的serverless，并通过在命令行中运行以下命令来测试一切是否正常:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="11cc" class="md jk hi mz b fi nd ne l nf ng">serverless invoke local -f lgbm-lambda -d '{"body":[[3.900e+01, 7.000e+00, 1.300e+01, 4.000e+00, 1.000e+00, 0.000e+00,4.000e+00, 1.000e+00, 2.174e+03, 0.000e+00, 4.000e+01, 3.900e+01]]}'</span></pre><p id="9c5f" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如果您正确地遵循了这些步骤，您应该会从这个命令中得到一个输出。在这种情况下，输出是:</p><blockquote class="np"><p id="f4c8" class="nq nr hi bd ns nt nu nv nw nx ny kw dx translated">{ <br/>“状态码”:200，<br/>“正文”:0.0687186340046925 <br/> }</p></blockquote><p id="88b4" class="pw-post-body-paragraph kb kc hi kd b ke nz ij kg kh oa im kj kk ob km kn ko oc kq kr ks od ku kv kw hb bi translated">正如你所看到的，我们选择了选项<strong class="kd hj">调用本地</strong>，这意味着我们正在使用我们的计算机，而不是云，我们还通过“身体”字段只传递了1个样本(这些值是特征值，不是很优雅，为什么对吗？)</p><p id="5b74" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">所以，看起来一切都在本地工作，现在让我们部署我们的lambda。</p><h2 id="aad0" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.6 —部署到AWS:</h2><p id="bea0" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">所以，现在是部署时间:</p><p id="6c3c" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">一旦一切都设置好并开始工作，部署lambda就像运行以下命令行一样简单:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="11d6" class="md jk hi mz b fi nd ne l nf ng">serverless deploy</span></pre><p id="8e5c" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">就这样，你会开始看到一些关于包被推送的日志消息，你也会看到你的压缩包的大小。</p><h2 id="3eef" class="md jk hi bd jl me mf mg jp mh mi mj jt kk mk ml jv ko mm mn jx ks mo mp jz mq bi translated">2.7 —测试部署的模型:</h2><p id="fdd5" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">一旦deploy命令被正确执行，并且您的lambda被部署，您将获得您的端点(url ),我们将使用它来进行预测。这个url会是这样的<a class="ae oe" href="https://xxx/predictadult" rel="noopener ugc nofollow" target="_blank"> https://xxx/predictadult </a>:</p><p id="0c7b" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">为了测试我们的预测，我们将运行以下命令:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="ec52" class="md jk hi mz b fi nd ne l nf ng">curl -X POST <a class="ae oe" href="https://xxx/predictadult" rel="noopener ugc nofollow" target="_blank">https://xxx/predictadult</a> -d [[3.900e+01, 7.000e+00, 1.300e+01, 4.000e+00, 1.000e+00, 0.000e+00,4.000e+00, 1.000e+00, 2.174e+03, 0.000e+00, 4.000e+01, 3.900e+01]]</span></pre><p id="707d" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">就这样，恭喜你，你已经在AWS lambdas功能中部署了你的模型，现在可以为你服务了。</p><p id="bffc" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">如果你在重新运行上述教程时遇到任何错误，你可以联系我，我的联系方式在下面，我将非常乐意帮助你。</p><p id="e3d2" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">我希望你觉得这篇教程非常有见地和实用，我希望你在读完所有这些文字后，现在觉得自己是一个更好的数据科学家。</p><p id="9418" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">下次再见，同时如果你有任何问题要问我，或者你对未来的教程有什么建议，我的联系方式在下面。</p><h1 id="9dbd" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">关于我</h1><p id="fcd0" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">我是@ <a class="ae oe" href="https://www.cleverecommerce.com/" rel="noopener ugc nofollow" target="_blank"> Clever Ecommerce Inc </a>的首席数据科学家，我们利用基于人工智能的强大技术，帮助企业<a class="ae oe" href="https://cleverads.com/google-ads-automation?" rel="noopener ugc nofollow" target="_blank">创建和管理谷歌广告活动</a>。</p><p id="84ab" class="pw-post-body-paragraph kb kc hi kd b ke kx ij kg kh ky im kj kk kz km kn ko la kq kr ks lb ku kv kw hb bi translated">你可以通过中的<a class="ae oe" href="https://www.linkedin.com/in/oussama-errabia-0b1a14b3/" rel="noopener ugc nofollow" target="_blank">链接或者通过Gmail:errabia.oussama@gmail.com联系我。</a></p></div></div>    
</body>
</html>