<html>
<head>
<title>Deploying &amp; optimizing your django deployment with gunicorn (Why can’t i just use manage.py runserver?)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用gunicorn部署和优化您的django部署(为什么我不能只使用manage.py runserver？)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/deploying-optimizing-your-django-deployment-with-gunicorn-why-cant-i-just-use-manage-py-3ecb72cd6882?source=collection_archive---------6-----------------------#2020-07-05">https://medium.com/analytics-vidhya/deploying-optimizing-your-django-deployment-with-gunicorn-why-cant-i-just-use-manage-py-3ecb72cd6882?source=collection_archive---------6-----------------------#2020-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a0e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你的应用越来越受欢迎了。你扩展得很快。现在是时候开始考虑如何优化您的部署了。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/3349dd56da9a2ce6beaa7391ce066add.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*6zSRLgqo5KMcA-Hy4262bw.png"/></div></figure><p id="519e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将讨论:</p><ol class=""><li id="5290" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">什么是gunicorn(为什么我不能直接用manage.py runserver？)</li><li id="1f22" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">您的gunicorn部署的最佳设置(我需要多少工作人员)</li><li id="9f86" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">如果我已经在使用gunicorn，为什么还需要Nginx或Apache？</li><li id="05e6" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">每个工作线程多个线程</li><li id="9c25" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">绿色线程</li></ol><h2 id="20aa" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">什么是Gunicorn</h2><blockquote class="ku kv kw"><p id="1f95" class="if ig kx ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated">Gunicorn 'Green Unicorn '是一个用于UNIX的Python WSGI HTTP服务器。这是一个前叉工人模型。Gunicorn服务器广泛兼容各种web框架，实现简单，占用服务器资源少，速度相当快。</p></blockquote><p id="db59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Gunicorn是一个HTTP服务器，它加载您的WSGI应用程序(<a class="ae lb" href="https://en.wikipedia.org/wiki/Web_Server_Gateway_Interface" rel="noopener ugc nofollow" target="_blank">WSGI是什么？</a>)，‘分叉’它的一个拷贝到多个‘工作’进程，并通过它提供流量。因此，如果你在gunicorn中创建四个“工人”,你的应用程序可以同时处理四个web请求！</p><p id="141b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Gunicorn依靠操作系统的内核来为它进行负载平衡，并在它的工作进程之间分配工作，所以你不必这样做</p><p id="22f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种方法有几个优点:即使你的一个工作线程被终止了(<a class="ae lb" href="https://discuss.codechef.com/t/why-do-i-get-a-sigsegv/1773" rel="noopener ugc nofollow" target="_blank">可能是因为一个分段错误</a>)，你的web服务器也不会宕机。流量被无缝地重定向到其他健康的工作线程。</p><p id="183d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，如果您的一个或多个工作人员陷入了类似无限循环的情况，其他健康的工作人员仍然可以为请求提供服务。同步工作者之间没有内存共享(<a class="ae lb" href="https://docs.gunicorn.org/en/stable/design.html" rel="noopener ugc nofollow" target="_blank">什么意思？点击这里阅读更多关于同步和异步工人</a>的信息，这样无论一个工人进程遇到什么样的麻烦，它都不会给你的其他工人带来麻烦</p><p id="5ded" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Gunicorn还将恢复任何被操作系统杀死的工人，它还可以定期杀死和替换工人(例如，如果您的应用程序有内存泄漏，这将有助于遏制它)。了解更多:<a class="ae lb" href="https://docs.gunicorn.org/en/18.0/settings.html#max-requests" rel="noopener ugc nofollow" target="_blank">https://docs . guni corn . org/en/18.0/settings . html # max-requests</a></p><p id="398e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后也是最重要的:它加快了你的应用程序！使用manage.py，您一次只能接受一个请求。当您的Django应用程序等待外部API或数据库调用返回一些信息时，您的计算机处于空闲状态。更不用说manage.py只使用一个核心，因此如果您的计算机有多个可用的核心，其余的核心就不会被使用。Gunicorn工作人员在多个内核之间分配工作。</p><h2 id="81b5" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">Gunicorn部署的最佳设置</h2><p id="153f" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">好吧。我应该去管理Gunicorn。伟大的阿尤斯。但是我应该启动多少工人呢？</p><p id="7739" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我应该只用一个工人吗？四个？八个？八千？工人越多就越好吗？</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="d76c" class="jz ka hi li b fi lm ln l lo lp">The recommended formula for the number of Synchronous workers is (2 * number_of_cpus_you_want_to_use) + 1</span></pre><p id="2c89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是你应该经常使用的吗？不。不过这是个好的起点。更多的工人意味着更多的进程(这意味着更多的内存使用，因为每个工人都在单独加载你的整个应用程序)</p><p id="1810" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您的应用程序需要等待很长时间(如大型数据库查询、API调用等)，更多的并发将会有所帮助。这被称为I/O绑定应用程序。我们将在本文后面讨论另一种方法来代替使用workers:线程化&amp;绿色线程</p><p id="e576" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您的应用程序进行大量处理(假设您有一个微服务，其中您接受一些输入，并使用重型机器学习模型对该输入进行预测)，您可能只需要让它保持在2*cpu + 1。您甚至可以通过稍微减少这个数字来减少RAM的使用。这是因为如果你的CPU资源已经完全饱和，那么这几乎是你能从gunicorn中得到的所有优化。一旦您最大化了CPU，增加工作人员或使用AsyncIO不会带来显著的不同。</p><h2 id="1652" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">如果我已经在使用gunicorn，为什么还需要Nginx或Apache？</h2><p id="8b88" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">你会在互联网上看到同样的事情:你不应该使用gunicorn作为前端应用程序。您应该始终使用Nginx或Apache来反向代理Gunicorn。Gunicorn的官方网站也是这么说的:<a class="ae lb" href="https://docs.gunicorn.org/en/18.0/deploy.html" rel="noopener ugc nofollow" target="_blank">https://docs.gunicorn.org/en/18.0/deploy.html</a></p><blockquote class="ku kv kw"><p id="0858" class="if ig kx ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated">我们强烈建议在代理服务器后面使用Gunicorn。</p></blockquote><p id="1ede" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是为什么呢？Gunicorn已经在处理所有的负载了。通过第三方转发请求有什么意义？</p><p id="89da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有几个原因:</p><ol class=""><li id="7509" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">丢弃的请求:Gunicorn没有一个内置的队列，当请求进来时，它将请求排队，并在请求可用时将它们分发给其中一个工作线程。Gunicorn完全依靠操作系统内核来完成这项工作，内核会将一个作业分配给任何一个可用的工作者。<br/>但是如果找不到工人怎么办？假设你有9个工人，他们都很忙，又有一个请求进来？第10个请求会因IO错误而出错</li><li id="a3c6" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">缓冲:Gunicorn真的很容易DoS ( <a class="ae lb" href="https://en.wikipedia.org/wiki/Denial-of-service_attack#:~:text=In%20computing%2C%20a%20denial%2Dof,host%20connected%20to%20the%20Internet." rel="noopener ugc nofollow" target="_blank">什么是DoS攻击？)</a>，甚至无心。Gunicorn将立即读取发送给它的数据，一旦它完成读取数据，它将开始处理它。这意味着在接收数据时，gunicorn的worker是空着的:它除了等待数据流结束之外，没有做任何有价值的工作。恶意攻击者也可以利用这一点，根本不会完成数据流。它会启动一个连接，发送数据，但永远不会结束。如果您有9个工作人员，那么只需要9个这样的请求就可以让您的服务器脱机。<br/>即使没有恶意，gunicorn的工作人员仍然在浪费时间等待数据的到来。</li><li id="e25c" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">静态文件:Gunicorn不提供静态文件。它评估代码，仅此而已。请求一个静态文件，它会出错。</li><li id="57c2" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">安全性:如何保护gunicorn应用程序？Gunicorn的建造从来没有把安全性放在首位。像Nginx和Apache这样的大型web服务器有很多集成和插件来帮助抵御常见的威胁(参见<a class="ae lb" href="https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus/" rel="noopener ugc nofollow" target="_blank">https://www . Nginx . com/blog/remeding-DDOS-attacks-with-Nginx-and-Nginx-plus/</a>)</li><li id="efba" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">预处理:如果您想在数据到达应用服务器之前对其进行修改，该怎么办？一个很好的例子是，当您使用cloudflare时，cloudflare的IP将显示为客户端IP，而不是实际用户的IP。您可以使用Nginx来编辑请求并设置正确的X-FORWARDED-FOR头，这样您的应用程序就可以知道用户的真实IP，而无需特殊代码来处理CloudFlare的头(<a class="ae lb" href="https://support.cloudflare.com/hc/en-us/articles/200170786-Restoring-original-visitor-IPs-Logging-visitor-IP-addresses-with-mod-cloudflare-" rel="noopener ugc nofollow" target="_blank">https://support . cloud flare . com/HC/en-us/articles/20017 07 86-Restoring-original-visitor-IPs-Logging-visitor-IP-addresses-with-mod-cloud flare-</a>)</li></ol><p id="4a96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了解决所有这些问题，我们使用类似Nginx或Apache的反向代理。它将提供静态文件，如果没有工作人员响应请求，将请求排队，动态编辑请求并缓冲它们，这样您的gunicorns就不会浪费时间。Nginx和Apache还可以更好地与各种安全系统集成，以过滤请求和/或记录请求，发出警报等。</p><h2 id="5819" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">线</h2><p id="1321" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">从Gunicorn 19开始，您可以为每个工作进程创建多个线程。这很好，因为您现在可以在不消耗资源的情况下同时处理更多的请求。</p><p id="7b11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我应该有几根线？其实也差不多。</p><pre class="je jf jg jh fd lh li lj lk aw ll bi"><span id="ee14" class="jz ka hi li b fi lm ln l lo lp">workers * threads_per_worker = (2*cpu)+1</span></pre><p id="009e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么使用线程到底有什么意义呢？只产生9个工作进程不是比3个工作进程各有3个线程更好吗？区别在于线程共享内存。3个工作线程的3个线程组合将比9个工作线程的配置使用更少的内存。其次，多线程允许进程向主gunicorn进程发出信号，表明一个工人仍然活着，即使它正忙于一个高CPU任务(否则gunicorn会认为它处于无限循环中并杀死它)</p><h2 id="5fa9" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">绿色线程</h2><p id="4d8c" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">好了，现在我们有工人了。每个工人占用相当大的内存，所以我们不能有太多的工人。如果我们的需求是CPU受限的，这是没问题的，因为我们基本上最大化了机器，以获得最大的收益。</p><p id="0db6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是如果我们是I/O绑定的呢？如果我们的机器只是浪费大量时间等待事情发生呢？我们不能只产生几十或几百个工人，因为他们会用掉太多的资源。如果每个工作人员对一个慢速API(假设一个API需要一分钟以上的时间来响应)进行API调用，我们的服务器就会因为只有几十个并发用户而过载。</p><p id="79cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看起来单靠线程并不能帮助我们解决这个问题。但是Gunicorn还有另一个妙招:绿色线程(异步工作者)。</p><p id="160f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Python的整个协程支持相当惊人。有效的协同例程允许我们在一个操作系统线程中运行多个独立的代码。令人惊奇的是，由于绿色线程只是一个虚拟的概念，我们可以在一个worker中创建数百个甚至数千个绿色线程！所以一个工人可以同时处理成百上千的请求。</p><p id="1e5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那会有什么不同吗？对于CPU受限的应用程序来说，不会。但是如果您的工作人员花费大部分时间等待事情发生，协程允许工作人员简单地放弃控制，让其他线程在等待时做一些事情。</p><p id="988d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以创建9个workers，并设置它们每个都使用1000个eventlets。理论上允许gunicorn同时接受9000个请求。当然，如果您受到CPU的限制，这不会有什么不同，大多数请求会处理得很慢，以至于超时。但是，如果你是I/O绑定的，这可能会产生巨大的差异，因为当一个绿色线程等待一个缓慢的API时，其他绿色线程正在“共享”同一个工作线程来完成工作</p><h2 id="5ff8" class="jz ka hi bd kb kc kd ke kf kg kh ki kj iq kk kl km iu kn ko kp iy kq kr ks kt bi translated">结束了</h2><p id="a90f" class="pw-post-body-paragraph if ig hi ih b ii lc ik il im ld io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">因此，在本文中，我们涵盖了:为什么我们使用gunicorn，为什么我们使用反向代理连接到gunicorn，优化gunicorn的一些基本信息，线程和绿色线程如何工作，以及它们何时有用。</p><p id="0b53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想了解更多，这里有一些推荐读物:</p><p id="178a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于协程和绿色线程:</p><ol class=""><li id="493a" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated"><a class="ae lb" href="https://en.wikipedia.org/wiki/Coroutine#:~:text=Coroutines%20are%20computer%20program%20components,iterators%2C%20infinite%20lists%20and%20pipes." rel="noopener ugc nofollow" target="_blank">维基百科关于协同程序的文章</a></li><li id="952f" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">迷人的Python:用Python生成器实现“无重量线程”，作者David Mertz(2002年6月1日)</li><li id="3ae9" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae lb" href="https://eventlet.net/doc/patching.html" rel="noopener ugc nofollow" target="_blank">使用Eventlets在Python中打猴子补丁</a></li></ol><p id="b0ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于gunicorn工人:</p><ol class=""><li id="6ddb" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated"><a class="ae lb" href="https://stackoverflow.com/a/41696500/1639052" rel="noopener ugc nofollow" target="_blank"> Stackoverflow关于管理工人、线程的回答&amp;绿色线程</a></li><li id="a525" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated"><a class="ae lb" href="https://stackoverflow.com/questions/25834333/what-exactly-is-a-pre-fork-web-server-model" rel="noopener ugc nofollow" target="_blank"> Stackoverflow解释Gunicorn使用的Fork前工人模型</a></li></ol><p id="bbaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与我联系:</p><p id="5192" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae lb" href="https://twitter.com/AgentAayush" rel="noopener ugc nofollow" target="_blank">https://twitter.com/AgentAayush</a></p><div class="lq lr ez fb ls lt"><a href="https://www.linkedin.com/in/aayushagrawal101/" rel="noopener  ugc nofollow" target="_blank"><div class="lu ab dw"><div class="lv ab lw cl cj lx"><h2 class="bd hj fi z dy ly ea eb lz ed ef hh bi translated">Aayush Agrawal - Python开发者-proton shub Technologies | LinkedIn</h2><div class="ma l"><h3 class="bd b fi z dy ly ea eb lz ed ef dx translated">查看Aayush Agrawal在全球最大的职业社区LinkedIn上的个人资料。Aayush有2份工作列在…</h3></div><div class="mb l"><p class="bd b fp z dy ly ea eb lz ed ef dx translated">www.linkedin.com</p></div></div><div class="mc l"><div class="md l me mf mg mc mh jj lt"/></div></div></a></div><p id="5590" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请继续关注更多关于使用Docker &amp; Kubernetes将gunicorn配置带到云中以及利用Kubernetes的水平Pod自动伸缩和集群自动伸缩的文章</p></div></div>    
</body>
</html>