<html>
<head>
<title>Introduction to Airflow in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 中的气流简介</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/introduction-to-airflow-in-python-3bccc401cc1d?source=collection_archive---------1-----------------------#2020-12-04">https://medium.com/analytics-vidhya/introduction-to-airflow-in-python-3bccc401cc1d?source=collection_archive---------1-----------------------#2020-12-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7cd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">阿帕奇气流初学者指南</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/799ac3fc840e79aa155135a9e1926b15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RwYrA70Spx4xE0FX_iOARg.png"/></div></div></figure><h2 id="78d8" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">什么是工作流</h2><p id="7184" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">完成给定数据工程任务的一组步骤。这些可以包括任何给定的任务，例如下载文件、复制数据、过滤信息、写入数据库等等。</p><p id="b663" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作流的复杂程度各不相同。一些工作流可能只有 2 或 3 个步骤，而其他工作流包含数百个组件。</p><h2 id="43a3" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">什么是气流？</h2><p id="333d" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">Airflow 是一个编程工作流(常规)的平台，包括工作流的创建、调度和监控。Airflow 将工作流实现为 Dag 或有向非循环图。</p><p id="a0ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可以通过代码、命令行或内置的 web 界面来访问和控制气流。</p><p id="8261" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae kp" href="https://airflow.apache.org/docs/stable/" rel="noopener ugc nofollow" target="_blank">https://airflow.apache.org/docs/stable/</a></p><p id="307a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">数据工程工作流程可以由 Spotify 的 Luigi、微软的 SSIS 甚至 Bash 脚本来管理。</p><h1 id="3b79" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">熟练的技艺</h1><p id="c568" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">DAG 代表有向非循环图。</p><ul class=""><li id="2b3d" class="lh li hi ih b ii ij im in iq lj iu lk iy ll jc lm ln lo lp bi translated">在 Airflow 中，这表示组成工作流的一组任务。</li><li id="3044" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">它由任务和任务之间的依赖关系组成。</li><li id="f94e" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">创建的 DAG 包含有关 DAG 的各种详细信息，包括名称、开始日期、所有者等。</li></ul><h2 id="c85b" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">DAG 示例代码</h2><p id="7d80" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">使用 pipeline 的 dag_id 和包含 dag 的 start_date 的 default_args 字典创建新的 DAG。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lv"><img src="../Images/9b58e155a904f7160f4eca400bdfac78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y5DfrzTggO3ZnF7X1oBsMQ.png"/></div></div></figure><p id="e3ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 python 中它被当作一个变量标识符，其中<strong class="ih hj"> dag_etl </strong>是变量，在 Airflow shell 命令中，我们必须使用 dag_id。</p><h2 id="eafd" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">用于创建 DAG 的详细 python 代码</h2><p id="5945" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">当我们在 python 中创建 DAG 时，我们需要导入各自的库。这里，整个 DAG 是在一个名为 etl_dag 的变量下创建的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lw"><img src="../Images/76ccdc9670d273942137b14fee0a5e61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-x3j21RROf8fCUDS_SMwiA.png"/></div></div></figure><h2 id="ab23" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">在 Airflow 中运行工作流程</h2><p id="1a0c" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们可以使用不同的方法运行它，最简单的是使用 airflow 运行一个 shell 命令。Airflow run 有三个参数，一个 dag_id、一个 task_id 和一个 start_date。所有这些论点都有特定的含义</p><p id="5205" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">airflow -h 命令可以给出我们可以执行的所有可能的命令。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lx"><img src="../Images/74c324f5a53e576a7b0be48b6ff202d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C39jIvAFlY1IlpOrfN58dA.png"/></div></div></figure><h2 id="e3b5" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">CLI 与 Python-何时使用</h2><p id="0d8e" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">你可能不知道什么时候用什么？</p><h2 id="6026" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">硬币指示器 （coin-levelindicator 的缩写）命令行界面（Command Line Interface for batch scripting）</h2><ul class=""><li id="74d1" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">启动气流过程，手动运行 Dag，记录气流信息。</li></ul><h2 id="3a49" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">计算机编程语言</h2><ul class=""><li id="30b4" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">创建 DAG 并编辑 DAG 的属性。</li></ul><h1 id="4fbd" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">气流 Web 用户界面</h1><p id="f0db" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">我们可以从 web UI 中实现各种 CLI 功能。每个页面都有不同的选项，很容易理解。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mb"><img src="../Images/c03ec1649d3ed2953d22af525ed9ffbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ucxmYptsAOGmUtX8QRtgg.png"/></div></div></figure><p id="52b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们单击 DAG 名称时，我们可以看到该特定 DAG 及其依赖项的更多详细信息。我们还可以看到树视图和图形视图以及 Dag 的代码。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mc"><img src="../Images/e407cb2f0ce6dac1dd18311627593216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCsZWLYgp2JdPst-rS8XDw.png"/></div></div></figure><h1 id="626b" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">气流操作员</h1><p id="9bbc" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">操作员是气流中的一种任务。这些任务可以是运行命令、发送电子邮件、运行 Python 脚本等等。</p><ul class=""><li id="e62d" class="lh li hi ih b ii ij im in iq lj iu lk iy ll jc lm ln lo lp bi translated">代表工作流中的单个任务。</li><li id="b449" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">独立运行。</li><li id="39f5" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">不同的操作员执行不同的任务。</li></ul><p id="1a44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">流行的操作符是 Bash 和 python 操作符。</p><h2 id="66ae" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">bash 运算符</h2><p id="a304" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">它需要一些参数来运行，比如 task_id、bash_command 和 dag name。我们还需要在运行 BashOperator 之前导入它。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/e10ea8889bef82e43a3ff2268918553b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V7X9WWahBU7UCwfyI5404A.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">BashOperator 图像</figcaption></figure><h2 id="d6af" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">气流任务</h2><ul class=""><li id="6e60" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">简单地说，任务就是操作符的实例。</li><li id="974b" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">任务一般被赋给一个变量，在上面的 BashOperator 图片中，bash_task 就是一个变量。</li><li id="a1ea" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">在 airflow 中，工具只理解 task_id，而不理解变量名。</li><li id="0be5" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">任务相关性定义了任务完成的给定顺序。</li><li id="767a" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">这两个操作符帮助我们定义任务顺序，上游操作符&gt;&gt;下游操作符&lt;&lt;</li></ul><p id="d635" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Task1 &gt;&gt;任务 2</p><h1 id="0c99" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">Python 运算符</h1><ul class=""><li id="f74b" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">执行 Python 函数/ callable</li><li id="6cdd" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">操作类似于 BashOperator，但有更多的选项</li><li id="78c0" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">可以向 Python 代码传入参数</li></ul><p id="9bdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要从库中导入操作符，然后创建一个 python 函数，然后创建 python 操作符的一个实例。printme 下面是函数，python_task 是 python 运算符的实例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mi"><img src="../Images/f98421c9c526cdb4cc96479a273bb4dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dV7hGhdBWM9T7OYya9QBAQ.png"/></div></div></figure><p id="cbd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们还可以向 python 操作符添加参数、位置参数和关键字参数。</p><p id="bed6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">airflow.operators 库中有许多可用的操作符。比如帮助我们发送电子邮件的电子邮件操作员。</p><h1 id="476a" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">气流调度</h1><p id="f727" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">当提到气流中的调度时，我们必须谈论 DAG run。这是给定时间点的工作流实例。</p><ul class=""><li id="a7a4" class="lh li hi ih b ii ij im in iq lj iu lk iy ll jc lm ln lo lp bi translated">DAG 可以手动运行，也可以通过 scheduled_interval 运行。</li><li id="0dac" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">Dag 可以有运行、失败或成功状态。</li></ul><p id="a528" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用 Web UI，我们可以在浏览选项卡中看到更多关于状态的信息。</p><p id="95bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们计划 DAG 时，这些属性很有帮助。</p><ul class=""><li id="a3c6" class="lh li hi ih b ii ij im in iq lj iu lk iy ll jc lm ln lo lp bi translated">开始日期、结束日期、最大尝试次数、预定时间间隔</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mj"><img src="../Images/5f563edb57c22fe9dbfa76ee9c7b4009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gfTAaHzGliapZWycjdsKYA.png"/></div></div></figure><p id="24c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此处计划了一个具有不同参数的 DAG，DAG 的开始日期是 2020 年 12 月 4 日，并计划使用 cron 约定在每周三中午 12:30 运行。</p><h1 id="8d64" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">气流传感器</h1><p id="45f2" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">什么是传感器？</p><ul class=""><li id="63ec" class="lh li hi ih b ii ij im in iq lj iu lk iy ll jc lm ln lo lp bi translated">等待某一条件为真的一种运算符</li><li id="cc0c" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">文件的创建。</li><li id="4aec" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">数据库记录的上传</li><li id="1b18" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">来自 web 请求的某些响应</li></ul><p id="c301" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以定义任何条件，多长时间检查一次条件为真传感器被分配到任务。</p><p id="2c22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有各种传感器参数，如<strong class="ih hj">模式、poke_interval 和超时。</strong>有各种各样的传感器可以用来完成任何任务，比如 filesensor、HttpSensor 和 SqlSensor。</p><p id="edf5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">文件传感器检查某个位置是否存在文件。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mk"><img src="../Images/2aa2f9f19914b6862495b4786abb987e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hq_b_jVVwHl8mikL0eBc5Q.png"/></div></div></figure><h1 id="18ac" class="kq jq hi bd jr kr ks kt jv ku kv kw jz kx ky kz kc la lb lc kf ld le lf ki lg bi translated">气流执行器</h1><ul class=""><li id="966f" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">执行者运行任务</li><li id="85af" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">我们可以根据需要创建自己的遗嘱执行人</li><li id="bd96" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">SequentialExecutor、LocalExecutor 和 CeleryExecutor。</li></ul><h2 id="d484" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">顺序执行器</h2><ul class=""><li id="709e" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">默认气流执行器</li><li id="bb2d" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">一次运行一项任务</li><li id="9f8c" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">对调试有用</li><li id="37c8" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">不建议用于生产，因为它一次运行一个任务</li></ul><h2 id="2ae6" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">本地执行者</h2><ul class=""><li id="139f" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">在单一系统上运行</li><li id="669e" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">将任务视为流程，并行度由用户定义</li><li id="198b" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">可以利用给定主机系统的所有资源。</li></ul><h2 id="95a6" class="jp jq hi bd jr js jt ju jv jw jx jy jz iq ka kb kc iu kd ke kf iy kg kh ki kj bi translated">加速器</h2><ul class=""><li id="3e39" class="lh li hi ih b ii kk im kl iq ly iu lz iy ma jc lm ln lo lp bi translated">使用芹菜后端作为任务管理器。</li><li id="47a2" class="lh li hi ih b ii lq im lr iq ls iu lt iy lu jc lm ln lo lp bi translated">有点复杂，但功能强大。</li></ul><p id="0406" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过查看 airflow.cfg 或简单的 cli 命令 airflow list_dags 来检查正在使用哪个执行器</p><p id="6a64" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止，我们已经讨论了气流的基本原理。其他需要学习的重要内容是<strong class="ih hj">调试和故障排除，使用模板和分支。</strong></p></div></div>    
</body>
</html>