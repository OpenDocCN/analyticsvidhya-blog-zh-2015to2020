<html>
<head>
<title>Shopper Behavior Exploration and Market Basket Analysis using Apache Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache Spark进行购物者行为探索和购物篮分析</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/shopper-behavior-exploration-and-market-basket-analysis-using-spark-650656d6a0e1?source=collection_archive---------8-----------------------#2020-04-12">https://medium.com/analytics-vidhya/shopper-behavior-exploration-and-market-basket-analysis-using-spark-650656d6a0e1?source=collection_archive---------8-----------------------#2020-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/395eb6a7d9b723fa6670a21e6d7f2d18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oW38b5_Tp090JvUZ8aAJOg.jpeg"/></div></div></figure><p id="0fa4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi jo translated"><span class="l jp jq jr bm js jt ju jv jw di">在</span>这篇博客中，我将讲述我在一个3MM+记录的真实Instacart数据集上进行的购物者行为探索。我将讨论如何在<a class="ae kb" href="https://databricks.com/spark/about" rel="noopener ugc nofollow" target="_blank">数据块</a>上使用Apache Spark ML <code class="du jx jy jz ka b">FP-growth</code>算法快速运行您的购物篮分析。</p><p id="7990" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">购物篮分析</strong>是大型零售商用来发现商品之间关联的技术。它通过寻找经常一起购买的商品组合来工作，提供信息来理解购买行为。关联规则挖掘是用于购物篮分析的机器学习的一个非常重要的概念。我们来了解一下是什么。</p><h1 id="b4ac" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">关联规则挖掘</h1><p id="345a" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">关联规则可以被认为是一种“如果-那么”关系。简而言之，如果客户在购物篮中有一件商品<strong class="is hj"> A </strong>，关联规则有助于识别客户最有可能购买的另一件商品<strong class="is hj"> B </strong>。例如，如果一个顾客买了面包，那么他很可能也会买黄油。</p><p id="86a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">商店中有数千种不同产品的超市可以通过利用这些未开发的机会来识别所购买商品之间的关系，从而增加收入和利润。他们可以通过将经常一起购买的商品放在同一个通道，优化他们的目录设计，在他们的网站上交叉销售集体折扣的商品，以及分析客户行为分析等方式来做到这一点。</p><p id="47c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用于定义关联规则的两个重要指标是<strong class="is hj">支持度</strong>和<strong class="is hj">置信度</strong>。每个关联规则应该同时具有最小置信度和最小支持度，这些通常是用户指定的。</p><p id="e349" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们用2项(假设)<strong class="is hj"> <em class="lf"> X </em> </strong>和<strong class="is hj"> <em class="lf"> Y </em> </strong>来看看什么是支持、信心和提升度量。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div class="er es lg"><img src="../Images/eb7338c5c3b608a1e94796c4ce6e3010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*9OMyVPEvodxireSIX6aZxQ.png"/></div></figure><p id="a404" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">支持:- </strong>支持定义为项目<strong class="is hj"> <em class="lf"> X </em> </strong>和<strong class="is hj"> <em class="lf"> Y </em> </strong> <em class="lf"> </em>在总交易次数中被一起购买的频率。这个度量告诉我们一个项目集在所有事务中出现的频率。</p><p id="0a04" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">置信度:- </strong>置信度是一起购买<strong class="is hj"> X </strong> <em class="lf"> </em>和<strong class="is hj"> <em class="lf"> Y </em> </strong> <em class="lf"> </em>的频率超过单独购买<strong class="is hj"> <em class="lf"> X </em> </strong> <em class="lf"> </em>的频率。</p><p id="7ded" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">提升:- </strong>提升定义为支撑超过支撑为<strong class="is hj"> <em class="lf"> X </em> </strong> <em class="lf"> </em>乘以支撑为<em class="lf"> Y </em>。把lift想象成在知道<strong class="is hj"><em class="lf"/></strong>X<strong class="is hj"><em class="lf"/></strong>在不知道<strong class="is hj"> <em class="lf"> X </em> </strong>存在的情况下，推车上有<strong class="is hj"> <em class="lf"> Y </em> </strong>的概率比推车上有<strong class="is hj"> <em class="lf"> Y </em> </strong>的概率高。</p><p id="53f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将在稍后实现<code class="du jx jy jz ka b">FP-growth</code>算法时使用这些指标。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h1 id="5d72" class="kc kd hi bd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv lw kx ky kz bi translated">资料组</h1><p id="78e2" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">在这篇博客中，我使用的数据集是2017年在Kaggle上发布的<strong class="is hj"> Instacart的真实数据集</strong>。</p><p id="6176" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lf">这是一个匿名数据集，包含来自200，000多名Instacart用户的300多万份杂货订单样本。对于每个用户，大约有4到100个订单，每个订单中有购买产品的顺序。</em></p><p id="6da2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据集可以从<a class="ae kb" href="https://www.kaggle.com/c/instacart-market-basket-analysis/data" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><h1 id="1529" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">使用的平台</h1><p id="0c0e" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">我将使用Apache Spark来实现这个项目，并使用<strong class="is hj"> PySpark </strong>、<strong class="is hj"> SparkSql </strong>和后来的<strong class="is hj"> Scala </strong>编程语言来编码。</p><p id="93c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意，您可以通过这个<a class="ae kb" href="https://databricks.com/spark/about" rel="noopener ugc nofollow" target="_blank">链接</a>免费试用Databricks cloud上的Apache Spark。</p><p id="ac34" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，理论到此为止，让我们来看看代码。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h2 id="e920" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated"><strong class="ak">将所有可用文件导入Spark数据帧并创建临时表格</strong></h2><p id="e638" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">数据集有六种不同的。可以合并在一起进行分析的csv文件。首先，我在Spark环境中导入了所有6个文件，并创建了临时表来运行Spark SQL查询。</p><figure class="lh li lj lk fd ij"><div class="bz dy l di"><div class="ml mm l"/></div><figcaption class="mn mo et er es mp mq bd b be z dx translated">文件导入Spark数据框架</figcaption></figure><p id="aed5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看每个导入文件的<strong class="is hj">前5行</strong>以及它们的<strong class="is hj">数据字典</strong>:</p><blockquote class="mr ms mt"><p id="6ae2" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><code class="du jx jy jz ka b"><em class="hi">orders</em></code> <em class="hi"> (3.4m行，206k用户):</em></p></blockquote><ul class=""><li id="5019" class="mx my hi is b it iu ix iy jb mz jf na jj nb jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">order_id</code>:订单标识符</li><li id="da22" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">user_id</code>:客户标识符</li><li id="e778" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">eval_set</code>:该订单属于哪个评估集</li><li id="6b4f" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">order_number</code>:该用户的订单序号(1 =第一个，n =第n个)</li><li id="f8c8" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">order_dow</code>:下订单的那一天</li><li id="2418" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">order_hour_of_day</code>:下单当天的小时</li><li id="3608" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">days_since_prior</code>:自上一次订单以来的天数，上限为30天(NAs为<code class="du jx jy jz ka b">order_number</code> = 1)</li></ul><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="fa95" class="lx kd hi ka b fi np nq l nr ns">orders.show(n=5)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nt"><img src="../Images/68838a8c92d170e26e6e9325505a491a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vjPhTfmp5VcoAbucq7NGaQ.png"/></div></div></figure><blockquote class="mr ms mt"><p id="8628" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><code class="du jx jy jz ka b"><em class="hi">products</em></code> <em class="hi"> (50k行):</em></p></blockquote><ul class=""><li id="74f5" class="mx my hi is b it iu ix iy jb mz jf na jj nb jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">product_id</code>:产品标识符</li><li id="59b3" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">product_name</code>:产品名称</li><li id="8e54" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">aisle_id</code>:外键</li><li id="1d3b" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">department_id</code>:外键</li></ul><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="8e6a" class="lx kd hi ka b fi np nq l nr ns">products.show(n=5)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/3f12d24a9ba86a1ca24b40c3ffaa34b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*txBdYPobuoEJSHhrKDKLFQ.png"/></div></div></figure><blockquote class="mr ms mt"><p id="ae53" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><code class="du jx jy jz ka b"><em class="hi">aisles</em></code> <em class="hi"> (134行):</em></p></blockquote><ul class=""><li id="e8d0" class="mx my hi is b it iu ix iy jb mz jf na jj nb jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">aisle_id</code>:过道标识符</li><li id="1c6d" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">aisle</code>:过道的名称</li></ul><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="b517" class="lx kd hi ka b fi np nq l nr ns">aisles.show(n=5)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/a70b1c4584354c4391fc298707898727.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*70xe58vcm9Ty7Wqdf4SDBg.png"/></div></div></figure><blockquote class="mr ms mt"><p id="658b" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><code class="du jx jy jz ka b"><em class="hi">deptartments</em></code> <em class="hi"> (21行):</em></p></blockquote><ul class=""><li id="ae3e" class="mx my hi is b it iu ix iy jb mz jf na jj nb jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">department_id</code>:部门标识</li><li id="98ea" class="mx my hi is b it ng ix nh jb ni jf nj jj nk jn nc nd ne nf bi translated"><code class="du jx jy jz ka b">department</code>:部门名称</li></ul><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="14f9" class="lx kd hi ka b fi np nq l nr ns">departments.show(n=5)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/451920b6115ebd0b8bcb8f72d7c8c30a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1AzfodAgIlNuC5SMaP1ZNA.png"/></div></div></figure><blockquote class="mr ms mt"><p id="ba1e" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><code class="du jx jy jz ka b"><em class="hi">order_products_train</em></code> <em class="hi"> (131K+行):</em></p></blockquote><p id="5e39" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">向Kaggle参与者提供的培训数据</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="3e4a" class="lx kd hi ka b fi np nq l nr ns">order_products_train.show(n=5)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/b0c526f2d4cf4f94de8409ab630f58b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XPd8asJpscJ5BifE7m-pvg.png"/></div></div></figure><blockquote class="mr ms mt"><p id="9a86" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><code class="du jx jy jz ka b"><em class="hi">order_products_prior</em></code> <em class="hi"> (32MM+排):</em></p></blockquote><p id="a30d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该用户最近订单之前的订单数据</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="7705" class="lx kd hi ka b fi np nq l nr ns">order_products_prior.show(n=5)</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/77987c08871836d46d0c3c64811d5b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jeyBkgnv9IL2WvZBCmLM3w.png"/></div></div></figure><p id="0684" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">既然我们已经创建了数据帧并浏览了每个文件的前5行，让我们使用 <strong class="is hj"> Spark SQL </strong>继续使用<strong class="is hj"> EDA，从Instacart数据集中寻找见解和模式。</strong></p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h1 id="8f7b" class="kc kd hi bd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv lw kx ky kz bi translated">探索性数据分析</h1><h2 id="f924" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">顾客在一天中的什么时候购物？</h2><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="d3fe" class="lx kd hi ka b fi np nq l nr ns">df = sqlContext.sql("select count(order_id) as total_orders, order_hour_of_day as hour <br/>from orders <br/>group by order_hour_of_day <br/>order by order_hour_of_day")<br/>df.show()</span></pre><blockquote class="mr ms mt"><p id="e956" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated"><em class="hi">注意:使用Databricks笔记本，我们可以使用</em> <code class="du jx jy jz ka b"><em class="hi">%sql</em></code> <em class="hi">在同一个Python笔记本中的新单元格内执行SQL代码。例如，上面代码片段的等价代码如下所示。</em></p></blockquote><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="19d9" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select count(order_id) as total_orders, order_hour_of_day as hour <br/>from orders <br/>group by order_hour_of_day <br/>order by order_hour_of_day</span></pre><p id="6f19" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lf">注:Databricks支持笔记本单元格内各种类型的数据帧和</em> <em class="lf"> SQL可视化。你可以在这里</em>  <em class="lf">了解更多关于他们的</em> <a class="ae kb" href="https://docs.databricks.com/notebooks/visualizations/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="lf">。</em></a></p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nv"><img src="../Images/f329773707b68fbfe61c8a70a47e8104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B89aeGleGjwip0pWln4EvQ.png"/></div></div></figure><p id="87d6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"/>上图<strong class="is hj"> </strong>折线图显示，客户更有可能在上午9点到下午6点之间下单</p><h2 id="2bbd" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">客户多久下一次订单？</h2><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="0cbe" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select days_since_prior_order,count(order_id) as total_orders<br/>from orders <br/>group by days_since_prior_order <br/>order by days_since_prior_order</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/47e93f296a0331d90301f2040bed4ead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5v3XLsZILoFg_e9Xk0x6g.png"/></div></div></figure><p id="96ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于大多数记录都集中在0到7天之间，因此大多数客户似乎每周订购一次</p><p id="7416" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"/>此外，许多客户在30天或之后下订单，因为“days_since_prior”列的上限为30天</p><h2 id="e99c" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">一周中的哪一天顾客购买最多？</h2><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="cf61" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select count(order_id) as total_orders, <br/>  (case <br/>     when order_dow = '0' then 'Sunday'<br/>     when order_dow = '1' then 'Monday'<br/>     when order_dow = '2' then 'Tuesday'<br/>     when order_dow = '3' then 'Wednesday'<br/>     when order_dow = '4' then 'Thursday'<br/>     when order_dow = '5' then 'Friday'<br/>     when order_dow = '6' then 'Saturday'              <br/>   end) as day_of_week <br/>  from orders  <br/> group by order_dow <br/> order by total_orders desc</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/05a15b0d2b010acd716fe8d18857c120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rS5ImX5jzuDpQmtwTADzQA.png"/></div></div></figure><p id="55bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">周日和周一的订单最多，而周四的订单最少</p><h2 id="c97c" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">客户在一份订单中购买多少件商品？</h2><p id="39d9" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">让我们通过将products、departments、order_products_train和order_products_prior数据集合并在一起来创建一个主数据集，并在其上运行查询。</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="4e6d" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>create table master_table as<br/>(select op.*,p.product_name,p.aisle_id,p.department_id,d.department from<br/> (select * from order_products_train <br/> union<br/> select * from order_products_prior) as op<br/> inner join products as p<br/> on op.product_id = p.product_id<br/> inner join departments as d<br/> on p.department_id = d.department_id)</span><span id="3c7f" class="lx kd hi ka b fi nw nq l nr ns">%sql<br/>select order_id,count(product_id) as total_items<br/>from master_table <br/>group by order_id</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/4497b1622e61b8348a9fb3250000c584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iCfIeiFDjaEIl4jQ_Sy-wA.png"/></div></div></figure><p id="43c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"/>上图显示，顾客最常购买的商品数量是4</p><p id="282b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"/>大多数<strong class="is hj"> </strong>顾客更喜欢每份订单购买1至15件商品</p><h2 id="d4f0" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">订单来自哪些顶级部门？</h2><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="976f" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select department, count(*) as orders_count from master_table<br/>group by department<br/>order by orders_count desc<br/>limit 10</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nu"><img src="../Images/0ab514006dc2de0559b17f111fe9a74a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dPQgvRBdC6XkikebZG00Uw.png"/></div></div></figure><p id="b2a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"/>如果我们看一下购买最多物品的前10个部门，我们会推断，几乎50%的购买物品来自两个部门，即“<em class="lf">生产</em>和“<em class="lf">乳制品鸡蛋</em></p><h2 id="93dd" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">哪些是购买最多的商品？</h2><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="3263" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select product_name, count(*) as orders_count from master_table<br/>group by product_name<br/>order by orders_count desc<br/>limit 200</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nx"><img src="../Images/b954f2eca3bb8d5753bcaa57b3825123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y5OeZlpBGJauTse6M5tOHg.png"/></div></div></figure><p id="1d73" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">▽</strong>这是Instacart客户在订单中购买的前8项商品。香蕉似乎是篮子里最常买的东西，其次是草莓、菠菜、鳄梨等。</p><p id="73bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们也来做一个Instacart客户购买的前200件商品的词云。</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="e414" class="lx kd hi ka b fi np nq l nr ns"># !pip install wordcloud<br/>from wordcloud import WordCloud <br/>import matplotlib.pyplot as plt</span><span id="32de" class="lx kd hi ka b fi nw nq l nr ns">df = sqlContext.sql("SELECT product_name FROM (select product_name, count(*) as orders_count from master_table group by product_name order by orders_count desc limit 200)")<br/>df2 = df.rdd.flatMap(lambda x: x).collect()<br/>fullStr = ' '.join(df2)</span><span id="fe27" class="lx kd hi ka b fi nw nq l nr ns">wordcloud = WordCloud(background_color="white").generate(fullStr)</span><span id="8d82" class="lx kd hi ka b fi nw nq l nr ns"># Display the generated image:<br/>plt.figure(figsize=(14, 10))<br/>plt.imshow(wordcloud, interpolation='bilinear')<br/>plt.axis("off")<br/>plt.show()<br/>display()</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nx"><img src="../Images/08ecf9c45617edb41fba72413170afd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8iSszHZ-NpzZKHuEmBn9gw.png"/></div></div></figure><p id="43d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从词云来看，似乎美国人购买<strong class="is hj"> <em class="lf">有机食品</em></strong><strong class="is hj"><em class="lf">蔬菜</em> </strong>很多，像<em class="lf">有机、牛奶、水、苹果、起泡酒、鸡蛋、绿色、奶酪</em>等词。是最受关注的。</p></div><div class="ab cl ll lm gp ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="hb hc hd he hf"><h1 id="6b48" class="kc kd hi bd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv lw kx ky kz bi translated">FP-增长算法</h1><p id="032e" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">FP-growth算法在Han等人的论文<a class="ae kb" href="http://dx.doi.org/10.1145/335191.335372" rel="noopener ugc nofollow" target="_blank">中进行了描述，在没有候选生成的情况下挖掘频繁模式</a>，其中“FP”代表频繁模式。给定一个事务数据集，FP-growth的第一步是计算项目频率并识别频繁项目。不同于<a class="ae kb" href="http://en.wikipedia.org/wiki/Apriori_algorithm" rel="noopener ugc nofollow" target="_blank">为同一目的设计的类似先验的</a>算法，FP-growth的第二步使用后缀树(FP-tree)结构对事务进行编码，而无需显式生成候选集，生成候选集通常很昂贵。在第二步之后，可以从FP-树中提取频繁项集。</p><blockquote class="mr ms mt"><p id="b9ed" class="iq ir lf is b it iu iv iw ix iy iz ja mu jc jd je mv jg jh ji mw jk jl jm jn hb bi translated">你可以在这里了解更多关于FP-growth算法 <a class="ae kb" href="https://www.softwaretestinghelp.com/fp-growth-algorithm-data-mining/" rel="noopener ugc nofollow" target="_blank">涉及的<strong class="is hj">步骤。</strong></a></p></blockquote><h2 id="3e24" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">按购物篮组织数据</h2><p id="7765" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">为了实现FP-growth，首先，我们将在数据集中创建每个订单的购物篮。我们将通过创建一个包含两列的<em class="lf"> baskets </em>数据帧来实现这一点:首先是<em class="lf"> order_id </em>，其次是以该特定订单购买的商品列表。</p><figure class="lh li lj lk fd ij"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="80aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是要输入到FP-growth算法中的<em class="lf">篮子</em>数据帧的前5行。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/95fd76bb782e5842685697b6a5abd444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHdQcHZtKSrcaURztiPCcg.png"/></div></div></figure><h2 id="dea3" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">用Scala实现FP-growth算法</h2><p id="3c42" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">这里，我们将使用<code class="du jx jy jz ka b">spark.ml</code>的FP-growth包来实现。</p><p id="6b49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从取最小支持值为0.001和最小置信度值为0开始。这两个阈值都是用户定义的。选择最小支持值，使得在我们的项目集中至少有1个项目，并且不需要太多的计算时间(较小的最小支持值导致更多的计算时间)。</p><figure class="lh li lj lk fd ij"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="4bf1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">生成<strong class="is hj">频繁项集</strong>并建立<strong class="is hj">关联规则</strong></p><figure class="lh li lj lk fd ij"><div class="bz dy l di"><div class="ml mm l"/></div></figure><p id="2aed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们研究一下上面生成的频繁项目集。</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="3e46" class="lx kd hi ka b fi np nq l nr ns"><br/>%sql<br/>select items, freq from mostPopularItemInABasket where size(items) &gt; 2 order by freq desc limit 20</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/2f3f695600442411ac7d42f9e5289032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oB3iVQJWtA8YE_YpVxEwiA.png"/></div></div></figure><p id="af19" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">篮子里最常见的物品包括有机鳄梨、有机草莓和有机香蕉。</p><p id="aea0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">思考<em class="lf">关联规则</em>的一个好方法是，模型决定了如果你购买了某样东西(即<em class="lf">前因</em>)，那么你将以如下信心购买另一样东西(即<em class="lf">后果</em>)。</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="842e" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select antecedent as `antecedent (if)`, consequent as `consequent (then)`, confidence from ifThen order by confidence desc limit 20</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/a7fd07d0b82e53352bb3fa2eb1a7f9b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G_D42BEYMINdl1MOwReuFQ.png"/></div></div></figure><p id="19fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述结果表明，如果顾客的篮子里有<em class="lf">有机覆盆子、有机鳄梨</em>和<em class="lf">有机草莓</em>，那么推荐有机香蕉也是有意义的。令人惊讶的是，10大购买建议不是有机香蕉就是香蕉。</p><p id="c9cf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">度量<em class="lf">提升</em>定义了项目集中<em class="lf">前件</em>和<em class="lf">后件</em>的独立程度。<em class="lf">Lift</em><em class="lf">&gt;&gt;1</em>表示项目之间高度依赖，<em class="lf"> lift </em> <em class="lf"> = 1 </em>表示项目之间相互独立，l <em class="lf"> ift &lt; &lt; 1 </em>表示项目之间相互替代(这意味着一个项目的存在会对另一个项目的存在产生负面影响，反之亦然)。</p><pre class="lh li lj lk fd nl ka nm nn aw no bi"><span id="d16c" class="lx kd hi ka b fi np nq l nr ns">%sql<br/>select * <strong class="ka hj">from</strong> <strong class="ka hj">ifThen</strong> where lift &gt; 1 order by lift desc</span></pre><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ny"><img src="../Images/a9300a7f8cf10b91987d55808c8f46c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pk0Ku9xf-EXIEFDhT6oYSQ.png"/></div></div></figure><p id="d42c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如我们在上面的结果中看到的，其中有<em class="lf">关联规则</em>在降低<em class="lf">提升</em>的值，如果有人购买<em class="lf">草莓大黄酸奶</em>，那么也有很高的几率购买<em class="lf">蓝莓酸奶</em>。</p><h2 id="9675" class="lx kd hi bd ke ly lz ma ki mb mc md km jb me mf kq jf mg mh ku jj mi mj ky mk bi translated">用PySpark实现FP-growth算法</h2><p id="4572" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">我们上面使用Scala实现的FP-growth算法也可以使用PySpark实现，其等效代码如下所示:</p><figure class="lh li lj lk fd ij"><div class="bz dy l di"><div class="ml mm l"/></div></figure><h1 id="962e" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">摘要</h1><p id="7868" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">在这篇博客中，我们分析了客户的购物行为，并使用Apache Spark对一个庞大的数据集进行了购物篮分析。如果想在其他环境下实现购物篮分析，可以使用Python中的<a class="ae kb" href="https://pypi.org/project/apyori/" rel="noopener ugc nofollow" target="_blank"> <em class="lf"> apyori </em> </a>库和R中的<a class="ae kb" href="https://cran.r-project.org/web/packages/arules/index.html" rel="noopener ugc nofollow" target="_blank"> <em class="lf"> arules </em> </a>库用于<em class="lf"> Apriori算法</em>。</p><p id="c754" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">好了，这篇文章就到这里。我希望你们喜欢看它，请在评论区分享你们的建议/观点/问题。</p><p id="96e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读！！！</p><p id="81c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参考资料:-</p><p id="3ca2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">I)<a class="ae kb" href="https://spark.apache.org/docs/latest/ml-frequent-pattern-mining.html" rel="noopener ugc nofollow" target="_blank">https://spark . Apache . org/docs/latest/ml-frequency-pattern-mining . html</a></p><p id="fc5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ii)<a class="ae kb" href="https://s3.us-east-2.amazonaws.com/databricks-dennylee/notebooks/Market+Basket+Analysis+using+Instacart+Online+Grocery+Dataset.html" rel="noopener ugc nofollow" target="_blank">https://S3 . us-east-2 . Amazon AWS . com/data bricks-Denny lee/notebooks/Market+Basket+Analysis+using+insta cart+Online+杂货+Dataset.html </a></p><p id="51c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">iii)<a class="ae kb" href="https://towardsdatascience.com/association-rules-2-aa9a77241654" rel="noopener" target="_blank">https://towards data science . com/association-rules-2-aa9a 77241654</a></p></div></div>    
</body>
</html>