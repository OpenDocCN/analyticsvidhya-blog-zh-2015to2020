<html>
<head>
<title>Calculating distances from Points to Polygon Borders in Python — A Paris Example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Python中计算点到面边界的距离-以巴黎为例</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/calculating-distances-from-points-to-polygon-borders-in-python-a-paris-example-3b597e1ea291?source=collection_archive---------0-----------------------#2020-03-19">https://medium.com/analytics-vidhya/calculating-distances-from-points-to-polygon-borders-in-python-a-paris-example-3b597e1ea291?source=collection_archive---------0-----------------------#2020-03-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bccf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有许多很棒的包可以帮助你在Python中处理地理空间数据。然而，如果你需要定制，这可能会变得棘手。</p><p id="565e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想展示如何计算纬度、经度对和多边形之间的米距离。考虑到我不想计算到多边形中点的距离，而是到最近的边界的距离。</p><p id="4368" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将用下面的例子来说明这一点:圣母院离每个区有多远？</p><p id="e70f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有代码都在我的<a class="ae jd" href="https://github.com/tmationmax/medium_polygon_distance/tree/master" rel="noopener ugc nofollow" target="_blank"> Git </a>里。我将包括相关函数的链接，而不是在这篇文章中写出语法。</p><h1 id="796a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">设置您的环境并获取数据</strong></h1><p id="f883" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了可视化，我们将使用python中的<code class="du kh ki kj kk b">folium</code>库。对于几何图形，我们将使用<code class="du kh ki kj kk b">geopy</code>。使用以下内容安装软件包:</p><p id="feac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kh ki kj kk b">pip install folium geopy</code></p><p id="3266" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想用巴黎各区的数据来展示这个方法。请从<a class="ae jd" href="https://www.data.gouv.fr/en/datasets/arrondissements-1/#_" rel="noopener ugc nofollow" target="_blank">https://www.data.gouv.fr/en/datasets/arrondissements-1/#_</a>下载GeoJSON文件，并将文件保存在您的项目根目录下。</p><p id="8e0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们来看看这个区以及巴黎圣母院的位置。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kl"><img src="../Images/3e59c71b4412b6358c2666a074ac2601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ndhe4prCc0ryOKfmOYXnbw.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">巴黎行政区和圣母院的位置</figcaption></figure><p id="7869" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是生成这张地图的代码。</p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="3c62" class="lf jf hi kk b fi lg lh l li lj">import folium<br/>from folium.features import DivIcon<br/>import geojson<br/><br/>with open('arrondissements.geojson') as f:<br/>    data = geojson.loads(f.read())<br/><br/># Set your point of interest. In our case that is Notre Dame.<br/>poi_name = 'Notre Dam'<br/>poi = [48.864716, 2.349014]</span><span id="33f8" class="lf jf hi kk b fi lk lh l li lj"># Map it!<br/>m = folium.Map(location=poi, zoom_start=12, tiles='cartodbpositron')</span><span id="0be4" class="lf jf hi kk b fi lk lh l li lj"># Display Arrondissements<br/>folium.GeoJson(data).add_to(m)</span><span id="a33f" class="lf jf hi kk b fi lk lh l li lj"># Display Arrondissements Numbers<br/>for arrond in data['features']:<br/>    loc = arrond['properties']['geom_x_y']<br/>    nr = arrond['properties']['c_ar']<br/>    folium.map.Marker(location=loc, icon=DivIcon(<br/>        icon_size=(150, 36),<br/>        icon_anchor=(0, 0),<br/>        html='&lt;div style="font-size: 15pt; color:rgb(41,111,255)"&gt;{}&lt;/div&gt;'.format(str(nr))<br/>    )).add_to(m)<br/><br/># Display POI<br/>folium.CircleMarker(location=poi, color='red', radius=5, fill='red').add_to(m)</span><span id="65b8" class="lf jf hi kk b fi lk lh l li lj"># Display POI Name<br/>folium.map.Marker(location=poi, icon=DivIcon(<br/>    icon_size=(150, 36),<br/>    icon_anchor=(0, 0),<br/>    html='&lt;div style="font-size: 18pt; color: red"&gt;{}&lt;/div&gt;'.format(poi_name)<br/>)).add_to(m)<br/><br/>m.save('map_1.html')</span></pre><h1 id="74af" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">计算到一个区的距离</strong></h1><p id="7ce8" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">尽管Python非常适合计算笛卡尔坐标系中的距离，但是如果您正在处理地理空间数据，则需要一些变通方法。</p><ol class=""><li id="77ab" class="ll lm hi ih b ii ij im in iq ln iu lo iy lp jc lq lr ls lt bi translated">库的输出需要转换成可用的度量。见@jbndir回复<a class="ae jd" href="https://stackoverflow.com/questions/39211879/how-can-calculate-the-real-distance-between-two-points-with-geodjango" rel="noopener ugc nofollow" target="_blank">此处</a>。</li><li id="b9db" class="ll lm hi ih b ii lu im lv iq lw iu lx iy ly jc lq lr ls lt bi translated">距离计算需要考虑地球的球形。我们可以使用<a class="ae jd" href="https://en.wikipedia.org/wiki/Haversine_formula" rel="noopener ugc nofollow" target="_blank">哈弗辛</a>公式来计算大圆距离，如这里所概述的<a class="ae jd" href="http://www.movable-type.co.uk/scripts/latlong.html" rel="noopener ugc nofollow" target="_blank">。(注意，这对于长距离变得越来越重要)</a></li></ol><h2 id="5102" class="lf jf hi bd jg lz ma mb jk mc md me jo iq mf mg js iu mh mi jw iy mj mk ka ml bi translated">另一个挑战——测量到什么的距离？</h2><p id="971f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我们想测量点到多边形的距离。但是多边形可以被分割成各种线段和点。我们应该测量到线、点到点的距离还是两者都测量？</p><p id="f177" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一个简单的例子:</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es mm"><img src="../Images/67789fb0a6d56a3471f7e5bce31b3d68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yL3pw3MO1KETHoLxTxNm3w.png"/></div></div></figure><p id="f944" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在A和B之间有一条线，想计算到c的最小距离，众所周知，最短距离是到AB线上的正交投影，线上最近的点是x。</p><p id="ac59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，在下面这个简单的例子中，我们不能投影一条正交线，这就是为什么最小距离是到最近点的距离。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es mn"><img src="../Images/7d70f888bb5fa19a02b8ca8a2b9930b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVp5PcsMJGG_hQNacalR5Q.png"/></div></div></figure><h2 id="2429" class="lf jf hi bd jg lz ma mb jk mc md me jo iq mf mg js iu mh mi jw iy mj mk ka ml bi translated">中间地带—测量到中点的距离！</h2><p id="a436" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">为了保持我们的算法精简，让我们不要考虑这些具体情况，总是计算到我们的线的中点的距离。尤其是在精确定义的多边形中(在小空间上)，差异可以忽略不计。</p><p id="5ef7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们按照这里<a class="ae jd" href="http://www.movable-type.co.uk/scripts/latlong.html" rel="noopener ugc nofollow" target="_blank">概述的中点计算</a>和这里Python中的实现<a class="ae jd" href="https://stackoverflow.com/questions/27461634/calculate-distance-between-a-point-and-a-line-segment-in-latitude-and-longitude?rq=1" rel="noopener ugc nofollow" target="_blank">(谢谢，@nelfin)。</a></p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="d502" class="lf jf hi kk b fi lg lh l li lj">def midpoint(a, b):<br/>... </span><span id="9d45" class="lf jf hi kk b fi lk lh l li lj">Please find the function <a class="ae jd" href="https://github.com/tmationmax/medium_polygon_distance/blob/master/func_util.py#L6" rel="noopener ugc nofollow" target="_blank">here</a>.</span></pre><p id="ddb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了中点，我们现在可以计算到点的距离:</p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="32cb" class="lf jf hi kk b fi lg lh l li lj">def calculate_dist_to_line(line_a_lat, line_a_lng, line_b_lat, line_b_lng, point_object):<br/>...</span><span id="d0f9" class="lf jf hi kk b fi lk lh l li lj">Please find the function <a class="ae jd" href="https://github.com/tmationmax/medium_polygon_distance/blob/master/func_util.py#L29" rel="noopener ugc nofollow" target="_blank">here</a>.</span></pre><p id="2b80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一个多边形由许多不同的线组成，这就是为什么我们需要遍历所有的线并找到距离最小的一条线:</p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="327d" class="lf jf hi kk b fi lg lh l li lj">def get_min_distance_to_arr(arr_coords, point_object, unit='m'):<br/>...</span><span id="b0d0" class="lf jf hi kk b fi lk lh l li lj">Please find the function <a class="ae jd" href="https://github.com/tmationmax/medium_polygon_distance/blob/master/func_util.py#L36" rel="noopener ugc nofollow" target="_blank">here</a>.</span></pre><h2 id="5295" class="lf jf hi bd jg lz ma mb jk mc md me jo iq mf mg js iu mh mi jw iy mj mk ka ml bi translated">不错！现在让我们来看一个区</h2><p id="4d76" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">使用我们的函数，我们可以很容易地获得任何行政区的最小距离和折线:</p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="1b58" class="lf jf hi kk b fi lg lh l li lj"># Example with Arrondissement 20<br/>coords = [x['geometry']['coordinates'][0] for x in data['features'] if x['properties']['c_ar'] == 20][0]</span><span id="59d2" class="lf jf hi kk b fi lk lh l li lj">p = Point(latitude=poi[0],longitude=poi[1])</span><span id="7557" class="lf jf hi kk b fi lk lh l li lj">distance, line = fu.get_min_distance_to_arr(arr_coords=coords,point_object=p)<br/>line_midpoint = fu.get_line_midpoint(line)</span></pre><p id="d838" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">剧情看起来也不错——而且准确！</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es mo"><img src="../Images/f7a20677484eb3d103c5390d4834ef3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kc1MgisStCtm4Tk5u_buwA.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">从圣母院到20区边界的最短距离。</figcaption></figure><p id="55b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码:</p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="4d3c" class="lf jf hi kk b fi lg lh l li lj"># Map it!<br/>m = folium.Map(location=poi, zoom_start=12, tiles='cartodbpositron')<br/><br/># Display POI<br/>folium.CircleMarker(location=poi, color='red', radius=5, fill='red').add_to(m)<br/># Display POI Name<br/>folium.map.Marker(location=poi, icon=DivIcon(<br/>    icon_size=(150, 36),<br/>    icon_anchor=(0, 0),<br/>    html='&lt;div style="font-size: 18pt; color: red"&gt;{}&lt;/div&gt;'.format(poi_name)<br/>)).add_to(m)<br/><br/>for i, _ in enumerate(coords):<br/>    if i+1 &lt; len(coords):<br/>        folium.PolyLine(locations=[(coords[i][1],coords[i][0]),(coords[i+1][1],coords[i+1][0])], color='blue').add_to(m)<br/>    else:<br/>        folium.PolyLine(locations=[(coords[i][1], coords[i][0]), (coords[0][1], coords[0][0])],<br/>                        color='blue').add_to(m)<br/><br/>folium.PolyLine(locations=line, color='red').add_to(m)<br/>folium.PolyLine(locations=[poi,[line_midpoint.latitude,line_midpoint.longitude]], color='red').add_to(m)<br/>folium.CircleMarker(location=[line_midpoint.latitude,line_midpoint.longitude], color='red', radius=5, fill='red').add_to(m)<br/><br/>new_line_mp = fu.get_line_midpoint([poi,[line_midpoint.latitude,line_midpoint.longitude]])<br/>folium.map.Marker(location=[new_line_mp.latitude,new_line_mp.longitude], icon=DivIcon(<br/>    icon_size=(150, 36),<br/>    icon_anchor=(0, 0),<br/>    html='&lt;div style="font-size: 10pt; color: red"&gt;Distance: {} Meters&lt;/div&gt;'.format(round(dist))<br/>)).add_to(m)<br/><br/>m.save('map_2.html')</span></pre><h2 id="bebb" class="lf jf hi bd jg lz ma mb jk mc md me jo iq mf mg js iu mh mi jw iy mj mk ka ml bi translated">让我们对所有其他区都这样做吧！</h2><p id="6e85" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">因为我们已经准备好了基本的逻辑，所以很容易遍历它并将所有数据点绘制在一起。</p><p id="497e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您想知道哪个区最近，请使用函数get_min_distance_to_arr的输出！</p><p id="ddec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">地图看起来不好看，但是是正确的:)</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es mp"><img src="../Images/e0d3fdac1eca9c3ab1cb3e5dbe603564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hwq7SHq7Aq0y_G3srD1GFw.png"/></div></div></figure><p id="0f34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这就是代码:</p><pre class="km kn ko kp fd lb kk lc ld aw le bi"><span id="1375" class="lf jf hi kk b fi lg lh l li lj"># Map all!<br/>m = folium.Map(location=poi, zoom_start=12, tiles='cartodbpositron')<br/><br/># Display POI<br/>folium.CircleMarker(location=poi, color='red', radius=5, fill='red').add_to(m)<br/># Display POI Name<br/>folium.map.Marker(location=poi, icon=DivIcon(<br/>    icon_size=(150, 36),<br/>    icon_anchor=(0, 0),<br/>    html='&lt;div style="font-size: 18pt; color: red"&gt;{}&lt;/div&gt;'.format(poi_name)<br/>)).add_to(m)<br/><br/># Display Arrondissements<br/>folium.GeoJson(data).add_to(m)<br/># Display Arrondissements Numbers<br/>for arrond in data['features']:<br/>    loc = arrond['properties']['geom_x_y']<br/>    nr = arrond['properties']['c_ar']<br/>    folium.map.Marker(location=loc, icon=DivIcon(<br/>        icon_size=(150, 36),<br/>        icon_anchor=(0, 0),<br/>        html='&lt;div style="font-size: 15pt; color:rgb(41,111,255)"&gt;{}&lt;/div&gt;'.format(str(nr))<br/>    )).add_to(m)<br/><br/>for arrond in data['features']:<br/><br/>    coords = arrond['geometry']['coordinates'][0]<br/>    p = Point(latitude=poi[0],longitude=poi[1])<br/>    dist, line = fu.get_min_distance_to_arr(arr_coords=coords,point_object=p)<br/>    line_midpoint = fu.get_line_midpoint(line)<br/><br/>    # for i, _ in enumerate(coords):<br/>    #     if i+1 &lt; len(coords):<br/>    #         folium.PolyLine(locations=[(coords[i][1],coords[i][0]),(coords[i+1][1],coords[i+1][0])], color='blue').add_to(m)<br/>    #     else:<br/>    #         folium.PolyLine(locations=[(coords[i][1], coords[i][0]), (coords[0][1], coords[0][0])],<br/>    #                         color='blue').add_to(m)<br/><br/>    folium.PolyLine(locations=line, color='red').add_to(m)<br/>    folium.PolyLine(locations=[poi,[line_midpoint.latitude,line_midpoint.longitude]], color='red').add_to(m)<br/>    folium.CircleMarker(location=[line_midpoint.latitude,line_midpoint.longitude], color='red', radius=5, fill='red').add_to(m)<br/><br/>    new_line_mp = fu.get_line_midpoint([poi,[line_midpoint.latitude,line_midpoint.longitude]])<br/>    folium.map.Marker(location=[line_midpoint.latitude,line_midpoint.longitude], icon=DivIcon(<br/>        icon_size=(150, 36),<br/>        icon_anchor=(0, 0),<br/>        html='&lt;div style="font-size: 10pt; color: red"&gt;Distance: {} Meters&lt;/div&gt;'.format(round(dist))<br/>    )).add_to(m)<br/><br/>m.save('map_3.html')</span></pre><p id="3631" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何问题，请联系我们！</p></div></div>    
</body>
</html>