<html>
<head>
<title>Part2: Securing web apps — command execution + firewall</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第2部分:保护web应用—命令执行+防火墙</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/securing-web-apps-command-execution-firewall-38c65f696cd7?source=collection_archive---------21-----------------------#2020-03-27">https://medium.com/analytics-vidhya/securing-web-apps-command-execution-firewall-38c65f696cd7?source=collection_archive---------21-----------------------#2020-03-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4add" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">本文有助于理解如何为webapp创建防火墙规则、命令执行如何工作以及安全编程。</p><p id="a305" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" rel="noopener" href="/@ayedaemon/python-web-apps-made-easy-python-cgi-5dd013964f2d">上一篇文章</a>中，我们停用了系统中的防火墙和SELinux策略。这显然是一种不好的做法。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/e458dac88812c948a2b77e9748e6b963.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Lmv-5BiFotKRQu1mmAmdA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">停止的防火墙服务</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es ju"><img src="../Images/2cd68abad43920dbaf81ecf41e3777f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*tIA7NL77zqZox6x_c3JdyA.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">停止了selinux</figcaption></figure><p id="84f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，现在我们将使防火墙恢复运行。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="8b35" class="ka kb hi jw b fi kc kd l ke kf">$ sudo systemctl start firewalld</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kg"><img src="../Images/8bf721e6f3abb250587c972363180629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Ez_77hAwDFIu5yQJKr3YA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">开始防火墙d</figcaption></figure><p id="ec78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们试着理解这里的<em class="kh">防火墙</em>。(<a class="ae jd" href="https://firewalld.org/documentation/man-pages/firewalld.html" rel="noopener ugc nofollow" target="_blank">https://firewalld . org/documentation/man-pages/firewalld . html</a>)</p><p id="2a9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们对防火墙是如何工作的有了一个概念…是时候制定一个规则来允许http服务通过它了。</p><p id="853c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这可以通过<em class="kh">firewall-cmd</em>(<a class="ae jd" href="https://firewalld.org/documentation/man-pages/firewall-cmd.html" rel="noopener ugc nofollow" target="_blank">https://firewalld . org/documentation/man-pages/firewall-cmd . html</a>)轻松完成</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="afe9" class="ka kb hi jw b fi kc kd l ke kf">$ sudo firewall-cmd --add-service=http --permanent</span></pre><p id="c60b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行上面的命令会给你一个<em class="kh">成功</em>。<br/>现在firewalld将允许任何属于http服务并通过认证的数据包通过。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ki"><img src="../Images/0aa2d2a6fc4d21dac88d6db44232c206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bB_VpFrr_-UvYN1jI6tM3w.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">激活防火墙后(selinux仍处于许可模式)</figcaption></figure><p id="a14c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了使事情变得简单易行，我们不会在本课程中激活SELinux策略。为了更好地理解SELinux是什么以及它是如何工作的，请阅读<a class="ae jd" href="https://wiki.centos.org/HowTos/SELinux" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae jd" href="https://www.nsa.gov/what-we-do/research/selinux/documentation/" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><p id="09be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将重点关注命令执行漏洞。<br/>命令注入基本上是通过web-app执行的操作系统命令的注入。</p><p id="0dc6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们通过向应用程序传递输入来检查我们的应用程序是否容易受到命令执行的攻击。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="d27c" class="ka kb hi jw b fi kc kd l ke kf">8.8.8.8;echo “bang bang”;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kj"><img src="../Images/f4214bb4456292ed9d9efbbf3a02626e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cJHAXXHr2m-b2O7reQn_uQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">“梆梆”在最后一行回荡</figcaption></figure><p id="8b32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看着上面的输出，我们确信echo“bang bang”已经成功执行了。</p><p id="802b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们尝试更多的命令。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="8581" class="ka kb hi jw b fi kc kd l ke kf">6.6.6.6;id</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kk"><img src="../Images/c6bb6b889128c2c350a164fbd071ff39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1yuIFOeQKPQvtWbX3dqvig.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">id执行突出显示</figcaption></figure><p id="a939" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们试着在远程服务器上创建一个文件。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="d91e" class="ka kb hi jw b fi kc kd l ke kf">8.8.8.8;echo “batman_was_here” &gt;knock_knock.txt</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kl"><img src="../Images/6d9754397767f1cd6c9a5cc6c088d6bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AUU20DS9H3rhCzuS9J4_TQ.png"/></div></div></figure><p id="6455" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们似乎没有足够的权限在此创建文件。<br/>但是等等……不是每个OS都有专门的文件夹存放临时创建的文件和文件夹吗？哦是的！就在那里。</p><p id="b83a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在Linux/Unix平台中，/tmp目录拥有完全权限。基本上，它允许我从那个目录中读取、写入和执行任何东西。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="6bf9" class="ka kb hi jw b fi kc kd l ke kf">drwxrwxrwt. 19 root root 4096 Mar 27 09:40 tmp</span></pre><p id="f76c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我们来试试吧。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="2602" class="ka kb hi jw b fi kc kd l ke kf">8.8.8.8;echo “batman_was_here” &gt;/tmp/knock_knock.txt</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es km"><img src="../Images/433ef5701054e16de93346b258e4f198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xLpAUzvw2AlMjmUKVzGhiA.png"/></div></div></figure><p id="f036" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这没有给任何错误。这意味着它执行成功。让我们试着在这里读取文件。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="9989" class="ka kb hi jw b fi kc kd l ke kf">8.8.8.8;cat /tmp/knock_knock.txt</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kn"><img src="../Images/ec9253ec91f571a2b242a7fe07723fff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BArPDF1Z_W1iCe4flkrySA.png"/></div></div></figure><p id="31e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是非常糟糕的，因为黑客可以从我们的服务器上创建、读取和执行文件。</p><p id="cb26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">受够了和弱者开玩笑。让我们试着阻止它。为此，我们需要修改我们的代码来检查输入中潜在的恶意字符，如下所示。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="a16e" class="ka kb hi jw b fi kc kd l ke kf">;<br/>&amp;<br/>|<br/>`</span></pre><p id="275c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们的逻辑代码部分看起来像这样。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="871b" class="ka kb hi jw b fi kc kd l ke kf">## LOGIC CODE<br/>import subprocess as sb<br/>import cgi</span><span id="3fd5" class="ka kb hi jw b fi ko kd l ke kf">data = cgi.FieldStorage() # read the field Storage or mini field storage for the cgi script</span><span id="a383" class="ka kb hi jw b fi ko kd l ke kf">if data.getvalue(“target_ip”):<br/> data_target_ip = data.getvalue(“target_ip”)<br/>else:<br/> data_target_ip = “8.8.8.8” # default set to google DNS</span><span id="fbb3" class="ka kb hi jw b fi ko kd l ke kf">#SANITIZE INPUT</span><span id="cc0d" class="ka kb hi jw b fi ko kd l ke kf">data_target_ip = data_target_ip.replace(“;”,””).replace(“&amp;”,””)<br/>data_target_ip = data_target_ip.replace(“|”,””).replace(“`”,””)</span><span id="7a08" class="ka kb hi jw b fi ko kd l ke kf">cmd_status = sb.getoutput(“sudo ping -c 3 “+data_target_ip)<br/>cmd_status = cmd_status.replace(“\n”,”&lt;br&gt;”)</span></pre><p id="9fc9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们试试我们的应用程序是否还在处理恶意输入。</p><pre class="jf jg jh ji fd jv jw jx jy aw jz bi"><span id="a6ae" class="ka kb hi jw b fi kc kd l ke kf">8.8.8.8;echo “bang bang”;</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kp"><img src="../Images/006b8caeb9ae3cb1c1d93df45ce224b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gDJGZwRZeGWYppovIUdFjA.png"/></div></div></figure><p id="7eaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们的应用程序不会受到这种恶意输入的影响..但是绝对安全仍然是一个神话。<br/>有些字符串仍然可能是恶意的。(那些不在本文讨论范围内)<br/>但还是有你应该好奇的地方。这将有助于你更好地理解那些高级恶意字符串。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kq"><img src="../Images/0ca2cd48cc32f07490b701dcee2c757a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*F1VZFQzxRwALP6HW--XgfA.png"/></div></figure><p id="4ea9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仔细看上面的图像..我向ping命令提供了一个完整的整数，它被转换为一个有效的IP。这些类型的符号被称为IP的整数符号<strong class="ih hj">。</strong></p><p id="5b7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但这还不止这些…</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es kr"><img src="../Images/079ce1b5f65ab25925522b28006ccd07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*-_RLEFa7GJ9lxc4IjL4RDA.png"/></div></figure><p id="7baa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仔细看看上面这些知识产权模式，我相信你会获得一些新的见解。</p><p id="2b8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你想了解更多关于命令执行的内容，请点击这里(<a class="ae jd" href="https://owasp.org/www-community/attacks/Command_Injection" rel="noopener ugc nofollow" target="_blank">https://owasp.org/www-community/attacks/Command_Injection</a>)。</p></div></div>    
</body>
</html>