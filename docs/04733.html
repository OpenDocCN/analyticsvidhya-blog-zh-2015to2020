<html>
<head>
<title>Spark Encrypt/Decrypt Columns for PII, GDPR Compliance, Privacy and Security.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spark加密/解密专栏，适用于PII、GDPR合规性、隐私和安全性。</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/spark-encrypt-columns-for-pii-gdpr-compliance-and-security-3bf17bf59636?source=collection_archive---------9-----------------------#2020-03-30">https://medium.com/analytics-vidhya/spark-encrypt-columns-for-pii-gdpr-compliance-and-security-3bf17bf59636?source=collection_archive---------9-----------------------#2020-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/62d7ce5a717a29cbedd6af117054d942.png" data-original-src="https://miro.medium.com/v2/resize:fit:840/0*hG0oA12AGi_TBe6a"/></div></figure><h1 id="512d" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">能够加密Spark Scala数据帧中的列</h1><p id="fdae" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">本教程是用Azure数据砖构建的。本文分为两部分，第一部分是使用SHA散列法，第二部分是使用AES加密法，展示我们如何加密和解密PII、GDPR和其他合规性安全数据。</p><p id="17d3" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">首先，让我们得到所有需要的进口</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="db39" class="kw in hi ks b fi kx ky l kz la">import scala.collection.JavaConverters._ <br/>import com.microsoft.azure.eventhubs._ <br/>import java.util.concurrent._ <br/>import scala.collection.immutable._ <br/>import scala.concurrent.Future <br/>import scala.concurrent.ExecutionContext.Implicits.global <br/>import org.apache.spark.sql._ <br/>import org.apache.spark.sql.functions._ <br/>import org.apache.spark.sql.types._ <br/>import org.apache.spark.sql.functions._ <br/>import org.apache.spark.sql.functions._</span></pre><p id="895f" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">为测试配置存储帐户信息</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="35b2" class="kw in hi ks b fi kx ky l kz la">spark.conf.set( "fs.azure.account.key.xxxxx.blob.core.windows.net", "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx")</span></pre><p id="24ae" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在为三角洲湖设立检查站</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="6e79" class="kw in hi ks b fi kx ky l kz la">val checkpointLocationproduct = "wasbs://xxxxx@xxxxxx.blob.core.windows.net/deltaidi/delta_custdata/_checkpoints/etl-from-jsonproduct" <br/>val deltapathproduct = "wasbs://xxxxxx@xxxxxxx.blob.core.windows.net/deltaidi/delta_productdim"</span></pre><p id="3ed2" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">将数据文件读入数据帧</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="832f" class="kw in hi ks b fi kx ky l kz la">val dfproduct = spark.read.option("header","true").option("inferSchema","true").csv("wasbs://xxxxx@xxxxx.blob.core.windows.net/productdim.csv")</span></pre><p id="8725" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示并确保数据集尚未加密。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c5b3" class="kw in hi ks b fi kx ky l kz la">display(dfproduct)</span></pre><p id="586d" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是导入安全库的时候了</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="d8cf" class="kw in hi ks b fi kx ky l kz la">import java.security.MessageDigest</span></pre><p id="ddf5" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">让我们做一些改变</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="5e3f" class="kw in hi ks b fi kx ky l kz la">def removeAllWhitespace(col: Column): Column = { regexp_replace(col, "\\s+", "") }</span><span id="a045" class="kw in hi ks b fi lb ky l kz la">val df1 = dfproduct.withColumn("customercleaned", removeAllWhitespace(dfproduct("customername")))</span></pre><p id="a4a0" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示结果</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="ccc3" class="kw in hi ks b fi kx ky l kz la">display(df1)</span><span id="5154" class="kw in hi ks b fi lb ky l kz la">import org.apache.spark.sql.types._ <br/>import org.apache.spark.sql.functions._ <br/>import javax.xml.bind.DatatypeConverter</span></pre><p id="78c5" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">创建加密函数</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="51b3" class="kw in hi ks b fi kx ky l kz la">def sha256Hash(text: String) : String = String.format("%064x", new java.math.BigInteger(1, java.security.MessageDigest.getInstance("SHA-256").digest(text.getBytes("UTF-8"))))</span></pre><p id="2865" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">构建自定义项</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="2a9f" class="kw in hi ks b fi kx ky l kz la">val encryptUDF = udf(sha256Hash _)</span></pre><p id="df38" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">运行加密</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="0e7f" class="kw in hi ks b fi kx ky l kz la">val df2 = df1.withColumn("encryptedcust", encryptUDF(col("customername").cast(StringType)))</span></pre><p id="e250" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示数据并查看它是否被加密</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="c135" class="kw in hi ks b fi kx ky l kz la">display(df2)</span></pre><p id="d26d" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在是时候检查AES了。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="e39e" class="kw in hi ks b fi kx ky l kz la">import java.security.MessageDigest <br/>import java.util import javax.crypto.Cipher <br/>import javax.crypto.spec.SecretKeySpec <br/>import org.apache.commons.codec.binary.Base64 <br/>import java.security.DigestException; <br/>import java.security.InvalidAlgorithmParameterException; <br/>import java.security.InvalidKeyException; <br/>import java.security.NoSuchAlgorithmException; <br/>import java.security.SecureRandom; <br/>import java.util.Arrays; <br/>import javax.crypto.BadPaddingException; <br/>import javax.crypto.Cipher; <br/>import javax.crypto.IllegalBlockSizeException; <br/>import javax.crypto.NoSuchPaddingException; <br/>import javax.crypto.spec.IvParameterSpec; <br/>import javax.crypto.spec.SecretKeySpec;</span></pre><p id="c17c" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">让我们创建AES加密代码:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7b6b" class="kw in hi ks b fi kx ky l kz la">def encrypt(key: String, value: String): String = { <br/>val cipher: Cipher = Cipher.getInstance("AES/ECB/PKCS5Padding") cipher.init(Cipher.ENCRYPT_MODE, keyToSpec(key)) org.apache.commons.codec.binary.Base64.encodeBase64String(cipher.doFinal(value.getBytes("UTF-8"))) <br/>} </span><span id="b217" class="kw in hi ks b fi lb ky l kz la">def decrypt(key: String, encryptedValue: String): String = { <br/>val cipher: Cipher = Cipher.getInstance("AES/ECB/PKCS5PADDING") cipher.init(Cipher.DECRYPT_MODE, keyToSpec(key)) <br/>new String(cipher.doFinal(org.apache.commons.codec.binary.Base64.decodeBase64(encryptedValue))) <br/>} </span><span id="a67b" class="kw in hi ks b fi lb ky l kz la">def keyToSpec(key: String): SecretKeySpec = { <br/>var keyBytes: Array[Byte] = (SALT + key).getBytes("UTF-8") <br/>val sha: MessageDigest = MessageDigest.getInstance("SHA-1") <br/>keyBytes = sha.digest(keyBytes) keyBytes = util.Arrays.copyOf(keyBytes, 16) <br/>new SecretKeySpec(keyBytes, "AES") <br/>} </span><span id="4876" class="kw in hi ks b fi lb ky l kz la">private val SALT: String = "jMhKlOuJnM34G6NHkqo9V010GhLAqOpF0BePojHgh1HgNg8^72k"</span></pre><p id="2449" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">设置要测试的键值</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="39bd" class="kw in hi ks b fi kx ky l kz la">val key = "123456789"</span><span id="02d8" class="kw in hi ks b fi lb ky l kz la">import org.apache.spark.sql.functions.lit</span></pre><p id="d485" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">创建带键的列以加快处理速度</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="aaea" class="kw in hi ks b fi kx ky l kz la">val df3 = df1.withColumn("key", lit(key))</span></pre><p id="2427" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">创建加密udf函数</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="39a9" class="kw in hi ks b fi kx ky l kz la">val encryptUDF1 = udf(encrypt _)</span></pre><p id="1992" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">创建解密udf函数</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="830d" class="kw in hi ks b fi kx ky l kz la">val decryptUDF = udf(decrypt _)</span></pre><p id="5c5c" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在运行加密的数据框，查看列是否加密</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="dd46" class="kw in hi ks b fi kx ky l kz la">val df4 = df3.withColumn("encryptedcust", encryptUDF1(col("key").cast(StringType),col("customername").cast(StringType)))</span></pre><p id="99ef" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示结果</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="7d02" class="kw in hi ks b fi kx ky l kz la">display(df4)</span></pre><p id="6d31" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">检查列名encryptedcust，数据应该加密</p><p id="50db" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">现在来解密</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="937f" class="kw in hi ks b fi kx ky l kz la">val df5 = df4.withColumn("deencryptedcust", decryptUDF(col("key").cast(StringType),col("encryptedcust").cast(StringType)))</span></pre><p id="b5d2" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">显示结果</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="709f" class="kw in hi ks b fi kx ky l kz la">display(df5)</span></pre><p id="f9d9" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">查找列名deencryptedcust，应该显示常规名称而不是加密名称。</p><p id="d7eb" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated">很好，祝你在保护你的专栏上玩得开心，然后给德尔塔湖回信，我们已经加密了数据。</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><p id="2d40" class="pw-post-body-paragraph jk jl hi jm b jn ki jp jq jr kj jt ju jv kk jx jy jz kl kb kc kd km kf kg kh hb bi translated"><em class="lj">最初发表于</em><a class="ae lk" href="https://github.com/balakreshnan/EventDrivenDL/blob/master/ScalaEncrypt.md" rel="noopener ugc nofollow" target="_blank"><em class="lj">【https://github.com】</em></a><em class="lj">。</em></p></div></div>    
</body>
</html>