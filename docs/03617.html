<html>
<head>
<title>Image classification with django (deployment)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用django进行图像分类(部署)</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/image-classification-with-django-deployment-d18dfc224270?source=collection_archive---------2-----------------------#2020-02-11">https://medium.com/analytics-vidhya/image-classification-with-django-deployment-d18dfc224270?source=collection_archive---------2-----------------------#2020-02-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b2b80f8d49dc3fc6221e76a3df4678b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w084l3BAJitvXtLdiXLhjw.jpeg"/></div></div></figure><h1 id="db7c" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">什么是django？</h1><p id="f506" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi km translated"><span class="l kn ko kp bm kq kr ks kt ku di"> D </span> jango是一个python web框架，由于其附带的大量功能，在python社区中很受欢迎。这让您可以快速开发应用程序。</p><p id="7768" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">对于图像分类，我们将使用带有<strong class="jq hj"> ImageNet </strong>权重的<strong class="jq hj"> VGG-16 </strong> <strong class="jq hj">预训练</strong>模型</p><blockquote class="la"><p id="c067" class="lb lc hi bd ld le lf lg lh li lj kl dx translated">要求:</p><p id="8bea" class="lb lc hi bd ld le lf lg lh li lj kl dx translated">克拉斯</p><p id="8428" class="lb lc hi bd ld le lf lg lh li lj kl dx translated">姜戈</p></blockquote><h1 id="0447" class="iq ir hi bd is it iu iv iw ix iy iz ja jb lk jd je jf ll jh ji jj lm jl jm jn bi translated"><strong class="ak">让我们开始构建项目</strong></h1><h2 id="2ee8" class="ln ir hi bd is lo lp lq iw lr ls lt ja jz lu lv je kd lw lx ji kh ly lz jm ma bi translated"><strong class="ak">创建项目:</strong></h2><p id="5ebc" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">从django项目开始，我们必须做一些初始设置。Django提供了一些命令行工具来帮助你开始你的项目。转到您想要创建项目的首选目录。为Linux用户打开终端，为windows用户打开cmd，并键入以下命令</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="d658" class="ln ir hi mg b fi mk ml l mm mn">django-admin startproject classify</span></pre><p id="ac3f" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">该命令将创建一个包含以下文件的“分类”存储库</p><figure class="mb mc md me fd ij er es paragraph-image"><div class="er es mo"><img src="../Images/2605c8bfffa256fd7f26609ede6ffe1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:324/format:webp/1*xfg5tqM83FUCKtUSn_B3XA.png"/></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">文件夹结构</figcaption></figure><p id="25de" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated"><strong class="jq hj">这些文件是:</strong></p><blockquote class="mt mu mv"><p id="b8c9" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">外部分类/根目录是项目的容器。它的名字对Django来说无关紧要；你可以把它改名为任何你喜欢的名字。</p><p id="9b1c" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">manage.py:一个命令行实用程序，允许您以各种方式与这个Django项目进行交互。</p><p id="dc46" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">内部分类/目录是项目的实际Python包。它的名称是Python包的名称，您需要使用它来导入包中的任何内容(例如classify.urls)。</p><p id="a104" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">classify/__init__。py:一个空文件，告诉Python这个目录应该被认为是一个Python包。如果您是Python初学者，请在官方Python文档中阅读更多关于包的内容。</p><p id="4a05" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">classify/settings.py:这个Django项目的设置/配置。Django设置会告诉你所有关于设置如何工作的信息。</p><p id="de7f" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">classify/urls.py:这个Django项目的URL声明；你的Django网站的“目录”。</p><p id="25e7" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">classify/ASGI . py:ASGI兼容的web服务器为您的项目服务的入口点。</p><p id="b056" class="jo jp mw jq b jr kv jt ju jv kw jx jy mx kx kb kc my ky kf kg mz kz kj kk kl hb bi translated">classify/wsgi.py:兼容wsgi的web服务器为您的项目服务的入口点。</p></blockquote></div><div class="ab cl na nb gp nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="hb hc hd he hf"><p id="1d23" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">让编码开始<strong class="jq hj"> … </strong>首先，让我们加载我们的模型。</p><p id="3e87" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">从classify项目中打开settings.py文件，并插入下面的代码。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="3df5" class="ln ir hi mg b fi mk ml l mm mn">import keras<br/>import numpy as np<br/>from keras import backend as K<br/>import tensorflow as tf<br/>from tensorflow.python.keras.backend import set_session<br/>from keras.applications import vgg16<br/><br/><br/>def get_session():<br/>    config = tf.ConfigProto()<br/>    config.gpu_options.allow_growth = True<br/>    return tf.Session(config=config)<br/><br/>K.tensorflow_backend.set_session(get_session())<br/><br/>config = tf.ConfigProto()<br/>config.gpu_options.allow_growth = True<br/>SESS = tf.Session(config=config)<br/>print("model loading")<br/>GRAPH1 = tf.get_default_graph()<br/><br/>set_session(SESS)<br/># Load the VGG model<br/>VGG_MODEL = vgg16.VGG16(weights="imagenet")</span></pre><p id="7588" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">这段代码将在您运行项目时加载您的模型，这样每次您必须预测时就不必加载模型了。记住，在这段代码中，我们将很快使用<strong class="jq hj"> views.py </strong>文件中的<strong class="jq hj"> VGG-16模型</strong>、<strong class="jq hj"> SESS </strong>、<strong class="jq hj"> GRAPH1 </strong>变量。</p><p id="c878" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">在您的<strong class="jq hj"> settings.py </strong>文件的末尾插入以下代码</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="2cf9" class="ln ir hi mg b fi mk ml l mm mn">STATIC_URL = '/static/'<br/>STATIC_ROOT = os.path.join(BASE_DIR, 'static')<br/><br/><br/>MEDIA_ROOT = os.path.join(BASE_DIR, 'media')<br/>MEDIA_URL = 'media/'</span></pre><p id="bd2f" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">这段代码将创建一个保存上传图片的媒体文件。</p><p id="1dff" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">现在让我们在内部分类目录中创建一个<strong class="jq hj"> views.py </strong>文件，用于访问模型以对图像<strong class="jq hj">进行分类。这就是此时你的文件夹结构应该看起来的样子。</strong></p><figure class="mb mc md me fd ij er es paragraph-image"><div class="er es nh"><img src="../Images/853621736734fee43862262cc3a71cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:314/format:webp/1*mmZ62rRbkYv21ky0DjADRA.png"/></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">文件夹结构</figcaption></figure><p id="85dc" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">让我们编辑<strong class="jq hj"> views.py </strong>文件。插入以下代码</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="9f2a" class="ln ir hi mg b fi mk ml l mm mn">from django.shortcuts import render<br/>from django.http import JsonResponse<br/>import base64<br/>from django.core.files.base import ContentFile<br/>from django.core.files.storage import default_storage<br/>from django.conf import settings <br/>from tensorflow.python.keras.backend import set_session<br/>from keras.preprocessing.image import load_img<br/>from keras.preprocessing.image import img_to_array<br/>from keras.applications.imagenet_utils import decode_predictions<br/>import matplotlib.pyplot as plt<br/>import numpy as np<br/>from keras.applications import vgg16<br/>import datetime<br/>import traceback<br/><br/>def index(request):<br/>    if  request.method == "POST":<br/>        f=request.FILES['sentFile'] # here you get the files needed<br/>        response = {}<br/>        file_name = "pic.jpg"<br/>        file_name_2 = default_storage.save(file_name, f)<br/>        file_url = default_storage.url(file_name_2)<br/>        original = load_img(file_url, target_size=(224, 224))<br/>        numpy_image = img_to_array(original)<br/>        <br/><br/>        image_batch = np.expand_dims(numpy_image, axis=0)<br/>        # prepare the image for the VGG model<br/>        processed_image = vgg16.preprocess_input(image_batch.copy())<br/>        <br/>        # get the predicted probabilities for each class<br/>        with settings.GRAPH1.as_default():<br/>            set_session(settings.SESS)<br/>            predictions=settings.VGG_MODEL.predict(processed_image)<br/>       <br/>        label = decode_predictions(predictions)<br/>        label = list(label)[0]<br/>        response['name'] = str(label)<br/>        return render(request,'homepage.html',response)<br/>    else:<br/>        return render(request,'homepage.html')</span></pre><p id="54aa" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">这里，索引函数帮助对图像进行分类，并将预测结果发送到homepage.html文件。if块验证图片已经上传，并给出一个预测，否则显示一个简单的表单。</p><p id="0a40" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">最后，让我们在模板目录<strong class="jq hj">中创建<strong class="jq hj">homepage.html</strong>。</strong>在manage.py文件的同级创建一个模板目录。</p><figure class="mb mc md me fd ij er es paragraph-image"><div class="er es ni"><img src="../Images/b6bb244adae9edbf3f503bc91ea27fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:388/format:webp/1*vUv9LkOQaTX8IOiIo0LsVA.png"/></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">文件夹结构</figcaption></figure><p id="6374" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">让我们在<strong class="jq hj">homepage.html</strong>文件中制作一个表单，从用户那里获取图像。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="6d47" class="ln ir hi mg b fi mk ml l mm mn">&lt;form method="post" enctype="multipart/form-data"&gt;<br/>    {% csrf_token %}<br/>    &lt;input type="file" name="sentFile" /&gt;<br/>    &lt;input type="submit" name="submit" value="Upload" /&gt;<br/>&lt;/form&gt;<br/>{{name}}</span></pre><p id="5d4e" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">这里，该表单帮助我们从用户那里获得一个图像，其中{{name}}是由<strong class="jq hj"> views.py </strong>文件发送的渲染预测。</p><p id="d3ae" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">为了路由所有这些，我们必须将<strong class="jq hj"> urls.py </strong>文件更改为以下内容。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="ae2c" class="ln ir hi mg b fi mk ml l mm mn">from django.contrib import admin<br/>from django.urls import path<br/>from . import views<br/>urlpatterns = [<br/>    path('', views.index, name='homepage'),<br/>    path('admin/', admin.site.urls),<br/>]</span></pre><p id="3e3e" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">就是这样。</p><h1 id="8cb2" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">检查魔法</strong></h1><p id="b678" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">现在，让我们通过在终端或cmd中运行以下命令来检查您是否做对了所有事情。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="53f0" class="ln ir hi mg b fi mk ml l mm mn">python manage.py runserver</span></pre><p id="f742" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">您应该会得到以下响应。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="b3e5" class="ln ir hi mg b fi mk ml l mm mn">Starting development server at <a class="ae nj" href="http://127.0.0.1:8000/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8000/</a></span><span id="dd40" class="ln ir hi mg b fi nk ml l mm mn">Quit the server with CTRL-BREAK.</span></pre><p id="d3ec" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated"><strong class="jq hj">打开您的浏览器并粘贴网址</strong><a class="ae nj" href="http://127.0.0.1:8000/" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8000/</a>然后点击选择文件按钮上传图像，几秒钟后您就可以在同一页面上看到显示的结果。</p><p id="5214" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated"><strong class="jq hj">结果</strong></p><figure class="mb mc md me fd ij er es paragraph-image"><div class="er es nl"><img src="../Images/eefc4492bae7af6f59b16d438d7d04bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*PvQj_LQuYu677Q7NHel_dw.png"/></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">点击选择文件</figcaption></figure><figure class="mb mc md me fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nm"><img src="../Images/f3d0fed99bedc9426273afa1935e4433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fyV5Ri25wiLzvQEcLHUQFg.png"/></div></div></figure><figure class="mb mc md me fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nn"><img src="../Images/ede202780915964a293b2f7e5b4e6282.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lDf-H6u29SKA_3lFN0Fg0g.png"/></div></div><figcaption class="mp mq et er es mr ms bd b be z dx translated">前五大预测将被收入词典</figcaption></figure><p id="58c1" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">如果你喜欢这篇文章，点击给我买杯咖啡！感谢阅读。😊</p><figure class="mb mc md me fd ij er es paragraph-image"><a href="https://www.payumoney.com/paybypayumoney/#/147695053B73CAB82672E715A52F9AA5"><div class="er es no"><img src="../Images/226d333c001f2bdbc8bc791892ea31ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*-aubdwm03fkW39OOplP4ag.png"/></div></a></figure><p id="7c75" class="pw-post-body-paragraph jo jp hi jq b jr kv jt ju jv kw jx jy jz kx kb kc kd ky kf kg kh kz kj kk kl hb bi translated">你的每一个小小的贡献都会鼓励我创造更多这样的内容。</p></div></div>    
</body>
</html>