<html>
<head>
<title>Use Your Data: Scraping PDFs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用您的数据:抓取pdf</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/part-2-use-your-data-scraping-pdfs-1375e45862bb?source=collection_archive---------5-----------------------#2019-10-14">https://medium.com/analytics-vidhya/part-2-use-your-data-scraping-pdfs-1375e45862bb?source=collection_archive---------5-----------------------#2019-10-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/456c1457b0a7cda656dabed2c3b40989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Sn-MD0dYiE7-TJe_"/></div></div></figure><div class=""/><div class=""><h2 id="78dc" class="pw-subtitle-paragraph iq hs ht bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">第2部分:从PDF中提取数据，清理和分析</h2></div><p id="4bab" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">你好。这篇文章是第1部分的延续，用简单的步骤展示了如何从pdf中抓取数据。如果你没有读过上一篇文章，这篇文章展示了如何自动下载电子邮件附件，你可以在这里<a class="ae ke" rel="noopener" href="/@samukweku/part-1-use-your-data-automating-email-attachments-downloads-671279144f62">阅读。</a></p><p id="ec86" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在我们继续之前，让我们检查一下我们的目标是什么，到目前为止我们已经做了什么，还有什么要做。</p><p id="d7c4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">目标:我欠了多少儿童保育费用？我如何阻止这些付款差异再次发生？</p><p id="fcc3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">实现目标的步骤:</p><ol class=""><li id="5c89" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">从电子邮件中下载包含权利声明的附件(这些pdf包含相关数据，如每个儿童在日托所花费的小时数、Centrelink支付的儿童保育补贴以及父母支付的余额)。</li><li id="3055" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">从pdf中提取数据。</li><li id="718a" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">清理数据。</li><li id="8d25" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">做些分析。检查金额，找出有多少是未付的。</li></ol><p id="a7fe" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">第1项已经实现。让我们处理剩下的项目。我们将使用Python和一些第三方库来实现我们的目标。</p><p id="568a" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">从PDF中提取数据</p><figure class="ku kv kw kx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kt"><img src="../Images/510b9dae97bd4dfcae6ad860e8308374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RjX8Yf4gd_IZQ--j"/></div></div></figure><p id="941e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">此处提供了一份<a class="ae ke" href="https://github.com/samukweku/PDF_Extraction/blob/master/sample.pdf" rel="noopener ugc nofollow" target="_blank"> PDF </a>样本——由于其敏感性，无法使用原始文档。我们的具体目标是从PDF中提取所有的表格。请注意，PDF必须是基于文本的，而不是扫描文件。如果您可以在PDF查看器中单击并拖动来选择表格中的文本，则PDF是基于文本的。下面是样本PDF的一部分。</p><figure class="ku kv kw kx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ky"><img src="../Images/1ba84843f750b5964846a5b052265f21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aOsXR0JjaeVYP372"/></div></div></figure><p id="c4fd" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">为了从PDF中提取表格，我们将使用一个强大的第三方库Camelot。卡梅洛特的语法很简单:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="aa00" class="le lf ht la b fi lg lh l li lj">table = camelot.read_pdf('foo.pdf')</span></pre><p id="67c4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">简单吧？只需使用read_pdf方法，就可以得到表格。如果PDF的页面多于一页，语法变为:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="1cc0" class="le lf ht la b fi lg lh l li lj">tables = camelot.read_pdf('foo.pdf', pages='1,2,3,and so on')<br/>#or you can just set pages="all" to read in all the pages in the pdf.</span></pre><p id="c326" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">您也可以将页面设置为一个范围(1，4–10，…)。</p><p id="a1d1" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">如果PDF中的表格单元格之间有分界线，那么camelot会自动使用lattice作为默认风格处理PDF。但是，如果单元格没有分界线，只需将flavor设置为stream:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="88ca" class="le lf ht la b fi lg lh l li lj">tables = camelot.read_pdf('foo.pdf', pages='1-3',flavor='stream')</span></pre><p id="b45e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">要找出提取了多少个表，只需运行下面的代码:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="6e57" class="le lf ht la b fi lg lh l li lj">tables.n</span></pre><p id="8da9" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">要将表作为pandas数据框查看，只需在表上调用df方法:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="d0af" class="le lf ht la b fi lg lh l li lj">tables[0].df</span></pre><p id="bd7b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在图书馆网站<a class="ae ke" href="https://camelot-py.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank">这里</a>有更多的选项和安装程序。</p><p id="3d8e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">出于我们的目的，PDF中有多个页面，它没有分界线，所以我们将使用flavor='stream '。但是我们如何得到页数呢？Simple将字符串“all”传递给pages参数。</p><p id="3ae0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">那么，让我们提取我们的表:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="fbbe" class="le lf ht la b fi lg lh l li lj">import camelot</span><span id="f5c1" class="le lf ht la b fi lk lh l li lj">table = camelot.read_pdf(file,<br/>                         pages='all',<br/>                         flavor='stream',<br/>                         edge_tol = 500)</span></pre><p id="1f20" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">在上面的代码中，我们导入了camelot，并使用read_pdf方法读入PDF文件。请注意，flavor设置为stream，还有一个额外的参数— edge_tol，它有助于改善检测到的区域。这给了我们需要的所有表格。</p><p id="7ac4" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">还不错。我们已经完成了第2项，即提取pdf。然而，我们的数据是杂乱无章的，非常不结构化，这在从pdf中提取表格时是可以预料的。下图显示了其中一个表格的样子——相当混乱——我们有不相关的行——例如第4行和第5行；我们只需要有日期的行。还有一些列是空的或者有“…”；它们是不相关的，应该被丢弃。</p><figure class="ku kv kw kx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ll"><img src="../Images/5b924df53b49ebd06ede775412bf93ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1CgGyEqS-ABAA-1X"/></div></div></figure><p id="a402" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">这就引出了第3项——清理数据。我们有在Python中实现这一点的工具——熊猫。好吧，让我们分解一下清洁任务。我们怎样做才能让它变得“干净”？</p><ol class=""><li id="630b" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">我们只需要有日期的行，其余的可以丢弃。</li><li id="d576" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">有些列有圆点(…)表示空单元格。我们需要清理这些单元格，如果所有单元格中有空的列，我们就删除这些列。</li><li id="72aa" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">并非所有提取的表都有标题。让我们为表格使用统一的列标题。</li><li id="9ca2" class="kf kg ht jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">让我们将所有表格合并成一个表格。</li></ol><p id="d1d3" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">好了，拿水管来！让我们打扫吧。</p><figure class="ku kv kw kx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ky"><img src="../Images/d9bd6b8fdf0d073c655e2f1d561bbc87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oa29SSt1ErPLjT-8"/></div></div></figure><ol class=""><li id="f14d" class="kf kg ht jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">丢弃不需要的行，只保留有日期的行。</li></ol><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="9984" class="le lf ht la b fi lg lh l li lj">def filter_index(dataframe):</span><span id="0ff9" class="le lf ht la b fi lk lh l li lj">    '''<br/>    filter for only indexes that start with the day of the week<br/>    '''</span><span id="7c15" class="le lf ht la b fi lk lh l li lj">    date_filter = ('Mon','Tue','Wed','Thu','Fri','Sat','Sun')</span><span id="267f" class="le lf ht la b fi lk lh l li lj">    index_filter = dataframe.index.str.strip().str.startswith(date_filter)</span><span id="e0ce" class="le lf ht la b fi lk lh l li lj">    dataframe = dataframe.loc[index_filter]</span><span id="c0f9" class="le lf ht la b fi lk lh l li lj">    return dataframe</span></pre><p id="9f30" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">上面的函数只过滤数据帧中以' Mon '，' Tue '，…为索引的行，而丢弃其余的行。</p><p id="cf94" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">2.清除带有多个点的单元格，并删除所有单元格都为空的列</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="9062" class="le lf ht la b fi lg lh l li lj">def clean_columns(dataframe):<br/>    <br/>    '''<br/>    Get rid of the dots and drop empty columns<br/>    '''<br/>    <br/>    for col in dataframe.columns:</span><span id="cdb4" class="le lf ht la b fi lk lh l li lj">        dataframe[col] = dataframe[col].str.strip('.')<br/>    <br/>    cols = [col for col in dataframe.columns <br/>                if (dataframe[col]=="").all()]</span><span id="d5a0" class="le lf ht la b fi lk lh l li lj">    dataframe = dataframe.drop(cols,axis=1)<br/>    <br/>    return dataframe</span></pre><p id="6bcf" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">说明:上面的for循环去掉了点单元格的前缀和后缀，如果它们存在的话。for循环后面的两行查找所有单元格都为空("")的列，并将它们从dataframe中删除。</p><p id="76fe" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">3.为提取的所有表格设置统一的标题。</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="7ca8" class="le lf ht la b fi lg lh l li lj">def column_rename(dataframe):<br/>    <br/>    '''<br/>    change the column headers to something more sensible.<br/>    '''</span><span id="19c3" class="le lf ht la b fi lk lh l li lj">    col_names = ['Start','End','Hours',<br/>                 'Attendance_Sign_In',<br/>                 'Attendance_Sign_Out', <br/>                 'Attendance_Hours',<br/>                 'Fee_Before_Discounts',               <br/>                 'Total_Fee_For_CCS',<br/>                 'Hourly_Fee',<br/>                 'CCS_Hours',<br/>                 'Fee_Reduction_to_Service_CCS', <br/>                 'Parent_Payment',<br/>                 'Educator_ID'<br/>                ]</span><span id="c6c3" class="le lf ht la b fi lk lh l li lj">    dataframe.columns = col_names<br/></span><span id="3c5a" class="le lf ht la b fi lk lh l li lj">    return dataframe</span></pre><p id="cd71" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">解释:这正如它所说的那样，重命名表中的列。这将应用于每个提取的表。</p><p id="eb38" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">还有一件事——改变数据帧的数据类型——使它们具有正确的格式——日期类型、数值类型</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="0670" class="le lf ht la b fi lg lh l li lj">def change_dtype(dataframe):</span><span id="324e" class="le lf ht la b fi lk lh l li lj">    #here I made changes to the data types<br/>    <br/>    dataframe.index = pd.to_datetime(dataframe.index,<br/>                                     dayfirst=True)<br/>                        .rename('Date')</span><span id="fb86" class="le lf ht la b fi lk lh l li lj">    dataframe['Fee_Before_Discounts']=       pd.to_numeric(dataframe['Fee_Before_Discounts'].str.replace('$',''))</span><span id="55a3" class="le lf ht la b fi lk lh l li lj">    dataframe['CCS_Hours'] = pd.to_numeric(dataframe['CCS_Hours'])</span><span id="9247" class="le lf ht la b fi lk lh l li lj">    dataframe['Total_Fee_For_CCS'] = pd.to_numeric(dataframe['Total_Fee_For_CCS'].str.replace('$',''))</span><span id="c6bb" class="le lf ht la b fi lk lh l li lj">    dataframe['Hourly_Fee'] = pd.to_numeric(dataframe['Hourly_Fee'])</span><span id="b0de" class="le lf ht la b fi lk lh l li lj">    dataframe['Fee_Reduction_to_Service_CCS'] = pd.to_numeric(dataframe['Fee_Reduction_to_Service_CCS'])</span><span id="6ea6" class="le lf ht la b fi lk lh l li lj">    dataframe['Parent_Payment'] = pd.to_numeric(dataframe['Parent_Payment'])</span><span id="4e78" class="le lf ht la b fi lk lh l li lj">    dataframe.insert(0,'Day',dataframe.index.day_name())<br/>    <br/>    return dataframe</span></pre><p id="891e" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们已经有了所有的函数，现在让我们将它们应用到桌子上并清理它们。我们将使用for循环来实现这一点:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="1684" class="le lf ht la b fi lg lh l li lj">import pandas as pd </span><span id="c99f" class="le lf ht la b fi lk lh l li lj">data_list = []</span><span id="4313" class="le lf ht la b fi lk lh l li lj">for t in range(table.n):</span><span id="7664" class="le lf ht la b fi lk lh l li lj">    data = table[t].df</span><span id="7290" class="le lf ht la b fi lk lh l li lj">    if len(data.columns)&lt;13:  <br/>        continue</span><span id="825b" class="le lf ht la b fi lk lh l li lj">    data_fixed = (data.set_index(0)<br/>                      .pipe(filter_index)<br/>                      .pipe(clean_columns)<br/>                      .pipe(column_rename)<br/>                      .pipe(change_dtype)</span><span id="61d6" class="le lf ht la b fi lk lh l li lj">                     )<br/>    <br/>    data_list.append(data_fixed)</span></pre><p id="4480" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我们把清理过的桌子列在一个列表里。最后一步是将它们全部放入一个数据框中:</p><pre class="ku kv kw kx fd kz la lb lc aw ld bi"><span id="b806" class="le lf ht la b fi lg lh l li lj">data_final = pd.concat(data_list, ignore_index=False, sort=False)</span></pre><p id="4af8" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">Tadaaa！我们的任务完成了。下图显示了我们最终输出的一部分。</p><figure class="ku kv kw kx fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lm"><img src="../Images/5ea0b48672ef7b7285db89d5ce7ec2cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cpbpzT0CPcfTIjvL"/></div></div></figure><p id="c06b" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">现在我们可以运行我们的分析，找出我们需要偿还多少儿童保育费用。我不会在这里运行任何分析，因为它只是一个愚蠢的数字样本PDF。</p><p id="e6a6" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">所以，你有它。我们现在知道如何从我们的电子邮件中自动下载，抓取pdf并做一些数据清理。全部代码都在我的github存储库中；你可以在这里查看<a class="ae ke" href="https://github.com/samukweku/PDF_Extraction" rel="noopener ugc nofollow" target="_blank">。打破它，测试它，让我知道你的想法。非常感谢反馈。</a></p><p id="47ec" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">参考资料:</p><p id="b481" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">卡米洛特:<a class="ae ke" href="https://camelot-py.readthedocs.io/en/master/" rel="noopener ugc nofollow" target="_blank">https://camelot-py.readthedocs.io/en/master/</a></p><p id="2a95" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">熊猫:【https://pandas.pydata.org T2】</p><p id="41e0" class="pw-post-body-paragraph ji jj ht jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd hb bi translated">我的github库:【https://github.com/samukweku/PDF_Extraction T4】</p></div></div>    
</body>
</html>