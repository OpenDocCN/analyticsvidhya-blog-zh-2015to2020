<html>
<head>
<title>Visualizing COVID-19 data with BigQuery and Data Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用BigQuery和Data Studio可视化新冠肺炎数据</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/visualizing-covid-19-data-with-bigquery-and-data-studio-6b9f89f70bc2?source=collection_archive---------8-----------------------#2020-03-16">https://medium.com/analytics-vidhya/visualizing-covid-19-data-with-bigquery-and-data-studio-6b9f89f70bc2?source=collection_archive---------8-----------------------#2020-03-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="6b0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你是否有兴趣探索关于冠状病毒的可用数据，搜索模式和关系，或者只是在社交距离遥远的时候开始一个有趣的项目？如果您已经对数据分析技术有所了解，在这篇简短的教程中，我将帮助您开始使用BigQuery和Data Studio。您可以只使用<a class="ae jd" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank"> GCP自由层</a>来遵循这些步骤，并且您甚至不需要将计费帐户与您的项目相关联。</p><p id="8ca3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，创建一个Google Cloud帐户和一个项目。我们将使用来自约翰·霍普金斯大学系统科学与工程中心的数据，该数据可在<a class="ae jd" href="https://github.com/CSSEGISandData/COVID-19" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得，并遵循三个简单的步骤:</p><ol class=""><li id="80a4" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建一个表来保存我们的数据</li><li id="ca8b" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">将CSV上传到BigQuery</li><li id="32c1" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">准备要在Data Studio中使用的数据</li></ol><p id="adde" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以让我们开始吧！</p><p id="0d1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="js">3月30日更新:本文旨在帮助您在公共数据不可用的时候开始使用BigQuery。现在谷歌已经创建了一个</em> <a class="ae jd" href="https://console.cloud.google.com/marketplace/details/bigquery-public-datasets/covid19-public-data-program" rel="noopener ugc nofollow" target="_blank"> <em class="js">新冠肺炎公共数据集程序</em> </a> <em class="js">，如果你愿意，你可以直接查询这些数据。</em></p><h1 id="6654" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">创建表格</h1><p id="c8b4" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">您可以查看存储库中的一个CSV文件<a class="ae jd" href="https://github.com/CSSEGISandData/COVID-19/blob/d5eab1b3657e70f55b9eb9eb7e475475dac445fb/csse_covid_19_data/csse_covid_19_daily_reports/03-14-2020.csv" rel="noopener ugc nofollow" target="_blank">,以了解我们试图创建的表的结构。在这个例子中，我将跳过纬度和经度，它们在旧文件中不可用，也不需要在Data Studio中的地图上放置国家。</a></p><p id="fe9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开<a class="ae jd" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>，从左侧导航菜单的大数据下，选择BigQuery。BigQuery中的每个表都需要在一个<em class="js">数据集</em>下，而数据集又在一个<em class="js">项目</em>下。在左侧栏中选择您的项目名称，然后点击右侧的<strong class="ih hj">创建数据集</strong>。您只需在<strong class="ih hj">数据集ID </strong>下输入一个名称。我把我的叫做<code class="du kw kx ky kz b">covid19</code>。如果您没有设置计费，您将处于BigQuery的沙盒版本，并且在此数据集中创建的任何表都将在60天后过期。</p><p id="a2a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我开始考虑这个项目时，我不确定是否要创建一个<a class="ae jd" href="https://cloud.google.com/bigquery/docs/querying-wildcard-tables" rel="noopener ugc nofollow" target="_blank">通配符表</a>，因为我的源数据也被分割到单独的文件中，或者我是否要创建一个包含所有数据的单个表。在意识到使用通配符时查询结果不会被缓存后，我决定使用单个表。</p><p id="82b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择您新创建的数据集，然后点击<strong class="ih hj">创建表格</strong>。在这里，您通常会从现有文件创建表，例如上传CSV或JSON，但是现在我们将只定义一个空表的结构。给它起一个名字(我用的是<code class="du kw kx ky kz b">daily_reports</code>)，输入下面截图中的字段，我建议您在<code class="du kw kx ky kz b">last_update</code>上启用分区，当您在查询中使用该过滤器时，这可以真正帮助减少处理的数据量。</p><figure class="lb lc ld le fd lf er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es la"><img src="../Images/17fa072bfb0b7f929cdefa8c53716cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M0tt0I3LJ7vJuG3yLpaYdw.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">在covid19数据集下创建表daily_reports</figcaption></figure><h1 id="88b4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">将数据加载到BigQuery</h1><p id="df7f" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">对于下一步，您需要<strong class="ih hj">激活Cloud Shell，</strong>位于搜索栏和标题帮助之间的图标。一旦您的会话开始，您应该运行以下命令来设置您的项目(用您的项目名称替换<em class="js"> project_name </em>):</p><p id="11d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kw kx ky kz b">gcloud config set project <em class="js">project_name</em></code></p><p id="5dc3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，从git存储库下载数据，进入该文件夹，并为我们将用来使数据与BigQuery兼容的脚本创建一个新文件:</p><pre class="lb lc ld le fd lq kz lr ls aw lt bi"><span id="cb39" class="lu ju hi kz b fi lv lw l lx ly">git clone <a class="ae jd" href="https://github.com/CSSEGISandData/COVID-19.git" rel="noopener ugc nofollow" target="_blank">https://github.com/CSSEGISandData/COVID-19.git</a><br/>cd COVID-19<br/>touch merge_files.py</span></pre><p id="7e5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击云壳上的<strong class="ih hj">启动编辑器</strong>，找到你新创建的<code class="du kw kx ky kz b">merge_files.py</code>。我们将使用该脚本将所有CSV文件合并为一个文件，将日期字段格式化为一致的值，并删除一些文件包含的不适合我们的表的额外列。我使用Python 2.7语法编写了这个文件，这是云Shell中可用的默认解释器。您可以复制并粘贴此<a class="ae jd" href="https://gist.github.com/bani/aad9b544d2c61ced2134725422278aff" rel="noopener ugc nofollow" target="_blank">要点</a>中的内容:</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="lm ln et er es lo lp bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/bani/aad9b544d2c61ced2134725422278aff" rel="noopener ugc nofollow" target="_blank">完整文件的链接</a></figcaption></figure><p id="faab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用命令<code class="du kw kx ky kz b">python merge_files.py</code>从shell中运行该脚本，这应该会创建一个名为<code class="du kw kx ky kz b">data.csv</code>的文件。</p><p id="69fe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经准备好填充我们的表了！您将运行以下命令，用您使用的名称替换项目、数据集和表名称:</p><p id="bc44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kw kx ky kz b">bq load --source_format=CSV <em class="js">project:dataset.table_name</em> data.csv</code></p><p id="fa85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例:<code class="du kw kx ky kz b">bq load --source_format=CSV bani:covid19.daily_reports data.csv</code></p><p id="c5f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，在项目和数据集之间使用冒号(:)，而在数据集和表名之间使用点(。).片刻之后，您的数据就可以被查询了！现在可以关闭云壳了。如果您需要在更多数据可用后重新运行，您可以在命令行中包含<code class="du kw kx ky kz b">--replace</code>来覆盖该表。否则，它将追加内容，复制所有现有的数据。</p><h1 id="eea4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">准备数据</h1><p id="dd75" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated"><strong class="ih hj"> <em class="js">更新</em> </strong> <em class="js">:从3月22日开始，美国各州的CSV文件中的数据变得更加精细，下面描述的转换不再是删除重复项的正确方法。我建议您仅将它用于该日期之前的数据。</em></p><p id="1670" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您实际创建报告之前，我建议稍微研究一下数据，以了解实际存在的内容。很难找到一个干净易用的数据源，这个也不例外。</p><p id="f36b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，乍一看，我以为我可以认为<code class="du kw kx ky kz b">location</code>、<code class="du kw kx ky kz b">country</code>和<code class="du kw kx ky kz b">last_update</code>的每个组合都是唯一的，但是结果发现在CSV文件中有许多重复的记录。这很容易用这样的查询来测试，如果我的假设是正确的，它不会返回任何记录:</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="6864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍加探究，你会很快注意到其他一些价值观也缺乏一致性。出于本例的目的，我决定修复一些国家名称的问题，并将所有内容聚合到该级别。如果你想做一些不同的事情，相应地调整。在另一个报告中，我查看了加拿大各省的结果，但是在旧的数据中，我在省列中找到了单个城市的名称，所以我不得不一个一个地替换。一些计算出来的指标也是有用的。在原始数据中，我只有累积的数字，这些数字不是完全累加的，所以我创建了新的列来保存每次更新的更改。数据还存在其他问题，如负面变化(即确诊病例总数一天比一天少)，但我认为这可以是一个良好的开端。</p><p id="5356" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们用清理后的数据创建一个表。我们将使用数据定义语言，并从查询窗口运行它。复制并粘贴<a class="ae jd" href="https://gist.github.com/bani/7a8a5f0f919f902f3537e33132e19c15" rel="noopener ugc nofollow" target="_blank">中的内容，跟随</a>、<strong class="ih hj">更新第1行和第16行</strong>中的完整表格名称。</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="lm ln et er es lo lp bd b be z dx translated"><a class="ae jd" href="https://gist.github.com/bani/7a8a5f0f919f902f3537e33132e19c15" rel="noopener ugc nofollow" target="_blank">完整文件的链接</a></figcaption></figure><p id="5472" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">太好了，现在我们准备好报告了！打开<a class="ae jd" href="https://datastudio.google.com/" rel="noopener ugc nofollow" target="_blank">数据工作室</a>，选择<strong class="ih hj">空白报表</strong>。然后在右下角，点击<strong class="ih hj">创建新的数据源</strong>。在下一个屏幕中，选择<strong class="ih hj"> BigQuery </strong>，在授权过程(如果需要)之后，您将能够找到您刚刚在项目下创建的表。选中表名，点击右上角的<strong class="ih hj">连接</strong>，然后<strong class="ih hj">添加到报告</strong>。</p><p id="1477" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你应该回到报告页面，上面有你的第一个表(如果你想删除它，你可以选择并按delete键！).现在是你探索的时候了，但我会带你浏览第一张图表。点击<strong class="ih hj">添加图表</strong>，选择<strong class="ih hj">地理地图</strong>，然后点击您想要添加图表的页面位置。在右侧的<strong class="ih hj">数据</strong>选项卡中，将<code class="du kw kx ky kz b">country</code>拖放到<strong class="ih hj">地理尺寸</strong>，将<code class="du kw kx ky kz b">confirmed_new</code>拖放到<strong class="ih hj">公制</strong>。然后在<strong class="ih hj">默认日期范围</strong>中选择自定义，并选择开始和结束日期。您应该会得到这样的结果:</p><figure class="lb lc ld le fd lf er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es mb"><img src="../Images/994f198dd12b8ced496f13668662b388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A6juQIlyIk-oMamR980LOQ.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx translated">新新冠肺炎病例世界地图</figcaption></figure><p id="4e59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，请尽情填充您的仪表板吧！分享您在下面的回答中找到的任何数据源或创建的仪表板。</p><h1 id="f36f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">承认</h1><p id="9a38" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">在看到Joao Correia 的仪表板后，我有了探索这些数据的想法，他还向我分享了他的一些数据准备步骤。</p></div></div>    
</body>
</html>