<html>
<head>
<title>MySQL river for Elasticsearch | go-mysql-elasticsearch in Ubuntu 18.04</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MySQL river for elastic search | go-MySQL-elastic search in Ubuntu 18.04</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/mysql-river-for-elasticsearch-go-mysql-elasticsearch-in-ubuntu-18-04-771e2c172c4f?source=collection_archive---------11-----------------------#2020-05-27">https://medium.com/analytics-vidhya/mysql-river-for-elasticsearch-go-mysql-elasticsearch-in-ubuntu-18-04-771e2c172c4f?source=collection_archive---------11-----------------------#2020-05-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b1ecf9c0a5e5dec8eea4ae6eeaf8a0e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qdsmAW0WqFedsVBRwBN_vw.jpeg"/></div></div></figure><p id="1dcf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇博文分享了我为ElasticSearch建立MySQL河流的经验。</p><blockquote class="jo jp jq"><p id="35ba" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">river是一种简单的方法，可以为您的Elasticsearch数据仓库建立一个连续的数据流。这是一个在Elasticsearch集群中运行的插件服务，它提取数据(或推送数据)，然后在集群中进行索引。<br/>它比传统的手动数据索引方法更实用，因为一旦配置完毕，所有数据都会自动更新。这降低了复杂性，也使得实时系统的创建成为可能。</p></blockquote></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="f78d" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated"><strong class="ak">背景和动机</strong></h1><p id="d08a" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">在这个数据驱动的时代，无论您是构建小规模还是大规模的应用程序，其中一个主要因素就是数据。根据数据的性质和开发人员的选择，这些非常重要的blobs将存放在NoSQL或SQL数据库中。</p><p id="a03a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最近，我和我的同事正在开发一个评分系统，包括基于不同标准的用户评分。由于我们的数据表现出巨大的关系特征，我们选择了MySQL服务器来存储它们。经过一些头脑风暴和想法分享，我们能够设计出一个与我们的数据和需求相一致的有效模式。</p><p id="5302" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在实现了算法和其他支持数据管道之后，我们对其进行了一些基准测试。<br/>我们得出的一个推论是，我们的引擎需要自动更正/补全功能，因为来自广泛用户群的数据往往会有错别字、缩写等。我们选择了Elasticsearch <em class="jr">(一个存储和查询巨大文本数据集的伟大工具)</em>来创建搜索空间。</p><blockquote class="lf"><p id="2e0c" class="lg lh hi bd li lj lk ll lm ln lo jn dx translated">Elasticsearch是一个灵活、强大的开源、分布式实时搜索和分析引擎。它速度快，易于使用，在许多情况下非常有用。</p></blockquote><p id="0d58" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">为了实现这样的搜索空间，有必要将数据从MySQL数据库传输到es索引。MySQL转储第一次可以用于播种索引，但是真正的挑战是数据很容易改变，所以我们需要在MySQL数据库和es索引之间建立连续的数据流。</p><p id="701d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们开始在广阔的万维网中寻找这样的机制，我们遇到了一些真正令人难以置信的项目。其中一个是我们自己的ES stack的<a class="ae lu" href="https://www.elastic.co/blog/how-to-keep-elasticsearch-synchronized-with-a-relational-database-using-logstash" rel="noopener ugc nofollow" target="_blank"> <em class="jr"> logstash </em> </a> <em class="jr">，</em>虽然看起来很有希望，但它不能满足我们所有的需求。然后我们遇到了这个用Go构建的很棒的服务。<a class="ae lu" href="https://github.com/siddontang/go-mysql-elasticsearch" rel="noopener ugc nofollow" target="_blank">https://github.com/siddontang/go-mysql-elasticsearch</a></p><blockquote class="jo jp jq"><p id="f8d0" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">go-mysql-elasticsearch 是一项将你的mysql数据自动同步到elasticsearch的服务。<br/>首先用<code class="du lv lw lx ly b"><a class="ae lu" href="https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html" rel="noopener ugc nofollow" target="_blank">mysqldump</a></code>取原始数据，然后用<a class="ae lu" href="https://dev.mysql.com/doc/refman/8.0/en/binary-log.html" rel="noopener ugc nofollow" target="_blank"> binlog </a>增量同步数据。</p></blockquote><p id="af36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，现在让我们进入正题，设置这个。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="fbd4" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">先决条件</h1><ul class=""><li id="729a" class="lz ma hi is b it la ix lb jb mb jf mc jj md jn me mf mg mh bi translated"><a class="ae lu" href="https://golang.org/doc/install" rel="noopener ugc nofollow" target="_blank"> Go (1.9+) </a></li><li id="3632" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated"><a class="ae lu" href="https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/" rel="noopener ugc nofollow" target="_blank"> MySQL ( &lt; 8.0) </a> <em class="jr">【本地或云实例】</em></li><li id="576b" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated"><a class="ae lu" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html" rel="noopener ugc nofollow" target="_blank">弹性搜索(&lt; 6.0) </a></li></ul><blockquote class="jo jp jq"><p id="ce76" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">如果您的环境没有配置这些要求，请遵循以上链接获取安装说明。</em></p></blockquote><p id="68d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尽管开发者建议使用MySQL &lt;8.0 and ES &lt;6.0, we implemented it with MySQL 5.7 and ES 7.7 and it worked without any issues.</p><h1 id="0df2" class="kc kd hi bd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz bi translated">Installing MySQL river</h1><p id="18ec" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">Run the following command from your terminal to fetch the project</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="769e" class="na kd hi ly b fi nb nc l nd ne"><em class="jr">go get github.com/siddontang/go-mysql-elasticsearch</em></span></pre><blockquote class="jo jp jq"><p id="5836" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">注意:它会显示一些信息，忽略它。<br/>默认下载位置将是$HOME/go，如果您想要使用自定义位置，请在您的环境中使用</em><a class="ae lu" href="https://golang.org/doc/gopath_code.html" rel="noopener ugc nofollow" target="_blank"><em class="hi">GOPATH</em></a><em class="hi">变量对其进行配置。<br/></em><code class="du lv lw lx ly b"><em class="hi">Add the following line to your ~/.bashrc file</em></code><em class="hi"><br/></em>T2】</p></blockquote><p id="d7af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在项目将被下载并安装到<code class="du lv lw lx ly b">$GOPATH</code>中，它包含目录<code class="du lv lw lx ly b">src/github.com/siddontang/go-mysql-elasticsearch/</code>，以及那些库及其依赖项的编译包(在<code class="du lv lw lx ly b">pkg/</code>)。</p><p id="8fca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">更改到项目目录</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="02ee" class="na kd hi ly b fi nb nc l nd ne">cd $HOME/go<!-- -->/src/github.com/siddontang/go-mysql-elasticsearch</span><span id="d88e" class="na kd hi ly b fi nf nc l nd ne">-- or --</span><span id="1dd4" class="na kd hi ly b fi nf nc l nd ne">cd $GOPATH/src/github.com/siddontang/go-mysql-elasticsearch</span></pre><p id="6a11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们构建程序的可执行文件，在您的终端中运行以下命令</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="f95c" class="na kd hi ly b fi nb nc l nd ne">make</span></pre><h1 id="86d6" class="kc kd hi bd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz bi translated">使用MySQL river</h1><h2 id="256f" class="na kd hi bd ke ng nh ni ki nj nk nl km jb nm nn kq jf no np ku jj nq nr ky ns bi translated">配置MySQL</h2><ul class=""><li id="b169" class="lz ma hi is b it la ix lb jb mb jf mc jj md jn me mf mg mh bi translated"><a class="ae lu" href="https://dev.mysql.com/doc/refman/5.7/en/binary-log-setting.html" rel="noopener ugc nofollow" target="_blank">配置你的MySQL <em class="jr"> binlog </em>使用行格式</a></li></ul><p id="f2b8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从mysql shell中运行以下命令</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="a503" class="na kd hi ly b fi nb nc l nd ne">SET GLOBAL binlog_format = 'ROW';</span><span id="e4c0" class="na kd hi ly b fi nf nc l nd ne">-- or -- For individual clients use the below command</span><span id="8545" class="na kd hi ly b fi nf nc l nd ne">SET SESSION binlog_format = ‘ROW’;</span></pre><ul class=""><li id="b522" class="lz ma hi is b it iu ix iy jb nt jf nu jj nv jn me mf mg mh bi translated">创建你的MySQL数据库和表格。</li></ul><blockquote class="jo jp jq"><p id="65ff" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">注意:将被同步的MySQL表应该有一个主键，也允许多列主键。</em></p></blockquote><h2 id="fa97" class="na kd hi bd ke ng nh ni ki nj nk nl km jb nm nn kq jf no np ku jj nq nr ky ns bi translated">配置弹性搜索</h2><ul class=""><li id="e7cf" class="lz ma hi is b it la ix lb jb mb jf mc jj md jn me mf mg mh bi translated">如果可能，创建相关的Elasticsearch索引、文档类型和映射，否则，Elasticsearch将自动创建这些内容。</li></ul><blockquote class="jo jp jq"><p id="7a0a" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">注意:如果没有配置ES索引，将使用默认映射。我们的方法需要精确的搜索结果，所以我们创建了带有自定义映射的索引。</em></p></blockquote><h2 id="fbc4" class="na kd hi bd ke ng nh ni ki nj nk nl km jb nm nn kq jf no np ku jj nq nr ky ns bi translated">配置河流</h2><p id="2be0" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">mysql-es的配置在<br/><em class="jr">$ GOPATH/src/github . com/siddontang/go-MySQL-elastic search/etc</em>下的<strong class="is hj"> <em class="jr"> river.toml </em> </strong>文件中提供</p><p id="8de6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将工作目录更改为</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="06eb" class="na kd hi ly b fi nb nc l nd ne">cd <em class="jr">$GOPATH/src/github.com/siddontang/go-mysql-elasticsearch/etc</em></span></pre><p id="f8ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在您喜欢的编辑器中打开<strong class="is hj"> river.toml </strong> config</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="371a" class="na kd hi ly b fi nb nc l nd ne">nano river.toml</span></pre><p id="e72e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr"> MySQL配置</em> </strong></p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="e2d7" class="na kd hi ly b fi nb nc l nd ne"># MySQL address, user and password<br/># user must have replication privilege in MySQL.</span><span id="25d5" class="na kd hi ly b fi nf nc l nd ne">my_addr = "127.0.0.1:3306"<br/>my_user = "root"<br/>my_pass = ""<br/>my_charset = "utf8" </span></pre><p id="774e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您也可以使用云托管的mysql服务，如RDS等..现在用<em class="jr"> flavor </em> param指定您选择的db。</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="194f" class="na kd hi ly b fi nb nc l nd ne"># mysql or mariadb<br/>flavor = "mysql"</span></pre><p id="fda9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“go-mysql-elasticsearch首先使用mysqldump获取原始数据，然后使用binlog增量同步数据”,因此，如果您也想索引现有数据，则使用以下配置指定转储位置，否则，只需对其进行注释或留空。</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="38cf" class="na kd hi ly b fi nb nc l nd ne"># mysqldump execution path<br/># if not set or empty, ignore mysqldump.</span><span id="577d" class="na kd hi ly b fi nf nc l nd ne">mysqldump = "./var/mysqldump"</span></pre><blockquote class="jo jp jq"><p id="6346" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">注意:我们在尝试从RDS恢复转储时遇到了一些问题，所以如果您正在使用RDS实例，请查看本帖的<strong class="is hj">获取部分</strong>以了解有关此问题的更多信息。</p></blockquote><p id="d1eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr"> ES配置</em> </strong></p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="1619" class="na kd hi ly b fi nb nc l nd ne"># Set true when elasticsearch use https<br/>#es_https = false<br/># Elasticsearch address</span><span id="77f8" class="na kd hi ly b fi nf nc l nd ne">es_addr = "127.0.0.1:9200"</span><span id="dab2" class="na kd hi ly b fi nf nc l nd ne"># Elasticsearch user and password, maybe set by shield, nginx, or x-pack</span><span id="2ace" class="na kd hi ly b fi nf nc l nd ne">es_user = ""<br/>es_pass = ""</span></pre><p id="156a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr">数据库配置</em> </strong></p><p id="f49d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设我们有一个名为dbx的数据库，其中包含表tba、tbb、tbc …为了同步该数据库及其首选表，我们需要在<strong class="is hj"> <em class="jr">源配置</em> </strong>下指定它们</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="a0f7" class="na kd hi ly b fi nb nc l nd ne"># MySQL data source<br/>[[source]]<br/>schema = "dbx"<br/>tables = ["tba", "tbb"]</span></pre><p id="5cd7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想同步数据库中的所有表，只需使用通配符' * '。</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="00d1" class="na kd hi ly b fi nb nc l nd ne"># MySQL data source<br/>[[source]]<br/>schema = "dbx"<br/>tables = ["*"]</span></pre><p id="15d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">也支持其他正则表达式，你可以做类似的事情来同步相似格式的表</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="f330" class="na kd hi ly b fi nb nc l nd ne"># MySQL data source<br/>[[source]]<br/>schema = "dbx"<br/>tables = ["tb[a-z]"]</span></pre><p id="a5ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想要同步多个数据库，您可以用它们各自的数据库名称复制这个配置。因此，同步dbx和dby的配置如下所示</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="e3d3" class="na kd hi ly b fi nb nc l nd ne"># MySQL data source<br/>[[source]]<br/>schema = "dbx"<br/>tables = ["tb[a-z]"]</span><span id="417e" class="na kd hi ly b fi nf nc l nd ne">[[source]]<br/>schema = "dby"<br/>tables = ["tbc", "tbd"]</span></pre><p id="8292" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr">指标配置</em> </strong></p><p id="a76f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">比方说，您希望将表tba同步到索引tb_index。这是在规则部分下配置的。</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="0dc2" class="na kd hi ly b fi nb nc l nd ne">[[rule]]<br/>schema = "dbx"<br/>table = "tba"<br/>index = "tb_index"<br/>type = "tba"</span></pre><blockquote class="jo jp jq"><p id="e3cd" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">注意:默认索引和类型名将是表名的索引和类型名。根据你的需要改变它们。</em></p></blockquote><p id="8f26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您只想同步表中的特定列，请使用下面的配置</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="6ec7" class="na kd hi ly b fi nb nc l nd ne">[[rule]] <br/>schema = "dbx"<br/>table = "tba"<br/>index = "tb_index"<br/>type = "tba" <br/> <br/>filter = ["col_a"] <br/> <br/>[rule.field] <br/>col_a="name"</span></pre><p id="e93a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里<strong class="is hj"> <em class="jr">过滤器</em> </strong>表示要同步到索引中的列，而<strong class="is hj"> <em class="jr">规则.字段</em> </strong>表示<em class="jr"> </em>列与索引的映射关系。<em class="jr">即</em>在这种情况下，来自<em class="jr">‘col _ a’</em>的值将被映射到tb_index的【T53’‘name’字段中。</p><p id="5a09" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jr">规则字段</em> </strong>配置也支持数据类型转换/规范，</p><blockquote class="jo jp jq"><p id="4aa8" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">这将把col_a列映射到弹性搜索名称</em></p></blockquote><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="e668" class="na kd hi ly b fi nb nc l nd ne">[rule.field]<br/> col_a="name"</span></pre><blockquote class="jo jp jq"><p id="9f1e" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">这将把col_a列映射到弹性搜索名称，并使用数组类型</em></p></blockquote><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="752f" class="na kd hi ly b fi nb nc l nd ne">[rule.field] <br/>col_a="name,list"</span></pre><blockquote class="jo jp jq"><p id="c868" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">这将把列col_a映射到弹性搜索col_a，并使用数组类型</em></p></blockquote><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="e937" class="na kd hi ly b fi nb nc l nd ne">[rule.field] <br/>col_a=",list"</span></pre><blockquote class="jo jp jq"><p id="5e5f" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">“list”修饰符将mysql字符串字段如“a，b，c”转换为弹性数组类型“{ a”，“b”，“c”} ”,如果您需要在弹性搜索中使用这些字段进行过滤，这将特别有用。</em></p><p id="f09c" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">如果created_time字段类型为“int ”,而您想在ES中将其转换为“date”类型，您可以按如下方式操作</em></p></blockquote><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="0e68" class="na kd hi ly b fi nb nc l nd ne">[rule.field] <br/>created_time=",date"</span></pre><p id="914c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们发现非常有用的另一个特性是在表规范中支持通配符。当您想要索引一个表的分块部分时，它特别有用。</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="1194" class="na kd hi ly b fi nb nc l nd ne">[[rule]] <br/>schema = "dbx"<br/>table = "tb[a-z]"<br/>index = "tb_index"<br/>type = "tba" <br/> <br/>filter = ["col_a"] <br/> <br/>[rule.field] <br/>col_a="name"</span></pre><blockquote class="jo jp jq"><p id="6242" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi">注意:确保匹配给定通配符的表应该具有相同的模式</em></p></blockquote><p id="03aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了将多个表同步到不同的索引中，只需复制带有相应表和索引名称的规则配置，就像我们对多个数据库所做的那样。</p><p id="4a42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，为了将tba和tbd同步到2个索引中，比如tb_index_1和tb_index_2，配置将是</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="9fa2" class="na kd hi ly b fi nb nc l nd ne">[[rule]] <br/>schema = "dbx"<br/>table = "tba"<br/>index = "tb_index_1"<br/>type = "tba" <br/> <br/>filter = ["col_a"] <br/> <br/>[rule.field] <br/>col_a="name"<br/></span><span id="760b" class="na kd hi ly b fi nf nc l nd ne">[[rule]] <br/>schema = "dby"<br/>table = "tbd"<br/>index = "tb_index_2"<br/>type = "tbd" <br/> <br/>filter = ["col_d"] <br/> <br/>[rule.field] <br/>col_d="name"</span></pre><p id="6f4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过这些配置，我们成功地建立了一个river，用于将mysql数据同步到ES中。</p><blockquote class="jo jp jq"><p id="8587" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><em class="hi"> go-mysql-elasticsearch还提供了更多的配置，你可以在项目</em><a class="ae lu" href="https://github.com/siddontang/go-mysql-elasticsearch/blob/master/README.md" rel="noopener ugc nofollow" target="_blank"><em class="hi">R</em></a><em class="hi">eadme . MD文件:<br/></em><a class="ae lu" href="https://github.com/siddontang/go-mysql-elasticsearch#source" rel="noopener ugc nofollow" target="_blank">https://github.com/siddontang/go-mysql-elasticsearch#source</a>中查看</p></blockquote><p id="5d92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完成了。现在让我们开始我们的河流。</p><h2 id="2273" class="na kd hi bd ke ng nh ni ki nj nk nl km jb nm nn kq jf no np ku jj nq nr ky ns bi translated">部署河流</h2><p id="9677" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">cd到项目目录中</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="589a" class="na kd hi ly b fi nb nc l nd ne">cd <em class="jr">$GOPATH/src/github.com/siddontang/go-mysql-elasticsearch/</em></span></pre><p id="90a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过运行可执行文件来启动河流</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="e68f" class="na kd hi ly b fi nb nc l nd ne">./bin/go-mysql-elasticsearch -config=./etc/river.toml</span></pre><p id="deaf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您能够成功地配置河流，您将会发现，对于表中所做的每一项更改，您的数据都会流入相应的索引中。速度极快，而且是实时的。</p><h1 id="d322" class="kc kd hi bd ke kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz bi translated">将河流作为一种服务来运营</h1><p id="318d" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">如果您希望river在后台运行，那么在您的Linux环境中，在<em class="jr"> /etc/systemd/system </em>中创建一个系统服务文件</p><p id="952d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建服务文件</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="67b4" class="na kd hi ly b fi nb nc l nd ne">sudo nano /etc/systemd/system/go-mysql-es-river.service</span></pre><p id="9efb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将下列行添加到服务文件中</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="ea04" class="na kd hi ly b fi nb nc l nd ne">[Unit] <br/>Description=Instance to serve go mysql es river <br/>After=network.target <br/> <br/>[Service] <br/>User=ubuntu <br/>Group=www-data <br/>WorkingDirectory=$GOPATH/src/github.com/siddontang/go-mysql-elasticsearch <br/>ExecStart=$GOPATH/src/github.com/siddontang/go-mysql-elasticsearch/bin/go-mysql-elasticsearch -config=/<br/>$GOPATH/src/github.com/siddontang/go-mysql-elasticsearch/etc/river.toml <br/> <br/>[Install] <br/>WantedBy=multi-user.target</span></pre><p id="e312" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">保存文件<em class="jr"> (Ctrl+o &amp;回车)并退出(Ctrl+x) </em></p><p id="b49c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们开始服务吧</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="3820" class="na kd hi ly b fi nb nc l nd ne">sudo systemctl start go-mysql-es-river.service</span></pre><p id="e82a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您希望river在系统启动时启动，那么使用</p><pre class="ms mt mu mv fd mw ly mx my aw mz bi"><span id="51ff" class="na kd hi ly b fi nb nc l nd ne">sudo systemctl enable go-mysql-es-river.service</span></pre></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="302d" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">小外卖</h1><p id="1c8a" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">我们在从RDS同步mysqldump时遇到了一个问题。该问题与go-mysql-elasticsearch无关，而是与RDS相关的权限错误。</p><blockquote class="jo jp jq"><p id="da34" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><strong class="is hj">无法执行“用读锁刷新表”:用户“root”@“%”的访问被拒绝(使用密码:是)(1045) </strong></p></blockquote><p id="ee18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是因为没有足够的权限运行带有AWS RDS中的<br/> -主数据标志的mysqldump。</p><blockquote class="jo jp jq"><p id="1d92" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">如果你遇到这个错误，要么注释river.toml中的mysqldump配置，用Index API或者Bulk API填充es索引。</em> </strong></p></blockquote><p id="9cfa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果没有，您可以按照下面的步骤使用mysqldump填充索引。</p><ol class=""><li id="70d7" class="lz ma hi is b it iu ix iy jb nt jf nu jj nv jn nw mf mg mh bi translated">使用mysqldump转储RDS MySQL服务器，并将其恢复到本地MySQL db。</li><li id="c76d" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn nw mf mg mh bi translated">关闭RDS MySQL服务器</li><li id="bd46" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn nw mf mg mh bi translated">将<code class="du lv lw lx ly b">my_addr</code>设置为本地数据库，启动go-mysql-elasticsearch，并等待搜索完成</li><li id="e7a8" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn nw mf mg mh bi translated">停止go-mysql-elasticsearch并删除var/master.info</li><li id="8895" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn nw mf mg mh bi translated">重新启动RDS MySQL服务器</li><li id="4d5a" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn nw mf mg mh bi translated">重启go-mysql-elasticsearch，用<code class="du lv lw lx ly b">my_addr</code>设置RDS MySQL服务器，用<code class="du lv lw lx ly b">mysqldump</code>清空</li></ol></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="8c9c" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">来自开发者的一些注释</h1><ul class=""><li id="bf83" class="lz ma hi is b it la ix lb jb mb jf mc jj md jn me mf mg mh bi translated">binlog格式必须是行。</li><li id="e2a1" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated">对于MySQL，二进制日志行图像必须是满的，如果在MySQL中使用最小的或无二进制日志行图像更新PK数据，您可能会丢失一些字段数据。MariaDB仅支持整行图像。</li><li id="2ba1" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated">运行时不能改变表格格式。</li><li id="55fd" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated">将要同步的MySQL表应该有一个PK(主键)，现在允许多列PK，例如，如果PKs是(a，b)，我们将使用“a:b”作为键。PK数据将在Elasticsearch中用作“id”。您也可以用其他列配置id的组成部分。</li><li id="d343" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated">你应该先在Elasticsearch中创建关联映射，我不认为使用默认映射是一个明智的决定，你必须知道如何精确搜索。</li><li id="cc25" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated"><code class="du lv lw lx ly b">mysqldump</code>必须与go-mysql-elasticsearch存在于同一个节点，如果不存在，go-mysql-elasticsearch将尝试只同步binlog。</li><li id="f19f" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated">不要在一个SQL中同时更改太多行。</li></ul></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="520c" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">结论</h1><p id="2ebb" class="pw-post-body-paragraph iq ir hi is b it la iv iw ix lb iz ja jb lc jd je jf ld jh ji jj le jl jm jn hb bi translated">这项服务对我们的团队产生了巨大的影响，比如使我们的数据库实例和搜索空间之间的数据同步自动化变得更加顺畅，使数据传输实时发生，并跟踪所有必要的CRUD操作。最终，当我们测试我们的应用程序时，我们发现SQL server中所做的更改实时地反映在相应的es索引上。</p></div><div class="ab cl jv jw gp jx" role="separator"><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka kb"/><span class="jy bw bk jz ka"/></div><div class="hb hc hd he hf"><h1 id="de3c" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">参考</h1><blockquote class="jo jp jq"><p id="5bf9" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated"><a class="ae lu" href="https://github.com/siddontang/go-mysql-elasticsearch" rel="noopener ugc nofollow" target="_blank"> 1。https://github.com/siddontang/go-mysql-elasticsearch</a><br/>2。<a class="ae lu" href="https://golang.org/doc/" rel="noopener ugc nofollow" target="_blank">https://golang.org/doc/</a>3<br/>。<a class="ae lu" href="https://www.elastic.co/blog/how-to-keep-elasticsearch-synchronized-with-a-relational-database-using-logstash" rel="noopener ugc nofollow" target="_blank">https://www . elastic . co/blog/how-to-keep-elastic search-synchronized-with-a-relational-database-using-log stash</a><br/>4 .<a class="ae lu" href="https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html</a>T11】5。<a class="ae lu" href="https://dev.mysql.com/doc/refman/8.0/en/binary-log.html" rel="noopener ugc nofollow" target="_blank">https://dev.mysql.com/doc/refman/8.0/en/binary-log.html</a>6<br/>。<a class="ae lu" href="https://dev.mysql.com/doc/refman/5.7/en/binary-log-setting.html" rel="noopener ugc nofollow" target="_blank">https://dev . MySQL . com/doc/ref man/5.7/en/binary-log-setting . html</a><br/>7 .<a class="ae lu" href="https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/" rel="noopener ugc nofollow" target="_blank">https://dev . MySQL . com/doc/MySQL-installation-extract/5.7/en/</a><br/>8 .<a class="ae lu" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html" rel="noopener ugc nofollow" target="_blank">https://www . elastic . co/guide/en/elastic search/reference/current/install-elastic search . html</a></p></blockquote></div></div>    
</body>
</html>