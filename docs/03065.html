<html>
<head>
<title>Executing commands on-prem using GCP IoT Core devices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GCP物联网核心设备在本地执行命令</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/executing-commands-on-prem-using-gcp-iot-core-devices-c9f0c7f89d56?source=collection_archive---------24-----------------------#2020-01-14">https://medium.com/analytics-vidhya/executing-commands-on-prem-using-gcp-iot-core-devices-c9f0c7f89d56?source=collection_archive---------24-----------------------#2020-01-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/990032ec63d3807161e1e586c89afdcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GokhYKQKxD3QOXah7Aj9HA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌云平台标志。来源:谷歌</figcaption></figure><p id="2905" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在SaaS的一些沉思中，我偶然发现了这个问题。如果客户希望他们的本地设备与您在GCP运行的SaaS通信，您会如何做？</p><p id="26ac" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">对GCP来说，显而易见的答案是服务账户。然而，在GCP每个项目你被限制为100个服务账户，所以这不会扩展得很好。那么，我们还能使用什么来认证大量设备，并与GCP很好地合作呢？当然是物联网核心！</p><p id="dcb5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">物联网核心是一项完全托管的服务(无服务器)，允许您将全球数百万台设备安全连接到GCP。虽然它旨在用于收集遥测数据并将其反馈到中央位置的小型设备，但它也可以用于向设备发送命令并获得响应。</p><p id="f4c2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我决定对它进行测试，并用python创建一个小型物联网客户端，它可以接收DNS名称，在网络中进行查找，并将结果返回给物联网核心。因此，这种情况下的“命令”是DNS查找。一个简单的概念验证，看看物联网核心是否能够胜任任务。基本架构如下所示:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jt"><img src="../Images/3682d54957e36d799b83b8df37471b18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SLK79JYTMralp8L-ZkqijA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">架构图</figcaption></figure><h1 id="13ee" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">正在设置</h1><p id="7eaa" class="pw-post-body-paragraph iu iv hi iw b ix kw iz ja jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr hb bi translated">首先，我遵循了<a class="ae js" href="https://cloud.google.com/iot/docs/how-tos/getting-started" rel="noopener ugc nofollow" target="_blank"> GCP物联网核心入门文档</a>。一旦我设置好了，我就按照“<a class="ae js" href="https://cloud.google.com/iot/docs/how-tos/devices" rel="noopener ugc nofollow" target="_blank">创建注册表和设备</a>”文档进行操作。我创建了一个名为“本地设备”的注册表。它位于“美国中部1”地区，使用“MQTT”协议。我还创建了一个名为“on-prem-devices-telemetry”的发布/订阅主题，以接收来自设备的遥测数据。</p><p id="1092" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">下一步是添加我的设备。要添加设备，您需要证书对其进行鉴定。所以我使用“openssl”生成了所需的密钥:</p><pre class="ju jv jw jx fd lb lc ld le aw lf bi"><span id="a8ac" class="lg jz hi lc b fi lh li l lj lk">openssl req -x509 -nodes -newkey rsa:2048 \<br/>-keyout ./key.pem \<br/>-out crt.pem \<br/>-days 365 \<br/>-subj "/CN=unused"</span></pre><p id="fb88" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">生成证书后，我使用Web UI添加了一个“设备”。“公钥值”是文件“crt.pem”的内容</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es ll"><img src="../Images/3be604353db1861e69331fc5943fd7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*UYcOhCc1fxv18DJp2fiNCQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">GCP“添加设备”用户界面</figcaption></figure><p id="985f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">既然这个设备是在GCP制造的，我需要为这个设备本身编写代码。幸运的是，Google有关于如何发布到MQTT的很好的文档，我可以跟随。他们的示例代码定期发送遥测数据，还处理定期重新认证，这超出了本文的范围。所以我调整了代码，让它更容易理解。它现在从IoT接收命令，进行DNS查找，然后将结果发布回IoT。看起来像这样:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="lm ln l"/></div></figure><p id="2f7b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这将把设备连接到GCP物联网核心，并等待命令。一旦收到包含DNS名称的命令，它将对该名称进行DNS查找，并将地址发布回物联网核心。与google的例子不同，这段代码不会向IoT发布数据，除非您向它发送一个命令。它也不处理生产中需要的重新认证。尽管缺少一些细节，但它确实证明了这样一个概念，即您可以向运行在客户网络上的设备发送经过验证的命令，并接收返回的响应，所有这些都是以安全的方式进行的。</p><h1 id="a275" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">运行代码</h1><p id="972c" class="pw-post-body-paragraph iu iv hi iw b ix kw iz ja jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr hb bi translated">要运行该示例，您可能需要在您的环境中安装“pyjwt”和“paho-mqtt”库。我在我的环境中使用pip3:</p><pre class="ju jv jw jx fd lb lc ld le aw lf bi"><span id="873d" class="lg jz hi lc b fi lh li l lj lk">pip3 install pyjwt<br/>pip3 install paho-mqtt</span></pre><p id="942c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后，您需要将Python文件(dns.py)放在与前面生成的私钥相同的目录中。你还需要下载谷歌的根CA文件，可以在他们的<a class="ae js" href="https://cloud.google.com/iot/docs/how-tos/mqtt-bridge#downloading_mqtt_server_certificates" rel="noopener ugc nofollow" target="_blank">文档</a>中找到，或者直接从<a class="ae js" href="https://pki.goog/roots.pem" rel="noopener ugc nofollow" target="_blank">这里</a>下载，并把它放在同一个目录中。编辑“项目标识”变量以包含您的GCP项目标识。如果名称不同，您可能还需要调整“注册表id”和“设备id”变量。有了它，我们可以测试它:</p><p id="76ed" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用Python 3运行“dns.py ”,它将连接到GCP物联网核心:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lo"><img src="../Images/abf67ad97473b2017d3dabf194eaba2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*5InJLSrfCgsB1bA1M8Yi4A.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在CLI中运行的dns.py的输出</figcaption></figure><p id="e727" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">一旦连接上，你就可以开始发送命令了。你可以连接一个云功能，将命令发送到一个特定的设备。然而，更简单的方法是只在物联网核心UI中发送命令。</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/b82eeeb4aa4572a14c91f043b2c3f310.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JIrGDzpfofNb88Co7xPs7A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">GCP“发送命令”用户界面</figcaption></figure><p id="ebbc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在这里，我们发送一个DNS名称为“example.com”的命令。这将被发送到本地运行的Python代码。它将接收命令并查找该DNS名称。然后将响应发布回物联网核心。Python代码的输出如下所示:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lq"><img src="../Images/712f7d201b67163e630ae43bb2ed116f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*HQFfkm1iG2ESkMpePxf62Q.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">收到命令后的dns.py输出</figcaption></figure><p id="1bf8" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Python发布响应后，物联网核心会将其发送到名为“现场设备遥测”的发布/订阅主题。我创建了一个云函数来监听主题并打印发送给它的任何数据。云函数代码如下所示:</p><pre class="ju jv jw jx fd lb lc ld le aw lf bi"><span id="5bd0" class="lg jz hi lc b fi lh li l lj lk">exports.eventDataPubSub = (event, context) =&gt; {<br/>  console.log(`Data from: ${event.attributes.deviceId}`)<br/>  const pubsubMessage = event.data;<br/>  console.log(Buffer.from(pubsubMessage, 'base64').toString());<br/>};</span></pre><p id="ce37" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Python代码发布其数据后的日志如下所示:</p><figure class="ju jv jw jx fd ij er es paragraph-image"><div class="er es lr"><img src="../Images/d40876609376ebd8b3f12f740c541dc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*hzneKP1u8xaWqs3LSgFFTw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">发布响应后的云函数日志</figcaption></figure><h1 id="509c" class="jy jz hi bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="f037" class="pw-post-body-paragraph iu iv hi iw b ix kw iz ja jb kx jd je jf ky jh ji jj kz jl jm jn la jp jq jr hb bi translated">可以使用物联网来验证客户网络中运行的设备，并向该设备发送命令。在本例中，我们运行了一个简单的python程序，该程序在本地网络上执行DNS查找，并将其连接到GCP物联网核心。物联网核心为我们处理所有的加密和认证。因此，我们可以安全地将DNS名称发送到客户的网络，并取回其IP地址。</p><p id="7c59" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">虽然这个例子本身没有太大的价值，但是我们可以将这个概念应用到其他事情上。例如，您可以挂钩Python代码将命令转发给<a class="ae js" href="https://puppet.com/docs/bolt/latest/bolt.html" rel="noopener ugc nofollow" target="_blank">木偶螺栓</a>。然后，您可以使用Puppet Bolt在网络设备上执行脚本、CLI命令和任务。</p></div></div>    
</body>
</html>