<html>
<head>
<title>3 Terraform tips that will save you from terrible mistakes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">3个将你从可怕的错误中拯救出来的方法</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/3-terraform-tips-will-save-you-from-terrible-mistakes-b379f40e501?source=collection_archive---------31-----------------------#2020-09-17">https://medium.com/analytics-vidhya/3-terraform-tips-will-save-you-from-terrible-mistakes-b379f40e501?source=collection_archive---------31-----------------------#2020-09-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="37a1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2020年9月16日</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/16b9f239f3f822878e40e47cb290646e.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/0*WrDUHJZ1DzT821zU.png"/></div></figure><p id="6a8b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最初贴在这里的是-&gt;<a class="ae jl" href="https://ish-ar.io/terraform-blog-series-3-tips/" rel="noopener ugc nofollow" target="_blank">https://ish-ar.io/terraform-blog-series-3-tips/</a></p><h1 id="cd39" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">1.一个大的单一州文件是不会帮助你的。</h1><p id="10b3" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">当一个新用户开始使用Terraform时，在一个大的存储库和一个大的状态文件<br/>下管理所有的基础设施代码似乎更容易(对于不知道什么是状态文件的人，请查看本页-&gt;<a class="ae jl" href="https://www.terraform.io/docs/state/index.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/docs/state/index.html</a></p><p id="f558" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，这种设计很快就会显示出它的缺点和局限性。</p><p id="5f93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">为什么单声道状态文件在性能方面不是一个好主意？</strong></p><p id="1346" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原因之一是在“地形图”命令中有一个动作叫做“刷新”。这一步意味着Terraform将要“将Terraform知道的状态(通过它的状态文件)与现实世界的基础设施相协调。”<br/>如果有一个映射了整个基础设施的大型状态文件，而一个人只想更改一个GKE集群，那么就删除一个EC2实例或创建一个新的bucket。<br/>猜猜看？<strong class="ih hj">这需要更新整个基础设施</strong>(相信我，这需要一段时间！)</p><p id="5748" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">但是基础设施的可靠性如何呢？</strong></p><p id="4912" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果有人对mono状态文件运行“terraform destroy ”,会发生什么？<br/>是的。都没了。你必须重建基础设施。</p><p id="2e42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果有人使用新的terraform版本会怎么样？(例如:从terraform 0.11到terraform 0.12) <br/>每个人都必须升级CLI版本，如果你不走运，你可能还需要更新实际的terraform代码。还有其他原因，但是我确信我已经说得够清楚了:不要使用单一的状态文件！-.-'</p><h1 id="fb3a" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">2.Monorepo是邪恶的。</h1><p id="861e" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">有人可能会说:让我们把所有的东西放在一起，模块，代码，所有的东西都放在一个仓库里，但是放在不同的目录里，有不同的状态文件:太棒了。-'</p><p id="0dfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">相信我，当我说我见过Terraform最糟糕的事情:在不同的目录中使用符号链接共享/复制变量的存储库，我见过巨大的mono存储库，从bash脚本和SQL数据库生成的terraform文件，相信我，这并不新奇。</p><p id="1dc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就代码可靠性而言，为什么大型存储库不是一个好主意？简单明了:它不可扩展。<br/>现在想象一下，你是一个由5名工程师组成的小团队，将所有的基础设施代码放在一起似乎是一个好主意。<br/>你们都有创建/删除/编辑terraform代码的权限，这样，你们就不必处理多个管道等。</p><p id="c575" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而一年后，你的5人小团队变成了100人。其他工程师现在希望使用Terraform来管理他们的基础设施(网络工程师、数据库管理员、数据工程师、数据科学家等)。).</p><p id="fab7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">管理权限、协调terraform变更以及创建一个能够满足每个人需求的完整管道/自动化将变得棘手(并非不可能)。</p><p id="1bb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您已经在那个单一的存储库中使用了模块，那会怎么样呢？你将如何管理模块版本？糟糕的存储库结构设计会产生所有这些障碍。</p><p id="a721" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你已经在那里了呢？<br/>我的建议是从将模块转移到不同的仓库开始。<br/>您也可以开始自动测试和标记模块。</p><p id="67f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成第一步后，将您的基础设施分成几层，并开始在由该基础设施层的所有者管理的不同存储库中划分层。<br/>这会很痛苦！<br/>记住，一分耕耘，一分收获！</p><h1 id="2dbd" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">3.不要手动运行Terraform:使用管道。</h1><p id="6e61" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">在这里，我也看到了最糟糕的事情。我曾经为一家公司工作，该公司曾经有一个松弛的频道，他们通过基本上发送类似“我正在使用Terraform”或“Terraform锁定”的信息来“锁定”terraform:我的意思是…真的吗？“锁定地形”？-.-'</p><p id="89ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">拥有正确的编排和自动化将有助于您的团队不要覆盖彼此的更改。<br/>如果你计划使用管道，我的建议是<em class="kp">不要</em>并行构建，在基础设施的微小部分上运行自动化。这样做，就不会有很长的管道，而是有着有效反馈循环的快速流动。</p><p id="d96a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">始终标记您的基础设施代码</em>，并将其视为真正的软件/应用。</p><p id="7558" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">运行测试。测试Terraform代码可能看起来很复杂，但有一些有用的工具，如“terratest”。<br/>如果你对Go很熟悉，你可以学习Hashicorp关于使用Terraform进行单元测试的教程。</em></p><p id="3ebe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">您应该有一个工具来处理配置项，另一个工具来运行部署。</em> <br/>在我看来，理想的情况是CI工具推送一个包含测试过的Terraform代码的工件，而deploy挑选工件并部署它。</p><h1 id="9e44" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">结论</h1><p id="a0d4" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">运行Terraform的完美方式并不存在。<br/>在大多数情况下，这取决于用例，但有一些错误，我会定义每个人都应该避免的常见错误。记住:良好的开端是成功的一半:)</p></div><div class="ab cl kq kr gp ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="hb hc hd he hf"><p id="aa3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">原载于</em><a class="ae jl" href="https://ish-ar.io/terraform_blog_series_3_tips/" rel="noopener ugc nofollow" target="_blank"><em class="kp">https://ish-ar . io</em></a><em class="kp">。</em></p></div></div>    
</body>
</html>