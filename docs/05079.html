<html>
<head>
<title>How to keep your app serverless with Google Sheets as a data-storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Google Sheets作为数据存储让你的应用不需要服务器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-keep-your-app-serverless-with-google-sheets-as-a-data-storage-e80dff70e9fc?source=collection_archive---------18-----------------------#2020-04-10">https://medium.com/analytics-vidhya/how-to-keep-your-app-serverless-with-google-sheets-as-a-data-storage-e80dff70e9fc?source=collection_archive---------18-----------------------#2020-04-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/995a73d9352a2767a7c26d1d58c00403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H2nB64u_u2gl3U9obULehg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用Python、Google Sheets和云功能实现无服务器化</figcaption></figure><p id="2a5e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是从数据新闻的角度报道新冠肺炎全球新闻的第三篇文章。<a class="ae js" rel="noopener" href="/@joeface/building-a-covid-19-map-using-django-leafletjs-google-spreadsheets-and-s3-cloud-storage-75bb522771f9">的第一篇文章</a>是对我们交互式地图背后的解决方案的总体描述。<a class="ae js" rel="noopener" href="/@joeface/extra-f549a4a0fc4f">第二个</a>是关于处理各种数据源和在地图上渲染自定义特征。</p><p id="21b4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这一篇是关于在Python 上构建一个<strong class="iw hj">无服务器应用程序的技术方面，用于获取、组合、存储和提供JSON数据。</strong></p><h1 id="9d8e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">云函数</h1><p id="b22f" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">最初，报废应用打算作为使用cli的简单<strong class="iw hj"> Python </strong>脚本来执行，作为<strong class="iw hj"> Google Cloud Function </strong>、<strong class="iw hj"> Amazon Lambda </strong>或<strong class="iw hj"> Docker容器</strong>。作为一个crontab作业，它在我的Ubuntu服务器上运行得很好。</p><p id="4628" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然而，手动数据输入有一个障碍，需要我在源代码中更新科索沃和白俄罗斯的新冠肺炎数据，然后将其推送到repo。这不是一个方便且有弹性的解决方案。</p><p id="8b3a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，如何存储和更新这些数据，保持应用程序的轻量级。如何让没有技术背景的人(记者)更新数据的过程变得顺畅？</p><p id="2c95" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">有一个解决办法。</p><h1 id="d1af" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">作为存储引擎的谷歌电子表格</h1><p id="1ab8" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">想象一下，您必须存储和更新您的应用程序经常使用的数据。数据必须由不同的人安全地更新，并具有用户友好的界面。</p><p id="21dd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">当然，您可能需要花费几个小时来设置整个虚拟机，为此解决方案配置web服务器和web框架，管理用户凭证。</p><p id="b4d3" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">但是，如果我们简单地使用谷歌电子表格作为存储引擎和API层会怎么样呢？</p><h2 id="ac33" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">电子表格的主要优势</h2><ul class=""><li id="3f12" class="lk ll hi iw b ix kr jb ks jf lm jj ln jn lo jr lp lq lr ls bi translated">访问控制模型</li><li id="87a8" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr lp lq lr ls bi translated">众所周知的用户界面和工作流程</li><li id="eaa3" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr lp lq lr ls bi translated">数据有效性</li><li id="d34a" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr lp lq lr ls bi translated">通过URL将数据导出为CSV格式(这里我们忽略<a class="ae js" href="https://developers.google.com/sheets/api/quickstart/python" rel="noopener ugc nofollow" target="_blank"> Google Sheets API </a></li></ul><h1 id="ccd3" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">解决方案</h1><p id="7756" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">这是我们在谷歌电子表格中的数据存储:</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/20cface44ea39ba4df56a211ea2b0dfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nvJLUZIMh7opC-8bkiJlpA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">谷歌电子表格数据存储</figcaption></figure><p id="ff08" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了让用户更容易更新数据并避免输入错误，我们可以实现<strong class="iw hj">数据验证</strong>和格式化列。</p><p id="38ff" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">“国家”列中的每个字段都变成一个下拉列表，其中包含另一个工作表中的国家列表。没有唯一索引的模型中的外键关系。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/19ad8102ae4b8fffb919094c82014139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yDqCpn2GxJaLo69AJxXbLg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">设置列的值列表</figcaption></figure><p id="0476" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们必须通过URL将电子表格制作成CSV文件:<strong class="iw hj">File→Publish to web</strong>。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/a90132c4d83a4febae28d5c30e33ed12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-esoOOS4u2nSrhnyId_NYw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">将Google电子表格发布为CSV格式</figcaption></figure><p id="dc6b" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">搞定了。现在，您有了一个带有可读格式数据的<a class="ae js" href="https://docs.google.com/spreadsheets/d/e/2PACX-1vSZ_YhO6H0Q-dBX1sifVmDN9nonyx0xBePvqsU6NdsJJVO-B1MdBRXRCjHo9NBlYpl96AZai8_HGXKa/pub?gid=0&amp;single=true&amp;output=csv" rel="noopener ugc nofollow" target="_blank"> URL </a>。您可以与指定人员共享电子表格，并让Google为您管理认证和授权。</p><blockquote class="mf mg mh"><p id="47bd" class="iu iv mi iw b ix iy iz ja jb jc jd je mj jg jh ji mk jk jl jm ml jo jp jq jr hb bi translated">显然，可以使用<a class="ae js" href="https://developers.google.com/sheets/api/quickstart/python" rel="noopener ugc nofollow" target="_blank"> Google Sheets API </a>来获取数据。然而，在我看来，CSV导出在这种特殊情况下更快更容易。</p></blockquote><h1 id="5df8" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Python云函数</h1><p id="0983" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">最后要做的事情是写一些代码。下面是一个获取电子表格内容并返回记录列表的基本函数:</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mm mn l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">用Python从Google电子表格中获取和解析数据</figcaption></figure><p id="0a50" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然而，这对于一个无服务器的应用程序来说是不够的。我们必须从JHU的<strong class="iw hj">CSSE</strong><a class="ae js" href="https://services1.arcgis.com/0MSEUqKaxRlEPj5g/arcgis/rest/services/ncov_cases/FeatureServer/2/query?f=json&amp;where=1%3D1&amp;returnGeometry=false&amp;spatialRel=esriSpatialRelIntersects&amp;outFields=*&amp;orderByFields=OBJECTID%20ASC&amp;outSR=102100&amp;resultOffset=0&amp;resultRecordCount=250&amp;cacheHint=true&amp;quantizationParameters=%7B%22mode%22%3A%22edit%22%7D" rel="noopener ugc nofollow" target="_blank">ArcGIS map feed</a>和<a class="ae js" href="https://github.com/CSSEGISandData/COVID-19/" rel="noopener ugc nofollow" target="_blank"> github repo </a>、<strong class="iw hj"> Worldometer </strong> <a class="ae js" href="https://www.worldometers.info/coronavirus/" rel="noopener ugc nofollow" target="_blank">网站</a>获取数据，最后，将数据与我们的<strong class="iw hj"> Google Sheets </strong>来源结合起来。</p><p id="ffab" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，我们从安装依赖项开始(参见requirements.txt)。为了将我们的JSON输出存储在亚马逊S3类型的存储中，我们必须设置AWS_*环境变量。否则，该应用程序会尝试将数据存储在Redis中，作为向云的备份。</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mm mn l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">支持Redis和亚马逊S3类型云存储的Google Cloud/Amazon Lambda的新冠肺炎数据解析器</figcaption></figure><p id="4612" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在上面的要点中，谷歌电子表格的URL被移到了环境变量中，使得应用程序更加灵活。</p><h1 id="7721" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">运行谷歌云功能</h1><p id="4bb6" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在<a class="ae js" href="https://console.cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云控制台</a>中加入你的Python功能是相当明显的:</p><ol class=""><li id="9dad" class="lk ll hi iw b ix iy jb jc jf mo jj mp jn mq jr mr lq lr ls bi translated">选择如何触发功能执行(例如云发布/订阅主题)</li><li id="fdda" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr mr lq lr ls bi translated">为代码选择源代码(在我们的例子中，我们使用行内编辑)</li><li id="22da" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr mr lq lr ls bi translated">复制并粘贴功能代码，并提供所需软件包的列表</li><li id="e4ef" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr mr lq lr ls bi translated">设置环境变量(我们用Google Sheet的URL设置MANUAL_DATA_SOURCE_URL ),然后单击Deploy</li></ol><p id="d4c7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">就这些。</p><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/56f8755a0f3110948a71da4cde417a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z09Jf4vMbqloyKElCtxHmA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">将Python代码部署为谷歌云功能</figcaption></figure><figure class="lz ma mb mc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/7913a3c8778aef1777db4759b7483752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NsWtU5pHCiQ7Y9cxlW1OxA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">作为Google云功能运行update_covid19_data的日志</figcaption></figure><h1 id="2474" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">支持Redis的go Docker</h1><p id="5606" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">您可能想更进一步，将整个东西包装成Docker容器。没问题伙计们。</p><figure class="lz ma mb mc fd ij"><div class="bz dy l di"><div class="mm mn l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">用于运行Python应用程序的Docker容器</figcaption></figure></div><div class="ab cl mu mv gp mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="hb hc hd he hf"><p id="a2fb" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢阅读！你可以在<a class="ae js" href="https://github.com/joeface/COVID-19-Data-Fabric" rel="noopener ugc nofollow" target="_blank"> github </a>上找到详细的自述文件、项目的所有源代码以及带有crontab任务的Ubuntu-container 的<strong class="iw hj"> Docker配置。</strong></p></div></div>    
</body>
</html>