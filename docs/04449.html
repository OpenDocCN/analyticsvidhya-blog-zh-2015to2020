<html>
<head>
<title>Google Big Query with R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带R的Google大查询</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/google-big-query-with-r-875facef7844?source=collection_archive---------3-----------------------#2020-03-20">https://medium.com/analytics-vidhya/google-big-query-with-r-875facef7844?source=collection_archive---------3-----------------------#2020-03-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0d5d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">用R API实现闪电般的数据库查询。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es ix"><img src="../Images/e03de448d356379fe0ae386af4228e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*0w8mCGsOdP79QEKy0A2CJQ.jpeg"/></div><figcaption class="jf jg et er es jh ji bd b be z dx translated"><a class="ae jj" href="https://blog.dotcom-monitor.com/web-page-load-speed/web-performance-analytics-https-archive-bigquery/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><p id="d7d4" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><em class="kg">这篇文章也发表在【https://www.r-bloggers.com/】<a class="ae jj" href="https://www.r-bloggers.com/" rel="noopener ugc nofollow" target="_blank"><em class="kg"/></a><em class="kg">上。</em></em></p><p id="0237" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated"><em class="kg">这是关于用R和Docker构建和部署一个健壮的API的系列文章的第一部分，这个API允许您从Google Big Query中提取实时数据。对于第二部分，请参见</em> <a class="ae jj" rel="noopener" href="/analytics-vidhya/live-data-extraction-with-cron-and-r-f29324bf153e"> <em class="kg">使用Cron和R </em> </a> <em class="kg">进行简单而可靠的实时数据提取。</em></p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="4fa4" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated">什么是谷歌大查询？</h1><p id="766a" class="pw-post-body-paragraph jk jl hi jm b jn lg ij jp jq lh im js jt li jv jw jx lj jz ka kb lk kd ke kf hb bi ll translated"><span class="l lm ln lo bm lp lq lr ls lt di"> B </span> <a class="ae jj" href="https://cloud.google.com/bigquery/what-is-bigquery" rel="noopener ugc nofollow" target="_blank"> ig Query </a>是一个高性能的云数据存储服务，始于2011年。您可以在Google Cloud控制台中管理它，并从bq控制台或通过API使用标准SQL命令查询存储。它很容易设置，自动缩放，并且有各种已建立的谷歌和其他服务的连接器。在本文中，我将向您展示使用Big Query的优势，以及如何使用R中的API和使用<code class="du lu lv lw lx b">dplyr</code>函数构建查询。</p><h1 id="be1b" class="ko kp hi bd kq kr ly kt ku kv lz kx ky io ma ip la ir mb is lc iu mc iv le lf bi translated">大查询有什么优势？</h1><p id="8d2b" class="pw-post-body-paragraph jk jl hi jm b jn lg ij jp jq lh im js jt li jv jw jx lj jz ka kb lk kd ke kf hb bi translated">与其他云数据存储相比，Google Big Query有一些优势。其他技术可能不相上下，甚至更好，但所有优势的结合，尤其是与谷歌的整合，是Big Query真正出众的地方。优点是:</p><ul class=""><li id="1e14" class="md me hi jm b jn jo jq jr jt mf jx mg kb mh kf mi mj mk ml bi translated"><strong class="jm hj">闪电般的快速查询速度:</strong> BQ拥有与其他现代数据库技术类似的<a class="ae jj" href="https://www.atscale.com/blog/tech-talk-bi-performance-benchmarks-with-bigquery-from-google/" rel="noopener ugc nofollow" target="_blank">基准测试结果</a>。BQ还<a class="ae jj" href="https://fivetran.com/blog/warehouse-benchmark" rel="noopener ugc nofollow" target="_blank">与其他数据仓库</a>解决方案进行了比较，这些解决方案具有类似的功能，如Amazon Redshift、Snowflake、Microsoft Azure和Presto，并且都显示出或多或少类似的性能和定价。</li></ul><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="er es mm"><img src="../Images/e4b7626d8798560af45226c0bff7ff30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FSkqehEluYJrGjKyaLTazg.png"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">大查询在不使用GROUP BY语句的情况下表现出优异的性能(Q1)，在使用GROUP BY语句的情况下表现明显更差(Q2-Q3)。通过许多大型连接和许多GROUP by(Q4 ),它在其他测试技术中表现中等。<a class="ae jj" href="https://www.atscale.com/blog/tech-talk-bi-performance-benchmarks-with-bigquery-from-google/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="er es mr"><img src="../Images/71d7e1e0d56fb397b10e9a261cf5eaf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qvnxzbux5jzrPEt0a4RTpg.png"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">Biq Query在并发查询下确实表现出色。由于快速的自动伸缩，与其他技术相比，查询时间保持不变。<a class="ae jj" href="https://www.atscale.com/blog/tech-talk-bi-performance-benchmarks-with-bigquery-from-google/" rel="noopener ugc nofollow" target="_blank">来源</a></figcaption></figure><ul class=""><li id="da93" class="md me hi jm b jn jo jq jr jt mf jx mg kb mh kf mi mj mk ml bi translated"><strong class="jm hj">低成本:</strong> BQ的成本与其他大数据仓库解决方案类似。截至目前，每月存储成本为0.02美元/GB，数据查询成本为5美元/TB。每月10 GB存储免费，每月1 TB数据查询免费。许多操作，如数据加载、复制、导出、删除以及失败的查询都是免费的。此外，还有查询缓存，如果您对相同的、未更改的数据再次运行查询，您不必付费。也有统一价格。</li><li id="97fe" class="md me hi jm b jn ms jq mt jt mu jx mv kb mw kf mi mj mk ml bi translated"><strong class="jm hj">与谷歌服务轻松集成:</strong>来自<strong class="jm hj">谷歌分析360 </strong>的数据可以轻松存储在BQ中。这是一个很大的优势，因为Google Analytics对存储的行数有限制，并且只支持样本数据的报告。如果您将分析数据存储在BQ中，您可以获得更详细的客户旅程，并将每个维度与每个指标相结合，因为您可以访问所有跟踪数据。此外，Google云存储和Google Drive上的数据集可以通过BQ查询，无需手动导入数据集。</li><li id="11a8" class="md me hi jm b jn ms jq mt jt mu jx mv kb mw kf mi mj mk ml bi translated"><strong class="jm hj">易于与其他工具集成:</strong> BQ拥有自己的机器学习套件，带有大型查询ML引擎，使您能够导入tensorflow模型进行预测。还有一个BQ BI引擎，但这两个对我来说都不是特别有用，因为功能有限。Tableau、Qlik或Looker等许多服务都有BQ的连接器。</li><li id="38c8" class="md me hi jm b jn ms jq mt jt mu jx mv kb mw kf mi mj mk ml bi translated"><strong class="jm hj">无操作管理:</strong>建立BQ和管理安全与恢复不需要任何数据库管理知识。</li><li id="072d" class="md me hi jm b jn ms jq mt jt mu jx mv kb mw kf mi mj mk ml bi translated"><strong class="jm hj">公共数据集:</strong>你在BQ上有一个很好的公共可用数据选择，一些数据集在不断更新！</li></ul></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><h1 id="ce41" class="ko kp hi bd kq kr ks kt ku kv kw kx ky io kz ip la ir lb is lc iu ld iv le lf bi translated">使用带R的大查询</h1><h2 id="9bed" class="mx kp hi bd kq my mz na ku nb nc nd ky jt ne nf la jx ng nh lc kb ni nj le nk bi translated">启用大查询并获取您的凭据</h2><ol class=""><li id="811f" class="md me hi jm b jn lg jq lh jt nl jx nm kb nn kf no mj mk ml bi translated">进入<a class="ae jj" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>，用你的谷歌账号登录。在左上角转到“选择项目”并开始一个新项目。如果你在你的主页上点击“转到API概述”，你会看到谷歌云服务的激活的API。默认情况下，所有新项目都应该激活“BigQuery API”和“BigQuery Storage API”。</li></ol><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="er es np"><img src="../Images/3ac113ec47fd8bf6cb97cf35c3e673bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aTeAY560rFnBKx_89rfung.jpeg"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">为一个新的谷歌云项目激活API。</figcaption></figure><p id="a331" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">2.按照<code class="du lu lv lw lx b">gargle</code> R包<a class="ae jj" href="https://gargle.r-lib.org/articles/get-api-credentials.html" rel="noopener ugc nofollow" target="_blank">这里</a>的描述获取你的API密匙。简而言之，转到上面显示的仪表板中Google Cloud Platform的凭证部分，创建凭证&gt; API密钥。您可以重命名您的API键，并将其限制为仅使用某些API，如“BigQuery API”。如果您需要应用程序访问BQ，您将需要一个<a class="ae jj" href="https://gargle.r-lib.org/articles/get-api-credentials.html" rel="noopener ugc nofollow" target="_blank">服务帐户令牌</a>，您可以将它作为JSON下载。</p><h2 id="9b31" class="mx kp hi bd kq my mz na ku nb nc nd ky jt ne nf la jx ng nh lc kb ni nj le nk bi translated">用R查询</h2><p id="0afc" class="pw-post-body-paragraph jk jl hi jm b jn lg ij jp jq lh im js jt li jv jw jx lj jz ka kb lk kd ke kf hb bi translated">为了查询BQ，我们将使用R库<a class="ae jj" href="https://github.com/r-dbi/bigrquery" rel="noopener ugc nofollow" target="_blank"> bigrquery </a>。BQ的另一个突出的R库是<a class="ae jj" href="https://code.markedmondson.me/bigQueryR/" rel="noopener ugc nofollow" target="_blank"> bigQueryR </a>，与bigquery相反，它依赖于库<a class="ae jj" href="https://github.com/MarkEdmondson1234/googleAuthR" rel="noopener ugc nofollow" target="_blank"> googleAuthR </a>，这使得它与Shiny和其他包更加兼容。</p><p id="adf5" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">首先，我们获取库并用我们创建的API密钥或下载的服务帐户令牌JSON进行身份验证。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nq nr l"/></div></figure><p id="6370" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">现在，我们可以开始查询我们的大查询数据或公共数据集。我们将从<a class="ae jj" href="https://openaq.org/#/?_k=h8s64f" rel="noopener ugc nofollow" target="_blank"> openAQ </a>中查询实时空气质量数据集。这是一个开源项目，它提供来自全球5490个空气质量测量站的实时数据(如果你扩展“实时”的定义)，这太棒了！如果你登录谷歌，你可以在大查询<a class="ae jj" href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&amp;d=openaq&amp;page=dataset&amp;project=" rel="noopener ugc nofollow" target="_blank">这里</a>看到数据集和简短描述。要在云控制台中查找开放数据集，请向下滚动左侧菜单，您应该会在标题“大数据”下看到“大查询”。如果您转到“+添加数据”，您将能够浏览公共数据集。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="er es ns"><img src="../Images/5e36cb493765698c14abb09c2a071793.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HkivOfKVIeKTHgpHqS0JiA.png"/></div></div><figcaption class="jf jg et er es jh ji bd b be z dx translated">我们将要查询的公共全球空气质量数据表的模式显示在BigQuery云控制台中。</figcaption></figure><p id="664c" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">我们将使用<code class="du lu lv lw lx b">DBI</code>包装<code class="du lu lv lw lx b">bigrquery</code> API，以便能够使用<code class="du lu lv lw lx b">dplyr</code>动词，然而<a class="ae jj" href="https://bigrquery.r-dbi.org/" rel="noopener ugc nofollow" target="_blank"> bigrquery </a>包也提供了一个低级API。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nq nr l"/></div></figure><p id="a471" class="pw-post-body-paragraph jk jl hi jm b jn jo ij jp jq jr im js jt ju jv jw jx jy jz ka kb kc kd ke kf hb bi translated">在本例中，您可以看到使用转换为SQL查询的<code class="du lu lv lw lx b">dplyr</code>函数进行查询，但是您无法获得直接SQL查询所提供的全部灵活性。为此，您可以从r通过<code class="du lu lv lw lx b">DBI::dbGetQuery()</code>发送SQL查询。全球空气质量数据集会定期更新，但是旧的条目会被忽略，这可能是为了节省存储成本。查看我的下一篇文章，关于如何构建一个Dockerized Cron-job来获取来自印度的最新空气污染数据，同时保留旧的记录。</p></div></div>    
</body>
</html>