<html>
<head>
<title>Part 3.1 !! Pandas DataFrame to PostgreSQL using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第3.1部分！！使用Python将数据帧转换为PostgreSQL</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/part-3-1-pandas-dataframe-to-postgresql-using-python-8a3e3da87ff1?source=collection_archive---------3-----------------------#2020-11-26">https://medium.com/analytics-vidhya/part-3-1-pandas-dataframe-to-postgresql-using-python-8a3e3da87ff1?source=collection_archive---------3-----------------------#2020-11-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d610" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><strong class="ak">使用executemany()将批量数据插入PostgreSQL数据库</strong></h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/f378a6e3c14636a2fb0f30aaa22ae5ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kBVnjRYKvwu_z2NCDZgZcw.png"/></div></div></figure><h1 id="1e84" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">先决条件</h1><p id="b764" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated"><strong class="kd hj">Python 3 . 8 . 3:</strong><a class="ae kx" href="https://www.anaconda.com/products/individual" rel="noopener ugc nofollow" target="_blank">Anaconda下载链接</a></p><p id="ff5c" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj">PostgreSQL 13:</strong>T8<strong class="kd hj">T10】下载链接</strong></p><p id="a836" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj"> Psycopg2 : </strong>安装<strong class="kd hj"> Psycopg2 </strong>使用命令:<strong class="kd hj"> pip安装psycopg2 </strong></p><h1 id="8267" class="jj jk hi bd jl jm jn jo jp jq jr js jt io ju ip jv ir jw is jx iu jy iv jz ka bi translated">目标</h1><p id="360b" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">本文的主要目标是逐步学习<strong class="kd hj"><em class="ld">execute many()</em></strong>方法的工作代码。</p><h2 id="60a0" class="le jk hi bd jl lf lg lh jp li lj lk jt kk ll lm jv ko ln lo jx ks lp lq jz lr bi translated">第1步:准备或识别您的数据</h2><p id="29ff" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">首先，准备或确定要导入PostgreSQL数据库的CSV文件。例如，我们从GitHub加载虹膜数据。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="613a" class="le jk hi lt b fi lx ly l lz ma"><strong class="lt hj"># import sys to get more detailed Python exception info</strong><br/>import sys<br/><strong class="lt hj"># import the connect library for psycopg2</strong><br/>import psycopg2<br/><strong class="lt hj"># import the error handling libraries for psycopg2</strong><br/>from psycopg2 import OperationalError, errorcodes, errors<br/><strong class="lt hj">import</strong> psycopg2.extras <strong class="lt hj">as</strong> extras<br/>import pandas as pd</span><span id="5555" class="le jk hi lt b fi mb ly l lz ma">irisData = pd.read_csv('<a class="ae kx" href="https://raw.githubusercontent.com/Muhd-Shahid/Learn-Python-Data-Access/main/iris.csv" rel="noopener ugc nofollow" target="_blank">https://github.com/Muhd-Shahid/Write-Raw-File-into-Database-Server/raw/main/iris.csv</a>',index_col=False)</span></pre><h2 id="6cc8" class="le jk hi bd jl lf lg lh jp li lj lk jt kk ll lm jv ko ln lo jx ks lp lq jz lr bi translated">第二步:<strong class="ak">指定连接参数</strong></h2><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="c8a8" class="le jk hi lt b fi lx ly l lz ma"><strong class="lt hj"># Note: please change your database, username &amp; password as per your own values<br/></strong>conn_params_dic = {<br/>    "host"      : "localhost",<br/>    "database"  : "irisdb",<br/>    "user"      : "postgres",<br/>    "password"  : "Passw0rd"<br/>}</span></pre><h2 id="49b4" class="le jk hi bd jl lf lg lh jp li lj lk jt kk ll lm jv ko ln lo jx ks lp lq jz lr bi translated">第三步:支持功能</h2><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="3fe6" class="le jk hi lt b fi lx ly l lz ma"><strong class="lt hj"><em class="ld"># Define a function that handles and parses psycopg2 exceptions</em><br/>def show_psycopg2_exception(err):</strong><br/>    <strong class="lt hj"># get details about the exception</strong><br/>    err_type, err_obj, traceback = sys.exc_info()   <strong class="lt hj"> <br/>    # get the line number when exception occured</strong><br/>    line_n = traceback.tb_lineno    <br/>    <strong class="lt hj"># print the connect() error</strong><br/>    print ("\npsycopg2 ERROR:", err, "on line number:", line_n)<br/>    print ("psycopg2 traceback:", traceback, "-- type:", err_type) <br/>    <strong class="lt hj"># psycopg2 extensions.Diagnostics object attribute</strong><br/>    print ("\nextensions.Diagnostics:", err.diag)   <strong class="lt hj"> <br/>    # print the pgcode and pgerror exceptions</strong><br/>    print ("pgerror:", err.pgerror)<br/>    print ("pgcode:", err.pgcode, "\n")</span><span id="f78b" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"><em class="ld"># Define a connect function for PostgreSQL database server</em><br/>def connect(conn_params_dic):</strong><br/>    conn = None<br/>    try:<br/>        print('Connecting to the PostgreSQL...........')<br/>        conn = psycopg2.connect(**conn_params_dic)<br/>        print("Connection successfully..................")<br/>        <br/>    except OperationalError as err:<br/>        <strong class="lt hj"># passing exception to function</strong><br/>        show_psycopg2_exception(err)       <strong class="lt hj"> <br/>        # set the connection to 'None' in case of error</strong><br/>        conn = None<br/>    return conn</span><span id="f0f8" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"># Define function using cursor.executemany() to insert the dataframe</strong><br/>def execute_many(conn, datafrm, table):<br/>    <br/>    <strong class="lt hj"><em class="ld"># Creating a list of tupples from the dataframe values</em></strong><br/>    tpls = [tuple(x) for x in datafrm.to_numpy()]<br/>    <br/>    <strong class="lt hj"><em class="ld"># dataframe columns with Comma-separated</em></strong><br/>    cols = ','.join(list(datafrm.columns))<br/>    <br/>  <strong class="lt hj"><em class="ld">  # SQL query to execute</em></strong><br/>    sql = "INSERT INTO %s(%s) VALUES(%%s,%%s,%%s,%%s,%%s)" % (table, cols)<br/>    cursor = conn.cursor()<br/>    try:<br/>        cursor.executemany(sql, tpls)<br/>        conn.commit()<br/>        print("Data inserted using execute_many() successfully...")<br/>    except (Exception, psycopg2.DatabaseError) as err:<br/>        <strong class="lt hj"><em class="ld"># pass exception to function</em></strong><br/>        show_psycopg2_exception(err)<br/>        cursor.close()</span></pre><h2 id="0e29" class="le jk hi bd jl lf lg lh jp li lj lk jt kk ll lm jv ko ln lo jx ks lp lq jz lr bi translated">步骤4:执行主要任务</h2><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="c441" class="le jk hi lt b fi lx ly l lz ma"><strong class="lt hj"><em class="ld"># Connect to the database</em></strong><br/>conn = connect(conn_params_dic)<br/>conn.autocommit = True<br/><strong class="lt hj"><em class="ld"># Run the execute_many method</em></strong><br/>execute_many(conn, irisData, 'iris')</span></pre><h2 id="0f97" class="le jk hi bd jl lf lg lh jp li lj lk jt kk ll lm jv ko ln lo jx ks lp lq jz lr bi translated"><strong class="ak">第五步:查询数据库检查我们的工作</strong></h2><p id="5b00" class="pw-post-body-paragraph kb kc hi kd b ke kf ij kg kh ki im kj kk kl km kn ko kp kq kr ks kt ku kv kw hb bi translated">让我们查询数据库，以确保我们插入的数据已被正确保存。</p><pre class="iy iz ja jb fd ls lt lu lv aw lw bi"><span id="69b7" class="le jk hi lt b fi lx ly l lz ma"><strong class="lt hj"><em class="ld"># declare a cursor object from the connection</em></strong><br/>cursor = conn.cursor()</span><span id="6212" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"><em class="ld"># Execute query</em></strong><br/>sql = "SELECT * FROM iris"<br/>cursor.execute(sql)</span><span id="b632" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"><em class="ld"># Fetch all the records</em></strong><br/>tuples = cursor.fetchall()</span><span id="5b88" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"><em class="ld"># Preparing list of columns for dataframe</em></strong><br/>cols = list(irisData.columns)</span><span id="4f29" class="le jk hi lt b fi mb ly l lz ma">irisdf = pd.DataFrame(tuples,columns=cols)<br/>print(irisdf.head())</span><span id="24fd" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"><em class="ld"># close the cursor object to avoid memory leaks</em></strong><br/>cursor.close()</span><span id="2ade" class="le jk hi lt b fi mb ly l lz ma"><strong class="lt hj"><em class="ld"># close the connection object</em></strong><br/>conn.close()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mc"><img src="../Images/c2d623b50b229eb71771ea192405f407.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3nZxO3gXAD29MjDQ0sAAzw.png"/></div></div></figure><p id="44e5" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj">结论:</strong>我们第3部分关于使用<strong class="kd hj"><em class="ld">execute many()</em></strong>插入批量数据的内容到此结束。在本教程中，我们学习了如何使用python将数据插入PostgreSQL数据库。</p><p id="f8e4" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated">本文的所有代码都可以作为GitHub    <em class="ld">上的<a class="ae kx" href="https://github.com/Muhd-Shahid/Learn-Python-Data-Access/tree/main/PostgreSQL" rel="noopener ugc nofollow" target="_blank"> <strong class="kd hj"> <em class="ld"> Jupyter笔记本获得。</em></strong></a></em></p><blockquote class="md me mf"><p id="31b9" class="kb kc ld kd b ke ky ij kg kh kz im kj mg la km kn mh lb kq kr mi lc ku kv kw hb bi translated"><strong class="kd hj"> <em class="hi">接下来</em> </strong> <a class="ae kx" rel="noopener" href="/analytics-vidhya/part-3-2-pandas-dataframe-to-postgresql-using-python-8dc0b0741226"> <strong class="kd hj"> <em class="hi">第3.2部分</em></strong></a><em class="hi"/><strong class="kd hj"><em class="hi">:使用Python </em> </strong>使用execute_batch()方法将批量数据插入PostgreSQL数据库</p><p id="b5e3" class="kb kc ld kd b ke ky ij kg kh kz im kj mg la km kn mh lb kq kr mi lc ku kv kw hb bi translated"><strong class="kd hj">之前的学习:</strong></p><p id="3579" class="kb kc ld kd b ke ky ij kg kh kz im kj mg la km kn mh lb kq kr mi lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/pandas-dataframe-to-postgresql-using-python-part-1-93f928f6fac7" rel="noopener"> <strong class="kd hj">第一部分</strong> </a> <strong class="kd hj">:简介、连接&amp;数据库创建</strong></p><p id="0ee4" class="kb kc ld kd b ke ky ij kg kh kz im kj mg la km kn mh lb kq kr mi lc ku kv kw hb bi translated"><a class="ae kx" href="https://shahid-dhn.medium.com/pandas-dataframe-to-postgresql-using-python-part-2-3ddb41f473bd" rel="noopener"> <strong class="kd hj"> <em class="hi">第二部分</em> </strong> </a> <strong class="kd hj"> <em class="hi">:使用Python </em> </strong>在PostgreSQL数据库中创建表</p></blockquote><p id="6f39" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated">保持乐观！！注意安全！！继续学习:))</p><p id="b328" class="pw-post-body-paragraph kb kc hi kd b ke ky ij kg kh kz im kj kk la km kn ko lb kq kr ks lc ku kv kw hb bi translated"><strong class="kd hj">感谢您的阅读！！</strong></p></div></div>    
</body>
</html>