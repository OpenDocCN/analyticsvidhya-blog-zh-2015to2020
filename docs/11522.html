<html>
<head>
<title>Background Asynchronous Process using Django+Celery+Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Django+芹菜+Redis 的后台异步过程</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/background-asynchronous-process-using-django-celery-redis-9af973a4f5d9?source=collection_archive---------3-----------------------#2020-12-07">https://medium.com/analytics-vidhya/background-asynchronous-process-using-django-celery-redis-9af973a4f5d9?source=collection_archive---------3-----------------------#2020-12-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0b06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 Web 应用程序开发中创建后台异步进程是不可避免的，芹菜使整个过程变得简单和容易。这个博客的主要重点是使用 Django 和芹菜创建一个后台进程，Redis 作为消息代理。</p><p id="c0f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1。下载并安装 Redis </strong></p><p id="6f03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以从<a class="ae jd" href="https://redis.io/download" rel="noopener ugc nofollow" target="_blank"><em class="je"/></a><em class="je">下载并安装 Redis。</em>确保 Redis 已启动，并且 Redis 服务器正在运行。</p><blockquote class="jf jg jh"><p id="272e" class="if ig je ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">注意:您系统中安装的 Redis 版本应该大于 3.0</p></blockquote><p id="e7d0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2 .基本安装</strong></p><p id="a2c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为第一步，创建一个虚拟环境并安装以下内容:</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="c0e0" class="ju jv hi jq b fi jw jx l jy jz">$ virtualenv scheduler-env<br/>$ cd scheduler-env<br/>$ source bin/activate<br/>$ pip install Django==3.1.3<br/>$ pip install celery==5.0.0<br/>$ pip install django-celery-beat==2.1.0<br/>$ pip install django-celery-results==2.0.0<br/>$ pip install redis==3.5.3</span></pre><p id="f634" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.<strong class="ih hj">创建姜戈项目和应用程序，添加基本配置</strong></p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="570a" class="ju jv hi jq b fi jw jx l jy jz">$ django-admin startproject testproj<br/>$ cd testproj<br/>$ django-admin startapp testtasks</span></pre><p id="869d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 testproj/testproj/settings.py 中添加以下内容</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="462f" class="ju jv hi jq b fi jw jx l jy jz">#testproj/testproj/settings.py</span><span id="139c" class="ju jv hi jq b fi ka jx l jy jz">INSTALLED_APPS += [<br/>    'django_celery_beat',<br/>    'django_celery_results',<br/>    <!-- -->'testtasks'<br/>]<br/>CELERY_RESULT_BACKEND = "django-db"<br/>CELERY_IMPORTS = ('testtasks.tasks')</span></pre><p id="4a1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.<strong class="ih hj">运行迁移</strong></p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="41fd" class="ju jv hi jq b fi jw jx l jy jz">python manage.py makemigrations<br/>python manage.py migrate</span></pre><p id="3c99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.<strong class="ih hj">添加芹菜，更新项目配置。</strong></p><p id="ed36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 path testproj/testproj 中创建一个文件芹菜. py，并将以下内容添加到该文件中。</p><blockquote class="jf jg jh"><p id="d39a" class="if ig je ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">注意:将文件中的“<strong class="ih hj"> testproj </strong>”替换为您的项目名称</p></blockquote><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="7f2f" class="ju jv hi jq b fi jw jx l jy jz">#testproj/testproj/celery.py</span><span id="60d6" class="ju jv hi jq b fi ka jx l jy jz">import os<br/>from celery import Celery</span><span id="fb23" class="ju jv hi jq b fi ka jx l jy jz">#set the default django settings to celery<br/>os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'testproj.settings')</span><span id="302e" class="ju jv hi jq b fi ka jx l jy jz">app = Celery('testproj')</span><span id="14ec" class="ju jv hi jq b fi ka jx l jy jz">app.config_from_object('django.conf:settings', namespace='CELERY')</span><span id="99f3" class="ju jv hi jq b fi ka jx l jy jz"># Load task modules from all registered Django app configs.<br/>app.autodiscover_tasks()</span><span id="c2b8" class="ju jv hi jq b fi ka jx l jy jz">#message broker configurations<br/>BASE_REDIS_URL = os.environ.get('REDIS_URL', 'redis://localhost:6379')</span><span id="d00d" class="ju jv hi jq b fi ka jx l jy jz">app.conf.broker_url = BASE_REDIS_URL</span><span id="c5e2" class="ju jv hi jq b fi ka jx l jy jz">#creating a celery beat scheduler to start the tasks<br/>app.conf.beat_scheduler = 'django_celery_beat.schedulers.DatabaseScheduler'</span></pre><p id="fa4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新 testproj/testproj/__init__ 中的芹菜项目配置。巴拉圭</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="3098" class="ju jv hi jq b fi jw jx l jy jz">#testproj/testproj/__init__.py<br/>from .celery import app </span></pre><p id="2a77" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.<strong class="ih hj">创建任务</strong></p><p id="5b9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 testproj/testtasks 路径中创建一个任务文件“tasks.py ”,并添加以下内容。如果您已经注意到，此任务. py 将在设置. py 中作为芹菜导入。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="d5cd" class="ju jv hi jq b fi jw jx l jy jz">#testproj/testtasks/tasks.py</span><span id="00e7" class="ju jv hi jq b fi ka jx l jy jz">import random<br/>from celery import Celery<br/>from testproj.celery import app</span><span id="ba2f" class="ju jv hi jq b fi ka jx l jy jz"><a class="ae jd" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.task(name='tasks.add')<br/>def add(x, y):<br/>    return x + y</span></pre><p id="08c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.<strong class="ih hj">验证任务</strong></p><p id="8e6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开一个终端并启动工作进程，</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="7069" class="ju jv hi jq b fi jw jx l jy jz">$ celery --app=testproj worker -l INFO</span></pre><p id="7421" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在另一个终端，打开外壳</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="d1f8" class="ju jv hi jq b fi jw jx l jy jz">$ python manage.py shell</span></pre><p id="9e70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 shell 中执行以下操作，</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="d336" class="ju jv hi jq b fi jw jx l jy jz">&gt;&gt;&gt; from testtasks.tasks import *<br/>&gt;&gt;&gt; add.delay(10,20)<br/>&lt;AsyncResult: 2f7057cb-7c2f-49b8-9f9b-640d54a62b6e&gt;</span></pre><p id="0ac5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当任务被调用时，您可以看到工作进程执行任务，并在工作进程运行的终端中给出结果。</p><p id="358e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">8.<strong class="ih hj">创建周期性任务</strong></p><p id="c0a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您还可以创建在特定时间间隔内执行任务的定期流程。让我们创建一个周期任务，每 3 秒运行一次。</p><p id="38f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在芹菜中加入下列物质</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="3ef2" class="ju jv hi jq b fi jw jx l jy jz">#testproj/testproj/celery.py</span><span id="12bc" class="ju jv hi jq b fi ka jx l jy jz">app.conf.beat_schedule = {<br/>    'add-every-3-seconds': {<br/>        'task': 'tasks.add',<br/>        'schedule': 3.0,<br/>        'args': (16, 16)<br/>    },<br/>}<br/>app.conf.timezone = 'UTC'</span></pre><p id="d49b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的代码片段每 3 秒运行一次任务“add”。您可以通过在单独的终端中运行工人和节拍来检查以下内容。您可以看到芹菜节拍启动任务，工作进程执行任务。</p><blockquote class="jf jg jh"><p id="7165" class="if ig je ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">注意:将“testproj”更改为您的项目名称</p></blockquote><p id="6fbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">终端 1-工作进程</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="5285" class="ju jv hi jq b fi jw jx l jy jz">$ celery --app=testproj worker -l INFO</span></pre><p id="301f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2 号航站楼-芹菜段</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="a633" class="ju jv hi jq b fi jw jx l jy jz">$ celery -A testproj beat -l INFO --scheduler django_celery_beat.schedulers:DatabaseScheduler</span></pre><p id="9636" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献:</strong></p><ol class=""><li id="eae3" class="kb kc hi ih b ii ij im in iq kd iu ke iy kf jc kg kh ki kj bi translated"><a class="ae jd" href="https://docs.celeryproject.org/en/latest/django/first-steps-with-django.html" rel="noopener ugc nofollow" target="_blank"><em class="je">https://docs . celeriproject . org/en/latest/django/first-steps-with-django . html</em></a></li><li id="902e" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated"><a class="ae jd" href="https://docs.celeryproject.org/en/latest/userguide/tasks.html" rel="noopener ugc nofollow" target="_blank"><em class="je">https://docs . celerrproject . org/en/last/user guide/tasks . html</em></a></li><li id="c000" class="kb kc hi ih b ii kk im kl iq km iu kn iy ko jc kg kh ki kj bi translated"><a class="ae jd" href="https://docs.celeryproject.org/en/stable/userguide/periodic-tasks.html" rel="noopener ugc nofollow" target="_blank"><em class="je">https://docs . celery project . org/en/stable/user guide/periodic-tasks . html</em></a></li></ol></div></div>    
</body>
</html>