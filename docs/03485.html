<html>
<head>
<title>How to resolve high disk usage in Cassandra</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何解决Cassandra中的高磁盘使用率</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/how-to-resolve-high-disk-usage-in-cassandra-870674b636cd?source=collection_archive---------1-----------------------#2020-02-04">https://medium.com/analytics-vidhya/how-to-resolve-high-disk-usage-in-cassandra-870674b636cd?source=collection_archive---------1-----------------------#2020-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b52b11b22c12136ccfa8f7277837101b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xdBO69V6X3O6OetD"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">马库斯·斯皮斯克在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="b5e9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是Cassandra集群中高磁盘使用率的一些故障排除步骤。</p><p id="e687" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">找到根本原因:维度不合适，写入的数据比预期的多，ttl或其他值较高。</p><h1 id="3bf2" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">选项:</h1><h2 id="1daf" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">A.添加容量-</h2><ol class=""><li id="4e51" class="lf lg hi ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">添加磁盘:垂直缩放</li><li id="5d9a" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">使用JBOD为表添加第二个位置文件夹，移动其中一些，然后重新启动Cassandra。数据文件目录:</li></ol><ul class=""><li id="5339" class="lf lg hi ix b iy iz jc jd jg lv jk lw jo lx js ly ln lo lp bi translated">/var/lib/cassandra/data</li><li id="61e8" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js ly ln lo lp bi translated">/var/lib/Cassandra/data-额外注意:JBOD功能在急需磁盘空间的紧急情况下会很有用，但是在这种情况下使用它应该是暂时的。</li></ul><p id="a6b5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.添加新节点:水平缩放</p><h2 id="f39e" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">B.减少使用的磁盘空间。</h2><h2 id="fd61" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">不要:</h2><ol class=""><li id="569f" class="lf lg hi ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">直接删除表</li><li id="dcdc" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">运行修复:它不驱逐墓碑</li><li id="f256" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">正在执行删除操作。</li></ol><h2 id="08a7" class="kr ju hi bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">Do的</h2><ol class=""><li id="a79e" class="lf lg hi ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">快照:使用“nodetool listsnapshot”检查快照是否已经存在于cassandra数据目录中，如果该选项不存在，则检查目录。如果存在，则在备份后使用“nodetool clearsnapshot”将其清除。</li><li id="4967" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">Cassandra磁盘中存在的其他文件修复:删除任何堆转储或其他可能存储在那里的文件</li><li id="02db" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">放大后忘记运行“节点工具清理”。</li><li id="f934" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">请检查“nodetool compactionstats”。通过列出临时表，压缩的当前开销:<em class="lz"> tmp </em> Data.db. fix:禁用压缩。删除它们。逐一进行压实。</li><li id="a200" class="lf lg hi ix b iy lq jc lr jg ls jk lt jo lu js lm ln lo lp bi translated">修复期间的反压缩还会导致临时的磁盘使用高峰</li></ol><p id="8fa0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">日志:9e 09 c 490-f1be-11e 7-b2ea-b 3085 f 85 ccae维修后防碰撞货物事件数据147.3 GB 158.54 GB字节92.91%</p><p id="e01a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">147 GB *[压缩比]。例如，如果压缩率为0.3，那么在反压缩结束后不久就会回收44GB。</p><p id="c878" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">修复:使用子范围修复</p><p id="8b17" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.修复过程中出现的一些溢出。请检查“nodetool netstats”。</p><p id="f10c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">修复:节流蒸。nodetool setstreamthroughput。流吞吐量出站兆比特每秒:200 mbps</p><p id="935d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">7.Tombstones:当tombstones被逐出时:7.1如果tombstones创建时间跨越了GCGP 7.2如果在某个其他文件中不存在具有相同分区的旧数据。(重叠表格)</p><p id="6a59" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">8.关于压缩战略的思考:STCS vs LSCS。稍后可能会有所缓解，但请注意，空间不应该只是改变压缩策略的理由。</p><p id="c7ec" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">9.TWCS:直接从cassandra中删除数据可能会导致数据丢失，但如果使用twcs，如果稳定的创建时间与ttl冲突，可以小心操作。否则可以使用unsafe _ aggressive _ sstable _ expiration = true，这样在移除之前不会检查重叠的ss table文件。</p><p id="5578" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">10.注意，在STCS，较大的桌子不参与压实，除非它属于同一铲斗。</p><p id="f30e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">修复:设置“uncheck _ tombstone _ compaction:true”通常会有所帮助。</p><p id="c735" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果不可用，请使用sstablemetadata和用户定义的压缩，如下所示。</p><p id="4adf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用表元数据:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="67cb" class="kr ju hi mf b fi mj mk l ml mm">for f in *.db; do meta=$(/home/user1/tools/bin/sstablemetadata $f); echo -e "Max:" $(date --date=@$(echo "$meta" | grep Maximum\ time | cut -d" "  -f3| cut -c 1-10) '+%Y/%m/%d %H:%M:%S') "Min: " $(date --date=@$(echo "$meta" | grep Minimum\ time | cut -d" "  -f3| cut -c 1-10) '+%Y/%m/%d %H:%M:%S') $(echo "$meta" | grep droppable) $(ls -lh $f | awk '{print $5" "$6" "$7" "$8" "$9}'); done | sort</span><span id="3052" class="kr ju hi mf b fi mn mk l ml mm">Max: 2017/12/07 10:06:46 Min:  2017/01/10 11:40:11 Estimated droppable tombstones: 0.524078481591479 4.4K Jan 21 07:07 ks-table-jb-2730206-Statistics.db<br/>Max: 2018/01/16 17:02:09 Min:  2017/01/10 09:52:06 Estimated droppable tombstones: 0.4882548629950296 4.5K Jan 21 07:07 ks-table-jb-2730319-Statistics.db<br/>Max: 2018/02/01 14:13:56 Min:  2017/01/10 08:15:39 Estimated droppable tombstones: 0.0784809244867484 5.9K Jan 21 07:07 ks-table-jb-2730216-Statistics.db<br/>Max: 2018/04/03 06:21:42 Min:  2017/01/10 08:13:04 Estimated droppable tombstones: 0.17692511128881072 5.9K Jan 21 07:07 ks-table-jb-2730344-Statistics.db</span></pre><p id="6c70" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用户定义的压缩:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="b679" class="kr ju hi mf b fi mj mk l ml mm">SSTABLE_LIST="/Users/tlp/.ccm/2-2-9/node1/data0/ks/table-b260e6a0a7cd11e9a56a372dfba9b857/lb-46464-big-Data.db,\<br/>/Users/tlp/.ccm/2-2-9/node1/data0/ks/table-b260e6a0a7cd11e9a56a372dfba9b857/lb-46464-big-Data.db"</span><span id="a443" class="kr ju hi mf b fi mn mk l ml mm">JMX_CMD="run -b org.apache.cassandra.db:type=CompactionManager forceUserDefinedCompaction ${SSTABLE_LIST}"<br/>echo ${JMX_CMD} | java -jar jmxterm-1.0-alpha-4-uber.jar -l localhost:7100<br/>#calling operation forceUserDefinedCompaction of mbean org.apache.cassandra.db:type=CompactionManager<br/>#operation returns:<br/>null</span></pre><p id="7693" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者nodetool garbagecollect如果有cassandra版本也可以有效。注意:这是io密集型操作。</p><p id="c796" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">11.检查集群是否不平衡:“节点工具状态”负载。修复:确保没有手动错误，如每个节点的num_token不相等或init_token设置不正确。没有正确选择分区键。</p><p id="5e69" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">12.磁盘空间超过90%时的预防措施。由于没有足够的空间修复，您的压缩可能会失败:通过将“未使用的”表移动到其他地方或截断它们来立即获得一些空间，以便为其他表的压缩提供一些空间。</p><p id="429a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">13.可能是你的Cassandra版本的一个错误:例如:过时的压缩文件没有被删除。滚动重启后，在修复运行时登录Cassandra 2.0.14:</p><ul class=""><li id="0c51" class="lf lg hi ix b iy iz jc jd jg lv jk lw jo lx js ly ln lo lp bi translated"><code class="du mo mp mq mf b">INFO [CompactionExecutor:1957] 2020-01-20 06:44:56,721 CompactionTask.java (line 120) Compacting [SSTableReader(path='/var/lib/cassandra/data/keyspace/columnfamily/keyspace-columnfamily-jb-123456-Data.db'), SSTableReader(path='/var/lib/cassandra/data/keyspace/columnfamily/keyspace-columnfamily-jb-234567-Data.db'), SSTableReader(path='/var/lib/cassandra/data/keyspace/columnfamily/keyspace-columnfamily-jb-345678-Data.db')] INFO [CompactionExecutor:1957] 2020-01-20 12:45:23,270 ColumnFamilyStore.java (line 795) Enqueuing flush of Memtable-compactions_in_progress@519967741(0/0 serialized/live bytes, 1 ops) INFO [CompactionExecutor:1957] 2020-01-20 12:45:23,502 CompactionTask.java (line 296) Compacted 3 sstables to [/var/lib/cassandra/data/keyspace/columnfamily/keyspace-columnfamily-jb-456789,]. 136,795,757,524 bytes to 100,529,812,389 (~73% of original) in 21,626,781ms = 4.433055MB/s. 1,738,999,743 total partitions merged to 1,274,232,528. Partition merge counts were {1:1049583261, 2:309997005, 3:23140824, }</code></li></ul><p id="6266" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">修复:删除过时的文件，重启并尽快升级到稳定版本。</p><p id="fdcf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考和信用:自己的经验和Cassandra用户邮件列表。</p></div></div>    
</body>
</html>