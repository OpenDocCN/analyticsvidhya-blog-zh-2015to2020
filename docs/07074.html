<html>
<head>
<title>Calling R from Python | Magic of rpy2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Python调用R | rpy 2的魔力</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/calling-r-from-python-magic-of-rpy2-d8cbbf991571?source=collection_archive---------0-----------------------#2020-06-13">https://medium.com/analytics-vidhya/calling-r-from-python-magic-of-rpy2-d8cbbf991571?source=collection_archive---------0-----------------------#2020-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e101fc37dd064a3cf74a68797ab93075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6x1UGd4dLe7XpiS4gT41xA.png"/></div></div></figure><p id="35ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据科学的两个大朋友是<strong class="is hj"> Python </strong>和<strong class="is hj"> R </strong>。虽然许多人对这两种方法都很满意，但在Python中使用R功能通常不会出现在我们的日常生活中。因为当我开始我的数据科学之路时，Python是语言，而R是人们开始忘记的东西。像<code class="du jo jp jq jr b">&lt;-, %&gt;%, variable$attribute</code>这样的R语法已经足够让我说<em class="js">不</em>并坚持使用python。</p><p id="9628" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">长话短说，一些写得很好的库强迫我“动手”。看一看R，它并不全是坏的，事实上时间序列分析和某些数据处理确实比python快。这工作得很好，直到我的项目中既有R代码又有Python代码。这太疯狂了，出于很多原因，你也可能以这种情况告终。于是我开始问这个问题，<strong class="is hj">如何从Python调用R脚本？</strong></p><p id="0c1f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你以前问过谷歌这个问题，首先出现的话题显然是令人惊叹的python库<a class="ae jt" href="https://pypi.org/project/rpy2/" rel="noopener ugc nofollow" target="_blank"> rpy2 </a>。现在，这不会是一个关于rpy2的详细教程，但是我将解释如何从Python中调用用R编写的函数。Rpy2提供了很多功能来使用python本身的R库和函数，但是修复数据类型不一致可能是一个真正的麻烦，所以这是我能想到的最好的快速修复方法。如果我正在读这篇文章，我不会走这么远，所以恭喜你！让我们直接进入代码，看看我们在这里处理的是什么。</p><p id="0b40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">预处理。稀有</p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="fb69" class="kc kd hi jr b fi ke kf l kg kh">filter_country &lt;- function(df, country){<br/>  #' Preprocessing df to filter country<br/>  #'<br/>  #' This function returns a subset of the df<br/>  #' if the value of the country column contains <br/>  #' the country we are passing<br/>  #'<br/>  #' <a class="ae jt" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> df The dataframe containing the data <br/>  #' <a class="ae jt" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank">@param</a> country The country we want to filter<br/>  #<br/>  df = subset(df, df$Country == country)<br/>  return(df)<br/>}</span></pre><p id="61a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是一个R脚本<strong class="is hj">预处理。R </strong>包含一个函数<strong class="is hj"> filter_country </strong>，这个函数基本上过滤你所经过的国家的数据帧。这纯粹是为了演示，你可以用R的高级函数库让这个函数尽可能的复杂。现在让我们看看调用R脚本的python脚本。</p><p id="3245" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">预处理程序. py</p><pre class="ju jv jw jx fd jy jr jz ka aw kb bi"><span id="cf9f" class="kc kd hi jr b fi ke kf l kg kh">import pandas as pd<br/>import rpy2.robjects as robjects<br/>from rpy2.robjects import pandas2ri</span><span id="696e" class="kc kd hi jr b fi ki kf l kg kh"># Defining the R script and loading the instance in Python<br/>r = robjects.r<br/>r['source']('preprocess.R')</span><span id="8f8a" class="kc kd hi jr b fi ki kf l kg kh"># Loading the function we have defined in R.<br/>filter_country_function_r = robjects.globalenv['filter_country']</span><span id="4ac8" class="kc kd hi jr b fi ki kf l kg kh"># Reading and processing data<br/>df = pd.read_csv("Country-Sales.csv")</span><span id="c5b5" class="kc kd hi jr b fi ki kf l kg kh">#converting it into r object for passing into r function<br/>df_r = pandas2ri.ri2py(df)<br/>#Invoking the R function and getting the result<br/>df_result_r = filter_country_function_r(df_r, 'USA')<br/>#Converting it back to a pandas dataframe.<br/>df_result = pandas2ri.py2ri(df_result_r)</span></pre><p id="ec1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一开始这可能有点让人不知所措，但我会一步一步解释。</p><ol class=""><li id="1aa9" class="kj kk hi is b it iu ix iy jb kl jf km jj kn jn ko kp kq kr bi translated">我们正在定义我们想要从中获取函数的源文件。为此，我们通过传入R脚本的路径在<code class="du jo jp jq jr b">robjects.r[‘source’]()</code>中指定source。</li><li id="f3c1" class="kj kk hi is b it ks ix kt jb ku jf kv jj kw jn ko kp kq kr bi translated">然后，我们从<code class="du jo jp jq jr b">robjects.globalenv</code>中加载我们想要的函数，方法是将键作为我们在r中定义的函数的名称传入。您可以在这个脚本中定义多个函数，并通过它们各自的名称引用它们。我们将检索到的函数存储在一个python变量中。</li><li id="64bb" class="kj kk hi is b it ks ix kt jb ku jf kv jj kw jn ko kp kq kr bi translated">现在，在我们将一个数据帧传递给这个函数之前，我们必须注意到一个<strong class="is hj">熊猫数据帧</strong>和一个<strong class="is hj"> R数据帧</strong>是不同的。幸运的是<em class="js"> pandas2ri </em>提供了在数据帧类型之间来回转换的函数。</li><li id="a07f" class="kj kk hi is b it ks ix kt jb ku jf kv jj kw jn ko kp kq kr bi translated">将熊猫数据帧转换为R数据帧。我们对它进行转换，并将其传递给我们从r对象创建的python函数。</li><li id="cee1" class="kj kk hi is b it ks ix kt jb ku jf kv jj kw jn ko kp kq kr bi translated">最后的结果是一个R数据帧，所以我们需要把它转换回熊猫数据帧。我们使用<code class="du jo jp jq jr b">pandas2ri.ri2py(df_result_r)</code>将其转换回熊猫数据帧。</li></ol><p id="1fc3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">瞧，我们已经用Python完成了R函数的接口。因此，通过维护一个基本的dataframe输入输出操作，我们将能够轻松地在Python内部接口R函数！:)</p><p id="2c43" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">也请注意，在一些论坛中，有人建议pandas version==0.23.x是最理想的，我亲自测试了它，发现了一些与其他更高版本集成的错误。</p></div></div>    
</body>
</html>