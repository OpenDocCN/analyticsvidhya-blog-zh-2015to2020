<html>
<head>
<title>Golang Command Line Git Parser</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang命令行Git解析器</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/golang-command-line-git-parser-2f4e85ac8fc6?source=collection_archive---------9-----------------------#2019-10-19">https://medium.com/analytics-vidhya/golang-command-line-git-parser-2f4e85ac8fc6?source=collection_archive---------9-----------------------#2019-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/fe1a60c1e4b06087276a182765160ff6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKhH0-D0BdQXv1qFJClEnA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">来源:<a class="ae iu" href="https://github.com/egonelbre/gophers" rel="noopener ugc nofollow" target="_blank">https://github.com/egonelbre/gophers</a></figcaption></figure><p id="6704" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">每天早上10点，我的团队都有一个虚拟的每日站立，每个成员都写下他们昨天完成了什么，并希望他们今天继续工作。</p><p id="5ec3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其中一个挑战是，在任何一天，我都可能在做多个项目，而试图在24小时后记住我在一个工作日所做的一切可能很难。</p><p id="be71" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是为什么我在Go中构建了一个命令行工具，它将遍历每个项目目录，并显示我在过去24小时内提交的所有内容。让我们投入进去吧！</p><p id="3818" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要获得最终代码:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="5d58" class="kc kd hi jy b fi ke kf l kg kh">cd $GOPATH/github.com<br/>git clone <a class="ae iu" href="https://github.com/Lebonesco/daily-standup-cli" rel="noopener ugc nofollow" target="_blank">https://github.com/Lebonesco/daily-standup-cli</a></span></pre></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="445a" class="kp kd hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">一些CLI样板文件</h1><p id="a48a" class="pw-post-body-paragraph iv iw hi ix b iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">我们将使用两个第三方软件包。<code class="du lr ls lt jy b">cli</code>将是我们构建项目的客户端库，<code class="du lr ls lt jy b">go-homedir</code>提供了一些有用的文件系统方法。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="4e25" class="kc kd hi jy b fi ke kf l kg kh">mkdir daily-standup-cli<br/>cd daily-standup-cli<br/>touch main.go<br/>go get <a class="ae iu" href="https://github.com/urfave/cli" rel="noopener ugc nofollow" target="_blank">https://github.com/urfave/cli</a><br/>go get github.com/mitchellh/go-homedir</span></pre><p id="8d39" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你有兴趣了解更多关于这个项目使用的<code class="du lr ls lt jy b">cli</code>包的信息，那么<a class="ae iu" href="https://github.com/urfave/cli" rel="noopener ugc nofollow" target="_blank">回购</a>中的文档是广泛的。</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="9ad3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的代码中，我们已经设置了启动客户端并传入各种标志的功能。现在，我们保持它的简单，只有三个标志，但你可以很容易地扩展这个项目的功能，能够做的事情，如指定你的输出到一个电子邮件，slack频道，或文件。</p><p id="a009" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面的代码块指定了一个名为<code class="du lr ls lt jy b">user</code>或<code class="du lr ls lt jy b">u</code>的标志，没有默认值。</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="f45a" class="kc kd hi jy b fi ke kf l kg kh">...<br/>cli.StringFlag{   <br/>    Name:  "user, u",<br/>    Value: "",<br/>    Usage: "git user name",  <br/>},<br/>...</span></pre><p id="900d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lr ls lt jy b">app.Action</code>是我们运行程序时执行核心代码的地方。<code class="du lr ls lt jy b">c.String("flag")</code>返回一个标志值。<code class="du lr ls lt jy b">dir</code>标志默认为您的系统主目录，<code class="du lr ls lt jy b">after</code>设置为从当前时间起24小时。唯一没有默认值的标志是<code class="du lr ls lt jy b">user</code>，它是您的git用户名。</p><p id="8027" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要查看我们的客户详情:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="1af0" class="kc kd hi jy b fi ke kf l kg kh">go run main.go --help</span><span id="3dd1" class="kc kd hi jy b fi lw kf l kg kh">NAME:<br/>   Daily Standup Helper CLI - Reports git history</span><span id="671a" class="kc kd hi jy b fi lw kf l kg kh">USAGE:<br/>   main [global options] command [command options] [arguments...]</span><span id="b245" class="kc kd hi jy b fi lw kf l kg kh">VERSION:<br/>   1.0.0</span><span id="8506" class="kc kd hi jy b fi lw kf l kg kh">AUTHOR:<br/>   github.com/Lebonesco</span><span id="1bed" class="kc kd hi jy b fi lw kf l kg kh">COMMANDS:<br/>   help, h  Shows a list of commands or help for one command</span><span id="b281" class="kc kd hi jy b fi lw kf l kg kh">GLOBAL OPTIONS:<br/>   --user value, -u value   git user name<br/>   --dir value, -d value    parent directory to start recursively searching for *.git files (default: "/Users/josephlivni")<br/>   --after value, -a value  when to start looking at commit history (default: "2019-10-18T14:21:17")<br/>   --help, -h               show help<br/>   --version, -v            print the version</span></pre><h1 id="23f4" class="kp kd hi bd kq kr lx kt ku kv ly kx ky kz lz lb lc ld ma lf lg lh mb lj lk ll bi translated">应用程序的核心</h1><p id="ee79" class="pw-post-body-paragraph iv iw hi ix b iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">是时候进入有趣的部分了！</p><p id="b8ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下一节将包括遍历文件夹、捕获git日志、将它们临时存储在内存中，然后将它们保存为格式化的JSON文件的代码。</p><h2 id="e0b3" class="kc kd hi bd kq mc md me ku mf mg mh ky jg mi mj lc jk mk ml lg jo mm mn lk mo bi translated">捕获Git日志</h2><p id="0fb3" class="pw-post-body-paragraph iv iw hi ix b iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">下面的代码接受我们想要执行的<code class="du lr ls lt jy b">git log</code>命令的路径、我们关心其提交的用户以及我们想要开始过滤的日期。</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="22ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你只是运行<code class="du lr ls lt jy b">git log</code>,你会在你的终端上得到大量的非结构化数据。幸运的是，git为我们提供了一个<code class="du lr ls lt jy b">--pretty=format</code>选项，允许我们将结果输出到格式化的XML中。<code class="du lr ls lt jy b">%an</code>会给我们作者的名字，<code class="du lr ls lt jy b">%cd</code>提交日期，<code class="du lr ls lt jy b">%B</code>提交消息。如果你想了解更多关于git日志格式的信息，请查看官方文档。</p><h2 id="0075" class="kc kd hi bd kq mc md me ku mf mg mh ky jg mi mj lc jk mk ml lg jo mm mn lk mo bi translated">在目录中爬行</h2><p id="85d2" class="pw-post-body-paragraph iv iw hi ix b iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">这里的想法是，我们将在文件系统中爬行，当我们找到一个<code class="du lr ls lt jy b">.git</code>文件时，我们将执行上面刚刚编写的代码并捕获日志。</p><p id="df73" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">幸运的是，Go有一个方法<code class="du lr ls lt jy b">filepath.Walk()</code>，给定一个起始目录，它将向下递归遍历。</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="4e0e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">代码相当简单。当我们用<code class="du lr ls lt jy b">info.Name() == .git</code>点击一个文件时，我们从那个项目中获得提交日志。然后，我们获取XML字节，将它们转换成一个<code class="du lr ls lt jy b">commit</code>结构，并将结果附加到<code class="du lr ls lt jy b">commits</code>。</p><p id="4bb9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意:<em class="mp">我们不能使用</em> <code class="du lr ls lt jy b"><em class="mp">xml.Umarshal(b, &amp;commit)</em></code> <em class="mp">将字节转换为结构的原因是，我们从git接收的结果是一个没有包装标签的XML对象数组。因此，</em> <code class="du lr ls lt jy b"><em class="mp">xml.Umarshal</em></code> <em class="mp">只会给我们第一个结果。</em> <code class="du lr ls lt jy b"><em class="mp">d.Decode</em></code> <em class="mp">足够聪明，可以遍历数组，直到命中末端。</em></p><h2 id="869d" class="kc kd hi bd kq mc md me ku mf mg mh ky jg mi mj lc jk mk ml lg jo mm mn lk mo bi translated">将所有东西整合在一起</h2><p id="634f" class="pw-post-body-paragraph iv iw hi ix b iy lm ja jb jc ln je jf jg lo ji jj jk lp jm jn jo lq jq jr js hb bi translated">我们最后将编写<code class="du lr ls lt jy b">runClient</code>，它将把我们所有的代码结合在一起，并将我们的结果保存到一个本地文件中。</p><p id="187e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面的代码将运行<code class="du lr ls lt jy b">getGitHistory()</code>并将结果保存为一个格式良好的JSON文件。</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="f3b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，如果您对能够从任何地方运行它感兴趣，请运行:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="2190" class="kc kd hi jy b fi ke kf l kg kh">cp main /usr/local/bin/&lt;whatever-you-want-to-call-it&gt;</span></pre><p id="ae49" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">全部完成！</p><p id="b3d1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢你阅读这篇文章。我希望它是有趣的。</p></div></div>    
</body>
</html>