<html>
<head>
<title>AWS S3 Multipart Upload/Download using Boto3 (Python SDK)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Boto3 (Python SDK)进行AWS S3多部分上传/下载</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/aws-s3-multipart-upload-download-using-boto3-python-sdk-2dedb0945f11?source=collection_archive---------1-----------------------#2020-07-03">https://medium.com/analytics-vidhya/aws-s3-multipart-upload-download-using-boto3-python-sdk-2dedb0945f11?source=collection_archive---------1-----------------------#2020-07-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/8f7a0a5a5e905140acaf8e5f756c7b26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*OPji094ZhoHv5X4AhI7DEA.png"/></div></figure><p id="53c4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们每天都在处理大量的数据集。我们工作描述的一部分是以低延迟传输数据:)。亚马逊简单存储服务(S3)可以存储高达5TB的文件，但通过一次上传操作，我们只能上传高达5 GB的对象。Amazon建议，对于大于100 MB的对象，客户应该考虑使用<em class="jk">多部分上传</em>功能。</p><p id="2cc7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jk"> AWS SDK、AWS CLI </em>和<em class="jk"> AWS S3 REST API </em>可用于多部分上传/下载。对于CLI，请阅读这篇<a class="ae jl" href="https://aws.amazon.com/premiumsupport/knowledge-center/s3-multipart-upload-cli/" rel="noopener ugc nofollow" target="_blank">博文</a>，这篇博文解释得非常好。</p><p id="40d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本指南中，我们将使用Python SDK。在我们开始之前，您需要准备好使用<strong class="io hj"> Python </strong>和<strong class="io hj"> Boto3 </strong>的环境。如果你还没有做好准备，<a class="ae jl" rel="noopener" href="/@paulankhi89/how-to-access-aws-s3-using-boto3-python-sdk-e5fbd3d276bd">请点击这里查看我之前的博文</a>。</p><p id="9329" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">首先，我们需要确保导入boto3也就是用于AWS的Python SDK。现在用<strong class="io hj"> boto3 </strong>创建<strong class="io hj"> S3 </strong>资源，与<strong class="io hj"> S3: </strong>交互</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="b4bd" class="jv jw hi jr b fi jx jy l jz ka">import boto3</span><span id="78a1" class="jv jw hi jr b fi kb jy l jz ka">s3_resource = boto3.resource(<strong class="jr hj">'s3'</strong>)</span></pre><p id="0cfe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">上传、下载或复制文件或S3对象时，用于Python的AWS SDK会自动管理重试、多部分和非多部分传输。为了实现细粒度控制，可以配置默认设置来满足要求。<strong class="io hj"> TransferConfig对象</strong>用于配置这些设置。然后该对象被传递给<em class="jk">配置=参数</em>中的一个传输方法(上传文件，下载文件)。</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="a919" class="jv jw hi jr b fi jx jy l jz ka">from <strong class="jr hj">boto3.s3.transfer</strong> import <strong class="jr hj">TransferConfig</strong></span><span id="d00c" class="jv jw hi jr b fi kb jy l jz ka">config = <strong class="jr hj">TransferConfig</strong>(<strong class="jr hj">multipart_threshold</strong>=1024 * 25, <br/>                        <strong class="jr hj">max_concurrency</strong>=10,<br/>                        <strong class="jr hj">multipart_chunksize</strong>=1024 * 25,<br/>                        <strong class="jr hj">use_threads</strong>=True)</span></pre><p id="ea7b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下面是对<strong class="io hj"> TransferConfig </strong>的每个元素的解释:</p><p id="5755" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> multipart_threshold </strong>:这用于确保多部分上传/下载仅在传输的大小大于所提到的阈值时发生，例如我使用了25MB。</p><p id="10d6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> max_concurrency </strong>:这表示将要发生的并发S3 API传输操作的最大数量(基本上是线程)。设定此项以增加或减少带宽使用。该属性的默认设置为10。如果<strong class="io hj"> use_threads </strong>设置为<strong class="io hj"> False </strong>，所提供的值将被忽略。</p><p id="ca1e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> multipart_chunksize </strong>:多部分传输的每个部分的大小。以25MB为例。</p><p id="26dd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">使用_螺纹</strong>:如果<strong class="io hj">为真</strong>，执行<strong class="io hj"> S3 </strong>转移时将使用平行螺纹。如果<strong class="io hj">为假</strong>，执行传输时将不使用任何线程。</p><p id="e947" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在配置了<strong class="io hj"> TransferConfig </strong>之后，让我们调用S3资源来上传一个文件:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="9d79" class="jv jw hi jr b fi jx jy l jz ka">bucket_name = <strong class="jr hj">'first-aws-bucket-1'</strong></span><span id="c39a" class="jv jw hi jr b fi kb jy l jz ka">def multipart_upload_boto3():<br/><br/>    file_path = os.path.dirname(__file__) + <strong class="jr hj">'/multipart_upload_example.pdf'</strong></span><span id="7367" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj">    </strong>key = <strong class="jr hj">'multipart-test/multipart_upload_example.pdf'<br/><br/>    </strong>s3_resource.Object(bucket_name, key).upload_file(file_path,<br/>                            ExtraArgs={<strong class="jr hj">'ContentType'</strong>: <strong class="jr hj">'text/pdf'</strong>},<br/>                            Config=config,<br/>                            Callback=ProgressPercentage(file_path)<br/>                            )</span></pre><p id="2efa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">- <strong class="io hj"> file_path </strong>:我们要上传到s3 bucket的源文件的位置。<br/> - <strong class="io hj">桶名</strong>:上传文件的目的S3桶名。<br/> - <strong class="io hj"> key </strong>:你要上传文件的key (S3位置)的名称。<br/> - <strong class="io hj"> ExtraArgs </strong>:在json字符串的这个param中设置额外的参数。您可以参考<a class="ae jl" href="https://boto3.amazonaws.com/v1/documentation/api/1.9.42/guide/s3.html" rel="noopener ugc nofollow" target="_blank">此</a>链接以获取有效的上传参数。<br/> - <strong class="io hj"> Config </strong>:这是我刚刚在上面创建的TransferConfig对象。</p><p id="dff5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">同样，对于下载文件:</p><pre class="jm jn jo jp fd jq jr js jt aw ju bi"><span id="7e46" class="jv jw hi jr b fi jx jy l jz ka">def multipart_download_boto3():<br/><br/>    file_path = os.path.dirname(__file__)+ <strong class="jr hj">'/multipart_download_example.pdf'</strong></span><span id="c0be" class="jv jw hi jr b fi kb jy l jz ka"><strong class="jr hj">    </strong>file_path1 = os.path.dirname(__file__)</span><span id="9977" class="jv jw hi jr b fi kb jy l jz ka">    key = <strong class="jr hj">'multipart-test/multipart_download_example.pdf'<br/><br/>    </strong>s3_resource.Object(bucket_name, key).download_file(file_path,<br/>                            Config=config,<br/>                            Callback=ProgressPercentage(file_path1)<br/>                            )</span></pre><p id="9b4d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> -bucket_name </strong>:下载文件的S3桶的名称。<br/> - <strong class="io hj"> key </strong>:你要从哪里下载文件(源)的key (S3位置)的名称。<br/> - <strong class="io hj"> file_path </strong>:你要下载文件的位置(目的地)<br/> - <strong class="io hj"> ExtraArgs </strong>:在json字符串的这个param中设置额外的参数。你可以参考<a class="ae jl" href="https://boto3.amazonaws.com/v1/documentation/api/1.9.42/guide/s3.html" rel="noopener ugc nofollow" target="_blank">这个</a>链接来获得有效的上传参数。<br/> - <strong class="io hj"> Config </strong>:这是我刚刚在上面创建的TransferConfig对象。</p><p id="1109" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请注意，我使用了进度回调，这样我就可以<br/>跟踪传输进度。upload_file和<br/> download_file方法都采用可选的回调参数。这个<em class="jk">进度百分比</em>类在<a class="ae jl" href="https://boto3.amazonaws.com/v1/documentation/api/latest/_modules/boto3/s3/transfer.html" rel="noopener ugc nofollow" target="_blank"> Boto3文档</a>中有解释。</p><p id="f1c4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">多部分上传的有趣事实(我在练习中学会的):</strong></p><ol class=""><li id="d170" class="kc kd hi io b ip iq it iu ix ke jb kf jf kg jj kh ki kj kk bi translated">为了检查文件的完整性，在上传之前，您可以计算文件的MD5校验和值作为参考。假设您想要上传一个12MB的文件，而您的部分大小是5MB。计算每个部分对应的3个MD5校验和，即第一个5MB、第二个5MB和最后一个2MB的校验和。然后取它们连接的校验和。由于MD5校验和是二进制数据的十六进制表示，所以请确保您采用解码的二进制串联的MD5，而不是ASCII或UTF-8编码的串联。完成后，添加一个连字符和零件的数量，以获得S3最终对象的<em class="jk"> ETag </em>。</li><li id="1062" class="kc kd hi io b ip kl it km ix kn jb ko jf kp jj kh ki kj kk bi translated">对于传统的PUT请求，对象的<em class="jk"> ETag </em>是文件的MD5校验和。然而，对于多部分上传<em class="jk">来说，Etag </em>是基于不同的算法计算的。</li></ol><p id="e742" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">继续探索和调整<strong class="io hj"> TransferConfig的配置。</strong>快乐学习！</p><p id="af79" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完整代码参考，请访问<a class="ae jl" href="https://github.com/ankhipaul/aws_demos" rel="noopener ugc nofollow" target="_blank"> github </a>。</p></div></div>    
</body>
</html>