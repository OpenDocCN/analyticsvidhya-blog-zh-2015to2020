<html>
<head>
<title>Proactively Scaling cluster with FBProphet forecasting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过FBProphet预测主动扩展集群</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/proactively-scaling-cluster-with-fbprophet-forecasting-a700c904d7f9?source=collection_archive---------13-----------------------#2020-12-26">https://medium.com/analytics-vidhya/proactively-scaling-cluster-with-fbprophet-forecasting-a700c904d7f9?source=collection_archive---------13-----------------------#2020-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="67fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将介绍我最近参与的一个有趣的项目，在这个项目中，我能够根据负载预测主动管理集群的大小。我将详细介绍可用的内置AWS功能，为什么我选择使用FBProphet以及如何将解决方案部署到生产中。</p><p id="87ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">在本文中，集群一词指的是Amazon EC2实例的集合。</em>T3】</strong></p><h1 id="e702" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">内置AWS功能</strong></h1><p id="fa72" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">AWS提供了两个内置功能来扩展和缩小集群以管理集群大小:动态扩展和预测性扩展。让我们看看每一个都是什么意思</p><p id="fa56" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">动态伸缩</strong>:动态伸缩是AWS提供的一种替代方案，它根据资源利用率的实时变化来管理集群大小。可以为向上扩展和向下扩展以及群集和动态扩展设置单独的阈值，确保一旦突破相应的阈值，就向上扩展或向下扩展。[1]</p><blockquote class="kh ki kj"><p id="f301" class="if ig jd ih b ii ij ik il im in io ip kk ir is it kl iv iw ix km iz ja jb jc hb bi translated">H <!-- -->然而，由于这种方法是反应式的，集群大小调整确实需要一些时间，因此最终会影响工作时间和后续的客户体验。</p></blockquote><p id="6a5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">预测缩放</strong>:AWS承诺的预测缩放应该利用过去2周的资源利用率数据，并预测未来2天的资源利用率。当预计负载较高时，可以使用这些预测来主动调整集群的大小，从而缓解动态扩展所面临的问题。[1]</p><blockquote class="kh ki kj"><p id="1301" class="if ig jd ih b ii ij ik il im in io ip kk ir is it kl iv iw ix km iz ja jb jc hb bi translated">然而，亚马逊预测缩放创建的预测似乎没有那么准确，导致探索其他可用于预测的库。</p></blockquote><h1 id="5ffb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">脸书预言家预测</h1><p id="cb2f" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">Prophet是脸书的一个预测库，可用于生成预测，这些预测又可用于主动扩展集群。为了正确进行预测，选择正确的指标也很重要。</p><p id="c7e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS通过其CloudWatch API公开各种指标，如平均CPU利用率、最大CPU利用率、节点数、特定时间间隔使用的内存。评估后，CPU利用率和节点数是用于此任务的指标。</p><p id="e49b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">利用脸书先知</strong>:</p><p id="2377" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">先知是一个非常容易使用和有效的时间序列库，由脸书开源。先知是如何工作的超出了这篇博客的范围，但是感兴趣的人可以在<a class="ae kn" href="https://peerj.com/preprints/3190.pdf" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">https://peerj.com/preprints/3190.pdf</strong></a>阅读</p><p id="0c0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就利用prophet API而言，有几件主要的事情需要记住。Prophet允许两种主要的增长模型，<strong class="ih hj">线性增长模型和逻辑增长模型</strong>(详细内容可在论文中找到)。</p><blockquote class="kh ki kj"><p id="c13d" class="if ig jd ih b ii ij ik il im in io ip kk ir is it kl iv iw ix km iz ja jb jc hb bi translated">这些模型中的一部分prophet还允许引入每日、每周和每年的季节性，其周期和顺序可以由领域专家输入。通过这种方法，prophet允许拥有领域专业知识的分析师轻松地利用它来训练模型。</p></blockquote><p id="8926" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中一个怪癖是Prophet模型在python中工作，训练数据应该以pandas数据帧的形式提供，该数据帧具有两个特定的列“ds”和“y”，其中“ds”表示时间戳,“y”表示要预测的指标值。</p><p id="ad1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是用于创建预测的示例代码。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="c70e" class="kx jf hi kt b fi ky kz l la lb">from fbprophet import Prophet</span><span id="1c03" class="kx jf hi kt b fi lc kz l la lb"># Define parameters of model</span><span id="ec5a" class="kx jf hi kt b fi lc kz l la lb">prophet = ( Prophet(growth = ‘logistic’)<br/> .add_seasonality(name=’daily’, period= 1, fourier_order= specified_fourier_order_daily)<br/> .add_seasonality(name=’weekly’, period=7, fourier_order=specified_fourier_order_daily)<br/> )</span><span id="61d1" class="kx jf hi kt b fi lc kz l la lb"># Fit prophet model on training data </span><span id="4a27" class="kx jf hi kt b fi lc kz l la lb">prophet.fit(df)</span><span id="649a" class="kx jf hi kt b fi lc kz l la lb"># Prepare future Dataframe for the time period to forecast, to store the forecasted values </span><span id="ceb6" class="kx jf hi kt b fi lc kz l la lb">future_df = prophet.make_future_dataframe(freq='min', periods = time_period_to_forecast)</span><span id="0345" class="kx jf hi kt b fi lc kz l la lb"># Forecast the values for the specified time frame<br/> <br/>forecast_df = prophet.predict(future_df)</span></pre><p id="7e0e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">应当注意，forecast_df包含训练数据的拟合值以及预测值，并且需要单独提取预测值以供进一步使用。</p><p id="ddfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦模型经过训练，用户还可以利用Prophet的plot_component功能绘制图表，查看模型中的趋势和季节性。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="b714" class="kx jf hi kt b fi ky kz l la lb">fig2 = prophet.plot_components(forecast_df)<br/>display(fig2)</span></pre><p id="ee38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将创建一个类似于下图的图。根据数据的基本行为，实际的绘图会有所不同。</p><figure class="ko kp kq kr fd le er es paragraph-image"><div class="er es ld"><img src="../Images/7c1f32fad080fa34d35191bc6e9759f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/0*eOVd2tA4P5Ajf0kG.png"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">图片来源:脸书开源</figcaption></figure><p id="a687" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还可以通过绘制预测数据框来了解prophet模型的拟合程度。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="1488" class="kx jf hi kt b fi ky kz l la lb"># Code to plot prophet forecast<br/> <br/>prophet.plot(forecasted_df)</span></pre><p id="dca5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它会生成如下图所示的图形</p><figure class="ko kp kq kr fd le er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/0c6c7db30468b1434bd275728f7a0d39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*v-ld4f1Q-_BVlXiT.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">图片来源:脸书开源</figcaption></figure><blockquote class="kh ki kj"><p id="4839" class="if ig jd ih b ii ij ik il im in io ip kk ir is it kl iv iw ix km iz ja jb jc hb bi translated">如果您在上面的图像中看到的<!-- -->是2016年之前的黑点，那么它将显示预测值。黑点代表真实值。蓝色区域表示预测值，浅蓝色的顶部和下部区域分别表示上限和下限。</p></blockquote><p id="3356" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">主动扩展AWS集群规模</strong></p><p id="fffe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们有了预测值，设置基础架构以进行扩展就非常简单了。可以建立一个作业来预测一天所需的指标，并将其存储在s3位置。这可以设置为cron作业或使用任何其他可用的调度程序。</p><p id="edb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在单独的EC2实例上或通过lambda函数，可以设置另一个脚本来实时获取集群指标。AWS提供API来收集各种指标，例如期望容量(实例)、当前容量(实例)等。</p><p id="1dc5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这与预测指标一起，可以通过逻辑检查来主动控制集群大小，并为用户提供更加流畅的体验。</p></div><div class="ab cl lq lr gp ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="hb hc hd he hf"><p id="1420" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">参考文献</strong></p><ol class=""><li id="adda" class="lx ly hi ih b ii ij im in iq lz iu ma iy mb jc mc md me mf bi translated"><a class="ae kn" href="https://docs.aws.amazon.com/autoscaling/plans/userguide/how-it-works.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/auto scaling/plans/user guide/how-it-works . html</a></li><li id="f2b5" class="lx ly hi ih b ii mg im mh iq mi iu mj iy mk jc mc md me mf bi translated"><a class="ae kn" href="https://docs.aws.amazon.com/autoscaling/ec2/APIReference/API_Operations_List.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/auto scaling/ec2/API reference/API _ Operations _ list . html</a></li><li id="c071" class="lx ly hi ih b ii mg im mh iq mi iu mj iy mk jc mc md me mf bi translated"><a class="ae kn" href="https://peerj.com/preprints/3190.pdf" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"/>https://peerj.com/preprints/3190.pdf</a></li></ol></div></div>    
</body>
</html>