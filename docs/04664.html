<html>
<head>
<title>Pivot table in AWS Athena (or Presto)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Athena(或Presto)中的数据透视表</h1>
<blockquote>原文：<a href="https://medium.com/analytics-vidhya/pivot-table-in-aws-athena-or-presto-764661eaa0fd?source=collection_archive---------1-----------------------#2020-03-28">https://medium.com/analytics-vidhya/pivot-table-in-aws-athena-or-presto-764661eaa0fd?source=collection_archive---------1-----------------------#2020-03-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="64e9" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">背景</h1><p id="a5cc" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">数据透视表是Excel中最常用的报表功能之一。用户不需要编程背景来执行数据分析。</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="202c" class="kk ig hi kg b fi kl km l kn ko">+---------------+-------+---------------+--------------+<br/>| Item Category | Price |    Region     | Sales Person |<br/>+---------------+-------+---------------+--------------+<br/>| Furniture     |    10 | North America | Jane         |<br/>| Technology    |     5 | Asia Pacific  | Jane         |<br/>| Furniture     |    12 | North America | Tom          |<br/>| Technology    |     8 | North America | Tom          |<br/>+---------------+-------+---------------+--------------+</span></pre><p id="c986" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">假设有一份销售报告，如上图<em class="ku">(为演示目的进行了大量简化)</em>所示，报告了所有地区的所有销售人员销售的订单。透视表启用多维度提问。</p><p id="4f58" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><strong class="jf hj">举例:<em class="ku">各地区各品类总销售额</em> </strong></p><p id="d46f" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">为了回答这个问题，可以在Excel上创建一个数据透视表，设置如下配置</p><ul class=""><li id="4c0b" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka la lb lc ld bi translated">行=项目类别</li><li id="f1dc" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">列<strong class="jf hj"> = </strong>区域</li><li id="a84b" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">价值=总和(价格)</li></ul><p id="a32d" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">如下所示的输出将回答这个问题。</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="0e0b" class="kk ig hi kg b fi kl km l kn ko">+---------------+--------------+---------------+<br/>| Item Category | Asia Pacific | North America |<br/>+---------------+--------------+---------------+<br/>| Furniture     |              |            22 |<br/>| Technology    |            5 |             8 |<br/>+---------------+--------------+---------------+</span></pre><p id="74d2" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">假设你的公司做得很好，上个月有1000万份订单。现在假设您的分析师在一个有1000万行的excel上运行数据透视表。希望他或她还会留下来参加下个月的分析。</p><p id="53cf" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">在本帖中，我们将描述如何在Athena上实现这一点——一种高度可扩展的方式来查询大量数据。</p></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><h1 id="7ed5" class="if ig hi bd ih ii lq ik il im lr io ip iq ls is it iu lt iw ix iy lu ja jb jc bi translated">亚马逊雅典娜</h1><figure class="kb kc kd ke fd lw er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lv"><img src="../Images/ee6f4fd0c0668762be8d62ca291f368a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9lt4RfFeNMxMNuiUkcsISw.png"/></div></div><figcaption class="md me et er es mf mg bd b be z dx translated">雅典娜用户界面。左边是表格列表。右边是执行查询并查看结果</figcaption></figure><p id="5795" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><a class="ae mh" href="https://aws.amazon.com/athena/" rel="noopener ugc nofollow" target="_blank"> Athena </a>是AWS提供的托管查询服务。查询引擎基于<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/presto-functions.html" rel="noopener ugc nofollow" target="_blank"> Presto </a>。Athena支持presto中的大多数操作符，是在s3中查询数据的流行选择。随着最近<a class="ae mh" href="https://docs.aws.amazon.com/athena/latest/ug/connect-to-a-data-source.html" rel="noopener ugc nofollow" target="_blank">联邦查询</a>的发布，Athena也可以查询其他数据源，比如Postgres。真的很棒。</p><h1 id="54a3" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">浏览一个例子</h1><h2 id="adc7" class="kk ig hi bd ih mi mj mk il ml mm mn ip jo mo mp it js mq mr ix jw ms mt jb mu bi translated">示例:每个地区每个类别的总销售额</h2><p id="b520" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">在这种情况下，用户将从数据透视表的excel中选择</p><ul class=""><li id="7320" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka la lb lc ld bi translated">行=项目类别</li><li id="efc8" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">Colum =区域</li><li id="e119" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">价值=总和(价格)</li></ul><p id="c247" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated"><em class="ku">通过Athena实现以上查询。假设该表被称为</em><strong class="jf hj"><em class="ku"/></strong></p><figure class="kb kc kd ke fd lw"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="a990" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">上面的查询将产生下面的输出。如果我们使用Excel中的数据透视表，输出与前面的示例完全相同。</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="c8db" class="kk ig hi kg b fi kl km l kn ko">+---------------+--------------+---------------+<br/>| Item Category | Asia Pacific | North America |<br/>+---------------+--------------+---------------+<br/>| Furniture     |              |          22.0 |<br/>| Technology    |          5.0 |           8.0 |<br/>+---------------+--------------+----------------</span></pre></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><h2 id="2a6c" class="kk ig hi bd ih mi mj mk il ml mm mn ip jo mo mp it js mq mr ix jw ms mt jb mu bi translated">说明</h2><p id="1a67" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">首先是内部查询。内部查询的输出示例如下所示。</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="2294" class="kk ig hi kg b fi kl km l kn ko">+---------------+---------------------------------------+<br/>| Item Category |                  kv1                  |<br/>+---------------+---------------------------------------+<br/>| Furniture     | {North America=[10, 12]}              |<br/>| Technology    | {Asia Pacific=[5], North America=[8]} |<br/>+---------------+---------------------------------------+</span></pre><p id="aa93" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">列kv1主要由函数<strong class="jf hj">multimap _ agg</strong>T22】multimap _ agg("区域"，金额)kv1 填充。</p><p id="9693" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">根据<a class="ae mh" href="https://prestodb.io/docs/0.172/functions/aggregate.html" rel="noopener ugc nofollow" target="_blank">文件</a></p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="7c75" class="kk ig hi kg b fi kl km l kn ko"><strong class="kg hj">multimap_agg</strong>(<em class="ku">key</em>, <em class="ku">value</em>) → map&lt;K,array&lt;V&gt;&gt;</span><span id="c768" class="kk ig hi kg b fi mx km l kn ko">Returns a multimap created from the input <!-- -->key<!-- --> / <!-- -->value<!-- --> pairs. Each key can be associated with multiple values.</span></pre><p id="de8c" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">请注意，kv1列是一个映射，key = region，values =该地区的所有价格。基于以上所述，它将表明</p><ul class=""><li id="0687" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka la lb lc ld bi translated">对于家具类别，在北美有两个订单，价格分别为10美元和12美元</li><li id="20a8" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka la lb lc ld bi translated">对于技术类别，亚太地区有一个5美元的订单，北美有一个8美元的订单</li></ul></div><div class="ab cl lj lk gp ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="hb hc hd he hf"><p id="33e4" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">在内部查询之后，最后一步是对值求和。Presto提供了多种<a class="ae mh" href="https://prestodb.io/docs/current/functions/array.html" rel="noopener ugc nofollow" target="_blank">数组</a>辅助函数。为了对值求和，我们将使用reduce运算符。</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="4ccc" class="kk ig hi kg b fi kl km l kn ko"><strong class="kg hj">reduce</strong>(<em class="ku">array(T)</em>, <em class="ku">initialState S</em>, <em class="ku">inputFunction(S</em>, <em class="ku">T</em>, <em class="ku">S)</em>, <em class="ku">outputFunction(S</em>, <em class="ku">R)</em>) → R</span><span id="555d" class="kk ig hi kg b fi mx km l kn ko">Returns a single value reduced from <!-- -->array<!-- -->. <!-- -->inputFunction<!-- --> will be invoked for each element in <!-- -->array<!-- --> in order. In addition to taking the element, <!-- -->inputFunction<!-- --> takes the current state, initially <!-- -->initialState<!-- -->, and returns the new state. <!-- -->outputFunction<!-- --> will be invoked to turn the final state into the result value. It may be the identity function (<!-- -->i -&gt; i<!-- -->).</span></pre><blockquote class="my mz na"><p id="48c0" class="jd je ku jf b jg kp ji jj jk kq jm jn nb kr jq jr nc ks ju jv nd kt jy jz ka hb bi translated">减少(kv1['亚太']，0.0，(s，x) -&gt; s + x，s-&gt; s)为“亚太”</p></blockquote><p id="bb8c" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">这条线的作用是</p><ol class=""><li id="7356" class="kv kw hi jf b jg kp jk kq jo kx js ky jw kz ka ne lb lc ld bi translated">查看行值，并用kv1['Asia Pacific']选择亚太区的值</li><li id="2900" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka ne lb lc ld bi translated">初始化reduce以对值求和</li><li id="abf6" class="kv kw hi jf b jg le jk lf jo lg js lh jw li ka ne lb lc ld bi translated">创建一个名为“亚太”的专栏</li></ol><h1 id="008b" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">结论</h1><p id="699c" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我希望以上内容可以作为Athena上数据透视表的快速指南。</p><p id="a95d" class="pw-post-body-paragraph jd je hi jf b jg kp ji jj jk kq jm jn jo kr jq jr js ks ju jv jw kt jy jz ka hb bi translated">如果你注意到，我们必须事先确定地区:亚太和北美。可惜我找不到动态生成列表的方法。如果你有建议，请告诉我。</p></div></div>    
</body>
</html>