# 在 GoLang 中使用 Redis 和 Docker 进行自定义速率限制

> 原文：<https://medium.com/analytics-vidhya/custom-rate-limiting-in-golang-using-redis-with-docker-e4a7be96f7dc?source=collection_archive---------7----------------------->

![](img/75fd26fd1de46e241eff31a3bad5ad8f.png)

**《让魔法开始》**

# 介绍

世界正朝着面向微服务的系统发展。防止 web 服务受到 DOS(拒绝服务)等攻击非常重要。速率限制通常是作为服务的防御措施而设置的。保护服务免受有意或无意的过度使用。它还有助于以公平的方式确保服务对所有客户端的可用性。

而这种能力可以很容易地使用反向代理服务器与应用程序集成。通常，反向代理服务器会根据客户端访问服务的次数进行速率限制。但是，在某些情况下，您可能希望基于其他属性启用速率限制。例如，您可能希望根据客户机从数据库中请求的记录数量来限制客户机的速率。因此，了解如何在应用程序中扩展这种能力始终是一项附加任务。

让我们试着创建一个速率限制的自定义实现。

# 先决条件

对…有相当的了解:

*   戈朗
*   [码头工人](https://docs.docker.com/docker-for-mac/install/)
*   Redis —用于缓存 IP 到 count 的映射

![](img/0feeff6ee24520487c5c33c9234e4927.png)

知识只能是自愿的，不能是强制的。—戴夫·斯诺登

# 概念

我们将使用 Redis 进行记录的内存缓存。这个想法是为带有定制请求过滤器的服务构建一个中间件。我们将拦截每个请求，并维护一个缓存，记录客户端点击服务的次数。该缓存将按分钟维护。如果客户端在一分钟内访问服务的次数超过了允许的限制，我们将拒绝该请求。

## 中间件

中间件(通常)是一些小代码，它们接受一个请求，对它做一些事情，然后将它传递给另一个中间件或最终的处理程序。中间件的一些常见用例是请求日志、头操作或`ResponseWriter`劫持。

# 设置

我们将在本地加速 Redis 容器以进行内存缓存。假设您已经建立了一个 docker 客户端。让我们把集装箱拿上来。在终端或等效工具中运行以下命令。

```
docker run -d — name redis-test -p 6379:6379 redis
```

使用 Golang 中的`mux`库创建端点。

```
go get -v github.com/gorilla/mux
```

获取 Redis 交互的`redigo`库。

```
go get -v github.com/gomodule/redigo/redis
```

![](img/6b42157e45148f989405615665188aaf.png)

**“顺应自然的步伐。她的秘诀是耐心。”—拉尔夫·瓦尔多·爱默生**

# 履行

## 为 Redis 连接池创建单一客户端

我们需要创建一个单独的客户端，它将从 Redis 连接池中返回一个连接。连接池有助于降低过度使用资源的风险。这些参数可以根据系统能力进行配置。

## 限制请求速率的中间件

我们将创建一个预请求过滤器，在请求到达最终处理程序之前拦截它。为了便于使用，我们将实现一个 IP 来限制计数率。

第一步是从请求中提取 IP 地址。我们需要对每个请求分时段。背后的想法是，我们希望根据键是否属于特定的时间段来增加键的计数器。

我们将每分钟维护一次铲斗。这也有助于我们轻松删除密钥。参考`GetKey`方法理解实现。

Redis 不会自行删除密钥，这意味着没有与密钥相关联的默认 TTL。一旦密钥被创建，它们将永远存在。我们需要为密钥显式设置一个 TTL。

因此，本质上，一旦我们得到一个新的请求，我们将检查缓存中是否存在该关键字，如果是，我们将递增该关键字的计数器，否则我们将把该关键字添加到缓存中。此外，我们验证计数器是否与阈值匹配，如果匹配，将使请求失败。

![](img/cfaef23c0c319763a9b44fc863854bbb.png)

**“我们用照片作为返程票，回到那个已经逝去的时刻。”**

## 为端点创建路由

最后一件事是创建一个服务端点，并为路由器配置中间件。我们将有一个简单的测试端点，我们将其命名为`ping`。我们需要配置`router`来使用中间件。本质上，存在两种中间件变体，即预请求和预响应过滤器。相同性质的中间件按照它们被配置的顺序执行。

# 最终代码

这是完整的代码。一定要试一试。

![](img/48fde847465edc09441847b3f3eaaf64.png)

# 非常感谢您的阅读

我希望这篇文章对你有所帮助。
快乐编码！！！